<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Built-in instrumentation modules | APM Go Agent Reference [1.x] | Elastic</title>
<link rel="home" href="index.html" title="APM Go Agent Reference [1.x]"/>
<link rel="up" href="getting-started.html" title="Set up the Agent"/>
<link rel="prev" href="getting-started.html" title="Set up the Agent"/>
<link rel="next" href="custom-instrumentation.html" title="Custom instrumentation"/>
<meta name="DC.type" content="Learn/Docs/APM Go Agent/Reference/1.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="1.x"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
A newer version is available. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">APM Go Agent Reference [1.x]</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="getting-started.html">Set up the Agent</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="getting-started.html">« Set up the Agent</a>
</span>
<span class="next">
<a href="custom-instrumentation.html">Custom instrumentation »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="builtin-modules"></a>Built-in instrumentation modules<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h2>
</div></div></div>
<p>For each server instrumentation module, a transaction is reported for each handled
request. The transaction will be stored in the request context, which can be obtained through
that framework&#8217;s API. The request context can be used for reporting <a class="xref" href="custom-instrumentation.html#custom-instrumentation-spans" title="Spans">custom spans</a>.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmhttp" title="module/apmhttp">module/apmhttp</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmfasthttp" title="module/apmfasthttp">module/apmfasthttp</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmecho" title="module/apmecho">module/apmecho</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmgin" title="module/apmgin">module/apmgin</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmfiber" title="module/apmfiber">module/apmfiber</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmbeego" title="module/apmbeego">module/apmbeego</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmgorilla" title="module/apmgorilla">module/apmgorilla</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmgrpc" title="module/apmgrpc">module/apmgrpc</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmhttprouter" title="module/apmhttprouter">module/apmhttprouter</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmnegroni" title="module/apmnegroni">module/apmnegroni</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmlambda" title="module/apmlambda">module/apmlambda</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmsql" title="module/apmsql">module/apmsql</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmgopg" title="module/apmgopg">module/apmgopg</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmgorm" title="module/apmgorm">module/apmgorm</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmgocql" title="module/apmgocql">module/apmgocql</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmredigo" title="module/apmredigo">module/apmredigo</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmgoredis" title="module/apmgoredis">module/apmgoredis</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmgoredisv8" title="module/apmgoredisv8">module/apmgoredisv8</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmrestful" title="module/apmrestful">module/apmrestful</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmchi" title="module/apmchi">module/apmchi</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmlogrus" title="module/apmlogrus">module/apmlogrus</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmzap" title="module/apmzap">module/apmzap</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmzerolog" title="module/apmzerolog">module/apmzerolog</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmelasticsearch" title="module/apmelasticsearch">module/apmelasticsearch</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmmongo" title="module/apmmongo">module/apmmongo</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmawssdkgo" title="module/apmawssdkgo">module/apmawssdkgo</a>
</li>
<li class="listitem">
<a class="xref" href="builtin-modules.html#builtin-modules-apmazure" title="module/apmazure">module/apmazure</a>
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmhttp"></a>module/apmhttp<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmhttp provides a low-level <code class="literal">net/http</code> middleware handler. Other web middleware should
typically be based off this.</p>
<p>For each request, a transaction is stored in the request context, which can be obtained via
<a href="https://golang.org/pkg/net/http/#Request.Context" class="ulink" target="_top">http.Request.Context</a> in your handler.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"go.elastic.co/apm/module/apmhttp"
)

func main() {
	var myHandler http.Handler = ...
	tracedHandler := apmhttp.Wrap(myHandler)
}</pre>
</div>
<p>The apmhttp handler will recover panics and send them to Elastic APM.</p>
<p>Package apmhttp also provides functions for instrumenting an <code class="literal">http.Client</code> or <code class="literal">http.RoundTripper</code>
such that outgoing requests are traced as spans, if the request context includes a transaction.
When performing the request, the enclosing context should be propagated by using
<a href="https://golang.org/pkg/net/http/#Request.WithContext" class="ulink" target="_top">http.Request.WithContext</a>, or a helper, such as those provided by <a href="https://golang.org/x/net/context/ctxhttp" class="ulink" target="_top">https://golang.org/x/net/context/ctxhttp</a>.</p>
<p>Client spans are not ended until the response body is fully consumed or closed.
If you fail to do either, the span will not be sent.
Always close the response body to ensure HTTP connections can be reused; see <a href="https://golang.org/pkg/net/http/#Client.Do" class="ulink" target="_top"><code class="literal">func (*Client) Do</code></a>.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"net/http"

	"golang.org/x/net/context/ctxhttp"

	"go.elastic.co/apm"
	"go.elastic.co/apm/module/apmhttp"
)

var tracingClient = apmhttp.WrapClient(http.DefaultClient)

func serverHandler(w http.ResponseWriter, req *http.Request) {
	// Propagate the transaction context contained in req.Context().
	resp, err := ctxhttp.Get(req.Context(), tracingClient, "http://backend.local/foo")
	if err != nil {
		apm.CaptureError(req.Context(), err).Send()
		http.Error(w, "failed to query backend", 500)
		return
	}
	body, err := ioutil.ReadAll(resp.Body)
	...
}

func main() {
	http.ListenAndServe(":8080", apmhttp.Wrap(http.HandlerFunc(serverHandler)))
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmfasthttp"></a>module/apmfasthttp<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmfasthttp provides a low-level <a href="https://github.com/valyala/fasthttp" class="ulink" target="_top">valyala/fasthttp</a> middleware request handler. Other fasthttp-based web middleware should typically be based off this.</p>
<p>For each request, a transaction is stored in the request context, which can be obtained via
<a href="https://pkg.go.dev/github.com/valyala/fasthttp#RequestCtx" class="ulink" target="_top">fasthttp.RequestCtx</a> in your handler using <code class="literal">apm.TransactionFromContext</code>.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"github.com/valyala/fasthttp"

	"go.elastic.co/apm/module/apmfasthttp"
)

func main() {
	var myHandler fasthttp.RequestHandler = func(ctx *fasthttp.RequestCtx) {
		apmCtx := apm.TransactionFromContext(ctx)
		// ...
	}
	tracedHandler := apmfasthttp.Wrap(myHandler)
}</pre>
</div>
<p>The apmfasthttp handler will recover panics and send them to Elastic APM.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmecho"></a>module/apmecho<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Packages apmecho and apmechov4 provide middleware for the <a href="https://github.com/labstack/echo" class="ulink" target="_top">Echo</a>
web framework, versions 3.x and 4.x respectively.</p>
<p>If you are using Echo 4.x (<code class="literal">github.com/labstack/echo/v4</code>), use <code class="literal">module/apmechov4</code>.
For the older Echo 3.x versions (<code class="literal">github.com/labstack/echo</code>), use <code class="literal">module/apmecho</code>.</p>
<p>For each request, a transaction is stored in the request context, which can be obtained via
<a href="https://godoc.org/github.com/labstack/echo#Context" class="ulink" target="_top">echo.Context</a><code class="literal">.Request().Context()</code> in your handler.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	echo "github.com/labstack/echo/v4"

	"go.elastic.co/apm/module/apmechov4"
)

func main() {
	e := echo.New()
	e.Use(apmechov4.Middleware())
	...
}</pre>
</div>
<p>The middleware will recover panics and send them to Elastic APM, so you do not need to install
the echo/middleware.Recover middleware.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmgin"></a>module/apmgin<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmgin provides middleware for the <a href="https://gin-gonic.com/" class="ulink" target="_top">Gin</a> web framework.</p>
<p>For each request, a transaction is stored in the request context, which can be obtained via
<a href="https://godoc.org/github.com/gin-gonic/gin#Context" class="ulink" target="_top">gin.Context</a><code class="literal">.Request.Context()</code> in your handler.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"go.elastic.co/apm/module/apmgin"
)

func main() {
	engine := gin.New()
	engine.Use(apmgin.Middleware(engine))
	...
}</pre>
</div>
<p>The apmgin middleware will recover panics and send them to Elastic APM, so you do not need to install the gin.Recovery middleware.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmfiber"></a>module/apmfiber<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmfiber provides middleware for the <a href="https://gofiber.io/" class="ulink" target="_top">Fiber</a> web framework, versions 2.x (v2.18.0 and greater).</p>
<p>For each request, a transaction is stored in the request context, which can be obtained via
<a href="https://pkg.go.dev/github.com/gofiber/fiber/v2#Ctx" class="ulink" target="_top">fiber.Ctx</a><code class="literal">.Context()</code> in your handler.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"go.elastic.co/apm/module/apmfiber"
)

func main() {
	app := fiber.New()
	app.Use(apmfiber.Middleware())
	...
}</pre>
</div>
<p>The apmfiber middleware will recover panics and send them to Elastic APM,
so you do not need to install the fiber <a href="https://docs.gofiber.io/api/middleware/recover" class="ulink" target="_top">recover</a> middleware.
You can disable default behaviour by using <code class="literal">WithPanicPropagation</code> option.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmbeego"></a>module/apmbeego<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmbeego provides middleware for the <a href="https://beego.me/" class="ulink" target="_top">Beego</a> web framework.</p>
<p>For each request, a transaction is stored in the request context, which can be obtained via
<a href="https://godoc.org/github.com/astaxie/beego/context#Context" class="ulink" target="_top">beego/context.Context</a><code class="literal">.Request.Context()</code>
in your controller.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"github.com/astaxie/beego"

	"go.elastic.co/apm"
	"go.elastic.co/apm/module/apmbeego"
)

type thingController struct{beego.Controller}

func (c *thingController) Get() {
	span, _ := apm.StartSpan(c.Ctx.Request.Context(), "thingController.Get", "controller")
	span.End()
	...
}

func main() {
	beego.Router("/", &amp;thingController{})
	beego.Router("/thing/:id:int", &amp;thingController{}, "get:Get")
	beego.RunWithMiddleWares("localhost:8080", apmbeego.Middleware())
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmgorilla"></a>module/apmgorilla<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmgorilla provides middleware for the <a href="http://www.gorillatoolkit.org/pkg/mux" class="ulink" target="_top">Gorilla Mux</a> router.</p>
<p>For each request, a transaction is stored in the request context, which can be obtained via
<a href="https://golang.org/pkg/net/http/#Request" class="ulink" target="_top">http.Request</a><code class="literal">.Context()</code> in your handler.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"github.com/gorilla/mux"

	"go.elastic.co/apm/module/apmgorilla"
)

func main() {
	router := mux.NewRouter()
	apmgorilla.Instrument(router)
	...
}</pre>
</div>
<p>The apmgorilla middleware will recover panics and send them to Elastic APM, so you do not need to install any other recovery middleware.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmgrpc"></a>module/apmgrpc<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmgrpc provides server and client interceptors for <a href="https://github.com/grpc/grpc-go" class="ulink" target="_top">gRPC-Go</a>.
Server interceptors report transactions for each incoming request, while client interceptors
report spans for each outgoing request. For each RPC served, a transaction is stored in the
context passed into the method.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"go.elastic.co/apm/module/apmgrpc"
)

func main() {
	server := grpc.NewServer(
		grpc.UnaryInterceptor(apmgrpc.NewUnaryServerInterceptor()),
		grpc.StreamInterceptor(apmgrpc.NewStreamServerInterceptor()),
	)
	...
	conn, err := grpc.Dial(addr,
		grpc.WithUnaryInterceptor(apmgrpc.NewUnaryClientInterceptor()),
		gprc.WithStreamInterceptor(apmgrpc.NewStreamClientInterceptor()),
	)
	...
}</pre>
</div>
<p>The server interceptor can optionally be made to recover panics, in the same way as
<a href="https://github.com/grpc-ecosystem/go-grpc-middleware/tree/master/recovery" class="ulink" target="_top">grpc_recovery</a>.
The apmgrpc server interceptor will always send panics it observes as errors to the Elastic APM server.
If you want to recover panics but also want to continue using grpc_recovery, then you should ensure
that it comes before the apmgrpc interceptor in the interceptor chain, or panics will not be captured
by apmgrpc.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">server := grpc.NewServer(grpc.UnaryInterceptor(
	apmgrpc.NewUnaryServerInterceptor(apmgrpc.WithRecovery()),
))
...</pre>
</div>
<p>Stream interceptors emit transactions and spans that represent the entire stream,
and not individual messages. For client streams, spans will be ended when the request
fails; when any of <code class="literal">grpc.ClientStream.RecvMsg</code>, <code class="literal">grpc.ClientStream.SendMsg</code>, or
<code class="literal">grpc.ClientStream.Header</code> return with an error; or when <code class="literal">grpc.ClientStream.RecvMsg</code>
returns for a non-streaming server method.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmhttprouter"></a>module/apmhttprouter<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmhttprouter provides a low-level middleware handler for <a href="https://github.com/julienschmidt/httprouter" class="ulink" target="_top">httprouter</a>.</p>
<p>For each request, a transaction is stored in the request context, which can be obtained via
<a href="https://golang.org/pkg/net/http/#Request" class="ulink" target="_top">http.Request</a><code class="literal">.Context()</code> in your handler.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"github.com/julienschmidt/httprouter"

	"go.elastic.co/apm/module/apmhttprouter"
)

func main() {
	router := httprouter.New()

	const route = "/my/route"
	router.GET(route, apmhttprouter.Wrap(h, route))
	...
}</pre>
</div>
<p><a href="https://github.com/julienschmidt/httprouter/pull/139" class="ulink" target="_top">httprouter does not provide a means of obtaining the matched route</a>, hence the route must be passed into the wrapper.</p>
<p>Alternatively, use the <code class="literal">apmhttprouter.Router</code> type, which wraps <code class="literal">httprouter.Router</code>,
providing the same API and instrumenting added routes. To use this wrapper type, rewrite your use of <code class="literal">httprouter.New</code> to <code class="literal">apmhttprouter.New</code>; the returned type
is <code class="literal">*apmhttprouter.Router</code>, and not <code class="literal">*httprouter.Router</code>.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import "go.elastic.co/apm/module/apmhttprouter"

func main() {
	router := apmhttprouter.New()

	router.GET(route, h)
	...
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmnegroni"></a>module/apmnegroni<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmnegroni provides middleware for the <a href="https://github.com/urfave/negroni/" class="ulink" target="_top">negroni</a> library.</p>
<p>For each request, a transaction is stored in the request context, which can be obtained via
<a href="https://golang.org/pkg/net/http/#Request.Context" class="ulink" target="_top">http.Request.Context</a> in your handler.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"net/http"

	"go.elastic.co/apm/module/apmnegroni"
)

func serverHandler(w http.ResponseWriter, req *http.Request) {
	...
}

func main() {
	n := negroni.New()
	n.Use(apmnegroni.Middleware())
	n.UseHandler(serverHandler)
	http.ListenAndServe(":8080", n)
}</pre>
</div>
<p>The apmnegroni handler will recover panics and send them to Elastic APM.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmlambda"></a>module/apmlambda<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmlambda intercepts requests to your AWS Lambda function invocations.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in technical preview and may be changed or removed in a future release. Elastic will apply best effort to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>Importing the package is enough to report the function invocations.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	_ "go.elastic.co/apm/module/apmlambda"
)</pre>
</div>
<p>We currently do not expose the transactions via context; when we do, it will be
necessary to make a small change to your code to call apmlambda.Start instead of
lambda.Start.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmsql"></a>module/apmsql<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmsql provides a means of wrapping <code class="literal">database/sql</code> drivers so that queries and other
executions are reported as spans within the current transaction.</p>
<p>To trace SQL queries, register drivers using apmsql.Register and obtain connections
with apmsql.Open. The parameters are exactly the same as if you were to call sql.Register
and sql.Open respectively.</p>
<p>As a convenience, we also provide packages which will automatically register popular drivers
with apmsql.Register:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
module/apmsql/pq (github.com/lib/pq)
</li>
<li class="listitem">
module/apmsql/pgxv4 (github.com/jackc/pgx/v4/stdlib)
</li>
<li class="listitem">
module/apmsql/mysql (github.com/go-sql-driver/mysql)
</li>
<li class="listitem">
module/apmsql/sqlite3 (github.com/mattn/go-sqlite3)
</li>
</ul>
</div>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"go.elastic.co/apm/module/apmsql"
	_ "go.elastic.co/apm/module/apmsql/pq"
	_ "go.elastic.co/apm/module/apmsql/sqlite3"
)

func main() {
	db, err := apmsql.Open("postgres", "postgres://...")
	db, err := apmsql.Open("sqlite3", ":memory:")
}</pre>
</div>
<p>Spans will be created for queries and other statement executions if the context methods are
used, and the context includes a transaction.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmgopg"></a>module/apmgopg<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmgopg provides a means of instrumenting <a href="http://github.com/go-pg/pg" class="ulink" target="_top">go-pg</a> database operations.</p>
<p>To trace <code class="literal">go-pg</code> statements, call <code class="literal">apmgopg.Instrument</code> with the database instance you plan on using and provide
a context that contains an apm transaction.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"github.com/go-pg/pg"

	"go.elastic.co/apm/module/apmgopg"
)

func main() {
	db := pg.Connect(&amp;pg.Options{})
	apmgopg.Instrument(db)

	db.WithContext(ctx).Model(...)
}</pre>
</div>
<p>Spans will be created for queries and other statement executions if the context methods are
used, and the context includes a transaction.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmgopgv10"></a>module/apmgopgv10<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmgopgv10 provides a means of instrumenting v10 of <a href="http://github.com/go-pg/pg" class="ulink" target="_top">go-pg</a> database operations.</p>
<p>To trace <code class="literal">go-pg</code> statements, call <code class="literal">apmgopgv10.Instrument</code> with the database instance you plan on using and provide
a context that contains an apm transaction.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"github.com/go-pg/pg/v10"

	"go.elastic.co/apm/module/apmgopgv10"
)

func main() {
	db := pg.Connect(&amp;pg.Options{})
	apmgopg.Instrument(db)

	db.WithContext(ctx).Model(...)
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmgorm"></a>module/apmgorm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmgorm provides a means of instrumenting <a href="http://gorm.io" class="ulink" target="_top">GORM</a> database operations.</p>
<p>To trace <code class="literal">GORM</code> operations, import the appropriate <code class="literal">apmgorm/dialects</code> package (instead of the
<code class="literal">gorm/dialects</code> package), and use <code class="literal">apmgorm.Open</code> (instead of <code class="literal">gorm.Open</code>). The parameters are
exactly the same.</p>
<p>Once you have a <code class="literal">*gorm.DB</code> from <code class="literal">apmgorm.Open</code>, you can call <code class="literal">apmgorm.WithContext</code> to
propagate a context containing a transaction to the operations:</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"go.elastic.co/apm/module/apmgorm"
	_ "go.elastic.co/apm/module/apmgorm/dialects/postgres"
)

func main() {
	db, err := apmgorm.Open("postgres", "")
	...
	db = apmgorm.WithContext(ctx, db)
	db.Find(...) // creates a "SELECT FROM &lt;foo&gt;" span
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_moduleapmgormv2"></a>module/apmgormv2<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmgormv2 provides a means of instrumenting <a href="http://gorm.io" class="ulink" target="_top">GORM</a> database operations.</p>
<p>To trace <code class="literal">GORM</code> operations, import the appropriate <code class="literal">apmgormv2/driver</code> package (instead of the
<code class="literal">gorm.io/driver</code> package), use these dialects to <code class="literal">gorm.Open</code> instead of gorm drivers.</p>
<p>Once you have a <code class="literal">*gorm.DB</code>, you can call <code class="literal">db.WithContext</code> to
propagate a context containing a transaction to the operations:</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"gorm.io/gorm"
	postgres "go.elastic.co/apm/module/apmgormv2/driver/postgres"
)

func main() {
	db, err := gorm.Open(postgres.Open("dsn"), &amp;gorm.Config{})
	...
	db = db.WithContext(ctx)
	db.Find(...) // creates a "SELECT FROM &lt;foo&gt;" span
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmgocql"></a>module/apmgocql<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmgocql provides a means of instrumenting <a href="https://github.com/gocql/gocql" class="ulink" target="_top">gocql</a> so
that queries are reported as spans within the current transaction.</p>
<p>To report <code class="literal">gocql</code> queries, construct an <code class="literal">apmgocql.Observer</code> and assign it to
the <code class="literal">QueryObserver</code> and <code class="literal">BatchObserver</code> fields of <code class="literal">gocql.ClusterConfig</code>, or install it
into a specific <code class="literal">gocql.Query</code> or <code class="literal">gocql.Batch</code> via their <code class="literal">Observer</code> methods.</p>
<p>Spans will be created for queries as long as they have context associated, and the
context includes a transaction.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"github.com/gocql/gocql"

	"go.elastic.co/apm/module/apmgocql"
)

func main() {
	observer := apmgocql.NewObserver()
	config := gocql.NewCluster("cassandra_host")
	config.QueryObserver = observer
	config.BatchObserver = observer

	session, err := config.CreateSession()
	...
	err = session.Query("SELECT * FROM foo").WithContext(ctx).Exec()
	...
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmredigo"></a>module/apmredigo<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmredigo provides a means of instrumenting <a href="https://github.com/gomodule/redigo" class="ulink" target="_top">Redigo</a>
so that Redis commands are reported as spans within the current transaction.</p>
<p>To report Redis commands, use the top-level <code class="literal">Do</code> or <code class="literal">DoWithTimeout</code> functions.
These functions have the same signature as the <code class="literal">redis.Conn</code> equivalents apart from an
initial <code class="literal">context.Context</code> parameter. If the context passed in contains a sampled
transaction, a span will be reported for the Redis command.</p>
<p>Another top-level function, <code class="literal">Wrap</code>, is provided to wrap a <code class="literal">redis.Conn</code> such that its
<code class="literal">Do</code> and <code class="literal">DoWithTimeout</code> methods call the above mentioned functions. Initially, the
wrapped connection will be associated with the background context; its <code class="literal">WithContext</code>
method may be used to obtain a shallow copy with another context. For example, in an
HTTP middleware you might bind a connection to the request context, which would
associate spans with the request&#8217;s APM transaction.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"net/http"

	"github.com/gomodule/redigo/redis"

	"go.elastic.co/apm/module/apmredigo"
)

var redisPool *redis.Pool // initialized at program startup

func handleRequest(w http.ResponseWriter, req *http.Request) {
	// Wrap and bind redis.Conn to request context. If the HTTP
	// server is instrumented with Elastic APM (e.g. with apmhttp),
	// Redis commands will be reported as spans within the request's
	// transaction.
	conn := apmredigo.Wrap(redisPool.Get()).WithContext(req.Context())
	defer conn.Close()
	...
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmgoredis"></a>module/apmgoredis<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmgoredis provides a means of instrumenting <a href="https://github.com/go-redis/redis" class="ulink" target="_top">go-redis/redis</a>
so that Redis commands are reported as spans within the current transaction.</p>
<p>To report Redis commands, use the top-level <code class="literal">Wrap</code> function to wrap a
<code class="literal">redis.Client</code>, <code class="literal">redis.ClusterClient</code>, or <code class="literal">redis.Ring</code>. Initially, the wrapped
client will be associated with the background context; its <code class="literal">WithContext</code> method
may be used to obtain a shallow copy with another context. For example, in an
HTTP middleware you might bind a client to the request context, which would
associate spans with the request&#8217;s APM transaction.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"net/http"

	"github.com/go-redis/redis"

	"go.elastic.co/apm/module/apmgoredis"
)

var redisClient *redis.Client // initialized at program startup

func handleRequest(w http.ResponseWriter, req *http.Request) {
	// Wrap and bind redisClient to the request context. If the HTTP
	// server is instrumented with Elastic APM (e.g. with apmhttp),
	// Redis commands will be reported as spans within the request's
	// transaction.
	client := apmgoredis.Wrap(redisClient).WithContext(req.Context())
	...
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmgoredisv8"></a>module/apmgoredisv8<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmgoredisv8 provides a means of instrumenting <a href="https://github.com/go-redis/redis" class="ulink" target="_top">go-redis/redis</a> for v8
so that Redis commands are reported as spans within the current transaction.</p>
<p>To report Redis commands, you can call <code class="literal">AddHook(apmgoredis.NewHook())</code>
from instance of <code class="literal">redis.Client</code>, <code class="literal">redis.ClusterClient</code>, or <code class="literal">redis.Ring</code>.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"github.com/go-redis/redis/v8"

	apmgoredis "go.elastic.co/apm/module/apmgoredisv8"
)

func main() {
	redisClient := redis.NewClient(&amp;redis.Options{})
	// Add apm hook to redisClient.
	// Redis commands will be reported as spans within the current transaction.
	redisClient.AddHook(apmgoredis.NewHook())

	redisClient.Get(ctx, "key")
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmrestful"></a>module/apmrestful<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmrestful provides a <a href="https://github.com/emicklei/go-restful" class="ulink" target="_top">go-restful</a> filter
for tracing requests, and capturing panics.</p>
<p>For each request, a transaction is stored in the request context, which can be obtained via
<a href="https://golang.org/pkg/net/http/#Request" class="ulink" target="_top">http.Request</a><code class="literal">.Context()</code> in your handler.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"github.com/emicklei/go-restful"

	"go.elastic.co/apm/module/apmrestful"
)

func init() {
	// Trace all requests to web services registered with the default container.
	restful.Filter(apmrestful.Filter())
}

func main() {
	var ws restful.WebService
	ws.Path("/things").Consumes(restful.MIME_JSON, restful.MIME_XML).Produces(restful.MIME_JSON, restful.MIME_XML)
	ws.Route(ws.GET("/{id:[0-1]+}").To(func(req *restful.Request, resp *restful.Response) {
		// req.Request.Context() should be propagated to downstream operations such as database queries.
	}))
	...
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmchi"></a>module/apmchi<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmchi provides middleware for <a href="https://github.com/go-chi/chi" class="ulink" target="_top">chi</a> routers,
for tracing requests and capturing panics.</p>
<p>For each request, a transaction is stored in the request context, which can be obtained via
<a href="https://golang.org/pkg/net/http/#Request" class="ulink" target="_top">http.Request</a><code class="literal">.Context()</code> in your handler.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"github.com/go-chi/chi"

	"go.elastic.co/apm/module/apmchi"
)

func main() {
	r := chi.NewRouter()
	r.Use(apmchi.Middleware())
	r.Get("/route/{pattern}", routeHandler)
	...
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmlogrus"></a>module/apmlogrus<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmlogrus provides a <a href="https://github.com/sirupsen/logrus" class="ulink" target="_top">logrus</a> Hook
implementation for sending error messages to Elastic APM, as well as a function
for adding trace context fields to log records.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"github.com/sirupsen/logrus"

	"go.elastic.co/apm/module/apmlogrus"
)

func init() {
	// apmlogrus.Hook will send "error", "panic", and "fatal" level log messages to Elastic APM.
	logrus.AddHook(&amp;apmlogrus.Hook{})
}

func handleRequest(w http.ResponseWriter, req *http.Request) {
	// apmlogrus.TraceContext extracts the transaction and span (if any) from the given context,
	// and returns logrus.Fields containing the trace, transaction, and span IDs.
	traceContextFields := apmlogrus.TraceContext(req.Context())
	logrus.WithFields(traceContextFields).Debug("handling request")

	// Output:
	// {"level":"debug","msg":"handling request","time":"1970-01-01T00:00:00Z","trace.id":"67829ae467e896fb2b87ec2de50f6c0e","transaction.id":"67829ae467e896fb"}
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmzap"></a>module/apmzap<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmzap provides a <a href="https://godoc.org/go.uber.org/zap/zapcore#Core" class="ulink" target="_top">go.uber.org/zap/zapcore.Core</a>
implementation for sending error messages to Elastic APM, as well as a function
for adding trace context fields to log records.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"go.uber.org/zap"

	"go.elastic.co/apm/module/apmzap"
)

// apmzap.Core.WrapCore will wrap the core created by zap.NewExample
// such that logs are also sent to the apmzap.Core.
//
// apmzap.Core will send "error", "panic", and "fatal" level log
// messages to Elastic APM.
var logger = zap.NewExample(zap.WrapCore((&amp;apmzap.Core{}).WrapCore))

func handleRequest(w http.ResponseWriter, req *http.Request) {
	// apmzap.TraceContext extracts the transaction and span (if any)
	// from the given context, and returns zap.Fields containing the
	// trace, transaction, and span IDs.
	traceContextFields := apmzap.TraceContext(req.Context())
	logger.With(traceContextFields...).Debug("handling request")

	// Output:
	// {"level":"debug","msg":"handling request","trace.id":"67829ae467e896fb2b87ec2de50f6c0e","transaction.id":"67829ae467e896fb"}
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmzerolog"></a>module/apmzerolog<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmzerolog provides an implementation of <a href="https://github.com/rs/zerolog" class="ulink" target="_top">Zerolog</a>'s
<code class="literal">LevelWriter</code> interface for sending error records to Elastic APM, as well as functions
for adding trace context and detailed error stack traces to log records.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"net/http"

	"github.com/rs/zerolog"

	"go.elastic.co/apm/module/apmzerolog"
)

// apmzerolog.Writer will send log records with the level error or greater to Elastic APM.
var logger = zerolog.New(zerolog.MultiLevelWriter(os.Stdout, &amp;apmzerolog.Writer{}))

func init() {
	// apmzerolog.MarshalErrorStack will extract stack traces from
	// errors produced by github.com/pkg/errors. The main difference
	// with github.com/rs/zerolog/pkgerrors.MarshalStack is that
	// the apmzerolog implementation records fully-qualified function
	// names, enabling errors reported to Elastic APM to be attributed
	// to the correct package.
	zerolog.ErrorStackMarshaler = apmzerolog.MarshalErrorStack
}

func traceLoggingMiddleware(h http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, req *http.Request) {
		ctx := req.Context()
		logger := zerolog.Ctx(ctx).Hook(apmzerolog.TraceContextHook(ctx))
		req = req.WithContext(logger.WithContext(ctx))
		h.ServeHTTP(w, req)
	})
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmelasticsearch"></a>module/apmelasticsearch<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmelasticsearch provides a means of instrumenting the HTTP transport
of Elasticsearch clients, such as <a href="https://github.com/elastic/go-elasticsearch" class="ulink" target="_top">go-elasticsearch</a>
and <a href="https://github.com/olivere/elastic" class="ulink" target="_top">olivere/elastic</a>, so that Elasticsearch
requests are reported as spans within the current transaction.</p>
<p>To create spans for an Elasticsearch request, wrap the client&#8217;s HTTP
transport using the <code class="literal">WrapRoundTripper</code> function, and then associate the request
with a context containing a transaction.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"net/http"

	"github.com/olivere/elastic"

	"go.elastic.co/apm/module/apmelasticsearch"
)

var client, _ = elastic.NewClient(elastic.SetHttpClient(&amp;http.Client{
	Transport: apmelasticsearch.WrapRoundTripper(http.DefaultTransport),
}))

func handleRequest(w http.ResponseWriter, req *http.Request) {
	result, err := client.Search("index").Query(elastic.NewMatchAllQuery()).Do(req.Context())
	...
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmmongo"></a>module/apmmongo<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmmongo provides a means of instrumenting the
<a href="https://github.com/mongodb/mongo-go-driver" class="ulink" target="_top">MongoDB Go Driver</a>, so that MongoDB
commands are reported as spans within the current transaction.</p>
<p>To create spans for MongoDB commands, pass in a <code class="literal">CommandMonitor</code> created
with <code class="literal">apmmongo.CommandMonitor</code> as an option when constructing a client, and then when
executing commands, pass in a context containing a transaction.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"context"
	"net/http"

	"go.mongodb.org/mongo-driver/bson"
	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"

	"go.elastic.co/apm/module/apmmongo"
)

var client, _ = mongo.Connect(
	context.Background(),
	options.Client().SetMonitor(apmmongo.CommandMonitor()),
)

func handleRequest(w http.ResponseWriter, req *http.Request) {
	collection := client.Database("db").Collection("coll")
	cur, err := collection.Find(req.Context(), bson.D{})
	...
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmawssdkgo"></a>module/apmawssdkgo<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmawssdkgo provides a means of instrumenting the
<a href="https://github.com/aws/aws-sdk-go" class="ulink" target="_top">AWS SDK Go</a> session object, so that
AWS requests are reported as spans within the current transaction.</p>
<p>To create spans for AWS requests, you should wrap the <code class="literal">session.Session</code> created
with <code class="literal">session.NewSession</code> when constructing a client. When executing commands,
pass in a context containing a transaction.</p>
<p>The following services are supported:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
S3
</li>
<li class="listitem">
DynamoDB
</li>
<li class="listitem">
SQS
</li>
<li class="listitem">
SNS
</li>
</ul>
</div>
<p>Passing a <code class="literal">session.Session</code> wrapped with <code class="literal">apmawssdkgo.WrapSession</code> to these
services from the AWS SDK will report spans within the current transaction.</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
	"context"
	"net/http"

	"github.com/aws/aws-sdk-go/aws"
	"github.com/aws/aws-sdk-go/aws/session"
	"github.com/aws/aws-sdk-go/service/s3/s3manager"

	"go.elastic.co/apm/module/apmawssdkgo"
)

func main() {
  session := session.Must(session.NewSession())
  session = apmawssdkgo.WrapSession(session)

  uploader := s3manager.NewUploader(session)
  s := &amp;server{uploader}
  ...
}

func (s *server) handleRequest(w http.ResponseWriter, req *http.Request) {
  ctx := req.Context()
  out, err := s.uploader.UploadWithContext(ctx, &amp;s3manager.UploadInput{
    Bucket: aws.String("your-bucket"),
    Key:    aws.String("your-key"),
    Body:   bytes.NewBuffer([]byte("your-body")),
  })
  ...
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="builtin-modules-apmazure"></a>module/apmazure<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/1.x/docs/instrumenting.asciidoc">edit</a></h3>
</div></div></div>
<p>Package apmazure provides a means of instrumenting the
<a href="https://github.com/Azure/azure-pipeline-go" class="ulink" target="_top">Azure Pipeline Go</a> pipeline object,
so that Azure requests are reported as spans within the current transaction.</p>
<p>To create spans for Azure requests, you should create a new pipeline using the
relevant service&#8217;s <code class="literal">NewPipeline</code> function, like <code class="literal">azblob.NewPipeline</code>, then wrap
the <code class="literal">pipeline.Pipeline</code> with <code class="literal">apmazure.WrapPipeline</code>. The returned <code class="literal">Pipeline</code>
can be used as normal.</p>
<p>The following services are supported:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Blob Storage
</li>
<li class="listitem">
Queue Storage
</li>
<li class="listitem">
File Storage
</li>
</ul>
</div>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
  "github.com/Azure/azure-storage-blob-go/azblob"

  "go.elastic.co/apm/module/apmazure"
)

func main() {
  p := azblob.NewPipeline(azblob.NewAnonymousCredential(), po)
  p = apmazure.WrapPipeline(p)
  u, err := url.Parse("https://my-account.blob.core.windows.net")
  serviceURL := azblob.NewServiceURL(*u, p)
  containerURL := serviceURL.NewContainerURL("mycontainer")
  blobURL := containerURL.NewBlobURL("readme.txt")
  // Use the blobURL to interact with Blob Storage
  ...
}</pre>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="getting-started.html">« Set up the Agent</a>
</span>
<span class="next">
<a href="custom-instrumentation.html">Custom instrumentation »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
