<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Metrics | APM Java Agent Reference [1.x] | Elastic</title>
<link rel="home" href="index.html" title="APM Java Agent Reference [1.x]"/>
<link rel="up" href="index.html" title="APM Java Agent Reference [1.x]"/>
<link rel="prev" href="plugin-api.html" title="Plugin API"/>
<link rel="next" href="log-correlation.html" title="Log correlation"/>
<meta name="DC.type" content="Learn/Docs/APM Java Agent/Reference/1.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="1.x"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">APM Java Agent Reference [1.x]</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="plugin-api.html">« Plugin API</a>
</span>
<span class="next">
<a href="log-correlation.html">Log correlation »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="metrics"></a>Metrics<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h1>
</div></div></div>
<p>The Java agent tracks certain system and application metrics.
Some of them have built-in visualizations and some can only be visualized with custom Kibana dashboards.</p>
<p>These metrics will be sent regularly to the APM Server and from there to Elasticsearch.
You can adjust the interval with the setting <a class="xref" href="config-reporter.html#config-metrics-interval" title="metrics_interval ()"><code class="literal">metrics_interval</code></a>.</p>
<p>The metrics will be stored in the <code class="literal">apm-*</code> index and have the <code class="literal">processor.event</code> property set to <code class="literal">metric</code>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Dedicated JVM metrics views are available since Elastic stack version 7.2.
Starting in 7.5, metrics are aggregated separately for each JVM, relying on the ID of the underlying system&#8201;&#8212;&#8201;either container ID (where applicable) or hostname.
Starting in Java agent version 1.11.0, it is possible to manually configure a unique name for each service node/JVM through
<a class="xref" href="config-core.html#config-service-node-name" title="service_node_name ()"><code class="literal">service_node_name</code></a>.
When multiple JVMs are running on the same host and report data for the same service, this configuration is required in order to be able to view metrics at the JVM level.</p>
</div>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="metrics.html#metrics-system" title="System metrics">System metrics</a>
</li>
<li class="listitem">
<a class="xref" href="metrics.html#metrics-cgroup" title="cgroup metrics (added in 1.18.0)">cgroup metrics</a>
</li>
<li class="listitem">
<a class="xref" href="metrics.html#metrics-jvm" title="JVM Metrics">JVM Metrics</a>
</li>
<li class="listitem">
<a class="xref" href="metrics.html#metrics-application" title="Built-in application metrics">Built-in application metrics</a>
</li>
<li class="listitem">
<a class="xref" href="metrics.html#metrics-only-mode" title="Use the agent for metrics collection only">Use the agent for metrics collection only</a>
</li>
<li class="listitem">
<a class="xref" href="metrics.html#metrics-micrometer" title="Micrometer metrics">Micrometer metrics</a>
</li>
</ul>
</div>
<h3><a id="metrics-system"></a>System metrics<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h3>
<p>Host metrics. As of version 6.6, these metrics will be visualized in the APM app.</p>
<p>For more system metrics, consider installing <a href="/guide/en/beats/metricbeat/8.3/index.html" class="ulink" target="_top">metricbeat</a> on your hosts.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">system.cpu.total.norm.pct</code></strong></span>
</span>
</dt>
<dd>
<p>type: scaled_float</p>
<p>format: percent</p>
<p>The percentage of CPU time in states other than Idle and IOWait, normalised by the number of cores.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">system.process.cpu.total.norm.pct</code></strong></span>
</span>
</dt>
<dd>
<p>type: scaled_float</p>
<p>format: percent</p>
<p>The percentage of CPU time spent by the process since the last event.
This value is normalized by the number of CPU cores and it ranges from 0 to 100%.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">system.memory.total</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>Total memory.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">system.memory.actual.free</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>Actual free memory in bytes. It is calculated based on the OS.
On Linux it consists of the free memory plus caches and buffers.
On OSX it is a sum of free memory and the inactive memory.
On Windows, this value does not include memory consumed by system caches and buffers.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">system.process.memory.size</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>The total virtual memory the process has.</p>
</dd>
</dl>
</div>
<h3><a id="metrics-cgroup"></a>cgroup metrics (added in 1.18.0)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h3>
<p>Linux&#8217;s cgroup metrics.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">system.process.cgroup.memory.mem.limit.bytes</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>Memory limit for current cgroup slice.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">system.process.cgroup.memory.mem.usage.bytes</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>Memory usage in current cgroup slice.</p>
</dd>
</dl>
</div>
<h3><a id="metrics-jvm"></a>JVM Metrics<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h3>
<p>JVM-specific metrics</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">jvm.memory.heap.used</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>The amount of used heap memory in bytes</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">jvm.memory.heap.committed</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>The amount of heap memory in bytes that is committed for the Java virtual machine to use.
This amount of memory is guaranteed for the Java virtual machine to use.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">jvm.memory.heap.max</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>The maximum amount of heap memory in bytes that can be used for memory management.
If the maximum memory size is undefined, the value is <code class="literal">-1</code>.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">jvm.memory.heap.pool.used</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>The amount of used memory in bytes of the memory pool specified by the <code class="literal">name</code> label</p>
<p>labels</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
name: The name representing this memory pool
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">jvm.memory.heap.pool.committed</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>The amount of memory in bytes that is committed for the memory pool specified by the <code class="literal">name</code> label.
This amount of memory is guaranteed for this specific pool.</p>
<p>labels</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
name: The name representing this memory pool
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">jvm.memory.heap.pool.max</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>The maximum amount of memory in bytes that can be used for the memory pool specified by the <code class="literal">name</code> label.</p>
<p>labels</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
name: The name representing this memory pool
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">jvm.memory.non_heap.used</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>The amount of used non-heap memory in bytes</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">jvm.memory.non_heap.committed</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>The amount of non-heap memory in bytes that is committed for the Java virtual machine to use.
This amount of memory is guaranteed for the Java virtual machine to use.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">jvm.memory.non_heap.max</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>The maximum amount of non-heap memory in bytes that can be used for memory management.
If the maximum memory size is undefined, the value is <code class="literal">-1</code>.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">jvm.thread.count</code></strong></span>
</span>
</dt>
<dd>
<p>type: int</p>
<p>The current number of live threads in the JVM, including both daemon and non-daemon threads.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">jvm.gc.count</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>labels</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
name: The name representing this memory manager (for example <code class="literal">G1 Young Generation</code>, <code class="literal">G1 Old Generation</code>)
</li>
</ul>
</div>
<p>The total number of collections that have occurred.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">jvm.gc.time</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: ms</p>
<p>labels</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
name: The name representing this memory manager (for example <code class="literal">G1 Young Generation</code>, <code class="literal">G1 Old Generation</code>)
</li>
</ul>
</div>
<p>The approximate accumulated collection elapsed time in milliseconds.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">jvm.gc.alloc</code></strong></span>
</span>
</dt>
<dd>
<p>type: long</p>
<p>format: bytes</p>
<p>An approximation of the total amount of memory,
in bytes, allocated in heap memory.</p>
</dd>
</dl>
</div>
<h3><a id="metrics-application"></a>Built-in application metrics<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h3>
<p>To power the <a href="/guide/en/kibana/8.3/transactions.html" class="ulink" target="_top">Time spent by span type</a> graph,
the agent collects summarized metrics about the timings of spans and transactions,
broken down by span type.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">span.self_time</code></strong></span>
</span>
</dt>
<dd>
<p>type: simple timer</p>
<p>This timer tracks the span self-times and is the basis of the transaction breakdown visualization.</p>
<p>Fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">sum.us</code>: The sum of all span self-times in microseconds since the last report (the delta)
</li>
<li class="listitem">
<code class="literal">count</code>: The count of all span self-times since the last report (the delta)
</li>
</ul>
</div>
<p>You can filter and group by these dimensions:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">transaction.name</code>: The name of the transaction
</li>
<li class="listitem">
<code class="literal">transaction.type</code>: The type of the transaction, for example <code class="literal">request</code>
</li>
<li class="listitem">
<code class="literal">span.type</code>: The type of the span, for example <code class="literal">app</code>, <code class="literal">template</code> or <code class="literal">db</code>
</li>
<li class="listitem">
<code class="literal">span.subtype</code>: The sub-type of the span, for example <code class="literal">mysql</code> (optional)
</li>
</ul>
</div>
</dd>
</dl>
</div>
<h3><a id="metrics-only-mode"></a>Use the agent for metrics collection only<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h3>
<p>There are cases where you would want to use the agent only to collect and ship metrics, without tracing any Java code.
In such cases, you may set the <a class="xref" href="config-core.html#config-instrument" title="instrument ()"><code class="literal">instrument</code></a> config option to <code class="literal">false</code>. By doing so, the agent will
minimize its effect on the application, while still collecting and sending metrics to the APM Server.</p>
<h3><a id="metrics-micrometer"></a>Micrometer metrics<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h3>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in beta and is subject to change. The design and code is less mature than official GA features and is being provided as-is with no warranties. Beta features are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>The Elastic APM Java agent lets you use the popular metrics collection framework <a href="https://micrometer.io/" class="ulink" target="_top">Micrometer</a> to track custom application metrics.</p>
<p>Some use cases for tracking custom metrics from your application include monitoring performance-related things like cache statistics, thread pools, or page hits.
However, you can also track business-related metrics such as revenue and correlate them with performance metrics.
Metrics registered to a Micrometer <code class="literal">MeterRegistry</code> are aggregated in memory and reported every <a class="xref" href="config-reporter.html#config-metrics-interval" title="metrics_interval ()"><code class="literal">metrics_interval</code></a>.
Based on the metadata about the service and the timestamp, you can correlate metrics with traces.
The advantage is that the metrics won&#8217;t be affected by the
<a class="xref" href="config-core.html#config-transaction-sample-rate" title="transaction_sample_rate (performance)">sampling rate</a> and usually take up less space.
That is because not every event is stored individually.</p>
<p>The limitation of tracking metrics is that you won&#8217;t be able to attribute a value to a specific transaction.
If you&#8217;d like to do that, <a class="xref" href="public-api.html#api-transaction-add-tag" title="Transaction setLabel(String key, value)">add labels</a> to your transaction instead of tracking the metric with Micrometer.
The tradeoff here is that you either have to do 100% sampling or account for the missing events.
The reason for that is that if you set your sampling rate to 10%, for example,
you&#8217;ll only be storing one out of 10 requests.
The labels you set on non-sampled transactions will be lost.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="metrics.html#metrics-micrometer-beta-caveats" title="Caveats">Caveats</a>
</li>
<li class="listitem">
<a class="xref" href="metrics.html#metrics-micrometer-get-started-existing" title="Get started with existing Micrometer setup">Get started with existing Micrometer setup</a>
</li>
<li class="listitem">
<a class="xref" href="metrics.html#metrics-micrometer-get-started-from-scratch" title="Get started from scratch">Get started from scratch</a>
</li>
<li class="listitem">
<a class="xref" href="metrics.html#metrics-micrometer-spring-boot" title="Get started with Spring Boot">Get started with Spring Boot</a>
</li>
<li class="listitem">
<a class="xref" href="metrics.html#metrics-micrometer-fields" title="Supported Meters">Supported Meters</a>
</li>
</ul>
</div>
<h4><a id="metrics-micrometer-beta-caveats"></a>Caveats<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h4>
<p>To fix some of the caveats listed here, we may have to introduce breaking changes.
Please look for Micrometer-related release notes before updating.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Dots in metric names of Micrometer metrics get replaced with underscores to avoid mapping conflicts.
De-dotting can be disabled via <a class="xref" href="config-metrics.html#config-dedot-custom-metrics" title="dedot_custom_metrics ()"><code class="literal">dedot_custom_metrics</code></a>.
</li>
<li class="listitem">
Histograms (<a href="https://www.javadoc.io/doc/io.micrometer/micrometer-core/latest/io/micrometer/core/instrument/DistributionSummary.html" class="ulink" target="_top">DistributionSummary</a>,
<a href="https://www.javadoc.io/doc/io.micrometer/micrometer-core/latest/io/micrometer/core/instrument/Timer.html" class="ulink" target="_top">Timer</a>,
and <a href="https://www.javadoc.io/doc/io.micrometer/micrometer-core/latest/io/micrometer/core/instrument/LongTaskTimer.html" class="ulink" target="_top">LongTaskTimer</a>)
are partially supported by converting the histogram metric into two derived metrics: a counter of the values and the sum of the values.
For example, <code class="literal">DistributionSummary.builder("order").register(...).record(orderPrice)</code> will create two metrics: <code class="literal">order.sum</code> and <code class="literal">order.count</code>.
</li>
<li class="listitem">
When multiple <code class="literal">MeterRegistry</code> s are used, the metrics are de-duplicated based on their meter id.
  However, it is non-deterministic which metrics are favored if multiple meter registries are used within a compound meter registry.
See <a href="https://github.com/elastic/apm-agent-java/issues/1476" class="ulink" target="_top">#1476</a>
</li>
<li class="listitem">
When using <code class="literal">CountingMode.STEP</code>, the step duration has to be aligned with <a class="xref" href="config-reporter.html#config-metrics-interval" title="metrics_interval ()"><code class="literal">metrics_interval</code></a>.
But even if doing that there can be missing values. See <a href="https://github.com/elastic/apm-agent-java/issues/1476" class="ulink" target="_top">#1476</a>
</li>
<li class="listitem">
When using <code class="literal">CountingMode.CUMULATIVE</code>, you can use TSVB&#8217;s "Positive Rate" aggregation to convert the counter to a rate.
But you have to remember to group by a combination of dimensions that uniquely identify the time series.
This may be a combination of <code class="literal">host.name</code> and <code class="literal">service.name</code>, or the <code class="literal">kubernetes.pod.id</code>.
</li>
</ul>
</div>
<h4><a id="metrics-micrometer-get-started-existing"></a>Get started with existing Micrometer setup<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h4>
<p>Attach the agent, and you’re done!
The agent automatically detects all <code class="literal">MeterRegistry</code> instances and reports all metrics to APM Server (in addition to where they originally report).
When attaching the agent after the application has already started, the agent detects a <code class="literal">MeterRegistry</code> when calling any public method on it.
If you are using multiple registries within a <code class="literal">CompoundMeterRegistry</code>, the agent only reports the metrics once.</p>
<h4><a id="verify-micrometer-data"></a>Verify Micrometer data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h4>
<p>Use Discover to validate that metrics are successfully reported to Kibana.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Launch Kibana.
</li>
<li class="listitem">
Open the main menu, then click <span class="strong strong"><strong>Discover</strong></span>.
</li>
<li class="listitem">
Select <code class="literal">apm-*</code> as your index pattern.
</li>
<li class="listitem">
Filter the data to only show documents with metrics: <code class="literal">processor.name :"metric"</code>
</li>
<li class="listitem">
Optionally, apply additional filters by service or host names if Micrometer was only instrumented on a subset of your environment.
</li>
</ol>
</div>
<p>You should now see documents containing both metrics collected by the APM agent and custom metrics from Micrometer.
Narrow your search with a known Micrometer metric field.
For example, if you know you have registered the metric name <code class="literal">cache.puts</code> in the Micrometer <code class="literal">MeterRegistry</code>, add <code class="literal">cache_puts: *</code> (dots are replaced with underscores) to your search to return only Micrometer metrics documents.</p>
<h4><a id="visualize-micrometer-data"></a>Visualize Micrometer data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h4>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Monotonically increased counters and Positive rate aggregations are not fully supported in the current version.</p>
</div>
</div>
<p><a href="/guide/en/kibana/8.3/tsvb.html" class="ulink" target="_top">TSVB</a> is the recommended visualization for Micrometer metrics.
First, make sure to select the right aggregation. The most common options are:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Sum: Useful for business metrics
</li>
<li class="listitem">
Average: Usually used for performance-related metrics
</li>
</ul>
</div>
<p>It&#8217;s common to group metrics by attributes, including Micrometer labels or attributes already collected by APM agents. This could be service versions, runtime versions, or even cloud metadata.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>See the <a href="/blog/visualizing-observability-with-kibana-event-rates-and-rate-of-change-in-tsvb" class="ulink" target="_top">Event rates and rate of change in TSVB</a> blog post for more information.</p>
</div>
</div>
<h4><a id="metrics-micrometer-get-started-from-scratch"></a>Get started from scratch<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h4>
<p>Declare a dependency to Micrometer:</p>
<div class="pre_wrapper lang-xml">
<pre class="programlisting prettyprint lang-xml">&lt;dependency&gt;
    &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
    &lt;artifactId&gt;micrometer-core&lt;/artifactId&gt;
    &lt;version&gt;${micrometer.version}&lt;/version&gt;
&lt;/dependency&gt;</pre>
</div>
<p>Create a Micrometer <code class="literal">MeterRegistry</code>.</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">MeterRegistry registry = new SimpleMeterRegistry(new SimpleConfig() {

        @Override
        public CountingMode mode() {
            // to report the delta since the last report
            // this makes building dashbaords a bit easier
            return CountingMode.STEP;
        }

        @Override
        public Duration step() {
            // the duration should match metrics_interval, which defaults to 30s
            return Duration.ofSeconds(30);
        }

        @Override
        public String get(String key) {
            return null;
        }
    }, Clock.SYSTEM);</pre>
</div>
<h4><a id="metrics-micrometer-spring-boot"></a>Get started with Spring Boot<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h4>
<p>The easiest way to get started with Spring Boot is to add a dependency to <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html" class="ulink" target="_top">Spring Boot Actuator</a>.
Spring Boot Actuator provides dependency management and auto-configuration for Micrometer.</p>
<p>Use the <code class="literal">management.metrics.export.simple</code> prefix to configure via <code class="literal">application.properties</code></p>
<div class="pre_wrapper lang-properties">
<pre class="programlisting prettyprint lang-properties">management.metrics.export.simple.enabled=true
management.metrics.export.simple.step=30s
management.metrics.export.simple.mode=STEP</pre>
</div>
<h4><a id="metrics-micrometer-fields"></a>Supported Meters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/metrics.asciidoc">edit</a></h4>
<p>This section lists all supported Micrometer <code class="literal">Meter</code> s and describes how they are mapped to Elasticsearch documents.</p>
<p>Micrometer tags are nested under <code class="literal">labels</code>. Example:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">"labels": {
  "tagKey1": "tagLabel1",
  "tagKey2": "tagLabel2",
}</pre>
</div>
<p>Labels are great for breaking down metrics by different dimensions.
Although there is no upper limit, note that a high number of distinct values per label (aka high cardinality) may lead to higher memory usage,
higher index sizes, and slower queries.
Also, make sure the number of distinct tag keys is limited to avoid <a href="/guide/en/elasticsearch/reference/8.3/mapping.html#mapping-limit-settings" class="ulink" target="_top">mapping explosions</a>.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">Timer</code></strong></span>
</span>
</dt>
<dd>
<p>Fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">${name}.sum.us</code>: The total time of recorded events (the delta when using <code class="literal">CountingMode.STEP</code>).
This is equivalent to <code class="literal">timer.totalTime(TimeUnit.MICROSECONDS)</code>.
</li>
<li class="listitem">
<code class="literal">${name}.count</code>: The number of times that stop has been called on this timer (the delta when using <code class="literal">CountingMode.STEP</code>).
This is equivalent to <code class="literal">timer.count()</code>.
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">FunctionTimer</code></strong></span>
</span>
</dt>
<dd>
<p>Fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">${name}.sum.us</code>: The total time of all occurrences of the timed event (the delta when using <code class="literal">CountingMode.STEP</code>).
This is equivalent to <code class="literal">functionTimer.totalTime(TimeUnit.MICROSECONDS)</code>.
</li>
<li class="listitem">
<code class="literal">${name}.count</code>: The total number of occurrences of the timed event (the delta when using <code class="literal">CountingMode.STEP</code>).
This is equivalent to <code class="literal">functionTimer.count()</code>.
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">LongTaskTimer</code></strong></span>
</span>
</dt>
<dd>
<p>Fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">${name}.sum.us</code>: The cumulative duration of all current tasks (the delta when using <code class="literal">CountingMode.STEP</code>).
This is equivalent to <code class="literal">longTaskTimer.totalTime(TimeUnit.MICROSECONDS)</code>.
</li>
<li class="listitem">
<code class="literal">${name}.count</code>: The current number of tasks being executed (the delta when using <code class="literal">CountingMode.STEP</code>)
This is equivalent to <code class="literal">longTaskTimer.activeTasks()</code>.
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">DistributionSummary</code></strong></span>
</span>
</dt>
<dd>
<p>Fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">${name}.sum</code>: The total amount of all recorded events (the delta when using <code class="literal">CountingMode.STEP</code>).
This is equivalent to <code class="literal">distributionSummary.totalAmount()</code>.
</li>
<li class="listitem">
<code class="literal">${name}.count</code>: The number of times that record has been called (the delta when using <code class="literal">CountingMode.STEP</code>).
This is equivalent to <code class="literal">distributionSummary.count()</code>.
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">Gauge</code></strong></span>
</span>
</dt>
<dd>
<p>Fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">${name}</code>: The value of <code class="literal">gauge.value()</code>.
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">Counter</code></strong></span>
</span>
</dt>
<dd>
<p>Fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">${name}</code>: The value of <code class="literal">counter.count()</code> (the delta when using <code class="literal">CountingMode.STEP</code>).
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">FunctionCounter</code></strong></span>
</span>
</dt>
<dd>
<p>Fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">${name}</code>: The value of <code class="literal">functionCounter.count()</code> (the delta when using <code class="literal">CountingMode.STEP</code>).
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="plugin-api.html">« Plugin API</a>
</span>
<span class="next">
<a href="log-correlation.html">Log correlation »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
