<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Overhead and Performance tuning | APM Java Agent Reference [1.x] | Elastic</title>
<link rel="home" href="index.html" title="APM Java Agent Reference [1.x]"/>
<link rel="up" href="index.html" title="APM Java Agent Reference [1.x]"/>
<link rel="prev" href="method-config-based.html" title="Configuration-based"/>
<link rel="next" href="trouble-shooting.html" title="Troubleshooting"/>
<meta name="DC.type" content="Learn/Docs/APM Java Agent/Reference/1.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="1.x"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">APM Java Agent Reference [1.x]</a></span>
»
<span class="breadcrumb-node">Overhead and Performance tuning</span>
</div>
<div class="navheader">
<span class="prev">
<a href="method-config-based.html">« Configuration-based</a>
</span>
<span class="next">
<a href="trouble-shooting.html">Troubleshooting »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="tuning-and-overhead"></a>Overhead and Performance tuning<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/tuning-and-overhead.asciidoc">edit</a></h1>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="tuning-and-overhead.html#agent-overhead" title="Agent overhead">Agent overhead</a>
</li>
<li class="listitem">
<a class="xref" href="tuning-and-overhead.html#tuning-agent" title="Tuning the Agent">Tuning the Agent</a>
</li>
<li class="listitem">
<a class="xref" href="tuning-and-overhead.html#circuit-breaker" title="Circuit Breaker (experimental)">Circuit Breaker (experimental)</a>
</li>
</ul>
</div>
<h3><a id="agent-overhead"></a>Agent overhead<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/tuning-and-overhead.asciidoc">edit</a></h3>
<p>Any APM Agent will impose overhead.
Here are a few different areas where that overhead might be seen.</p>
<h4><a id="_latency"></a>Latency<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/tuning-and-overhead.asciidoc">edit</a></h4>
<p>Great care is taken to keep code on critical paths as lightweight as possible.
For example, the actual reporting of events is done on a background thread.</p>
<p>It is very important that both the average latency, and higher percentiles of latency are low.
That&#8217;s because a low average latency means nothing if 1% of your requests experiences very poor performance.
The main sources of spikes in higher latencies are garbage collection pauses and contended locks.</p>
<p>We take great care to minimize the memory allocations we do in the Java agent as much as possible.
For example, instead of allocating new objects, we take them from an object pool and return them to the pool when they are not used anymore.
More details on this process can be found <a href="https://github.com/elastic/apm-agent-java/blob/master/apm-agent-core/README.md#lifecycle" class="ulink" target="_top">here</a>.
When it comes to reporting the recorded events,
we directly serialize them into the output stream of the request to the APM server while only relying on reusable buffers.
This way we can report events without allocating any objects.
We do all that in order to not add additional work for the GC which is already busy cleaning up the memory your application is allocating.</p>
<p>The Java agent also uses specialized data structures (LMAX Disruptor and queues from JCTools)
when we transfer events across threads.
For example, from the application threads which record transactions to the background reporter thread.
This is to circumvent problems like lock contention and false sharing you would get from standard JDK data structures like <code class="literal">ArrayBlockingQueue</code>.</p>
<p>In single-threaded benchmarks,
our Java agent imposes an overhead in the order of single-digit microseconds (µs) up to the 99.99th percentile.
The benchmarks were run on a Linux machine with an i7-7700 (3.60GHz) on Oracle JDK 10.
We are currently working on multi-threaded benchmarks.
When disabling header recording, the agent allocates less than one byte for recording an HTTP request and one JDBC (SQL) query,
including reporting those events in the background to the APM Server.</p>
<h4><a id="_cpu"></a>CPU<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/tuning-and-overhead.asciidoc">edit</a></h4>
<p>Even though the Agent does most of its work in the background, serializing and compressing events,
along with sending them to the APM Server does actually also add a bit of CPU overhead.
If your application is not CPU bound, this shouldn’t matter much.
Your application is probably not CPU bound if you do (blocking) network I/O,
like communicating with databases or external services.</p>
<p>In a scenario where APM Server can’t handle all of the events,
the Agent will drop data so as to not crash your application.</p>
<h4><a id="_memory"></a>Memory<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/tuning-and-overhead.asciidoc">edit</a></h4>
<p>Unless you have really small heaps,
you usually don&#8217;t have to increase the heap size for the Java Agent.
It has a fairly small and static memory overhead for the object pools, and some small buffers in the order of a couple of megabytes.</p>
<h4><a id="_network"></a>Network<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/tuning-and-overhead.asciidoc">edit</a></h4>
<p>The Agent requires some network bandwidth, as it needs to send recorded events to the APM server.
This is where it&#8217;s important to know how many requests your application handles and how many of those you want to record and store.
This can be adjusted with the <a class="xref" href="tuning-and-overhead.html#tune-sample-rate" title="Sample rate">Sample rate</a>.</p>
<h3><a id="tuning-agent"></a>Tuning the Agent<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/tuning-and-overhead.asciidoc">edit</a></h3>
<p>The Java agent offers a variety of <a class="xref" href="configuration.html" title="Configuration">configuration options</a>,
some of which can have a significant impact on performance.
To make it easy to determine which options impact performance,
we&#8217;ve tagged certain configuration options in the documentation with <em>(performance)</em>.</p>
<h4><a id="tune-sample-rate"></a>Sample rate<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/tuning-and-overhead.asciidoc">edit</a></h4>
<p><em>Sample rate</em> is the percentage of requests which should be recorded and sent to the APM Server.
What is an ideal sample rate? Unfortunately, there&#8217;s no one-size-fits-all answer to that question.
Sampling comes down to your preferences and your application.
The more you want to sample, the more network bandwidth and disk space you’ll need.</p>
<p>It’s important to note that the latency of an application won’t be affected much by the agent,
even if you sample at 100%.
However, the background reporter thread has some work to do when serializing and gzipping events.</p>
<p>The sample rate can be changed by altering the <a class="xref" href="config-core.html#config-transaction-sample-rate" title="transaction_sample_rate (performance)"><code class="literal">transaction_sample_rate</code> (performance)</a>.</p>
<h4><a id="_stack_trace_collection"></a>Stack trace collection<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/tuning-and-overhead.asciidoc">edit</a></h4>
<p>If a span, e.g., a captured JDBC query, takes longer than 5ms,
we capture the stack trace so that you can easily find the code path which lead to the query.
Stack traces can be quite long, taking up bandwidth and disk space, and also requiring object allocations.
But because we are processing the stack trace asynchronously, it adds very little latency.
Upping the <a class="xref" href="config-stacktrace.html#config-span-frames-min-duration" title="span_frames_min_duration (performance)"><code class="literal">span_frames_min_duration</code> (performance)</a> or disabling stack trace collection altogether can gain you a bit of performance if needed.</p>
<h4><a id="_recording_headers_and_cookies"></a>Recording headers and cookies<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/tuning-and-overhead.asciidoc">edit</a></h4>
<p>By default, the Java agent records all request and response headers, including cookies.
Disabling <a class="xref" href="config-core.html#config-capture-headers" title="capture_headers (performance)"><code class="literal">capture_headers</code> (performance)</a> can save allocations, network bandwidth, and disk space.</p>
<h3><a id="circuit-breaker"></a>Circuit Breaker (experimental)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/tuning-and-overhead.asciidoc">edit</a></h3>
<p>When enabled, the agent periodically polls stress monitors to detect system/process/JVM stress state.
If ANY of the monitors detects a stress indication, the agent will become inactive, as if the
<a class="xref" href="config-core.html#config-recording" title="recording ()"><code class="literal">recording</code></a> configuration option has been set to <code class="literal">false</code>, thus reducing resource consumption to a minimum.
When inactive, the agent continues polling the same monitors in order to detect whether the stress state
has been relieved. If ALL monitors approve that the system/process/JVM is not under stress anymore, the
agent will resume and become fully functional.
For fine-grained Circuit Breaker configurations please refer to <a class="xref" href="config-circuit-breaker.html" title="Circuit-Breaker configuration options">Circuit-Breaker configuration options</a>.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="method-config-based.html">« Configuration-based</a>
</span>
<span class="next">
<a href="trouble-shooting.html">Troubleshooting »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Most Popular</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Get Started with Elasticsearch: Video</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Intro to Kibana: Video</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">ELK for Logs & Metrics: Video</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
