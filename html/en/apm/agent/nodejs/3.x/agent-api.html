<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Agent API | APM Node.js Agent Reference [3.x] | Elastic</title>
<meta class="elastic" name="content" content="Agent API | APM Node.js Agent Reference [3.x]">

<link rel="home" href="index.html" title="APM Node.js Agent Reference [3.x]"/>
<link rel="up" href="api.html" title="API Reference"/>
<link rel="prev" href="api.html" title="API Reference"/>
<link rel="next" href="transaction-api.html" title="Transaction API"/>
<meta class="elastic" name="product_version" content="3.x"/>
<meta class="elastic" name="product_name" content="APM"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/APM Node.js Agent/Reference/3.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="3.x"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles-v1.css" />
  </head>

  <!--© 2015-2025 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="api.html">« API Reference</a>
</span>
<span class="next">
<a href="transaction-api.html"><code class="literal">Transaction</code> API »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link">
  <div id="related-products" class="dropdown">
  <div class="related-products-title">APM:</div>
  <div class="dropdown-anchor" tabindex="0">Node.js Agent Reference<span class="dropdown-icon"></span></div>
  <div class="dropdown-content">
  <ul>
  <li class="dropdown-category">APM</li>
  <ul>
  <li><a href="/guide/en/observability/current/apm.html">Observability › APM</a></li>
  </ul>
  <li class="dropdown-category">APM agents</li>
  <ul>
  <li><a href="/guide/en/apm/agent/android/current/intro.html">Android Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/go/current/introduction.html">Go Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/swift/current/intro.html">iOS Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/java/current/intro.html">Java Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/dotnet/current/intro.html">.NET Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/nodejs/current/intro.html">Node.js Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/php/current/intro.html">PHP Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/python/current/getting-started.html">Python Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/ruby/current/introduction.html">Ruby Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/rum-js/current/intro.html">Real User Monitoring JavaScript Agent Reference</a></li>
  </ul>
  <li class="dropdown-category">APM extensions</li>
  <ul>
  <li><a href="/guide/en/apm/lambda/current/aws-lambda-arch.html">AWS Lambda extension</a></li>
  <li><a href="/guide/en/apm/attacher/current/apm-attacher.html">Attacher</a></li>
  </ul>
  </ul>
  </div>
  </div>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="api.html">API Reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Agent API</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="agent-api"></a><code class="literal">Agent</code> API<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h2>
</div></div></div>
<p>The Elastic APM Node.js agent is a singleton. You get the agent instance by requiring either <code class="literal">elastic-apm-node</code> or <code class="literal">elastic-apm-node/start</code>. The agent is also returned by the <a class="xref" href="agent-api.html#apm-start" title="apm.start([options])"><code class="literal">.start()</code></a> method, which allows you to require and start the agent on the same line:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">const apm = require('elastic-apm-node').start(...)</pre>
</div>
<p>If you need to access the <code class="literal">Agent</code> in any part of your codebase,
you can simply require <code class="literal">elastic-apm-node</code> to access the already started singleton.
You therefore don&#8217;t need to manage or pass around the started <code class="literal">Agent</code> yourself.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-start"></a><code class="literal">apm.start([options])</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p>Starts the Elastic APM agent for Node.js and returns itself.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>For the APM agent to automatically instrument Node.js modules, it must be started before those modules are loaded. See <a class="xref" href="starting-the-agent.html" title="Starting the agent">Starting the agent</a> for details and possible surprises with compilers/transpilers/bundlers.</p>
</div>
</div>
<p>See the <a class="xref" href="configuration.html" title="Configuration options">Configuration documentation</a> for available options.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-is-started"></a><code class="literal">apm.isStarted()</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v1.5.0</span></p>
<p>Use <code class="literal">isStarted()</code> to check if the agent has already started.
Returns <code class="literal">true</code> if the agent has started,
otherwise returns <code class="literal">false</code>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-get-service-name"></a><code class="literal">apm.getServiceName()</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v3.11.0</span></p>
<p>Get the configured <a class="xref" href="configuration.html#service-name" title="serviceName"><code class="literal">serviceName</code></a>. If a service name was not
explicitly configured, this value may have been automatically determined.
The service name is not determined until <code class="literal">agent.start()</code>, so will be <code class="literal">undefined</code>
until then. A misconfigured agent can have a <code class="literal">null</code> service name.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-set-framework"></a><code class="literal">apm.setFramework(options)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v2.8.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p><code class="literal">options</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="ulink" target="_top">&lt;Object&gt;</a></code> The following options are supported:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> Framework name.
</li>
<li class="listitem">
<code class="literal">version</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> Framework version.
</li>
<li class="listitem">
<code class="literal">overwrite</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="ulink" target="_top">&lt;boolean&gt;</a></code> If set to <code class="literal">false</code>,
the <a class="xref" href="configuration.html#framework-name" title="frameworkName"><code class="literal">frameworkName</code></a> and <a class="xref" href="configuration.html#framework-version" title="frameworkVersion"><code class="literal">frameworkVersion</code></a> provided as <a class="xref" href="configuration.html" title="Configuration options">config options</a> will not be overwritten.
<span class="strong strong"><strong>Default:</strong></span> <code class="literal">true</code>.
</li>
</ul>
</div>
</li>
</ul>
</div>
<p>Set or change the <a class="xref" href="configuration.html#framework-name" title="frameworkName"><code class="literal">frameworkName</code></a> or <a class="xref" href="configuration.html#framework-version" title="frameworkVersion"><code class="literal">frameworkVersion</code></a> after the agent has started.
These config options can also be provided as part of the <a class="xref" href="configuration.html" title="Configuration options">regular agent configuration</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-add-filter"></a><code class="literal">apm.addFilter(fn)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v0.1.0</span></p>
<p>Use <code class="literal">addFilter()</code> to supply a filter function.</p>
<p>Each filter function will be called just before data is being sent to the APM Server.
This will allow you to manipulate the data being sent,
for instance to remove sensitive information like passwords etc.
(Note: Filters added via <code class="literal">addFilter</code> are <span class="strong strong"><strong>not</strong></span> applied to the "metadata"
object sent to the APM Server&#8201;&#8212;&#8201;use <code class="literal">addMetadataFilter</code> instead.)</p>
<p>Each filter function will be called in the order they were added,
and will receive a <code class="literal">payload</code> object as the only argument,
containing the data about to be sent to the APM Server.</p>
<p>The format of the payload depends on the event type being sent.
For details about the different formats,
see the <a href="/guide/en/apm/guide/8.15/api-events.html" class="ulink" target="_top">events intake API docs</a>.</p>
<p>The filter function is synchronous and should return the manipulated payload object.
If a filter function doesn&#8217;t return any value or returns a falsy value,
the remaining filter functions will not be called and the payload <span class="strong strong"><strong>will not</strong></span> be sent to the APM Server.</p>
<p>Example usage:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">apm.addFilter(function redactSecretHeader(payload) {
  if (payload.context &amp;&amp;
      payload.context.request &amp;&amp;
      payload.context.request.headers &amp;&amp;
      payload.context.request.headers['x-secret']) {
    // redact sensitive data
    payload.context.request.headers['x-secret'] = '[REDACTED]'
  }

  // remember to return the modified payload
  return payload
})</pre>
</div>
<p>A set of built-in filters are added by default.
See <a class="xref" href="configuration.html#filter-http-headers" title="filterHttpHeaders"><code class="literal">filterHttpHeaders</code></a> for details.</p>
<p>Though you can also use filter functions to add new contextual information to the <code class="literal">user</code> and <code class="literal">custom</code> properties,
it&#8217;s recommended that you use <a class="xref" href="agent-api.html#apm-set-user-context" title="apm.setUserContext(context)"><code class="literal">apm.setUserContext()</code></a> and <a class="xref" href="agent-api.html#apm-set-custom-context" title="apm.setCustomContext(context)"><code class="literal">apm.setCustomContext()</code></a> for that purpose.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-add-error-filter"></a><code class="literal">apm.addErrorFilter(fn)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v2.0.0</span></p>
<p>Similar to <a class="xref" href="agent-api.html#apm-add-filter" title="apm.addFilter(fn)"><code class="literal">apm.addFilter()</code></a>,
but the <code class="literal">fn</code> will only be called with error payloads.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-add-transaction-filter"></a><code class="literal">apm.addTransactionFilter(fn)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v2.0.0</span></p>
<p>Similar to <a class="xref" href="agent-api.html#apm-add-filter" title="apm.addFilter(fn)"><code class="literal">apm.addFilter()</code></a>,
but the <code class="literal">fn</code> will only be called with transaction payloads.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-add-span-filter"></a><code class="literal">apm.addSpanFilter(fn)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v2.0.0</span></p>
<p>Similar to <a class="xref" href="agent-api.html#apm-add-filter" title="apm.addFilter(fn)"><code class="literal">apm.addFilter()</code></a>,
but the <code class="literal">fn</code> will only be called with span payloads.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-add-metadata-filter"></a><code class="literal">apm.addMetadataFilter(fn)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v3.14.0</span></p>
<p>Use <code class="literal">addMetadataFilter(fn)</code> to supply a filter function for the
<a href="/guide/en/apm/guide/8.15/api-metadata.html#api-metadata-schema" class="ulink" target="_top">metadata object</a>
sent to the APM Server. This will allow you to manipulate the data being
sent, for instance to remove possibly sensitive information.</p>
<p>Each filter function will be called in the order they were added, and will
receive a <code class="literal">metadata</code> object as the only argument. The filter function is
synchronous and must return the manipulated object. Example usage:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">apm.addMetadataFilter(function dropArgv(metadata) {
  if (metadata.process &amp;&amp; metadata.process.argv) {
    delete metadata.process.argv
  }
  return metadata
})</pre>
</div>
<p>Warning: It is the responsibility of the author to ensure the returned object
conforms to the
<a href="/guide/en/apm/guide/8.15/api-metadata.html#api-metadata-schema" class="ulink" target="_top">metadata schema</a>
otherwise all APM data injest will fail. A metadata filter that breaks the
metadata will result in error logging from the agent, something like:</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">ERROR (elastic-apm-node): APM Server transport error (400): Unexpected APM Server response
APM Server accepted 0 events in the last request
Error: validation error: 'metadata' required
  Document: {"metadata":null}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-set-user-context"></a><code class="literal">apm.setUserContext(context)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v0.1.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p><code class="literal">context</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="ulink" target="_top">&lt;Object&gt;</a></code> Accepts the following optional properties:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">id</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> | <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="ulink" target="_top">&lt;number&gt;</a></code> The user&#8217;s ID.
</li>
<li class="listitem">
<code class="literal">username</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> The user&#8217;s username.
</li>
<li class="listitem">
<code class="literal">email</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> The user&#8217;s e-mail.
</li>
</ul>
</div>
</li>
</ul>
</div>
<p>Call this to enrich collected performance data and errors with information about the user/client.
This function can be called at any point during the request/response life cycle (i.e. while a transaction is active).</p>
<p>The given <code class="literal">context</code> will be added to the active transaction.
If no active transaction can be found,
<code class="literal">false</code> is returned.
Otherwise <code class="literal">true</code>.</p>
<p>It&#8217;s possible to call this function multiple times within the scope of the same active transaction.
For each call, the properties of the <code class="literal">context</code> argument are shallow merged with the context previously given.</p>
<p>If an error is captured,
the context from the active transaction is used as context for the captured error,
and any custom context given as the 2nd argument to <a class="xref" href="agent-api.html#apm-capture-error" title="apm.captureError(error[, options][, callback])"><code class="literal">apm.captureError</code></a> takes precedence and is shallow merged on top.</p>
<p>The provided user context is stored under <code class="literal">context.user</code> in Elasticsearch on both errors and transactions.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-set-custom-context"></a><code class="literal">apm.setCustomContext(context)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v0.1.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">context</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="ulink" target="_top">&lt;Object&gt;</a></code> Can contain any property that can be JSON encoded.
</li>
</ul>
</div>
<p>Call this to enrich collected errors and transactions with any information that you think will help you debug performance issues or errors.
This function can be called at any point while a transaction is active (e.g. during the request/response life cycle of an incoming HTTP request).</p>
<p>The provided custom context is stored under <code class="literal">context.custom</code> in APM Server pre-7.0,
or <code class="literal">transaction.custom</code> and <code class="literal">error.custom</code> in APM Server 7.0+.</p>
<p>The given <code class="literal">context</code> will be added to the active transaction.
If no active transaction can be found,
<code class="literal">false</code> is returned.
Otherwise <code class="literal">true</code>.</p>
<p>It&#8217;s possible to call this function multiple times within the scope of the same active transaction.
For each call, the properties of the <code class="literal">context</code> argument are shallow merged with the context previously given.</p>
<p>If an error is captured,
the context from the active transaction is used as context for the captured error,
and any custom context given as the 2nd argument to <a class="xref" href="agent-api.html#apm-capture-error" title="apm.captureError(error[, options][, callback])"><code class="literal">apm.captureError</code></a> takes precedence and is shallow merged on top.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Before using custom context, ensure you understand the different types of
<a href="/guide/en/apm/guide/8.15/data-model-metadata.html" class="ulink" target="_top">metadata</a> that are available.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-set-label"></a><code class="literal">apm.setLabel(name, value[, stringify = true])</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v0.1.0</span><br>
<span class="small">Renamed from <code class="literal">apm.setTag()</code> to <code class="literal">apm.setLabel()</code>: v2.10.0</span><br>
<span class="small">Added <code class="literal">stringify</code> argument in: v3.11.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code>
Any periods (<code class="literal">.</code>), asterisks (<code class="literal">*</code>), or double quotation marks (<code class="literal">"</code>) will be replaced by underscores (<code class="literal">_</code>),
as those characters have special meaning in Elasticsearch
</li>
<li class="listitem">
<code class="literal">value</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> | <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="ulink" target="_top">&lt;number&gt;</a></code> | <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="ulink" target="_top">&lt;boolean&gt;</a></code>
</li>
<li class="listitem">
<code class="literal">stringify</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="ulink" target="_top">&lt;boolean&gt;</a></code>
Defaults to <code class="literal">true</code>. When true, if a non-string <code class="literal">value</code> is given, it is
converted to a string before being sent to the APM Server.
</li>
</ul>
</div>
<p>Set a label on the current transaction.
You can set multiple labels on the same transaction.
If an error happens during the current transaction,
it will also get tagged with the same label.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Labels are key/value pairs that are indexed by Elasticsearch and therefore searchable
(as opposed to data set via <a class="xref" href="agent-api.html#apm-set-custom-context" title="apm.setCustomContext(context)"><code class="literal">apm.setCustomContext()</code></a>).
Before using custom labels, ensure you understand the different types of
<a href="/guide/en/apm/guide/8.15/data-model-metadata.html" class="ulink" target="_top">metadata</a> that are available.</p>
</div>
</div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Avoid defining too many user-specified labels.
Defining too many unique fields in an index is a condition that can lead to a
<a href="/guide/en/elasticsearch/reference/8.15/mapping.html#mapping-limit-settings" class="ulink" target="_top">mapping explosion</a>.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-add-labels"></a><code class="literal">apm.addLabels({ [name]: value }[, stringify = true])</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v1.5.0</span><br>
<span class="small">Renamed from <code class="literal">apm.addTags()</code> to <code class="literal">apm.addLabels()</code>: v2.10.0</span><br>
<span class="small">Added <code class="literal">stringify</code> argument in: v3.11.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p><code class="literal">labels</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="ulink" target="_top">&lt;Object&gt;</a></code> Contains key/value pairs:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code>
Any periods (<code class="literal">.</code>), asterisks (<code class="literal">*</code>), or double quotation marks (<code class="literal">"</code>) will be replaced by underscores (<code class="literal">_</code>),
as those characters have special meaning in Elasticsearch
</li>
<li class="listitem">
<code class="literal">value</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> | <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="ulink" target="_top">&lt;number&gt;</a></code> | <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="ulink" target="_top">&lt;boolean&gt;</a></code>
</li>
</ul>
</div>
</li>
<li class="listitem">
<code class="literal">stringify</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="ulink" target="_top">&lt;boolean&gt;</a></code>
Defaults to <code class="literal">true</code>. When true, if a non-string <code class="literal">value</code> is given, it is
converted to a string before being sent to the APM Server.
</li>
</ul>
</div>
<p>Add several labels on the current transaction.
You can add labels multiple times.
If an error happens during the current transaction,
it will also get tagged with the same labels.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Labels are key/value pairs that are indexed by Elasticsearch and therefore searchable
(as opposed to data set via <a class="xref" href="agent-api.html#apm-set-custom-context" title="apm.setCustomContext(context)"><code class="literal">apm.setCustomContext()</code></a>).
Before using custom labels, ensure you understand the different types of
<a href="/guide/en/apm/guide/8.15/data-model-metadata.html" class="ulink" target="_top">metadata</a> that are available.</p>
</div>
</div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Avoid defining too many user-specified labels.
Defining too many unique fields in an index is a condition that can lead to a
<a href="/guide/en/elasticsearch/reference/8.15/mapping.html#mapping-limit-settings" class="ulink" target="_top">mapping explosion</a>.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-set-global-label"></a><code class="literal">apm.setGlobalLabel(name, value)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v3.47.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code>
</li>
<li class="listitem">
<code class="literal">value</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> | <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="ulink" target="_top">&lt;number&gt;</a></code> | <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="ulink" target="_top">&lt;boolean&gt;</a></code>
</li>
</ul>
</div>
<p>Extends the <a class="xref" href="configuration.html#global-labels" title="globalLabels"><code class="literal">globalLabels</code></a> configuration. It allows setting labels that are applied to all transactions. A potential use case is to specify a label with the state of your application: <code class="literal">'initializing' | 'available' | 'unhealthy'</code>.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Labels are key/value pairs that are indexed by Elasticsearch and therefore searchable
(as opposed to data set via <a class="xref" href="agent-api.html#apm-set-custom-context" title="apm.setCustomContext(context)"><code class="literal">apm.setCustomContext()</code></a>).
Before using custom labels, ensure you understand the different types of
<a href="/guide/en/apm/guide/8.15/data-model-metadata.html" class="ulink" target="_top">metadata</a> that are available.</p>
</div>
</div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Avoid defining too many user-specified labels.
Defining too many unique fields in an index is a condition that can lead to a
<a href="/guide/en/elasticsearch/reference/8.15/mapping.html#mapping-limit-settings" class="ulink" target="_top">mapping explosion</a>.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-capture-error"></a><code class="literal">apm.captureError(error[, options][, callback])</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v0.1.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">error</code> - Can be either an <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error" class="ulink" target="_top">&lt;Error&gt;</a></code> object,
a <a class="xref" href="agent-api.html#message-strings" title="Message strings">message string</a>,
or a <a class="xref" href="agent-api.html#parameterized-message-object" title="Parameterized message object">special parameterized message object</a>
</li>
<li class="listitem">
<p><code class="literal">options</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="ulink" target="_top">&lt;Object&gt;</a></code> The following options are supported:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">timestamp</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="ulink" target="_top">&lt;number&gt;</a></code> The time when the error happened.
Must be a Unix Time Stamp representing the number of milliseconds since January 1, 1970, 00:00:00 UTC.
Sub-millisecond precision can be achieved using decimals.
If not provided,
the current time will be used
</li>
<li class="listitem">
<code class="literal">message</code> - If the <code class="literal">error</code> argument is an <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error" class="ulink" target="_top">&lt;Error&gt;</a></code> object,
it&#8217;s possible to use this option to supply an additional message string that will be stored along with the error message under <code class="literal">log.message</code>
</li>
<li class="listitem">
<code class="literal">user</code> - See <a class="xref" href="agent-api.html#metadata" title="Metadata">metadata section</a> for details about this option
</li>
<li class="listitem">
<code class="literal">custom</code> - See <a class="xref" href="agent-api.html#metadata" title="Metadata">metadata section</a> for details about this option
</li>
<li class="listitem">
<code class="literal">request</code> <code class="literal"><a href="https://nodejs.org/api/http.html#http_class_http_incomingmessage" class="ulink" target="_top">&lt;http.IncomingMessage&gt;</a></code> You can associate an error with information about the incoming request to gain additional context such as the request url, headers, and cookies.
However, in most cases, the agent will detect if an error was in response to an http request and automatically add the request details for you.
See <a class="xref" href="agent-api.html#http-requests" title="HTTP requests">http requests section</a> for more details.
</li>
<li class="listitem">
<code class="literal">response</code> <code class="literal"><a href="https://nodejs.org/api/http.html#http_class_http_serverresponse" class="ulink" target="_top">&lt;http.ServerResponse&gt;</a></code> You can associate an error with information about the http response to get additional details such as status code and headers.
However, in most cases, the agent will detect if an error occured during an http request and automatically add response details for you.
See <a class="xref" href="agent-api.html#http-responses" title="HTTP responses">http responses section</a> for more details.
</li>
<li class="listitem">
<code class="literal">handled</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="ulink" target="_top">&lt;boolean&gt;</a></code> Adds additional context to the exception to show
whether the error is handled or uncaught. Unhandled errors are immediately
flushed to APM server, in case the application is about the crash.
<span class="strong strong"><strong>Default:</strong></span> <code class="literal">true</code>.
</li>
<li class="listitem">
<code class="literal">labels</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="ulink" target="_top">&lt;Object&gt;</a></code> Add additional context with labels, these labels will be added to the error along with the labels from the current transaction.
See the <a class="xref" href="agent-api.html#apm-add-labels" title="apm.addLabels({ [name]: value }[, stringify = true])"><code class="literal">apm.addLabels()</code></a> method for details about the format.
</li>
<li class="listitem">
<code class="literal">captureAttributes</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="ulink" target="_top">&lt;boolean&gt;</a></code> Whether to include properties on the given <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error" class="ulink" target="_top">&lt;Error&gt;</a></code> object in the data sent to the APM Server (as <code class="literal">error.exception.attributes</code>). <span class="strong strong"><strong>Default:</strong></span> <code class="literal">true</code>.
</li>
<li class="listitem">
<code class="literal">skipOutcome</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="ulink" target="_top">&lt;boolean&gt;</a></code> Whether to skip setting the outcome value for the current span to <code class="literal">failure</code>.  See <a class="xref" href="span-api.html#span-outcome" title="span.outcome">Span outcome</a> for more information. <span class="strong strong"><strong>Default:</strong></span> <code class="literal">false</code>.
</li>
<li class="listitem">
<code class="literal">parent</code> <a class="xref" href="transaction-api.html" title="Transaction API">Transaction</a> | <a class="xref" href="span-api.html" title="Span API">Span</a> | <code class="literal">null</code> - A Transaction or Span instance to make the parent of this error. If not given (or <code class="literal">undefined</code>), then the current span or transaction will be used. If <code class="literal">null</code> is given, then no span or transaction will be used. <span class="small">(Added in v3.33.0.)</span>
</li>
</ul>
</div>
</li>
<li class="listitem">
<code class="literal">callback</code> - Will be called after the error has been sent to the APM Server.
It will receive an <code class="literal">Error</code> instance if the agent failed to send the error,
and the id of the captured error.
</li>
</ul>
</div>
<p>Send an error to the APM Server:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">apm.captureError(new Error('boom!'))</pre>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="message-strings"></a>Message strings<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h4>
</div></div></div>
<p>Instead of an <code class="literal">Error</code> object,
you can log a plain text message:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">apm.captureError('Something happened!')</pre>
</div>
<p>This will also be sent as an error to the APM Server,
but will not be associated with an exception.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="parameterized-message-object"></a>Parameterized message object<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h4>
</div></div></div>
<p>Instead of an <code class="literal">Error</code> object or a string,
you can supply a special parameterized message object:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">apm.captureError({
  message: 'Could not find user %s with id %d in the database',
  params: ['Peter', 42]
})</pre>
</div>
<p>This makes it possible to better group error messages that contain variable data like ID&#8217;s or names.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="metadata"></a>Metadata<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h4>
</div></div></div>
<p>To ease debugging it&#8217;s possible to send some extra data with each error you send to the APM Server.
The APM Server intake API supports a lot of different metadata fields,
most of which are automatically managed by the Elastic APM Node.js Agent.
But if you wish you can supply some extra details using <code class="literal">user</code> or <code class="literal">custom</code>.
For more details on the properties accepted by the events intake API see the <a href="/guide/en/apm/guide/8.15/api-events.html" class="ulink" target="_top">events intake API docs</a>.</p>
<p>To supply any of these extra fields,
use the optional options argument when calling <code class="literal">apm.captureError()</code>.</p>
<p>Here are some examples:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">// Sending some extra details about the user
apm.captureError(error, {
  user: {
    id: 'unique_id',
    username: 'foo',
    email: 'foo@example.com'
  }
})

// Sending some arbitrary details using the `custom` field
apm.captureError(error, {
  custom: {
    some_important_metric: 'foobar'
  }
})</pre>
</div>
<p>To supply per-request metadata to all errors captured in one central location,
use <a class="xref" href="agent-api.html#apm-set-user-context" title="apm.setUserContext(context)"><code class="literal">apm.setUserContext()</code></a> and <a class="xref" href="agent-api.html#apm-set-custom-context" title="apm.setCustomContext(context)"><code class="literal">apm.setCustomContext()</code></a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="http-requests"></a>HTTP requests<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h4>
</div></div></div>
<p>Besides the options described in the <a class="xref" href="agent-api.html#metadata" title="Metadata">metadata section</a>,
you can use the <code class="literal">options</code> argument to associate the error with an HTTP request:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">apm.captureError(err, {
  request: req // an instance of http.IncomingMessage
})</pre>
</div>
<p>This will log the URL that was requested,
the HTTP headers,
cookies and other useful details to help you debug the error.</p>
<p>In most cases, this isn&#8217;t needed,
as the agent is pretty smart at figuring out if your Node.js app is an HTTP server and if an error occurred during an incoming request.
In which case it will automate this processes for you.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="http-responses"></a>HTTP responses<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h4>
</div></div></div>
<p>Besides the options described in the <a class="xref" href="agent-api.html#metadata" title="Metadata">metadata section</a>,
you can use the <code class="literal">options</code> argument to associate the error with an HTTP response:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">apm.captureError(err, {
  response: res // an instance of http.ServerResponse
})</pre>
</div>
<p>This will log the response status code,
headers and other useful details to help you debug the error.</p>
<p>In most cases, this isn&#8217;t needed,
as the agent is pretty smart at figuring out if your Node.js app is an HTTP server and if an error occurred during an incoming request.
In which case it will automate this processes for you.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-middleware-connect"></a><code class="literal">apm.middleware.connect()</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v0.1.0</span></p>
<p>Returns a middleware function used to collect and send errors to the APM Server.</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">const apm = require('elastic-apm-node').start()
const connect = require('connect')

const app = connect()

// your regular middleware:
app.use(...)
app.use(...)

// your main HTTP router
app.use(function (req, res, next) {
  throw new Error('Broke!')
})

// add Elastic APM in the bottom of the middleware stack
app.use(apm.middleware.connect())

app.listen(3000)</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p><code class="literal">apm.middleware.connect</code> <em>must</em> be added to the middleware stack <em>before</em> any other error handling middleware functions or there&#8217;s a chance that the error will never get to the agent.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-start-transaction"></a><code class="literal">apm.startTransaction([name][, type][, subtype][, action][, options])</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v0.1.0</span><br>
<span class="small">Transaction <code class="literal">subtype</code> and <code class="literal">action</code> deprecated in: v3.25.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> The name of the transaction.
You can always set this later via <a class="xref" href="transaction-api.html#transaction-name" title="transaction.name"><code class="literal">transaction.name</code></a> or <a class="xref" href="agent-api.html#apm-set-transaction-name" title="apm.setTransactionName(name)"><code class="literal">apm.setTransactionName()</code></a>.
<span class="strong strong"><strong>Default:</strong></span> <code class="literal">unnamed</code>
</li>
<li class="listitem">
<code class="literal">type</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> The type of the transaction.
You can always set this later via <a class="xref" href="transaction-api.html#transaction-type" title="transaction.type"><code class="literal">transaction.type</code></a>.
</li>
<li class="listitem">
<code class="literal">subtype</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> The subtype of the transaction.
You can alternatively set this via <a class="xref" href="transaction-api.html#transaction-subtype" title="transaction.subtype"><code class="literal">transaction.subtype</code></a>.
The transaction <code class="literal">subtype</code> field is deprecated: it is not used and will be
removed in the next major version.
</li>
<li class="listitem">
<code class="literal">action</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> The action of the transaction.
You can alternatively set this via <a class="xref" href="transaction-api.html#transaction-action" title="transaction.action"><code class="literal">transaction.action</code></a>.
The transaction <code class="literal">action</code> field is deprecated: it is not used and will be removed
in the next major version.
</li>
<li class="listitem">
<p><code class="literal">options</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="ulink" target="_top">&lt;Object&gt;</a></code> The following options are supported:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">startTime</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="ulink" target="_top">&lt;number&gt;</a></code> The time when the transaction started.
Must be a Unix Time Stamp representing the number of milliseconds since January 1, 1970, 00:00:00 UTC.
Sub-millisecond precision can be achieved using decimals.
If not provided,
the current time will be used
</li>
<li class="listitem">
<code class="literal">childOf</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> A W3C trace-context "traceparent" string, typically received from a remote service call.
</li>
<li class="listitem">
<code class="literal">tracestate</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> A W3C trace-context "tracestate" string.
</li>
<li class="listitem">
<code class="literal">links</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" class="ulink" target="_top">&lt;Array&gt;</a></code> Span links.
A transaction can refer to zero or more other transactions or spans (separate
from its parent). Span links will be shown in the Kibana APM app trace view.
The <code class="literal">links</code> argument is an array of objects with a single "context" field
that is a <code class="literal">Transaction</code>, <code class="literal">Span</code>, or W3C trace-context <em>traceparent</em> string.
For example: <code class="literal">apm.startTransaction('aName', { links: [{ context: anotherSpan }] })</code>.
</li>
</ul>
</div>
</li>
</ul>
</div>
<p>Start a new transaction.</p>
<p>Use this function to create a custom transaction.
Note that the agent will do this for you automatically whenever your application receives an incoming HTTP request.
You only need to use this function to create custom transactions.</p>
<p>There&#8217;s a special <code class="literal">type</code> called <code class="literal">request</code> which is used by the agent for the transactions automatically created when an incoming HTTP request is detected.</p>
<p>See the <a class="xref" href="transaction-api.html" title="Transaction API">Transaction API</a> docs for details on how to use custom transactions.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-end-transaction"></a><code class="literal">apm.endTransaction([result][, endTime])</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v0.1.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">result</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> Describes the result of the transaction.
This is typically the HTTP status code,
or e.g. "success" or "failure" for a background task
</li>
<li class="listitem">
<code class="literal">endTime</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="ulink" target="_top">&lt;number&gt;</a></code> The time when the transaction ended.
Must be a Unix Time Stamp representing the number of milliseconds since January 1, 1970, 00:00:00 UTC.
Sub-millisecond precision can be achieved using decimals.
If not provided,
the current time will be used
</li>
</ul>
</div>
<p>Ends the active transaction.
If no transaction is currently active,
nothing happens.</p>
<p>Note that the agent will do this for you automatically for all regular HTTP transactions.
You only need to use this function to end custom transactions created by <a class="xref" href="agent-api.html#apm-start-transaction" title="apm.startTransaction([name][, type][, subtype][, action][, options])"><code class="literal">apm.startTransaction()</code></a> or if you wish the end a regular transaction prematurely.</p>
<p>Alternatively you can call <a class="xref" href="transaction-api.html#transaction-end" title="transaction.end([result][, endTime])"><code class="literal">end()</code></a> directly on an active transaction object.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-current-transaction"></a><code class="literal">apm.currentTransaction</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v1.9.0</span></p>
<p>Get the currently active transaction,
if used within the context of a transaction.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If there&#8217;s no active transaction available,
<code class="literal">null</code> will be returned.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-current-span"></a><code class="literal">apm.currentSpan</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v2.0.0</span></p>
<p>Get the currently active span,
if used within the context of a span.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If there&#8217;s no active span available,
<code class="literal">null</code> will be returned.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-current-traceparent"></a><code class="literal">apm.currentTraceparent</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v2.9.0</span></p>
<p>Get the serialized traceparent string of the current transaction or span.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If there&#8217;s no active transaction or span available,
<code class="literal">null</code> will be returned.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-set-transaction-name"></a><code class="literal">apm.setTransactionName(name)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v0.1.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> Set or overwrite the name of the current transaction.
</li>
</ul>
</div>
<p>If you use a supported router/framework the agent will automatically set the transaction name for you.</p>
<p>If you do not use Express, hapi, koa-router, Restify, or Fastify or if the agent for some reason cannot detect the name of the HTTP route,
the transaction name will default to <code class="literal">METHOD unknown route</code> (e.g. <code class="literal">POST unknown route</code>).</p>
<p>Read more about naming routes manually in the <a class="xref" href="custom-stack.html#custom-stack-route-naming" title="Route naming">Get started with a custom Node.js stack</a> article.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-start-span"></a><code class="literal">apm.startSpan([name][, type][, subtype][, action][, options])</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v1.1.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> The name of the span.
You can alternatively set this via <a class="xref" href="span-api.html#span-name" title="span.name"><code class="literal">span.name</code></a>.
<span class="strong strong"><strong>Default:</strong></span> <code class="literal">unnamed</code>
</li>
<li class="listitem">
<code class="literal">type</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> The type of the span.
You can alternatively set this via <a class="xref" href="span-api.html#span-type" title="span.type"><code class="literal">span.type</code></a>.
</li>
<li class="listitem">
<code class="literal">subtype</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> The subtype of the span.
You can alternatively set this via <a class="xref" href="span-api.html#span-subtype" title="span.subtype"><code class="literal">span.subtype</code></a>.
</li>
<li class="listitem">
<code class="literal">action</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> The action of the span.
You can alternatively set this via <a class="xref" href="span-api.html#span-action" title="span.action"><code class="literal">span.action</code></a>.
</li>
<li class="listitem">
<p><code class="literal">options</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="ulink" target="_top">&lt;Object&gt;</a></code> The following options are supported:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">startTime</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="ulink" target="_top">&lt;number&gt;</a></code> The time when the span started.
Must be a Unix Time Stamp representing the number of milliseconds since January 1, 1970, 00:00:00 UTC.
Sub-millisecond precision can be achieved using decimals.
If not provided,
the current time will be used
</li>
<li class="listitem">
<code class="literal">exitSpan</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="ulink" target="_top">&lt;boolean&gt;</a></code> Make an "exit span".
Exit spans represent outgoing communication. They are used to create a node
in the <a href="/guide/en/kibana/8.15/service-maps.html" class="ulink" target="_top">Service Map</a> and a downstream service
in the <a href="/guide/en/kibana/8.15/dependencies.html" class="ulink" target="_top">Dependencies Table</a>. The provided subtype
will be used as the downstream service name.
</li>
<li class="listitem">
<code class="literal">links</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" class="ulink" target="_top">&lt;Array&gt;</a></code> Span links.
A span can refer to zero or more other transactions or spans (separate from
its parent). Span links will be shown in the Kibana APM app trace view. The
<code class="literal">links</code> argument is an array of objects with a single "context" field that is a
<code class="literal">Transaction</code>, <code class="literal">Span</code>, or W3C trace-context <em>traceparent</em> string.  For example:
<code class="literal">apm.startSpan('aName', { links: [{ context: anotherSpan }] })</code>.
</li>
</ul>
</div>
</li>
</ul>
</div>
<p>Start and return a new custom span associated with the current active transaction.
This is the same as getting the current transaction with <code class="literal">apm.currentTransaction</code> and,
if a transaction was found,
calling <code class="literal">transaction.startSpan(name, type, options)</code> on it.</p>
<p>When a span is started it will measure the time until <a class="xref" href="span-api.html#span-end" title="span.end([endTime])"><code class="literal">span.end()</code></a> is called.</p>
<p>See <a class="xref" href="span-api.html" title="Span API">Span API</a> docs for details on how to use custom spans.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If there&#8217;s no active transaction available,
<code class="literal">null</code> will be returned.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-handle-uncaught-exceptions"></a><code class="literal">apm.handleUncaughtExceptions([callback])</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v0.1.0</span></p>
<p>By default, the agent will terminate the Node.js process when an uncaught exception is detected.
Use this function if you need to run any custom code before the process is terminated.</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">apm.handleUncaughtExceptions(function (err) {
  // Do your own stuff... and then exit:
  process.exit(1)
})</pre>
</div>
<p>The callback is called <span class="strong strong"><strong>after</strong></span> the event has been sent to the APM Server with the following arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">err</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error" class="ulink" target="_top">&lt;Error&gt;</a></code> the captured exception
</li>
</ul>
</div>
<p>This function will also enable the uncaught exception handler if it was disabled using the <a class="xref" href="configuration.html#capture-exceptions" title="captureExceptions"><code class="literal">captureExceptions</code></a> configuration option.</p>
<p>If you don&#8217;t specify a callback,
the node process is terminated automatically when an uncaught exception has been captured and sent to the APM Server.</p>
<p><a href="https://nodejs.org/api/process.html#process_event_uncaughtexception" class="ulink" target="_top">It is recommended</a> that you don&#8217;t leave the process running after receiving an uncaught exception,
so if you are using the optional callback,
remember to terminate the node process.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-flush"></a><code class="literal">apm.flush([callback])</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v0.12.0</span></p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">// with node-style callback
apm.flush(function (err) {
  // Flush complete
})

// with promises
apm.flush().then(function () {
  // Flush complete
}).catch(function (err) {
  // Flush returned an error
})

// inside of an async function
try {
  await apm.flush()
  // Flush complete
} catch (err) {
  // Flush returned an error
}</pre>
</div>
<p>Manually end the active outgoing HTTP request to the APM Server.
The HTTP request is otherwise ended automatically at regular intervals,
controlled by the <a class="xref" href="configuration.html#api-request-time" title="apiRequestTime"><code class="literal">apiRequestTime</code></a> and <a class="xref" href="configuration.html#api-request-size" title="apiRequestSize"><code class="literal">apiRequestSize</code></a> config options.</p>
<p>If an optional <code class="literal">callback</code> is provided as the first argument to this method, it will call <code class="literal">callback(flushErr)</code> when complete.
If no <code class="literal">callback</code> is provided, then a <code class="literal">Promise</code> will be returned, which will either resolve with <code class="literal">void</code> or reject with <code class="literal">flushErr</code>.</p>
<p>The callback is called (or the <code class="literal">Promise</code> resolves if no <code class="literal">callback</code> argument is provided) <span class="strong strong"><strong>after</strong></span> the active HTTP request has ended.
The callback is called even if no HTTP request is currently active.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-lambda"></a><code class="literal">apm.lambda([type, ]handler)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v1.4.0</span></p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">exports.hello = apm.lambda(function (event, context, callback) {
  callback(null, `Hello, ${payload.name}!`)
})</pre>
</div>
<p>Manually instrument an AWS Lambda function to form a transaction around each execution.
Optionally, a type may also be provided to group lambdas together. By default,
"lambda" will be used as the type name.</p>
<p>Read more lambda support in the <a class="xref" href="lambda.html" title="Monitoring AWS Lambda Node.js Functions">Lambda</a> article.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-add-patch"></a><code class="literal">apm.addPatch(modules, handler)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v2.7.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">modules</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> | <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string[]&gt;</a></code>
Name of module(s) to apply the patch to, when required.
</li>
<li class="listitem">
<p><code class="literal">handler</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" class="ulink" target="_top">&lt;Function&gt;</a></code> | <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code>
Must be a patch function or a path to a module exporting a patch function</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">exports</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="ulink" target="_top">&lt;Object&gt;</a></code> The original export object of the module
</li>
<li class="listitem">
<code class="literal">agent</code> - The agent instance to use in the patch function
</li>
<li class="listitem">
<p><code class="literal">options</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="ulink" target="_top">&lt;Object&gt;</a></code> The following options are supported:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">version</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code> | <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Glossary/Undefined" class="ulink" target="_top">&lt;undefined&gt;</a></code> The module version, if applicable.
</li>
<li class="listitem">
<code class="literal">enabled</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="ulink" target="_top">&lt;boolean&gt;</a></code> A flag indicating if the instrumentation is enabled.
Any module patch can be disabled, by module name, with <a class="xref" href="configuration.html#disable-instrumentations" title="disableInstrumentations"><code class="literal">disableInstrumentations</code></a>.
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<p>Register a module patch to apply on intercepted <code class="literal">require</code> calls.</p>
<p>A module can have any number of patches and will be applied in the order they are added.</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">apm.addPatch('timers', (exports, agent, { version, enabled }) =&gt; {
  const setTimeout = exports.setTimeout
  exports.setTimeout = (fn, ms) =&gt; {
    const span = agent.startSpan('set-timeout')
    return setTimeout(() =&gt; {
      span.end()
      fn()
    }, ms)
  }

  return exports
})

// or ...

apm.addPatch(['hapi', '@hapi/hapi'], (exports, agent, { version, enabled }) =&gt; {
  const setTimeout = exports.setTimeout
  exports.setTimeout = (fn, ms) =&gt; {
    const span = agent.startSpan('set-timeout')
    return setTimeout(() =&gt; {
      span.end()
      fn()
    }, ms)
  }

  return exports
})

// or ...

apm.addPatch('timers', './timer-patch')</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-remove-patch"></a><code class="literal">apm.removePatch(modules, handler)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v2.7.0</span></p>
<p>Removes a module patch.
This will generally only be needed when replacing an existing patch.
To <em>disable</em> instrumentation while keeping context propagation support, see <a class="xref" href="configuration.html#disable-instrumentations" title="disableInstrumentations"><code class="literal">disableInstrumentations</code></a>.</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">apm.removePatch('timers', './timers-patch')

// or ...

apm.removePatch(['timers'], './timers-patch')

// or ...

apm.removePatch('timers', timerPatchFunction)</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-clear-patches"></a><code class="literal">apm.clearPatches(modules)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v2.7.0</span></p>
<p>Clear all patches for the given module.
This will generally only be needed when replacing an existing patch.
To <em>disable</em> instrumentation while keeping context propagation support, see <a class="xref" href="configuration.html#disable-instrumentations" title="disableInstrumentations"><code class="literal">disableInstrumentations</code></a>.</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">apm.clearPatches('timers')

// or ...

apm.clearPatches(['timers'])</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-current-trace-ids"></a><code class="literal">apm.currentTraceIds</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v2.17.0</span></p>
<p><code class="literal">apm.currentTraceIds</code> produces an object containing <code class="literal">trace.id</code> and either <code class="literal">transaction.id</code> or <code class="literal">span.id</code> when a current transaction or span is available.
When no transaction or span is available it will return an empty object.
This enables <a class="xref" href="logs.html#log-correlation-ids" title="Log correlation">log correlation</a> to APM traces with structured loggers.</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">{
  "trace.id": "abc123",
  "transaction.id": "abc123"
}
// or ...
{
  "trace.id": "abc123",
  "span.id": "abc123"
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-register-custom-metrics"></a><code class="literal">apm.registerMetric(name[, labels], callback)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.</p>
</div>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code>
Name of the metrics.
</li>
<li class="listitem">
<code class="literal">labels</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="ulink" target="_top">&lt;Object&gt;</a></code> Contains key/value pairs.
Optional labels. Omittable.
</li>
<li class="listitem">
<code class="literal">callback</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" class="ulink" target="_top">&lt;Function&gt;</a></code>
Must be a function that returns the current metric value.
</li>
</ul>
</div>
<p>Register a metric callback.</p>
<p>Take care not to use the names of <a class="xref" href="metrics.html" title="Metrics">built-in metrics</a>.</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">apm.registerMetric( 'ws.connections' , () =&gt; {
  return wss.clients.size;
})

// or, to additionally label the metric with "module: 'ws'":

apm.registerMetric( 'ws.connections' , {module : 'ws'}, () =&gt; {
  return wss.clients.size;
})</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-transaction-outcome"></a><code class="literal">apm.setTransactionOutcome(outcome)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v3.12.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">outcome</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code>
</li>
</ul>
</div>
<p>Will set the outcome property on the <em>current</em> transaction.</p>
<p>See the <a class="xref" href="transaction-api.html#transaction-outcome" title="transaction.outcome">Transaction Outcome docs</a> for more information.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="apm-span-outcome"></a><code class="literal">apm.setSpanOutcome(outcome)</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/agent-api.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="small">Added in: v3.12.0</span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">outcome</code> <code class="literal"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="ulink" target="_top">&lt;string&gt;</a></code>
</li>
</ul>
</div>
<p>Will set the outcome property on the <em>current</em> span.</p>
<p>See the <a class="xref" href="span-api.html#span-outcome" title="span.outcome">Span Outcome docs</a> for more information.</p>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="api.html">« API Reference</a>
</span>
<span class="next">
<a href="transaction-api.html"><code class="literal">Transaction</code> API »</a>
</span>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs-v1.js"></script>
    <script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
