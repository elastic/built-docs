<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Node.js Agent version 4.x | APM Node.js Agent Reference [4.x] | Elastic</title>
<meta class="elastic" name="content" content="Node.js Agent version 4.x | APM Node.js Agent Reference [4.x]">

<link rel="home" href="index.html" title="APM Node.js Agent Reference [4.x]"/>
<link rel="up" href="release-notes.html" title="Release notes"/>
<link rel="prev" href="release-notes.html" title="Release notes"/>
<link rel="next" href="release-notes-3.x.html" title="Node.js Agent version 3.x"/>
<meta class="elastic" name="product_version" content="4.x"/>
<meta class="elastic" name="product_name" content="APM"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/APM Node.js Agent/Reference/4.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="4.x"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link">
  <div id="related-products" class="dropdown">
  <div class="related-products-title">APM:</div>
  <div class="dropdown-anchor" tabindex="0">Node.js Agent Reference<span class="dropdown-icon"></span></div>
  <div class="dropdown-content">
  <ul>
  <li class="dropdown-category">APM</li>
  <ul>
  <li><a href="/guide/en/apm/guide/current/apm-overview.html">User Guide</a></li>
  </ul>
  <li class="dropdown-category">APM agents</li>
  <ul>
  <li><a href="/guide/en/apm/agent/android/current/intro.html">Android Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/go/current/introduction.html">Go Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/swift/current/intro.html">iOS Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/java/current/intro.html">Java Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/dotnet/current/intro.html">.NET Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/nodejs/current/intro.html">Node.js Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/php/current/intro.html">PHP Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/python/current/getting-started.html">Python Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/ruby/current/introduction.html">Ruby Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/rum-js/current/intro.html">Real User Monitoring JavaScript Agent Reference</a></li>
  </ul>
  <li class="dropdown-category">APM extensions</li>
  <ul>
  <li><a href="/guide/en/apm/lambda/current/aws-lambda-arch.html">Monitoring AWS Lambda Functions</a></li>
  <li><a href="/guide/en/apm/attacher/current/apm-attacher.html">Attacher</a></li>
  </ul>
  </ul>
  </div>
  </div>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="release-notes.html">Release notes</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="release-notes.html">« Release notes</a>
</span>
<span class="next">
<a href="release-notes-3.x.html">Node.js Agent version 3.x »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="release-notes-4.x"></a>Node.js Agent version 4.x<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h2>
</div></div></div>
<p>See the <a class="xref" href="upgrade-to-v4.html" title="Upgrade to v4.x">Upgrade to v4.x</a> guide.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.1.0"></a>4.1.0 - 2023/10/09<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Update <a class="xref" href="opentelemetry-bridge.html" title="OpenTelemetry bridge"><em>OpenTelemetry bridge</em></a> support to <code class="literal">@opentelemetry/api</code> version 1.6.0.
<a href="https://github.com/elastic/apm-agent-nodejs/pull/3622" class="ulink" target="_top">#3622</a>
</li>
<li class="listitem">
Add support for <code class="literal">@aws-sdk/client-dynamodb</code>, one of the AWS SDK v3 clients.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2958" class="ulink" target="_top">#2958</a>)
</li>
<li class="listitem">
Add support for <code class="literal">@aws-sdk/client-sns</code>, one of the AWS SDK v3 clients.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2956" class="ulink" target="_top">#2956</a>)
</li>
<li class="listitem">
Add support for <code class="literal">@aws-sdk/client-sqs</code>, one of the AWS SDK v3 clients.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2957" class="ulink" target="_top">#2957</a>)
</li>
<li class="listitem">
Fixes for some values of the <a class="xref" href="configuration.html#disable-instrumentations" title="disableInstrumentations"><code class="literal">disableInstrumentations</code></a> config setting.
"redis" will now properly disable instrumentation for redis@4.
"next" will propertly disable all Next.js instrumentation.
(<a href="https://github.com/elastic/apm-agent-nodejs/pull/3658" class="ulink" target="_top">#3658</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Changes to cloud metadata collection for Google Cloud (GCP). Most notably
the <code class="literal">cloud.project.id</code> field is now the <code class="literal">project-id</code> from
<a href="https://cloud.google.com/compute/docs/metadata/default-metadata-values#project_metadata" class="ulink" target="_top">https://cloud.google.com/compute/docs/metadata/default-metadata-values#project_metadata</a>
rather than the <code class="literal">numeric-project-id</code>. This matches the value produced by
Elastic Beats (like filebeat). <a href="https://github.com/elastic/apm-agent-nodejs/issues/3614" class="ulink" target="_top">#3614</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.0.0"></a>4.0.0 - 2023/09/07<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_breaking_changes"></a>Breaking changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Set the new minimum supported Node.js to version 14.17.0.
Users of earlier Node.js versions can use elastic-apm-node v3.x, which
supports back to Node.js v8.6.
</li>
<li class="listitem">
Ignore a <code class="literal">timer</code> option passed to <code class="literal">startTransaction()</code> and <code class="literal">startSpan()</code> APIs.
This option was never documented. It would be surprising if any user is
impacted by this.
</li>
<li class="listitem">
Remove long deprecated support for the <code class="literal">ELASTIC_APM_</code>-prefixed environment
variables for the <a class="xref" href="configuration.html#kubernetes-node-name" title="kubernetesNodeName">Kubernetes config options</a>. For
example, one must use <code class="literal">KUBERNETES_POD_NAME</code> and not
<code class="literal">ELASTIC_APM_KUBERNETES_POD_NAME</code>. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2661" class="ulink" target="_top">#2661</a>)
</li>
<li class="listitem">
The config option <code class="literal">filterHttpHeaders</code> is now <em>removed</em>. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3539" class="ulink" target="_top">#3539</a>)
</li>
<li class="listitem">
Remove the deprecated <code class="literal">span.toString()</code> and <code class="literal">transaction.toString()</code> APIs.
See <a class="xref" href="upgrade-to-v4.html#v4-api-to-string" title="span.toString(), transaction.toString()">the upgrading doc</a> for details. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2348" class="ulink" target="_top">#2348</a>)
</li>
<li class="listitem">
Remove instrumentation support for the old <em>hapi</em> package&#8201;&#8212;&#8201;the current
<em>@hapi/hapi</em> package is still instrumented. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2691" class="ulink" target="_top">#2691</a>)
</li>
<li class="listitem">
Change <code class="literal">apm.startTransaction()</code> api to return a noop transaction instead of
null, if the agent is not yet started. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2429" class="ulink" target="_top">#2429</a>)
</li>
<li class="listitem">
Drop support for the obsolete "patch" context manager, i.e. the
<code class="literal">contextManager: "patch"</code> config option. This was a limited async context
management that predated the preferred <code class="literal">AsyncLocalStorage</code> core Node.js
mechanism for context tracking. It was deprecated in v3.37.0.  As well, the
related and deprecated <code class="literal">asyncHooks</code> config option has been removed.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/3529" class="ulink" target="_top">#3529</a>)
</li>
<li class="listitem">
Remove the <code class="literal">logUncaughtExceptions</code> config option.
See <a class="xref" href="upgrade-to-v4.html#v4-config-options" title="Config options">Upgrading to v4</a> for details.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2412" class="ulink" target="_top">#2412</a>)
</li>
<li class="listitem">
Remove <code class="literal">transaction.subtype</code> and <code class="literal">transaction.action</code> properties from API.
This also impacts <a class="xref" href="agent-api.html#apm-start-transaction" title="apm.startTransaction([name][, type][, options])"><code class="literal">apm.startTransaction([name][, type][, options])</code></a> and <code class="literal">transaction.setType(...)</code>,
both of which now no longer accept <code class="literal">subtype</code> and <code class="literal">action</code> parameters.
These two properties were deprecated in v3.25.0.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/3557" class="ulink" target="_top">#3557</a>)
</li>
<li class="listitem">
Remove support for the erroneous <code class="literal">ELASTIC_SANITIZE_FIELD_NAMES</code> and
<code class="literal">ELASTIC_IGNORE_MESSAGE_QUEUES</code> config environment variables. The correct env
vars are <code class="literal">ELASTIC_APM_SANITIZE_FIELD_NAMES</code> and
<code class="literal">ELASTIC_APM_IGNORE_MESSAGE_QUEUES</code>, respectively, and were supported starting
in v3.36.0.
</li>
</ul>
</div>
<h5><a id="_features_2"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The <code class="literal">apm.destroy()</code> method is now async. Almost no users should need to use
this method. However, if used, to be sure to wait for APM agent shutdown to
be complete, one can now <code class="literal">await apm.destroy()</code>. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/3222" class="ulink" target="_top">#3222</a>)
</li>
<li class="listitem">
Support instrumenting <code class="literal">mongodb</code> v6. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3596" class="ulink" target="_top">#3596</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_2"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix instrumentation of <code class="literal">mongodb</code> to avoid multiple command handler
registrations when client is created via <code class="literal">MongoClient.connect</code> static
method. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3586" class="ulink" target="_top">#3586</a>)
</li>
</ul>
</div>
<h5><a id="_chores"></a>Chores<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add a warning message when a duration or size config option is provided
without units. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2121" class="ulink" target="_top">#2121</a>)
</li>
<li class="listitem">
Change default value of <code class="literal">useElasticTraceparentHeader</code> config option to <code class="literal">false</code>.
This means that for outgoing HTTP requests, the APM agent will no longer add the
<code class="literal">elastic-apm-traceparent</code> header. This vendor-specific header was used in the past
while the <a href="https://w3c.github.io/trace-context/" class="ulink" target="_top">W3C trace-context</a> spec was still
in development. Now that it is in wide use, the <code class="literal">elastic-apm-traceparent</code> header is
only useful for interaction with very old Elastic APM agents.
</li>
<li class="listitem">
Add default ports into <code class="literal">context.service.target.name</code> for HTTP spans conforming to the
spec update done in <a href="https://github.com/elastic/apm/pull/700" class="ulink" target="_top">https://github.com/elastic/apm/pull/700</a> (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3590" class="ulink" target="_top">#3590</a>)
</li>
</ul>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="release-notes.html">« Release notes</a>
</span>
<span class="next">
<a href="release-notes-3.x.html">Node.js Agent version 3.x »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs.js"></script>
    <script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
