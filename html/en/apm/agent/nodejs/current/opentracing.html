<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>OpenTracing API | APM Node.js Agent Reference [3.x] | Elastic</title>
<link rel="home" href="index.html" title="APM Node.js Agent Reference [3.x]"/>
<link rel="up" href="index.html" title="APM Node.js Agent Reference [3.x]"/>
<link rel="prev" href="metrics.html" title="Metrics"/>
<link rel="next" href="log-correlation.html" title="Log correlation"/>
<meta name="DC.type" content="Learn/Docs/APM Node.js Agent/Reference/3.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="3.x"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">APM Node.js Agent Reference [3.x]</a></span>
»
<span class="breadcrumb-node">OpenTracing API</span>
</div>
<div class="navheader">
<span class="prev">
<a href="metrics.html">« Metrics</a>
</span>
<span class="next">
<a href="log-correlation.html">Log correlation »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="opentracing"></a>OpenTracing API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/opentracing.asciidoc">edit</a></h1>
</div></div></div>
<p>The Elastic APM OpenTracing bridge allows creating Elastic APM transactions and spans,
using the <a href="https://opentracing-javascript.surge.sh/" class="ulink" target="_top">OpenTracing API</a>.
In other words,
it translates the calls to the OpenTracing API to Elastic APM and thus allows for reusing existing instrumentation.</p>
<p>For more information about OpenTracing, see the <a href="https://opentracing.io/" class="ulink" target="_top">OpenTracing website</a>.</p>
<h3><a id="ot-prerequisites"></a>Prerequisites<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/opentracing.asciidoc">edit</a></h3>
<p>OpenTracing support for the Elastic APM Node.js Agent is provided via a separate module called <a href="https://www.npmjs.com/package/elastic-apm-node-opentracing" class="ulink" target="_top"><code class="literal">elastic-apm-node-opentracing</code></a>.</p>
<p>This module requires that the Elastic APM Node.js Agent is installed separately.
To ensure that both dependencies are added to the application,
install them like so:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">npm install elastic-apm-node elastic-apm-node-opentracing --save</pre>
</div>
<h3><a id="ot-terminologies"></a>OpenTracing vs Elastic APM terminologies<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/opentracing.asciidoc">edit</a></h3>
<p>Elastic APM differentiates between <a href="/guide/en/apm/get-started/7.9/transactions.html" class="ulink" target="_top">transactions</a> and <a href="/guide/en/apm/get-started/7.9/transaction-spans.html" class="ulink" target="_top">spans</a>.
In the context of OpenTracing, a transaction can be thought of as a special kind of span.</p>
<p>Because OpenTracing natively only has the concept of spans,
the Elastic APM OpenTracing bridge will automatically create either Elastic transactions or Elastic spans behind the scenes.
There are a set of rules that determine which is created:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
If <code class="literal">agent.currentTransaction</code> is <code class="literal">null</code>,
a new Elastic transaction will be created when calling <code class="literal">tracer.startSpan()</code>.
</li>
<li class="listitem">
If <code class="literal">agent.currentTransaction</code> holds an existing transaction,
but that transaction is ended,
a new Elastic transaction will be created when calling <code class="literal">tracer.startSpan()</code>.
</li>
<li class="listitem">
In all other cases,
a new Elastic span will be created when calling <code class="literal">tracer.startSpan()</code>.
</li>
</ol>
</div>
<h3><a id="ot-initialization"></a>Initialization<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/opentracing.asciidoc">edit</a></h3>
<p>It&#8217;s important that the agent is started before you require <span class="strong strong"><strong>any</strong></span> other modules in your Node.js application - i.e. before <code class="literal">express</code>, <code class="literal">http</code>, etc.</p>
<p>This means that you should probably require and start the agent in your application&#8217;s main file (usually <code class="literal">index.js</code>, <code class="literal">server.js</code> or <code class="literal">app.js</code>).</p>
<p>Here&#8217;s a simple example where we first start the agent and then initialize the OpenTracing bridge:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">// Add this to the VERY top of the first file loaded in your app
const agent = require('elastic-apm-node').start({
  // Override service name from package.json
  // Allowed characters: a-z, A-Z, 0-9, -, _, and space
  serviceName: '',

  // Use if APM Server requires a token
  secretToken: '',

  // Set custom APM Server URL (default: http://localhost:8200)
  serverUrl: '',
})

const Tracer = require('elastic-apm-node-opentracing')

// Pass the Elastic APM agent as an argument to the OpenTracing tracer
const tracer = new Tracer(agent)

const span = tracer.startSpan('my-first-span')
// ... do some work ...
span.finish()</pre>
</div>
<h3><a id="ot-api"></a>API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/opentracing.asciidoc">edit</a></h3>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">tracer = new Tracer(agent)</pre>
</div>
<p>The <code class="literal">elastic-apm-node-opentracing</code> module exposes a Tracer class which is OpenTracing compatible.</p>
<p>When instantiating the Tracer object,
an instance of the Elastic APM Node.js Agent must be provided as its only argument.</p>
<p>For details about the <code class="literal">tracer</code> API,
see the <a href="https://opentracing-javascript.surge.sh/" class="ulink" target="_top"><code class="literal">opentracing-javascript</code> API docs</a>.</p>
<h3><a id="ot-elastic-apm-tags"></a>Elastic APM specific tags<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/opentracing.asciidoc">edit</a></h3>
<p>Elastic APM defines some tags which have special meaning and which will not be stored as regular tags.
Instead, they will be used to set certain metadata on the transaction or span.</p>
<p>The following tags have special meaning for both transactions and spans:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">type</code> - sets the type of the transaction or span,
for example <code class="literal">request</code> for transactions or <code class="literal">db.mysql.query</code> for spans
</li>
</ul>
</div>
<p>The following tags only have special meaning on the span if the underlying Elastic APM object is a transaction:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">result</code> - sets the result of the transaction (defaults to <code class="literal">success</code>)
</li>
<li class="listitem">
<code class="literal">error</code> - sets the result of the transaction to <code class="literal">error</code> if the tag value is <code class="literal">true</code> (defaults to <code class="literal">success</code>)
</li>
<li class="listitem">
<code class="literal">http.status_code</code> - sets the result of the transaction.
E.g. If the tag value is <code class="literal">200</code>,
the transaction result will be set to <code class="literal">HTTP 2xx</code> (defaults to <code class="literal">success</code>)
</li>
<li class="listitem">
<code class="literal">user.id</code> - sets the user id,
appears in the "User" tab in the transaction details in the Elastic APM app
</li>
<li class="listitem">
<code class="literal">user.email</code> - sets the user email,
appears in the "User" tab in the transaction details in the Elastic APM app
</li>
<li class="listitem">
<code class="literal">user.username</code> - sets the user name,
appears in the "User" tab in the transaction details in the Elastic APM app
</li>
</ul>
</div>
<h3><a id="ot-caveats"></a>Caveats<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/opentracing.asciidoc">edit</a></h3>
<p>Not all features of the OpenTracing API are supported.</p>
<h4><a id="ot-propagation"></a>Context propagation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/opentracing.asciidoc">edit</a></h4>
<p>This bridge only supports the formats <code class="literal">opentracing.FORMAT_TEXT_MAP</code> and <code class="literal">opentracing.FORMAT_HTTP_HEADERS</code>.
<code class="literal">opentracing.FORMAT_BINARY</code> is currently not supported.</p>
<h4><a id="ot-references"></a>Span References<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/opentracing.asciidoc">edit</a></h4>
<p>Currently, this bridge only supports <code class="literal">opentracing.REFERENCE_CHILD_OF</code> references.
Other references,
like <code class="literal">opentracing.REFERENCE_FOLLOWS_FROM</code>, are not supported yet.</p>
<h4><a id="ot-baggage"></a>Baggage<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/opentracing.asciidoc">edit</a></h4>
<p>The <code class="literal">span.setBaggageItem()</code> method is not supported.
Baggage items are silently dropped.</p>
<h4><a id="ot-logs"></a>Logs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/opentracing.asciidoc">edit</a></h4>
<p>Only error logging is supported.
Logging an Error object on the OpenTracing span will create an Elastic APM
<a href="/guide/en/apm/get-started/7.9/errors.html" class="ulink" target="_top">error</a>.
Example:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">const err = new Error('boom!')

span.log({
  event: 'error',
  'error.object': err
})</pre>
</div>
<p>Other logs are silently dropped.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="metrics.html">« Metrics</a>
</span>
<span class="next">
<a href="log-correlation.html">Log correlation »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Most Popular</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Get Started with Elasticsearch: Video</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Intro to Kibana: Video</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">ELK for Logs & Metrics: Video</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
