<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Get started with Fastify | APM Node.js Agent Reference [master] | Elastic</title>
<meta class="elastic" name="content" content="Get started with Fastify | APM Node.js Agent Reference [master]">

<link rel="home" href="index.html" title="APM Node.js Agent Reference [master]"/>
<link rel="up" href="set-up.html" title="Set up the Agent"/>
<link rel="prev" href="express.html" title="Get started with Express"/>
<link rel="next" href="hapi.html" title="Get started with hapi"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="APM"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/APM Node.js Agent/Reference/master"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link">
  <div id="related-products" class="dropdown">
  <div class="related-products-title">APM:</div>
  <div class="dropdown-anchor" tabindex="0">Node.js Agent Reference<span class="dropdown-icon"></span></div>
  <div class="dropdown-content">
  <ul>
  <li class="dropdown-category">APM</li>
  <ul>
  <li><a href="/guide/en/observability/current/apm.html">Observability › APM</a></li>
  </ul>
  <li class="dropdown-category">APM agents</li>
  <ul>
  <li><a href="/guide/en/apm/agent/android/current/intro.html">Android Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/go/current/introduction.html">Go Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/swift/current/intro.html">iOS Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/java/current/intro.html">Java Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/dotnet/current/intro.html">.NET Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/nodejs/current/intro.html">Node.js Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/php/current/intro.html">PHP Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/python/current/getting-started.html">Python Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/ruby/current/introduction.html">Ruby Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/rum-js/current/intro.html">Real User Monitoring JavaScript Agent Reference</a></li>
  </ul>
  <li class="dropdown-category">APM extensions</li>
  <ul>
  <li><a href="/guide/en/apm/lambda/current/aws-lambda-arch.html">AWS Lambda extension</a></li>
  <li><a href="/guide/en/apm/attacher/current/apm-attacher.html">Attacher</a></li>
  </ul>
  </ul>
  </div>
  </div>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="set-up.html">Set up the Agent</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="express.html">« Get started with Express</a>
</span>
<span class="next">
<a href="hapi.html">Get started with hapi »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="fastify"></a>Get started with Fastify<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/fastify.asciidoc">edit</a></h2>
</div></div></div>
<p>Getting Elastic APM set up for your Fastify app is easy,
and there are various ways you can tweak it to fit your needs.</p>
<p>Follow the guide below to get started, and for more advanced topics,
check out the <a class="xref" href="api.html" title="API Reference">API Reference</a>.</p>
<h4><a id="fastify-installation"></a>Installation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/fastify.asciidoc">edit</a></h4>
<p>Add the <code class="literal">elastic-apm-node</code> module as a dependency to your application:</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">npm install elastic-apm-node --save</pre>
</div>
<h4><a id="fastify-initialization"></a>Initialization<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/fastify.asciidoc">edit</a></h4>
<p>It&#8217;s important that the agent is started before you require <span class="strong strong"><strong>any</strong></span> other modules in your Node.js application - i.e. before <code class="literal">fastify</code>, <code class="literal">http</code>, etc.</p>
<p>This means that you should probably require and start the agent in your application&#8217;s main file (usually <code class="literal">index.js</code>, <code class="literal">server.js</code> or <code class="literal">app.js</code>).</p>
<p>Here&#8217;s a simple Fastify example with the Elastic APM agent installed:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">// Add this to the VERY top of the first file loaded in your app
var apm = require('elastic-apm-node').start({
  // Override service name from package.json
  // Allowed characters: a-z, A-Z, 0-9, -, _, and space
  serviceName: '',

  // Use if APM Server requires a token
  secretToken: '',

  // Use if APM Server uses API keys for authentication
  apiKey: '',

  // Set custom APM Server URL (default: http://127.0.0.1:8200)
  serverUrl: '',
})

// Require the framework and instantiate it
var fastify = require('fastify')({
  logger: true
})

// Declare a route
fastify.get('/', function (request, reply) {
  reply.send({ hello: 'world' })
})

// Run the server!
fastify.listen(3000, function (err, address) {
  if (err) throw err
  fastify.log.info(`server listening on ${address}`)
})</pre>
</div>
<p>The agent will now monitor the performance of your Fastify application and record any uncaught exceptions.</p>
<h5><a id="fastify-advanced-configuration"></a>Advanced configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/fastify.asciidoc">edit</a></h5>
<p>In the above example we initialize the agent by calling the <a class="xref" href="agent-api.html#apm-start" title="apm.start([options])"><code class="literal">start()</code></a> function.
This function takes an optional options object used to configure the agent.
Any option not supplied via the options object can instead be configured using environment variables.
So if you prefer, you can set the same configuration options using environment variables:</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">ELASTIC_APM_SERVICE_NAME=&lt;service name&gt;
ELASTIC_APM_SECRET_TOKEN=&lt;token&gt;
ELASTIC_APM_SERVER_URL=&lt;server url&gt;</pre>
</div>
<p>And then just start the agent like so:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">// Start the agent before any thing else in your app
var apm = require('elastic-apm-node').start()</pre>
</div>
<p>See all possible ways to configure the agent <a class="xref" href="configuring-the-agent.html" title="Configuring the agent">in the API documentation</a>.</p>
<h5><a id="fastify-full-documentation"></a>Full documentation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/fastify.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="advanced-setup.html" title="Configuration">Setup and Configuration</a>
</li>
<li class="listitem">
<a class="xref" href="api.html" title="API Reference">API Reference</a>
</li>
</ul>
</div>
<h4><a id="fastify-performance-monitoring"></a>Performance monitoring<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/fastify.asciidoc">edit</a></h4>
<p>Elastic APM automatically measures the performance of your Fastify application.
It records spans for database queries,
external HTTP requests,
and other slow operations that happen during requests to your Fastify app.</p>
<p>By default, the agent will instrument <a class="xref" href="supported-technologies.html" title="Supported technologies">the most common modules</a>.
To instrument other events,
you can use custom spans.
For information about custom spans,
see the <a class="xref" href="custom-spans.html" title="Custom spans">Custom Spans section</a>.</p>
<p>Spans are grouped in transactions - by default one for each incoming HTTP request.
But it&#8217;s possible to create custom transactions not associated with an HTTP request.
See the <a class="xref" href="custom-transactions.html" title="Custom transactions">Custom Transactions section</a> for details.</p>
<h5><a id="fastify-unknown-routes"></a>Unknown routes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/fastify.asciidoc">edit</a></h5>
<p>When viewing the performance metrics of your application in Elastic APM,
you might see some transactions named "unknown route".
This indicates that the agent detected an incoming HTTP request to your application,
but didn&#8217;t know which route in your Fastify app the HTTP request matched.</p>
<p>This might simply be 404 requests,
which by definition don&#8217;t match any route,
or it might be a symptom that the agent wasn&#8217;t installed correctly.
If you see this or can&#8217;t get any meaningful metrics to show up,
please follow the <a class="xref" href="troubleshooting.html" title="Troubleshooting">Troubleshooting Guide</a>.</p>
<h4><a id="fastify-error-logging"></a>Error logging<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/fastify.asciidoc">edit</a></h4>
<p>By default, the Node.js agent will watch for uncaught exceptions and send them to Elastic APM automatically.
But in most cases, errors are not thrown but returned via a callback,
caught by a promise,
or simply manually created.
Those errors will not automatically be sent to Elastic APM.
To manually send an error to Elastic APM,
simply call <code class="literal">apm.captureError()</code> with the error:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">var err = new Error('Ups, something broke!')

apm.captureError(err)</pre>
</div>
<p>For advanced logging of errors,
including adding extra metadata to the error,
see <a class="xref" href="agent-api.html#apm-capture-error" title="apm.captureError(error[, options][, callback])">the API documentation</a>.</p>
<h4><a id="fastify-filter-sensitive-information"></a>Filter sensitive information<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/fastify.asciidoc">edit</a></h4>
<p>By default, the Node.js agent will filter common sensitive information before sending errors and metrics to the Elastic APM server.</p>
<p>It&#8217;s possible for you to tweak these defaults or remove any information you don&#8217;t want to send to Elastic APM:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
By default, the Node.js agent will not log the body of HTTP requests.
To enable this,
use the <a class="xref" href="configuration.html#capture-body" title="captureBody"><code class="literal">captureBody</code></a> config option
</li>
<li class="listitem">
By default, the Node.js agent will filter certain HTTP headers known to contain sensitive information.
To disable this,
use the <a class="xref" href="configuration.html#sanitize-field-names" title="sanitizeFieldNames"><code class="literal">sanitizeFieldNames</code></a> config option
</li>
<li class="listitem">
To apply custom filters,
use one of the <a class="xref" href="agent-api.html#apm-add-filter" title="apm.addFilter(fn)">filtering</a> functions
</li>
</ul>
</div>
<h4><a id="fastify-add-your-own-data"></a>Add your own data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/fastify.asciidoc">edit</a></h4>
<p>The Node.js agent will keep track of the active HTTP request and will link it to errors and recorded transaction metrics when they are sent to the Elastic APM server.
This allows you to see details about which request resulted in a particular error or which requests cause a certain HTTP endpoint to be slow.</p>
<p>But in many cases,
information about the HTTP request itself isn&#8217;t enough.
To add even more metadata to errors and transactions,
use one of the functions below:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="agent-api.html#apm-set-user-context" title="apm.setUserContext(context)"><code class="literal">apm.setUserContext()</code></a> - Call this to enrich collected performance data and errors with information about the user/client
</li>
<li class="listitem">
<a class="xref" href="agent-api.html#apm-set-custom-context" title="apm.setCustomContext(context)"><code class="literal">apm.setCustomContext()</code></a> - Call this to enrich collected performance data and errors with any information that you think will help you debug performance issues and errors (this data is only stored, but not indexed in Elasticsearch)
</li>
<li class="listitem">
<a class="xref" href="agent-api.html#apm-set-label" title="apm.setLabel(name, value[, stringify = true])"><code class="literal">apm.setLabel()</code></a> - Call this to enrich collected performance data and errors with simple key/value strings that you think will help you debug performance issues and errors (labels are indexed in Elasticsearch)
</li>
</ul>
</div>
<h4><a id="fastify-compatibility"></a>Compatibility<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/fastify.asciidoc">edit</a></h4>
<p>See <a class="xref" href="supported-technologies.html" title="Supported technologies"><em>Supported technologies</em></a> for details.</p>
<p>See also: <a href="https://www.fastify.io/docs/latest/LTS/" class="ulink" target="_top">Fastify&#8217;s own LTS documentation.</a></p>
<h4><a id="fastify-troubleshooting"></a>Troubleshooting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/fastify.asciidoc">edit</a></h4>
<p>If you can&#8217;t get the Node.js agent to work as expected,
please follow the <a class="xref" href="troubleshooting.html" title="Troubleshooting">troubleshooting guide</a>.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="express.html">« Get started with Express</a>
</span>
<span class="next">
<a href="hapi.html">Get started with hapi »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs.js"></script>
    <script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
