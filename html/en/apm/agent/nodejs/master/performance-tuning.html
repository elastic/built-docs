<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Performance Tuning | APM Node.js Agent Reference [master] | Elastic</title>
<link rel="home" href="index.html" title="APM Node.js Agent Reference [master]"/>
<link rel="up" href="index.html" title="APM Node.js Agent Reference [master]"/>
<link rel="prev" href="message-queues.html" title="Message queues"/>
<link rel="next" href="troubleshooting.html" title="Troubleshooting"/>
<meta name="DC.type" content="Learn/Docs/APM Node.js Agent/Reference/master"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="master"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">APM Node.js Agent Reference [master]</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="message-queues.html">« Message queues</a>
</span>
<span class="next">
<a href="troubleshooting.html">Troubleshooting »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="performance-tuning"></a>Performance Tuning<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/performance-tuning.asciidoc">edit</a></h1>
</div></div></div>
<p>The Node.js APM agent offers a variety of <a class="xref" href="configuration.html" title="Configuration options">configuration options</a>,
some of which can have a significant impact on performance. Areas where APM
agent overhead might be seen are: CPU, memory, network, latency, and storage.
This document discusses the options most significant for performance tuning the
APM agent.</p>
<h3><a id="performance-sampling"></a>Sample rate<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/performance-tuning.asciidoc">edit</a></h3>
<p>The <em>sample rate</em> is the percentage of incoming requests that are recorded and
sent to the APM Server. This is controlled by the
<a class="xref" href="configuration.html#transaction-sample-rate" title="transactionSampleRate"><code class="literal">transactionSampleRate</code></a> configuration option. By
default <em>all</em> requests are traced (<code class="literal">transactionSampleRate: 1.0</code>).</p>
<p>The amount of work the APM agent needs to do, generally scales linearly with
the number of traced requests. Therefore, the sample rate impacts CPU, memory,
network, and storage overhead.</p>
<p>Applications with a high request rate and/or many spans per incoming request
may want to lower the the sampling rate. For example, see the example below
to trace 20% of incoming requests. Note that incoming HTTP requests that are
part of a <a class="xref" href="distributed-tracing.html" title="Distributed tracing">distributed trace</a> already have the sampling
decision made&#8201;&#8212;&#8201;the <code class="literal">tracestate</code> header includes a
<a href="https://w3c.github.io/trace-context/#sampled-flag" class="ulink" target="_top">sampled flag</a>. In these cases
the <code class="literal">transactionSampleRate</code> setting will not apply.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">require('elastic-apm-node').start({
  transactionSampleRate: 0.2 // sample 20% of incoming requests
})</pre>
</div>
<h3><a id="performance-stack-traces"></a>Stack Traces<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/performance-tuning.asciidoc">edit</a></h3>
<p>When the APM agent captures an error, it records its stack trace for later
analysis and viewing. Optionally, the APM agent can also record a stack trace
for captured <span class="strong strong"><strong>spans</strong></span>. Stack traces can have a significant impact on CPU and
memory usage of the agent. There are several settings to adjust how they are
used.</p>
<h4><a id="performance-span-stack-traces"></a>Span Stack Traces<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/performance-tuning.asciidoc">edit</a></h4>
<p>The <a class="xref" href="configuration.html#span-stack-trace-min-duration" title="spanStackTraceMinDuration"><code class="literal">spanStackTraceMinDuration</code></a> configuration
option controls if stack traces are never captured for spans (the
default), always captured for spans, or only captured for spans that are longer
than a given duration. In a complex application, a traced request may capture
many spans. Capturing and sending a stack trace for every span can result in
significant CPU and memory usage.</p>
<p>It is because of the possibility of this CPU overhead that the APM Agent
disables stack trace collection for <em>spans</em> by default. Unfortunately, even
the capturing of raw stack trace data at span creation and then throwing that
away for fast spans can have significant CPU overhead for heavily loaded
applications. Therefore, care must be taken before using <code class="literal">spanStackTraceMinDuration</code>.</p>
<h4><a id="performance-source-lines"></a>Stack Trace Source Lines<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/performance-tuning.asciidoc">edit</a></h4>
<p>If you want to keep span stack traces enabled for context,
the next thing to try is adjusting how many source lines are reported for each stack trace.
When a stack trace is captured,
the agent will also capture several lines of source code around each stack frame location in the stack trace.</p>
<p>The are four different settings to control this behaviour:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="configuration.html#source-context-error-app-frames"><code class="literal">sourceLinesErrorAppFrames</code></a>
</li>
<li class="listitem">
<a class="xref" href="configuration.html#source-context-error-library-frames"><code class="literal">sourceLinesErrorLibraryFrames</code></a>
</li>
<li class="listitem">
<a class="xref" href="configuration.html#source-context-span-app-frames"><code class="literal">sourceLinesSpanAppFrames</code></a>
</li>
<li class="listitem">
<a class="xref" href="configuration.html#source-context-span-library-frames"><code class="literal">sourceLinesSpanLibraryFrames</code></a>
</li>
</ul>
</div>
<p>Source line settings are divided into app frames representing your app code and library frames representing the code of your dependencies.
App and library categories are both split into error and span groups.
Spans,
by default,
do not capture source lines.
Errors,
by default,
will capture five lines of code around each stack frame.</p>
<p>Source lines are cached in-process.
In memory-constrained environments,
the source line cache may use more memory than desired.
Turning the limits down will help prevent excessive memory use.</p>
<h4><a id="performance-stack-frame-limit"></a>Stack Frame Limit<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/performance-tuning.asciidoc">edit</a></h4>
<p>The <a class="xref" href="configuration.html#stack-trace-limit" title="stackTraceLimit"><code class="literal">stackTraceLimit</code></a> configuration option controls how
many stack frames are captured when producing an <code class="literal">Error</code> instance of any kind.
A large value may impact CPU and memory overhead of the agent.</p>
<h4><a id="performance-error-log-stack-traces"></a>Error Log Stack Traces<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/performance-tuning.asciidoc">edit</a></h4>
<p>Most stack traces recorded by the agent will point to where the error was instantiated,
not where it was identified and reported to the agent with <a class="xref" href="agent-api.html#apm-capture-error" title="apm.captureError(error[, options][, callback])"><code class="literal">captureError</code></a>.
For this reason,
the agent also has the <a class="xref" href="configuration.html#capture-error-log-stack-traces" title="captureErrorLogStackTraces"><code class="literal">captureErrorLogStackTraces</code></a> setting to enable capturing an additional stack trace pointing to the place an error was reported to the agent.
By default,
it will only capture the stack trace to the reporting point when <a class="xref" href="agent-api.html#apm-capture-error" title="apm.captureError(error[, options][, callback])"><code class="literal">captureError</code></a> is called with a string message.</p>
<p>Setting this to <code class="literal">always</code> will increase memory and bandwidth usage,
so it helps to consider how frequently the app may capture errors.</p>
<h3><a id="performance-transaction-max-spans"></a>Spans<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/performance-tuning.asciidoc">edit</a></h3>
<p>The <a class="xref" href="configuration.html#transaction-max-spans" title="transactionMaxSpans"><code class="literal">transactionMaxSpans</code></a> setting limits the number of spans which may be recorded within a single transaction before remaining spans are dropped.</p>
<p>Spans may include many things such as a stack trace and context data.
Limiting the number of spans that may be recorded will reduce memory usage.</p>
<p>Reducing max spans could result in loss of useful data about what occurred within a request,
if it is set too low.</p>
<p>An alternative to limiting the maximum number of spans can be to drop spans with a very short duration, as those might not be that relevant.</p>
<p>This, however, both reduces the amount of storage needed to store the spans in Elasticsearch, and the bandwidth needed to transport the data to the APM Server from the instrumented application.</p>
<p>This can be implemented by providing a span-filter:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">agent.addSpanFilter(payload =&gt; {
  return payload.duration &lt; 10 ? null : payload
})</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Using a span filter does not reduce the load of recording the spans in your application, but merely filters them out before sending them to the APM Server.</p>
</div>
</div>
<h3><a id="performance-max-queue-size"></a>Max queue size<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/performance-tuning.asciidoc">edit</a></h3>
<p>The APM agent uses a persistent outgoing HTTP request (periodically refreshed)
to stream data to the APM Server. If either the APM agent cannot keep up with
events (transactions, spans, errors, and metricsets) from the application or
if the APM Server is slow or not responding, then the agent will buffer events.
If the buffer exceeds <a class="xref" href="configuration.html#max-queue-size" title="maxQueueSize"><code class="literal">maxQueueSize</code></a>, then events are dropped to limit
memory usage of the agent.</p>
<p>A lower value for <code class="literal">maxQueueSize</code> will decrease the heap overhead (and possibly
the CPU usage) of the agent, while a higher value makes it less likely to lose
events in case of a temporary spike in throughput.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="message-queues.html">« Message queues</a>
</span>
<span class="next">
<a href="troubleshooting.html">Troubleshooting »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
