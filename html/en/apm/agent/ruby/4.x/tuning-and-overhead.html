<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Performance tuning | APM Ruby Agent Reference [4.x] | Elastic</title>
<link rel="home" href="index.html" title="APM Ruby Agent Reference [4.x]"/>
<link rel="up" href="index.html" title="APM Ruby Agent Reference [4.x]"/>
<link rel="prev" href="log-correlation.html" title="Log correlation"/>
<link rel="next" href="debugging.html" title="Troubleshooting"/>
<meta name="DC.type" content="Learn/Docs/APM Ruby Agent/Reference/4.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="4.x"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">APM Ruby Agent Reference [4.x]</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="log-correlation.html">« Log correlation</a>
</span>
<span class="next">
<a href="debugging.html">Troubleshooting »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="tuning-and-overhead"></a>Performance tuning<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/4.x/docs/performance-tuning.asciidoc">edit</a></h1>
</div></div></div>
<p>Using any APM solution comes with trade-offs, and the Elastic APM Ruby Agent is no different.
Instrumenting your code, using timers, recording context data, etc., uses resources—for example:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
CPU time
</li>
<li class="listitem">
Memory
</li>
<li class="listitem">
Bandwidth
</li>
<li class="listitem">
Elasticsearch storage
</li>
</ul>
</div>
<p>We invest a lot of effort to ensure that the Ruby Agent is suitable for production code
and that its overhead remains as low as possible.
However, because every application is different, there are some knobs you can turn and tweak to adapt the Agent to your specific needs.</p>
<h3><a id="tuning-sample-rate"></a>Transaction sample rate<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/4.x/docs/performance-tuning.asciidoc">edit</a></h3>
<p>By default, the Agent samples every transaction.
The easiest way to reduce both the overhead of the agent and storage requirements,
is to tell it to do less, i.e., sample fewer transactions.
To do this, set the <a class="xref" href="configuration.html#config-transaction-sample-rate" title="transaction_sample_rate"><code class="literal">transaction_sample_rate</code></a>
to a value between <code class="literal">0.0</code> and <code class="literal">1.0</code>—the percentage of transactions you&#8217;d like to randomly sample.
The Agent will still record the overall time and result of unsampled transactions,
but not context information, tags, or spans.</p>
<h3><a id="tuning-frame-context"></a>Collecting frame context<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/4.x/docs/performance-tuning.asciidoc">edit</a></h3>
<p>The Agent automatically captures several lines of source code around each frame location in the stack trace.
This enables the APM app to provide greater insight into exactly where an error or span is occurring in your code.
This insight does come at a cost—in terms of performance, stack trace collection is the most expensive thing the Agent does.</p>
<p>There are settings you can modify to control this behavior:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Disable stack trace frame collection for short-duration spans by setting
<a class="xref" href="configuration.html#config-span-frames-min-duration-ms" title="span_frames_min_duration"><code class="literal">span_frames_min_duration</code></a> to <code class="literal">0</code>.
</li>
<li class="listitem">
<p>Modify the number of source code lines collected.
These settings are divided between app frames, which represent your application code,
and library frames, which represent the code of your dependencies.
Each of these categories are further split into separate error and span settings.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="configuration.html#config-source-lines-error-app-frames" title="source_lines_error_app_frames"><code class="literal">source_lines_error_app_frames</code></a>
</li>
<li class="listitem">
<a class="xref" href="configuration.html#config-source-lines-error-library-frames" title="source_lines_error_library_frames"><code class="literal">source_lines_error_library_frames</code></a>
</li>
<li class="listitem">
<a class="xref" href="configuration.html#config-source-lines-span-app-frames" title="source_lines_span_app_frames"><code class="literal">source_lines_span_app_frames</code></a>
</li>
<li class="listitem">
<a class="xref" href="configuration.html#config-source-lines-span-library-frames" title="source_lines_span_library_frames"><code class="literal">source_lines_span_library_frames</code></a>
</li>
</ul>
</div>
</li>
<li class="listitem">
If you&#8217;re using the API to create a custom span, you can disable stack trace collection with the
<a class="xref" href="api.html#api-agent-start_span" title="ElasticAPM.start_span"><code class="literal">include_stacktrace</code> argument</a>.
</li>
</ol>
</div>
<p>Reading source files inside a running application can cause a lot of disk I/O,
and sending up source lines for each frame will have a network and storage cost that is quite high.
Turning these limits down will prevent storing excessive amounts of data in Elasticsearch.</p>
<h3><a id="tuning-queue"></a>Transaction queue<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/4.x/docs/performance-tuning.asciidoc">edit</a></h3>
<p>The Agent does not send every transaction as it happens.
Instead, to reduce load on the APM Server, the Agent uses a queue.
The queue is flushed periodically, or when it reaches a maximum size.</p>
<p>While this reduces the load on the APM Server, holding on to transaction data in a queue uses memory.
If you notice a large increase in memory use, try adjusting these settings:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="configuration.html#config-api-request-time" title="api_request_time"><code class="literal">api_request_time</code></a> to reduce the duration of a single streaming request.
This setting is helpful if you have a sustained high number of transactions.
</li>
<li class="listitem">
<a class="xref" href="configuration.html#config-api-request-size" title="api_request_size"><code class="literal">api_request_size</code></a> to reduce the maximum size of one request.
This setting can help if you experience transaction peaks (a large number in a short period of time).
</li>
</ul>
</div>
<p>Keep in mind that reducing the value of either setting will cause the agent to send more HTTP requests to the APM Server,
potentially causing a higher load.</p>
<h3><a id="tuning-max-spans"></a>Spans per transaction<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/4.x/docs/performance-tuning.asciidoc">edit</a></h3>
<p>The number of spans per transaction will influence both how much time the agent spends in each transaction collecting contextual data,
and how much storage space is needed in Elasticsearch.
In our experience, most <em>usual</em> transactions should have well below 100 spans.
In some cases, however, the number of spans can explode—for example:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Long-running transactions
</li>
<li class="listitem">
Unoptimized code, e.g., doing hundreds of SQL queries in a loop
</li>
</ul>
</div>
<p>To avoid these edge cases which overload both the Agent and the APM Server,
the Agent will stop recording spans when a specified limit is reached.
This limit is configurable with <a class="xref" href="configuration.html#config-transaction-max-spans" title="transaction_max_spans"><code class="literal">transaction_max_spans</code></a>.</p>
<h3><a id="tuning-body-headers"></a>Capturing headers and request body<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/4.x/docs/performance-tuning.asciidoc">edit</a></h3>
<p>You can configure the Agent to capture headers and request bodies with
<a class="xref" href="configuration.html#config-capture-headers" title="capture_headers"><code class="literal">capture_headers</code></a> and <a class="xref" href="configuration.html#config-capture-body" title="capture_body"><code class="literal">capture_body</code></a>.
By default, headers are captured and request bodies are not.</p>
<p>Depending on the nature of your POST requests, capturing request bodies for transactions may introduce noticeable overhead,
as well as increased storage use.
In most scenarios, we advise against enabling request body capturing for transactions, and only enabling it if necessary for errors.</p>
<p>Capturing request/response headers has less overhead on the agent than capturing request bodies,
but can have an impact on storage use.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="log-correlation.html">« Log correlation</a>
</span>
<span class="next">
<a href="debugging.html">Troubleshooting »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
