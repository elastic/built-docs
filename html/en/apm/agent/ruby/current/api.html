<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>API reference | APM Ruby Agent Reference [3.x] | Elastic</title>
<link rel="home" href="index.html" title="APM Ruby Agent Reference [3.x]"/>
<link rel="up" href="index.html" title="APM Ruby Agent Reference [3.x]"/>
<link rel="prev" href="custom-instrumentation.html" title="Custom instrumentation"/>
<link rel="next" href="metrics.html" title="Metrics"/>
<meta name="DC.type" content="Learn/Docs/APM Ruby Agent/Reference/3.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="3.x"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">APM Ruby Agent Reference [3.x]</a></span>
»
<span class="breadcrumb-node">API reference</span>
</div>
<div class="navheader">
<span class="prev">
<a href="custom-instrumentation.html">« Custom instrumentation</a>
</span>
<span class="next">
<a href="metrics.html">Metrics »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="api"></a>API reference<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h1>
</div></div></div>
<p>Although most usage is covered automatically, Elastic APM also has a public
API that allows custom usage.</p>
<h3><a id="agent-life-cycle"></a>Agent life cycle<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h3>
<p>Controlling when the agent starts and stops.</p>
<h4><a id="api-agent-start"></a><code class="literal">ElasticAPM.start</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>To create and start an ElasticAPM agent use <code class="literal">ElasticAPM.start</code>:</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">ElasticAPM.start(server_url: 'http://localhost:8200')</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">config</code>: An optional hash or <code class="literal">ElasticAPM::Config</code> instance with configuration
options.  See <a class="xref" href="configuration.html" title="Configuration">Configuration</a>.
</li>
</ul>
</div>
<p>If you are using <a class="xref" href="getting-started-rails.html" title="Getting started with Rails">Ruby on Rails</a> this is done automatically for you.
If you choose not to require the <code class="literal">elastic_apm</code> gem and instead want to start the
agent and hook into Rails manually, see <a class="xref" href="api.html#rails-start" title="Rails">hooking into Rails explicitly</a>.
If you&#8217;re not using Rails, see <a class="xref" href="getting-started-rack.html" title="Getting started with Rack">Getting started with Rack</a>.</p>
<h4><a id="api-agent-stop"></a><code class="literal">ElasticAPM.stop</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Stop the currently running agent. Use this inside <code class="literal">at_exit</code> in your
<a class="xref" href="getting-started-rack.html" title="Getting started with Rack">Rack app</a> to gracefully shut down.</p>
<h4><a id="api-agent-restart"></a><code class="literal">ElasticAPM.restart</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>If the agent is already running, this method will stop and start the agent.</p>
<p>If the agent is not already running, this method will start the agent.</p>
<p>A config can be passed to the method that will be used to start the agent. If the agent
is already running and no config is passed to the <code class="literal">#restart</code> method, the running agent&#8217;s
config will be used.</p>
<h4><a id="api-agent-running"></a><code class="literal">ElasticAPM.running?</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Returns whether the ElasticAPM Agent is currently running.</p>
<h4><a id="api-agent-agent"></a><code class="literal">ElasticAPM.agent</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Returns the currently running agent or nil.</p>
<h3><a id="_instrumentation"></a>Instrumentation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h3>
<h4><a id="api-agent-current-transaction"></a><code class="literal">ElasticAPM.current_transaction</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Returns the current <code class="literal">ElasticAPM::Transaction</code> or nil.</p>
<h4><a id="api-agent-start_transaction"></a><code class="literal">ElasticAPM.start_transaction</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Start a <em>transaction</em> eg. an incoming web request or a background job.</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby"># call with block
ElasticAPM.start_transaction('Name')
do_work # ...
ElasticAPM.end_transaction('result')</pre>
</div>
<p>Arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code>: A name for your transaction. Transactions are grouped by name. <span class="strong strong"><strong>Required</strong></span>.
</li>
<li class="listitem">
<code class="literal">type</code>: A <code class="literal">type</code> for your transaction eg. <code class="literal">db.postgresql.sql</code>.
</li>
<li class="listitem">
<code class="literal">context:</code>: An optional <a class="xref" href="api.html#api-context" title="Context">Context</a> used to enrich the
transaction with information about the current request.
</li>
<li class="listitem">
<code class="literal">trace_context:</code>: An optional <code class="literal">TraceContext</code> object for Distributed Tracing.
</li>
</ul>
</div>
<p>Returns the transaction.</p>
<h4><a id="api-agent-end_transaction"></a><code class="literal">ElasticAPM.end_transaction</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Ends the currently running transaction.</p>
<p>Arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">result</code>: A <code class="literal">String</code> result of the transaction, eg. <code class="literal">'success'</code>.
</li>
</ul>
</div>
<h4><a id="api-agent-with_transaction"></a><code class="literal">ElasticAPM.with_transaction</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Wrap a block in a Transaction, starting and ending around the block</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">ElasticAPM.with_transaction 'Do things' do |transaction|
  do_work # ...

  transaction.result = 'success'
end</pre>
</div>
<p>Arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code>: A name for your transaction. Transactions are grouped by name. <span class="strong strong"><strong>Required</strong></span>.
</li>
<li class="listitem">
<code class="literal">type</code>: A <code class="literal">type</code> for your transaction eg. <code class="literal">db.postgresql.sql</code>.
</li>
<li class="listitem">
<code class="literal">context:</code>: An optional <a class="xref" href="api.html#api-context" title="Context">Context</a> used to enrich the
transaction with information about the current request.
</li>
<li class="listitem">
<code class="literal">trace_context:</code>: An optional <code class="literal">TraceContext</code> object for Distributed Tracing.
</li>
<li class="listitem">
<code class="literal">&amp;block</code>: A block to wrap. Optionally yields the transaction.
</li>
</ul>
</div>
<p>Returns the return value of the given block.</p>
<h4><a id="api-agent-start_span"></a><code class="literal">ElasticAPM.start_span</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Start a new span.</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">ElasticAPM.with_transaction 'Do things' do
  ElasticAPM.start_span 'Do one of the things'
  Database.query # ...
  ElasticAPM.end_span
end</pre>
</div>
<p>Arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code>: A name for your span. <span class="strong strong"><strong>Required</strong></span>.
</li>
<li class="listitem">
<code class="literal">type</code>: The type of span eg. <code class="literal">db</code>.
</li>
<li class="listitem">
<code class="literal">subtype</code>: The subtype of span eg. <code class="literal">postgresql</code>.
</li>
<li class="listitem">
<code class="literal">action</code>: The action type of span eg. <code class="literal">connect</code> or <code class="literal">query</code>.
</li>
<li class="listitem">
<code class="literal">context</code>: An instance of <code class="literal">Span::Context</code>.
</li>
<li class="listitem">
<code class="literal">include_stacktrace</code>: Whether or not to collect a Stacktrace.
</li>
<li class="listitem">
<code class="literal">trace_context:</code>: An optional <code class="literal">TraceContext</code> object for Distributed Tracing.
</li>
<li class="listitem">
<code class="literal">parent:</code>: An optional parent transaction or span. Relevant when the span is created in another thread.
</li>
<li class="listitem">
<code class="literal">sync:</code>: An boolean to indicate whether the span is created synchronously or not.
</li>
<li class="listitem">
<code class="literal">&amp;block</code>: An optional block to wrap with the span.
The block is passed the span as an optional argument.
</li>
</ul>
</div>
<p>Returns the created span.</p>
<p>If you&#8217;d like to create an asynchronous span, you have to pass the parent <code class="literal">Span</code> or <code class="literal">Transaction</code> to the <code class="literal">start_span</code> method.
You can also set the <code class="literal">sync</code> flag to <code class="literal">false</code>, if you&#8217;d like the span to be marked as asynchronous. This has no effect other than being queryable in Elasticsearch.</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">transaction = ElasticAPM.current_transaction # or start one with `.start_transaction`
Thread.new do
  ElasticAPM.start_span(
    'job 1',
    parent: transaction,
    sync: false
  ) { Worker.perform }
  ElasticAPM.end_span
end</pre>
</div>
<h4><a id="api-agent-end_span"></a><code class="literal">ElasticAPM.end_span</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Ends the currently running span.</p>
<h4><a id="api-agent-with_span"></a><code class="literal">ElasticAPM.with_span</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Wraps a block in a Span.</p>
<p>Arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code>: A name for your span. <span class="strong strong"><strong>Required</strong></span>.
</li>
<li class="listitem">
<code class="literal">type</code>: The type of span eg. <code class="literal">db</code>.
</li>
<li class="listitem">
<code class="literal">subtype</code>: The subtype of span eg. <code class="literal">postgresql</code>.
</li>
<li class="listitem">
<code class="literal">action</code>: The action type of span eg. <code class="literal">connect</code> or <code class="literal">query</code>.
</li>
<li class="listitem">
<code class="literal">context</code>: An instance of <code class="literal">Span::Context</code>.
</li>
<li class="listitem">
<code class="literal">include_stacktrace</code>: Whether or not to collect a Stacktrace.
</li>
<li class="listitem">
<code class="literal">trace_context:</code>: An optional <code class="literal">TraceContext</code> object for Distributed Tracing.
</li>
<li class="listitem">
<code class="literal">parent:</code>: An optional parent transaction or span. Relevant when the span is created in another thread.
</li>
<li class="listitem">
<code class="literal">sync:</code>: An boolean to indicate whether the span is created synchronously or not.
</li>
<li class="listitem">
<code class="literal">&amp;block</code>: An optional block to wrap with the span.
The block is passed the span as an optional argument.
</li>
</ul>
</div>
<p>Returns the return value of the given block.</p>
<p>If you&#8217;d like to create an asynchronous span, you have to pass the parent <code class="literal">Span</code> or <code class="literal">Transaction</code> to the <code class="literal">with_span</code> method.
You can also set the <code class="literal">sync</code> flag to <code class="literal">false</code>, if you&#8217;d like the span to be marked as asynchronous.</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">transaction = ElasticAPM.current_transaction # or start one with `.start_transaction`
Thread.new do
  ElasticAPM.with_span(
    'job 1',
    parent: transaction,
    sync: false
  ) { Worker.perform }
end</pre>
</div>
<h4><a id="api-agent-build-context"></a><code class="literal">ElasticAPM.build_context</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Build a new <em>Context</em> from a Rack <code class="literal">env</code>.</p>
<p>A context provides information about the current request, response, user and more.</p>
<p>Arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">rack_env</code>: An instance of Rack::Env
</li>
<li class="listitem">
<code class="literal">for_type</code>: Symbol representing type of event, eg. <code class="literal">:transaction</code> or <code class="literal">error</code>
</li>
</ul>
</div>
<p>Returns the built context.</p>
<h3><a id="rails-start"></a>Rails<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h3>
<p>Start the agent and hook into Rails manually. This is useful if you skip requiring
the gem and using the <code class="literal">Railtie</code>.</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">ElasticAPM::Rails.start(server_url: 'http://localhost:8200')</pre>
</div>
<h3><a id="sinatra-start"></a>Sinatra<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h3>
<p>Start the agent and hook into Sinatra.</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">ElasticAPM::Sinatra.start(MySinatraApp, server_url: 'http://localhost:8200')</pre>
</div>
<h3><a id="grape-start"></a>Grape<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h3>
<p>Start the agent and hook into Grape.</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">ElasticAPM::Grape.start(MyGrapeApp, server_url: 'http://localhost:8200')</pre>
</div>
<h3><a id="_errors"></a>Errors<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h3>
<h4><a id="api-agent-report"></a><code class="literal">ElasticAPM.report</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Send an <code class="literal">Exception</code> to Elastic APM.</p>
<p>If reported inside a transaction, the context from that will be added.</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">begin
  do_a_thing_and_fail
rescue Exception =&gt; e
  ElasticAPM.report(e)
end</pre>
</div>
<p>Arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">exception</code>: An instance of <code class="literal">Exception</code>. <span class="strong strong"><strong>Required</strong></span>.
</li>
<li class="listitem">
<code class="literal">handled</code>: Whether the error was <em>handled</em> eg. wasn&#8217;t rescued and was represented
to the user. Default: <code class="literal">true</code>.
</li>
</ul>
</div>
<p>Returns <code class="literal">[String]</code> ID of the generated <code class="literal">[ElasticAPM::Error]</code> object.</p>
<h4><a id="api-agent-report-message"></a><code class="literal">ElasticAPM.report_message</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Send a custom message to Elastic APM.</p>
<p>If reported inside a transaction, the context from that will be added.</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">ElasticAPM.report_message('This should probably never happen?!')</pre>
</div>
<p>Arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">message</code>: A custom error string. <span class="strong strong"><strong>Required</strong></span>.
</li>
</ul>
</div>
<p>Returns <code class="literal">[String]</code> ID of the generated <code class="literal">[ElasticAPM::Error]</code> object.</p>
<h3><a id="api-context"></a>Context<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h3>
<h4><a id="api-agent-set-label"></a><code class="literal">ElasticAPM.set_label</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Add a label to the current transaction.
Labels are basic key-value pairs that are indexed in your Elasticsearch database and therefore searchable.
The value can be a string, nil, numeric or boolean.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Before using custom labels, ensure you understand the different types of
<a href="/guide/en/apm/get-started/7.9/metadata.html" class="ulink" target="_top">metadata</a> that are available.</p>
</div>
</div>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">before_action do
  ElasticAPM.set_label(:company_id, current_user.company.id)
end</pre>
</div>
<p>Arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">key</code>: A string key. Note that <code class="literal">.</code>, <code class="literal">*</code> or <code class="literal">"</code> will be converted to <code class="literal">_</code>.
</li>
<li class="listitem">
<code class="literal">value</code>: A value.
</li>
</ul>
</div>
<p>Returns the set <code class="literal">value</code>.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Be aware that labels are indexed in Elasticsearch. Using too many unique keys will result in <span class="strong strong"><strong><a href="/blog/found-crash-elasticsearch#mapping-explosion" class="ulink" target="_top">Mapping explosion</a></strong></span>.</p>
</div>
</div>
<h4><a id="api-agent-set-custom-context"></a><code class="literal">ElasticAPM.set_custom_context</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Add custom context to the current transaction.
Use this to further specify a context that will help you track or diagnose what&#8217;s
going on inside your app.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Before using custom context, ensure you understand the different types of
<a href="/guide/en/apm/get-started/7.9/metadata.html" class="ulink" target="_top">metadata</a> that are available.</p>
</div>
</div>
<p>If called several times during a transaction the custom context will be destructively
merged with <code class="literal">merge!</code>.</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">before_action do
  ElasticAPM.set_custom_context(company: current_user.company.to_h)
end</pre>
</div>
<p>Arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">context</code>: A hash of JSON-compatible key-values. Can be nested.
</li>
</ul>
</div>
<p>Returns current custom context.</p>
<h4><a id="api-agent-set-user"></a><code class="literal">ElasticAPM.set_user</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Add the current user to the current transaction&#8217;s context.</p>
<p>Arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">user</code>: An object representing the user
</li>
</ul>
</div>
<p>Returns the given user</p>
<h3><a id="_data"></a>Data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h3>
<h4><a id="api-agent-add-filter"></a><code class="literal">ElasticAPM.add_filter</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Provide a filter to transform payloads before sending.</p>
<p>Arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">key</code>: A unique key identifying the filter
</li>
<li class="listitem">
<code class="literal">callable</code>: An object or proc (responds to <code class="literal">.call(payload)</code>)
</li>
</ul>
</div>
<p>Return the altered payload.</p>
<p>If <code class="literal">nil</code> is returned all subsequent filters will be skipped and the post request cancelled.</p>
<p>Example:</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">ElasticAPM.add_filter(:filter_pings) do |payload|
  payload[:transactions]&amp;.reject! do |t|
    t[:name] == 'PingsController#index'
  end
  payload
end</pre>
</div>
<h3><a id="api-transaction"></a>Transaction<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h3>
<p><code class="literal">ElasticAPM.transaction</code> returns a <code class="literal">Transaction</code> (if the agent is running).</p>
<h4><a id="_properties"></a>Properties<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code>: String
</li>
<li class="listitem">
<code class="literal">type</code>: String
</li>
<li class="listitem">
<code class="literal">result</code>: String
</li>
<li class="listitem">
<code class="literal">outcome</code>: String (<em>unknown</em>, <em>success</em>, <em>failure</em>, nil)
</li>
<li class="listitem">
<code class="literal">trace_id</code>: String (readonly)
</li>
</ul>
</div>
<h4><a id="api-transaction-sampled_"></a><code class="literal">#sampled?</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>Whether the transaction is <em>sampled</em> eg. it includes stacktraces for its spans.</p>
<h4><a id="api-transaction-ensure_parent_id"></a><code class="literal">#ensure_parent_id</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<p>If the transaction does not have a parent-ID yet, calling this method generates
a new ID, sets it as the parent-ID of this transaction, and returns it as a
<code class="literal">String</code>.</p>
<p>This enables the correlation of the spans the JavaScript Real User Monitoring
(RUM) agent creates for the initial page load with the transaction of the
backend service.</p>
<p>If your service generates the HTML page dynamically, initializing the
JavaScript RUM agent with the value of this method allows analyzing the time
spent in the browser vs in the backend services.</p>
<p>To enable the JavaScript RUM agent, initialize the RUM agent with the Ruby
agent&#8217;s current transaction:</p>
<div class="pre_wrapper lang-html">
<pre class="programlisting prettyprint lang-html">&lt;script src="elastic-apm-js-base/dist/bundles/elastic-apm-js-base.umd.min.js"&gt;&lt;/script&gt;
&lt;script&gt;
  var elasticApm = initApm({
    serviceName: '',
    serverUrl: 'http://localhost:8200',
    pageLoadTraceId: "&lt;%= ElasticAPM.current_transaction&amp;.trace_id %&gt;",
    pageLoadSpanId: "&lt;%= ElasticAPM.current_transaction&amp;.ensure_parent_id %&gt;",
    pageLoadSampled: &lt;%= ElasticAPM.current_transaction&amp;.sampled? %&gt;
  })
&lt;/script&gt;</pre>
</div>
<p>See the <a href="/guide/en/apm/agent/rum-js/current" class="ulink" target="_top">JavaScript RUM agent documentation</a> for more information.</p>
<h3><a id="api-span"></a>Span<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h3>
<h4><a id="_properties_2"></a>Properties<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-ruby/edit/3.x/docs/api.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code>: String
</li>
<li class="listitem">
<code class="literal">type</code>: String
</li>
</ul>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="custom-instrumentation.html">« Custom instrumentation</a>
</span>
<span class="next">
<a href="metrics.html">Metrics »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Most Popular</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Get Started with Elasticsearch: Video</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Intro to Kibana: Video</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">ELK for Logs & Metrics: Video</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
