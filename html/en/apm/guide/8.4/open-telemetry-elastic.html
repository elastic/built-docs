<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>OpenTelemetry integration | APM User Guide [8.4] | Elastic</title>
<meta class="elastic" name="content" content="OpenTelemetry integration | APM User Guide [8.4]">

<link rel="home" href="index.html" title="APM User Guide [8.4]"/>
<link rel="up" href="apm-features.html" title="Elastic APM features"/>
<link rel="prev" href="opentracing.html" title="OpenTracing bridge"/>
<link rel="next" href="observability-integrations.html" title="Observability integrations"/>
<meta class="elastic" name="product_version" content="8.4"/>
<meta class="elastic" name="product_name" content="APM"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/APM Guide/8.4"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="8.4"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link">
  <div id="related-products" class="dropdown">
    <div class="related-products-title">APM:</div>
    <div class="dropdown-anchor" tabindex="0">User Guide<span class="dropdown-icon"></span></div>
    <div class="dropdown-content">
      <ul>
        <li class="dropdown-category">APM</li>
        <ul>
          <li><a href="/guide/en/apm/guide/current/apm-overview.html">User Guide</a></li>
        </ul>
        <li class="dropdown-category">APM agents</li>
        <ul>
          <li><a href="/guide/en/apm/agent/android/current/intro.html">Android Agent Reference</a></li>
          <li><a href="/guide/en/apm/agent/go/current/introduction.html">Go Agent Reference</a></li>
          <li><a href="/guide/en/apm/agent/swift/current/intro.html">iOS Agent Reference</a></li>
          <li><a href="/guide/en/apm/agent/java/current/intro.html">Java Agent Reference</a></li>
          <li><a href="/guide/en/apm/agent/dotnet/current/intro.html">.NET Agent Reference</a></li>
          <li><a href="/guide/en/apm/agent/nodejs/current/intro.html">Node.js Agent Reference</a></li>
          <li><a href="/guide/en/apm/agent/php/current/intro.html">PHP Agent Reference</a></li>
          <li><a href="/guide/en/apm/agent/python/current/getting-started.html">Python Agent Reference</a></li>
          <li><a href="/guide/en/apm/agent/ruby/current/introduction.html">Ruby Agent Reference</a></li>
          <li><a href="/guide/en/apm/agent/rum-js/current/intro.html">Real User Monitoring JavaScript Agent Reference</a></li>
        </ul>
        <li class="dropdown-category">APM extensions</li>
        <ul>
          <li><a href="/guide/en/apm/lambda/current/aws-lambda-arch.html">Monitoring AWS Lambda Functions</a></li>
          <li><a href="/guide/en/apm/attacher/current/apm-attacher.html">Attacher</a></li>
        </ul>
      </ul>
    </div>
  </div>
</span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="legacy-apm-overview.html">Legacy APM Overview</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="apm-features.html">Elastic APM features</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="opentracing.html">« OpenTracing bridge</a>
</span>
<span class="next">
<a href="observability-integrations.html">Observability integrations »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="open-telemetry-elastic"></a>OpenTelemetry integration<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h2>
</div></div></div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>This documentation refers to the standalone (legacy) method of running APM Server. This method of running APM Server will be deprecated and removed in a future release. Please consider <a class="xref" href="upgrade-to-apm-integration.html" title="Switch to the Elastic APM integration">upgrading to the Elastic APM integration</a>.
If you&#8217;ve already upgraded, see <a class="xref" href="open-telemetry.html" title="OpenTelemetry integration">OpenTelemetry integration</a>.</p>
</div>
</div>
<p><a href="https://opentelemetry.io/docs/concepts/what-is-opentelemetry/" class="ulink" target="_top">OpenTelemetry</a> is a set
of APIs, SDKs, tooling, and integrations that enable the capture and management of
telemetry data from your services for greater observability. For more information about the
OpenTelemetry project, see the <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/master/README.md" class="ulink" target="_top">spec</a>.</p>
<p>Elastic OpenTelemetry integrations allow you to reuse your existing OpenTelemetry
instrumentation to quickly analyze distributed traces and metrics to help you monitor
business KPIs and technical components with the Elastic Stack.</p>
<h4><a id="open-telemetry-elastic-protocol"></a>APM Server native support of OpenTelemetry protocol<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h4>
<p>Elastic APM Server natively supports the OpenTelemetry protocol.
This means trace data and metrics collected from your applications and infrastructure can
be sent directly to Elastic APM Server using the OpenTelemetry protocol.</p>
<div class="imageblock">
<div class="content">
<img src="./images/open-telemetry-protocol-arch.png" alt="OpenTelemetry Elastic architecture diagram">
</div>
</div>
<h6><a id="instrument-apps-apm-server"></a>Instrument applications<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h6>
<p>To export traces and metrics to APM Server, ensure that you have instrumented your services and applications
with the OpenTelemetry API, SDK, or both. For example, if you are a Java developer, you need to instrument your Java app using the
<a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation" class="ulink" target="_top">OpenTelemetry agent for Java</a>.</p>
<p>By defining the following environment variables, you can configure the OTLP endpoint so that the OpenTelemetry agent communicates with
APM Server.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">export OTEL_RESOURCE_ATTRIBUTES=service.name=checkoutService,service.version=1.1,deployment.environment=production
export OTEL_EXPORTER_OTLP_ENDPOINT=https://apm_server_url:8200
export OTEL_EXPORTER_OTLP_HEADERS="Authorization=Bearer an_apm_secret_token"
java -javaagent:/path/to/opentelemetry-javaagent-all.jar \
     -classpath lib/*:classes/ \
     com.mycompany.checkout.CheckoutServiceServer</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">OTEL_RESOURCE_ATTRIBUTES</code></p></td>
<td align="left" valign="top"><p>Fields that describe the service and the environment that the service runs in. See <a class="xref" href="open-telemetry-elastic.html#elastic-open-telemetry-resource-attributes" title="Resource attributes">Resource attributes</a> for more information.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">OTEL_EXPORTER_OTLP_ENDPOINT</code></p></td>
<td align="left" valign="top"><p>APM Server URL. The host and port that APM Server listens for events on.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">OTEL_EXPORTER_OTLP_HEADERS</code></p></td>
<td align="left" valign="top"><p>Authorization header that includes the Elastic APM Secret token or API key: <code class="literal">"Authorization=Bearer an_apm_secret_token"</code> or <code class="literal">"Authorization=ApiKey an_api_key"</code>.</p>
<p>For information on how to format an API key, see our <a href="/guide/en/apm/guide/8.4/api-key.html" class="ulink" target="_top">API key</a> docs.</p>
<p>Please note the required space between <code class="literal">Bearer</code> and <code class="literal">an_apm_secret_token</code>, and <code class="literal">APIKey</code> and <code class="literal">an_api_key</code>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">OTEL_EXPORTER_OTLP_CERTIFICATE</code></p></td>
<td align="left" valign="top"><p>The trusted certificate used to verify the TLS credentials of the client. (optional)</p></td>
</tr>
</tbody>
</table>
</div>
<p>You are now ready to collect traces and <a class="xref" href="open-telemetry-elastic.html#open-telemetry-elastic-metrics" title="Collect metrics">metrics</a> before <a class="xref" href="open-telemetry-elastic.html#open-telemetry-elastic-verify" title="Verify OpenTelemetry metrics data">verifying metrics</a>
and <a class="xref" href="open-telemetry-elastic.html#open-telemetry-elastic-kibana" title="Visualize in Kibana">visualizing metrics</a> in Kibana.</p>
<h5><a id="open-telemetry-collector"></a>Connect OpenTelemetry Collector instances<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h5>
<p>Using the OpenTelemetry collector instances in your architecture, you can connect them to Elastic Observability using the OTLP exporter.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">receivers: <a id="CO50-1"></a><i class="conum" data-value="1"></i>
  # ...
  otlp:

processors: <a id="CO50-2"></a><i class="conum" data-value="2"></i>
  # ...
  memory_limiter:
    check_interval: 1s
    limit_mib: 2000
  batch:

exporters:
  logging:
    loglevel: warn <a id="CO50-3"></a><i class="conum" data-value="3"></i>
  otlp/elastic: <a id="CO50-4"></a><i class="conum" data-value="4"></i>
    # Elastic APM server https endpoint without the "https://" prefix
    endpoint: "${ELASTIC_APM_SERVER_ENDPOINT}" <a id="CO50-5"></a><i class="conum" data-value="5"></i> <a id="CO50-6"></a><i class="conum" data-value="7"></i>
    headers:
      # Elastic APM Server secret token
      Authorization: "Bearer ${ELASTIC_APM_SECRET_TOKEN}" <a id="CO50-7"></a><i class="conum" data-value="6"></i> <a id="CO50-8"></a><i class="conum" data-value="7"></i>

service:
  pipelines:
    traces:
      receivers: [otlp]
      exporters: [logging, otlp/elastic]
    metrics:
      receivers: [otlp]
      exporters: [logging, otlp/elastic]
    logs: <a id="CO50-9"></a><i class="conum" data-value="8"></i>
      receivers: [otlp]
      exporters: [logging, otlp/elastic]</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO50-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The receivers, such as
the <a href="https://github.com/open-telemetry/opentelemetry-collector/tree/main/receiver/otlpreceiver" class="ulink" target="_top">OTLP receiver</a>, that forward data emitted by APM agents or the <a href="https://github.com/open-telemetry/opentelemetry-collector/tree/main/receiver/hostmetricsreceiver" class="ulink" target="_top">host metrics receiver</a>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO50-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>We recommend using the <a href="https://github.com/open-telemetry/opentelemetry-collector/blob/main/processor/batchprocessor/README.md" class="ulink" target="_top">Batch processor</a> and also suggest using the <a href="https://github.com/open-telemetry/opentelemetry-collector/blob/main/processor/memorylimiter/README.md" class="ulink" target="_top">memory limiter processor</a>. For more information, see <a href="https://github.com/open-telemetry/opentelemetry-collector/blob/main/processor/README.md#recommended-processors" class="ulink" target="_top">Recommended processors</a>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO50-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <a href="https://github.com/open-telemetry/opentelemetry-collector/tree/main/exporter/loggingexporter" class="ulink" target="_top">logging exporter</a> is helpful for troubleshooting and supports various logging levels: <code class="literal">debug</code>, <code class="literal">info</code>, <code class="literal">warn</code>, and <code class="literal">error</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO50-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>Elastic Observability endpoint configuration.
APM Server supports a ProtoBuf payload via both the OTLP protocol over gRPC transport <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md#otlpgrpc" class="ulink" target="_top">(OTLP/gRPC)</a>
and the OTLP protocol over HTTP transport <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md#otlphttp" class="ulink" target="_top">(OTLP/HTTP)</a>.
To learn more about these exporters, see the OpenTelemetry Collector documentation:
<a href="https://github.com/open-telemetry/opentelemetry-collector/tree/main/exporter/otlphttpexporter" class="ulink" target="_top">OTLP/HTTP Exporter</a> or
<a href="https://github.com/open-telemetry/opentelemetry-collector/tree/main/exporter/otlpexporter" class="ulink" target="_top">OTLP/gRPC exporter</a>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO50-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>Hostname and port of the APM Server endpoint. For example, <code class="literal">elastic-apm-server:8200</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO50-7"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>Credential for Elastic APM <a href="/guide/en/apm/guide/8.4/secret-token.html" class="ulink" target="_top">secret token authorization</a> (<code class="literal">Authorization: "Bearer a_secret_token"</code>) or <a href="/guide/en/apm/guide/8.4/api-key.html" class="ulink" target="_top">API key authorization</a> (<code class="literal">Authorization: "ApiKey an_api_key"</code>).</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO50-6"><i class="conum" data-value="7"></i></a><a href="#CO50-8"></a></p>
</td>
<td align="left" valign="top">
<p>Environment-specific configuration parameters can be conveniently passed in as environment variables documented <a href="https://opentelemetry.io/docs/collector/configuration/#configuration-environment-variables" class="ulink" target="_top">here</a> (e.g. <code class="literal">ELASTIC_APM_SERVER_ENDPOINT</code> and <code class="literal">ELASTIC_APM_SECRET_TOKEN</code>).</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO50-9"><i class="conum" data-value="8"></i></a></p>
</td>
<td align="left" valign="top">
<p>To send OpenTelemetry logs to Elastic Stack version 8.0+, declare a <code class="literal">logs</code> pipeline.</p>
</td>
</tr>
</table>
</div>
<p>You&#8217;re now ready to export traces and metrics from your services and applications.</p>
<h4><a id="open-telemetry-elastic-metrics"></a>Collect metrics<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h4>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>When collecting metrics, please note that the <a href="https://www.javadoc.io/doc/io.opentelemetry/opentelemetry-api/latest/io/opentelemetry/api/metrics/DoubleValueRecorder.html" class="ulink" target="_top"><code class="literal">DoubleValueRecorder</code></a>
and <a href="https://www.javadoc.io/doc/io.opentelemetry/opentelemetry-api/latest/io/opentelemetry/api/metrics/LongValueObserver.html" class="ulink" target="_top"><code class="literal">LongValueRecorder</code></a> metrics are not yet supported.</p>
</div>
</div>
<p>Here&#8217;s an example of how to capture business metrics from a Java application.</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">// initialize metric
Meter meter = GlobalMetricsProvider.getMeter("my-frontend");
DoubleCounter orderValueCounter = meter.doubleCounterBuilder("order_value").build();

public void createOrder(HttpServletRequest request) {

   // create order in the database
   ...
   // increment business metrics for monitoring
   orderValueCounter.add(orderPrice);
}</pre>
</div>
<p>See the <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/metrics/api.md" class="ulink" target="_top">Open Telemetry Metrics API</a>
for more information.</p>
<h5><a id="open-telemetry-elastic-verify"></a>Verify OpenTelemetry metrics data<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h5>
<p>Use <span class="strong strong"><strong>Discover</strong></span> to validate that metrics are successfully reported to Kibana.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Launch Kibana:</p>
<div class="tabs" data-tab-group="spin-up-stack">
  <div role="tablist" aria-label="Configure Server">
    <button role="tab"
            aria-selected="true"
            aria-controls="cloud-tab-open-kib"
            id="cloud-open-kib">
      Elasticsearch Service
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="self-managed-tab-open-kib"
            id="self-managed-open-kib"
            tabindex="-1">
      Self-managed
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="cloud-tab-open-kib"
       aria-labelledby="cloud-open-kib">
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a href="https://cloud.elastic.co/" class="ulink" target="_top">Log in</a> to your Elastic Cloud account.
</li>
<li class="listitem">
Navigate to the Kibana endpoint in your deployment.
</li>
</ol>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="self-managed-tab-open-kib"
       aria-labelledby="self-managed-open-kib"
       hidden="">
<p>Point your browser to <a href="http://localhost:5601" class="ulink" target="_top">http://localhost:5601</a>, replacing
<code class="literal">localhost</code> with the name of the Kibana host.</p>
  </div>
</div>
</li>
<li class="listitem">
Open the main menu, then click <span class="strong strong"><strong>Discover</strong></span>.
</li>
<li class="listitem">
Select <code class="literal">apm-*</code> as your index pattern.
</li>
<li class="listitem">
Filter the data to only show documents with metrics: <code class="literal">processor.name :"metric"</code>
</li>
<li class="listitem">
Narrow your search with a known OpenTelemetry field. For example, if you have an <code class="literal">order_value</code> field, add <code class="literal">order_value: *</code> to your search to return
only OpenTelemetry metrics documents.
</li>
</ol>
</div>
<h5><a id="open-telemetry-elastic-kibana"></a>Visualize in Kibana<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h5>
<p>TSVB within Kibana is the recommended visualization for OpenTelemetry metrics. TSVB is a time series data visualizer that allows you to use the
Elasticsearch aggregation framework&#8217;s full power. With TSVB, you can combine an infinite number of aggregations to display complex data.</p>
<p>In this example eCommerce OpenTelemetry dashboard, there are four visualizations: sales, order count, product cache, and system load. The dashboard provides us with business
KPI metrics, along with performance-related metrics.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="./images/ecommerce-dashboard.png" alt="OpenTelemetry visualizations">
</div>
</div>
<p>Let&#8217;s look at how this dashboard was created, specifically the Sales USD and System load visualizations.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Open the main menu, then click <span class="strong strong"><strong>Dashboard</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create dashboard</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Save</strong></span>, enter the name of your dashboard, and then click <span class="strong strong"><strong>Save</strong></span> again.
</li>
<li class="listitem">
Let’s add a Sales USD visualization. Click <span class="strong strong"><strong>Edit</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create new</strong></span> and then select <span class="strong strong"><strong>TSVB</strong></span>.
</li>
<li class="listitem">
<p>For the label name, enter Sales USD, and then select the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Aggregation: <code class="literal">Counter Rate</code>.
</li>
<li class="listitem">
Field: <code class="literal">order_sum</code>.
</li>
<li class="listitem">
Scale: <code class="literal">auto</code>.
</li>
<li class="listitem">
Group by: <code class="literal">Everything</code>
</li>
</ul>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Save</strong></span>, enter Sales USD as the visualization name, and then click <span class="strong strong"><strong>Save and return</strong></span>.
</li>
<li class="listitem">
Now let&#8217;s create a visualization of load averages on the system. Click <span class="strong strong"><strong>Create new</strong></span>.
</li>
<li class="listitem">
Select <span class="strong strong"><strong>TSVB</strong></span>.
</li>
<li class="listitem">
<p>Select the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Aggregation: <code class="literal">Average</code>.
</li>
<li class="listitem">
Field: <code class="literal">system.cpu.load_average.1m</code>.
</li>
<li class="listitem">
Group by: <code class="literal">Terms</code>.
</li>
<li class="listitem">
By: <code class="literal">host.ip</code>.
</li>
<li class="listitem">
Top: <code class="literal">10</code>.
</li>
<li class="listitem">
Order by: <code class="literal">Doc Count (default)</code>.
</li>
<li class="listitem">
Direction: <code class="literal">Descending</code>.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Save</strong></span>, enter System load per host IP as the visualization name, and then click <span class="strong strong"><strong>Save and return</strong></span>.</p>
<p>Both visualizations are now displayed on your custom dashboard.</p>
</li>
</ol>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>By default, Discover shows data for the last 15 minutes. If you have a time-based index
and no data displays, you might need to increase the time range.</p>
</div>
</div>
<h4><a id="open-telemetry-aws-lambda-elastic"></a>AWS Lambda Support<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h4>
<p>AWS Lambda functions can be instrumented with OpenTelemetry and monitored with Elastic Observability.</p>
<p>To get started, follow the official AWS Distro for OpenTelemetry Lambda <a href="https://aws-otel.github.io/docs/getting-started/lambda" class="ulink" target="_top">getting started documentation</a> and configure the OpenTelemetry Collector to output traces and metrics to your Elastic cluster.</p>
<h5><a id="open-telemetry-aws-lambda-elastic-java"></a>Instrumenting AWS Lambda Java functions<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h5>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For a better startup time, we recommend using SDK-based instrumentation, i.e. manual instrumentation of the code, rather than auto instrumentation.</p>
</div>
</div>
<p>To instrument AWS Lambda Java functions, follow the official <a href="https://aws-otel.github.io/docs/getting-started/lambda/lambda-java" class="ulink" target="_top">AWS Distro for OpenTelemetry Lambda Support For Java</a>.</p>
<p>Noteworthy configuration elements:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>AWS Lambda Java functions should extend <code class="literal">com.amazonaws.services.lambda.runtime.RequestHandler</code>,</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">public class ExampleRequestHandler implements RequestHandler&lt;APIGatewayProxyRequestEvent, APIGatewayProxyResponseEvent&gt; {
    public APIGatewayProxyResponseEvent handleRequest(APIGatewayProxyRequestEvent event, Context context) {
        // add your code ...
    }
}</pre>
</div>
</li>
<li class="listitem">
<p>When using SDK-based instrumentation, frameworks you want to gain visibility of should be manually instrumented</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>The below example instruments <a href="https://square.github.io/okhttp/4.x/okhttp/okhttp3/-ok-http-client/" class="ulink" target="_top">OkHttpClient</a> with the OpenTelemetry instrument <a href="https://search.maven.org/artifact/io.opentelemetry.instrumentation/opentelemetry-okhttp-3.0/1.3.1-alpha/jar" class="ulink" target="_top">io.opentelemetry.instrumentation:opentelemetry-okhttp-3.0:1.3.1-alpha</a></p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">import io.opentelemetry.instrumentation.okhttp.v3_0.OkHttpTracing;

OkHttpClient httpClient = new OkHttpClient.Builder()
        .addInterceptor(OkHttpTracing.create(GlobalOpenTelemetry.get()).newInterceptor())
        .build();</pre>
</div>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>The configuration of the OpenTelemetry Collector, with the definition of the Elastic Observability endpoint, can be added to the root directory of the Lambda binaries (e.g. defined in <code class="literal">src/main/resources/opentelemetry-collector.yaml</code>)</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml"># Copy opentelemetry-collector.yaml in the root directory of the lambda function
# Set an environment variable 'OPENTELEMETRY_COLLECTOR_CONFIG_FILE' to '/var/task/opentelemetry-collector.yaml'
receivers:
  otlp:
    protocols:
      http:
      grpc:

exporters:
  logging:
    loglevel: debug
  otlp/elastic:
    # Elastic APM server https endpoint without the "https://" prefix
    endpoint: "${ELASTIC_OTLP_ENDPOINT}" <a id="CO51-1"></a><i class="conum" data-value="1"></i>
    headers:
      # Elastic APM Server secret token
      Authorization: "Bearer ${ELASTIC_OTLP_TOKEN}" <a id="CO51-2"></a><i class="conum" data-value="1"></i>

service:
  pipelines:
    traces:
      receivers: [otlp]
      exporters: [logging, otlp/elastic]
    metrics:
      receivers: [otlp]
      exporters: [logging, otlp/elastic]
    logs:
      receivers: [otlp]
      exporters: [logging, otlp/elastic]</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO51-1"><i class="conum" data-value="1"></i></a><a href="#CO51-2"></a></p>
</td>
<td align="left" valign="top">
<p>Environment-specific configuration parameters can be conveniently passed in as environment variables: <code class="literal">ELASTIC_OTLP_ENDPOINT</code> and <code class="literal">ELASTIC_OTLP_TOKEN</code></p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>Configure the AWS Lambda Java function with:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://docs.aws.amazon.com/lambda/latest/dg/API_Layer.html" class="ulink" target="_top">Function
layer</a>: The latest <a href="https://aws-otel.github.io/docs/getting-started/lambda/lambda-java" class="ulink" target="_top">AWS
Lambda layer for OpenTelemetry</a> (e.g. <code class="literal">arn:aws:lambda:eu-west-1:901920570463:layer:aws-otel-java-wrapper-ver-1-2-0:1</code>)
</li>
<li class="listitem">
<a href="https://docs.aws.amazon.com/lambda/latest/dg/API_TracingConfig.html" class="ulink" target="_top"><code class="literal">TracingConfig</code> / Mode</a> set to <code class="literal">PassTrough</code>
</li>
<li class="listitem">
<a href="https://docs.aws.amazon.com/lambda/latest/dg/API_FunctionConfiguration.html" class="ulink" target="_top"><code class="literal">FunctionConfiguration</code> / Timeout</a> set to more than 10 seconds to support the longer cold start inherent to the Lambda Java Runtime
</li>
<li class="listitem">
<p>Export the environment variables:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">AWS_LAMBDA_EXEC_WRAPPER="/opt/otel-proxy-handler"</code> for wrapping handlers proxied through the API Gateway (see <a href="https://aws-otel.github.io/docs/getting-started/lambda/lambda-java#enable-auto-instrumentation-for-your-lambda-function" class="ulink" target="_top">here</a>)
</li>
<li class="listitem">
<code class="literal">OTEL_PROPAGATORS="tracecontext, baggage"</code> to override the default setting that also enables X-Ray headers causing interferences between OpenTelemetry and X-Ray
</li>
<li class="listitem">
<code class="literal">OPENTELEMETRY_COLLECTOR_CONFIG_FILE="/var/task/opentelemetry-collector.yaml"</code> to specify the path to your OpenTelemetry Collector configuration
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<h5><a id="open-telemetry-aws-lambda-elastic-java-terraform"></a>Instrumenting AWS Lambda Java functions with Terraform<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h5>
<p>We recommend using an infrastructure as code solution like Terraform or Ansible to manage the configuration of your AWS Lambda functions.</p>
<p>Here is an example of AWS Lambda Java function managed with Terraform and the <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function" class="ulink" target="_top">AWS Provider / Lambda Functions</a>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Sample Terraform code: <a href="https://github.com/cyrille-leclerc/my-serverless-shopping-cart/tree/main/checkout-function/deploy" class="ulink" target="_top">https://github.com/cyrille-leclerc/my-serverless-shopping-cart/tree/main/checkout-function/deploy</a>
</li>
<li class="listitem">
Note that the Terraform code to manage the HTTP API Gateway (<a href="https://github.com/cyrille-leclerc/my-serverless-shopping-cart/tree/main/utils/terraform/api-gateway-proxy" class="ulink" target="_top">here</a>) is copied from the official OpenTelemetry Lambda sample <a href="https://github.com/open-telemetry/opentelemetry-lambda/tree/e72467a085a2a6e57af133032f85ac5b8bbbb8d1/utils" class="ulink" target="_top">here</a>
</li>
</ul>
</div>
<h5><a id="open-telemetry-aws-lambda-elastic-nodejs"></a>Instrumenting AWS Lambda Node.js functions<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h5>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For a better startup time, we recommend using SDK-based instrumentation for manual instrumentation of the code rather than auto instrumentation.</p>
</div>
</div>
<p>To instrument AWS Lambda Node.js functions, see <a href="https://aws-otel.github.io/docs/getting-started/lambda/lambda-js" class="ulink" target="_top">AWS Distro for OpenTelemetry Lambda Support For JavaScript</a>.</p>
<p>The configuration of the OpenTelemetry Collector, with the definition of the Elastic Observability endpoint, can be added to the root directory of the Lambda binaries: <code class="literal">src/main/resources/opentelemetry-collector.yaml</code>.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml"># Copy opentelemetry-collector.yaml in the root directory of the lambda function
# Set an environment variable 'OPENTELEMETRY_COLLECTOR_CONFIG_FILE' to '/var/task/opentelemetry-collector.yaml'
receivers:
  otlp:
    protocols:
      http:
      grpc:

exporters:
  logging:
    loglevel: debug
  otlp/elastic:
    # Elastic APM server https endpoint without the "https://" prefix
    endpoint: "${ELASTIC_OTLP_ENDPOINT}" <a id="CO52-1"></a><i class="conum" data-value="1"></i>
    headers:
      # Elastic APM Server secret token
      Authorization: "Bearer ${ELASTIC_OTLP_TOKEN}" <a id="CO52-2"></a><i class="conum" data-value="1"></i>

service:
  pipelines:
    traces:
      receivers: [otlp]
      exporters: [logging, otlp/elastic]
    metrics:
      receivers: [otlp]
      exporters: [logging, otlp/elastic]
    logs:
      receivers: [otlp]
      exporters: [logging, otlp/elastic]</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO52-1"><i class="conum" data-value="1"></i></a><a href="#CO52-2"></a></p>
</td>
<td align="left" valign="top">
<p>Environment-specific configuration parameters can be conveniently passed in as environment variables: <code class="literal">ELASTIC_OTLP_ENDPOINT</code> and <code class="literal">ELASTIC_OTLP_TOKEN</code></p>
</td>
</tr>
</table>
</div>
<p>Configure the AWS Lambda Node.js function:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://docs.aws.amazon.com/lambda/latest/dg/API_Layer.html" class="ulink" target="_top">Function
layer</a>: The latest <a href="https://aws-otel.github.io/docs/getting-started/lambda/lambda-js" class="ulink" target="_top">AWS
Lambda layer for OpenTelemetry</a>. For example, <code class="literal">arn:aws:lambda:eu-west-1:901920570463:layer:aws-otel-nodejs-ver-0-23-0:1</code>)
</li>
<li class="listitem">
<a href="https://docs.aws.amazon.com/lambda/latest/dg/API_TracingConfig.html" class="ulink" target="_top"><code class="literal">TracingConfig</code> / Mode</a> set to <code class="literal">PassTrough</code>
</li>
<li class="listitem">
<a href="https://docs.aws.amazon.com/lambda/latest/dg/API_FunctionConfiguration.html" class="ulink" target="_top"><code class="literal">FunctionConfiguration</code> / Timeout</a> set to more than 10 seconds to support the cold start of the Lambda JavaScript Runtime
</li>
<li class="listitem">
<p>Export the environment variables:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">AWS_LAMBDA_EXEC_WRAPPER="/opt/otel-handler"</code> for wrapping handlers proxied through the API Gateway. See <a href="https://aws-otel.github.io/docs/getting-started/lambda/lambda-js#enable-auto-instrumentation-for-your-lambda-function" class="ulink" target="_top">enable auto instrumentation for your lambda-function</a>.
</li>
<li class="listitem">
<code class="literal">OTEL_PROPAGATORS="tracecontext"</code> to override the default setting that also enables X-Ray headers causing interferences between OpenTelemetry and X-Ray
</li>
<li class="listitem">
<code class="literal">OPENTELEMETRY_COLLECTOR_CONFIG_FILE="/var/task/opentelemetry-collector.yaml"</code> to specify the path to your OpenTelemetry Collector configuration
</li>
<li class="listitem">
<code class="literal">OTEL_EXPORTER_OTLP_ENDPOINT="http://localhost:55681/v1/traces"</code> this environment variable is required to be set until <a href="https://github.com/open-telemetry/opentelemetry-js/pull/2331" class="ulink" target="_top">PR #2331</a> is merged and released.
</li>
<li class="listitem">
<code class="literal">OTEL_TRACES_SAMPLER="AlwaysOn"</code> define the required sampler strategy if it is not sent from the caller. Note that <code class="literal">Always_on</code> can potentially create a very large amount of data, so in production set the correct sampling configuration, as per the <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/trace/sdk.md#sampling" class="ulink" target="_top">specification</a>.
</li>
</ul>
</div>
</li>
</ul>
</div>
<h5><a id="open-telemetry-aws-lambda-elastic-nodejs-terraform"></a>Instrumenting AWS Lambda Node.js functions with Terraform<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h5>
<p>To manage the configuration of your AWS Lambda functions, we recommend using an infrastructure as code solution like Terraform or Ansible.</p>
<p>Here is an example of AWS Lambda Node.js function managed with Terraform and the <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function" class="ulink" target="_top">AWS Provider / Lambda Functions</a>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://github.com/michaelhyatt/terraform-aws-nodejs-api-worker-otel/tree/v0.23" class="ulink" target="_top">Sample Terraform code</a>
</li>
</ul>
</div>
<h4><a id="elastic-open-telemetry-resource-attributes"></a>Resource attributes<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h4>
<p>A resource attribute is a key/value pair containing information about the entity producing telemetry.
Resource attributes are mapped to Elastic Common Schema (ECS) fields like <code class="literal">service.*</code>, <code class="literal">cloud.*</code>, <code class="literal">process.*</code>, etc.
These fields describe the service and the environment that the service runs in.</p>
<p>The examples below set the Elastic (ECS) <code class="literal">service.environment</code> field for the resource, i.e. service, that is producing trace events.
Note that Elastic maps the OpenTelemetry <code class="literal">deployment.environment</code> field to
the ECS <code class="literal">service.environment</code> field on ingestion.</p>
<p><span class="strong strong"><strong>OpenTelemetry agent</strong></span></p>
<p>Use the <code class="literal">OTEL_RESOURCE_ATTRIBUTES</code> environment variable to pass resource attributes at process invocation.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">export OTEL_RESOURCE_ATTRIBUTES=deployment.environment=production</pre>
</div>
<p><span class="strong strong"><strong>OpenTelemetry collector</strong></span></p>
<p>Use the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/resourceprocessor" class="ulink" target="_top">resource processor</a> to set or apply changes to resource attributes.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">...
processors:
  resource:
    attributes:
    - key: deployment.environment
      action: insert
      value: production
...</pre>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Need to add event attributes instead?
Use attributes&#8212;&#8203;not to be confused with resource attributes&#8212;&#8203;to add data to span, log, or metric events.
Attributes can be added as a part of the OpenTelemetry instrumentation process or with the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/processor/attributesprocessor" class="ulink" target="_top">attributes processor</a>.</p>
</div>
</div>
<h4><a id="elastic-open-telemetry-proxy-apm"></a>Proxy requests to APM Server<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h4>
<p>APM Server supports both the <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md#otlpgrpc" class="ulink" target="_top">(OTLP/gRPC)</a> and <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md#otlphttp" class="ulink" target="_top">(OTLP/HTTP)</a> protocol on the same port as Elastic APM agent requests. For ease of setup, we recommend using OTLP/HTTP when proxying or load balancing requests to the APM Server.</p>
<p>If you use the OTLP/gRPC protocol, requests to the APM Server must use either HTTP/2 over TLS or HTTP/2 Cleartext (H2C). No matter which protocol is used, OTLP/gRPC requests will have the header: <code class="literal">"Content-Type: application/grpc"</code>.</p>
<p>When using a layer 7 (L7) proxy like AWS ALB, requests must be proxied in a way that ensures requests to the APM Server follow the rules outlined above. For example, with ALB you can create rules to select an alternative backend protocol based on the headers of requests coming into ALB. In this example, you&#8217;d select the gRPC protocol when the  <code class="literal">"Content-Type: application/grpc"</code> header exists on a request.</p>
<p>For more information on how to configure an AWS ALB to support gRPC, see this AWS blog post:
<a href="https://aws.amazon.com/blogs/aws/new-application-load-balancer-support-for-end-to-end-http-2-and-grpc/" class="ulink" target="_top">Application Load Balancer Support for End-to-End HTTP/2 and gRPC</a>.</p>
<p>For more information on how APM Server services gRPC requests, see
<a href="https://github.com/elastic/apm-server/blob/main/dev_docs/otel.md#muxing-grpc-and-http11" class="ulink" target="_top">Muxing gRPC and HTTP/1.1</a>.</p>
<h4><a id="elastic-open-telemetry-known-limitations"></a>Limitations<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h4>
<h5><a id="elastic-open-telemetry-traces-limitations"></a>OpenTelemetry traces<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Traces of applications using <code class="literal">messaging</code> semantics might be wrongly displayed as <code class="literal">transactions</code> in the APM UI, while they should be considered <code class="literal">spans</code>. <a href="https://github.com/elastic/apm-server/issues/7001" class="ulink" target="_top">#7001</a>
</li>
<li class="listitem">
Inability to see Stack traces in spans
</li>
<li class="listitem">
Inability in APM views to view the "Time Spent by Span Type" <a href="https://github.com/elastic/apm-server/issues/5747" class="ulink" target="_top">#5747</a>
</li>
<li class="listitem">
Metrics derived from traces (throughput, latency, and errors) are not accurate when traces are sampled before being ingested by Elastic Observability (for example, by an OpenTelemetry Collector or OpenTelemetry APM agent or SDK) <a href="https://github.com/elastic/apm/issues/472" class="ulink" target="_top">#472</a>
</li>
</ul>
</div>
<h5><a id="elastic-open-telemetry-metrics-limitations"></a>OpenTelemetry metrics<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Inability to see host metrics in Elastic Metrics Infrastructure view when using the OpenTelemetry Collector host metrics receiver <a href="https://github.com/elastic/apm-server/issues/5310" class="ulink" target="_top">#5310</a>
</li>
</ul>
</div>
<h5><a id="elastic-open-telemetry-otlp-limitations"></a>OpenTelemetry Line Protocol (OTLP)<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h5>
<p>APM Server supports both the <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md#otlpgrpc" class="ulink" target="_top">(OTLP/gRPC)</a> and <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md#otlphttp" class="ulink" target="_top">(OTLP/HTTP)</a> protocol with ProtoBuf payload.
APM Server does not yet support JSON Encoding for OTLP/HTTP.</p>
<h5><a id="elastic-open-telemetry-collector-exporter"></a>OpenTelemetry Collector exporter for Elastic<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-server/edit/8.4/docs/legacy/guide/opentelemetry-elastic.asciidoc">edit</a></h5>
<p>The <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/elasticexporter#legacy-opentelemetry-collector-exporter-for-elastic" class="ulink" target="_top">OpenTelemetry Collector exporter for Elastic</a>
was deprecated in 7.13 and replaced by the native support of the OpenTelemetry Line Protocol in
Elastic Observability (OTLP). To learn more, see
<a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/elasticexporter#migration" class="ulink" target="_top">migration</a>.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="opentracing.html">« OpenTracing bridge</a>
</span>
<span class="next">
<a href="observability-integrations.html">Observability integrations »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
