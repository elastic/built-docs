<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Manual index lifecycle management | APM Server Reference [6.8] | Elastic</title>
<link rel="home" href="index.html" title="APM Server Reference [6.8]"/>
<link rel="up" href="configuring-howto-apm-server.html" title="Configuring APM Server"/>
<link rel="prev" href="_manually_loading_template_configuration.html" title="Manually loading template configuration"/>
<link rel="next" href="configuration-logging.html" title="Configure logging"/>
<meta name="DC.type" content="Learn/Docs/APM Server/Reference/6.8"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="6.8"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">
<p>
  <strong>NOTE</strong>: You are looking at documentation for an older release. 
  For the latest information, see the 
  <a href="../current/index.html">current release documentation</a>. 
</p>
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">APM Server Reference [6.8]</a></span>
»
<span class="breadcrumb-link"><a href="configuring-howto-apm-server.html">Configuring APM Server</a></span>
»
<span class="breadcrumb-node">Manual index lifecycle management</span>
</div>
<div class="navheader">
<span class="prev">
<a href="_manually_loading_template_configuration.html">« Manually loading template configuration</a>
</span>
<span class="next">
<a href="configuration-logging.html">Configure logging »</a>
</span>
</div>
<div class="chapter xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="manual-ilm-setup"></a>Manual index lifecycle management<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/6.8/docs/ilm-setup.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>
<p>APM Server can take advantage of the index lifecycle management (ILM) capabilities of Elasticsearch.
ILM enables you to automate how you want to manage your indices over time.
You can base actions on factors such as shard size and performance requirements.</p>
<p>The guide below will help you set up a custom ILM policy for span indices.
You can repeat the actions for any other indices.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you&#8217;re migrating from an existing setup,
any indices present before ILM was configured will need to be managed manually.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p><span class="strong strong"><strong>Set up the default index template.</strong></span></p>
<p>If you haven&#8217;t already, you&#8217;ll need to set up the default index template.
This is accomplished by running the <a class="xref" href="command-line-options.html#setup-command" title="setup command"><code class="literal">setup --template</code></a> command.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">./apm-server setup --template</pre>
</div>
<div class="console_widget" data-snippet="snippets/1.console"></div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Create a policy for spans.</strong></span></p>
<p>Index lifecycle management will manage an index based on its defined policy.
Policies only need to be created once, and will persist through version upgrades.
Let&#8217;s create a policy named <code class="literal">apm_span_policy</code>.</p>
<p>This policy defines two rollover criteria: <code class="literal">"max_age": "1d"</code>, and <code class="literal">"max_size": "50gb"</code>.
When one or more of these criteria are met, the policy rolls data over into a new index.
<code class="literal">apm_span_policy</code> also tells the old indexes to delete after <em>10 days</em>.
All of these values can be customized to your specific needs.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ilm/policy/apm_span_policy
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_age": "1d", <a id="CO3-1"></a><i class="conum" data-value="1"></i>
            "max_size": "50gb" <a id="CO3-2"></a><i class="conum" data-value="2"></i>
          }
        }
      },
      "delete": {
        "min_age": "10d", <a id="CO3-3"></a><i class="conum" data-value="3"></i>
        "actions": {
          "delete": {}
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/2.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO3-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Rollover after <em>1 day</em></p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO3-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Rollover after <em>50gb</em></p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO3-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Delete old indexes after <em>10 days</em></p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Set up the ILM index template.</strong></span></p>
<p>To use the index lifecycle management policy created in the previous step,
you need to specify it in the index template used to create the indices.
The following template associates <code class="literal">apm_span_policy</code> with indices created from the <code class="literal">apm-6.8.11-span-ilm</code> template.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Because we&#8217;re utilizing the current stack-version (6.8.11) in this step,
this action will need to be performed as a part of each version upgrade.</p>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _template/apm-6.8.11-span-ilm
{
  "order": 2,
  "index_patterns": ["apm-6.8.11-span-*"], <a id="CO4-1"></a><i class="conum" data-value="1"></i>
  "settings": {
    "index.lifecycle.name": "apm_span_policy", <a id="CO4-2"></a><i class="conum" data-value="2"></i>
    "index.lifecycle.rollover_alias": "apm-6.8.11-span"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/3.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO4-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This template applies to all indices with the prefix <code class="literal">apm-6.8.11-span-</code></p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO4-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Associates <code class="literal">apm_span_policy</code> with all indices created with this template</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Create the index and alias.</strong></span></p>
<p>Now we can create the first index: <code class="literal">apm-6.8.11-span-000001</code>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This action will need to be performed as a part of each version upgrade.</p>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT apm-6.8.11-span-000001 <a id="CO5-1"></a><i class="conum" data-value="1"></i>
{
  "aliases": {
    "apm-6.8.11-span":{
      "is_write_index": true <a id="CO5-2"></a><i class="conum" data-value="2"></i>
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/4.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO5-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The rollover action increments the suffix number for each subsequent index.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO5-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Designates this index as the write index for this alias.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Verify the ILM index template was applied.</strong></span></p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET apm-*-span/_settings</pre>
</div>
<div class="console_widget" data-snippet="snippets/5.console"></div>
<p>The response should be similar to this:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "apm-6.8.11-span-000001" : {
    "settings" : {
      "index" : {
        "lifecycle" : {
          "name" : "apm_span_policy",
          "rollover_alias" : "apm-6.8.11-span"
        },
        "number_of_shards" : "1",
        "provided_name" : "apm-6.8.11-span-000001",
        "creation_date" : "1553024227938",
        "number_of_replicas" : "1",
        "uuid" : "6b5l-H7QTRK95FAodAN-wg",
        "version" : {
          "created" : "7000099"
        }
      }
    }
  }
}</pre>
</div>
<p>You can also verify and adjust your configuration via Kibana&#8217;s <a href="/guide/en/kibana/6.8/index-lifecycle-policies.html" class="ulink" target="_top">management</a>.</p>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Repeat for other indices.</strong></span></p>
<p>Repeat the previous steps for each index that will be using ILM.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Create a policy
</li>
<li class="listitem">
Set up the ILM index template
</li>
<li class="listitem">
Create the index and alias
</li>
<li class="listitem">
Verify the ILM index template was applied
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Modify APM Server&#8217;s configuration.</strong></span></p>
<p>Finally, modify the default index configuration in <a class="xref" href="apm-server-configuration.html" title="Configuration file"><code class="literal">apm-server.yml</code></a>.
Trim off the date template from each index you are setting up ILM for,
so that APM Server is always writing events to the same place.
The name of your modified index configuration must match the <code class="literal">is_write_index</code> alias created previously</p>
<p>It&#8217;s important to note that <code class="literal">apm-server.yml</code> overwrites defaults rather than being merged.
This means you&#8217;ll need to configure all of your indices in the file, even if some are not using ILM.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">output.elasticsearch:
  indices:
    - index: "apm-6.8.11-sourcemap"
      when.contains:
        processor.event: "sourcemap"

    - index: "apm-6.8.11-error"
      when.contains:
        processor.event: "error"

    - index: "apm-6.8.11-transaction"
      when.contains:
        processor.event: "transaction"

    - index: "apm-6.8.11-span"
      when.contains:
        processor.event: "span"

    - index: "apm-6.8.11-metric"
      when.contains:
        processor.event: "metric"

    - index: "apm-6.8.11-onboarding"
      when.contains:
        processor.event: "onboarding"</pre>
</div>
<div class="console_widget" data-snippet="snippets/6.console"></div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Start apm-server.</strong></span></p>
<p>Your ILM configuration should now be up and running!</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Monitor ILM status as events flow:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET apm-*/_ilm/explain?human</pre>
</div>
<div class="console_widget" data-snippet="snippets/7.console"></div>
</li>
<li class="listitem">
<p>Monitor index status:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET _cat/indices/apm*?v</pre>
</div>
<div class="console_widget" data-snippet="snippets/8.console"></div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="_manually_loading_template_configuration.html">« Manually loading template configuration</a>
</span>
<span class="next">
<a href="configuration-logging.html">Configure logging »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Most Popular</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Get Started with Elasticsearch: Video</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Intro to Kibana: Video</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">ELK for Logs & Metrics: Video</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
