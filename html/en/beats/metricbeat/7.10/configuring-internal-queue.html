<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Configure the internal queue | Metricbeat Reference [7.10] | Elastic</title>
<link rel="home" href="index.html" title="Metricbeat Reference [7.10]"/>
<link rel="up" href="configuring-howto-metricbeat.html" title="Configure Metricbeat"/>
<link rel="prev" href="configuration-autodiscover-advanced.html" title="Advanced usage"/>
<link rel="next" href="configuration-logging.html" title="Configure logging"/>
<meta name="DC.type" content="Learn/Docs/Metricbeat/Reference/7.10"/>
<meta name="DC.subject" content="Metricbeat"/>
<meta name="DC.identifier" content="7.10"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Metricbeat Reference [7.10]</a></span>
»
<span class="breadcrumb-link"><a href="configuring-howto-metricbeat.html">Configure Metricbeat</a></span>
»
<span class="breadcrumb-node">Configure the internal queue</span>
</div>
<div class="navheader">
<span class="prev">
<a href="configuration-autodiscover-advanced.html">« Advanced usage</a>
</span>
<span class="next">
<a href="configuration-logging.html">Configure logging »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="configuring-internal-queue"></a>Configure the internal queue<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h2>
</div></div></div>

<p>Metricbeat uses an internal queue to store events before publishing them. The
queue is responsible for buffering and combining events into batches that can
be consumed by the outputs. The outputs will use bulk operations to send a
batch of events in one transaction.</p>
<p>You can configure the type and behavior of the internal queue by setting
options in the <code class="literal">queue</code> section of the <code class="literal">metricbeat.yml</code> config file. Only one
queue type can be configured.</p>
<p>This sample configuration sets the memory queue to buffer up to 4096 events:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">queue.mem:
  events: 4096</pre>
</div>
<h3><a id="configuration-internal-queue-memory"></a>Configure the memory queue<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h3>
<p>The memory queue keeps all events in memory.</p>
<p>If no flush interval and no number of events to flush is configured,
all events published to this queue will be directly consumed by the outputs.
To enforce spooling in the queue, set the <code class="literal">flush.min_events</code> and <code class="literal">flush.timeout</code> options.</p>
<p>By default <code class="literal">flush.min_events</code> is set to 2048 and <code class="literal">flush.timeout</code> is set to 1s.</p>
<p>The output&#8217;s <code class="literal">bulk_max_size</code> setting limits the number of events being processed at once.</p>
<p>The memory queue waits for the output to acknowledge or drop events. If
the queue is full, no new events can be inserted into the memory queue. Only
after the signal from the output will the queue free up space for more events to be accepted.</p>
<p>This sample configuration forwards events to the output if 512 events are
available or the oldest available event has been waiting for 5s in the queue:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">queue.mem:
  events: 4096
  flush.min_events: 512
  flush.timeout: 5s</pre>
</div>
<h4><a id="_configuration_options_14"></a>Configuration options<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h4>
<p>You can specify the following options in the <code class="literal">queue.mem</code> section of the <code class="literal">metricbeat.yml</code> config file:</p>
<h5><a id="_events"></a><code class="literal">events</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h5>
<p>Number of events the queue can store.</p>
<p>The default value is 4096 events.</p>
<h5><a id="_flush_min_events"></a><code class="literal">flush.min_events</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h5>
<p>Minimum number of events required for publishing. If this value is set to 0, the
output can start publishing events without additional waiting times. Otherwise
the output has to wait for more events to become available.</p>
<p>The default value is 2048.</p>
<h5><a id="_flush_timeout"></a><code class="literal">flush.timeout</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h5>
<p>Maximum wait time for <code class="literal">flush.min_events</code> to be fulfilled. If set to 0s, events
will be immediately available for consumption.</p>
<p>The default value is 1s.</p>
<h3><a id="configuration-internal-queue-spool"></a>Configure the file spool queue<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h3>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in beta and is subject to change. The design and code is less mature than official GA features and is being provided as-is with no warranties. Beta features are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>The file spool queue stores all events in an on disk ring buffer. The spool
has a write buffer, which new events are written to. Events written to the
spool are forwarded to the outputs, only after the write buffer has been
flushed successfully.</p>
<p>The spool waits for the output to acknowledge or drop events. If the spool is
full, no new events can be inserted. The spool will block. Space is freed only
after a signal from the output has been received.</p>
<p>On disk, the spool divides a file into pages. The <code class="literal">file.page_size</code> setting
configures the file&#8217;s page size at file creation time. The optimal page size depends
on the effective block size, used by the underlying file system.</p>
<p>This sample configuration enables the spool with all default settings (See
<a class="xref" href="configuring-internal-queue.html#configuration-internal-queue-spool-reference" title="Configuration options">Configuration options</a> for defaults) and the
default file path:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">queue.spool: ~</pre>
</div>
<p>This sample configuration creates a spool of 512MiB, with 16KiB pages. The
write buffer is flushed if 10MiB of contents, or 1024 events have been
written. If the oldest available event has been waiting for 5s in the write
buffer, the buffer will be flushed as well:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">queue.spool:
  file:
    path: "${path.data}/spool.dat"
    size: 512MiB
    page_size: 16KiB
  write:
    buffer_size: 10MiB
    flush.timeout: 5s
    flush.events: 1024</pre>
</div>
<h4><a id="configuration-internal-queue-spool-reference"></a>Configuration options<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h4>
<p>You can specify the following options in the <code class="literal">queue.spool</code> section of the
<code class="literal">metricbeat.yml</code> config file:</p>
<h5><a id="_file_path"></a><code class="literal">file.path</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h5>
<p>The spool file path. The file is created on startup, if it does not exist.</p>
<p>The default value is "${path.data}/spool.dat".</p>
<h5><a id="_file_permissions"></a><code class="literal">file.permissions</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h5>
<p>The file permissions. The permissions are applied when the file is
created. In case the file already exists, the file permissions are compared
with <code class="literal">file.permissions</code>. The spool file is not opened if the actual file
permissions are more permissive then configured.</p>
<p>The default value is 0600.</p>
<h5><a id="_file_size"></a><code class="literal">file.size</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h5>
<p>Spool file size.</p>
<p>The default value is 100 MiB.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The size should be much larger then the expected event sizes
and write buffer size. Otherwise the queue will block, because it has not
enough space.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The file size cannot be changed once the file has been generated. This
limitation will be removed in the future.</p>
</div>
</div>
<h5><a id="_file_page_size"></a><code class="literal">file.page_size</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h5>
<p>The file&#8217;s page size.</p>
<p>The spool file is split into pages of <code class="literal">page_size</code>. All I/O
operations operate on complete pages.</p>
<p>The default value is 4096 (4KiB).</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This setting should match the file system&#8217;s minimum block size. If the
<code class="literal">page_size</code> is not a multiple of the file system&#8217;s block size, the file system
might create additional read operations on writes.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The page size is only set at file creation time. It cannot be changed
afterwards.</p>
</div>
</div>
<h5><a id="_file_prealloc"></a><code class="literal">file.prealloc</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h5>
<p>If <code class="literal">prealloc</code> is set to <code class="literal">true</code>, truncate is used to reserve the space up to
<code class="literal">file.size</code>. This setting is only used when the file is created.</p>
<p>The file will dynamically grow, if <code class="literal">prealloc</code> is set to false. The spool
blocks, if <code class="literal">prealloc</code> is <code class="literal">false</code> and the system is out of disk space.</p>
<p>The default value is <code class="literal">true</code>.</p>
<h5><a id="_write_buffer_size"></a><code class="literal">write.buffer_size</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h5>
<p>The write buffer size. The write buffer is flushed, once the buffer size is exceeded.</p>
<p>Very big events are allowed to be bigger then the configured buffer size. But
the write buffer will be flushed right after the event has been serialized.</p>
<p>The default value is 1MiB.</p>
<h5><a id="_write_codec"></a><code class="literal">write.codec</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h5>
<p>The event encoding used for serialized events. Valid values are <code class="literal">json</code> and <code class="literal">cbor</code>.</p>
<p>The default value is <code class="literal">cbor</code>.</p>
<h5><a id="_write_flush_timeout"></a><code class="literal">write.flush.timeout</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h5>
<p>Maximum wait time of the oldest event in the write buffer. If set to 0, the
write buffer will only be flushed once <code class="literal">write.flush.events</code> or <code class="literal">write.buffer_size</code> is fulfilled.</p>
<p>The default value is 1s.</p>
<h5><a id="_write_flush_events"></a><code class="literal">write.flush.events</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h5>
<p>Number of buffered events. The write buffer is flushed once the limit is reached.</p>
<p>The default value is 16384.</p>
<h5><a id="_read_flush_timeout"></a><code class="literal">read.flush.timeout</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/7.10/libbeat/docs/queueconfig.asciidoc">edit</a></h5>
<p>The spool reader tries to read up to the output&#8217;s <code class="literal">bulk_max_size</code> events at once.</p>
<p>If <code class="literal">read.flush.timeout</code> is set to 0s, all available events are forwarded
immediately to the output.</p>
<p>If <code class="literal">read.flush.timeout</code> is set to a value bigger then 0s, the spool will wait
for more events to be flushed. Events are forwarded to the output if
<code class="literal">bulk_max_size</code> events have been read or the oldest read event has been waiting
for the configured duration.</p>
<p>The default value is 0s.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="configuration-autodiscover-advanced.html">« Advanced usage</a>
</span>
<span class="next">
<a href="configuration-logging.html">Configure logging »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Most Popular</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Get Started with Elasticsearch: Video</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Intro to Kibana: Video</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">ELK for Logs & Metrics: Video</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
