<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Testing
        | Packetbeat Reference [1.1]
      | Elastic
    </title><link rel="home" href="index.html" title="Packetbeat Reference [1.1]" /><link rel="up" href="new-protocol.html" title="Developer Guide: Adding a New Protocol" /><link rel="prev" href="protocol-modules.html" title="Protocol Modules" /><meta name="DC.type" content="Learn/Docs/Packetbeat/Reference/1.1" /><meta name="DC.subject" content="Packetbeat" /><meta name="DC.identifier" content="1.1" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- For third-generation iPad with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <!-- For iPhone with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <!-- For first- and second-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- new ga for staging server -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>
    <!-- new ga for staging server -->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">You are looking at documentation for an older release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Packetbeat Reference
      [1.1]
    </a></span> » <span class="breadcrumb-link"><a href="new-protocol.html">Developer Guide: Adding a New Protocol</a></span> » <span class="breadcrumb-node">Testing</span></div><div class="navheader"><span class="prev"><a href="protocol-modules.html">
              « 
              Protocol Modules</a>
           
        </span><span class="next">
           
          </span></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="testing"></a>Testing<a href="https://github.com/elastic/beats/edit/1.1/packetbeat/docs/new_protocol.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><h3><a id="_unit_tests"></a>Unit Tests<a href="https://github.com/elastic/beats/edit/1.1/packetbeat/docs/new_protocol.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><p>For unit tests, use only the Go standard library
<a class="ulink" href="http://golang.org/pkg/testing/" target="_top">testing</a> package. To make comparing complex
structures less verbose, we use the assert package from the
<a class="ulink" href="https://github.com/stretchr/testify" target="_top">testify</a> library.</p><p>For parser and decoder tests, it’s a good practice to have an array with
test cases containing the inputs and expected outputs. For an example, see the
<code class="literal">Test_splitCookiesHeader</code> unit test in <code class="literal">beats/packetbeat/protos/http/http_test.go</code>
in the <a class="ulink" href="https://github.com/elastic/beats" target="_top">Beats GitHub repository</a>.</p><p>You can also have unit tests that treat the whole module as a black box, calling
its interface functions, then reading the result and checking it. This pattern
is especially useful for checking corner cases related to packet boundaries or
correlation issues. Here is an example from the HTTP module:</p><div class="pre_wrapper lang-go"><pre class="programlisting prettyprint lang-go">func Test_gap_in_body_http1dot0_fin(t *testing.T) {
        if testing.Verbose() { <a id="CO5-1"></a><i class="conum" data-value="1"></i>
                logp.LogInit(logp.LOG_DEBUG, "", false, true, []string{"http",
                        "httpdetailed"})
        }
        http := HttpModForTests()

        data1 := []byte("GET / HTTP/1.0\r\n\r\n") <a id="CO5-2"></a><i class="conum" data-value="2"></i>

        data2 := []byte("HTTP/1.0 200 OK\r\n" +
                "Date: Tue, 14 Aug 2012 22:31:45 GMT\r\n" +
                "Expires: -1\r\n" +
                "Cache-Control: private, max-age=0\r\n" +
                "Content-Type: text/html; charset=UTF-8\r\n" +
                "Content-Encoding: gzip\r\n" +
                "Server: gws\r\n" +
                "X-XSS-Protection: 1; mode=block\r\n" +
                "X-Frame-Options: SAMEORIGIN\r\n" +
                "\r\n" +
                "xxxxxxxxxxxxxxxxxxxx")

        tcptuple := testCreateTCPTuple()
        req := protos.Packet{Payload: data1}
        resp := protos.Packet{Payload: data2}

        private := protos.ProtocolData(new(httpConnectionData))

        private = http.Parse(&amp;req, tcptuple, 0, private) <a id="CO5-3"></a><i class="conum" data-value="3"></i>
        private = http.ReceivedFin(tcptuple, 0, private)

        private = http.Parse(&amp;resp, tcptuple, 1, private)

        logp.Debug("http", "Now sending gap..")

        private, drop := http.GapInStream(tcptuple, 1, 10, private)
        assert.Equal(t, false, drop)

        private = http.ReceivedFin(tcptuple, 1, private)

        trans := expectTransaction(t, http) <a id="CO5-4"></a><i class="conum" data-value="4"></i>
        assert.NotNil(t, trans)
        assert.Equal(t, trans["notes"], []string{"Packet loss while capturing the response"})
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
It’s useful to initialize the logging system in case the <code class="literal">-v</code> flag is passed
to <code class="literal">go test</code>. This makes it easy to get the logs for a failing test while
keeping the output clean on a normal run.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>
Define the data we’ll be using in the test.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-3"><i class="conum" data-value="3"></i></a> </p></td><td valign="top" align="left"><p>
Call the interface functions exported by the module. The <code class="literal">private</code> structure
is passed from one call to the next like the TCP layer would do.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-4"><i class="conum" data-value="4"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">expectTransaction</code> function tries to read from the publisher queue and
causes errors in the test case if there’s no transaction present.
</p></td></tr></table></div><p>To check the coverage of your unit tests, run the <code class="literal">make cover</code> command at the
top of the repository.</p><h3><a id="_system_testing"></a>System Testing<a href="https://github.com/elastic/beats/edit/1.1/packetbeat/docs/new_protocol.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><p>Because the main input to Packetbeat are packets and the main output are JSON
objects, a convenient way of testing its functionality is by providing PCAP
files as input and checking the results in the files created by using the "file"
output plugin.</p><p>This is the approach taken by the tests in the <code class="literal">beats/packetbeat/tests/system</code> directory
in the <a class="ulink" href="https://github.com/elastic/beats" target="_top">Beats GitHub repository</a>. The
tests are written in Python and executed using
<a class="ulink" href="https://nose.readthedocs.org/en/latest/" target="_top">nose</a>. Here is a simple example test
from the MongoDB suite:</p><div class="pre_wrapper lang-python"><pre class="programlisting prettyprint lang-python">    def test_mongodb_find(self):
        """
        Should correctly pass a simple MongoDB find query
        """
        self.render_config_template( <a id="CO6-1"></a><i class="conum" data-value="1"></i>
            mongodb_ports=[27017]
        )
        self.run_packetbeat(pcap="mongodb_find.pcap", <a id="CO6-2"></a><i class="conum" data-value="2"></i>
                            debug_selectors=["mongodb"])

        objs = self.read_output() <a id="CO6-3"></a><i class="conum" data-value="3"></i>
        o = objs[0]
        assert o["type"] == "mongodb"
        assert o["method"] == "find"
        assert o["status"] == "OK"</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
The configuration file for each test run is generated from the template. If
your protocol plugin has options in the configuration file, you should add them
to the template.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">run_packetbeat</code> function receives the PCAP file to run. It looks for
the PCAP file in the <code class="literal">beats/packetbeat/tests/system/pcaps</code> folder. The <code class="literal">debug_selectors</code> array controls
which log lines to be included. You can use <code class="literal">debug_selectors=["*"]</code> to enable
all debug messages.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-3"><i class="conum" data-value="3"></i></a> </p></td><td valign="top" align="left"><p>
After the run, the test reads the output files and checks the result.
</p></td></tr></table></div><div class="tip admon"><div class="icon"><img alt="Tip" src="images/icons/tip.png" /></div><div class="admon_content"><p>To generate the PCAP files, you can use Packetbeat. The <code class="literal">-dump</code> CLI
flag will dump to disk all the packets sniffed from the network that match the
BPF filter.</p></div></div><p>To run the whole test suite, use:</p><div class="pre_wrapper lang-shell"><pre class="programlisting prettyprint lang-shell">$ make test</pre></div><p>This requires you to have Python and virtualenv installed, but it automatically
creates and uses the virtualenv.</p><p>To run an individual test, use the following steps:</p><div class="pre_wrapper lang-shell"><pre class="programlisting prettyprint lang-shell">$ cd tests
$ . env/bin/activate
$ nosetests test_0025_mongodb_basic.py:Test.test_write_errors</pre></div><p>After running the individual test, you can check the logs, the output, and the
configuration file manually by looking into the folder that the <code class="literal">last_run</code>
symlink points to:</p><div class="pre_wrapper lang-shell"><pre class="programlisting prettyprint lang-shell">$ cd last_run
$ ls
output packetbeat.log packetbeat.yml</pre></div></div><div class="navfooter"><span class="prev"><a href="protocol-modules.html">
              « 
              Protocol Modules</a>
           
        </span><span class="next">
           
          </span></div>
                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Getting Started Videos</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Starting Elasticsearch</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Introduction to Kibana</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Starter Guide</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script type="text/javascript" src="/static/js/slick.min.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
