<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Managing authentication for multiple stacks using Elastic Stack configuration policy | Elastic Cloud on Kubernetes [2.11] | Elastic</title>
<meta class="elastic" name="content" content="Managing authentication for multiple stacks using Elastic Stack configuration policy | Elastic Cloud on Kubernetes [2.11]">

<link rel="home" href="index.html" title="Elastic Cloud on Kubernetes [2.11]"/>
<link rel="up" href="k8s-securing-stack.html" title="Secure the Elastic Stack"/>
<link rel="prev" href="k8s-saml-authentication.html" title="SAML Authentication"/>
<link rel="next" href="k8s-accessing-elastic-services.html" title="Access Elastic Stack services"/>
<meta class="elastic" name="product_version" content="2.11"/>
<meta class="elastic" name="product_name" content="ECK"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Kubernetes/Reference/2.11"/>
<meta name="DC.subject" content="ECK"/>
<meta name="DC.identifier" content="2.11"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
A newer version is available. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Cloud on Kubernetes [2.11]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="k8s-orchestrating-elastic-stack-applications.html">Orchestrating Elastic Stack applications</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="k8s-securing-stack.html">Secure the Elastic Stack</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="k8s-saml-authentication.html">« SAML Authentication</a>
</span>
<span class="next">
<a href="k8s-accessing-elastic-services.html">Access Elastic Stack services »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="k8s-auth-config-using-stack-config-policy"></a>Managing authentication for multiple stacks using Elastic Stack configuration policy<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/security/auth-configs-using-stack-config-policy.asciidoc">edit</a></h2>
</div></div></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This requires a valid Enterprise license or Enterprise trial license. Check <a class="xref" href="k8s-licensing.html" title="Manage licenses in ECK">the license documentation</a> for more details about managing licenses.</p>
</div>
</div>
<p>ECK <code class="literal">2.11.0</code> extends the functionality of <a class="xref" href="k8s-stack-config-policy.html" title="Elastic Stack configuration policies">Elastic Stack configuration policies</a> so that it becomes possible to configure Elasticsearch security realms for more than one Elastic stack at once.
The authentication will apply to all Elasticsearch clusters and Kibana instances managed by the Elastic Stack configuration policy.</p>
<p>Examples for configuring some of the authentication methods can be found below:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="k8s-auth-config-using-stack-config-policy.html#k8s-ldap-using-stack-config-policy" title="LDAP using Elastic stack configuration policy">LDAP authentication using Elastic Stack configuration policy</a>
</li>
<li class="listitem">
<a class="xref" href="k8s-auth-config-using-stack-config-policy.html#k8s-oidc-stack-config-policy" title="OIDC using Elastic stack configuration policy">OpenID Connect authentication using Elastic Stack configuration policy</a>
</li>
<li class="listitem">
<a class="xref" href="k8s-auth-config-using-stack-config-policy.html#k8s-jwt-stack-config-policy" title="JWT using Elastic Stack configuration policy">JWT authentication using Elastic Stack configuration policy</a>
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s-ldap-using-stack-config-policy"></a>LDAP using Elastic stack configuration policy<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/security/managing-authentication-for-multiple-stacks/ldap-using-stack-config-policy.asciidoc">edit</a></h3>
</div></div></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This requires a valid Enterprise license or Enterprise trial license. Check <a class="xref" href="k8s-licensing.html" title="Manage licenses in ECK">the license documentation</a> for more details about managing licenses.</p>
</div>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure you check the complete <a href="/guide/en/elasticsearch/reference/current/ldap-realm.html" class="ulink" target="_top">guide to setting up LDAP with Elasticsearch</a>.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="k8s_to_configure_ldap_using_elastic_stack_configuration_policy_with_user_search"></a>To configure LDAP using Elastic Stack configuration policy with user search:<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/security/managing-authentication-for-multiple-stacks/ldap-using-stack-config-policy.asciidoc">edit</a></h4>
</div></div></div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add a realm configuration to the <code class="literal">config</code> field under <code class="literal">elasticsearch</code> in the <code class="literal">xpack.security.authc.realms.ldap</code> namespace. At a minimum, you must specify the URL of the LDAP server and the order of the LDAP realm compared to other configured security realms. You also have to set <code class="literal">user_search.base_dn</code> to the container DN where the users are searched for. Refer to <a href="/guide/en/elasticsearch/reference/current/security-settings.html#ref-ldap-settings" class="ulink" target="_top">LDAP realm settings</a> for all of the options you can set for an LDAP realm.
For example, the following snippet shows an LDAP realm configured with a user search:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">elasticsearch:
  config:
    xpack.security.authc.realms:
      ldap:
        ldap1:
          order: 0
          url: "ldap://openldap.default.svc.cluster.local:1389"
          bind_dn: "cn=admin,dc=example,dc=org"
          user_search:
            base_dn: "dc=example,dc=org"
            filter: "(cn={0})"
          group_search:
            base_dn: "dc=example,dc=org"
          unmapped_groups_as_roles: false</pre>
</div>
</li>
<li class="listitem">
<p>The password for the <code class="literal">bind_dn</code> user should be configured by adding the appropriate <code class="literal">secure_bind_password</code> setting to the Elasticsearch keystore. This can be done using the Elastic Stack configuration policy by following the below steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create a secret that has the <code class="literal">secure_bind_password</code> in the same namespace as the operator</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">  kubectl create secret generic ldap-secret --from-literal=xpack.security.authc.realms.ldap.ldap1.secure_bind_password=&lt;password&gt;</pre>
</div>
</li>
<li class="listitem">
<p>Add the secret name to the <code class="literal">secureSettings</code> field under <code class="literal">elasticsearch</code> in the Elastic Stack configuration policy</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  spec:
    resourceSelector:
      matchLabels:
        env: my-label
    elasticsearch:
      secureSettings:
      - secretName: ldap-secret</pre>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>Map LDAP groups to roles. In the below example, LDAP users get the Elasticsearch <code class="literal">superuser</code> role. <code class="literal">dn: "cn=users,dc=example,dc=org"</code> is the LDAP distinguished name (DN) of the users group.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">securityRoleMappings:
  ldap_role:
    roles: [ "superuser" ]
    rules:
      all:
        - field: { realm.name: "ldap1" }
        - field: { dn: "cn=users,dc=example,dc=org" }
    enabled: true</pre>
</div>
</li>
</ol>
</div>
<p>Simple full example Elastic Stack config policy to configure LDAP realm with user search</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: stackconfigpolicy.k8s.elastic.co/v1alpha1
kind: StackConfigPolicy
metadata:
  name: test-stack-config-policy
spec:
  resourceSelector:
    matchLabels:
      env: my-label
  elasticsearch:
    secureSettings:
    - secretName: ldap-secret
  securityRoleMappings:
    ldap_role:
      roles: [ "superuser" ]
      rules:
        all:
          - field: { realm.name: "ldap1" }
          - field: { dn: "cn=users,dc=example,dc=org" }
      enabled: true
  config:
    xpack.security.authc.realms:
      ldap:
        ldap1:
          order: 0
          url: "ldap://openldap.default.svc.cluster.local:1389"
          bind_dn: "cn=admin,dc=example,dc=org"
          user_search:
            base_dn: "dc=example,dc=org"
            filter: "(cn={0})"
          group_search:
            base_dn: "dc=example,dc=org"
          unmapped_groups_as_roles: false</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="k8s_to_configure_an_ldap_realm_with_user_dn_templates"></a>To configure an LDAP realm with user DN templates:<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/security/managing-authentication-for-multiple-stacks/ldap-using-stack-config-policy.asciidoc">edit</a></h4>
</div></div></div>
<p>Add a realm configuration to <code class="literal">elasticsearch.yml</code> in the xpack.security.authc.realms.ldap namespace. At a minimum, you must specify the url and order of the LDAP server, and specify at least one template with the user_dn_templates option. Check <a href="/guide/en/elasticsearch/reference/current/security-settings.html#ref-ldap-settings" class="ulink" target="_top">LDAP realm settings</a>  for all of the options you can set for an ldap realm.</p>
<p>For example, the following snippet shows an LDAP realm configured with user DN templates:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        ldap:
          ldap1:
            order: 0
            url: "ldaps://ldap.example.com:636"
            user_dn_templates:
              - "cn={0}, ou=users, dc=example, dc=org"
            group_search:
              base_dn: "dc=example,dc=org"
            unmapped_groups_as_roles: false</pre>
</div>
<p>Example Elastic Stack config policy to configure LDAP realm with user DN templates:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: stackconfigpolicy.k8s.elastic.co/v1alpha1
kind: StackConfigPolicy
metadata:
  name: test-stack-config-policy
spec:
  resourceSelector:
    matchLabels:
      env: my-label
  elasticsearch:
  securityRoleMappings:
    ldap_role:
      roles: [ "superuser" ]
      rules:
        all:
          - field: { realm.name: "ldap1" }
          - field: { dn: "*,ou=users,dc=example,dc=org" }
      enabled: true
  config:
    xpack.security.authc.realms:
      ldap:
        ldap1:
          order: 0
          url: "ldaps://ldap.example.com:636"
          user_dn_templates:
            - "cn={0}, ou=users, dc=example, dc=org"
          group_search:
            base_dn: "dc=example,dc=org"
          unmapped_groups_as_roles: false</pre>
</div>
<p>The <code class="literal">bind_dn</code> setting is not used in template mode. All LDAP operations run as the authenticating user. So there is no need of setting up any additional secrets to be stored in the keystore.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s-oidc-stack-config-policy"></a>OIDC using Elastic stack configuration policy<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/security/managing-authentication-for-multiple-stacks/oidc-stack-config-policy.asciidoc">edit</a></h3>
</div></div></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This requires a valid Enterprise license or Enterprise trial license. Check <a class="xref" href="k8s-licensing.html" title="Manage licenses in ECK">the license documentation</a> for more details about managing licenses.</p>
</div>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure you check the complete <a href="/guide/en/elasticsearch/reference/current/oidc-guide.html" class="ulink" target="_top">guide to setting up OpenID Connect with Elasticsearch</a>.</p>
</div>
</div>
<p>Configuring OpenID Connect using Elastic Stack configuration policy</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add OIDC realm to the <code class="literal">elasticsearch.yml</code> file using the <code class="literal">config</code> field under <code class="literal">elasticsearch</code> in the Elastic Stack configuration policy, also enable token service.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Below snippet is an example of using Google as OpenID provider, the values will change depending on the provider being used.</p>
</div>
</div>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">elasticsearch:
    config:
       xpack:
         security:
           authc:
             token.enabled: true
             realms:
               oidc:
                 oidc1:
                   order: 2
                   rp.client_id: "&lt;client id&gt;"
                   rp.response_type: "code"
                   rp.requested_scopes: ["openid", "email"]
                   rp.redirect_uri: "${KIBANA_URL}/api/security/oidc/callback"
                   op.issuer: "https://accounts.google.com"
                   op.authorization_endpoint: "https://accounts.google.com/o/oauth2/v2/auth"
                   op.token_endpoint: "https://oauth2.googleapis.com/token"
                   op.userinfo_endpoint: "https://openidconnect.googleapis.com/v1/userinfo"
                   op.jwkset_path: "https://www.googleapis.com/oauth2/v3/certs"
                   claims.principal: email
                   claim_patterns.principal: "^([^@]+)@elastic\\.co$"</pre>
</div>
</li>
<li class="listitem">
<p>Another piece of configuration of the OpenID Connect realm is to set the Client Secret that was assigned to the Relying Parties (RP) during registration in the OpenID Connect Provider (OP). This is a secure setting and as such is not defined in the realm configuration in <code class="literal">elasticsearch.yml</code> but added to the Elasticsearch keystore. To set this up using Elastic Stack configuration policy, use the following steps.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create a secret in the operator namespace that has the Client Secret</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">kubectl create secret generic oidc-client-secret --from-literal=xpack.security.authc.realms.oidc.oidc1.rp.client_secret=&lt;client_secret&gt;</pre>
</div>
</li>
<li class="listitem">
<p>Add the secret name to the <code class="literal">secureSettings</code> field under <code class="literal">elasticsearch</code></p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">elasticsearch:
    secureSettings:
    - secretName: oidc-client-secret</pre>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>When a user authenticates using OpenID Connect, they are identified to the Elastic Stack, but this does not automatically grant them access to perform any actions or access any data. Your OpenID Connect users cannot do anything until they are assigned roles. Roles can be assigned by adding role mappings to the Elastic Stack configuration policy. The below example is giving a specific user access as a superuser to Elasticsearch, if you want to assign roles to all users authenticating with OIDC, you can remove the username field.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">elasticsearch:
    secureSettings:
    - secretName: oidc-client-secret
    securityRoleMappings:
      oidc_kibana:
        roles: [ "superuser" ]
        rules:
          all:
            - field: { realm.name: "oidc1" }
            - field: { username: "&lt;username&gt;" }
        enabled: true</pre>
</div>
</li>
<li class="listitem">
<p>Update Kibana to use OpenID Connect as the authentication provider:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">kibana:
    config:
      xpack.security.authc.providers:
        oidc.oidc1:
          order: 0
          realm: oidc1
          description: "Log in with GCP"</pre>
</div>
</li>
</ol>
</div>
<p>Example full Elastic Stack configuration policy to configure oidc</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: stackconfigpolicy.k8s.elastic.co/v1alpha1
kind: StackConfigPolicy
metadata:
  name: test-stack-config-policy
spec:
  resourceSelector:
    matchLabels:
      env: my-label
  elasticsearch:
    secureSettings:
    - secretName: oidc-secret
    securityRoleMappings:
      oidc_kibana:
        roles: [ "superuser" ]
        rules:
          all:
            - field: { realm.name: "oidc1" }
            - field: { username: "&lt;username&gt;" }
        enabled: true
    config:
       logger.org.elasticsearch.discovery: DEBUG
       xpack:
         security:
           authc:
             token.enabled: true
             realms:
               oidc:
                 oidc1:
                   order: 2
                   rp.client_id: "&lt;client id&gt;"
                   rp.response_type: "code"
                   rp.requested_scopes: ["openid", "email"]
                   rp.redirect_uri: "${KIBANA_URL}/api/security/oidc/callback" <a id="CO30-1"></a><i class="conum" data-value="1"></i>
                   op.issuer: "https://accounts.google.com"
                   op.authorization_endpoint: "https://accounts.google.com/o/oauth2/v2/auth"
                   op.token_endpoint: "https://oauth2.googleapis.com/token"
                   op.userinfo_endpoint: "https://openidconnect.googleapis.com/v1/userinfo"
                   op.jwkset_path: "https://www.googleapis.com/oauth2/v3/certs"
                   claims.principal: email
                   claim_patterns.principal: "^([^@]+)@elastic\\.co$"
  kibana:
    config:
      xpack.security.authc.providers:
        oidc.oidc1:
          order: 0
          realm: oidc1
          description: "Log in with GCP"
        basic.basic1:
          order: 1</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO30-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The Kibana URL should be an environment variable that should be configured on the Elasticsearch Clusters managed by the Elastic Stack Configuration policy. This can be done by adding an environment variable to the pod template in the Elasticsearch CR.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: quickstart
  namespace: kvalliy
  labels:
    env: my-label
spec:
  version: 8.10.3
  nodeSets:
  - name: default
    count: 1
    config:
      node.store.allow_mmap: false
    podTemplate:
      spec:
        containers:
        - name: elasticsearch
          env:
            - name: KIBANA_URL
              value: "https://kibana.eck-ocp.elastic.dev"</pre>
</div>
</td>
</tr>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The OpenID Connect Provider (OP) should have support to configure multiple Redirect URLs, so that the same <code class="literal">rp.client_id</code> and <code class="literal">client_secret</code> can be used for all the Elasticsearch clusters managed by the Elastic Stack configuration policy.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s-jwt-stack-config-policy"></a>JWT using Elastic Stack configuration policy<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/security/managing-authentication-for-multiple-stacks/jwt-stack-config-policy.asciidoc">edit</a></h3>
</div></div></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This requires a valid Enterprise license or Enterprise trial license. Check <a class="xref" href="k8s-licensing.html" title="Manage licenses in ECK">the license documentation</a> for more details about managing licenses.</p>
</div>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure you check the complete <a href="/guide/en/elasticsearch/reference/current/jwt-auth-realm.html" class="ulink" target="_top">guide to setting up JWT with Elasticsearch</a>.</p>
</div>
</div>
<p>Configuring JWT with Elastic Stack configuration policy</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add your JWT realm to the <code class="literal">elasticsearch.yml</code> file using the <code class="literal">config</code> field under <code class="literal">elasticsearch</code> in the Elastic Stack configuration policy</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">elasticsearch:
    config:
       xpack.security.authc.realms.jwt.jwt1:
         order: -98
         token_type: id_token
         client_authentication.type: shared_secret
         allowed_issuer: "https://es.k8s.elastic.co"
         allowed_audiences: [ "elasticsearch" ]
         allowed_subjects: ["elastic-user"]
         allowed_signature_algorithms: [RS512]
         pkc_jwkset_path: jwks/jwkset.json
         claims.principal: sub</pre>
</div>
</li>
<li class="listitem">
<p>Add the <code class="literal">shared_secret</code> setting that will be used for client authentication to the Elasticsearch keystore.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create a secret in the operator namespace containing the shared secret</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">kubectl create secret generic shared-secret --from-literal=xpack.security.authc.realms.jwt.jwt1.client_authentication.shared_secret=&lt;sharedsecret&gt;</pre>
</div>
</li>
<li class="listitem">
<p>Add the secret name to the <code class="literal">secureSettings</code> field under <code class="literal">elasticsearch</code> in the Elastic Stack configuration policy</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">  elasticsearch:
    secureSettings:
:   - secretName: shared-secret</pre>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>Add an additional volume to the Elasticsearch pods that contain the JSON Web Keys, it should be mounted to the path that is configured for the <code class="literal">xpack.security.authc.realms.jwt.jwt1.pkc_jwkset_path</code> config. The file path is resolved relative to the Elasticsearch configuration directory.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create a secret in the operator namespace that has the jwk set</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">kubectl create secret generic jwks-secret --from-file=jwkset.json</pre>
</div>
</li>
<li class="listitem">
<p>Add the secret name and mountpath to the <code class="literal">secretMounts</code> field under <code class="literal">elasticsearch</code> in the Elastic Stack configuration policy</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">secretMounts:
    - secretName: jwks-secret
      mountPath: "/usr/share/elasticsearch/config/jwks"</pre>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>You can use the <code class="literal">securityRoleMappings</code> field under <code class="literal">elasticsearch</code> in the Elastic Stack configuration policy to define role mappings that determine which roles should be assigned to each user based on their username, groups, or other metadata.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">securityRoleMappings:
  jwt1-user-role:
    roles: [ "superuser" ]
    rules:
      all:
        - field: { realm.name: "jwt1" }
        - field: { username: "jwt-user" }
    enabled: true</pre>
</div>
</li>
</ol>
</div>
<p>The following example demonstrates how an Elastic Stack configuration policy can be used to configure a JWT realm:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: stackconfigpolicy.k8s.elastic.co/v1alpha1
kind: StackConfigPolicy
metadata:
  name: test-stack-config-policy
spec:
  resourceSelector:
    matchLabels:
      env: my-label
  elasticsearch:
    secureSettings:
    - secretName: shared-secret
    securityRoleMappings:
      jwt1-user-role:
        roles: [ "superuser" ]
        rules:
          all:
            - field: { realm.name: "jwt1" }
            - field: { username: "jwt-user" }
        enabled: true
    config:
       xpack.security.authc.realms.jwt.jwt1:
         order: -98
         token_type: id_token
         client_authentication.type: shared_secret
         allowed_issuer: "https://es.k8s.elastic.co"
         allowed_audiences: [ "elasticsearch" ]
         allowed_subjects: ["elastic-user"]
         allowed_signature_algorithms: [RS512]
         pkc_jwkset_path: jwks/jwkset.json
         claims.principal: sub
    secretMounts:
    - secretName: jwks-secret
      mountPath: "/usr/share/elasticsearch/config/jwks"</pre>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="k8s-saml-authentication.html">« SAML Authentication</a>
</span>
<span class="next">
<a href="k8s-accessing-elastic-services.html">Access Elastic Stack services »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs.js"></script>
    <script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
