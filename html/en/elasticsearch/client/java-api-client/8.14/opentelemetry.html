<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Using OpenTelemetry | Elasticsearch Java API Client [8.14] | Elastic</title>
<meta class="elastic" name="content" content="Using OpenTelemetry | Elasticsearch Java API Client [8.14]">

<link rel="home" href="index.html" title="Elasticsearch Java API Client [8.14]"/>
<link rel="up" href="_setup.html" title="Setup"/>
<link rel="prev" href="migrate-hlrc.html" title="Migrating from the High Level Rest Client"/>
<link rel="next" href="api-conventions.html" title="API conventions"/>
<meta class="elastic" name="product_version" content="8.14"/>
<meta class="elastic" name="product_name" content="Clients"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Clients/Java/8.14"/>
<meta name="DC.subject" content="Clients"/>
<meta name="DC.identifier" content="8.14"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Java API Client [8.14]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="_setup.html">Setup</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="migrate-hlrc.html">« Migrating from the High Level Rest Client</a>
</span>
<span class="next">
<a href="api-conventions.html">API conventions »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="opentelemetry"></a>Using OpenTelemetry<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch-java/edit/8.14/docs/setup/open-telemetry.asciidoc">edit</a></h2>
</div></div></div>
<p>You can use <a href="https://opentelemetry.io/" class="ulink" target="_top">OpenTelemetry</a> to monitor the performance and behavior of your Elasticsearch requests through the Java API Client.
The Java API Client comes with built-in OpenTelemetry instrumentation that emits <a href="/guide/en/apm/guide/current/apm-distributed-tracing.html" class="ulink" target="_top">distributed tracing spans</a> by default.
With that, applications <a href="https://opentelemetry.io/docs/instrumentation/java/manual/" class="ulink" target="_top">instrumented with OpenTelemetry</a> or running the <a href="https://opentelemetry.io/docs/instrumentation/java/automatic/" class="ulink" target="_top">OpenTelemetry Java Agent</a> are inherently enriched with additional spans that contain insightful information about the execution of the Elasticsearch requests.</p>
<p>The native instrumentation in the Java API Client follows the <a href="https://opentelemetry.io/docs/specs/semconv/database/elasticsearch/" class="ulink" target="_top">OpenTelemetry Semantic Conventions for Elasticsearch</a>. In particular, the instrumentation in the client covers the logical Elasticsearch request layer, thus, creates a single span per request the service executes against the Java API Client. The following image shows a resulting trace in which three different Elasticsearch requests are executed, i.e. an <code class="literal">index</code>, <code class="literal">get</code> and a search <code class="literal">request</code>:</p>
<div class="imageblock text-center screenshot">
<div class="content">
<img src="images/otel-waterfall-instrumented-without-http.jpg" alt="Distributed trace with Elasticsearch spans">
</div>
</div>
<p>Usually, OpenTelemetry agents and auto-instrumentation modules come with instrumentation support for HTTP-level communication. In this case, in addition to the logical Elasticsearch client requests, spans will be captured for the physical HTTP requests emitted by the client. The following image shows a trace with both, Elasticsearch spans (in blue) and the corresponding HTTP-level spans (in red):</p>
<div class="imageblock text-center screenshot">
<div class="content">
<img src="images/otel-waterfall-instrumented.jpg" alt="Distributed trace with Elasticsearch and HTTP spans">
</div>
</div>
<p>Advanced Java API Client behavior such as nodes round-robin and request retries are revealed through the combination of logical Elasticsearch spans and the physical HTTP spans. The following example shows an <code class="literal">index</code> request in a scenario with two Elasticsearch nodes:</p>
<div class="imageblock text-center screenshot">
<div class="content">
<img src="images/otel-waterfall-retries.jpg" alt="Distributed trace with request retries">
</div>
</div>
<p>The first node is unavailable and results in an HTTP error, while the retry to the second node succeeds. Both HTTP requests are subsumed by the logical Elasticsearch request span (in blue).</p>
<h4><a id="_setup_the_opentelemetry_instrumentation"></a>Setup the OpenTelemetry instrumentation<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch-java/edit/8.14/docs/setup/open-telemetry.asciidoc">edit</a></h4>
<p>When using the <a href="https://opentelemetry.io/docs/instrumentation/java/manual" class="ulink" target="_top">OpenTelemetry Java SDK manually</a> or using the <a href="https://opentelemetry.io/docs/instrumentation/java/automatic/" class="ulink" target="_top">OpenTelemetry Java Agent</a>, the Java API Client&#8217;s OpenTelemetry instrumentation is enabled by default and uses the <em>globally</em> registered OpenTelemetry SDK instance (i.e. <code class="literal">GlobalOpenTelemetry</code>). So, if you don&#8217;t use a custom, local OpenTelemetry SDK instance, there is no explicit setup required to use the Java API Client&#8217;s OpenTelemetry instrumentation.</p>
<h5><a id="_using_a_custom_opentelemetry_instance"></a>Using a custom OpenTelemetry instance<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch-java/edit/8.14/docs/setup/open-telemetry.asciidoc">edit</a></h5>
<p>In case you are using <a href="https://opentelemetry.io/docs/instrumentation/java/manual/#example" class="ulink" target="_top">manual OpenTelemetry instrumentation</a> with a custom OpenTelemetry SDK instance that is <em>not registered globally</em>, you can create the Java API Client using a custom OpenTelemetry instance. The following code snippet shows an example of using a custom OpenTelemetry instance.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">// URL and API key
String serverUrl = "https://localhost:9200";
String apiKey = "VnVhQ2ZHY0JDZGJrU...";

// Create the low-level client
RestClient restClient = RestClient
    .builder(HttpHost.create(serverUrl))
    .setDefaultHeaders(new Header[]{
            new BasicHeader("Authorization", "ApiKey " + apiKey)
    })
    .build();
// Create and configure custom OpenTelemetry instance
OpenTelemetry customOtel = OpenTelemetrySdk.builder().build();

// Create Instrumentation instance using the custom OpenTelemetry instance
// Second constructor argument allows to enable/disable search body capturing
OpenTelemetryForElasticsearch esOtelInstrumentation =
    new OpenTelemetryForElasticsearch(customOtel, false);

// Create the transport with the custom Instrumentation instance
ElasticsearchTransport transport = new RestClientTransport(
    restClient, new JacksonJsonpMapper(), null, esOtelInstrumentation
);

// And create the API client
ElasticsearchClient esClient = new ElasticsearchClient(transport);</pre>
</div>
<h4><a id="_configuring_the_opentelemetry_instrumentation"></a>Configuring the OpenTelemetry instrumentation<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch-java/edit/8.14/docs/setup/open-telemetry.asciidoc">edit</a></h4>
<p>You can configure the OpenTelemetry instrumentation either through Java System properties or Environment Variables.
The following configuration options are available.</p>
<h5><a id="opentelemetry-config-enable"></a>Enable / Disable the OpenTelemetry instrumentation<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch-java/edit/8.14/docs/setup/open-telemetry.asciidoc">edit</a></h5>
<p>With this configuration option you can enable (default) or disable the built-in OpenTelemetry instrumentation.</p>
<p><span class="strong strong"><strong>Default:</strong></span> <code class="literal">true</code></p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Java System Property</p></td>
<td align="left" valign="top"><p><code class="literal">otel.instrumentation.elasticsearch.enabled</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Environment Variable</p></td>
<td align="left" valign="top"><p><code class="literal">OTEL_INSTRUMENTATION_ELASTICSEARCH_ENABLED</code></p></td>
</tr>
</tbody>
</table>
</div>
<h5><a id="_capture_search_request_bodies"></a>Capture search request bodies<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch-java/edit/8.14/docs/setup/open-telemetry.asciidoc">edit</a></h5>
<p>Per default, the built-in OpenTelemetry instrumentation does not capture request bodies because of data privacy reasons. You can use this option to enable capturing of search queries from the the request bodies of Elasticsearch search requests in case you wish to capture this information, regardless.</p>
<p><span class="strong strong"><strong>Default:</strong></span> <code class="literal">false</code></p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Java System Property</p></td>
<td align="left" valign="top"><p><code class="literal">otel.instrumentation.elasticsearch.capture-search-query</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Environment Variable</p></td>
<td align="left" valign="top"><p><code class="literal">OTEL_INSTRUMENTATION_ELASTICSEARCH_CAPTURE_SEARCH_QUERY</code></p></td>
</tr>
</tbody>
</table>
</div>
<h4><a id="_overhead"></a>Overhead<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch-java/edit/8.14/docs/setup/open-telemetry.asciidoc">edit</a></h4>
<p>The OpenTelemetry instrumentation (as any other monitoring approach) may come with a little overhead on CPU, memory and/or latency. The overhead may only occur when the instrumentation is enabled (default) and an OpenTelemetry SDK (or an OpenTelemetry Agent) is active in the target application. In case that either the instrumentation is disabled or no OpenTelemetry SDK (or OpenTelemetry Agent) is active with the target application, there is no monitoring overhead expected when using the client.</p>
<p>Even when the instrumentation is enabled and is being actively used (by an OpenTelemetry SDK), in the vast majority of cases the overhead is very small and negligible. In edge cases in which there is a noticable overhead the <a class="xref" href="opentelemetry.html#opentelemetry-config-enable" title="Enable / Disable the OpenTelemetry instrumentation">instrumentation can be explicitly disabled</a> to eliminate any potential overhead effect of the instrumentation.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="migrate-hlrc.html">« Migrating from the High Level Rest Client</a>
</span>
<span class="next">
<a href="api-conventions.html">API conventions »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs.js"></script>
    <script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
