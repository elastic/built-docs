<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Update By Query API | Java API (deprecated) [7.x] | Elastic</title>
<link rel="home" href="index.html" title="Java API (deprecated) [7.x]"/>
<link rel="up" href="java-docs.html" title="Document APIs"/>
<link rel="prev" href="java-docs-bulk-processor.html" title="Using Bulk Processor"/>
<link rel="next" href="java-docs-reindex.html" title="Reindex API"/>
<meta name="DC.type" content="Learn/Docs/Clients/Java/7.x"/>
<meta name="DC.subject" content="Clients"/>
<meta name="DC.identifier" content="7.x"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Java API (deprecated) [7.x]</a></span>
»
<span class="breadcrumb-link"><a href="java-docs.html">Document APIs</a></span>
»
<span class="breadcrumb-node">Update By Query API</span>
</div>
<div class="navheader">
<span class="prev">
<a href="java-docs-bulk-processor.html">« Using Bulk Processor</a>
</span>
<span class="next">
<a href="java-docs-reindex.html">Reindex API »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="java-docs-update-by-query"></a>Update By Query API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.x/docs/java-api/docs/update-by-query.asciidoc">edit</a></h2>
</div></div></div>
<p>The simplest usage of <code class="literal">updateByQuery</code> updates each
document in an index without changing the source. This usage enables
picking up a new property or another online mapping change.</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source("source_index").abortOnVersionConflict(false);
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p>Calls to the <code class="literal">updateByQuery</code> API start by getting a snapshot of the index, indexing
any documents found using the <code class="literal">internal</code> versioning.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Version conflicts happen when a document changes between the time of the
snapshot and the time the index request processes.</p>
</div>
</div>
<p>When the versions match, <code class="literal">updateByQuery</code> updates the document
and increments the version number.</p>
<p>All update and query failures cause <code class="literal">updateByQuery</code> to abort. These failures are
available from the <code class="literal">BulkByScrollResponse#getIndexingFailures</code> method. Any
successful updates remain and are not rolled back. While the first failure
causes the abort, the response contains all of the failures generated by the
failed bulk request.</p>
<p>To prevent version conflicts from causing <code class="literal">updateByQuery</code> to abort, set
<code class="literal">abortOnVersionConflict(false)</code>. The first example does this because it is
trying to pick up an online mapping change and a version conflict means that
the conflicting document was updated between the start of the <code class="literal">updateByQuery</code>
and the time when it attempted to update the document. This is fine because
that update will have picked up the online mapping update.</p>
<p>The <code class="literal">UpdateByQueryRequestBuilder</code> API supports filtering the updated documents,
limiting the total number of documents to update, and updating documents
with a script:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source("source_index")
    .filter(QueryBuilders.termQuery("level", "awesome"))
    .maxDocs(1000)
    .script(new Script(ScriptType.INLINE,
        "painless",
        "ctx._source.awesome = 'absolutely'",
        Collections.emptyMap()));
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p><code class="literal">UpdateByQueryRequestBuilder</code> also enables direct access to the query used
to select the documents. You can use this access to change the default scroll size or
otherwise modify the request for matching documents.</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source("source_index")
    .source()
    .setSize(500);
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p>You can also combine <code class="literal">maxDocs</code> with sorting to limit the documents updated:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
   new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source("source_index")
    .maxDocs(100)
    .source()
    .addSort("cat", SortOrder.DESC);
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p>In addition to changing the <code class="literal">_source</code> field for the document, you can use a
script to change the action, similar to the Update API:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source("source_index")
    .script(new Script(
        ScriptType.INLINE,
        "painless",
        "if (ctx._source.awesome == 'absolutely') {"
            + "  ctx.op='noop'"
            + "} else if (ctx._source.awesome == 'lame') {"
            + "  ctx.op='delete'"
            + "} else {"
            + "ctx._source.awesome = 'absolutely'}",
        Collections.emptyMap()));
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p>As in the <a class="xref" href="java-docs-update.html" title="Update API">Update API</a>, you can set the value of <code class="literal">ctx.op</code> to change the
operation that executes:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">noop</code>
</span>
</dt>
<dd>
Set <code class="literal">ctx.op = "noop"</code> if your script doesn&#8217;t make any
changes. The <code class="literal">updateByQuery</code> operation then omits that document from the updates.
This behavior increments the <code class="literal">noop</code> counter in the response body.
</dd>
<dt>
<span class="term">
<code class="literal">delete</code>
</span>
</dt>
<dd>
Set <code class="literal">ctx.op = "delete"</code> if your script decides that the document must be
deleted. The deletion will be reported in the <code class="literal">deleted</code> counter in the
response body.
</dd>
</dl>
</div>
<p>Setting <code class="literal">ctx.op</code> to any other value generates an error. Setting any
other field in <code class="literal">ctx</code> generates an error.</p>
<p>This API doesn&#8217;t allow you to move the documents it touches, just modify their
source. This is intentional! We&#8217;ve made no provisions for removing the document
from its original location.</p>
<p>You can also perform these operations on multiple indices at once, similar to the search API:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source("foo", "bar");
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p>If you provide a <code class="literal">routing</code> value then the process copies the routing value to the scroll query,
limiting the process to the shards that match that routing value:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source().setRouting("cat");
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p><code class="literal">updateByQuery</code> can also use the ingest node by
specifying a <code class="literal">pipeline</code> like this:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.setPipeline("hurray");
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<h3><a id="java-docs-update-by-query-task-api"></a>Works with the Task API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.x/docs/java-api/docs/update-by-query.asciidoc">edit</a></h3>
<p>You can fetch the status of all running update-by-query requests with the Task API:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">ListTasksResponse tasksList = client.admin().cluster().prepareListTasks()
    .setActions(UpdateByQueryAction.NAME).setDetailed(true).get();
for (TaskInfo info: tasksList.getTasks()) {
    TaskId taskId = info.getTaskId();
    BulkByScrollTask.Status status =
        (BulkByScrollTask.Status) info.getStatus();
    // do stuff
}</pre>
</div>
<p>With the <code class="literal">TaskId</code> shown above you can look up the task directly:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">GetTaskResponse get = client.admin().cluster().prepareGetTask(taskId).get();</pre>
</div>
<h3><a id="java-docs-update-by-query-cancel-task-api"></a>Works with the Cancel Task API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.x/docs/java-api/docs/update-by-query.asciidoc">edit</a></h3>
<p>Any Update By Query can be canceled using the Task Cancel API:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">// Cancel all update-by-query requests
client.admin().cluster().prepareCancelTasks()
    .setActions(UpdateByQueryAction.NAME).get().getTasks();
// Cancel a specific update-by-query request
client.admin().cluster().prepareCancelTasks()
    .setTaskId(taskId).get().getTasks();</pre>
</div>
<p>Use the <code class="literal">list tasks</code> API to find the value of <code class="literal">taskId</code>.</p>
<p>Cancelling a request is typically a very fast process but can take up to a few seconds.
The task status API continues to list the task until the cancellation is complete.</p>
<h3><a id="java-docs-update-by-query-rethrottle"></a>Rethrottling<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.x/docs/java-api/docs/update-by-query.asciidoc">edit</a></h3>
<p>Use the <code class="literal">_rethrottle</code> API to change the value of <code class="literal">requests_per_second</code> on a running update:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">new RethrottleRequestBuilder(client, RethrottleAction.INSTANCE)
    .setTaskId(taskId)
    .setRequestsPerSecond(2.0f)
    .get();</pre>
</div>
<p>Use the <code class="literal">list tasks</code> API to find the value of <code class="literal">taskId</code>.</p>
<p>As with the <code class="literal">updateByQuery</code> API, the value of <code class="literal">requests_per_second</code>
can be any positive float value to set the level of the throttle, or <code class="literal">Float.POSITIVE_INFINITY</code> to disable throttling.
A value of <code class="literal">requests_per_second</code> that speeds up the process takes
effect immediately. <code class="literal">requests_per_second</code> values that slow the query take effect
after completing the current batch in order to prevent scroll timeouts.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="java-docs-bulk-processor.html">« Using Bulk Processor</a>
</span>
<span class="next">
<a href="java-docs-reindex.html">Reindex API »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Most Popular</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Get Started with Elasticsearch: Video</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Intro to Kibana: Video</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">ELK for Logs & Metrics: Video</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
