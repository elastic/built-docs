<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Unrecoverable exceptions | Elasticsearch.Net and NEST: the .NET clients [master] | Elastic</title>
<link rel="home" href="index.html" title="Elasticsearch.Net and NEST: the .NET clients [master]"/>
<link rel="up" href="thrown-exceptions.html" title="Exceptions"/>
<link rel="prev" href="unexpected-exceptions.html" title="Unexpected exceptions"/>
<link rel="next" href="transports-and-pipelines.html" title="Transports and pipelines"/>
<meta name="DC.type" content="Learn/Docs/Clients/.Net/master"/>
<meta name="DC.subject" content="Clients"/>
<meta name="DC.identifier" content="master"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Elasticsearch.Net and NEST:  the .NET clients [master]</a></span>
»
<span class="breadcrumb-link"><a href="api-conventions.html">API Conventions</a></span>
»
<span class="breadcrumb-link"><a href="thrown-exceptions.html">Exceptions</a></span>
»
<span class="breadcrumb-node">Unrecoverable exceptions</span>
</div>
<div class="navheader">
<span class="prev">
<a href="unexpected-exceptions.html">« Unexpected exceptions</a>
</span>
<span class="next">
<a href="transports-and-pipelines.html">Transports and pipelines »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="unrecoverable-exceptions"></a>Unrecoverable exceptions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-net/edit/master/docs/client-concepts/connection-pooling/exceptions/unrecoverable-exceptions.asciidoc">edit</a></h2>
</div></div></div>
<p>Unrecoverable exceptions are <em>expected</em> exceptions that are grounds to exit the client pipeline immediately.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>What do we mean by <em>expected</em> exceptions? Aren&#8217;t all exceptions <em>exceptional</em>?</p>
<p>Well, there a some exceptions that can be thrown in the course of a request
that <em>may</em> be expected, some of which can be retried on another node in the cluster, and some that cannot.
For example, an exception thrown when pinging a node throws an exception,
but this is an exception that the client expects can happen,
and can handle by trying a ping on another node. On the contrary, a bad authentication response from a node will throw an
exception, and the client understands that an exception under these circumstances should be handled by not retrying,
but by exiting the pipeline.</p>
</div>
</div>
<p>By default, the client won&#8217;t throw on any <code class="literal">TransportException</code> but instead return an invalid response
that can be detected by checking the <code class="literal">.IsValid</code> property on the response. You can change this behaviour with
by using <code class="literal">ThrowExceptions()</code> on <a class="xref" href="configuration-options.html" title="Configuration options"><code class="literal">ConnectionSettings</code></a>.</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">var failures = Enum.GetValues(typeof(PipelineFailure)).Cast&lt;PipelineFailure&gt;();
foreach (var failure in failures)
{
    switch (failure)
    {
        /** The followinig pipeline failures are recoverable and will be retried */
        case PipelineFailure.PingFailure:
        case PipelineFailure.BadRequest:
        case PipelineFailure.BadResponse:
            var recoverable = new PipelineException(failure);
            recoverable.Recoverable.Should().BeTrue(failure.GetStringValue());
            break;

        /** The followinig pipeline failures are NOT recoverable and won't be retried */
        case PipelineFailure.BadAuthentication:
        case PipelineFailure.SniffFailure:
        case PipelineFailure.CouldNotStartSniffOnStartup:
        case PipelineFailure.MaxTimeoutReached:
        case PipelineFailure.MaxRetriesReached:
        case PipelineFailure.Unexpected:
        case PipelineFailure.NoNodesAttempted:
            var unrecoverable = new PipelineException(failure);
            unrecoverable.Recoverable.Should().BeFalse(failure.GetStringValue());
            break;
        default:
            throw new ArgumentOutOfRangeException(failure.GetStringValue());
    }
}</pre>
</div>
<p>As an example, let&#8217;s use our Virtual cluster test framework to set up a 10 node cluster
that always succeeds when pinged but fails with a 401 response when making client calls</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">var audit = new Auditor(() =&gt; VirtualClusterWith
    .Nodes(10)
    .Ping(r =&gt; r.SucceedAlways()) <a id="CO5-1"></a><i class="conum" data-value="1"></i>
    .ClientCalls(r =&gt; r.FailAlways(401)) <a id="CO5-2"></a><i class="conum" data-value="2"></i>
    .StaticConnectionPool()
    .AllDefaults()
);</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO5-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Always succeed on ping</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO5-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>&#8230;&#8203;but always fail on calls with a 401 Bad Authentication response</p>
</td>
</tr>
</table>
</div>
<p>Now, let&#8217;s make a client call. We&#8217;ll see that the first audit event is a successful ping
followed by a bad response as a result of the 401 bad authentication response</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">audit = await audit.TraceElasticsearchException(
    new ClientCall {
        { PingSuccess, 9200 }, <a id="CO6-1"></a><i class="conum" data-value="1"></i>
        { BadResponse, 9200 }, <a id="CO6-2"></a><i class="conum" data-value="2"></i>
    },
    exception =&gt;
    {
        exception.FailureReason
            .Should().Be(PipelineFailure.BadAuthentication); <a id="CO6-3"></a><i class="conum" data-value="3"></i>
    }
);</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO6-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>First call results in a successful ping</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO6-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Second call results in a bad response</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO6-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The reason for the bad response is Bad Authentication</p>
</td>
</tr>
</table>
</div>
<p>When a bad authentication response occurs, the client attempts to deserialize the response body returned;</p>
<p>In some setups you might be running behind a proxy and you might need to prevent the client from trying to deserialize
bad json. In the following example an HTML response is return but with an application/json content type. If the proxy is not
under your control you would need to be able to fix this in the client. Here we make the client aware that 401 responses
should never be deserialized by calling <code class="literal">SkipDeserializationForStatusCodes()</code> on <code class="literal">ConnectionSettings</code>.</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">var audit = new Auditor(() =&gt; VirtualClusterWith
    .Nodes(10)
    .Ping(r =&gt; r.SucceedAlways())
    .ClientCalls(r =&gt; r.FailAlways(401).ReturnByteResponse(HtmlNginx401Response, "application/json")) <a id="CO7-1"></a><i class="conum" data-value="1"></i>
    .StaticConnectionPool()
    .Settings(s =&gt; s.SkipDeserializationForStatusCodes(401))
);

audit = await audit.TraceElasticsearchException(
    new ClientCall {
        { PingSuccess, 9200 },
        { BadResponse, 9201 },
    },
    (e) =&gt;
    {
        e.FailureReason.Should().Be(PipelineFailure.BadAuthentication);
        e.Response.HttpStatusCode.Should().Be(401);
        e.Response.ResponseBodyInBytes.Should().BeNull(); <a id="CO7-2"></a><i class="conum" data-value="2"></i>
    }
);</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO7-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Always return a 401 bad response with a HTML response on client calls</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO7-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Assert that the response body bytes are null</p>
</td>
</tr>
</table>
</div>
<p>Now in this example, by turning on <code class="literal">DisableDirectStreaming()</code> on <code class="literal">ConnectionSettings</code>, we see the same behaviour exhibited
as before, but this time however, the response body bytes are captured in the response and can be inspected.
Also note that in this example the 401 returns the correct mime type for html so the client wont try to deserialize to json and
we no longer need to set <code class="literal">SkipDeserializationForStatusCodes()</code></p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">var audit = new Auditor(() =&gt; VirtualClusterWith
    .Nodes(10)
    .Ping(r =&gt; r.SucceedAlways())
    .ClientCalls(r =&gt; r.FailAlways(401).ReturnByteResponse(HtmlNginx401Response, "text/html"))
    .StaticConnectionPool()
    .Settings(s =&gt; s.DisableDirectStreaming())
);

audit = await audit.TraceElasticsearchException(
    new ClientCall {
        { PingSuccess, 9200 },
        { BadResponse, 9200 },
    },
    (e) =&gt;
    {
        e.FailureReason.Should().Be(PipelineFailure.BadAuthentication);
        e.Response.HttpStatusCode.Should().Be(401);
        e.Response.ResponseBodyInBytes.Should().NotBeNull(); <a id="CO8-1"></a><i class="conum" data-value="1"></i>
        var responseString = Encoding.UTF8.GetString(e.Response.ResponseBodyInBytes);
        responseString.Should().Contain("nginx/"); <a id="CO8-2"></a><i class="conum" data-value="2"></i>
        e.DebugInformation.Should().Contain("nginx/");
    }
);</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO8-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Response bytes are set on the response</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO8-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Assert that the response contains <code class="literal">"nginx/"</code></p>
</td>
</tr>
</table>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="unexpected-exceptions.html">« Unexpected exceptions</a>
</span>
<span class="next">
<a href="transports-and-pipelines.html">Transports and pipelines »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Most Popular</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Get Started with Elasticsearch: Video</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Intro to Kibana: Video</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">ELK for Logs & Metrics: Video</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
