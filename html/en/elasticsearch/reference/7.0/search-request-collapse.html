<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Field Collapsing | Elasticsearch Reference [7.0] | Elastic</title>
<link rel="home" href="index.html" title="Elasticsearch Reference [7.0]"/>
<link rel="up" href="search-request-body.html" title="Request Body Search"/>
<link rel="prev" href="search-request-explain.html" title="Explain"/>
<link rel="next" href="search-request-from-size.html" title="From / Size"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/7.0"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="7.0"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference [7.0]</a></span>
»
<span class="breadcrumb-link"><a href="search.html">Search APIs</a></span>
»
<span class="breadcrumb-link"><a href="search-request-body.html">Request Body Search</a></span>
»
<span class="breadcrumb-node">Field Collapsing</span>
</div>
<div class="navheader">
<span class="prev">
<a href="search-request-explain.html">« Explain</a>
</span>
<span class="next">
<a href="search-request-from-size.html">From / Size »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-request-collapse"></a>Field Collapsing<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/7.0/docs/reference/search/request/collapse.asciidoc">edit</a></h2>
</div></div></div>
<p>Allows to collapse search results based on field values.
The collapsing is done by selecting only the top sorted document per collapse key.
For instance the query below retrieves the best tweet for each user and sorts them by number of likes.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /twitter/_search
{
    "query": {
        "match": {
            "message": "elasticsearch"
        }
    },
    "collapse" : {
        "field" : "user" <a id="CO25-1"></a><i class="conum" data-value="1"></i>
    },
    "sort": ["likes"], <a id="CO25-2"></a><i class="conum" data-value="2"></i>
    "from": 10 <a id="CO25-3"></a><i class="conum" data-value="3"></i>
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/194.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO25-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>collapse the result set using the "user" field</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO25-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>sort the top docs by number of likes</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO25-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>define the offset of the first collapsed result</p>
</td>
</tr>
</table>
</div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>The total number of hits in the response indicates the number of matching documents without collapsing.
The total number of distinct group is unknown.</p>
</div>
</div>
<p>The field used for collapsing must be a single valued <a class="xref" href="keyword.html" title="Keyword datatype"><code class="literal">keyword</code></a> or <a class="xref" href="number.html" title="Numeric datatypes"><code class="literal">numeric</code></a> field with <a class="xref" href="doc-values.html" title="doc_values"><code class="literal">doc_values</code></a> activated</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The collapsing is applied to the top hits only and does not affect aggregations.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_expand_collapse_results"></a>Expand collapse results<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/7.0/docs/reference/search/request/collapse.asciidoc">edit</a></h3>
</div></div></div>
<p>It is also possible to expand each collapsed top hits with the <code class="literal">inner_hits</code> option.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /twitter/_search
{
    "query": {
        "match": {
            "message": "elasticsearch"
        }
    },
    "collapse" : {
        "field" : "user", <a id="CO26-1"></a><i class="conum" data-value="1"></i>
        "inner_hits": {
            "name": "last_tweets", <a id="CO26-2"></a><i class="conum" data-value="2"></i>
            "size": 5, <a id="CO26-3"></a><i class="conum" data-value="3"></i>
            "sort": [{ "date": "asc" }] <a id="CO26-4"></a><i class="conum" data-value="4"></i>
        },
        "max_concurrent_group_searches": 4 <a id="CO26-5"></a><i class="conum" data-value="5"></i>
    },
    "sort": ["likes"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/195.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO26-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>collapse the result set using the "user" field</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO26-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>the name used for the inner hit section in the response</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO26-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>the number of inner_hits to retrieve per collapse key</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO26-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>how to sort the document inside each group</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO26-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>the number of concurrent requests allowed to retrieve the inner_hits` per group</p>
</td>
</tr>
</table>
</div>
<p>See <a class="xref" href="search-request-inner-hits.html" title="Inner hits">inner hits</a> for the complete list of supported options and the format of the response.</p>
<p>It is also possible to request multiple <code class="literal">inner_hits</code> for each collapsed hit.  This can be useful when you want to get
multiple representations of the collapsed hits.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /twitter/_search
{
    "query": {
        "match": {
            "message": "elasticsearch"
        }
    },
    "collapse" : {
        "field" : "user", <a id="CO27-1"></a><i class="conum" data-value="1"></i>
        "inner_hits": [
            {
                "name": "most_liked",  <a id="CO27-2"></a><i class="conum" data-value="2"></i>
                "size": 3,
                "sort": ["likes"]
            },
            {
                "name": "most_recent", <a id="CO27-3"></a><i class="conum" data-value="3"></i>
                "size": 3,
                "sort": [{ "date": "asc" }]
            }
        ]
    },
    "sort": ["likes"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/196.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO27-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>collapse the result set using the "user" field</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO27-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>return the three most liked tweets for the user</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO27-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>return the three most recent tweets for the user</p>
</td>
</tr>
</table>
</div>
<p>The expansion of the group is done by sending an additional query for each
<code class="literal">inner_hit</code> request for each collapsed hit returned in the response.  This can significantly slow things down
if you have too many groups and/or <code class="literal">inner_hit</code> requests.</p>
<p>The <code class="literal">max_concurrent_group_searches</code> request parameter can be used to control
the maximum number of concurrent searches allowed in this phase.
The default is based on the number of data nodes and the default search thread pool size.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p><code class="literal">collapse</code> cannot be used in conjunction with <a class="xref" href="search-request-scroll.html" title="Scroll">scroll</a>,
<a class="xref" href="search-request-rescore.html" title="Rescoring">rescore</a> or <a class="xref" href="search-request-search-after.html" title="Search After">search after</a>.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_second_level_of_collapsing"></a>Second level of collapsing<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/7.0/docs/reference/search/request/collapse.asciidoc">edit</a></h3>
</div></div></div>
<p>Second level of collapsing is also supported and is applied to <code class="literal">inner_hits</code>.
For example, the following request finds the top scored tweets for
each country, and within each country finds the top scored tweets
for each user.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">GET /twitter/_search
{
    "query": {
        "match": {
            "message": "elasticsearch"
        }
    },
    "collapse" : {
        "field" : "country",
        "inner_hits" : {
            "name": "by_location",
            "collapse" : {"field" : "user"},
            "size": 3
        }
    }
}</pre>
</div>
<p>Response:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
    ...
    "hits": [
        {
            "_index": "twitter",
            "_type": "_doc",
            "_id": "9",
            "_score": ...,
            "_source": {...},
            "fields": {"country": ["UK"]},
            "inner_hits":{
                "by_location": {
                    "hits": {
                       ...,
                       "hits": [
                          {
                            ...
                            "fields": {"user" : ["user124"]}
                          },
                          {
                            ...
                            "fields": {"user" : ["user589"]}
                          },
                          {
                            ...
                             "fields": {"user" : ["user001"]}
                          }
                       ]
                    }
                 }
            }
        },
        {
            "_index": "twitter",
            "_type": "_doc",
            "_id": "1",
            "_score": ..,
            "_source": {...},
            "fields": {"country": ["Canada"]},
            "inner_hits":{
                "by_location": {
                    "hits": {
                       ...,
                       "hits": [
                          {
                            ...
                            "fields": {"user" : ["user444"]}
                          },
                          {
                            ...
                            "fields": {"user" : ["user1111"]}
                          },
                          {
                            ...
                             "fields": {"user" : ["user999"]}
                          }
                       ]
                    }
                 }
            }

        },
        ....
    ]
}</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Second level of collapsing doesn&#8217;t allow <code class="literal">inner_hits</code>.</p>
</div>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="search-request-explain.html">« Explain</a>
</span>
<span class="next">
<a href="search-request-from-size.html">From / Size »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Most Popular</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Get Started with Elasticsearch: Video</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Intro to Kibana: Video</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">ELK for Logs & Metrics: Video</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
