<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Common SAML issues | Elasticsearch Guide [7.2] | Elastic</title>
<link rel="home" href="index.html" title="Elasticsearch Guide [7.2]"/>
<link rel="up" href="security-troubleshooting.html" title="Troubleshooting security"/>
<link rel="prev" href="trb-security-kerberos.html" title="Common Kerberos exceptions"/>
<link rel="next" href="trb-security-internalserver.html" title="Internal Server Error in Kibana"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/7.2"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="7.2"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [7.2]</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="secure-cluster.html">Secure a cluster</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="security-troubleshooting.html">Troubleshooting security</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="trb-security-kerberos.html">« Common Kerberos exceptions</a>
</span>
<span class="next">
<a href="trb-security-internalserver.html">Internal Server Error in Kibana »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="trb-security-saml"></a>Common SAML issues<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/7.2/x-pack/docs/en/security/troubleshooting.asciidoc">edit</a></h2>
</div></div></div>
<p>Some of the common SAML problems are shown below with tips on how to resolve
these issues.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Authentication in Kibana fails and the following error is printed in the Elasticsearch
logs:</p>
<pre class="literallayout">Cannot find any matching realm for [SamlPrepareAuthenticationRequest{realmName=null,
assertionConsumerServiceURL=https://my.kibana.url/api/security/v1/saml}]</pre>

<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>Elasticsearch, Kibana and your Identity Provider need all have the same view on what the
Assertion Consumer Service URL of the SAML Service Provider is.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Elasticsearch discovers this via the <code class="literal">sp.acs</code> setting in your Elasticsearch SAML realm configuration
</li>
<li class="listitem">
<p>Kibana constructs this value using the <code class="literal">server.host</code> and <code class="literal">server.port</code> in
<code class="literal">kibana.yml</code>. For instance:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">server.host: kibanaserver.org
server.port: 3456</pre>
</div>
<p>These settings would mean that Kibana would construct the Assertion Consumer
Service URL as <code class="literal">https://kibanaserver.org:3456/api/security/v1/saml</code>. However,
if for example, Kibana is behind a reverse proxy and you have configured the
following  <code class="literal">xpack.security.public.*</code> settings:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">xpack.security.public:
  protocol: https
  hostname: kibana.proxy.com
  port: 8080</pre>
</div>
<p>These settings would instruct Kibana to construct the Assertion Consumer Service
URL as <code class="literal">https://kibana.proxy.com:8080/api/security/v1/saml</code></p>
</li>
<li class="listitem">
The SAML Identity Provider is either explicitly configured by the IdP
administrator or consumes the SAML metadata that are generated by Elasticsearch and as
such contain the same value for the
as the one
that is configured in the the <code class="literal">sp.acs</code> setting in the Elasticsearch SAML realm
configuration.
</li>
</ol>
</div>
<p>The error encountered here indicates that the Assertion Consumer Service URL
that Kibana has constructed via one of the aforementioned ways
(<code class="literal">https://my.kibana.url/api/security/v1/saml</code>) is not the one that Elasticsearch is
configured with. Note that these two URLs are compared as case-sensitive strings
and not as canonicalized URLs.</p>
<p>Often, this can be resolved by changing the <code class="literal">sp.acs</code> URL in <code class="literal">elasticearch.yml</code>
to match the value that Kibana has constructed. Note however, that the SAML IdP
configuration needs to also be adjusted to reflect this change.</p>
<p>Alternatively, if you think Kibana is using the wrong value for the Assertion
Consumer Service URL, you will need to change the configuration in <code class="literal">kibana.yml</code>
by adjusting either the <code class="literal">server.host</code> and <code class="literal">server.port</code> to change the URL Kibana
listens to or the <code class="literal">xpack.security.public.*</code> settings to make Kibana aware about
its correct public URL.</p>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Authentication in Kibana fails and the following error is printed in the
Elasticsearch logs:</p>
<pre class="literallayout">Authentication to realm saml1 failed - Provided SAML response is not valid for realm
saml/saml1 (Caused by ElasticsearchSecurityException[Conditions [https://some-url-here...]
do not match required audience [https://my.kibana.url]])</pre>

<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>We received a SAML response that is addressed to another SAML Service Provider.
This usually means that the configured SAML Service Provider Entity ID in
<code class="literal">elasticsearch.yml</code> (<code class="literal">sp.entity_id</code>) does not match what has been configured as
the SAML Service Provider Entity ID in the SAML Identity Provider documentation.</p>
<p>To resolve this issue, ensure that both the saml realm in Elasticsearch and the IdP are
configured with the same string for the SAML Entity ID of the Service Provider.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>These strings are compared as case-sensitive strings and not as
canonicalized URLs even when the values are URL-like. Be mindful of trailing
slashes, port numbers, etc.</p>
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Authentication in Kibana fails and the following error is printed in the
Elasticsearch logs:</p>
<pre class="literallayout">Cannot find metadata for entity [your:entity.id] in [metadata.xml]</pre>

<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>We could not find the metadata for the SAML Entity ID <code class="literal">your:entity.id</code> in the
configured metadata file (<code class="literal">metadata.xml</code>).</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Ensure that the <code class="literal">metadata.xml</code> file you are using is indeed the one provided
by your SAML Identity Provider.
</li>
<li class="listitem">
Ensure that the <code class="literal">metadata.xml</code> file contains one &lt;EntityDescriptor&gt; element
as follows: <code class="literal">&lt;EntityDescriptor ID="0597c9aa-e69b-46e7-a1c6-636c7b8a8070" entityID="https://saml.example.com/f174199a-a96e-4201-88f1-0d57a610c522/" ...</code>
where the value of the <code class="literal">entityID</code> attribute is the same as the value of the
<code class="literal">idp.entity_id</code> that you have set in your SAML realm configuration in
<code class="literal">elasticsearch.yml</code>.
</li>
<li class="listitem">
Note that these are also compared as case-sensitive strings and not as
canonicalized URLs even when the values are URL-like.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Authentication in Kibana fails and the following error is printed in the Elasticsearch
logs:</p>
<pre class="literallayout">unable to authenticate user [&lt;unauthenticated-saml-user&gt;]
for action [cluster:admin/xpack/security/saml/authenticate]</pre>

<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>This error indicates that Elasticsearch failed to process the incoming SAML
authentication message. Since the message can&#8217;t be processed, Elasticsearch is not aware
of who the to-be authenticated user is and the <code class="literal">&lt;unauthenticated-saml-user&gt;</code>
placeholder is used instead. To diagnose the <em>actual</em> problem, you must check
the Elasticsearch logs for further details.</p>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Authentication in Kibana fails and the following error is printed in the
Elasticsearch logs:</p>
<pre class="literallayout">Authentication to realm my-saml-realm failed -
Provided SAML response is not valid for realm saml/my-saml-realm
(Caused by ElasticsearchSecurityException[SAML Response is not a 'success' response:
 The SAML IdP did not grant the request. It indicated that the Elastic Stack side sent
 something invalid (urn:oasis:names:tc:SAML:2.0:status:Requester). Specific status code which might
 indicate what the issue is: [urn:oasis:names:tc:SAML:2.0:status:InvalidNameIDPolicy]]
)</pre>

<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>This means that the SAML Identity Provider failed to authenticate the user and
sent a SAML Response to the Service Provider (Elastic Stack) indicating this failure.
The message will convey whether the SAML Identity Provider thinks that the problem
is with the Service Provider (Elastic Stack) or with the Identity Provider itself and
the specific status code that follows is extremely useful as it usually indicates
the underlying issue. The list of specific error codes is defined in the
<a href="https://docs.oasis-open.org/security/saml/v2.0/saml-core-2.0-os.pdf" class="ulink" target="_top">SAML 2.0 Core specification - Section 3.2.2.2</a>
and the most commonly encountered ones are:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<code class="literal">urn:oasis:names:tc:SAML:2.0:status:AuthnFailed</code>: The SAML Identity Provider failed to
authenticate the user. There is not much to troubleshoot on the Elastic Stack side for this status, the logs of
the SAML Identity Provider will hopefully offer much more information.
</li>
<li class="listitem">
<code class="literal">urn:oasis:names:tc:SAML:2.0:status:InvalidNameIDPolicy</code>: The SAML Identity Provider cannot support
releasing a NameID with the requested format. When creating SAML Authentication Requests, Elasticsearch sets
the NameIDPolicy element of the Authentication request with the appropriate value. This is controlled
by the <a class="xref" href="security-settings.html#ref-saml-settings" title="SAML realm settings"><code class="literal">nameid_format</code></a> configuration parameter in
<code class="literal">elasticsearch.yml</code>, which if not set defaults to <code class="literal">urn:oasis:names:tc:SAML:2.0:nameid-format:transient</code>.
 This instructs the Identity Provider to return a NameID with that specific format in the SAML Response. If
the SAML Identity Provider cannot grant that request, for example because it is configured to release a
NameID format with <code class="literal">urn:oasis:names:tc:SAML:2.0:nameid-format:persistent</code> format instead, it returns this error
indicating an invalid NameID policy. This issue can be resolved by adjusting <code class="literal">nameid_format</code> to match the format
the SAML Identity Provider can return or by setting it to <code class="literal">urn:oasis:names:tc:SAML:2.0:nameid-format:unspecified</code>
so that the Identity Provider is allowed to return any format it wants.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Authentication in Kibana fails and the following error is printed in the
Elasticsearch logs:</p>
<pre class="literallayout">The XML Signature of this SAML message cannot be validated. Please verify that the saml
realm uses the correct SAMLmetadata file/URL for this Identity Provider</pre>

<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>This means that Elasticsearch failed to validate the digital signature of the SAML
message that the Identity Provider sent. Elasticsearch uses the public key of the
Identity Provider that is included in the SAML metadata, in order to validate
the signature that the IdP has created using its corresponding private key.
Failure to do so, can have a number of causes:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
As the error message indicates, the most common cause is that the wrong
metadata file is used and as such the public key it contains doesn&#8217;t correspond
to the private key the Identity Provider uses.
</li>
<li class="listitem">
The configuration of the Identity Provider has changed or the key has been
rotated and the metadata file that Elasticsearch is using has not been updated.
</li>
<li class="listitem">
The SAML Response has been altered in transit and the signature cannot be
validated even though the correct key is used.
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The private keys and public keys and self-signed X.509 certificates that
are used in SAML for digital signatures as described above have no relation to
the keys and certificates that are used for TLS either on the transport or the
http layer. A failure such as the one described above has nothing to do with
your <code class="literal">xpack.ssl</code> related configuration.</p>
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Users are unable to login with a local username and password in Kibana because
SAML is enabled.</p>
<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>If you want your users to be able to use local credentials to authenticate to
Kibana in addition to using the SAML realm for Single Sign-On, you must enable
the <code class="literal">basic</code> <code class="literal">authProvider</code> in Kibana. The process is documented in the
<a class="xref" href="saml-kibana.html#saml-kibana-basic" title="Supporting SAML and basic authentication in Kibana">SAML Guide</a></p>
</li>
</ol>
</div>
<p><span class="strong strong"><strong>Logging:</strong></span></p>
<p>Very detailed trace logging can be enabled specifically for the SAML realm by
setting the following transient setting:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">PUT /_cluster/settings
{
  "transient": {
    "logger.org.elasticsearch.xpack.security.authc.saml": "trace"
  }
}</pre>
</div>
<p>Alternatively, you can add the following lines to the end of the
<code class="literal">log4j2.properties</code> configuration file in the <code class="literal">ES_PATH_CONF</code>:</p>
<div class="pre_wrapper lang-properties">
<pre class="programlisting prettyprint lang-properties">logger.saml.name = org.elasticsearch.xpack.security.authc.saml
logger.saml.level = TRACE</pre>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="trb-security-kerberos.html">« Common Kerberos exceptions</a>
</span>
<span class="next">
<a href="trb-security-internalserver.html">Internal Server Error in Kibana »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
