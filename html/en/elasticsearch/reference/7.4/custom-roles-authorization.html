<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Customizing roles and authorization | Elasticsearch Guide [7.4] | Elastic</title>
<link rel="home" href="index.html" title="Elasticsearch Guide [7.4]"/>
<link rel="up" href="authorization.html" title="User authorization"/>
<link rel="prev" href="configuring-authorization-delegation.html" title="Configuring authorization delegation"/>
<link rel="next" href="enable-audit-logging.html" title="Enabling audit logging"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/7.4"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="7.4"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [7.4]</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="secure-cluster.html">Secure a cluster</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="authorization.html">User authorization</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="configuring-authorization-delegation.html">« Configuring authorization delegation</a>
</span>
<span class="next">
<a href="enable-audit-logging.html">Enabling audit logging »</a>
</span>
</div>
<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="custom-roles-authorization"></a>Customizing roles and authorization<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/7.4/x-pack/docs/en/security/authorization/custom-authorization.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>
<p>If you need to retrieve user roles from a system not supported out-of-the-box
or if the authorization system that is provided by the Elasticsearch security features
does not meet your needs, a SPI loaded security extension can be implemented to
customize role retrieval and/or the authorization system. The SPI loaded
security extension is part of an ordinary elasticsearch plugin.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="implementing-custom-roles-provider"></a>Implementing a custom roles provider<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/7.4/x-pack/docs/en/security/authorization/custom-authorization.asciidoc">edit</a></h3>
</div></div></div>
<p>To create a custom roles provider:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Implement the interface <code class="literal">BiConsumer&lt;Set&lt;String&gt;, ActionListener&lt;Set&lt;RoleDescriptor&gt;&gt;&gt;</code>.
That is to say, the implementation consists of one method that takes a set of strings,
which are the role names to resolve, and an ActionListener, on which the set of resolved
role descriptors are passed on as the response.
</li>
<li class="listitem">
The custom roles provider implementation must take special care to not block on any I/O
operations.  It is the responsibility of the implementation to ensure asynchronous behavior
and non-blocking calls, which is made easier by the fact that the <code class="literal">ActionListener</code> is
provided on which to send the response when the roles have been resolved and the response
is ready.
</li>
</ol>
</div>
<p>To package your custom roles provider as a plugin:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Implement an extension class for your roles provider that implements
<code class="literal">org.elasticsearch.xpack.core.security.SecurityExtension</code>. There you need to
override one or more of the following methods:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">@Override
public List&lt;BiConsumer&lt;Set&lt;String&gt;, ActionListener&lt;Set&lt;RoleDescriptor&gt;&gt;&gt;&gt;
getRolesProviders(Settings settings, ResourceWatcherService resourceWatcherService) {
    ...
}</pre>
</div>
<p>The <code class="literal">getRolesProviders</code> method is used to provide a list of custom roles providers that
will be used to resolve role names, if the role names could not be resolved by the reserved
roles or native roles stores.   The list should be returned in the order that the custom role
providers should be invoked to resolve roles.  For example, if <code class="literal">getRolesProviders</code> returns two
instances of roles providers, and both of them are able to resolve role <code class="literal">A</code>, then the resolved
role descriptor that will be used for role <code class="literal">A</code> will be the one resolved by the first roles
provider in the list.</p>
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="implementing-authorization-engine"></a>Implementing an authorization engine<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/7.4/x-pack/docs/en/security/authorization/custom-authorization.asciidoc">edit</a></h3>
</div></div></div>
<p>To create an authorization engine, you need to:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Implement the <code class="literal">org.elasticsearch.xpack.core.security.authz.AuthorizationEngine</code>
interface in a class with the desired authorization behavior.
</li>
<li class="listitem">
Implement the <code class="literal">org.elasticsearch.xpack.core.security.authz.Authorization.AuthorizationInfo</code>
interface in a class that contains the necessary information to authorize the request.
</li>
</ol>
</div>
<p>To package your authorization engine as a plugin:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Implement an extension class for your authorization engine that extends
<code class="literal">org.elasticsearch.xpack.core.security.SecurityExtension</code>. There you need to
override the following method:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">@Override
public AuthorizationEngine getAuthorizationEngine(Settings settings) {
    ...
}</pre>
</div>
<p>The <code class="literal">getAuthorizationEngine</code> method is used to provide the authorization engine
implementation.</p>
</li>
</ol>
</div>
<p>Sample code that illustrates the structure and implementation of a custom
authorization engine is provided in the
<a href="https://github.com/elastic/elasticsearch/tree/master/plugins/examples/security-authorization-engine" class="ulink" target="_top">elasticsearch</a>
repository on GitHub. You can use this code as a starting point for creating your
own authorization engine.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="packing-extension-plugin"></a>Implement an elasticsearch plugin<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/7.4/x-pack/docs/en/security/authorization/custom-authorization.asciidoc">edit</a></h3>
</div></div></div>
<p>In order to register the security extension for your custom roles provider or
authorization engine, you need to also implement an elasticsearch plugin that
contains the extension:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Implement a plugin class that extends <code class="literal">org.elasticsearch.plugins.Plugin</code>
</li>
<li class="listitem">
Create a build configuration file for the plugin; Gradle is our recommendation.
</li>
<li class="listitem">
Create a <code class="literal">plugin-descriptor.properties</code> file as described in
<a href="/guide/en/elasticsearch/plugins/7.4/plugin-authors.html" class="ulink" target="_top">Help for plugin authors</a>.
</li>
<li class="listitem">
Create a <code class="literal">META-INF/services/org.elasticsearch.xpack.core.security.SecurityExtension</code> descriptor file for the
extension that contains the fully qualified class name of your <code class="literal">org.elasticsearch.xpack.core.security.SecurityExtension</code> implementation
</li>
<li class="listitem">
Bundle all in a single zip file.
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="using-security-extension"></a>Using the security extension<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/7.4/x-pack/docs/en/security/authorization/custom-authorization.asciidoc">edit</a></h3>
</div></div></div>
<p>To use a security extension:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Install the plugin with the extension on each node in the cluster. You run
<code class="literal">bin/elasticsearch-plugin</code> with the <code class="literal">install</code> sub-command and specify the URL
pointing to the zip file that contains the extension. For example:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">bin/elasticsearch-plugin install file:///&lt;path&gt;/my-extension-plugin-1.0.zip</pre>
</div>
</li>
<li class="listitem">
<p>Add any configuration parameters for implementations in the extension to the
<code class="literal">elasticsearch.yml</code> file.  The settings are not namespaced and you have access to any
settings when constructing the extensions, although it is recommended to have a
namespacing convention for extensions to keep your <code class="literal">elasticsearch.yml</code>
configuration easy to understand.</p>
<p>For example, if you have a custom roles provider that
resolves roles from reading a blob in an S3 bucket on AWS, then you would specify settings
in <code class="literal">elasticsearch.yml</code> such as:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">custom_roles_provider.s3_roles_provider.bucket: roles
custom_roles_provider.s3_roles_provider.region: us-east-1
custom_roles_provider.s3_roles_provider.secret_key: xxx
custom_roles_provider.s3_roles_provider.access_key: xxx</pre>
</div>
<p>These settings are passed as arguments to the methods in the <code class="literal">SecurityExtension</code> interface.</p>
</li>
<li class="listitem">
Restart Elasticsearch.
</li>
</ol>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="configuring-authorization-delegation.html">« Configuring authorization delegation</a>
</span>
<span class="next">
<a href="enable-audit-logging.html">Enabling audit logging »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
