<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>JWT authentication | Elasticsearch Guide [8.8] | Elastic</title>
<meta class="elastic" name="content" content="JWT authentication | Elasticsearch Guide [8.8]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.8]"/>
<link rel="up" href="setting-up-authentication.html" title="User authentication"/>
<link rel="prev" href="kerberos-realm.html" title="Kerberos authentication"/>
<link rel="next" href="custom-realms.html" title="Integrating with other authentication systems"/>
<meta class="elastic" name="product_version" content="8.8"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.8"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.8"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.8]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="secure-cluster.html">Secure the Elastic Stack</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="setting-up-authentication.html">User authentication</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="kerberos-realm.html">« Kerberos authentication</a>
</span>
<span class="next">
<a href="custom-realms.html">Integrating with other authentication systems »</a>
</span>
</div>
<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="jwt-auth-realm"></a>JWT authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h2>
</div></div></div>
<p>Elasticsearch can be configured to trust JSON Web Tokens (JWTs) issued from an external service
as bearer tokens for authentication.</p>
<p>When a JWT realm is used to authenticate with Elasticsearch, a distinction is made
between the <em>client</em> that is connecting to Elasticsearch, and the <em>user</em> on whose behalf
the request should run. The JWT authenticates the user, and a separate credential
authenticates the client.</p>
<p>The JWT realm supports two token types, <code class="literal">id_token</code> (the default) and <code class="literal">access_token</code>.
They are designed to work for the following two scenarios, respectively:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<code class="literal">id_token</code> - An application authenticates and identifies a user with an authentication flow,
e.g. OpenID Connect (OIDC), and then accesses Elasticsearch on behalf of the authenticated user using
a JSON Web Token (JWT) conforming to OIDC ID Token specification.
</li>
<li class="listitem">
<code class="literal">access_token</code> - An application accesses Elasticsearch using its own identity, encoded as a JWT,
e.g. The application authenticates itself to a central identity platform using an
OAuth2 Client Credentials Flow and then uses the resulting JWT-based access token to connect to Elasticsearch.
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>A single JWT realm can only work with a single token type. To handle both token types,
you must configure at least two JWT realms. You should choose the token type carefully based
on the use case because it impacts on how validations are performed.</p>
</div>
</div>
<p>The JWT realm validates the incoming JWT based on its configured token type.
JSON Web Tokens (JWT) of both types must contain the following 5 pieces of information.
While ID Tokens, based on the OIDC specification, have strict rules for what claims should provide these information,
access tokens allow some claims to be configurable.</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p></p></td>
<td align="center" colspan="2" valign="top"><p><span class="strong strong"><strong>Claims</strong></span></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>Information</strong></span></p></td>
<td align="left" valign="top"><p>ID Token</p></td>
<td align="left" valign="top"><p>Access Token</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Issuer</p></td>
<td align="left" valign="top"><p><code class="literal">iss</code></p></td>
<td align="left" valign="top"><p><code class="literal">iss</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Subject</p></td>
<td align="left" valign="top"><p><code class="literal">sub</code></p></td>
<td align="left" valign="top"><p>Defaults to <code class="literal">sub</code>, but can fall back to another claim if <code class="literal">sub</code> does not exist</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Audiences</p></td>
<td align="left" valign="top"><p><code class="literal">aud</code></p></td>
<td align="left" valign="top"><p>Defaults to <code class="literal">aud</code>, but can fall back to another claim if <code class="literal">aud</code> does not exist</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Issue Time</p></td>
<td align="left" valign="top"><p><code class="literal">iat</code></p></td>
<td align="left" valign="top"><p><code class="literal">iat</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Expiration Time</p></td>
<td align="left" valign="top"><p><code class="literal">exp</code></p></td>
<td align="left" valign="top"><p><code class="literal">exp</code></p></td>
</tr>
</tbody>
</table>
</div>
<p>In addition, Elasticsearch also validates <code class="literal">nbf</code> and <code class="literal">auth_time</code> claims for ID Tokens if these claims are present.
But these claims are ignored for access tokens.</p>
<p>Overall, the access token type has more relaxed validation rules and is suitable for more generic JWTs,
including self-signed ones.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="jwt-realm-oidc"></a>ID Tokens from OIDC workflows<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>JWT authentication in Elasticsearch is derived from OIDC user workflows, where different
tokens can be issued by an OIDC Provider (OP), including ID Tokens.
ID Tokens from an OIDC provider are well-defined JSON Web Tokens (JWT) and should be always compatible with
a JWT realm of the <code class="literal">id_token</code> token type. The subject claim of an ID token represents the end-user.
This means that ID tokens will generally have many allowed subjects.
Therefore, a JWT realm of <code class="literal">id_token</code> token type does <em>not</em> mandate the <code class="literal">allowed_subjects</code> validation.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Because JWTs are obtained external to Elasticsearch, you can define a custom workflow
instead of using the OIDC workflow. However, the JWT format must still be JSON
Web Signature (JWS). The JWS header and JWS signature are validated using OIDC
ID token validation rules.</p>
</div>
</div>
<p>Elasticsearch supports a separate <a class="xref" href="oidc-realm.html" title="OpenID Connect authentication">OpenID Connect realm</a>. It is preferred for any
use case where Elasticsearch can act as an OIDC RP. The OIDC realm is the only supported
way to enable OIDC authentication in Kibana.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Users authenticating with a JWT realm can optionally impersonate another user
with the <a class="xref" href="run-as-privilege.html" title="Submitting requests on behalf of other users"><code class="literal">run_as</code></a> feature. See also <a class="xref" href="jwt-auth-realm.html#jwt-realm-runas" title="Applying the run_as privilege to JWT realm users">Applying the <code class="literal">run_as</code> privilege to JWT realm users</a>.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="jwt-realm-oauth2"></a>Access Tokens<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>A common method to obtain access tokens is with the OAuth2 Client Credentials Flow.
A typical usage of this flow is for an application to get a credential for itself.
This is the use case that the <code class="literal">access_token</code> token type is designed for.
It is likely that this application also obtains ID Tokens for its end-users.
To prevent end-user ID Tokens being used to authenticate with the JWT realm configured
for the application, we mandate <code class="literal">allowed_subjects</code> validation when a JWT realm
has token type <code class="literal">access_token</code>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Not every access token is formatted as a JSON Web Token (JWT).
For it to be compatible with the JWT realm, it must at least use the JWT format and satisfies
relevant requirements in the above table.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="jwt-realm-configuration"></a>Configure Elasticsearch to use a JWT realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>To use JWT authentication, create the realm in the <code class="literal">elasticsearch.yml</code> file
to configure it within the Elasticsearch authentication chain.</p>
<p>The JWT realm has a few mandatory settings, plus optional settings that are
described in <a class="xref" href="security-settings.html#ref-jwt-settings" title="JWT realm settings">JWT realm settings</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Client authentication is enabled by default for the JWT realms. Disabling
client authentication is possible, but strongly discouraged.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add your JWT realm to the <code class="literal">elasticsearch.yml</code> file. The following example
includes the most common settings, which are not intended for every use case:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.jwt.jwt1:
  order: 3
  token_type: id_token
  client_authentication.type: shared_secret
  allowed_issuer: "https://issuer.example.com/jwt/"
  allowed_audiences: [ "8fb85eba-979c-496c-8ae2-a57fde3f12d0" ]
  allowed_signature_algorithms: [RS256,HS256]
  pkc_jwkset_path: jwt/jwkset.json
  claims.principal: sub</pre>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">order</code>
</span>
</dt>
<dd>
Specifies a realm <code class="literal">order</code> of <code class="literal">3</code>, which indicates the order in which the
configured realm is checked when authenticating a user. Realms are consulted in
ascending order, where the realm with the lowest order value is consulted first.
</dd>
<dt>
<span class="term">
<code class="literal">token_type</code>
</span>
</dt>
<dd>
Instructs the realm to treat and validate incoming JWTs as ID Tokens (<code class="literal">id_token</code>).
</dd>
<dt>
<span class="term">
<code class="literal">client_authentication.type</code>
</span>
</dt>
<dd>
Specifies the client authentication type as <code class="literal">shared_secret</code>, which means that
the client is authenticated using an HTTP request header that must match a
pre-configured secret value. The client must provide this shared secret with
every request in the <code class="literal">ES-Client-Authentication</code> header. The header value must be a
case-sensitive match to the realm&#8217;s <code class="literal">client_authentication.shared_secret</code>.
</dd>
<dt>
<span class="term">
<code class="literal">allowed_issuer</code>
</span>
</dt>
<dd>
Sets a verifiable identifier for your JWT issuer. This value is typically a
URL, UUID, or some other case-sensitive string value.
</dd>
<dt>
<span class="term">
<code class="literal">allowed_audiences</code>
</span>
</dt>
<dd>
Specifies a list of JWT audiences that the realm will allow.
These values are typically URLs, UUIDs, or other case-sensitive string values.
</dd>
<dt>
<span class="term">
<code class="literal">allowed_signature_algorithms</code>
</span>
</dt>
<dd>
Indicates that Elasticsearch should use the <code class="literal">RS256</code> or <code class="literal">HS256</code> signature algorithms to
verify the signature of the JWT from the JWT issuer.
</dd>
<dt>
<span class="term">
<code class="literal">pkc_jwkset_path</code>
</span>
</dt>
<dd>
The file path to a JSON Web Key Set (JWKS) containing the public key material
that the JWT realm uses to verify JWT signatures. If a path is provided,
then it is resolved relative to the Elasticsearch configuration directory. In Elastic Cloud,
use an absolute path starting with <code class="literal">/app/config/</code>.
</dd>
<dt>
<span class="term">
<code class="literal">claims.principal</code>
</span>
</dt>
<dd>
The name of the JWT claim that contains the user&#8217;s principal (username).
</dd>
</dl>
</div>
<p>The following is an example snippet for configure a JWT realm for handling
access tokens:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.jwt.jwt2:
  order: 4
  token_type: access_token
  client_authentication.type: shared_secret
  allowed_issuer: "https://issuer.example.com/jwt/"
  allowed_subjects: [ "123456-compute@developer.example.com" ]
  allowed_audiences: [ "elasticsearch" ]
  required_claims:
    token_use: access
    version: ["1.0", "2.0"]
  allowed_signature_algorithms: [RS256,HS256]
  pkc_jwkset_path: "https://idp-42.example.com/.well-known/configuration"
  fallback_claims.sub: client_id
  fallback_claims.aud: scope
  claims.principal: sub</pre>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">token_type</code>
</span>
</dt>
<dd>
Instructs the realm to treat and validate incoming JWTs as access tokens (<code class="literal">access_token</code>).
</dd>
<dt>
<span class="term">
<code class="literal">allowed_subjects</code>
</span>
</dt>
<dd>
Specifies a list of JWT subjects that the realm will allow.
These values are typically URLs, UUIDs, or other case-sensitive string values.
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This setting is mandatory for when <code class="literal">token_type</code> is <code class="literal">access_token</code>.</p>
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">required_claims</code>
</span>
</dt>
<dd>
Specifies a list of key/value pairs for additional verifications to be performed
against a JWT. The values are either a string or an array of strings.
</dd>
<dt>
<span class="term">
<code class="literal">fallback_claims.sub</code>
</span>
</dt>
<dd>
The name of the JWT claim to extract the subject information if the <code class="literal">sub</code> claim does not exist.
This setting is only available when <code class="literal">token_type</code> is <code class="literal">access_token</code>.
The fallback is applied everywhere the <code class="literal">sub</code> claim is used.
In the above snippet, it means the <code class="literal">claims.principal</code> will also fallback to <code class="literal">client_id</code>
if <code class="literal">sub</code> does not exist.
</dd>
<dt>
<span class="term">
<code class="literal">fallback_claims.aud</code>
</span>
</dt>
<dd>
The name of the JWT claim to extract the audiences information if the <code class="literal">aud</code> claim does not exist.
This setting is only available when <code class="literal">token_type</code> is <code class="literal">access_token</code>.
The fallback is applied everywhere the <code class="literal">aud</code> claim is used.
</dd>
</dl>
</div>
</li>
<li class="listitem">
<p>After defining settings, use the
<a href="/guide/en/elasticsearch/reference/8.8/elasticsearch-keystore.html" class="ulink" target="_top"><code class="literal">elasticsearch-keystore</code></a> tool to store
values for secure settings in the Elasticsearch keystore.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Store the <code class="literal">shared_secret</code> value for <code class="literal">client_authentication.type</code>:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">bin/elasticsearch-keystore add xpack.security.authc.realms.jwt.jwt1.client_authentication.shared_secret</pre>
</div>
</li>
<li class="listitem">
<p>Store the HMAC keys for <code class="literal">allowed_signature_algorithms</code>, which use the HMAC
SHA-256 algorithm <code class="literal">HS256</code> in the example:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">bin/elasticsearch-keystore add-file xpack.security.authc.realms.jwt.jwt1.hmac_jwkset &lt;path&gt; <a id="CO563-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO563-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Path to a JWKS, which is a resource for a set of JSON-encoded secret keys.
The file can be removed after you load the contents into the Elasticsearch keystore.</p>
</td>
</tr>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Using the JWKS is preferred. However, you can add an HMAC key in string format
using the following command. This format is compatible with HMAC UTF-8 keys, but
only supports a single key with no attributes. You can only use one HMAC format
(either <code class="literal">hmac_jwkset</code> or <code class="literal">hmac_key</code>) simultaneously.</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">bin/elasticsearch-keystore add xpack.security.authc.realms.jwt.jwt1.hmac_key</pre>
</div>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="jwt-validation"></a>JWT encoding and validation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>JWTs can be parsed into three pieces:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
Header
</span>
</dt>
<dd>
Provides information about how to validate the token.
</dd>
<dt>
<span class="term">
Claims
</span>
</dt>
<dd>
Contains data about the calling user or application.
</dd>
<dt>
<span class="term">
Signature
</span>
</dt>
<dd>
The data that&#8217;s used to validate the token.
</dd>
</dl>
</div>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">Header: {"typ":"JWT","alg":"HS256"}
Claims: {"aud":"aud8","sub":"security_test_user","iss":"iss8","exp":4070908800,"iat":946684800}
Signature: UnnFmsoFKfNmKMsVoDQmKI_3-j95PCaKdgqqau3jPMY</pre>
</div>
<p>This example illustrates a partial decoding of a JWT. The validity period is
from 2000 to 2099 (inclusive), as defined by the issue time (<code class="literal">iat</code>) and
expiration time (<code class="literal">exp</code>). JWTs typically have a validity period shorter than
100 years, such as 1-2 hours or 1-7 days, not an entire human life.</p>
<p>The signature in this example is deterministic because the header, claims, and
HMAC key are fixed. JWTs typically have a <code class="literal">nonce</code> claim to make the signature
non-deterministic. The supported JWT encoding is JSON Web Signature (JWS), and
the JWS <code class="literal">Header</code> and <code class="literal">Signature</code> are validated using OpenID Connect ID Token
validation rules. Some validation is customizable through
<a class="xref" href="security-settings.html#ref-jwt-settings" title="JWT realm settings">JWT realm settings</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="jwt-validation-header"></a>Header claims<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>The header claims indicate the token type and the algorithm used to sign the
token.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">alg</code>
</span>
</dt>
<dd>
(Required, String) Indicates the algorithm that was used to sign the token, such
as <code class="literal">HS256</code>. The algorithm must be in the realm&#8217;s allow list.
</dd>
<dt>
<span class="term">
<code class="literal">typ</code>
</span>
</dt>
<dd>
(Optional, String) Indicates the token type, which must be <code class="literal">JWT</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="jwt-validation-payload"></a>Payload claims<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>Tokens contain several claims, which provide information about the user
who is issuing the token, and the token itself.
Depending on the token type, these information can optionally be identified
by different claims.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_jwt_payload_claims"></a>JWT payload claims<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h5>
</div></div></div>
<p>The following claims are validated by a subset of OIDC ID token rules.</p>
<p>Elasticsearch doesn&#8217;t validate <code class="literal">nonce</code> claims, but a custom JWT issuer can add a
random <code class="literal">nonce</code> claim to introduce entropy into the signature.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can relax validation of any of the time-based claims by setting
<code class="literal">allowed_clock_skew</code>. This value sets the maximum allowed clock skew before
validating JWTs with respect to their authentication time (<code class="literal">auth_time</code>),
creation (<code class="literal">iat</code>), not before (<code class="literal">nbf</code>), and expiration times (<code class="literal">exp</code>).</p>
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">iss</code>
</span>
</dt>
<dd>
(Required, String) Denotes the issuer that created the ID token. The value must
be an exact, case-sensitive match to the value in the <code class="literal">allowed_issuer</code> setting.
</dd>
<dt>
<span class="term">
<code class="literal">sub</code>
</span>
</dt>
<dd>
(Required*, String) Indicates the subject that the ID token is created for.
If the JWT realm is of the <code class="literal">id_token</code> type, this claim is mandatory.
A JWT realm of the <code class="literal">id_token</code> type by defaults accepts all subjects.
A JWT realm of the access_token type must specify the <code class="literal">allowed_subjects</code> setting and the subject value
must be an exact, case-sensitive match to any of the CSV values in the
allowed_subjects setting.
A JWT realm of the access_token type can specify a fallback claim that will
be used in place where the <code class="literal">sub</code> claim does not exist.
</dd>
<dt>
<span class="term">
<code class="literal">aud</code>
</span>
</dt>
<dd>
(Required*, String) Indicates the audiences that the ID token is for, expressed as a
comma-separated value (CSV). One of the values must be an exact, case-sensitive
match to any of the CSV values in the <code class="literal">allowed_audiences</code> setting.
If the JWT realm is of the <code class="literal">id_token</code> type, this claim is mandatory.
A JWT realm of the <code class="literal">access_token</code> type can specify a fallback claim that will
be used in place where the <code class="literal">aud</code> claim does not exist.
</dd>
<dt>
<span class="term">
<code class="literal">exp</code>
</span>
</dt>
<dd>
(Required, integer) Expiration time for the ID token, expressed in UTC
seconds since epoch.
</dd>
<dt>
<span class="term">
<code class="literal">iat</code>
</span>
</dt>
<dd>
(Required, integer) Time that the ID token was issued, expressed in UTC
seconds since epoch.
</dd>
<dt>
<span class="term">
<code class="literal">nbf</code>
</span>
</dt>
<dd>
(Optional, integer) Indicates the time before which the JWT must not be accepted,
expressed as UTC seconds since epoch.
This claim is optional. If it exists, a JWT realm of <code class="literal">id_token</code> type will verify
it, while a JWT realm of <code class="literal">access_token</code> will just ignore it.
</dd>
<dt>
<span class="term">
<code class="literal">auth_time</code>
</span>
</dt>
<dd>
(Optional, integer) Time when the user authenticated to the JWT issuer,
expressed as UTC seconds since epoch.
This claim is optional. If it exists, a JWT realm of <code class="literal">id_token</code> type will verify
it, while a JWT realm of <code class="literal">access_token</code> will just ignore it.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="jwt-validation-payload-es"></a>Elasticsearch settings for consuming JWT claims<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h5>
</div></div></div>
<p>Elasticsearch uses JWT claims for the following settings.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">principal</code>
</span>
</dt>
<dd>
(Required, String) Contains the user&#8217;s principal (username). The value is
configurable using the realm setting <code class="literal">claims.principal</code>.
You can configure an optional regular expression using the
<code class="literal">claims.principal_pattern</code> to extract a substring.
</dd>
<dt>
<span class="term">
<code class="literal">groups</code>
</span>
</dt>
<dd>
(Optional, JSON array) Contains the user&#8217;s group membership.
The value is configurable using the realm setting <code class="literal">claims.groups</code>. You can
configure an optional regular expression using the realm setting
<code class="literal">claims.groups_pattern</code> to extract a substring value.
</dd>
<dt>
<span class="term">
<code class="literal">name</code>
</span>
</dt>
<dd>
(Optional, String) Contains a human-readable identifier that identifies the
subject of the token. The value is configurable using the realm setting
<code class="literal">claims.name</code>. You can configure an optional regular expression using the realm
setting <code class="literal">claims.name_pattern</code> to extract a substring value.
</dd>
<dt>
<span class="term">
<code class="literal">mail</code>
</span>
</dt>
<dd>
(Optional, String) Contains the e-mail address to associate with the user. The
value is configurable using the realm setting <code class="literal">claims.mail</code>. You can configure an
optional regular expression using the realm setting <code class="literal">claims.mail_pattern</code> to
extract a substring value.
</dd>
<dt>
<span class="term">
<code class="literal">dn</code>
</span>
</dt>
<dd>
(Optional, String) Contains the user&#8217;s Distinguished Name (DN), which uniquely
identifies a user or group. The value is configurable using the realm setting
<code class="literal">claims.dn</code>. You can configure an optional regular expression using the realm
setting <code class="literal">claims.dn_pattern</code> to extract a substring value.
</dd>
</dl>
</div>
</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="jwt-authorization"></a>JWT realm authorization<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>The JWT realm supports authorization with the create or update role mappings API,
or delegating authorization to another realm. You cannot use these methods
simultaneously, so choose whichever works best for your environment.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>You cannot map roles in the JWT realm using the <code class="literal">role_mapping.yml</code>
file.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="jwt-authorization-role-mapping"></a>Authorizing with the role mapping API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>You can use the
<a class="xref" href="security-api-put-role-mapping.html" title="Create or update role mappings API">create or update role mappings API</a> to define
role mappings that determine which roles should be assigned to each user based on
their username, groups, or other metadata.</p>
<a id="5e21dbac92f34d236a8f0cc0d3a39cdd"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/jwt1_users?refresh=true
{
  "roles" : [ "user" ],
  "rules" : { "all" : [
      { "field": { "realm.name": "jwt1" } },
      { "field": { "username": "principalname1" } },
      { "field": { "dn": "CN=Principal Name 1,DC=example.com" } },
      { "field": { "groups": "group1" } },
      { "field": { "metadata.jwt_claim_other": "other1" } }
  ] },
  "enabled": true
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1757.console"></div>
<p>If you use this API in the JWT realm, the following claims are available for
role mapping:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">principal</code>
</span>
</dt>
<dd>
(Required, String) Principal claim that is used as the Elasticsearch user&#8217;s username.
</dd>
<dt>
<span class="term">
<code class="literal">dn</code>
</span>
</dt>
<dd>
(Optional, String) Distinguished Name (DN) that is used as the Elasticsearch user&#8217;s DN.
</dd>
<dt>
<span class="term">
<code class="literal">groups</code>
</span>
</dt>
<dd>
(Optional, String) Comma-separated value (CSV) list that is used as the Elasticsearch
user&#8217;s list of groups.
</dd>
<dt>
<span class="term">
<code class="literal">metadata</code>
</span>
</dt>
<dd>
(Optional, object) Additional metadata about the user, such as strings, integers,
boolean values, and collections that are used as the Elasticsearch user&#8217;s metadata.
These values are key value pairs formatted as
<code class="literal">metadata.jwt_claim_&lt;key&gt;</code> = <code class="literal">&lt;value&gt;</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="jwt-authorization-delegation"></a>Delegating JWT authorization to another realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>If you <a class="xref" href="realm-chains.html#authorization_realms" title="Delegating authorization to another realm">delegate authorization</a> to other realms from the
JWT realm, only the <code class="literal">principal</code> claim is available for role lookup. When
delegating the assignment and lookup of roles to another realm from the JWT
realm, claims for <code class="literal">dn</code>, <code class="literal">groups</code>, <code class="literal">mail</code>, <code class="literal">metadata</code>, and <code class="literal">name</code> are not used
for the Elasticsearch user&#8217;s values. Only the JWT <code class="literal">principal</code> claim is passed to the
delegated authorization realms. The realms that are delegated for authorization
- not the JWT realm - become responsible for populating all of the Elasticsearch user&#8217;s
values.</p>
<p>The following example shows how you define delegation authorization in the
<code class="literal">elasticsearch.yml</code> file to multiple other realms from the JWT realm. A JWT
realm named <code class="literal">jwt2</code> is delegating authorization to multiple realms:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.jwt.jwt2.authorization_realms: file1,native1,ldap1,ad1</pre>
</div>
<p>You can then use the
<a class="xref" href="security-api-put-role-mapping.html" title="Create or update role mappings API">create or update role mappings API</a> to map
roles to the authorizing realm. The following example maps roles in the <code class="literal">native1</code>
realm for the <code class="literal">principalname1</code> JWT principal.</p>
<a id="8f6f7ea5abf56152b4a5639ddf40848f"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/native1_users?refresh=true
{
  "roles" : [ "user" ],
  "rules" : { "all" : [
      { "field": { "realm.name": "native1" } },
      { "field": { "username": "principalname1" } }
  ] },
  "enabled": true
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1758.console"></div>
<p>If realm <code class="literal">jwt2</code> successfully authenticates a client with a JWT for principal
<code class="literal">principalname1</code>, and delegates authorization to one of the listed realms
(such as <code class="literal">native1</code>), then that realm can look up the Elasticsearch user&#8217;s values. With
this defined role mapping, the realm can also look up this role mapping rule
linked to realm <code class="literal">native1</code>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="jwt-realm-runas"></a>Applying the <code class="literal">run_as</code> privilege to JWT realm users<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>Elasticsearch can retrieve roles for a JWT user through either role mapping or
delegated authorization. Regardless of which option you choose, you can apply the
<a class="xref" href="run-as-privilege.html#run-as-privilege-apply" title="Apply the run_as privilege to roles"><code class="literal">run_as</code> privilege</a> to a role so that a user can
submit authenticated requests to "run as" a different user. To submit requests as
another user, include the <code class="literal">es-security-runas-user</code> header in your requests.
Requests run as if they were issued from that user and Elasticsearch uses their roles.</p>
<p>For example, let&#8217;s assume that there&#8217;s a user with the username <code class="literal">user123_runas</code>.
The following request creates a user role named <code class="literal">jwt_role1</code>, which specifies a
<code class="literal">run_as</code> user with the <code class="literal">user123_runas</code> username. Any user with the <code class="literal">jwt_role1</code>
role can issue requests as the specified <code class="literal">run_as</code> user.</p>
<a id="2864a24608b3ac59d21f604f8a31d131"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/role/jwt_role1?refresh=true
{
  "cluster": ["manage"],
  "indices": [ { "names": [ "*" ], "privileges": ["read"] } ],
  "run_as": [ "user123_runas" ],
  "metadata" : { "version" : 1 }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1759.console"></div>
<p>You can then map that role to a user in a specific realm. The following request
maps the <code class="literal">jwt_role1</code> role to a user with the username <code class="literal">user2</code> in the <code class="literal">jwt2</code> JWT
realm. This means that Elasticsearch will use the <code class="literal">jwt2</code> realm to authenticate the user
named <code class="literal">user2</code>. Because <code class="literal">user2</code> has a role (the <code class="literal">jwt_role1</code> role) that includes
the <code class="literal">run_as</code> privilege, Elasticsearch retrieves the role mappings for the <code class="literal">user123_runas</code>
user and uses the roles for that user to submit requests.</p>
<a id="fe54f3e53dbe7dee40ec3108a461d19a"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/role_mapping/jwt_user1?refresh=true
{
  "roles": [ "jwt_role1"],
  "rules" : { "all" : [
      { "field": { "realm.name": "jwt2" } },
      { "field": { "username": "user2" } }
  ] },
  "enabled": true,
  "metadata" : { "version" : 1 }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1760.console"></div>
<p>After mapping the roles, you can make an
<a class="xref" href="security-api-authenticate.html" title="Authenticate API">authenticated call</a> to Elasticsearch using a JWT and include
the <code class="literal">ES-Client-Authentication</code> header:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -s -X GET -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOlsiZXMwMSIsImVzMDIiLCJlczAzIl0sInN1YiI6InVzZXIyIiwiaXNzIjoibXktaXNzdWVyIiwiZXhwIjo0MDcwOTA4ODAwLCJpYXQiOjk0NjY4NDgwMCwiZW1haWwiOiJ1c2VyMkBzb21ldGhpbmcuZXhhbXBsZS5jb20ifQ.UgO_9w--EoRyUKcWM5xh9SimTfMzl1aVu6ZBsRWhxQA" -H "ES-Client-Authentication: sharedsecret test-secret" https://localhost:9200/_security/_authenticate</pre>
</div>
<p>The response includes the user who submitted the request (<code class="literal">user2</code>), including
the <code class="literal">jwt_role1</code> role that you mapped to this user in the JWT realm:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{"username":"user2","roles":["jwt_role1"],"full_name":null,"email":"user2@something.example.com",
"metadata":{"jwt_claim_email":"user2@something.example.com","jwt_claim_aud":["es01","es02","es03"],
"jwt_claim_sub":"user2","jwt_claim_iss":"my-issuer"},"enabled":true,"authentication_realm":
{"name":"jwt2","type":"jwt"},"lookup_realm":{"name":"jwt2","type":"jwt"},"authentication_type":"realm"}
%</pre>
</div>
<p>If you want to specify a request as the <code class="literal">run_as</code> user, include the
<code class="literal">es-security-runas-user</code> header with the name of the user that you want to
submit requests as. The following request uses the <code class="literal">user123_runas</code> user:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -s -X GET -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOlsiZXMwMSIsImVzMDIiLCJlczAzIl0sInN1YiI6InVzZXIyIiwiaXNzIjoibXktaXNzdWVyIiwiZXhwIjo0MDcwOTA4ODAwLCJpYXQiOjk0NjY4NDgwMCwiZW1haWwiOiJ1c2VyMkBzb21ldGhpbmcuZXhhbXBsZS5jb20ifQ.UgO_9w--EoRyUKcWM5xh9SimTfMzl1aVu6ZBsRWhxQA" -H "ES-Client-Authentication: sharedsecret test-secret" -H "es-security-runas-user: user123_runas" https://localhost:9200/_security/_authenticate</pre>
</div>
<p>In the response, you&#8217;ll see that the <code class="literal">user123_runas</code> user submitted the request,
and Elasticsearch used the <code class="literal">jwt_role1</code> role:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{"username":"user123_runas","roles":["jwt_role1"],"full_name":null,"email":null,"metadata":{},
"enabled":true,"authentication_realm":{"name":"jwt2","type":"jwt"},"lookup_realm":{"name":"native",
"type":"native"},"authentication_type":"realm"}%</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="jwt-realm-jwkset-reloading"></a>PKC JWKS reloading<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>JWT authentication supports signature verification using PKC (Public Key Cryptography)
or HMAC algorithms.</p>
<p>PKC JSON Web Token Key Sets (JWKS) can contain public RSA and EC keys. HMAC JWKS
or an HMAC UTF-8 JWK contain secret keys. JWT issuers typically rotate PKC JWKS
more frequently (such as daily), because RSA and EC public keys are designed to
be easier to distribute than secret keys like HMAC.</p>
<p>JWT realms load a PKC JWKS and an HMAC JWKS or HMAC UTF-8 JWK at startup. JWT
realms can also reload PKC JWKS contents at runtime; a reload is triggered by
signature validation failures.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>HMAC JWKS or HMAC UTF-8 JWK reloading is not supported at this time.</p>
</div>
</div>
<p>Load failures, parse errors, and configuration errors prevent a node from
starting (and restarting). However, runtime PKC reload errors and recoveries are
handled gracefully.</p>
<p>All other JWT realm validations are checked before a signature failure can
trigger a PKC JWKS reload. If multiple JWT authentication signature failures
occur simultaneously with a single Elasticsearch node, reloads are combined to reduce
the reloads that are sent externally.</p>
<p>Separate reload requests cannot be combined if JWT signature failures trigger:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
PKC JWKS reloads in different Elasticsearch nodes
</li>
<li class="listitem">
PKC JWKS reloads in the same Elasticsearch node at different times
</li>
</ul>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Enabling client authentication (<code class="literal">client_authentication.type</code>) is strongly
recommended. Only trusted client applications and realm-specific JWT users can
trigger PKC reload attempts. Additionally, configuring the following
<a class="xref" href="security-settings.html#ref-jwt-settings" title="JWT realm settings">JWT security settings</a> is recommended:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">allowed_audiences</code>
</li>
<li class="listitem">
<code class="literal">allowed_clock_skew</code>
</li>
<li class="listitem">
<code class="literal">allowed_issuer</code>
</li>
<li class="listitem">
<code class="literal">allowed_signature_algorithms</code>
</li>
</ul>
</div>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="hmac-oidc-example"></a>Authorizing to the JWT realm with an HMAC UTF-8 key<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>The following settings are for a JWT issuer, Elasticsearch, and a client of Elasticsearch. The
example HMAC key is in an OIDC format that&#8217;s compatible with HMAC. The key bytes
are the UTF-8 encoding of the UNICODE characters.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>HMAC UTF-8 keys need to be longer than HMAC random byte keys to
achieve the same key strength.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="hmac-oidc-example-jwt-issuer"></a>JWT issuer<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>The following values are for the bespoke JWT issuer.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">Issuer:     iss8
Audiences:  aud8
Algorithms: HS256
HMAC UTF-8: hmac-oidc-key-string-for-hs256-algorithm</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="hmac-oidc-example-jwt-realm"></a>JWT realm settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>To define a JWT realm, add the following realm settings to <code class="literal">elasticsearch.yml</code>.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.jwt.jwt8.order: 8 <a id="CO564-1"></a><i class="conum" data-value="1"></i>
xpack.security.authc.realms.jwt.jwt8.allowed_issuer: iss8
xpack.security.authc.realms.jwt.jwt8.allowed_audiences: [aud8]
xpack.security.authc.realms.jwt.jwt8.allowed_signature_algorithms: [HS256]
xpack.security.authc.realms.jwt.jwt8.claims.principal: sub
xpack.security.authc.realms.jwt.jwt8.client_authentication.type: shared_secret</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO564-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>In Elastic Cloud, the realm order starts at <code class="literal">2</code>. <code class="literal">0</code> and <code class="literal">1</code> are reserved in the
realm chain on Elastic Cloud.</p>
</td>
</tr>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_jwt_realm_secure_settings"></a>JWT realm secure settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>After defining the realm settings, use the
<a href="/guide/en/elasticsearch/reference/8.8/elasticsearch-keystore.html" class="ulink" target="_top"><code class="literal">elasticsearch-keystore</code></a> tool to add the
following secure settings to the Elasticsearch keystore. In Elastic Cloud, you define settings
for the Elasticsearch keystore under <span class="strong strong"><strong>Security</strong></span> in your deployment.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.jwt.jwt8.hmac_key: hmac-oidc-key-string-for-hs256-algorithm
xpack.security.authc.realms.jwt.jwt8.client_authentication.shared_secret: client-shared-secret-string</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_jwt_realm_role_mapping_rule"></a>JWT realm role mapping rule<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>The following request creates role mappings for Elasticsearch in the <code class="literal">jwt8</code> realm for
the user <code class="literal">principalname1</code>:</p>
<a id="7885ca9d7c61050095288eef6bc6cca9"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/jwt8_users?refresh=true
{
  "roles" : [ "user" ],
  "rules" : { "all" : [
      { "field": { "realm.name": "jwt8" } },
      { "field": { "username": "principalname1" } }
  ] },
  "enabled": true
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1761.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="hmac-oidc-example-request-headers"></a>Request headers<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>The following header settings are for an Elasticsearch client.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJpc3M4IiwiYXVkIjoiYXVkOCIsInN1YiI6InNlY3VyaXR5X3Rlc3RfdXNlciIsImV4cCI6NDA3MDkwODgwMCwiaWF0Ijo5NDY2ODQ4MDB9.UnnFmsoFKfNmKMsVoDQmKI_3-j95PCaKdgqqau3jPMY
ES-Client-Authentication: SharedSecret client-shared-secret-string</pre>
</div>
<p>You can use this header in a <code class="literal">curl</code> request to make an authenticated call to
Elasticsearch. Both the bearer token and the client authorization token must be
specified as separate headers with the <code class="literal">-H</code> option:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -s -X GET -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJpc3M4IiwiYXVkIjoiYXVkOCIsInN1YiI6InNlY3VyaXR5X3Rlc3RfdXNlciIsImV4cCI6NDA3MDkwODgwMCwiaWF0Ijo5NDY2ODQ4MDB9.UnnFmsoFKfNmKMsVoDQmKI_3-j95PCaKdgqqau3jPMY" -H "ES-Client-Authentication: SharedSecret client-shared-secret-string" https://localhost:9200/_security/_authenticate</pre>
</div>
<p>If you used role mapping in the JWT realm, the response includes the user&#8217;s
<code class="literal">username</code>, their <code class="literal">roles</code>, metadata about the user, and the details about the
JWT realm itself.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{"username":"user2","roles":["jwt_role1"],"full_name":null,"email":"user2@something.example.com",
"metadata":{"jwt_claim_email":"user2@something.example.com","jwt_claim_aud":["es01","es02","es03"],
"jwt_claim_sub":"user2","jwt_claim_iss":"my-issuer"},"enabled":true,"authentication_realm":
{"name":"jwt2","type":"jwt"},"lookup_realm":{"name":"jwt2","type":"jwt"},"authentication_type":"realm"}</pre>
</div>
</div>

</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="kerberos-realm.html">« Kerberos authentication</a>
</span>
<span class="next">
<a href="custom-realms.html">Integrating with other authentication systems »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {"alternatives":{"console":{"php":{"hasAny":true},"python":{"hasAny":true},"ruby":{"hasAny":true},"go":{"hasAny":true},"js":{"hasAny":true}}}}</script>
  </body>
</html>
