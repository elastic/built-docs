<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Deploy and manage Learning To Rank models | Elasticsearch Guide [8.14] | Elastic</title>
<meta class="elastic" name="content" content="Deploy and manage Learning To Rank models | Elasticsearch Guide [8.14]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.14]"/>
<link rel="up" href="learning-to-rank.html" title="Learning To Rank"/>
<link rel="prev" href="learning-to-rank.html" title="Learning To Rank"/>
<link rel="next" href="learning-to-rank-search-usage.html" title="Search using Learning To Rank"/>
<meta class="elastic" name="product_version" content="8.14"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.14"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.14"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.14]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search-with-elasticsearch.html">Search your data</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="learning-to-rank.html">Learning To Rank</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="learning-to-rank.html">« Learning To Rank</a>
</span>
<span class="next">
<a href="learning-to-rank-search-usage.html">Search using Learning To Rank »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="learning-to-rank-model-training"></a>Deploy and manage Learning To Rank models<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h2>
</div></div></div>

<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>The Learning To Rank feature is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but this feature is not subject to the support SLA of official GA features.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This feature was introduced in version 8.12.0 and is only available to certain subscription levels.
For more information, see <a href="/subscriptions" class="ulink" target="_top">https://www.elastic.co/subscriptions</a>.</p>
</div>
</div>
<h4><a id="learning-to-rank-model-training-workflow"></a>Train and deploy a model using Eland<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h4>
<p>Typically, the <a href="https://xgboost.readthedocs.io/en/stable/" class="ulink" target="_blank" rel="noopener">XGBoost</a> model training process uses standard Python data science tools like Pandas and scikit-learn.</p>
<p>We have developed an
<a href="https://github.com/elastic/elasticsearch-labs/blob/main/notebooks/search/08-learning-to-rank.ipynb" class="ulink" target="_blank" rel="noopener">example
notebook</a> available in the <code class="literal">elasticsearch-labs</code> repo. This interactive Python notebook
details an end-to-end model training and deployment workflow.</p>
<p>We highly recommend using <a href="https://eland.readthedocs.io/" class="ulink" target="_blank" rel="noopener">eland</a> in your workflow, because it provides important functionalities for working with LTR in Elasticsearch. Use eland to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Configure feature extraction
</li>
<li class="listitem">
Extract features for training
</li>
<li class="listitem">
Deploy the model in Elasticsearch
</li>
</ul>
</div>
<h5><a id="learning-to-rank-model-training-feature-definition"></a>Configure feature extraction in Eland<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h5>
<p>Feature extractors are defined using templated queries. <a href="https://eland.readthedocs.io/" class="ulink" target="_blank" rel="noopener">Eland</a> provides the <code class="literal">eland.ml.ltr.QueryFeatureExtractor</code> to define these feature extractors directly in Python:</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">from eland.ml.ltr import QueryFeatureExtractor

feature_extractors=[
    # We want to use the score of the match query for the title field as a feature:
    QueryFeatureExtractor(
        feature_name="title_bm25",
        query={"match": {"title": "{{query}}"}}
    ),
    # We can use a script_score query to get the value
    # of the field rating directly as a feature:
    QueryFeatureExtractor(
        feature_name="popularity",
        query={
            "script_score": {
                "query": {"exists": {"field": "popularity"}},
                "script": {"source": "return doc['popularity'].value;"},
            }
        },
    ),
    # We can execute a script on the value of the query
    # and use the return value as a feature:
    QueryFeatureExtractor(
        feature_name="query_length",
        query={
            "script_score": {
                "query": {"match_all": {}},
                "script": {
                    "source": "return params['query'].splitOnToken(' ').length;",
                    "params": {
                        "query": "{{query}}",
                    }
                },
            }
        },
    ),
]</pre>
</div>
<p>Once the feature extractors have been defined, they are wrapped in an <code class="literal">eland.ml.ltr.LTRModelConfig</code> object for use in later training steps:</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">from eland.ml.ltr import LTRModelConfig

ltr_config = LTRModelConfig(feature_extractors)</pre>
</div>
<h5><a id="learning-to-rank-model-training-feature-extraction"></a>Extracting features for training<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h5>
<p>Building your dataset is a critical step in the training process. This involves
extracting relevant features and adding them to your judgment list. We
recommend using Eland&#8217;s <code class="literal">eland.ml.ltr.FeatureLogger</code> helper class for this
process.</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">from eland.ml.ltr import FeatureLogger

# Create a feature logger that will be used to query {es} to retrieve the features:
feature_logger = FeatureLogger(es_client, MOVIE_INDEX, ltr_config)</pre>
</div>
<p>The FeatureLogger provides an <code class="literal">extract_features</code> method which enables you to extract features for a list of specific documents from your judgment list. At the same time, you can pass query parameters to the feature extractors defined earlier:</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">feature_logger.extract_features(
    query_params={"query": "foo"},
    doc_ids=["doc-1", "doc-2"]
)</pre>
</div>
<p>Our <a href="https://github.com/elastic/elasticsearch-labs/blob/main/notebooks/search/08-learning-to-rank.ipynb" class="ulink" target="_blank" rel="noopener">example notebook</a> explains how to use the <code class="literal">FeatureLogger</code> to build a training dataset, by adding features to a judgment list.</p>
<h6><a id="learning-to-rank-model-training-feature-extraction-notes"></a>Notes on feature extraction<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h6>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
We strongly advise against implementing feature extraction on your own. It&#8217;s crucial to maintain consistency in feature extraction between the training environment and inference in Elasticsearch. By using eland tooling, which is developed and tested in tandem with Elasticsearch, you can ensure that they function together consistently.
</li>
<li class="listitem">
Feature extraction is performed by executing queries on the Elasticsearch server. This could put a lot of stress on your cluster, especially when your judgment list contains a lot of examples or you have many features. Our feature logger implementation is designed to minimize the number of search requests sent to the server and reduce load. However, it might be best to build your training dataset using an Elasticsearch cluster that is isolated from any user-facing, production traffic.
</li>
</ul>
</div>
<h5><a id="learning-to-rank-model-deployment"></a>Deploy your model into Elasticsearch<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h5>
<p>Once your model is trained you will be able to deploy it in your Elasticsearch cluster. You can use Eland&#8217;s <code class="literal">MLModel.import_ltr_model method</code>:</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">from eland.ml import MLModel

LEARNING_TO_RANK_MODEL_ID="ltr-model-xgboost"

MLModel.import_ltr_model(
    es_client=es_client,
    model=ranker,
    model_id=LEARNING_TO_RANK_MODEL_ID,
    ltr_model_config=ltr_config,
    es_if_exists="replace",
)</pre>
</div>
<p>This method will serialize the trained model and the Learning To Rank configuration (including feature extraction) in a format that Elasticsearch can understand. The model is then deployed to Elasticsearch using the <a class="xref" href="put-trained-models.html" title="Create trained models API">Create Trained Models API</a>.</p>
<p>The following types of models are currently supported for LTR with Elasticsearch:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeRegressor.html" class="ulink" target="_blank" rel="noopener"><code class="literal">DecisionTreeRegressor</code></a>
</li>
<li class="listitem">
<a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html" class="ulink" target="_blank" rel="noopener"><code class="literal">RandomForestRegressor</code></a>
</li>
<li class="listitem">
<a href="https://lightgbm.readthedocs.io/en/latest/pythonapi/lightgbm.LGBMRegressor.html" class="ulink" target="_blank" rel="noopener"><code class="literal">LGBMRegressor</code></a>
</li>
<li class="listitem">
<a href="https://xgboost.readthedocs.io/en/stable/python/python_api.html#xgboost.XGBRanker" class="ulink" target="_blank" rel="noopener"><code class="literal">XGBRanker</code></a>
</li>
<li class="listitem">
<a href="https://xgboost.readthedocs.io/en/stable/python/python_api.html#xgboost.XGBRegressor" class="ulink" target="_blank" rel="noopener"><code class="literal">XGBRegressor</code></a>
</li>
</ul>
</div>
<p>More model types will be supported in the future.</p>
<h4><a id="learning-to-rank-model-management"></a>Learning To Rank model management<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h4>
<p>Once your model is deployed in Elasticsearch you can manage it using the <a href="/guide/en/elasticsearch/reference/current/ml-df-trained-models-apis.html" class="ulink" target="_top">trained model APIs</a>.
You&#8217;re now ready to work with your LTR model as a rescorer at <a class="xref" href="learning-to-rank-search-usage.html" title="Search using Learning To Rank">search time</a>.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="learning-to-rank.html">« Learning To Rank</a>
</span>
<span class="next">
<a href="learning-to-rank-search-usage.html">Search using Learning To Rank »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs.js"></script>
    <script type="text/javascript">
  window.initial_state = {"alternatives":{"console":{"php":{"hasAny":true},"python":{"hasAny":true},"ruby":{"hasAny":true},"go":{"hasAny":true},"js":{"hasAny":true}}}}</script>
  </body>
</html>
