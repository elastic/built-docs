<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Configuring single sign-on to the Elastic Stack using OpenID Connect | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Configuring single sign-on to the Elastic Stack using OpenID Connect | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="setting-up-authentication.html" title="User authentication"/>
<link rel="prev" href="saml-guide-stack.html" title="Configuring SAML single-sign-on on the Elastic Stack"/>
<link rel="next" href="authorization.html" title="User authorization"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles-v1.css" />
  </head>

  <!--© 2015-2025 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="saml-guide-stack.html">« Configuring SAML single-sign-on on the Elastic Stack</a>
</span>
<span class="next">
<a href="authorization.html">User authorization »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="secure-cluster.html">Secure the Elastic Stack</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="setting-up-authentication.html">User authentication</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Configuring single sign-on to the Elastic Stack using OpenID Connect</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="oidc-guide"></a>Configuring single sign-on to the Elastic Stack using OpenID Connect<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h2>
</div></div></div>
<p>The Elastic Stack supports single sign-on (SSO) using OpenID Connect via Kibana using
Elasticsearch as the backend service that holds most of the functionality. Kibana and Elasticsearch
together represent an OpenID Connect Relying Party (RP) that supports the authorization code flow and implicit flow as these are defined in the OpenID Connect specification.</p>
<p>This guide assumes that you have an OpenID Connect Provider where the
Elastic Stack Relying Party will be registered.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The OpenID Connect realm support in Kibana is designed with the expectation that it
will be the primary authentication method for the users of that Kibana instance. The
<a class="xref" href="oidc-guide.html#oidc-configure-kibana" title="Configuring Kibana">Configuring Kibana</a> section describes what this entails and how you can set it up to support
other realms if necessary.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="oidc-guide-op"></a>The OpenID Connect Provider<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>The OpenID Connect Provider (OP) is the entity in OpenID Connect that is responsible for
authenticating the user and for granting the necessary tokens with the authentication and
user information to be consumed by the Relying Parties.</p>
<p>In order for the Elastic Stack to be able to use your OpenID Connect Provider for authentication,
a trust relationship needs to be established between the OP and the RP. In the OpenID Connect
Provider, this means registering the RP as a client. OpenID Connect defines a dynamic client
registration protocol but this is usually geared towards real-time client registration and
not the trust establishment process for cross security domain single sign on. All OPs will
also allow for the manual registration of an RP as a client, via a user interface or (less often)
via the consumption of a metadata document.</p>
<p>The process for registering the Elastic Stack RP will be different from OP to OP and following
the provider&#8217;s relevant documentation is prudent. The information for the
RP that you commonly need to provide for registration are the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">Relying Party Name</code>: An arbitrary identifier for the relying party. Neither the specification
nor the Elastic Stack implementation impose any constraints on this value.
</li>
<li class="listitem">
<code class="literal">Redirect URI</code>: This is the URI where the OP will redirect the user&#8217;s browser after authentication. The
appropriate value for this will depend on your setup and whether or not Kibana sits behind a proxy or
load balancer. It will typically be <code class="literal">${kibana-url}/api/security/oidc/callback</code> (for the authorization code flow) or <code class="literal">${kibana-url}/api/security/oidc/implicit</code> (for the implicit flow) where <em>${kibana-url}</em> is the base URL for your Kibana instance. You might also see this
called <code class="literal">Callback URI</code>.
</li>
</ul>
</div>
<p>At the end of the registration process, the OP will assign a Client Identifier and a Client Secret for the RP (Elastic Stack) to use.
Note these two values as they will be used in the Elasticsearch configuration.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="oidc-elasticsearch-authentication"></a>Configure Elasticsearch for OpenID Connect authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>The following is a summary of the configuration steps required in order to enable authentication
using OpenID Connect in Elasticsearch:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="oidc-guide.html#oidc-enable-http" title="Enable TLS for HTTP">Enable SSL/TLS for HTTP</a>
</li>
<li class="listitem">
<a class="xref" href="oidc-guide.html#oidc-enable-token" title="Enable the token service">Enable the Token Service</a>
</li>
<li class="listitem">
<a class="xref" href="oidc-guide.html#oidc-create-realm" title="Create an OpenID Connect realm">Create one or more OpenID Connect realms</a>
</li>
<li class="listitem">
<a class="xref" href="oidc-guide.html#oidc-role-mappings" title="Configuring role mappings">Configure role mappings</a>
</li>
</ol>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="oidc-enable-http"></a>Enable TLS for HTTP<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>If your Elasticsearch cluster is operating in production mode, then you must
configure the HTTP interface to use SSL/TLS before you can enable OpenID Connect
authentication.</p>
<p>For more information, see
<a class="xref" href="security-basic-setup-https.html#encrypt-http-communication" title="Encrypt HTTP client communications for Elasticsearch">Encrypt HTTP client communications for Elasticsearch</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="oidc-enable-token"></a>Enable the token service<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The Elasticsearch OpenID Connect implementation makes use of the Elasticsearch Token Service. This service
is automatically enabled if you configure TLS on the HTTP interface, and can be
explicitly configured by including the following in your <code class="literal">elasticsearch.yml</code> file:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.token.enabled: true</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="oidc-create-realm"></a>Create an OpenID Connect realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>OpenID Connect based authentication is enabled by configuring the appropriate realm within
the authentication chain for Elasticsearch.</p>
<p>This realm has a few mandatory settings, and a number of optional settings.
The available settings are described in detail in
<a class="xref" href="security-settings.html#ref-oidc-settings" title="OpenID Connect realm settings">OpenID Connect realm settings</a>. This
guide will explore the most common settings.</p>
<p>Create an OpenID Connect (the realm type is <code class="literal">oidc</code>) realm in your <code class="literal">elasticsearch.yml</code> file
similar to what is shown below:</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The values used below are meant to be an example and are not intended to apply to
every use case. The details below the configuration snippet provide insights and suggestions
to help you pick the proper values, depending on your OP configuration.</p>
</div>
</div>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.oidc.oidc1:
  order: 2
  rp.client_id: "the_client_id"
  rp.response_type: code
  rp.redirect_uri: "https://kibana.example.org:5601/api/security/oidc/callback"
  op.issuer: "https://op.example.org"
  op.authorization_endpoint: "https://op.example.org/oauth2/v1/authorize"
  op.token_endpoint: "https://op.example.org/oauth2/v1/token"
  op.jwkset_path: oidc/jwkset.json
  op.userinfo_endpoint: "https://op.example.org/oauth2/v1/userinfo"
  op.endsession_endpoint: "https://op.example.org/oauth2/v1/logout"
  rp.post_logout_redirect_uri: "https://kibana.example.org:5601/security/logged_out"
  claims.principal: sub
  claims.groups: "http://example.info/claims/groups"</pre>
</div>
<p>The configuration values used in the example above are:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
xpack.security.authc.realms.oidc.oidc1
</span>
</dt>
<dd>
This defines a new <code class="literal">oidc</code> authentication realm named "oidc1".
See <a class="xref" href="realms.html" title="Realms">Realms</a> for more explanation of realms.
</dd>
<dt>
<span class="term">
order
</span>
</dt>
<dd>
You should define a unique order on each realm in your authentication chain.
It is recommended that the OpenID Connect realm be at the bottom of your authentication
chain (that is, that it has the <em>highest</em> order).
</dd>
<dt>
<span class="term">
rp.client_id
</span>
</dt>
<dd>
This, usually opaque, arbitrary string, is the Client Identifier that was assigned to the Elastic Stack RP by the OP upon
registration.
</dd>
<dt>
<span class="term">
rp.response_type
</span>
</dt>
<dd>
<p>
This is an identifier that controls which OpenID Connect authentication flow this RP supports and also
which flow this RP requests the OP should follow. Supported values are
</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">code</code>, which means that the RP wants to use the Authorization Code flow. If your OP supports the
Authorization Code flow, you should select this instead of the Implicit Flow.
</li>
<li class="listitem">
<code class="literal">id_token token</code> which means that the RP wants to use the Implicit flow and we also request an oAuth2
access token from the OP, that we can potentially use for follow up requests ( UserInfo ). This
should be selected if the OP offers a UserInfo endpoint in its configuration, or if you know that
the claims you will need to use for role mapping are not available in the ID Token.
</li>
<li class="listitem">
<code class="literal">id_token</code> which means that the RP wants to use the Implicit flow, but is not interested in getting
an oAuth2 token too. Select this if you are certain that all necessary claims will be contained in
the ID Token or if the OP doesn&#8217;t offer a User Info endpoint.
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
rp.redirect_uri
</span>
</dt>
<dd>
The redirect URI where the OP will redirect the browser after authentication. This needs to be
<em>exactly</em> the same as the one <a class="xref" href="oidc-guide.html#oidc-guide-op" title="The OpenID Connect Provider">configured with the OP upon registration</a> and will
typically be <code class="literal">${kibana-url}/api/security/oidc/callback</code> where <em>${kibana-url}</em> is the base URL for your Kibana instance
</dd>
<dt>
<span class="term">
op.issuer
</span>
</dt>
<dd>
A verifiable Identifier for your OpenID Connect Provider. An Issuer Identifier is usually a case sensitive URL.
The value for this setting should be provided by your OpenID Connect Provider.
</dd>
<dt>
<span class="term">
op.authorization_endpoint
</span>
</dt>
<dd>
The URL for the Authorization Endpoint in the OP. This is where the user&#8217;s browser
will be redirected to start the authentication process. The value for this setting should be provided by your
OpenID Connect Provider.
</dd>
<dt>
<span class="term">
op.token_endpoint
</span>
</dt>
<dd>
The URL for the Token Endpoint in the OpenID Connect Provider. This is the endpoint where
Elasticsearch will send a request to exchange the code for an ID Token. This setting is optional when
you use the implicit flow. The value for this setting should be provided by your OpenID Connect Provider.
</dd>
<dt>
<span class="term">
op.jwkset_path
</span>
</dt>
<dd>
The path to a file or a URL containing a JSON Web Key Set with the key material that the OpenID Connect
Provider uses for signing tokens and claims responses. If a path is set, it is resolved relative to the Elasticsearch
config directory.
Elasticsearch will automatically monitor this file for changes and will reload the configuration whenever
it is updated. Your OpenID Connect Provider should provide you with this file or a URL where it is available.
</dd>
<dt>
<span class="term">
op.userinfo_endpoint
</span>
</dt>
<dd>
(Optional) The URL for the UserInfo Endpoint in the OpenID Connect Provider. This is the endpoint of the OP that
can be queried to get further user information, if required. The value for this setting should be provided by your
 OpenID Connect Provider.
</dd>
<dt>
<span class="term">
op.endsession_endpoint
</span>
</dt>
<dd>
(Optional) The URL to the End Session Endpoint in the OpenID Connect Provider. This is the endpoint where the user&#8217;s
browser will be redirected after local logout, if the realm is configured for RP initiated Single Logout and
the OP supports it. The value for this setting should be provided by your OpenID Connect Provider.
</dd>
<dt>
<span class="term">
rp.post_logout_redirect_uri
</span>
</dt>
<dd>
(Optional) The Redirect URL where the OpenID Connect Provider should redirect the user after a
successful Single Logout (assuming <code class="literal">op.endsession_endpoint</code> above is also set). This should be set to a value that
will not trigger a new OpenID Connect Authentication, such as <code class="literal">${kibana-url}/security/logged_out</code>  or
<code class="literal">${kibana-url}/login?msg=LOGGED_OUT</code> where <em>${kibana-url}</em> is the base URL for your Kibana instance.
</dd>
<dt>
<span class="term">
claims.principal
</span>
</dt>
<dd>
See <a class="xref" href="oidc-guide.html#oidc-claims-mappings" title="Claims mapping">Claims mapping</a>.
</dd>
<dt>
<span class="term">
claims.groups
</span>
</dt>
<dd>
See <a class="xref" href="oidc-guide.html#oidc-claims-mappings" title="Claims mapping">Claims mapping</a>.
</dd>
</dl>
</div>
<p>A final piece of configuration of the OpenID Connect realm is to set the <code class="literal">Client Secret</code> that was assigned
to the RP during registration in the OP. This is a secure setting and as such is not defined in the realm
configuration in <code class="literal">elasticsearch.yml</code> but added to the
<a class="xref" href="secure-settings.html" title="Secure settings">elasticsearch keystore</a>.
For instance</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-keystore add xpack.security.authc.realms.oidc.oidc1.rp.client_secret</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Changes to the <code class="literal">client_secret</code> requires a restart of the Elasticsearch nodes to pick up the change.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>According to the OpenID Connect specification, the OP should also make their configuration
available at a well known URL, which is the concatenation of their <code class="literal">Issuer</code> value with the
<code class="literal">.well-known/openid-configuration</code> string. For example: <code class="literal">https://op.org.com/.well-known/openid-configuration</code>
That document should contain all the necessary information to configure the OpenID Connect realm in Elasticsearch.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="oidc-claims-mappings"></a>Claims mapping<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_claims_and_scopes"></a>Claims and scopes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>When authenticating to Kibana using OpenID Connect, the OP will provide information about the user
in the form of OpenID Connect Claims, that can be included either in the ID Token, or be retrieved from the
UserInfo endpoint of the OP. The claim is defined as a piece of information asserted by the OP
for the authenticated user. Simply put, a claim is a name/value pair that contains information about
the user. Related to claims, we also have the notion of OpenID Connect Scopes. Scopes are identifiers
that are used to request access to specific lists of claims. The standard defines a set of scope
identifiers that can be requested. The only mandatory one is <code class="literal">openid</code>, while commonly used ones are
<code class="literal">profile</code> and <code class="literal">email</code>. The <code class="literal">profile</code> scope requests access to the <code class="literal">name</code>,<code class="literal">family_name</code>,<code class="literal">given_name</code>,<code class="literal">middle_name</code>,<code class="literal">nickname</code>,
<code class="literal">preferred_username</code>,<code class="literal">profile</code>,<code class="literal">picture</code>,<code class="literal">website</code>,<code class="literal">gender</code>,<code class="literal">birthdate</code>,<code class="literal">zoneinfo</code>,<code class="literal">locale</code>, and <code class="literal">updated_at</code> claims.
The <code class="literal">email</code> scope requests access to the <code class="literal">email</code> and <code class="literal">email_verified</code> claims. The process is that
the RP requests specific scopes during the authentication request. If the OP Privacy Policy
allows it and the authenticating user consents to it, the related claims are returned to the
RP (either in the ID Token or as a UserInfo response).</p>
<p>The list of the supported claims will vary depending on the OP you are using, but you can expect
the <a href="https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims" class="ulink" target="_top">Standard Claims</a> to be
largely supported.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="oidc-claim-to-property"></a>Mapping claims to user properties<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>The goal of claims mapping is to configure Elasticsearch in such a way as to be able to map the values of
specified returned claims to one of the <a class="xref" href="oidc-guide.html#oidc-user-properties" title="Elasticsearch user properties">user properties</a> that are supported
by Elasticsearch. These user properties are then utilized to identify the user in the Kibana UI or the audit
logs, and can also be used to create <a class="xref" href="oidc-guide.html#oidc-role-mappings" title="Configuring role mappings">role mapping</a> rules.</p>
<p>The recommended steps for configuring OpenID Claims mapping are as follows:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Consult your OP configuration to see what claims it might support. Note that
the list provided in the OP&#8217;s metadata or in the configuration page of the OP
is a list of potentially supported claims. However, for privacy reasons it might
not be a complete one, or not all supported claims will be available for all
authenticated users.
</li>
<li class="listitem">
Read through the list of <a class="xref" href="oidc-guide.html#oidc-user-properties" title="Elasticsearch user properties">user properties</a> that Elasticsearch
supports, and decide which of them are useful to you, and can be provided by
your OP in the form of claims. At a <em>minimum</em>, the <code class="literal">principal</code> user property
is required.
</li>
<li class="listitem">
<p>Configure your OP to "release" those claims to your Elastic Stack Relying
party. This process greatly varies by provider. You can use a static
configuration while others will support that the RP requests the scopes that
correspond to the claims to be "released" on authentication time. See
<a class="xref" href="security-settings.html#ref-oidc-settings" title="OpenID Connect realm settings"><code class="literal">rp.requested_scopes</code></a> for details about how
to configure the scopes to request. To ensure interoperability and minimize
the errors, you should only request scopes that the OP supports, and which you
intend to map to Elasticsearch user properties.</p>
<pre class="literallayout">NOTE: You can only map claims with values that are strings, numbers, boolean values or an array
of the aforementioned.</pre>

</li>
<li class="listitem">
<p>Configure the OpenID Connect realm in Elasticsearch to associate the Elasticsearch user properties (see
<a class="xref" href="oidc-guide.html#oidc-user-properties" title="Elasticsearch user properties">the listing</a> below), to the name of the claims that your
OP will release. In the example above, we have configured the <code class="literal">principal</code> and
<code class="literal">groups</code> user properties as follows:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<code class="literal">claims.principal: sub</code> : This instructs Elasticsearch to look for the OpenID Connect claim named <code class="literal">sub</code>
in the ID Token that the OP issued for the user ( or in the UserInfo response ) and assign the
value of this claim to the <code class="literal">principal</code> user property. <code class="literal">sub</code> is a commonly used claim for the
principal property as it is an identifier of the user in the OP and it is also a required
claim of the ID Token, thus offering guarantees that it will be available. It is, however,
only used as an example here, the OP may provide another claim that is a better fit for your needs.
</li>
<li class="listitem">
<code class="literal">claims.groups: "http://example.info/claims/groups"</code> : Similarly, this instructs Elasticsearch to look
for the claim with the name <code class="literal">http://example.info/claims/groups</code> (note that this is a URI - an
identifier, treated as a string and not a URL pointing to a location that will be retrieved)
either in the ID Token or in the UserInfo response, and map the value(s) of it to the user
property <code class="literal">groups</code> in Elasticsearch. There is no standard claim in the specification that is used for
expressing roles or group memberships of the authenticated user in the OP, so the name of the
claim that should be mapped here, will vary greatly between providers. Consult your OP
documentation for more details.
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="oidc-user-properties"></a>Elasticsearch user properties<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>The Elasticsearch OpenID Connect realm can be configured to map OpenID Connect claims to the
following properties on the authenticated user:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
principal
</span>
</dt>
<dd>
<em>(Required)</em>
This is the <em>username</em> that will be applied to a user that authenticates
against this realm.
The <code class="literal">principal</code> appears in places such as the Elasticsearch audit logs.
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If the principal property fails to be mapped from a claim, the authentication fails.</p>
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
groups
</span>
</dt>
<dd>
<em>(Recommended)</em>
If you wish to use your OP&#8217;s concept of groups or roles as the basis for a
user&#8217;s Elasticsearch privileges, you should map them with this property.
The <code class="literal">groups</code> are passed directly to your <a class="xref" href="oidc-guide.html#oidc-role-mappings" title="Configuring role mappings">role mapping rules</a>.
</dd>
<dt>
<span class="term">
name
</span>
</dt>
<dd>
<em>(Optional)</em> The user&#8217;s full name.
</dd>
<dt>
<span class="term">
mail
</span>
</dt>
<dd>
<em>(Optional)</em> The user&#8217;s email address.
</dd>
<dt>
<span class="term">
dn
</span>
</dt>
<dd>
<em>(Optional)</em> The user&#8217;s X.500 <em>Distinguished Name</em>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_extracting_partial_values_from_openid_connect_claims"></a>Extracting partial values from OpenID Connect claims<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>There are some occasions where the value of a claim may contain more information
than you wish to use within Elasticsearch. A common example of this is one where the
OP works exclusively with email addresses, but you would like the user&#8217;s
<code class="literal">principal</code> to use the <em>local-name</em> part of the email address.
For example if their email address was <code class="literal">james.wong@staff.example.com</code>, then you
would like their principal to simply be <code class="literal">james.wong</code>.</p>
<p>This can be achieved using the <code class="literal">claim_patterns</code> setting in the Elasticsearch
realm, as demonstrated in the realm configuration below:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.oidc.oidc1:
  order: 2
  rp.client_id: "the_client_id"
  rp.response_type: code
  rp.redirect_uri: "https://kibana.example.org:5601/api/security/oidc/callback"
  op.authorization_endpoint: "https://op.example.org/oauth2/v1/authorize"
  op.token_endpoint: "https://op.example.org/oauth2/v1/token"
  op.userinfo_endpoint: "https://op.example.org/oauth2/v1/userinfo"
  op.endsession_endpoint: "https://op.example.org/oauth2/v1/logout"
  op.issuer: "https://op.example.org"
  op.jwkset_path: oidc/jwkset.json
  claims.principal: email_verified
  claim_patterns.principal: "^([^@]+)@staff\\.example\\.com$"</pre>
</div>
<p>In this case, the user&#8217;s <code class="literal">principal</code> is mapped from the <code class="literal">email_verified</code> claim, but a
regular expression is applied to the value before it is assigned to the user.
If the regular expression matches, then the result of the first group is used as the
effective value. If the regular expression does not match then the claim
mapping fails.</p>
<p>In this example, the email address must belong to the <code class="literal">staff.example.com</code> domain,
and then the local-part (anything before the <code class="literal">@</code>) is used as the principal.
Any users who try to login using a different email domain will fail because the
regular expression will not match against their email address, and thus their
principal user property - which is mandatory - will not be populated.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Small mistakes in these regular expressions can have significant
security consequences. For example, if we accidentally left off the trailing
<code class="literal">$</code> from the example above, then we would match any email address where the
domain starts with <code class="literal">staff.example.com</code>, and this would accept an email
address such as <code class="literal">admin@staff.example.com.attacker.net</code>. It is important that
you make sure your regular expressions are as precise as possible so that
you do not inadvertently open an avenue for user impersonation attacks.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="third-party-login"></a>Third party initiated single sign-on<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The Open ID Connect realm in Elasticsearch supports 3rd party initiated login as described in the
<a href="https://openid.net/specs/openid-connect-core-1_0.html#ThirdPartyInitiatedLogin" class="ulink" target="_top">relevant specification</a>.</p>
<p>This allows the OP itself or another, third party other than the RP, to initiate the authentication
process while requesting the OP to be used for the authentication. Please note that the Elastic
Stack RP should already be configured for this OP, in order for this process to succeed.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="oidc-logout"></a>OpenID Connect Logout<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The OpenID Connect realm in Elasticsearch supports RP-Initiated Logout Functionality as
described in the
<a href="https://openid.net/specs/openid-connect-session-1_0.html#RPLogout" class="ulink" target="_top">relevant part of the specification</a></p>
<p>In this process, the OpenID Connect RP (the Elastic Stack in this case) will redirect the user&#8217;s
browser to predefined URL of the OP after successfully completing a local logout. The OP can then
logout the user also, depending on the configuration, and should finally redirect the user back to the
RP. The <code class="literal">op.endsession_endpoint</code> in the realm configuration determines the URL in the OP that the browser
will be redirected to. The <code class="literal">rp.post_logout_redirect_uri</code> setting determines the URL to redirect
the user back to after the OP logs them out.</p>
<p>When configuring <code class="literal">rp.post_logout_redirect_uri</code>, care should be taken to not point this to a URL that
will trigger re-authentication of the user. For instance, when using OpenID Connect to support
single sign-on to Kibana, this could be set to either <code class="literal">${kibana-url}/security/logged_out</code>, which will show a
user-friendly message to the user or <code class="literal">${kibana-url}/login?msg=LOGGED_OUT</code> which will take the user to the login selector in Kibana.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="oidc-ssl-config"></a>OpenID Connect Realm SSL Configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>OpenID Connect depends on TLS to provide security properties such as encryption in transit and endpoint authentication. The RP
is required to establish back-channel communication with the OP in order to exchange the code for an ID Token during the
Authorization code grant flow and in order to get additional user information from the UserInfo endpoint. Furthermore, if
you configure <code class="literal">op.jwks_path</code> as a URL, Elasticsearch will need to get the OP&#8217;s signing keys from the file hosted there. As such, it is
important that Elasticsearch can validate and trust the server certificate that the OP uses for TLS. Since the system truststore is
used for the client context of outgoing https connections, if your OP is using a certificate from a trusted CA, no additional
configuration is needed.</p>
<p>However, if the issuer of your OP&#8217;s certificate is not trusted by the JVM on which Elasticsearch is running (e.g it uses a organization CA), then you must configure
Elasticsearch to trust that CA. Assuming that you have the CA certificate that has signed the certificate that the OP uses for TLS
stored in the /oidc/company-ca.pem` file stored in the configuration directory of Elasticsearch, you need to set the following
property in the realm configuration:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.oidc.oidc1:
  order: 1
  ...
  ssl.certificate_authorities: ["/oidc/company-ca.pem"]</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="oidc-role-mappings"></a>Configuring role mappings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>When a user authenticates using OpenID Connect, they are identified to the Elastic Stack,
but this does not automatically grant them access to perform any actions or
access any data.</p>
<p>Your OpenID Connect users cannot do anything until they are assigned roles. This can be done
through either the
<a class="xref" href="security-api-put-role-mapping.html" title="Create or update role mappings API">add role mapping API</a> or with
<a class="xref" href="realm-chains.html#authorization_realms" title="Delegating authorization to another realm">authorization realms</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You cannot use <a class="xref" href="mapping-roles.html#mapping-roles-file" title="Using role mapping files">role mapping files</a>
to grant roles to users authenticating via OpenID Connect.</p>
</div>
</div>
<p>This is an example of a simple role mapping that grants the <code class="literal">example_role</code> role
to any user who authenticates against the <code class="literal">oidc1</code> OpenID Connect realm:</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.putRoleMapping({
  name: "oidc-example",
  roles: ["example_role"],
  enabled: true,
  rules: {
    field: {
      "realm.name": "oidc1",
    },
  },
});
console.log(response);</pre>
</div>
<a id="10de9fd4a38755020a07c4ec964d44c9"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">PUT /_security/role_mapping/oidc-example
{
  "roles": [ "example_role" ], <a id="CO651-1"></a><i class="conum" data-value="1"></i>
  "enabled": true,
  "rules": {
    "field": { "realm.name": "oidc1" }
  }
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2029.console"></div>
<div class="calloutlist default has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO651-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">example_role</code> role is <span class="strong strong"><strong>not</strong></span> a builtin Elasticsearch role.
This example assumes that you have created a custom role of your own, with
appropriate access to your <a class="xref" href="defining-roles.html#roles-indices-priv" title="Indices privileges">data streams, indices,</a> and
<a href="/guide/en/kibana/master/kibana-privileges.html#kibana-feature-privileges" class="ulink" target="_top">Kibana features</a>.</p>
</td>
</tr>
</table>
</div>
<p>The user properties that are mapped via the realm configuration are used to process
role mapping rules, and these rules determine which roles a user is granted.</p>
<p>The user fields that are provided to the role
mapping are derived from the OpenID Connect claims as follows:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">username</code>: The <code class="literal">principal</code> user property
</li>
<li class="listitem">
<code class="literal">dn</code>: The <code class="literal">dn</code> user property
</li>
<li class="listitem">
<code class="literal">groups</code>: The <code class="literal">groups</code> user property
</li>
<li class="listitem">
<code class="literal">metadata</code>: See <a class="xref" href="oidc-guide.html#oidc-user-metadata" title="User metadata">User metadata</a>
</li>
</ul>
</div>
<p>For more information, see <a class="xref" href="mapping-roles.html" title="Mapping users and groups to roles">Mapping users and groups to roles</a> and
<a class="xref" href="security-api.html#security-role-mapping-apis" title="Role mappings">Role mappings</a>.</p>
<p>If your OP has the ability to provide groups or roles to RPs via tha use of
an OpenID Claim, then you should map this claim to the <code class="literal">claims.groups</code> setting in
the Elasticsearch realm (see <a class="xref" href="oidc-guide.html#oidc-claim-to-property" title="Mapping claims to user properties">Mapping claims to user properties</a>), and then make use of it in a role mapping
as per the example below.</p>
<p>This mapping grants the Elasticsearch <code class="literal">finance_data</code> role, to any users who authenticate
via the <code class="literal">oidc1</code> realm with the <code class="literal">finance-team</code> group membership.</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.putRoleMapping({
  name: "oidc-finance",
  roles: ["finance_data"],
  enabled: true,
  rules: {
    all: [
      {
        field: {
          "realm.name": "oidc1",
        },
      },
      {
        field: {
          groups: "finance-team",
        },
      },
    ],
  },
});
console.log(response);</pre>
</div>
<a id="f3ab820e1f2f54ea718017aeae865742"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">PUT /_security/role_mapping/oidc-finance
{
  "roles": [ "finance_data" ],
  "enabled": true,
  "rules": { "all": [
        { "field": { "realm.name": "oidc1" } },
        { "field": { "groups": "finance-team" } }
  ] }
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2030.console"></div>
<p>If your users also exist in a repository that can be directly accessed by Elasticsearch
(such as an LDAP directory) then you can use
<a class="xref" href="realm-chains.html#authorization_realms" title="Delegating authorization to another realm">authorization realms</a> instead of role mappings.</p>
<p>In this case, you perform the following steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In your OpenID Connect realm, assign a claim to act as the lookup userid,
by configuring the <code class="literal">claims.principal</code> setting.
</li>
<li class="listitem">
Create a new realm that can look up users from your local repository (e.g. an
<code class="literal">ldap</code> realm)
</li>
<li class="listitem">
In your OpenID Connect realm, set <code class="literal">authorization_realms</code> to the name of the
realm you created in step 2.
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="oidc-user-metadata"></a>User metadata<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>By default users who authenticate via OpenID Connect will have some additional metadata
fields. These fields will include every OpenID Claim that is provided in the authentication response
(regardless of whether it is mapped to an Elasticsearch user property). For example,
in the metadata field <code class="literal">oidc(claim_name)</code>, "claim_name" is the name of the
claim as it was contained in the ID Token or in the User Info response. Note that these will
include all the <a href="https://openid.net/specs/openid-connect-core-1_0.html#IDToken" class="ulink" target="_top">ID Token claims</a>
that pertain to the authentication event, rather than the user themselves.</p>
<p>This behaviour can be disabled by adding <code class="literal">populate_user_metadata: false</code> as
a setting in the oidc realm.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="oidc-configure-kibana"></a>Configuring Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>OpenID Connect authentication in Kibana requires a small number of additional settings
in addition to the standard Kibana security configuration. The
<a href="/guide/en/kibana/master/using-kibana-with-security.html" class="ulink" target="_top">Kibana security documentation</a>
provides details on the available configuration options that you can apply.</p>
<p>In particular, since your Elasticsearch nodes have been configured to use TLS on the HTTP
interface, you must configure Kibana to use a <code class="literal">https</code> URL to connect to Elasticsearch, and
you may need to configure <code class="literal">elasticsearch.ssl.certificateAuthorities</code> to trust
the certificates that Elasticsearch has been configured to use.</p>
<p>OpenID Connect authentication in Kibana is subject to the following timeout settings in
<code class="literal">kibana.yml</code>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="/guide/en/kibana/master/xpack-security-session-management.html#session-idle-timeout" class="ulink" target="_top"><code class="literal">xpack.security.session.idleTimeout</code></a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/master/xpack-security-session-management.html#session-lifespan" class="ulink" target="_top"><code class="literal">xpack.security.session.lifespan</code></a>
</li>
</ul>
</div>
<p>You may want to adjust these timeouts based on your security requirements.</p>
<p>The three additional settings that are required for OpenID Connect support are shown below:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.providers:
  oidc.oidc1:
    order: 0
    realm: "oidc1"</pre>
</div>
<p>The configuration values used in the example above are:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">xpack.security.authc.providers</code>
</span>
</dt>
<dd>
Add <code class="literal">oidc</code> provider to instruct Kibana to use OpenID Connect single sign-on as the
authentication method. This instructs Kibana to attempt to initiate an SSO flow
everytime a user attempts to access a URL in Kibana, if the user is not already
authenticated. If you also want to allow users to login with a username and password,
you must enable the <code class="literal">basic</code> authentication provider too. For example:
</dd>
</dl>
</div>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.providers:
  oidc.oidc1:
    order: 0
    realm: "oidc1"
  basic.basic1:
    order: 1</pre>
</div>
<p>This will allow users that haven&#8217;t already authenticated with OpenID Connect to
log in using the Kibana login form.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">xpack.security.authc.providers.oidc.&lt;provider-name&gt;.realm</code>
</span>
</dt>
<dd>
The name of the OpenID Connect realm in Elasticsearch that should handle authentication
for this Kibana instance.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="oidc-without-kibana"></a>OpenID Connect without Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>The OpenID Connect realm is designed to allow users to authenticate to Kibana and as
such, most of the parts of the guide above make the assumption that Kibana is used.
This section describes how a custom web application could use the relevant OpenID
Connect REST APIs in order to authenticate the users to Elasticsearch, with OpenID Connect.</p>
<p>Single sign-on realms such as OpenID Connect and SAML make use of the Token Service in
Elasticsearch and in principle exchange a SAML or OpenID Connect Authentication response for
an Elasticsearch access token and a refresh token. The access token is used as credentials for subsequent calls to Elasticsearch. The
refresh token enables the user to get new Elasticsearch access tokens after the current one
expires.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The Elasticsearch Token Service can be seen as a minimal oAuth2 authorization server
and the access token and refresh token mentioned above are tokens that pertain
<em>only</em> to this authorization server. They are generated and consumed <em>only</em> by Elasticsearch
and are in no way related to the tokens ( access token and ID Token ) that the
OpenID Connect Provider issues.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_register_the_rp_with_an_openid_connect_provider"></a>Register the RP with an OpenID Connect Provider<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The Relying Party ( Elasticsearch and the custom web app ) will need to be registered as
client with the OpenID Connect Provider. Note that when registering the
<code class="literal">Redirect URI</code>, it needs to be a URL in the custom web app.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_openid_connect_realm"></a>OpenID Connect Realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>An OpenID Connect realm needs to be created and configured accordingly
in Elasticsearch. See <a class="xref" href="oidc-guide.html#oidc-elasticsearch-authentication" title="Configure Elasticsearch for OpenID Connect authentication">Configure Elasticsearch for OpenID Connect authentication</a></p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_service_account_user_for_accessing_the_apis"></a>Service Account user for accessing the APIs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The realm is designed with the assumption that there needs to be a privileged entity
acting as an authentication proxy. In this case, the custom web application is the
authentication proxy handling the authentication of end users ( more correctly,
"delegating" the authentication to the OpenID Connect Provider ). The OpenID Connect
APIs require authentication and the necessary authorization level for the authenticated
user. For this reason, a Service Account user needs to be created and assigned a role
that gives them the <code class="literal">manage_oidc</code> cluster privilege. The use of the <code class="literal">manage_token</code>
cluster privilege will be necessary after the authentication takes place, so that the
user can maintain access or be subsequently logged out.</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.putRole({
  name: "facilitator-role",
  cluster: ["manage_oidc", "manage_token"],
});
console.log(response);</pre>
</div>
<a id="a325f31e94fb1e8739258910593504a8"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /_security/role/facilitator-role
{
  "cluster" : ["manage_oidc", "manage_token"]
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2031.console"></div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.putUser({
  username: "facilitator",
  password: "&lt;somePasswordHere&gt;",
  roles: ["facilitator-role"],
});
console.log(response);</pre>
</div>
<a id="53e4ac5a4009fd21024f4b31e54aa83f"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /_security/user/facilitator
{
  "password" : "&lt;somePasswordHere&gt;",
  "roles"    : [ "facilitator-role"]
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2032.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_handling_the_authentication_flow"></a>Handling the authentication flow<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>On a high level, the custom web application would need to perform the following steps in order to
authenticate a user with OpenID Connect:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Make an HTTP POST request to <code class="literal">_security/oidc/prepare</code>, authenticating as the <code class="literal">facilitator</code> user, using the name of the
OpenID Connect realm in the Elasticsearch configuration in the request body. For more
details, see
<a class="xref" href="security-api-oidc-prepare-authentication.html" title="OpenID Connect prepare authentication API">OpenID Connect prepare authentication</a>.</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.oidcPrepareAuthentication({});
console.log(response);</pre>
</div>
<a id="e3019fd5f23458ae49ad9854c97d321c"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /_security/oidc/prepare
{
  "realm" : "oidc1"
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2033.console"></div>
</li>
<li class="listitem">
Handle the response to <code class="literal">/_security/oidc/prepare</code>. The response from Elasticsearch will contain 3 parameters:
<code class="literal">redirect</code>, <code class="literal">state</code>, <code class="literal">nonce</code>. The custom web application would need to store the values for <code class="literal">state</code>
and <code class="literal">nonce</code> in the user&#8217;s session (client side in a cookie or server side if session information is
 persisted this way) and redirect the user&#8217;s browser to the URL that will be contained in the
<code class="literal">redirect</code> value.
</li>
<li class="listitem">
<p>Handle a subsequent response from the OP. After the user is successfully authenticated with the
OpenID Connect Provider, they will be redirected back to the callback/redirect URI. Upon receiving
this HTTP GET request, the custom web app will need to make an HTTP POST request to
<code class="literal">_security/oidc/authenticate</code>, again - authenticating as the <code class="literal">facilitator</code> user - passing the URL
where the user&#8217;s browser was redirected to, as a parameter, along with the
values for <code class="literal">nonce</code> and <code class="literal">state</code> it had saved in the user&#8217;s session previously. If more than one
OpenID Connect realms are configured, the custom web app can specify the name of the realm to be
used for handling this, but this parameter is optional. For more details, see
<a class="xref" href="security-api-oidc-authenticate.html" title="OpenID Connect authenticate API">OpenID Connect authenticate</a>.</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.oidcAuthenticate({});
console.log(response);</pre>
</div>
<a id="9c01db07c9ac395b6370e3b33965c21f"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /_security/oidc/authenticate
{
  "redirect_uri" : "https://oidc-kibana.elastic.co:5603/api/security/oidc/callback?code=jtI3Ntt8v3_XvcLzCFGq&amp;state=4dbrihtIAt3wBTwo6DxK-vdk-sSyDBV8Yf0AjdkdT5I",
  "state" : "4dbrihtIAt3wBTwo6DxK-vdk-sSyDBV8Yf0AjdkdT5I",
  "nonce" : "WaBPH0KqPVdG5HHdSxPRjfoZbXMCicm5v1OiAj0DUFM",
  "realm" : "oidc1"
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2034.console"></div>
<p>Elasticsearch will validate this and if all is correct will respond with an access token that can be used
as a <code class="literal">Bearer</code> token for subsequent requests and a refresh token that can be later used to refresh the given
access token as described in <a class="xref" href="security-api-get-token.html" title="Get token API">Get token</a>.</p>
</li>
<li class="listitem">
<p>At some point, if necessary, the custom web application can log the user out by using the
<a class="xref" href="security-api-oidc-logout.html" title="OpenID Connect logout API">OIDC logout API</a> passing the access token and refresh token as parameters. For example:</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.oidcLogout({});
console.log(response);</pre>
</div>
<a id="2a1eece9a59ac1773edcf0a932c26de0"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /_security/oidc/logout
{
  "token" : "dGhpcyBpcyBub3QgYSByZWFsIHRva2VuIGJ1dCBpdCBpcyBvbmx5IHRlc3QgZGF0YS4gZG8gbm90IHRyeSB0byByZWFkIHRva2VuIQ==",
  "refresh_token": "vLBPvmAB6KvwvJZr27cS"
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2035.console"></div>
<p>If the realm is configured accordingly, this may result in a response with a <code class="literal">redirect</code> parameter indicating where
the user needs to be redirected in the OP in order to complete the logout process.</p>
</li>
</ol>
</div>
</div>

</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="saml-guide-stack.html">« Configuring SAML single-sign-on on the Elastic Stack</a>
</span>
<span class="next">
<a href="authorization.html">User authorization »</a>
</span>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs-v1.js"></script>
    <script type="text/javascript">
  window.initial_state = {"alternatives":{"console":{"php":{"hasAny":true},"python":{"hasAny":true},"ruby":{"hasAny":true},"go":{"hasAny":true},"js":{"hasAny":true}}}}</script>
  </body>
</html>
