<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>S3 repository | Elasticsearch Guide [master] | Elastic</title>
<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="snapshots-register-repository.html" title="Register a snapshot repository"/>
<link rel="prev" href="repository-gcs.html" title="Google Cloud Storage repository"/>
<link rel="next" href="snapshots-filesystem-repository.html" title="Shared file system repository"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="snapshot-restore.html">Snapshot and restore</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="snapshots-register-repository.html">Register a snapshot repository</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="repository-gcs.html">« Google Cloud Storage repository</a>
</span>
<span class="next">
<a href="snapshots-filesystem-repository.html">Shared file system repository »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="repository-s3"></a>S3 repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h2>
</div></div></div>
<p>You can use AWS S3 as a repository for <a href="/guide/en/elasticsearch/reference/master/modules-snapshots.html" class="ulink" target="_top">Snapshot/Restore</a>.</p>
<p><span class="strong strong"><strong>If you are looking for a hosted solution of Elasticsearch on AWS, please visit
<a href="/cloud/" class="ulink" target="_top">https://www.elastic.co/cloud/</a>.</strong></span></p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-s3-usage"></a>Getting started<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h3>
</div></div></div>
<p>To register an S3 repository, specify the type as <code class="literal">s3</code> when creating
the repository. The repository defaults to using
<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-iam-roles.html" class="ulink" target="_top">ECS
IAM Role</a> credentials for authentication. You can also use <a class="xref" href="repository-s3.html#iam-kubernetes-service-accounts" title="Using IAM roles for Kubernetes service accounts for authentication">Using IAM roles for Kubernetes service accounts for authentication</a> Kubernetes service accounts.</p>
<p>The only mandatory setting is the bucket name:</p>
<a id="7de7e647c1c9cbe0a1df0d104fc0a947"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_s3_repository
{
  "type": "s3",
  "settings": {
    "bucket": "my-bucket"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1583.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-s3-client"></a>Client settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h3>
</div></div></div>
<p>The client that you use to connect to S3 has a number of settings available.
The settings have the form <code class="literal">s3.client.CLIENT_NAME.SETTING_NAME</code>. By default,
<code class="literal">s3</code> repositories use a client named <code class="literal">default</code>, but this can be modified using
the <a class="xref" href="repository-s3.html#repository-s3-repository" title="Repository settings">repository setting</a> <code class="literal">client</code>. For example:</p>
<a id="0da747e9d98bae157d3520ff1b489ad4"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_s3_repository
{
  "type": "s3",
  "settings": {
    "bucket": "my-bucket",
    "client": "my-alternate-client"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1584.console"></div>
<p>Most client settings can be added to the <code class="literal">elasticsearch.yml</code> configuration file
with the exception of the secure settings, which you add to the Elasticsearch keystore.
For more information about creating and updating the Elasticsearch keystore, see
<a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">Secure settings</a>.</p>
<p>For example, if you want to use specific credentials to access S3 then run the
following commands to add these credentials to the keystore:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-keystore add s3.client.default.access_key
bin/elasticsearch-keystore add s3.client.default.secret_key
# a session token is optional so the following command may not be needed
bin/elasticsearch-keystore add s3.client.default.session_token</pre>
</div>
<p>If instead you want to use the instance role or container role to access S3
then you should leave these settings unset. You can switch from using specific
credentials back to the default of using the instance role or container role by
removing these settings from the keystore as follows:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-keystore remove s3.client.default.access_key
bin/elasticsearch-keystore remove s3.client.default.secret_key
# a session token is optional so the following command may not be needed
bin/elasticsearch-keystore remove s3.client.default.session_token</pre>
</div>
<p><span class="strong strong"><strong>All</strong></span> client secure settings of this repository type are
<a href="/guide/en/elasticsearch/reference/master/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>. After you
reload the settings, the internal <code class="literal">s3</code> clients, used to transfer the snapshot
contents, will utilize the latest settings from the keystore. Any existing <code class="literal">s3</code>
repositories, as well as any newly created ones, will pick up the new values
stored in the keystore.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In-progress snapshot/restore tasks will not be preempted by a <span class="strong strong"><strong>reload</strong></span> of
the client&#8217;s secure settings. The task will complete using the client as it was
built when the operation started.</p>
</div>
</div>
<p>The following list contains the available client settings. Those that must be
stored in the keystore are marked as "secure" and are <span class="strong strong"><strong>reloadable</strong></span>; the other
settings belong in the <code class="literal">elasticsearch.yml</code> file.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">access_key</code> (<a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="/guide/en/elasticsearch/reference/master/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
An S3 access key. If set, the <code class="literal">secret_key</code> setting must also be specified.
If unset, the client will use the instance or container role instead.
</dd>
<dt>
<span class="term">
<code class="literal">secret_key</code> (<a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="/guide/en/elasticsearch/reference/master/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
An S3 secret key. If set, the <code class="literal">access_key</code> setting must also be specified.
</dd>
<dt>
<span class="term">
<code class="literal">session_token</code> (<a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="/guide/en/elasticsearch/reference/master/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
An S3 session token. If set, the <code class="literal">access_key</code> and <code class="literal">secret_key</code> settings
must also be specified.
</dd>
<dt>
<span class="term">
<code class="literal">endpoint</code>
</span>
</dt>
<dd>
The S3 service endpoint to connect to. This defaults to <code class="literal">s3.amazonaws.com</code>
but the
<a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region" class="ulink" target="_top">AWS
documentation</a> lists alternative S3 endpoints. If you are using an
<a class="xref" href="repository-s3.html#repository-s3-compatible-services" title="S3-compatible services">S3-compatible service</a> then you should
set this to the service&#8217;s endpoint.
</dd>
<dt>
<span class="term">
<code class="literal">protocol</code>
</span>
</dt>
<dd>
The protocol to use to connect to S3. Valid values are either <code class="literal">http</code> or
<code class="literal">https</code>. Defaults to <code class="literal">https</code>. When using HTTPS, this repository type validates the
repository&#8217;s certificate chain using the JVM-wide truststore. Ensure that
the root certificate authority is in this truststore using the JVM&#8217;s
<code class="literal">keytool</code> tool.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.host</code>
</span>
</dt>
<dd>
The host name of a proxy to connect to S3 through.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.port</code>
</span>
</dt>
<dd>
The port of a proxy to connect to S3 through.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.username</code> (<a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="/guide/en/elasticsearch/reference/master/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
The username to connect to the <code class="literal">proxy.host</code> with.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.password</code> (<a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="/guide/en/elasticsearch/reference/master/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
The password to connect to the <code class="literal">proxy.host</code> with.
</dd>
<dt>
<span class="term">
<code class="literal">read_timeout</code>
</span>
</dt>
<dd>
The socket timeout for connecting to S3. The value should specify the unit.
For example, a value of <code class="literal">5s</code> specifies a 5 second timeout. The default value
is 50 seconds.
</dd>
<dt>
<span class="term">
<code class="literal">max_retries</code>
</span>
</dt>
<dd>
The number of retries to use when an S3 request fails. The default value is
<code class="literal">3</code>.
</dd>
<dt>
<span class="term">
<code class="literal">use_throttle_retries</code>
</span>
</dt>
<dd>
Whether retries should be throttled (i.e. should back off). Must be <code class="literal">true</code>
or <code class="literal">false</code>. Defaults to <code class="literal">true</code>.
</dd>
<dt>
<span class="term">
<code class="literal">path_style_access</code>
</span>
</dt>
<dd>
Whether to force the use of the path style access pattern. If <code class="literal">true</code>, the
path style access pattern will be used. If <code class="literal">false</code>, the access pattern will
be automatically determined by the AWS Java SDK (See
<a href="https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/services/s3/AmazonS3Builder.html#setPathStyleAccessEnabled-java.lang.Boolean-" class="ulink" target="_top">AWS
documentation</a> for details). Defaults to <code class="literal">false</code>.
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<a id="repository-s3-path-style-deprecation"></a>
<p>In versions <code class="literal">7.0</code>, <code class="literal">7.1</code>, <code class="literal">7.2</code> and <code class="literal">7.3</code> all bucket operations used the
<a href="https://aws.amazon.com/blogs/aws/amazon-s3-path-deprecation-plan-the-rest-of-the-story/" class="ulink" target="_top">now-deprecated</a>
path style access pattern. If your deployment requires the path style access
pattern then you should set this setting to <code class="literal">true</code> when upgrading.</p>
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">disable_chunked_encoding</code>
</span>
</dt>
<dd>
Whether chunked encoding should be disabled or not. If <code class="literal">false</code>, chunked
encoding is enabled and will be used where appropriate. If <code class="literal">true</code>, chunked
encoding is disabled and will not be used, which may mean that snapshot
operations consume more resources and take longer to complete. It should
only be set to <code class="literal">true</code> if you are using a storage service that does not
support chunked encoding. See the
<a href="https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/services/s3/AmazonS3Builder.html#disableChunkedEncoding--" class="ulink" target="_top">AWS
Java SDK documentation</a> for details. Defaults to <code class="literal">false</code>.
</dd>
<dt>
<span class="term">
<code class="literal">region</code>
</span>
</dt>
<dd>
Allows specifying the signing region to use. Specificing this setting manually should not be necessary for most use cases. Generally,
the SDK will correctly guess the signing region to use. It should be considered an expert level setting to support S3-compatible APIs
that require <a href="https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html" class="ulink" target="_top">v4 signatures</a> and use a region other than the
default <code class="literal">us-east-1</code>. Defaults to empty string which means that the SDK will try to automatically determine the correct signing region.
</dd>
<dt>
<span class="term">
<code class="literal">signer_override</code>
</span>
</dt>
<dd>
Allows specifying the name of the signature algorithm to use for signing requests by the S3 client. Specifying this setting should not
be necessary for most use cases. It should be considered an expert level setting to support S3-compatible APIs that do not support the
signing algorithm that the SDK automatically determines for them.
See the
<a href="https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/ClientConfiguration.html#setSignerOverride-java.lang.String-" class="ulink" target="_top">AWS
Java SDK documentation</a> for details. Defaults to empty string which means that no signing algorithm override will be used.
</dd>
</dl>
</div>
<h5><a id="repository-s3-compatible-services"></a>S3-compatible services<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h5>
<p>There are a number of storage systems that provide an S3-compatible API, and
the <code class="literal">repository-s3</code> type allows you to use these systems in place of AWS S3.
To do so, you should set the <code class="literal">s3.client.CLIENT_NAME.endpoint</code> setting to the
system&#8217;s endpoint. This setting accepts IP addresses and hostnames and may
include a port. For example, the endpoint may be <code class="literal">172.17.0.2</code> or
<code class="literal">172.17.0.2:9000</code>.</p>
<p>By default Elasticsearch communicates with your storage system using HTTPS, and
validates the repository&#8217;s certificate chain using the JVM-wide truststore.
Ensure that the JVM-wide truststore includes an entry for your repository. If
you wish to use unsecured HTTP communication instead of HTTPS, set
<code class="literal">s3.client.CLIENT_NAME.protocol</code> to <code class="literal">http</code>.</p>
<p><a href="https://minio.io" class="ulink" target="_top">MinIO</a> is an example of a storage system that provides an
S3-compatible API. The <code class="literal">repository-s3</code> type allows Elasticsearch to work with
MinIO-backed repositories as well as repositories stored on AWS S3. Other
S3-compatible storage systems may also work with Elasticsearch, but these are not
covered by the Elasticsearch test suite.</p>
<p>Note that some storage systems claim to be S3-compatible but do not faithfully
emulate S3&#8217;s behaviour in full. The <code class="literal">repository-s3</code> type requires full
compatibility with S3. In particular it must support the same set of API
endpoints, return the same errors in case of failures, and offer consistency
and performance at least as good as S3 even when accessed concurrently by
multiple nodes. Incompatible error codes, consistency or performance may be
particularly hard to track down since errors, consistency failures, and
performance issues are usually rare and hard to reproduce.</p>
<p>You can perform some basic checks of the suitability of your storage system
using the <a href="/guide/en/elasticsearch/reference/master/repo-analysis-api.html" class="ulink" target="_top">repository analysis API</a>. If this API
does not complete successfully, or indicates poor performance, then your
storage system is not fully compatible with AWS S3 and therefore unsuitable for
use as a snapshot repository. You will need to work with the supplier of your
storage system to address any incompatibilities you encounter.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-s3-repository"></a>Repository settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">s3</code> repository type supports a number of settings to customize how data is
stored in S3. These can be specified when creating the repository. For example:</p>
<a id="af607715d0693587dd12962266359a96"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_s3_repository
{
  "type": "s3",
  "settings": {
    "bucket": "my-bucket",
    "another_setting": "setting-value"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1585.console"></div>
<p>The following settings are supported:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">bucket</code>
</span>
</dt>
<dd>
<p>
(Required)
Name of the S3 bucket to use for snapshots.
</p>
<p>The bucket name must adhere to Amazon&#8217;s
<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/BucketRestrictions.html#bucketnamingrules" class="ulink" target="_top">S3
bucket naming rules</a>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">client</code>
</span>
</dt>
<dd>
The name of the <a class="xref" href="repository-s3.html#repository-s3-client" title="Client settings">S3 client</a> to use to connect to S3.
Defaults to <code class="literal">default</code>.
</dd>
<dt>
<span class="term">
<code class="literal">base_path</code>
</span>
</dt>
<dd>
<p>
Specifies the path to the repository data within its bucket. Defaults to an
empty string, meaning that the repository is at the root of the bucket. The
value of this setting should not start or end with a <code class="literal">/</code>.
</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Don&#8217;t set <code class="literal">base_path</code> when configuring a snapshot repository for Elastic Cloud Enterprise.
Elastic Cloud Enterprise automatically generates the <code class="literal">base_path</code> for each deployment so that
multiple deployments may share the same bucket.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">chunk_size</code>
</span>
</dt>
<dd>
Big files can be broken down into chunks during snapshotting if needed.
Specify the chunk size as a value and unit, for example:
<code class="literal">1TB</code>, <code class="literal">1GB</code>, <code class="literal">10MB</code>. Defaults to the maximum size of a blob in the S3 which is <code class="literal">5TB</code>.
</dd>
<dt>
<span class="term">
<code class="literal">compress</code>
</span>
</dt>
<dd>
When set to <code class="literal">true</code> metadata files are stored in compressed format. This
setting doesn&#8217;t affect index files that are already compressed by default.
Defaults to <code class="literal">true</code>.
</dd>
<dt>
<span class="term">
<code class="literal">max_restore_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot restore rate per node. Defaults to unlimited. Note
that restores are also throttled through <a class="xref" href="recovery.html" title="Index recovery settings">recovery settings</a>.
</dd>
<dt>
<span class="term">
<code class="literal">max_snapshot_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot creation rate per node. Defaults to <code class="literal">40mb</code> per second.
</dd>
</dl>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">readonly</code>
</span>
</dt>
<dd>
<p>
(Optional, Boolean)
If <code class="literal">true</code>, the repository is read-only. The cluster can retrieve and restore
snapshots from the repository but not write to the repository or create
snapshots in it.
</p>
<p>Only a cluster with write access can create snapshots in the repository. All
other clusters connected to the repository should have the <code class="literal">readonly</code> parameter
set to <code class="literal">true</code>.</p>
<p>If <code class="literal">false</code>, the cluster can write to the repository and create snapshots in it.
Defaults to <code class="literal">false</code>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you register the same snapshot repository with multiple clusters, only
one cluster should have write access to the repository. Having multiple clusters
write to the repository at the same time risks corrupting the contents of the
repository.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">server_side_encryption</code>
</span>
</dt>
<dd>
When set to <code class="literal">true</code> files are encrypted on server side using AES256
algorithm. Defaults to <code class="literal">false</code>.
</dd>
<dt>
<span class="term">
<code class="literal">buffer_size</code>
</span>
</dt>
<dd>
Minimum threshold below which the chunk is uploaded using a single request.
Beyond this threshold, the S3 repository will use the
<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/uploadobjusingmpu.html" class="ulink" target="_top">AWS
Multipart Upload API</a> to split the chunk into several parts, each of
<code class="literal">buffer_size</code> length, and to upload each part in its own request. Note that
setting a buffer size lower than <code class="literal">5mb</code> is not allowed since it will prevent
the use of the Multipart API and may result in upload errors. It is also not
possible to set a buffer size greater than <code class="literal">5gb</code> as it is the maximum upload
size allowed by S3. Defaults to <code class="literal">100mb</code> or <code class="literal">5%</code> of JVM heap, whichever is
smaller.
</dd>
<dt>
<span class="term">
<code class="literal">canned_acl</code>
</span>
</dt>
<dd>
The S3 repository supports all
<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html#canned-acl" class="ulink" target="_top">S3
canned ACLs</a> : <code class="literal">private</code>, <code class="literal">public-read</code>, <code class="literal">public-read-write</code>,
<code class="literal">authenticated-read</code>, <code class="literal">log-delivery-write</code>, <code class="literal">bucket-owner-read</code>,
<code class="literal">bucket-owner-full-control</code>. Defaults to <code class="literal">private</code>. You could specify a
canned ACL using the <code class="literal">canned_acl</code> setting. When the S3 repository creates
buckets and objects, it adds the canned ACL into the buckets and objects.
</dd>
<dt>
<span class="term">
<code class="literal">storage_class</code>
</span>
</dt>
<dd>
Sets the S3 storage class for objects stored in the snapshot repository.
Values may be <code class="literal">standard</code>, <code class="literal">reduced_redundancy</code>, <code class="literal">standard_ia</code>, <code class="literal">onezone_ia</code>
and <code class="literal">intelligent_tiering</code>. Defaults to <code class="literal">standard</code>.
Changing this setting on an existing repository only affects the
storage class for newly created objects, resulting in a mixed usage of
storage classes. Additionally, S3 Lifecycle Policies can be used to manage
the storage class of existing objects. Due to the extra complexity with the
Glacier class lifecycle, it is not currently supported by this
repository type. For more information about the different classes, see
<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/storage-class-intro.html" class="ulink" target="_top">AWS
Storage Classes Guide</a>
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The option of defining client settings in the repository settings as
documented below is considered deprecated, and will be removed in a future
version.</p>
</div>
</div>
<p>In addition to the above settings, you may also specify all non-secure client
settings in the repository settings. In this case, the client settings found in
the repository settings will be merged with those of the named client used by
the repository. Conflicts between client and repository settings are resolved
by the repository settings taking precedence over client settings.</p>
<p>For example:</p>
<a id="51b44224feee6e2e5974824334474c77"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_s3_repository
{
  "type": "s3",
  "settings": {
    "client": "my-client",
    "bucket": "my-bucket",
    "endpoint": "my.s3.endpoint"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1586.console"></div>
<p>This sets up a repository that uses all client settings from the client
<code class="literal">my_client_name</code> except for the <code class="literal">endpoint</code> that is overridden to
<code class="literal">my.s3.endpoint</code> by the repository settings.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="repository-s3-permissions"></a>Recommended S3 permissions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h4>
</div></div></div>
<p>In order to restrict the Elasticsearch snapshot process to the minimum required
resources, we recommend using Amazon IAM in conjunction with pre-existing S3
buckets. Here is an example policy which will allow the snapshot access to an S3
bucket named "snaps.example.com". This may be configured through the AWS IAM
console, by creating a Custom Policy, and using a Policy Document similar to
this (changing snaps.example.com to your bucket name).</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "Statement": [
    {
      "Action": [
        "s3:ListBucket",
        "s3:GetBucketLocation",
        "s3:ListBucketMultipartUploads",
        "s3:ListBucketVersions"
      ],
      "Effect": "Allow",
      "Resource": [
        "arn:aws:s3:::snaps.example.com"
      ]
    },
    {
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:AbortMultipartUpload",
        "s3:ListMultipartUploadParts"
      ],
      "Effect": "Allow",
      "Resource": [
        "arn:aws:s3:::snaps.example.com/*"
      ]
    }
  ],
  "Version": "2012-10-17"
}</pre>
</div>
<p>You may further restrict the permissions by specifying a prefix within the
bucket, in this example, named "foo".</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "Statement": [
    {
      "Action": [
        "s3:ListBucket",
        "s3:GetBucketLocation",
        "s3:ListBucketMultipartUploads",
        "s3:ListBucketVersions"
      ],
      "Condition": {
        "StringLike": {
          "s3:prefix": [
            "foo/*"
          ]
        }
      },
      "Effect": "Allow",
      "Resource": [
        "arn:aws:s3:::snaps.example.com"
      ]
    },
    {
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:AbortMultipartUpload",
        "s3:ListMultipartUploadParts"
      ],
      "Effect": "Allow",
      "Resource": [
        "arn:aws:s3:::snaps.example.com/foo/*"
      ]
    }
  ],
  "Version": "2012-10-17"
}</pre>
</div>
<p>The bucket needs to exist to register a repository for snapshots. If you did not
create the bucket then the repository registration will fail.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_cleaning_up_multi_part_uploads"></a>Cleaning up multi-part uploads<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h4>
</div></div></div>
<p>Elasticsearch uses S3&#8217;s multi-part upload process to upload larger blobs to the
repository. The multi-part upload process works by dividing each blob into
smaller parts, uploading each part independently, and then completing the
upload in a separate step. This reduces the amount of data that Elasticsearch must
re-send if an upload fails: Elasticsearch only needs to re-send the part that failed
rather than starting from the beginning of the whole blob. The storage for each
part is charged independently starting from the time at which the part was
uploaded.</p>
<p>If a multi-part upload cannot be completed then it must be aborted in order to
delete any parts that were successfully uploaded, preventing further storage
charges from accumulating. Elasticsearch will automatically abort a multi-part upload on
failure, but sometimes the abort request itself fails. For example, if the
repository becomes inaccessible or the instance on which Elasticsearch is running is
terminated abruptly then Elasticsearch cannot complete or abort any ongoing uploads.</p>
<p>You must make sure that failed uploads are eventually aborted to avoid
unnecessary storage costs. You can use the
<a href="https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListMultipartUploads.html" class="ulink" target="_top">List
multipart uploads API</a> to list the ongoing uploads and look for any which are
unusually long-running, or you can
<a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/mpu-abort-incomplete-mpu-lifecycle-config.html" class="ulink" target="_top">configure
a bucket lifecycle policy</a> to automatically abort incomplete uploads once they
reach a certain age.</p>
<h4><a id="repository-s3-aws-vpc"></a>AWS VPC bandwidth settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h4>
<p>AWS instances resolve S3 endpoints to a public IP. If the Elasticsearch
instances reside in a private subnet in an AWS VPC then all traffic to S3 will
go through the VPC&#8217;s NAT instance. If your VPC&#8217;s NAT instance is a smaller
instance size (e.g. a t2.micro) or is handling a high volume of network traffic
your bandwidth to S3 may be limited by that NAT instance&#8217;s networking bandwidth
limitations. Instead we recommend creating a <a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-endpoints.html" class="ulink" target="_top">VPC endpoint</a>
that enables connecting to S3 in instances that reside in a private subnet in
an AWS VPC. This will eliminate any limitations imposed by the network
bandwidth of your VPC&#8217;s NAT instance.</p>
<p>Instances residing in a public subnet in an AWS VPC will connect to S3 via the
VPC&#8217;s internet gateway and not be bandwidth limited by the VPC&#8217;s NAT instance.</p>
<h4><a id="iam-kubernetes-service-accounts"></a>Using IAM roles for Kubernetes service accounts for authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h4>
<p>If you want to use <a href="https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/" class="ulink" target="_top">Kubernetes service accounts</a>
for authentication, you need to add a symlink to the <code class="literal">$AWS_WEB_IDENTITY_TOKEN_FILE</code> environment variable
(which should be automatically set by a Kubernetes pod) in the S3 repository config directory, so the repository
can have the read access for the service account (a repository can&#8217;t read any files outside its config directory).
For example:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">mkdir -p "${ES_PATH_CONF}/repository-s3"
ln -s $AWS_WEB_IDENTITY_TOKEN_FILE "${ES_PATH_CONF}/repository-s3/aws-web-identity-token-file"</pre>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>The symlink must be created on all data and master eligible nodes and be readable
by the <code class="literal">elasticsearch</code> user. By default, Elasticsearch runs as user <code class="literal">elasticsearch</code> using uid:gid <code class="literal">1000:0</code>.</p>
</div>
</div>
<p>If the symlink exists, it will be used by default by all S3 repositories that don&#8217;t have explicit <code class="literal">client</code> credentials.</p>
</div>

</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="repository-gcs.html">« Google Cloud Storage repository</a>
</span>
<span class="next">
<a href="snapshots-filesystem-repository.html">Shared file system repository »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {"alternatives":{"console":{"php":{"hasAny":true},"csharp":{"hasAny":true},"python":{"hasAny":true},"ruby":{"hasAny":true},"go":{"hasAny":true},"js":{"hasAny":true}}}}</script>
  </body>
</html>
