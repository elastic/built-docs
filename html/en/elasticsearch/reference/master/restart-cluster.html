<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Full-cluster restart and rolling restart | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Full-cluster restart and rolling restart | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="setup.html" title="Set up Elasticsearch"/>
<link rel="prev" href="add-elasticsearch-nodes.html" title="Add and remove nodes in your cluster"/>
<link rel="next" href="remote-clusters.html" title="Remote clusters"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles-v1.css" />
  </head>

  <!--© 2015-2025 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="add-elasticsearch-nodes.html">« Add and remove nodes in your cluster</a>
</span>
<span class="next">
<a href="remote-clusters.html">Remote clusters »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="setup.html">Set up Elasticsearch</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Full-cluster restart and rolling restart</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/setup/restart-cluster.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="restart-cluster"></a>Full-cluster restart and rolling restart<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/setup/restart-cluster.asciidoc">edit</a></h2>
</div></div></div>
<p>There may be <a class="xref" href="security-basic-setup.html" title="Set up basic security for the Elastic Stack">situations where you want
to perform a full-cluster restart</a> or a rolling restart. In the case of
<a class="xref" href="restart-cluster.html#restart-cluster-full" title="Full-cluster restart">full-cluster restart</a>, you shut down and restart all the
nodes in the cluster while in the case of
<a class="xref" href="restart-cluster.html#restart-cluster-rolling" title="Rolling restart">rolling restart</a>, you shut down only one node at a
time, so the service remains uninterrupted.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Nodes exceeding the low watermark threshold will be slow to restart. Reduce the disk
usage below the <a class="xref" href="modules-cluster.html#cluster-routing-watermark-low">low watermark</a> before restarting nodes.</p>
</div>
</div>
<h3><a id="restart-cluster-full"></a>Full-cluster restart<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/setup/restart-cluster.asciidoc">edit</a></h3>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p><span class="strong strong"><strong>Disable shard allocation.</strong></span></p>
<p>When you shut down a data node, the allocation process waits for
<code class="literal">index.unassigned.node_left.delayed_timeout</code> (by default, one minute) before
starting to replicate the shards on that node to other nodes in the cluster,
which can involve a lot of I/O. Since the node is shortly going to be
restarted, this I/O is unnecessary. You can avoid racing the clock by
<a class="xref" href="modules-cluster.html#cluster-routing-allocation-enable">disabling allocation</a> of replicas before
shutting down <a class="xref" href="modules-node.html#data-node" title="Data nodes">data nodes</a>:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.cluster.put_settings(
    body={
        "persistent": {"cluster.routing.allocation.enable": "primaries"}
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cluster.put_settings(
  body: {
    persistent: {
      'cluster.routing.allocation.enable' =&gt; 'primaries'
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cluster.putSettings({
  persistent: {
    "cluster.routing.allocation.enable": "primaries",
  },
});
console.log(response);</pre>
</div>
<a id="1cd3b9d65576a9212eef898eb3105758"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">PUT _cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": "primaries"
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/38.console"></div>
<p>You can also consider <a class="xref" href="modules-gateway.html" title="Local gateway settings">gateway settings</a> when restarting
large clusters to reduce initial strain while nodes are processing
<a class="xref" href="modules-discovery.html" title="Discovery and cluster formation">through discovery</a>.</p>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Stop indexing and perform a flush.</strong></span></p>
<p>Performing a <a class="xref" href="indices-flush.html" title="Flush API">flush</a> speeds up shard recovery.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.flush()
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.flush
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.flush();
console.log(response);</pre>
</div>
<a id="f27c28ddbf4c266b5f42d14da837b8de"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">POST /_flush</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/39.console"></div>
</li>
</ol>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p><span class="strong strong"><strong>Temporarily stop the tasks associated with active machine learning jobs and datafeeds.</strong></span> (Optional)</p>
<p>Machine learning features require specific <a href="/subscriptions" class="ulink" target="_top">subscriptions</a>.</p>
<p>You have two options to handle machine learning jobs and datafeeds when you shut down a
cluster:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Temporarily halt the tasks associated with your machine learning jobs and datafeeds and
prevent new jobs from opening by using the
<a class="xref" href="ml-set-upgrade-mode.html" title="Set upgrade mode API">set upgrade mode API</a>:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.ml.set_upgrade_mode(
    enabled="true",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.ml.set_upgrade_mode(
  enabled: true
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.ml.setUpgradeMode({
  enabled: "true",
});
console.log(response);</pre>
</div>
<a id="a21a7bf052b41f5b996dc58f7b69770f"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">POST _ml/set_upgrade_mode?enabled=true</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/40.console"></div>
<p>When you disable upgrade mode, the jobs resume using the last model state that
was automatically saved. This option avoids the overhead of managing active jobs
during the shutdown and is faster than explicitly stopping datafeeds and closing
jobs.</p>
</li>
<li class="listitem">
<a href="/guide/en/machine-learning/master/stopping-ml.html" class="ulink" target="_top">Stop all datafeeds and close all jobs</a>. This option
saves the model state at the time of closure. When you reopen the jobs after the
cluster restart, they use the exact same model. However, saving the latest model
state takes longer than using upgrade mode, especially if you have a lot of jobs
or jobs with large model states.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Shut down all nodes.</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>If you are running Elasticsearch with <code class="literal">systemd</code>:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo systemctl stop elasticsearch.service</pre>
</div>
</li>
<li class="listitem">
<p>If you are running Elasticsearch with SysV <code class="literal">init</code>:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo -i service elasticsearch stop</pre>
</div>
</li>
<li class="listitem">
<p>If you are running Elasticsearch as a daemon:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">kill $(cat pid)</pre>
</div>
</li>
</ul>
</div>
</li>
<li class="listitem">
<span class="strong strong"><strong>Perform any needed changes.</strong></span>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Restart nodes.</strong></span></p>
<p>If you have dedicated master nodes, start them first and wait for them to
form a cluster and elect a master before proceeding with your data nodes.
You can check progress by looking at the logs.</p>
<p>As soon as enough master-eligible nodes have discovered each other, they form a
cluster and elect a master. At that point, you can use
the <a class="xref" href="cat-health.html" title="cat health API">cat health</a> and <a class="xref" href="cat-nodes.html" title="cat nodes API">cat nodes</a> APIs to monitor nodes
joining the cluster:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.cat.health()
print(resp)

resp = client.cat.nodes()
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cat.health
puts response

response = client.cat.nodes
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cat.health();
console.log(response);

const response1 = await client.cat.nodes();
console.log(response1);</pre>
</div>
<a id="c0a4b0c1c6eff14da8b152ceb19c1c31"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET _cat/health

GET _cat/nodes</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/41.console"></div>
<p>The <code class="literal">status</code> column returned by <code class="literal">_cat/health</code> shows the health of each node
in the cluster: <code class="literal">red</code>, <code class="literal">yellow</code>, or <code class="literal">green</code>.</p>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Wait for all nodes to join the cluster and report a status of yellow.</strong></span></p>
<p>When a node joins the cluster, it begins to recover any primary shards that
are stored locally. The <a class="xref" href="cat-health.html" title="cat health API"><code class="literal">_cat/health</code></a> API initially reports
a <code class="literal">status</code> of <code class="literal">red</code>, indicating that not all primary shards have been allocated.</p>
<p>Once a node recovers its local shards, the cluster <code class="literal">status</code> switches to
<code class="literal">yellow</code>, indicating that all primary shards have been recovered, but not all
replica shards are allocated. This is to be expected because you have not yet
re-enabled allocation. Delaying the allocation of replicas until all nodes
are <code class="literal">yellow</code> allows the master to allocate replicas to nodes that
already have local shard copies.</p>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Re-enable allocation.</strong></span></p>
<p>When all nodes have joined the cluster and recovered their primary shards,
re-enable allocation by restoring <code class="literal">cluster.routing.allocation.enable</code> to its
default:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.cluster.put_settings(
    body={"persistent": {"cluster.routing.allocation.enable": None}},
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cluster.put_settings(
  body: {
    persistent: {
      'cluster.routing.allocation.enable' =&gt; nil
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cluster.putSettings({
  persistent: {
    "cluster.routing.allocation.enable": null,
  },
});
console.log(response);</pre>
</div>
<a id="45ef5156dbd2d3fd4fd22b8d99f7aad4"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">PUT _cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": null
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/42.console"></div>
<p>Once allocation is re-enabled, the cluster starts allocating replica shards to
the data nodes. At this point it is safe to resume indexing and searching,
but your cluster will recover more quickly if you can wait until all primary
and replica shards have been successfully allocated and the status of all nodes
is <code class="literal">green</code>.</p>
<p>You can monitor progress with the <a class="xref" href="cat-health.html" title="cat health API"><code class="literal">_cat/health</code></a> and
<a class="xref" href="cat-recovery.html" title="cat recovery API"><code class="literal">_cat/recovery</code></a> APIs:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.cat.health()
print(resp)

resp = client.cat.recovery()
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cat.health
puts response

response = client.cat.recovery
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cat.health();
console.log(response);

const response1 = await client.cat.recovery();
console.log(response1);</pre>
</div>
<a id="2d9b30acd6b5683f39d53494c0dd779c"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET _cat/health

GET _cat/recovery</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/43.console"></div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Restart machine learning jobs.</strong></span> (Optional)</p>
<p>If you temporarily halted the tasks associated with your machine learning jobs, use the
<a class="xref" href="ml-set-upgrade-mode.html" title="Set upgrade mode API">set upgrade mode API</a> to return them to active states:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.ml.set_upgrade_mode(
    enabled="false",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.ml.set_upgrade_mode(
  enabled: false
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.ml.setUpgradeMode({
  enabled: "false",
});
console.log(response);</pre>
</div>
<a id="3c5d5a5c34a62724942329658c688f5e"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">POST _ml/set_upgrade_mode?enabled=false</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/44.console"></div>
<p>If you closed all machine learning jobs before stopping the nodes, open the jobs and start
the datafeeds from Kibana or with the <a class="xref" href="ml-open-job.html" title="Open anomaly detection jobs API">open jobs</a> and
<a class="xref" href="ml-start-datafeed.html" title="Start datafeeds API">start datafeed</a> APIs.</p>
</li>
</ol>
</div>
<h3><a id="restart-cluster-rolling"></a>Rolling restart<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/setup/restart-cluster.asciidoc">edit</a></h3>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p><span class="strong strong"><strong>Disable shard allocation.</strong></span></p>
<p>When you shut down a data node, the allocation process waits for
<code class="literal">index.unassigned.node_left.delayed_timeout</code> (by default, one minute) before
starting to replicate the shards on that node to other nodes in the cluster,
which can involve a lot of I/O. Since the node is shortly going to be
restarted, this I/O is unnecessary. You can avoid racing the clock by
<a class="xref" href="modules-cluster.html#cluster-routing-allocation-enable">disabling allocation</a> of replicas before
shutting down <a class="xref" href="modules-node.html#data-node" title="Data nodes">data nodes</a>:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.cluster.put_settings(
    body={
        "persistent": {"cluster.routing.allocation.enable": "primaries"}
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cluster.put_settings(
  body: {
    persistent: {
      'cluster.routing.allocation.enable' =&gt; 'primaries'
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cluster.putSettings({
  persistent: {
    "cluster.routing.allocation.enable": "primaries",
  },
});
console.log(response);</pre>
</div>
<a id="1cd3b9d65576a9212eef898eb3105758"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">PUT _cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": "primaries"
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/45.console"></div>
<p>You can also consider <a class="xref" href="modules-gateway.html" title="Local gateway settings">gateway settings</a> when restarting
large clusters to reduce initial strain while nodes are processing
<a class="xref" href="modules-discovery.html" title="Discovery and cluster formation">through discovery</a>.</p>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Stop non-essential indexing and perform a flush.</strong></span> (Optional)</p>
<p>While you can continue indexing during the rolling restart, shard recovery
can be faster if you temporarily stop non-essential indexing and perform a
<a class="xref" href="indices-flush.html" title="Flush API">flush</a>.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.flush()
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.flush
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.flush();
console.log(response);</pre>
</div>
<a id="f27c28ddbf4c266b5f42d14da837b8de"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">POST /_flush</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/46.console"></div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Temporarily stop the tasks associated with active machine learning jobs and datafeeds.</strong></span> (Optional)</p>
<p>Machine learning features require specific <a href="/subscriptions" class="ulink" target="_top">subscriptions</a>.</p>
<p>You have two options to handle machine learning jobs and datafeeds when you shut down a
cluster:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Temporarily halt the tasks associated with your machine learning jobs and datafeeds and
prevent new jobs from opening by using the
<a class="xref" href="ml-set-upgrade-mode.html" title="Set upgrade mode API">set upgrade mode API</a>:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.ml.set_upgrade_mode(
    enabled="true",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.ml.set_upgrade_mode(
  enabled: true
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.ml.setUpgradeMode({
  enabled: "true",
});
console.log(response);</pre>
</div>
<a id="a21a7bf052b41f5b996dc58f7b69770f"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">POST _ml/set_upgrade_mode?enabled=true</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/47.console"></div>
<p>When you disable upgrade mode, the jobs resume using the last model state that
was automatically saved. This option avoids the overhead of managing active jobs
during the shutdown and is faster than explicitly stopping datafeeds and closing
jobs.</p>
</li>
<li class="listitem">
<a href="/guide/en/machine-learning/master/stopping-ml.html" class="ulink" target="_top">Stop all datafeeds and close all jobs</a>. This option
saves the model state at the time of closure. When you reopen the jobs after the
cluster restart, they use the exact same model. However, saving the latest model
state takes longer than using upgrade mode, especially if you have a lot of jobs
or jobs with large model states.
</li>
</ul>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If you perform a rolling restart, you can also leave your machine learning
jobs running. When you shut down a machine learning node, its jobs automatically
move to another node and restore the model states. This option enables your jobs
to continue running during the shutdown but it puts increased load on the
cluster.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Shut down a single node in case of rolling restart.</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>If you are running Elasticsearch with <code class="literal">systemd</code>:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo systemctl stop elasticsearch.service</pre>
</div>
</li>
<li class="listitem">
<p>If you are running Elasticsearch with SysV <code class="literal">init</code>:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo -i service elasticsearch stop</pre>
</div>
</li>
<li class="listitem">
<p>If you are running Elasticsearch as a daemon:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">kill $(cat pid)</pre>
</div>
</li>
</ul>
</div>
</li>
<li class="listitem">
<span class="strong strong"><strong>Perform any needed changes.</strong></span>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Restart the node you changed.</strong></span></p>
<p>Start the node and confirm that it joins the cluster by checking the log file or
by submitting a <code class="literal">_cat/nodes</code> request:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.cat.nodes()
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cat.nodes
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cat.nodes();
console.log(response);</pre>
</div>
<a id="7e49705769c42895fb7b1e2ca028ff47"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET _cat/nodes</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/48.console"></div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Reenable shard allocation.</strong></span></p>
<p>For data nodes, once the node has joined the cluster, remove the
<code class="literal">cluster.routing.allocation.enable</code> setting to enable shard allocation and start
using the node:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.cluster.put_settings(
    body={"persistent": {"cluster.routing.allocation.enable": None}},
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cluster.put_settings(
  body: {
    persistent: {
      'cluster.routing.allocation.enable' =&gt; nil
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cluster.putSettings({
  persistent: {
    "cluster.routing.allocation.enable": null,
  },
});
console.log(response);</pre>
</div>
<a id="45ef5156dbd2d3fd4fd22b8d99f7aad4"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">PUT _cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": null
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/49.console"></div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Repeat in case of rolling restart.</strong></span></p>
<p>When the node has recovered and the cluster is stable, repeat these steps
for each node that needs to be changed.</p>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Restart machine learning jobs.</strong></span> (Optional)</p>
<p>If you temporarily halted the tasks associated with your machine learning jobs, use the
<a class="xref" href="ml-set-upgrade-mode.html" title="Set upgrade mode API">set upgrade mode API</a> to return them to active states:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.ml.set_upgrade_mode(
    enabled="false",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.ml.set_upgrade_mode(
  enabled: false
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.ml.setUpgradeMode({
  enabled: "false",
});
console.log(response);</pre>
</div>
<a id="3c5d5a5c34a62724942329658c688f5e"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">POST _ml/set_upgrade_mode?enabled=false</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/50.console"></div>
<p>If you closed all machine learning jobs before stopping the nodes, open the jobs and start
the datafeeds from Kibana or with the <a class="xref" href="ml-open-job.html" title="Open anomaly detection jobs API">open jobs</a> and
<a class="xref" href="ml-start-datafeed.html" title="Start datafeeds API">start datafeed</a> APIs.</p>
</li>
</ol>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="add-elasticsearch-nodes.html">« Add and remove nodes in your cluster</a>
</span>
<span class="next">
<a href="remote-clusters.html">Remote clusters »</a>
</span>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs-v1.js"></script>
    <script type="text/javascript">
  window.initial_state = {"alternatives":{"console":{"php":{"hasAny":true},"python":{"hasAny":true},"ruby":{"hasAny":true},"go":{"hasAny":true},"js":{"hasAny":true}}}}</script>
  </body>
</html>
