<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Configuring SAML single-sign-on on the Elastic Stack | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Configuring SAML single-sign-on on the Elastic Stack | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="setting-up-authentication.html" title="User authentication"/>
<link rel="prev" href="controlling-user-cache.html" title="Controlling the user cache"/>
<link rel="next" href="oidc-guide.html" title="Configuring single sign-on to the Elastic Stack using OpenID Connect"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles-v1.css" />
  </head>

  <!--© 2015-2025 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="controlling-user-cache.html">« Controlling the user cache</a>
</span>
<span class="next">
<a href="oidc-guide.html">Configuring single sign-on to the Elastic Stack using OpenID Connect »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="secure-cluster.html">Secure the Elastic Stack</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="setting-up-authentication.html">User authentication</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Configuring SAML single-sign-on on the Elastic Stack</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="saml-guide-stack"></a>Configuring SAML single-sign-on on the Elastic Stack<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h2>
</div></div></div>
<p>The Elastic Stack supports SAML single-sign-on (SSO) into Kibana, using Elasticsearch as
a backend service. In SAML terminology, the Elastic Stack is operating as a
<em>Service Provider</em>.</p>
<p>The other component that is needed to enable SAML single-sign-on is the
<em>Identity Provider</em>, which is a service that handles your credentials and
performs that actual authentication of users.</p>
<p>If you are interested in configuring SSO into Kibana, then you will need to
provide Elasticsearch with information about your <em>Identity Provider</em>, and you will need
to register the Elastic Stack as a known <em>Service Provider</em> within that
Identity Provider. There are also a few configuration changes that are
required in Kibana to activate the SAML authentication provider.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The SAML support in Kibana is designed on the expectation that it will be
the primary (or sole) authentication method for users of that Kibana instance.
Once you enable SAML authentication in Kibana it will affect all users who try
to login. The <a class="xref" href="saml-guide-stack.html#saml-configure-kibana" title="Configuring Kibana">Configuring Kibana</a> section provides more detail about how
this works.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-guide-idp"></a>The identity provider<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>The Elastic Stack supports the SAML 2.0 <em>Web Browser SSO</em> and the SAML
2.0 <em>Single Logout</em> profiles and can integrate with any Identity Provider (IdP)
that supports at least the SAML 2.0 <em>Web Browser SSO Profile</em>.
It has been tested with a number of popular IdP implementations, such as
<a href="/blog/how-to-configure-elasticsearch-saml-authentication-with-adfs" class="ulink" target="_top">Microsoft Active Directory Federation Services (ADFS)</a>,
<a href="/blog/saml-based-single-sign-on-with-elasticsearch-and-azure-active-directory" class="ulink" target="_top">Azure Active Directory (AAD)</a>,
and <a href="/blog/setting-up-saml-for-elastic-enterprise-search-okta-edition" class="ulink" target="_top">Okta</a>.</p>
<p>This guide assumes that you have an existing IdP and wish to add Kibana as a
Service Provider.</p>
<p>The Elastic Stack uses a standard SAML <em>metadata</em> document, in XML format that
defines the capabilities and features of your IdP. You should be able to
download or generate such a document within your IdP administration interface.</p>
<p>Download the IdP metadata document and store it within the <code class="literal">config</code> directory on
each Elasticsearch node. For the purposes of this guide, we will assume that you are
storing it as <code class="literal">config/saml/idp-metadata.xml</code>.</p>
<p>The IdP will have been assigned an identifier (<em>EntityID</em> in SAML terminology)
which is most commonly expressed in <em>Uniform Resource Identifier</em> (URI) form.
Your admin interface may tell you what this is, or you might need to
read the metadata document to find it - look for the <code class="literal">entityID</code> attribute on the
<code class="literal">EntityDescriptor</code> element.</p>
<p>Most IdPs will provide an appropriate metadata file with all the features that
the Elastic Stack requires, and should only require the configuration steps
described below. For completeness sake, the minimum requirements that the Elastic
Stack has for the IdP&#8217;s metadata are:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
An <code class="literal">&lt;EntityDescriptor&gt;</code> with an <code class="literal">entityID</code> that matches the Elasticsearch
<a class="xref" href="saml-guide-stack.html#saml-create-realm" title="Create a SAML realm">configuration</a>
</li>
<li class="listitem">
An <code class="literal">&lt;IDPSSODescriptor&gt;</code> that supports the SAML 2.0 protocol
(<code class="literal">urn:oasis:names:tc:SAML:2.0:protocol</code>).
</li>
<li class="listitem">
At least one <code class="literal">&lt;KeyDescriptor&gt;</code> that is configured for <em>signing</em> (that is, it
has <code class="literal">use="signing"</code> or leaves the <code class="literal">use</code> unspecified)
</li>
<li class="listitem">
A <code class="literal">&lt;SingleSignOnService&gt;</code> with binding of HTTP-Redirect
(<code class="literal">urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect</code>)
</li>
<li class="listitem">
If you wish to support <a class="xref" href="saml-guide-stack.html#saml-logout" title="SAML logout">Single Logout</a>, a <code class="literal">&lt;SingleLogoutService&gt;</code>
with binding of HTTP-Redirect
(<code class="literal">urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect</code>)
</li>
</ul>
</div>
<p>The Elastic Stack requires that all messages from the IdP are signed.
For authentication <code class="literal">&lt;Response&gt;</code> messages, the signature may be applied to either
the response itself, or to the individual assertions.
For <code class="literal">&lt;LogoutRequest&gt;</code> messages, the message itself must be signed, and the
signature should be provided as a URL parameter, as required by the HTTP-Redirect
binding.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-elasticsearch-authentication"></a>Configure Elasticsearch for SAML authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>There are five configuration steps to enable SAML authentication in Elasticsearch:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="saml-guide-stack.html#saml-enable-http" title="Enable TLS for HTTP">Enable SSL/TLS for HTTP</a>
</li>
<li class="listitem">
<a class="xref" href="saml-guide-stack.html#saml-enable-token" title="Enable the token service">Enable the Token Service</a>
</li>
<li class="listitem">
<a class="xref" href="saml-guide-stack.html#saml-create-realm" title="Create a SAML realm">Create one or more SAML realms</a>
</li>
<li class="listitem">
<a class="xref" href="saml-guide-stack.html#saml-role-mapping" title="Configuring role mappings">Configure role mappings</a>
</li>
<li class="listitem">
Generate a SAML Metadata file for use by your Identity Provider <em>(optional)</em>
</li>
</ol>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-enable-http"></a>Enable TLS for HTTP<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>If your Elasticsearch cluster is operating in production mode, then you must
configure the HTTP interface to use SSL/TLS before you can enable SAML
authentication.</p>
<p>For more information, see
<a class="xref" href="security-basic-setup-https.html#encrypt-http-communication" title="Encrypt HTTP client communications for Elasticsearch">Encrypt HTTP client communications for Elasticsearch</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-enable-token"></a>Enable the token service<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The Elasticsearch SAML implementation makes use of the Elasticsearch Token Service. This service
is automatically enabled if you configure TLS on the HTTP interface, and can be
explicitly configured by including the following in your <code class="literal">elasticsearch.yml</code> file:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.token.enabled: true</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-create-realm"></a>Create a SAML realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>SAML authentication is enabled by configuring a SAML realm within the
authentication chain for Elasticsearch.</p>
<p>This realm has a few mandatory settings, and a number of optional settings.
The available settings are described in detail in <a class="xref" href="security-settings.html" title="Security settings in Elasticsearch">Security settings</a>. For
example, <a class="xref" href="security-settings.html#ref-saml-settings" title="SAML realm settings">SAML realm settings</a>, <a class="xref" href="security-settings.html#ref-saml-signing-settings" title="SAML realm signing settings">SAML realm signing settings</a>,
<a class="xref" href="security-settings.html#ref-saml-encryption-settings" title="SAML realm encryption settings">SAML realm encryption settings</a>, <a class="xref" href="security-settings.html#ref-saml-ssl-settings" title="SAML realm SSL settings">SAML realm SSL settings</a>.
This guide will walk you through the most common settings.</p>
<p>Create a realm by adding the following to your <code class="literal">elasticsearch.yml</code>
configuration file. Each configuration value is explained below.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.saml.saml1:
  order: 2
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.example.com/"
  sp.acs: "https://kibana.example.com/api/security/saml/callback"
  sp.logout: "https://kibana.example.com/logout"
  attributes.principal: "urn:oid:0.9.2342.19200300.100.1.1"
  attributes.groups: "urn:oid:1.3.6.1.4.1.5923.1.5.1."</pre>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>SAML is used when authenticating via Kibana, but it is not an
effective means of authenticating directly to the Elasticsearch REST API. For this reason
we recommend that you include at least one additional realm such as the
<a class="xref" href="native-realm.html" title="Native user authentication">native realm</a> in your authentication chain for use by API
clients.</p>
</div>
</div>
<p>The configuration values used in the example above are:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
xpack.security.authc.realms.saml.saml1
</span>
</dt>
<dd>
This defines a new <code class="literal">saml</code> authentication realm named "saml1".
See <a class="xref" href="realms.html" title="Realms">Realms</a> for more explanation of realms.
</dd>
<dt>
<span class="term">
order
</span>
</dt>
<dd>
The order of the realm within the realm chain. Realms with a lower order
have highest priority and are consulted first. We recommend giving
password-based realms such as file, native, LDAP, and Active Directory the
lowest order (highest priority), followed by SSO realms such as SAML and
OpenID Connect. If you have multiple realms of the same type, give the most
frequently accessed realm the lowest order to have it consulted first.
</dd>
<dt>
<span class="term">
idp.metadata.path
</span>
</dt>
<dd>
This is the path to the metadata file that you saved for your Identity Provider.
The path that you enter here is relative to your <code class="literal">config/</code> directory.
Elasticsearch will automatically monitor this file for changes and will
reload the configuration whenever it is updated.
</dd>
<dt>
<span class="term">
idp.entity_id
</span>
</dt>
<dd>
This is the identifier (SAML EntityID) that your IdP uses.
It should match the <code class="literal">entityID</code> attribute within the metadata file.
</dd>
<dt>
<span class="term">
sp.entity_id
</span>
</dt>
<dd>
This is a unique identifier for your Kibana instance, expressed as a URI.
You will use this value when you add Kibana as a service provider within your IdP.
We recommend that you use the base URL for your Kibana instance as the entity ID.
</dd>
<dt>
<span class="term">
sp.acs
</span>
</dt>
<dd>
The <em>Assertion Consumer Service</em> (ACS) endpoint is the URL within Kibana that accepts
authentication messages from the IdP.
This ACS endpoint supports the SAML HTTP-POST binding only.
It must be a URL that is accessible from the web browser of the user who is
attempting to login to Kibana, it does not need to be directly accessible by Elasticsearch
or the IdP.
The correct value may vary depending on how you have installed Kibana and
whether there are any proxies involved, but it will typically be
<code class="literal">${kibana-url}/api/security/saml/callback</code> where <em>${kibana-url}</em> is the base URL for
your Kibana instance.
</dd>
<dt>
<span class="term">
sp.logout
</span>
</dt>
<dd>
This is the URL within Kibana that accepts logout messages from the IdP.
Like the <code class="literal">sp.acs</code> URL, it must be accessible from the web browser, but does
not need to be directly accessible by Elasticsearch or the IdP. The correct value may
vary depending on how you have installed Kibana and whether there are any
proxies involved, but it will typically be <code class="literal">${kibana-url}/logout</code> where
<em>${kibana-url}</em> is the base URL for your Kibana instance.
</dd>
<dt>
<span class="term">
attributes.principal
</span>
</dt>
<dd>
See <a class="xref" href="saml-guide-stack.html#saml-attributes-mapping" title="Attribute mapping">Attribute mapping</a>.
</dd>
<dt>
<span class="term">
attributes.groups
</span>
</dt>
<dd>
See <a class="xref" href="saml-guide-stack.html#saml-attributes-mapping" title="Attribute mapping">Attribute mapping</a>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-attributes-mapping"></a>Attribute mapping<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>When a user connects to Kibana through your Identity Provider, the Identity
Provider will supply a SAML Assertion about the user. The assertion will contain
an <em>Authentication Statement</em> indicating that the user has successfully
authenticated to the IdP and one or more <em>Attribute Statements</em> that will
include <em>Attributes</em> for the user.</p>
<p>These attributes may include such things as:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
the user&#8217;s username
</li>
<li class="listitem">
the user&#8217;s email address
</li>
<li class="listitem">
the user&#8217;s groups or roles
</li>
</ul>
</div>
<p>Attributes in SAML are named using a URI such as
<code class="literal">urn:oid:0.9.2342.19200300.100.1.1</code> or
<code class="literal">http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn</code>, and have one or
more values associated with them.</p>
<p>These attribute identifiers vary between IdPs, and most IdPs offer ways to
customize the URIs and their associated value.</p>
<p>Elasticsearch uses these attributes to infer information about the user who has
logged in, and they can be used for role mapping (below).</p>
<p>In order for these attributes to be useful, Elasticsearch and the IdP need to have a
common value for the names of the attributes. This is done manually, by
configuring the IdP and the SAML realm to use the same URI name for
each logical user attribute.</p>
<p>The recommended steps for configuring these SAML attributes are as follows:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Consult your IdP to see what user attributes it can provide.
This varies greatly between providers, but you should be able to obtain a list
from the documentation, or from your local admin.
</li>
<li class="listitem">
Read through the list of <a class="xref" href="saml-guide-stack.html#saml-es-user-properties" title="Elasticsearch user properties">user properties</a> that Elasticsearch
supports, and decide which of them are useful to you, and can be provided by
your IdP. At a <em>minimum</em>, the <code class="literal">principal</code> attribute is required.
</li>
<li class="listitem">
Configure your IdP to "release" those attributes to your Kibana SAML service
provider. This process varies by provider - some will provide a user interface
for this, while others may require that you edit configuration files.
Usually the IdP (or your local administrator) will have suggestions about what
URI to use for each attribute. You can simply accept those suggestions, as the
Elasticsearch service is entirely configurable and does not require that any specific
URIs are used.
</li>
<li class="listitem">
Configure the SAML realm in Elasticsearch to associate the Elasticsearch user properties (see
<a class="xref" href="saml-guide-stack.html#saml-es-user-properties" title="Elasticsearch user properties">the listing</a> below), to the URIs that you configured
in your IdP. In the example above, we have configured the <code class="literal">principal</code> and
<code class="literal">groups</code> attributes.
</li>
</ol>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="saml-attribute-mapping-nameid"></a>Special attribute names<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>In general, Elasticsearch expects that the configured value for an attribute will be a
URI such as <code class="literal">urn:oid:0.9.2342.19200300.100.1.1</code>, however there are some
additional names that can be used:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">nameid</code>
</span>
</dt>
<dd>
This uses the SAML <code class="literal">NameID</code> value (all leading and trailing whitespace removed)
instead of a SAML attribute. SAML
<code class="literal">NameID</code> elements are an optional, but frequently provided, field within a
SAML Assertion that the IdP may use to identify the Subject of that
Assertion. In some cases the <code class="literal">NameID</code> will relate to the user&#8217;s login
identifier (username) within the IdP, but in many cases they will be
internally generated identifiers that have no obvious meaning outside
of the IdP.
</dd>
<dt>
<span class="term">
<code class="literal">nameid:persistent</code>
</span>
</dt>
<dd>
This uses the SAML <code class="literal">NameID</code> value (all leading and trailing whitespace removed),
but only if the NameID format is
<code class="literal">urn:oasis:names:tc:SAML:2.0:nameid-format:persistent</code>.
A SAML <code class="literal">NameID</code> element has an optional <code class="literal">Format</code> attribute that indicates
the semantics of the provided name. It is common for IdPs to be configured
with "transient" NameIDs that present a new identifier for each session.
Since it is rarely useful to use a transient NameID as part of an attribute
mapping, the "nameid:persistent" attribute name can be used as a safety
mechanism that will cause an error if you attempt to map from a <code class="literal">NameID</code>
that does not have a persistent value.
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Identity Providers can be either statically configured to release a <code class="literal">NameID</code>
with a specific format, or they can be configured to try to conform with the
requirements of the SP. The SP declares its requirements as part of the
Authentication Request, using an element which is called the <code class="literal">NameIDPolicy</code>. If
this is needed, you can set the relevant <a class="xref" href="security-settings.html#ref-saml-settings" title="SAML realm settings">settings</a> named
<code class="literal">nameid_format</code> in order to request that the IdP releases a <code class="literal">NameID</code> with a
specific format.</p>
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<em>friendlyName</em>
</span>
</dt>
<dd>
A SAML attribute may have a <em>friendlyName</em> in addition to its URI based name.
For example the attribute with a name of <code class="literal">urn:oid:0.9.2342.19200300.100.1.1</code>
might also have a friendlyName of <code class="literal">uid</code>.
You may use these friendly names within an attribute mapping, but it is
recommended that you use the URI based names, as friendlyNames are neither
standardized or mandatory.
</dd>
</dl>
</div>
<p>The example below configures a realm to use a persistent nameid for the principal,
and the attribute with the friendlyName "roles" for the user&#8217;s groups.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.saml.saml1:
  order: 2
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.example.com/"
  sp.acs: "https://kibana.example.com/api/security/saml/callback"
  attributes.principal: "nameid:persistent"
  attributes.groups: "roles"
  nameid_format: "urn:oasis:names:tc:SAML:2.0:nameid-format:persistent"</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="saml-es-user-properties"></a>Elasticsearch user properties<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>The Elasticsearch SAML realm can be configured to map SAML <code class="literal">attributes</code> to the
following properties on the authenticated user:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
principal
</span>
</dt>
<dd>
<em>(Required)</em>
This is the <em>username</em> that will be applied to a user that authenticates
against this realm.
The <code class="literal">principal</code> appears in places such as the Elasticsearch audit logs.
</dd>
<dt>
<span class="term">
groups
</span>
</dt>
<dd>
<p>
<em>(Recommended)</em>
If you wish to use your IdP&#8217;s concept of groups or roles as the basis for a
user&#8217;s Elasticsearch privileges, you should map them with this attribute.
The <code class="literal">groups</code> are passed directly to your
<a class="xref" href="saml-guide-stack.html#saml-role-mapping" title="Configuring role mappings">role mapping rules</a>.
</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Some IdPs are configured to send the <code class="literal">groups</code> list as a single value, comma-separated
string. To map this SAML attribute to the <code class="literal">attributes.groups</code> setting in the Elasticsearch
realm, you can configure a string delimiter using the <code class="literal">attribute_delimiters.group</code>
setting.</p>
<p>For example, splitting the SAML attribute value
<code class="literal">engineering,elasticsearch-admins,employees</code> on a delimiter value of <code class="literal">,</code> will
result in <code class="literal">engineering</code>, <code class="literal">elasticsearch-admins</code>, and <code class="literal">employees</code> as the list of
groups for the user.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
name
</span>
</dt>
<dd>
<em>(Optional)</em> The user&#8217;s full name.
</dd>
<dt>
<span class="term">
mail
</span>
</dt>
<dd>
<em>(Optional)</em> The user&#8217;s email address.
</dd>
<dt>
<span class="term">
dn
</span>
</dt>
<dd>
<em>(Optional)</em> The user&#8217;s X.500 <em>Distinguished Name</em>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_extracting_partial_values_from_saml_attributes"></a>Extracting partial values from SAML attributes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>There are some occasions where the IdP&#8217;s attribute may contain more information
than you wish to use within Elasticsearch. A common example of this is one where the
IdP works exclusively with email addresses, but you would like the user&#8217;s
<code class="literal">principal</code> to use the <em>local-name</em> part of the email address.
For example if their email address was <code class="literal">james.wong@staff.example.com</code>, then you
would like their principal to simply be <code class="literal">james.wong</code>.</p>
<p>This can be achieved using the <code class="literal">attribute_patterns</code> setting in the Elasticsearch
realm, as demonstrated in the realm configuration below:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.saml.saml1:
  order: 2
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.example.com/"
  sp.acs: "https://kibana.example.com/api/security/saml/callback"
  attributes.principal: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"
  attribute_patterns.principal: "^([^@]+)@staff\\.example\\.com$"</pre>
</div>
<p>In this case, the user&#8217;s <code class="literal">principal</code> is mapped from an email attribute, but a
regular expression is applied to the value before it is assigned to the user.
If the regular expression matches, then the result of the first group is used as
effective value. If the regular expression does not match then the attribute
mapping fails.</p>
<p>In this example, the email address must belong to the <code class="literal">staff.example.com</code> domain,
and then the local-part (anything before the <code class="literal">@</code>) is used as the principal.
Any users who try to login using a different email domain will fail because the
regular expression will not match against their email address, and thus their
principal attribute - which is mandatory - will not be populated.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Small mistakes in these regular expressions can have significant
security consequences. For example, if we accidentally left off the trailing
<code class="literal">$</code> from the example above, then we would match any email address where the
domain starts with <code class="literal">staff.example.com</code>, and this would accept an email
address such as <code class="literal">admin@staff.example.com.attacker.net</code>. It is important that
you make sure your regular expressions are as precise as possible so that
you do not inadvertently open an avenue for user impersonation attacks.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="req-authn-context"></a>Requesting specific authentication methods<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>It is sometimes necessary for a SAML SP to be able to impose specific
restrictions regarding the authentication that will take place at an IdP,
in order to assess the level of confidence that it can place in
the corresponding authentication response. The restrictions might have to do
with the authentication method (password, client certificates, etc), the
user identification method during registration, and other details. Elasticsearch implements
<a href="https://docs.oasis-open.org/security/saml/v2.0/saml-authn-context-2.0-os.pdf" class="ulink" target="_top">SAML 2.0 Authentication Context</a>, which can be used for this purpose as defined in SAML 2.0 Core
Specification.</p>
<p>In short, the SAML SP defines a set of Authentication Context Class Reference
values, which describe the restrictions to be imposed on the IdP, and sends these
in the Authentication Request. The IdP attempts to grant these restrictions.
If it cannot grant them, the authentication attempt fails. If the user is
successfully authenticated, the Authentication Statement of the SAML Response
contains an indication of the restrictions that were satisfied.</p>
<p>You can define the Authentication Context Class Reference values by using the <code class="literal">req_authn_context_class_ref</code> option in the SAML realm configuration. See
<a class="xref" href="security-settings.html#ref-saml-settings" title="SAML realm settings">SAML realm settings</a>.</p>
<p>Elasticsearch supports only the <code class="literal">exact</code> comparison method for the Authentication Context.
When it receives the Authentication Response from the IdP, Elasticsearch examines the
value of the Authentication Context Class Reference that is part of the
Authentication Statement of the SAML Assertion. If it matches one of the
requested values, the authentication is considered successful. Otherwise, the
authentication attempt fails.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-logout"></a>SAML logout<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The SAML protocol supports the concept of Single Logout (SLO).
The level of support for SLO varies between Identity Providers.
You should consult the documentation for your IdP to determine what Logout
services it offers.</p>
<p>By default the Elastic Stack will support SAML SLO if the following are true:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Your IdP metadata specifies that the IdP offers a SLO service
</li>
<li class="listitem">
Your IdP releases a NameID in the subject of the SAML assertion that it issues for your users
</li>
<li class="listitem">
You configure <code class="literal">sp.logout</code>
</li>
<li class="listitem">
The setting <code class="literal">idp.use_single_logout</code> is not <code class="literal">false</code>
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_idp_slo_service"></a>IdP SLO service<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>One of the values that Elasticsearch reads from the IdP&#8217;s SAML metadata is the
<code class="literal">&lt;SingleLogoutService&gt;</code>. In order for Single Logout to work with the Elastic
stack, Elasticsearch requires that this exist and support a binding of
<code class="literal">urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect</code>.</p>
<p>The Elastic Stack will send both <code class="literal">&lt;LogoutRequest&gt;</code> and <code class="literal">&lt;LogoutResponse&gt;</code>
messages to this service as appropriate.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_the_sp_logout_setting"></a>The sp.logout setting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>The Elasticsearch realm setting <code class="literal">sp.logout</code> specifies a URL in Kibana to which the IdP can
send both <code class="literal">&lt;LogoutRequest&gt;</code> and <code class="literal">&lt;LogoutResponse&gt;</code> messages. This service uses
the SAML HTTP-Redirect binding.</p>
<p>Elasticsearch will process <code class="literal">&lt;LogoutRequest&gt;</code> messages, and perform a global signout that
invalidates any existing Elasticsearch security tokens that are associated with the
provided SAML session.</p>
<p>If you do not configure a value for <code class="literal">sp.logout</code>, Elasticsearch will refuse all
<code class="literal">&lt;LogoutRequest&gt;</code> messages.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>It is common for IdPs to require that <code class="literal">LogoutRequest</code> messages be signed,
so you may need to configure <a class="xref" href="saml-guide-stack.html#saml-enc-sign" title="Encryption and signing">signing credentials</a>.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_the_idp_use_single_logout_setting"></a>The idp.use_single_logout setting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>If your IdP provides a <code class="literal">&lt;SingleLogoutService&gt;</code> but you do not wish to use it,
you can configure <code class="literal">idp.use_single_logout: false</code> in your SAML realm, and Elasticsearch
will ignore the SLO service that your IdP provides. In this case, when a user
logs out of Kibana it will invalidate their Elasticsearch session (security token), but
will not perform any logout at the IdP.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_using_kibana_without_single_logout"></a>Using Kibana without single logout<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>If your IdP does not support Single Logout, or you choose not to use it, then
Kibana will perform a "local logout" only.</p>
<p>This means that Kibana will invalidate the session token it is using to
communicate with Elasticsearch, but will not be able to perform any sort of invalidation
of the Identity Provider session. In most cases this will mean that Kibana users
are still considered to be logged in to the IdP. Consequently, if the user
navigates to the Kibana landing page, they will be automatically reauthenticated,
and will commence a new Kibana session without needing to enter any credentials.</p>
<p>The possible solutions to this problem are:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Ask your IdP administrator or vendor to provide a Single Logout service
</li>
<li class="listitem">
If your Idp does provide a Single Logout Service, make sure it is included in
the IdP metadata file, and do <em>not</em> set <code class="literal">idp.use_single_logout</code> to <code class="literal">false</code>.
</li>
<li class="listitem">
Advise your users to close their browser after logging out of Kibana
</li>
<li class="listitem">
Enable the <code class="literal">force_authn</code> setting on your SAML realm. This setting causes the
Elastic Stack to request fresh authentication from the IdP every time a user
attempts to log in to Kibana.
This setting defaults to <code class="literal">false</code> because it can be a more cumbersome user
experience, but it can also be an effective protection to stop users
piggy-backing on existing IdP sessions.
</li>
</ul>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-enc-sign"></a>Encryption and signing<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The Elastic Stack supports generating signed SAML messages (for authentication
and/or logout), verifying signed SAML messages from the IdP (for both
authentication and logout) and can process encrypted content.</p>
<p>You can configure Elasticsearch for signing, encryption or both, with the same
or separate keys used for each of those.</p>
<p>The Elastic Stack uses X.509 certificates with RSA private keys for SAML
cryptography. These keys can be generated using any standard SSL tool, including
the <code class="literal">elasticsearch-certutil</code> tool.</p>
<p>Your IdP may require that the Elastic Stack have a cryptographic key for signing
SAML messages, and that you provide the corresponding signing certificate within
the Service Provider configuration (either within the Elastic Stack SAML
metadata file or manually configured within the IdP administration interface).
While most IdPs do not expected authentication requests to be signed, it is
commonly the case that signatures are required for logout requests. Your IdP
will validate these signatures against the signing certificate that has been
configured for the Elastic Stack Service Provider.</p>
<p>Encryption certificates are rarely needed, but the Elastic Stack supports them
for cases where IdPs or local policies mandate their use.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_generating_certificates_and_keys"></a>Generating certificates and keys<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>Elasticsearch supports certificates and keys in either PEM, PKCS#12 or JKS format.
Some Identity Providers are more restrictive in the formats they support, and
will require you to provide the certificates as a file in a particular format.
You should consult the documentation for your IdP to determine what formats they
support. Since PEM format is the most commonly supported format, the examples
below will generate certificates in that format.</p>
<p>Using the <a class="xref" href="certutil.html" title="elasticsearch-certutil"><code class="literal">elasticsearch-certutil</code> tool</a>, you can generate a
signing certificate with the following command:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-certutil cert --self-signed --pem --days 1100 --name saml-sign --out saml-sign.zip</pre>
</div>
<p>This will</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
generate a certificate and key pair (the <code class="literal">cert</code> subcommand)
</li>
<li class="listitem">
create the files in PEM format (<code class="literal">-pem</code> option)
</li>
<li class="listitem">
generate a certificate that is valid for 3 years (<code class="literal">-days 1100</code>)
</li>
<li class="listitem">
name the certificate <code class="literal">saml-sign</code> (<code class="literal">-name</code> option)
</li>
<li class="listitem">
save the certificate and key in the <code class="literal">saml-sign.zip</code> file (<code class="literal">-out</code> option)
</li>
</ul>
</div>
<p>The generated zip archive will contain 3 files:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">saml-sign.crt</code>, the public certificate to be used for signing
</li>
<li class="listitem">
<code class="literal">saml-sign.key</code>, the private key for the certificate
</li>
<li class="listitem">
<code class="literal">ca.crt</code>, a CA certificate that is not need, and can be ignored.
</li>
</ul>
</div>
<p>Encryption certificates can be generated with the same process.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_configuring_elasticsearch_for_signing"></a>Configuring Elasticsearch for signing<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>By default, Elasticsearch will sign <em>all</em> outgoing SAML messages if a signing
key has been configured.</p>
<p>If you wish to use <span class="strong strong"><strong>PEM formatted</strong></span> keys and certificates for signing, then
you should configure the following settings on the SAML realm:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">signing.certificate</code>
</span>
</dt>
<dd>
The path to the PEM formatted certificate file. e.g. <code class="literal">saml/saml-sign.crt</code>
</dd>
<dt>
<span class="term">
<code class="literal">signing.key</code>
</span>
</dt>
<dd>
The path to the PEM formatted key file. e.g. <code class="literal">saml/saml-sign.key</code>
</dd>
<dt>
<span class="term">
<code class="literal">signing.secure_key_passphrase</code>
</span>
</dt>
<dd>
The passphrase for the key, if the file is encrypted. This is a
<a class="xref" href="secure-settings.html" title="Secure settings">secure setting</a> that must be set with the
<code class="literal">elasticsearch-keystore</code> tool.
</dd>
</dl>
</div>
<p>If you wish to use <span class="strong strong"><strong>PKCS#12 formatted</strong></span> files or a <span class="strong strong"><strong>Java Keystore</strong></span> for
signing, then you should configure the following settings on the SAML realm:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">signing.keystore.path</code>
</span>
</dt>
<dd>
The path to the PKCS#12 or JKS keystore. e.g. <code class="literal">saml/saml-sign.p12</code>
</dd>
<dt>
<span class="term">
<code class="literal">signing.keystore.alias</code>
</span>
</dt>
<dd>
The alias of the key within the keystore. e.g. <code class="literal">signing-key</code>
</dd>
<dt>
<span class="term">
<code class="literal">signing.keystore.secure_password</code>
</span>
</dt>
<dd>
The passphrase for the keystore, if the file is encrypted. This is a
<a class="xref" href="secure-settings.html" title="Secure settings">secure setting</a> that must be set with the
<code class="literal">elasticsearch-keystore</code> tool.
</dd>
</dl>
</div>
<p>If you wish to sign some, but not all outgoing <span class="strong strong"><strong>SAML messages</strong></span>, then you
should configure the following setting on the SAML realm:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">signing.saml_messages</code>
</span>
</dt>
<dd>
A list of message types to sign. A message type is identified by the
<em>local name</em> of the XML element used for the message. Supported values
are: <code class="literal">AuthnRequest</code>, <code class="literal">LogoutRequest</code> and <code class="literal">LogoutResponse</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_configuring_elasticsearch_for_encrypted_messages"></a>Configuring Elasticsearch for encrypted messages<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>The Elasticsearch security features support a single key for message decryption. If a
key is configured, then Elasticsearch attempts to use it to decrypt
<code class="literal">EncryptedAssertion</code> and <code class="literal">EncryptedAttribute</code> elements in Authentication
responses, and <code class="literal">EncryptedID</code> elements in Logout requests.</p>
<p>Elasticsearch rejects any SAML message that contains an <code class="literal">EncryptedAssertion</code>
that cannot be decrypted.</p>
<p>If an <code class="literal">Assertion</code> contains both encrypted and plain-text attributes, then
failure to decrypt the encrypted attributes will not cause an automatic
rejection. Rather, Elasticsearch processes the available plain-text attributes
(and any <code class="literal">EncryptedAttributes</code> that could be decrypted).</p>
<p>If you wish to use <span class="strong strong"><strong>PEM formatted</strong></span> keys and certificates for SAML encryption,
then you should configure the following settings on the SAML realm:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">encryption.certificate</code>
</span>
</dt>
<dd>
The path to the PEM formatted certificate file. e.g. <code class="literal">saml/saml-crypt.crt</code>
</dd>
<dt>
<span class="term">
<code class="literal">encryption.key</code>
</span>
</dt>
<dd>
The path to the PEM formatted key file. e.g. <code class="literal">saml/saml-crypt.key</code>
</dd>
<dt>
<span class="term">
<code class="literal">encryption.secure_key_passphrase</code>
</span>
</dt>
<dd>
The passphrase for the key, if the file is encrypted. This is a
<a class="xref" href="secure-settings.html" title="Secure settings">secure setting</a> that must be set with the
<code class="literal">elasticsearch-keystore</code> tool.
</dd>
</dl>
</div>
<p>If you wish to use <span class="strong strong"><strong>PKCS#12 formatted</strong></span> files or a <span class="strong strong"><strong>Java Keystore</strong></span> for SAML
encryption, then you should configure the following settings on the SAML realm:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">encryption.keystore.path</code>
</span>
</dt>
<dd>
The path to the PKCS#12 or JKS keystore. e.g. <code class="literal">saml/saml-crypt.p12</code>
</dd>
<dt>
<span class="term">
<code class="literal">encryption.keystore.alias</code>
</span>
</dt>
<dd>
The alias of the key within the keystore. e.g. <code class="literal">encryption-key</code>
</dd>
<dt>
<span class="term">
<code class="literal">encryption.keystore.secure_password</code>
</span>
</dt>
<dd>
The passphrase for the keystore, if the file is encrypted. This is a
<a class="xref" href="secure-settings.html" title="Secure settings">secure setting</a> that must be set with the
<code class="literal">elasticsearch-keystore</code> tool.
</dd>
</dl>
</div>
</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-sp-metadata"></a>Generating SP metadata<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>Some Identity Providers support importing a metadata file from the Service
Provider. This will automatically configure many of the integration options
between the IdP and the SP.</p>
<p>The Elastic Stack supports generating such a metadata file using the
<a class="xref" href="saml-metadata.html" title="elasticsearch-saml-metadata"><code class="literal">bin/elasticsearch-saml-metadata</code> command</a> or the
<a class="xref" href="security-api-saml-sp-metadata.html" title="SAML service provider metadata API">SAML service provider metadata API</a>.</p>
<p>You can generate the SAML metadata by issuing the API request to Elasticsearch and store
it as an XML file using tools like <code class="literal">jq</code>. For example, the following command
generates the metadata for the SAML realm <code class="literal">realm1</code> and saves it to a
<code class="literal">metadata.xml</code> file:</p>
<a id="e85e3ab802fc9b40798fb0f546a7d05a"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">curl -u user_name:password  -X GET http://localhost:9200/_security/saml/metadata/saml1 -H 'Content-Type: application/json' | jq -r '.[]' &gt; metadata.xml</pre>
</div>
<div class="console_widget" data-snippet="snippets/2019.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-role-mapping"></a>Configuring role mappings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>When a user authenticates using SAML, they are identified to the Elastic Stack,
but this does not automatically grant them access to perform any actions or
access any data.</p>
<p>Your SAML users cannot do anything until they are assigned roles. This can be done
through either the
<a class="xref" href="security-api-put-role-mapping.html" title="Create or update role mappings API">add role mapping API</a> or with
<a class="xref" href="realm-chains.html#authorization_realms" title="Delegating authorization to another realm">authorization realms</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You cannot use <a class="xref" href="mapping-roles.html#mapping-roles-file" title="Using role mapping files">role mapping files</a>
to grant roles to users authenticating via SAML.</p>
</div>
</div>
<p>This is an example of a simple role mapping that grants the <code class="literal">example_role</code> role
to any user who authenticates against the <code class="literal">saml1</code> realm:</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.putRoleMapping({
  name: "saml-example",
  roles: ["example_role"],
  enabled: true,
  rules: {
    field: {
      "realm.name": "saml1",
    },
  },
});
console.log(response);</pre>
</div>
<a id="862907653d1c18d2e80eff7f421200e2"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">PUT /_security/role_mapping/saml-example
{
  "roles": [ "example_role" ], <a id="CO649-1"></a><i class="conum" data-value="1"></i>
  "enabled": true,
  "rules": {
    "field": { "realm.name": "saml1" }
  }
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2020.console"></div>
<div class="calloutlist default has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO649-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">example_role</code> role is <span class="strong strong"><strong>not</strong></span> a builtin Elasticsearch role.
This example assumes that you have created a custom role of your own, with
appropriate access to your <a class="xref" href="defining-roles.html#roles-indices-priv" title="Indices privileges">data streams, indices,</a> and
<a href="/guide/en/kibana/master/kibana-privileges.html#kibana-feature-privileges" class="ulink" target="_top">Kibana features</a>.</p>
</td>
</tr>
</table>
</div>
<p>The attributes that are mapped via the realm configuration are used to process
role mapping rules, and these rules determine which roles a user is granted.</p>
<p>The user fields that are provided to the role
mapping are derived from the SAML attributes as follows:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">username</code>: The <code class="literal">principal</code> attribute
</li>
<li class="listitem">
<code class="literal">dn</code>: The <code class="literal">dn</code> attribute
</li>
<li class="listitem">
<code class="literal">groups</code>: The <code class="literal">groups</code> attribute
</li>
<li class="listitem">
<code class="literal">metadata</code>: See <a class="xref" href="saml-guide-stack.html#saml-user-metadata" title="User metadata">User metadata</a>
</li>
</ul>
</div>
<p>For more information, see <a class="xref" href="mapping-roles.html" title="Mapping users and groups to roles">Mapping users and groups to roles</a> and
<a class="xref" href="security-api.html#security-role-mapping-apis" title="Role mappings">Role mappings</a>.</p>
<p>If your IdP has the ability to provide groups or roles to Service Providers,
then you should map this SAML attribute to the <code class="literal">attributes.groups</code> setting in
the Elasticsearch realm, and then make use of it in a role mapping as per the example
below.</p>
<p>This mapping grants the Elasticsearch <code class="literal">finance_data</code> role, to any users who authenticate
via the <code class="literal">saml1</code> realm with the <code class="literal">finance-team</code> group.</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.putRoleMapping({
  name: "saml-finance",
  roles: ["finance_data"],
  enabled: true,
  rules: {
    all: [
      {
        field: {
          "realm.name": "saml1",
        },
      },
      {
        field: {
          groups: "finance-team",
        },
      },
    ],
  },
});
console.log(response);</pre>
</div>
<a id="aac5996a8398cc8f7701a063df0b2346"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">PUT /_security/role_mapping/saml-finance
{
  "roles": [ "finance_data" ],
  "enabled": true,
  "rules": { "all": [
        { "field": { "realm.name": "saml1" } },
        { "field": { "groups": "finance-team" } } <a id="CO650-1"></a><i class="conum" data-value="1"></i>
  ] }
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2021.console"></div>
<div class="calloutlist default has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO650-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">groups</code> attribute supports using wildcards (<code class="literal">*</code>). Refer to the
<a class="xref" href="security-api-put-role-mapping.html#security-api-put-role-mapping-example" title="Examples">create or update role mappings API</a> for
more information.</p>
</td>
</tr>
</table>
</div>
<p>If your users also exist in a repository that can be directly accessed by Elasticsearch
(such as an LDAP directory) then you can use
<a class="xref" href="realm-chains.html#authorization_realms" title="Delegating authorization to another realm">authorization realms</a> instead of role mappings.</p>
<p>In this case, you perform the following steps:
1. In your SAML realm, assigned a SAML attribute to act as the lookup userid,
   by configuring the <code class="literal">attributes.principal</code> setting.
2. Create a new realm that can lookup users from your local repository (e.g. an
   <code class="literal">ldap</code> realm)
3. In your SAML realm, set <code class="literal">authorization_realms</code> to the name of the realm you
   created in step 2.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-user-metadata"></a>User metadata<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>By default users who authenticate via SAML will have some additional metadata
fields.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">saml_nameid</code> will be set to the value of the <code class="literal">NameID</code> element in the SAML
authentication response
</li>
<li class="listitem">
<code class="literal">saml_nameid_format</code> will be set to the full URI of the NameID&#8217;s <code class="literal">format</code>
attribute
</li>
<li class="listitem">
Every SAML Attribute that is provided in the authentication response
(regardless of whether it is mapped to an Elasticsearch user property), will be added
as the metadata field <code class="literal">saml(name)</code> where "name" is the full URI name of the
attribute. For example <code class="literal">saml(urn:oid:0.9.2342.19200300.100.1.3)</code>.
</li>
<li class="listitem">
For every SAML Attribute that has a <em>friendlyName</em>, will also be added as the
metadata field <code class="literal">saml_friendlyName</code> where "name" is the full URI name of the
attribute. For example <code class="literal">saml_mail</code>.
</li>
</ul>
</div>
<p>This behaviour can be disabled by adding <code class="literal">populate_user_metadata: false</code> to as
a setting in the saml realm.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-configure-kibana"></a>Configuring Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>SAML authentication in Kibana requires a small number of additional settings
in addition to the standard Kibana security configuration. The
<a href="/guide/en/kibana/master/using-kibana-with-security.html" class="ulink" target="_top">Kibana security documentation</a>
provides details on the available configuration options that you can apply.</p>
<p>In particular, since your Elasticsearch nodes have been configured to use TLS on the HTTP
interface, you must configure Kibana to use a <code class="literal">https</code> URL to connect to Elasticsearch, and
you may need to configure <code class="literal">elasticsearch.ssl.certificateAuthorities</code> to trust
the certificates that Elasticsearch has been configured to use.</p>
<p>SAML authentication in Kibana is subject to the following timeout settings in
<code class="literal">kibana.yml</code>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="/guide/en/kibana/master/xpack-security-session-management.html#session-idle-timeout" class="ulink" target="_top"><code class="literal">xpack.security.session.idleTimeout</code></a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/master/xpack-security-session-management.html#session-lifespan" class="ulink" target="_top"><code class="literal">xpack.security.session.lifespan</code></a>
</li>
</ul>
</div>
<p>You may want to adjust these timeouts based on your security requirements.</p>
<p>The three additional settings that are required for SAML support are shown below:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.providers:
  saml.saml1:
    order: 0
    realm: "saml1"</pre>
</div>
<p>The configuration values used in the example above are:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">xpack.security.authc.providers</code>
</span>
</dt>
<dd>
Add <code class="literal">saml</code> provider to instruct Kibana to use SAML SSO as the authentication
method.
</dd>
<dt>
<span class="term">
<code class="literal">xpack.security.authc.providers.saml.&lt;provider-name&gt;.realm</code>
</span>
</dt>
<dd>
Set this to the name of the SAML realm that you have used in your <a class="xref" href="saml-guide-stack.html#saml-create-realm" title="Create a SAML realm">Elasticsearch realm configuration</a>, for instance: <code class="literal">saml1</code>
</dd>
</dl>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-kibana-basic"></a>Supporting SAML and basic authentication in Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The SAML support in Kibana is designed on the expectation that it will be the
primary (or sole) authentication method for users of that Kibana instance.
However, it is possible to support both SAML and Basic authentication within a
single Kibana instance by setting <code class="literal">xpack.security.authc.providers</code> as per the
example below:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.providers:
  saml.saml1:
    order: 0
    realm: "saml1"
  basic.basic1:
    order: 1</pre>
</div>
<p>If Kibana is configured in this way, users are presented with a choice
at the Login Selector UI. They log in with SAML or they provide a username and password and rely on one
of the other security realms within Elasticsearch. Only users who have
a username and password for a configured Elasticsearch authentication realm can
log in via Kibana login form.</p>
<p>Alternatively, when the <code class="literal">basic</code> authentication provider is enabled, you can
place a reverse proxy in front of Kibana, and configure it to send a basic
authentication header (<code class="literal">Authorization: Basic ....</code>) for each request.
If this header is present and valid, Kibana will not initiate the SAML
authentication process.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_operating_multiple_kibana_instances"></a>Operating multiple Kibana instances<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>If you wish to have multiple Kibana instances that authenticate against the same
Elasticsearch cluster, then each Kibana instance that is configured for SAML authentication,
requires its own SAML realm.</p>
<p>Each SAML realm must have its own unique Entity ID (<code class="literal">sp.entity_id</code>), and its own
<em>Assertion Consumer Service</em> (<code class="literal">sp.acs</code>). Each Kibana instance will be mapped to
the correct realm by looking up the matching <code class="literal">sp.acs</code> value.</p>
<p>These realms may use the same Identity Provider, but are not required to.</p>
<p>The following is example of having 3 difference Kibana instances, 2 of which
use the same internal IdP, and another which uses a different IdP.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.saml.saml_finance:
  order: 2
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.finance.example.com/"
  sp.acs: "https://kibana.finance.example.com/api/security/saml/callback"
  sp.logout: "https://kibana.finance.example.com/logout"
  attributes.principal: "urn:oid:0.9.2342.19200300.100.1.1"
  attributes.groups: "urn:oid:1.3.6.1.4.1.5923.1.5.1."
xpack.security.authc.realms.saml.saml_sales:
  order: 3
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.sales.example.com/"
  sp.acs: "https://kibana.sales.example.com/api/security/saml/callback"
  sp.logout: "https://kibana.sales.example.com/logout"
  attributes.principal: "urn:oid:0.9.2342.19200300.100.1.1"
  attributes.groups: "urn:oid:1.3.6.1.4.1.5923.1.5.1."
xpack.security.authc.realms.saml.saml_eng:
  order: 4
  idp.metadata.path: saml/idp-external.xml
  idp.entity_id: "https://engineering.sso.example.net/"
  sp.entity_id:  "https://kibana.engineering.example.com/"
  sp.acs: "https://kibana.engineering.example.com/api/security/saml/callback"
  sp.logout: "https://kibana.engineering.example.com/logout"
  attributes.principal: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn"</pre>
</div>
<p>It is possible to have one or more Kibana instances that use SAML, while other
instances use basic authentication against another realm type (e.g.
<a class="xref" href="native-realm.html" title="Native user authentication">Native</a> or <a class="xref" href="ldap-realm.html" title="LDAP user authentication">LDAP</a>).</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-troubleshooting"></a>Troubleshooting SAML Realm Configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>The SAML 2.0 specification offers a lot of options and flexibility for the implementers
of the standard which in turn adds to the complexity and the number of configuration options
that are available both at the Service Provider (Elastic Stack) and at the Identity Provider.
Additionally, different security domains have different security requirements that need
specific configuration to be satisfied.
A conscious effort has been made to mask this complexity with sane defaults and the detailed
documentation above but in case you encounter issues while configuring a SAML realm, you can
look through our <a class="xref" href="trb-security-saml.html" title="Common SAML issues">SAML troubleshooting documentation</a> that has
suggestions and resolutions for common issues.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-no-kibana"></a>SAML without Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>The SAML realm in Elasticsearch is designed to allow users to authenticate to Kibana and as
such, most of the parts of the guide above make the assumption that Kibana is used.
This section describes how a custom web application could use the relevant SAML
REST APIs in order to authenticate the users to Elasticsearch with SAML.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This section assumes that the reader is familiar with the SAML 2.0 standard
and more specifically with the SAML 2.0 Web Browser Single Sign On profile.</p>
</div>
</div>
<p>Single sign-on realms such as OpenID Connect and SAML make use of the Token Service in
Elasticsearch and in principle exchange a SAML or OpenID Connect Authentication response for
an Elasticsearch access token and a refresh token. The access token is used as credentials
for subsequent calls to Elasticsearch. The refresh token enables the user to get new Elasticsearch
access tokens after the current one expires.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-no-kibana-realm"></a>SAML realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>You must create a SAML realm and configure it accordingly
in Elasticsearch. See <a class="xref" href="saml-guide-stack.html#saml-elasticsearch-authentication" title="Configure Elasticsearch for SAML authentication">Configure Elasticsearch for SAML authentication</a></p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-no-kibana-user"></a>Service Account user for accessing the APIs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The realm is designed with the assumption that there needs to be a privileged entity
acting as an authentication proxy. In this case, the custom web application is the
authentication proxy handling the authentication of end users (more correctly,
"delegating" the authentication to the SAML Identity Provider). The SAML related
APIs require authentication and the necessary authorization level for the authenticated
user. For this reason, you must create a Service Account user and assign it a role
that gives it the <code class="literal">manage_saml</code> cluster privilege. The use of the <code class="literal">manage_token</code>
cluster privilege will be necessary after the authentication takes place, so that
the service account user can maintain access in order refresh access tokens on
behalf of the authenticated users or to subsequently log them out.</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.putRole({
  name: "saml-service-role",
  cluster: ["manage_saml", "manage_token"],
});
console.log(response);</pre>
</div>
<a id="49cb3f48a0097bfc597c52fa51c6d379"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /_security/role/saml-service-role
{
  "cluster" : ["manage_saml", "manage_token"]
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2022.console"></div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.putUser({
  username: "saml-service-user",
  password: "&lt;somePasswordHere&gt;",
  roles: ["saml-service-role"],
});
console.log(response);</pre>
</div>
<a id="b2b26f8568c5dba7649e79f09b859272"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /_security/user/saml-service-user
{
  "password" : "&lt;somePasswordHere&gt;",
  "roles"    : ["saml-service-role"]
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2023.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-no-kibana-sp-init-sso"></a>Handling the SP-initiated authentication flow<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>On a high level, the custom web application would need to perform the
following steps in order to authenticate a user with SAML against Elasticsearch:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Make an HTTP POST request to <code class="literal">_security/saml/prepare</code>, authenticating as
the <code class="literal">saml-service-user</code> user. Use either the name of the SAML realm in the Elasticsearch configuration or the value for
the Assertion Consumer Service URL in the request body.
See the <a class="xref" href="security-api-saml-prepare-authentication.html" title="SAML prepare authentication API">SAML prepare authentication API</a> for more details.</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.samlPrepareAuthentication({
  realm: "saml1",
});
console.log(response);</pre>
</div>
<a id="a5dfcfd1cfb3558e7912456669c92eee"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /_security/saml/prepare
{
  "realm" : "saml1"
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2024.console"></div>
</li>
<li class="listitem">
Handle the response from <code class="literal">/_security/saml/prepare</code>. The response from Elasticsearch will contain 3 parameters:
  <code class="literal">redirect</code>, <code class="literal">realm</code> and <code class="literal">id</code>. The custom web application would need to store the value for <code class="literal">id</code>
 in the user&#8217;s session (client side in a cookie or server side if session information is
persisted this way). It must also redirect the user&#8217;s browser to the URL that was returned in the
  <code class="literal">redirect</code> parameter. The <code class="literal">id</code> value should not be disregarded as it is used as a nonce in SAML in
order to mitigate against replay attacks.
</li>
<li class="listitem">
<p>Handle a subsequent response from the SAML IdP. After the user is successfully authenticated with the
Identity Provider they will be redirected back to the Assertion Consumer Service URL. This <code class="literal">sp.acs</code> needs to be
defined as a URL which the custom web application handles. When it receives this HTTP POST request, the
custom web application must parse it and make an HTTP POST request itself to the
<code class="literal">_security/saml/authenticate</code> API. It must authenticate as the <code class="literal">saml-service-user</code> user and pass
the Base64 encoded SAML Response that was sent as the body of the request. It must also pass the value for <code class="literal">id</code> that it had saved in the user&#8217;s session previously.</p>
<p>See <a class="xref" href="security-api-saml-authenticate.html" title="SAML authenticate API">SAML authenticate API</a> for more details.</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.samlAuthenticate({
  content:
    "PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMD.....",
  ids: ["4fee3b046395c4e751011e97f8900b5273d56685"],
});
console.log(response);</pre>
</div>
<a id="8e208098a0156c4c92afe0a06960b230"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /_security/saml/authenticate
{
  "content" : "PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMD.....",
  "ids" : ["4fee3b046395c4e751011e97f8900b5273d56685"]
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2025.console"></div>
<p>Elasticsearch will validate this and if all is correct will respond with an access token that can be used
as a <code class="literal">Bearer</code> token for subsequent requests. It also supplies a refresh token that can be later used to refresh the given
access token as described in <a class="xref" href="security-api-get-token.html" title="Get token API">get token API</a>.</p>
</li>
<li class="listitem">
The response to calling <code class="literal">/_security/saml/authenticate</code> will contain only the username of the authenticated
user. If you need to get the values for the SAML Attributes that were contained in the SAML
Response for that user, you can call the Authenticate API <code class="literal">/_security/_authenticate/</code> using the access token as a <code class="literal">Bearer</code> token
and the SAML attribute values will be contained in the response as part of the <a class="xref" href="saml-guide-stack.html#saml-user-metadata" title="User metadata">User metadata</a>.
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-no-kibana-idp-init-sso"></a>Handling the IdP-initiated authentication flow<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>Elasticsearch can also handle the IdP-initiated Single Sign On flow of the SAML 2 Web Browser SSO profile. In this
case the authentication starts with an unsolicited authentication response from the SAML Identity
Provider. The difference with the <a class="xref" href="saml-guide-stack.html#saml-no-kibana-sp-init-sso" title="Handling the SP-initiated authentication flow">SP initiated SSO</a> is that the web application needs to handle
requests to the <code class="literal">sp.acs</code> that will not come as responses to previous redirections. As such, it will not have a session
for the user already, and it will not have any stored values for the <code class="literal">id</code> parameter. The request to the
<code class="literal">_security/saml/authenticate</code> API will look like the one below in this case:</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.samlAuthenticate({
  content:
    "PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMD.....",
  ids: [],
});
console.log(response);</pre>
</div>
<a id="9eda9c39428b0c2c53cbd8ee7ae0f888"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /_security/saml/authenticate
{
  "content" : "PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMD.....",
  "ids" : []
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2026.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-no-kibana-slo"></a>Handling the logout flow<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>At some point, if necessary, the custom web application can log the user out by using the
<a class="xref" href="security-api-saml-logout.html" title="SAML logout API">SAML logout API</a> and passing the access token and refresh token as parameters. For example:</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.samlLogout({
  token: "46ToAxZVaXVVZTVKOVF5YU04ZFJVUDVSZlV3",
  refresh_token: "mJdXLtmvTUSpoLwMvdBt_w",
});
console.log(response);</pre>
</div>
<a id="553904c175a76d5ba83bc5d46fff7373"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /_security/saml/logout
{
  "token" : "46ToAxZVaXVVZTVKOVF5YU04ZFJVUDVSZlV3",
  "refresh_token": "mJdXLtmvTUSpoLwMvdBt_w"
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2027.console"></div>
<p>If the SAML realm is configured accordingly and the IdP supports it (see <a class="xref" href="saml-guide-stack.html#saml-logout" title="SAML logout">SAML logout</a>), this request will trigger a SAML
SP-initiated Single Logout. In this case, the response will include a <code class="literal">redirect</code>
parameter indicating where the user needs to be redirected at the IdP in order to complete the logout.</p>
</li>
<li class="listitem">
<p>Alternatively, the IdP might initiate the Single Logout flow at some point. In order to handle this,
the Logout URL (<code class="literal">sp.logout</code>) needs to be handled by the custom web app. The query part of the URL that the
user will be redirected to will contain a SAML Logout request and this query part needs to be relayed to Elasticsearch
using the <a class="xref" href="security-api-saml-invalidate.html" title="SAML invalidate API">SAML invalidate API</a></p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.security.samlInvalidate({
  query:
    "SAMLRequest=nZFda4MwFIb%2FiuS%2BmviRpqFaClKQdbvo2g12M2KMraCJ9cRR9utnW4Wyi13sMie873MeznJ1aWrnS3VQGR0j4mLkKC1NUeljjA77zYyhVbIE0dR%2By7fmaHq7U%2BdegXWGpAZ%2B%2F4pR32luBFTAtWgUcCv56%2Fp5y30X87Yz1khTIycdgpUW9kY7WdsC9zxoXTvMvWuVV98YyMnSGH2SYE5pwALBIr9QKiwDGpW0oGVUznGeMyJZKFkQ4jBf5HnhUymjIhzCAL3KNFihbYx8TBYzzGaY7EnIyZwHzCWMfiDnbRIftkSjJr%2BFu0e9v%2B0EgOquRiiZjKpiVFp6j50T4WXoyNJ%2FEWC9fdqc1t%2F1%2B2F3aUpjzhPiXpqMz1%2FHSn4A&amp;SigAlg=http%3A%2F%2Fwww.w3.org%2F2001%2F04%2Fxmldsig-more%23rsa-sha256&amp;Signature=MsAYz2NFdovMG2mXf6TSpu5vlQQyEJAg%2B4KCwBqJTmrb3yGXKUtIgvjqf88eCAK32v3eN8vupjPC8LglYmke1ZnjK0%2FKxzkvSjTVA7mMQe2AQdKbkyC038zzRq%2FYHcjFDE%2Bz0qISwSHZY2NyLePmwU7SexEXnIz37jKC6NMEhus%3D",
  realm: "saml1",
});
console.log(response);</pre>
</div>
<a id="a71154ea11a5214f409ecfd118e9b5e3"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /_security/saml/invalidate
{
  "query" : "SAMLRequest=nZFda4MwFIb%2FiuS%2BmviRpqFaClKQdbvo2g12M2KMraCJ9cRR9utnW4Wyi13sMie873MeznJ1aWrnS3VQGR0j4mLkKC1NUeljjA77zYyhVbIE0dR%2By7fmaHq7U%2BdegXWGpAZ%2B%2F4pR32luBFTAtWgUcCv56%2Fp5y30X87Yz1khTIycdgpUW9kY7WdsC9zxoXTvMvWuVV98YyMnSGH2SYE5pwALBIr9QKiwDGpW0oGVUznGeMyJZKFkQ4jBf5HnhUymjIhzCAL3KNFihbYx8TBYzzGaY7EnIyZwHzCWMfiDnbRIftkSjJr%2BFu0e9v%2B0EgOquRiiZjKpiVFp6j50T4WXoyNJ%2FEWC9fdqc1t%2F1%2B2F3aUpjzhPiXpqMz1%2FHSn4A&amp;SigAlg=http%3A%2F%2Fwww.w3.org%2F2001%2F04%2Fxmldsig-more%23rsa-sha256&amp;Signature=MsAYz2NFdovMG2mXf6TSpu5vlQQyEJAg%2B4KCwBqJTmrb3yGXKUtIgvjqf88eCAK32v3eN8vupjPC8LglYmke1ZnjK0%2FKxzkvSjTVA7mMQe2AQdKbkyC038zzRq%2FYHcjFDE%2Bz0qISwSHZY2NyLePmwU7SexEXnIz37jKC6NMEhus%3D",
  "realm" : "saml1"
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/2028.console"></div>
<p>The custom web application will then need to also handle the response, which will include a <code class="literal">redirect</code>
parameter with a URL in the IdP that contains the SAML Logout response. The application should redirect the user
there to complete the logout.</p>
</li>
</ol>
</div>
<p>For SP-initiated Single Logout, the IdP may send back a logout response which can be verified by Elasticsearch
using the <a class="xref" href="security-api-saml-complete-logout.html" title="SAML complete logout API">SAML complete logout API</a>.</p>
</div>

</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="controlling-user-cache.html">« Controlling the user cache</a>
</span>
<span class="next">
<a href="oidc-guide.html">Configuring single sign-on to the Elastic Stack using OpenID Connect »</a>
</span>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs-v1.js"></script>
    <script type="text/javascript">
  window.initial_state = {"alternatives":{"console":{"php":{"hasAny":true},"python":{"hasAny":true},"ruby":{"hasAny":true},"go":{"hasAny":true},"js":{"hasAny":true}}}}</script>
  </body>
</html>
