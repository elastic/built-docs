<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Top hits aggregation | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Top hits aggregation | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="search-aggregations-metrics.html" title="Metrics aggregations"/>
<link rel="prev" href="search-aggregations-metrics-ttest-aggregation.html" title="T-test aggregation"/>
<link rel="next" href="search-aggregations-metrics-top-metrics.html" title="Top metrics aggregation"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles-v1.css" />
  </head>

  <!--© 2015-2025 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="search-aggregations-metrics-ttest-aggregation.html">« T-test aggregation</a>
</span>
<span class="next">
<a href="search-aggregations-metrics-top-metrics.html">Top metrics aggregation »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search-aggregations.html">Aggregations</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search-aggregations-metrics.html">Metrics aggregations</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Top hits aggregation</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/tophits-aggregation.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-metrics-top-hits-aggregation"></a>Top hits aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/tophits-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A <code class="literal">top_hits</code> metric aggregator keeps track of the most relevant document being aggregated. This aggregator is intended
to be used as a sub aggregator, so that the top matching documents can be aggregated per bucket.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>We do not recommend using <code class="literal">top_hits</code> as a top-level aggregation. If you
want to group search hits, use the <a class="xref" href="collapse-search-results.html" title="Collapse search results"><code class="literal">collapse</code></a>
parameter instead.</p>
</div>
</div>
<p>The <code class="literal">top_hits</code> aggregator can effectively be used to group result sets by certain fields via a bucket aggregator.
One or more bucket aggregators determines by which properties a result set get sliced into.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_options_6"></a>Options<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/tophits-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">from</code> - The offset from the first result you want to fetch.
</li>
<li class="listitem">
<code class="literal">size</code> - The maximum number of top matching hits to return per bucket. By default the top three matching hits are returned.
</li>
<li class="listitem">
<code class="literal">sort</code> - How the top matching hits should be sorted. By default the hits are sorted by the score of the main query.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_supported_per_hit_features"></a>Supported per hit features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/tophits-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The top_hits aggregation returns regular search hits, because of this many per hit features can be supported:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="highlighting.html" title="Highlighting">Highlighting</a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#request-body-search-explain">Explain</a>
</li>
<li class="listitem">
<a class="xref" href="query-dsl-bool-query.html#named-queries" title="Named queries">Named queries</a>
</li>
<li class="listitem">
<a class="xref" href="search-fields.html#search-fields-param" title="The fields option">Search fields</a>
</li>
<li class="listitem">
<a class="xref" href="search-fields.html#source-filtering" title="The _source option">Source filtering</a>
</li>
<li class="listitem">
<a class="xref" href="search-fields.html#stored-fields" title="Stored fields">Stored fields</a>
</li>
<li class="listitem">
<a class="xref" href="search-fields.html#script-fields" title="Script fields">Script fields</a>
</li>
<li class="listitem">
<a class="xref" href="search-fields.html#docvalue-fields" title="Doc value fields">Doc value fields</a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#request-body-search-version">Include versions</a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#request-body-search-seq-no-primary-term">Include Sequence Numbers and Primary Terms</a>
</li>
</ul>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you <span class="strong strong"><strong>only</strong></span> need <code class="literal">docvalue_fields</code>, <code class="literal">size</code>, and <code class="literal">sort</code> then
<a class="xref" href="search-aggregations-metrics-top-metrics.html" title="Top metrics aggregation">Top metrics</a> might be a more efficient choice than the Top Hits Aggregation.</p>
</div>
</div>
<p><code class="literal">top_hits</code> does not support the <a class="xref" href="filter-search-results.html#rescore" title="Rescore filtered search results"><code class="literal">rescore</code></a> parameter. Query rescoring
applies only to search hits, not aggregation results. To change the scores used
by aggregations, use a <a class="xref" href="query-dsl-function-score-query.html" title="Function score query"><code class="literal">function_score</code></a> or
<a class="xref" href="query-dsl-script-score-query.html" title="Script score query"><code class="literal">script_score</code></a> query.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_example_6"></a>Example<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/tophits-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>In the following example we group the sales by type and per type we show the last sale.
For each sale only the date and price fields are being included in the source.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'sales',
  size: 0,
  body: {
    aggregations: {
      top_tags: {
        terms: {
          field: 'type',
          size: 3
        },
        aggregations: {
          top_sales_hits: {
            top_hits: {
              sort: [
                {
                  date: {
                    order: 'desc'
                  }
                }
              ],
              _source: {
                includes: [
                  'date',
                  'price'
                ]
              },
              size: 1
            }
          }
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "sales",
  size: 0,
  aggs: {
    top_tags: {
      terms: {
        field: "type",
        size: 3,
      },
      aggs: {
        top_sales_hits: {
          top_hits: {
            sort: [
              {
                date: {
                  order: "desc",
                },
              },
            ],
            _source: {
              includes: ["date", "price"],
            },
            size: 1,
          },
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="4c777b8360ef6c7671ae2e3803c0b0f6"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">POST /sales/_search?size=0
{
  "aggs": {
    "top_tags": {
      "terms": {
        "field": "type",
        "size": 3
      },
      "aggs": {
        "top_sales_hits": {
          "top_hits": {
            "sort": [
              {
                "date": {
                  "order": "desc"
                }
              }
            ],
            "_source": {
              "includes": [ "date", "price" ]
            },
            "size": 1
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/1615.console"></div>
<p>Possible response:</p>
<a id="ac5c534e77684388b5126e2960db0d3f"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  ...
  "aggregations": {
    "top_tags": {
       "doc_count_error_upper_bound": 0,
       "sum_other_doc_count": 0,
       "buckets": [
          {
             "key": "hat",
             "doc_count": 3,
             "top_sales_hits": {
                "hits": {
                   "total" : {
                       "value": 3,
                       "relation": "eq"
                   },
                   "max_score": null,
                   "hits": [
                      {
                         "_index": "sales",
                         "_id": "AVnNBmauCQpcRyxw6ChK",
                         "_source": {
                            "date": "2015/03/01 00:00:00",
                            "price": 200
                         },
                         "sort": [
                            1425168000000
                         ],
                         "_score": null
                      }
                   ]
                }
             }
          },
          {
             "key": "t-shirt",
             "doc_count": 3,
             "top_sales_hits": {
                "hits": {
                   "total" : {
                       "value": 3,
                       "relation": "eq"
                   },
                   "max_score": null,
                   "hits": [
                      {
                         "_index": "sales",
                         "_id": "AVnNBmauCQpcRyxw6ChL",
                         "_source": {
                            "date": "2015/03/01 00:00:00",
                            "price": 175
                         },
                         "sort": [
                            1425168000000
                         ],
                         "_score": null
                      }
                   ]
                }
             }
          },
          {
             "key": "bag",
             "doc_count": 1,
             "top_sales_hits": {
                "hits": {
                   "total" : {
                       "value": 1,
                       "relation": "eq"
                   },
                   "max_score": null,
                   "hits": [
                      {
                         "_index": "sales",
                         "_id": "AVnNBmatCQpcRyxw6ChH",
                         "_source": {
                            "date": "2015/01/01 00:00:00",
                            "price": 150
                         },
                         "sort": [
                            1420070400000
                         ],
                         "_score": null
                      }
                   ]
                }
             }
          }
       ]
    }
  }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_field_collapse_example"></a>Field collapse example<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/tophits-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>Field collapsing or result grouping is a feature that logically groups a result set into groups and per group returns
top documents. The ordering of the groups is determined by the relevancy of the first document in a group. In
Elasticsearch this can be implemented via a bucket aggregator that wraps a <code class="literal">top_hits</code> aggregator as sub-aggregator.</p>
<p>In the example below we search across crawled webpages. For each webpage we store the body and the domain the webpage
belong to. By defining a <code class="literal">terms</code> aggregator on the <code class="literal">domain</code> field we group the result set of webpages by domain. The
<code class="literal">top_hits</code> aggregator is then defined as sub-aggregator, so that the top matching hits are collected per bucket.</p>
<p>Also a <code class="literal">max</code> aggregator is defined which is used by the <code class="literal">terms</code> aggregator&#8217;s order feature to return the buckets by
relevancy order of the most relevant document in a bucket.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'sales',
  body: {
    query: {
      match: {
        body: 'elections'
      }
    },
    aggregations: {
      top_sites: {
        terms: {
          field: 'domain',
          order: {
            top_hit: 'desc'
          }
        },
        aggregations: {
          top_tags_hits: {
            top_hits: {}
          },
          top_hit: {
            max: {
              script: {
                source: '_score'
              }
            }
          }
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "sales",
  query: {
    match: {
      body: "elections",
    },
  },
  aggs: {
    top_sites: {
      terms: {
        field: "domain",
        order: {
          top_hit: "desc",
        },
      },
      aggs: {
        top_tags_hits: {
          top_hits: {},
        },
        top_hit: {
          max: {
            script: {
              source: "_score",
            },
          },
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="30db2702dd0071c72a090b8311d0db09"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">POST /sales/_search
{
  "query": {
    "match": {
      "body": "elections"
    }
  },
  "aggs": {
    "top_sites": {
      "terms": {
        "field": "domain",
        "order": {
          "top_hit": "desc"
        }
      },
      "aggs": {
        "top_tags_hits": {
          "top_hits": {}
        },
        "top_hit" : {
          "max": {
            "script": {
              "source": "_score"
            }
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/1616.console"></div>
<p>At the moment the <code class="literal">max</code> (or <code class="literal">min</code>) aggregator is needed to make sure the buckets from the <code class="literal">terms</code> aggregator are
ordered according to the score of the most relevant webpage per domain. Unfortunately the <code class="literal">top_hits</code> aggregator
can&#8217;t be used in the <code class="literal">order</code> option of the <code class="literal">terms</code> aggregator yet.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_top_hits_support_in_a_nested_or_reverse_nested_aggregator"></a>top_hits support in a nested or reverse_nested aggregator<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/tophits-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>If the <code class="literal">top_hits</code> aggregator is wrapped in a <code class="literal">nested</code> or <code class="literal">reverse_nested</code> aggregator then nested hits are being returned.
Nested hits are in a sense hidden mini documents that are part of regular document where in the mapping a nested field type
has been configured. The <code class="literal">top_hits</code> aggregator has the ability to un-hide these documents if it is wrapped in a <code class="literal">nested</code>
or <code class="literal">reverse_nested</code> aggregator. Read more about nested in the <a class="xref" href="nested.html" title="Nested field type">nested type mapping</a>.</p>
<p>If nested type has been configured a single document is actually indexed as multiple Lucene documents and they share
the same id. In order to determine the identity of a nested hit there is more needed than just the id, so that is why
nested hits also include their nested identity. The nested identity is kept under the <code class="literal">_nested</code> field in the search hit
and includes the array field and the offset in the array field the nested hit belongs to. The offset is zero based.</p>
<p>Let&#8217;s see how it works with a real sample. Considering the following mapping:</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.create(
  index: 'sales',
  body: {
    mappings: {
      properties: {
        tags: {
          type: 'keyword'
        },
        comments: {
          type: 'nested',
          properties: {
            username: {
              type: 'keyword'
            },
            comment: {
              type: 'text'
            }
          }
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.create({
  index: "sales",
  mappings: {
    properties: {
      tags: {
        type: "keyword",
      },
      comments: {
        type: "nested",
        properties: {
          username: {
            type: "keyword",
          },
          comment: {
            type: "text",
          },
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="025155da86802ebf4c3aeee5aab692f9"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">PUT /sales
{
  "mappings": {
    "properties": {
      "tags": { "type": "keyword" },
      "comments": {                           <a id="CO402-1"></a><i class="conum" data-value="1"></i>
        "type": "nested",
        "properties": {
          "username": { "type": "keyword" },
          "comment": { "type": "text" }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/1617.console"></div>
<div class="calloutlist default has-ruby has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO402-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">comments</code> is an array that holds nested documents under the <code class="literal">product</code> object.</p>
</td>
</tr>
</table>
</div>
<p>And some documents:</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.index(
  index: 'sales',
  id: 1,
  refresh: true,
  body: {
    tags: [
      'car',
      'auto'
    ],
    comments: [
      {
        username: 'baddriver007',
        comment: 'This car could have better brakes'
      },
      {
        username: 'dr_who',
        comment: "Where's the autopilot? Can't find it"
      },
      {
        username: 'ilovemotorbikes',
        comment: 'This car has two extra wheels'
      }
    ]
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.index({
  index: "sales",
  id: 1,
  refresh: "true",
  document: {
    tags: ["car", "auto"],
    comments: [
      {
        username: "baddriver007",
        comment: "This car could have better brakes",
      },
      {
        username: "dr_who",
        comment: "Where's the autopilot? Can't find it",
      },
      {
        username: "ilovemotorbikes",
        comment: "This car has two extra wheels",
      },
    ],
  },
});
console.log(response);</pre>
</div>
<a id="a8add749c3f41ad1308a45308df14103"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">PUT /sales/_doc/1?refresh
{
  "tags": [ "car", "auto" ],
  "comments": [
    { "username": "baddriver007", "comment": "This car could have better brakes" },
    { "username": "dr_who", "comment": "Where's the autopilot? Can't find it" },
    { "username": "ilovemotorbikes", "comment": "This car has two extra wheels" }
  ]
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/1618.console"></div>
<p>It&#8217;s now possible to execute the following <code class="literal">top_hits</code> aggregation (wrapped in a <code class="literal">nested</code> aggregation):</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'sales',
  body: {
    query: {
      term: {
        tags: 'car'
      }
    },
    aggregations: {
      by_sale: {
        nested: {
          path: 'comments'
        },
        aggregations: {
          by_user: {
            terms: {
              field: 'comments.username',
              size: 1
            },
            aggregations: {
              by_nested: {
                top_hits: {}
              }
            }
          }
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "sales",
  query: {
    term: {
      tags: "car",
    },
  },
  aggs: {
    by_sale: {
      nested: {
        path: "comments",
      },
      aggs: {
        by_user: {
          terms: {
            field: "comments.username",
            size: 1,
          },
          aggs: {
            by_nested: {
              top_hits: {},
            },
          },
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="a1377b32d7fe3680079ae0df73009b0e"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">POST /sales/_search
{
  "query": {
    "term": { "tags": "car" }
  },
  "aggs": {
    "by_sale": {
      "nested": {
        "path": "comments"
      },
      "aggs": {
        "by_user": {
          "terms": {
            "field": "comments.username",
            "size": 1
          },
          "aggs": {
            "by_nested": {
              "top_hits": {}
            }
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/1619.console"></div>
<p>Top hits response snippet with a nested hit, which resides in the first slot of array field <code class="literal">comments</code>:</p>
<a id="7360e36c8ba3511fa133472ec101fff3"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  ...
  "aggregations": {
    "by_sale": {
      "by_user": {
        "buckets": [
          {
            "key": "baddriver007",
            "doc_count": 1,
            "by_nested": {
              "hits": {
                "total" : {
                   "value": 1,
                   "relation": "eq"
                },
                "max_score": 0.3616575,
                "hits": [
                  {
                    "_index": "sales",
                    "_id": "1",
                    "_nested": {
                      "field": "comments",  <a id="CO403-1"></a><i class="conum" data-value="1"></i>
                      "offset": 0 <a id="CO403-2"></a><i class="conum" data-value="2"></i>
                    },
                    "_score": 0.3616575,
                    "_source": {
                      "comment": "This car could have better brakes", <a id="CO403-3"></a><i class="conum" data-value="3"></i>
                      "username": "baddriver007"
                    }
                  }
                ]
              }
            }
          }
          ...
        ]
      }
    }
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO403-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Name of the array field containing the nested hit</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO403-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Position if the nested hit in the containing array</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO403-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Source of the nested hit</p>
</td>
</tr>
</table>
</div>
<p>If <code class="literal">_source</code> is requested then just the part of the source of the nested object is returned, not the entire source of the document.
Also stored fields on the <span class="strong strong"><strong>nested</strong></span> inner object level are accessible via <code class="literal">top_hits</code> aggregator residing in a <code class="literal">nested</code> or <code class="literal">reverse_nested</code> aggregator.</p>
<p>Only nested hits will have a <code class="literal">_nested</code> field in the hit, non nested (regular) hits will not have a <code class="literal">_nested</code> field.</p>
<p>The information in <code class="literal">_nested</code> can also be used to parse the original source somewhere else if <code class="literal">_source</code> isn&#8217;t enabled.</p>
<p>If there are multiple levels of nested object types defined in mappings then the <code class="literal">_nested</code> information can also be hierarchical
in order to express the identity of nested hits that are two layers deep or more.</p>
<p>In the example below a nested hit resides in the first slot of the field <code class="literal">nested_grand_child_field</code> which then resides in
the second slow of the <code class="literal">nested_child_field</code> field:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">...
"hits": {
 "total" : {
     "value": 2565,
     "relation": "eq"
 },
 "max_score": 1,
 "hits": [
   {
     "_index": "a",
     "_id": "1",
     "_score": 1,
     "_nested" : {
       "field" : "nested_child_field",
       "offset" : 1,
       "_nested" : {
         "field" : "nested_grand_child_field",
         "offset" : 0
       }
     }
     "_source": ...
   },
   ...
 ]
}
...</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_use_in_pipeline_aggregations"></a>Use in pipeline aggregations<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/tophits-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p><code class="literal">top_hits</code> can be used in pipeline aggregations that consume a single value per bucket, such as <code class="literal">bucket_selector</code>
that applies per bucket filtering, similar to using a HAVING clause in SQL. This requires setting <code class="literal">size</code> to 1, and
specifying the right path for the value to be passed to the wrapping aggregator. The latter can be a <code class="literal">_source</code>, a
<code class="literal">_sort</code> or a <code class="literal">_score</code> value. For example:</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "sales",
  size: 0,
  aggs: {
    top_tags: {
      terms: {
        field: "type",
        size: 3,
      },
      aggs: {
        top_sales_hits: {
          top_hits: {
            sort: [
              {
                date: {
                  order: "desc",
                },
              },
            ],
            _source: {
              includes: ["date", "price"],
            },
            size: 1,
          },
        },
        "having.top_salary": {
          bucket_selector: {
            buckets_path: {
              tp: "top_sales_hits[_source.price]",
            },
            script: "params.tp &lt; 180",
          },
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="e1220f2c28db6ef0233e26e6bd3866fa"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /sales/_search?size=0
{
  "aggs": {
    "top_tags": {
      "terms": {
        "field": "type",
        "size": 3
      },
      "aggs": {
        "top_sales_hits": {
          "top_hits": {
            "sort": [
              {
                "date": {
                  "order": "desc"
                }
              }
            ],
            "_source": {
              "includes": [ "date", "price" ]
            },
            "size": 1
          }
        },
        "having.top_salary": {
          "bucket_selector": {
            "buckets_path": {
              "tp": "top_sales_hits[_source.price]"
            },
            "script": "params.tp &lt; 180"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/1620.console"></div>
<p>The <code class="literal">bucket_path</code> uses the <code class="literal">top_hits</code> name <code class="literal">top_sales_hits</code> and a keyword for the field providing the aggregate value,
namely <code class="literal">_source</code> field <code class="literal">price</code> in the example above. Other options include <code class="literal">top_sales_hits[_sort]</code>, for filtering on the
sort value <code class="literal">date</code> above, and <code class="literal">top_sales_hits[_score]</code>, for filtering on the score of the top hit.</p>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="search-aggregations-metrics-ttest-aggregation.html">« T-test aggregation</a>
</span>
<span class="next">
<a href="search-aggregations-metrics-top-metrics.html">Top metrics aggregation »</a>
</span>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs-v1.js"></script>
    <script type="text/javascript">
  window.initial_state = {"alternatives":{"console":{"php":{"hasAny":true},"python":{"hasAny":true},"ruby":{"hasAny":true},"go":{"hasAny":true},"js":{"hasAny":true}}}}</script>
  </body>
</html>
