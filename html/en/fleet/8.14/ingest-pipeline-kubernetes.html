<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Using a custom ingest pipeline with the Kubernetes Integration | Fleet and Elastic Agent Guide [8.14] | Elastic</title>
<meta class="elastic" name="content" content="Using a custom ingest pipeline with the Kubernetes Integration | Fleet and Elastic Agent Guide [8.14]">

<link rel="home" href="index.html" title="Fleet and Elastic Agent Guide [8.14]"/>
<link rel="up" href="install-elastic-agents-in-containers.html" title="Install Elastic Agents in a containerized environment"/>
<link rel="prev" href="scaling-on-kubernetes.html" title="Scaling Elastic Agent on Kubernetes"/>
<link rel="next" href="agent-environment-variables.html" title="Elastic Agent environment variables"/>
<meta class="elastic" name="product_version" content="8.14"/>
<meta class="elastic" name="product_name" content="Fleet and Elastic Agent"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Fleet/Guide/Elastic Agent/8.14"/>
<meta name="DC.subject" content="Fleet and Elastic Agent"/>
<meta name="DC.identifier" content="8.14"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Fleet and Elastic Agent Guide [8.14]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="elastic-agent-installation.html">Install Elastic Agents</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="install-elastic-agents-in-containers.html">Install Elastic Agents in a containerized environment</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="scaling-on-kubernetes.html">« Scaling Elastic Agent on Kubernetes</a>
</span>
<span class="next">
<a href="agent-environment-variables.html">Elastic Agent environment variables »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="ingest-pipeline-kubernetes"></a>Using a custom ingest pipeline with the Kubernetes Integration<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/elastic-agent/ingest-pipeline-kubernetes.asciidoc">edit</a></h3>
</div></div></div>
<p>This tutorial explains how to add a custom ingest pipeline to a Kubernetes Integration in order to add specific metadata fields for deployments and cronjobs of pods.</p>
<p>Custom pipelines can be used to add custom data processing, like adding fields, obfuscating sensitive information, and more. Find more information in our tutorial about <a class="xref" href="ingest-pipeline-kubernetes.html" title="Using a custom ingest pipeline with the Kubernetes Integration">transforming data with custom ingest pipelines</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_metadata_enrichment_for_kubernetes"></a>Metadata enrichment for Kubernetes<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/elastic-agent/ingest-pipeline-kubernetes.asciidoc">edit</a></h4>
</div></div></div>
<p>The <a href="https://docs.elastic.co/en/integrations/kubernetes" class="ulink" target="_top">Kubernetes Integration</a> is used to collect logs and metrics from Kubernetes clusters with Elastic Agent. During the collection, the integration enhances the collected information with extra useful information that users can correlate with different Kubernetes assets. This additional information added on top of collected data, such as labels, annotations, ancestor names of Kubernetes assets, and others, are called metadata.</p>
<p>The <a href="/guide/en/fleet/current/kubernetes-provider.html" class="ulink" target="_top">Kubernetes Provider</a> offers the <code class="literal">add_resource_metadata</code> option to configure the metadata enrichment options.</p>
<p>For Elastic Agent versions &gt;[8.10.4], the default configuration for metadata enrichment is <code class="literal">add_resource_metadata.deployment=false</code> and <code class="literal">add_resource_metadata.cronjob=false</code>. This means that pods that are created from replicasets that belong to specific deployments would not be enriched with <code class="literal">kubernetes.deployment.name</code>. Additionally, pods that are created from jobs that belong to specific cronjobs, would not be enriched with <code class="literal">kubernetes.cronjob.name</code>.</p>
<p><span class="strong strong"><strong>Kubernetes Integration Policy &gt; Collect Kubernetes metrics from Kube-state-metrics &gt; Kubernetes Pod Metrics</strong></span></p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/add_resource_metadata.png" alt="Configure add_resource_metadata">
</div>
</div>
<p>Example: Enabling the enrichment through <code class="literal">add_resource_metadata</code> in a Managed Elastic Agent Policy</p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Note:</strong></span> Enabling deployment and cronjob metadata enrichment leads to an increase of Elastic Agent&#8217;s memory consumption. Elastic Agent uses a local cache in order to keep records of the Kubernetes assets from being discovered.</p>
</blockquote>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_add_deployment_and_cronjob_for_kubernetes_pods_through_ingest_pipelines"></a>Add deployment and cronjob for Kubernetes pods through ingest pipelines<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/elastic-agent/ingest-pipeline-kubernetes.asciidoc">edit</a></h4>
</div></div></div>
<p>As an alternative to keeping the feature enabled and using more memory resources for Elastic Agent, users can make use of ingest pipelines to add the missing fields of <code class="literal">kubernetes.deployment.name</code> and <code class="literal">kubernetes.cronjob.name</code>.</p>
<p>Following the <a class="xref" href="ingest-pipeline-kubernetes.html" title="Using a custom ingest pipeline with the Kubernetes Integration">transforming data with custom ingest pipelines</a> tutorial, navigate to <code class="literal">state_pod</code> datastream under: <span class="strong strong"><strong>Kubernetes Integration Policy &gt; Collect Kubernetes metrics from Kube-state-metrics &gt; Kubernetes Pod Metrics</strong></span>.</p>
<p>Create the following custom ingest pipeline with two processors:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/ingest_pipeline_custom_k8s.png" alt="Custom ingest pipeline">
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_processor_for_deployment"></a>Processor for deployment<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/elastic-agent/ingest-pipeline-kubernetes.asciidoc">edit</a></h5>
</div></div></div>
<div class="imageblock screenshot">
<div class="content">
<img src="images/gsub_deployment.png" alt="Gsub Processor for deployment">
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_processor_for_cronjob"></a>Processor for cronjob<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/elastic-agent/ingest-pipeline-kubernetes.asciidoc">edit</a></h5>
</div></div></div>
<div class="imageblock screenshot">
<div class="content">
<img src="images/gsub_cronjob.png" alt="Gsub Processor for cronjob">
</div>
</div>
<p>The final <code class="literal">metrics-kubernetes.state_pod@custom</code> ingest pipeline:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">[
  {
    "gsub": {
      "field": "kubernetes.replicaset.name",
      "pattern": "(?:.(?!-))+$",
      "replacement": "",
      "target_field": "kubernetes.deployment.name",
      "ignore_missing": true,
      "ignore_failure": true
    }
  },
  {
    "gsub": {
      "field": "kubernetes.job.name",
      "pattern": "(?:.(?!-))+$",
      "replacement": "",
      "target_field": "kubernetes.cronjob.name",
      "ignore_missing": true,
      "ignore_failure": true
    }
  }
]</pre>
</div>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Note</strong></span>: The ingest pipeline does not check for the actual existence of a deployment and cronjob ancestor, it only adds the specific values.</p>
</blockquote>
</div>
</div>

</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="scaling-on-kubernetes.html">« Scaling Elastic Agent on Kubernetes</a>
</span>
<span class="next">
<a href="agent-environment-variables.html">Elastic Agent environment variables »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs.js"></script>
    <script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
