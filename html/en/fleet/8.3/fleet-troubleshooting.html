<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Troubleshoot common problems | Fleet and Elastic Agent Guide [8.3] | Elastic</title>
<link rel="home" href="index.html" title="Fleet and Elastic Agent Guide [8.3]"/>
<link rel="up" href="troubleshooting-intro.html" title="Troubleshoot"/>
<link rel="prev" href="troubleshooting-intro.html" title="Troubleshoot"/>
<link rel="next" href="fleet-faq.html" title="Frequently asked questions"/>
<meta name="DC.type" content="Learn/Docs/Fleet/Guide/Elastic Agent/8.3"/>
<meta name="DC.subject" content="Fleet and Elastic Agent"/>
<meta name="DC.identifier" content="8.3"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">Fleet and Elastic Agent Guide [8.3]</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="troubleshooting-intro.html">Troubleshoot</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="troubleshooting-intro.html">« Troubleshoot</a>
</span>
<span class="next">
<a href="fleet-faq.html">Frequently asked questions »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="fleet-troubleshooting"></a>Troubleshoot common problems<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h2>
</div></div></div>
<p>We have collected the most common known problems and listed them here. If your problem
is not described here, please review the open issues in the following GitHub repositories:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Repository</th>
<th align="left" valign="top">To review or report issues about</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><a href="https://github.com/elastic/kibana/issues" class="ulink" target="_top">elastic/kibana</a></p></td>
<td align="left" valign="top"><p>Fleet and Integrations UI</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><a href="https://github.com/elastic/elastic-agent/issues" class="ulink" target="_top">elastic/elastic-agent</a></p></td>
<td align="left" valign="top"><p>Elastic Agent</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><a href="https://github.com/elastic/beats/issues" class="ulink" target="_top">elastic/beats</a></p></td>
<td align="left" valign="top"><p>Beats shippers</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><a href="https://github.com/elastic/fleet-server/issues" class="ulink" target="_top">elastic/fleet-server</a></p></td>
<td align="left" valign="top"><p>Fleet Server</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><a href="https://github.com/elastic/package-registry/issues" class="ulink" target="_top">elastic/package-registry</a></p></td>
<td align="left" valign="top"><p>Elastic Package Registry</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><a href="https://github.com/elastic/observability-docs/issues" class="ulink" target="_top">elastic/observability-docs</a></p></td>
<td align="left" valign="top"><p>Documentation issues</p></td>
</tr>
</tbody>
</table>
</div>
<p>Have a question? Read our <a class="xref" href="fleet-faq.html" title="Frequently asked questions">FAQ</a>, or contact us in the
<a href="https://discuss.elastic.co/" class="ulink" target="_top">discuss forum</a>. Your feedback is valuable to us.</p>
<p>Running Elastic Agent standalone? Also refer to <a class="xref" href="debug-standalone-agents.html" title="Debug standalone Elastic Agents">Debug standalone Elastic Agents</a>.</p>
<h4><a id="agents-in-cloud-stuck-at-updating"></a>Elastic Agents hosted on Elastic Cloud are stuck in <code class="literal">Updating</code> or <code class="literal">Offline</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>In Elastic Cloud, after <a class="xref" href="upgrade-integration.html" title="Upgrade an Elastic Agent integration">upgrading</a> Fleet Server and its
integration policies, agents enrolled in the Elastic Cloud agent policy
may experience issues updating. To resolve this problem:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>In a terminal window, run the following <code class="literal">cURL</code> request, providing your Kibana superuser credentials to reset the Elastic Cloud agent policy.</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">curl -u &lt;username&gt;:&lt;password&gt; --request POST \
  --url &lt;kibana_url&gt;/internal/fleet/reset_preconfigured_agent_policies/policy-elastic-agent-on-cloud \
  --header 'content-type: application/json' \
  --header 'kbn-xsrf: xyz'</pre>
</div>
</li>
<li class="listitem">
<p>Force unenroll the agent stuck in <code class="literal">Updating</code>:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
To find agent&#8217;s ID, go to <span class="strong strong"><strong>Fleet &gt; Agents</strong></span> and click the agent to see its
details. Copy the Agent ID.
</li>
<li class="listitem">
<p>In a terminal window, run:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">curl -u &lt;username&gt;:&lt;password&gt; --request POST \
  --url &lt;kibana_url&gt;/api/fleet/agents/&lt;agentID&gt;/unenroll \
  --header 'content-type: application/json' \
  --header 'kbn-xsrf: xx' \
  --data-raw '{"force":true,"revoke":true}' \
  --compressed</pre>
</div>
<p>Where <code class="literal">&lt;agentID&gt;</code> is the ID you copied in the previous step.</p>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>Restart the Integrations Server:</p>
<p>In the Elastic Cloud console under Integrations Server, click <span class="strong strong"><strong>Force Restart</strong></span>.</p>
</li>
</ol>
</div>
<h4><a id="fleet-server-not-in-kibana-cloud"></a>When using Elastic Cloud, Fleet Server is not listed in Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>If you are unable to see Fleet Server in Kibana, make sure it&#8217;s set up.</p>
<p>To set up Fleet Server on Elastic Cloud:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to your deployment on Elastic Cloud.
</li>
<li class="listitem">
Follow the Elastic Cloud prompts to set up <span class="strong strong"><strong>Integrations Server</strong></span>. Once complete, the Fleet Server Elastic Agent
will show up in Fleet.
</li>
</ol>
</div>
<p>To enable Fleet and set up Fleet Server on a self-managed cluster:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>In the Elasticsearch configuration file, <code class="literal">config/elasticsearch.yml</code>, set the following
security settings to enable security and API keys:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.enabled: true
xpack.security.authc.api_key.enabled: true</pre>
</div>
</li>
<li class="listitem">
<p>In the Kibana configuration file, <code class="literal">config/kibana.yml</code>, enable Fleet
and specify your user credentials:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.encryptedSavedObjects.encryptionKey: "something_at_least_32_characters"
xpack.security.enabled: true
elasticsearch.username: "my_username" <a id="CO19-1"></a><i class="conum" data-value="1"></i>
elasticsearch.password: "my_password"</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO19-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Specify a user who is authorized to use Fleet.</p>
</td>
</tr>
</table>
</div>
<p>To set up passwords, you can use the documented Elasticsearch APIs or the
<code class="literal">elasticsearch-setup-passwords</code> command. For example, <code class="literal">./bin/elasticsearch-setup-passwords auto</code></p>
<p>After running the command:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Copy the Elastic user name to the Kibana configuration file.
</li>
<li class="listitem">
Restart Kibana.
</li>
<li class="listitem">
Follow the documented steps for setting up a self-managed Fleet Server.
For more information, refer to <a class="xref" href="fleet-server.html" title="Set up Fleet Server"><em>Set up Fleet Server</em></a>.
</li>
</ol>
</div>
</li>
</ol>
</div>
<h4><a id="fleet-setup-fails"></a>The <code class="literal">/api/fleet/setup</code> endpoint can&#8217;t reach the package registry<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>To install Integrations, the Fleet app requires a connection to
an external service called the Elastic Package Registry.</p>
<p>For this to work, the Kibana server must connect to <code class="literal">https://epr.elastic.co</code> on port <code class="literal">443</code>.</p>
<h4><a id="fleet-errors-tls"></a>Kibana cannot connect to Elastic Package Registry in air-gapped environments<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>In air-gapped environments, you may encounter the following error if you&#8217;re using a custom Certificate Authority (CA) that is not available to Kibana:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{"type":"log","@timestamp":"2022-03-02T09:58:36-05:00","tags":["error","plugins","fleet"],"pid":58716,"message":"Error connecting to package registry: request to https://customer.server.name:8443/categories?experimental=true&amp;include_policy_templates=true&amp;kibana.version=7.17.0 failed, reason: self signed certificate in certificate chain"}</pre>
</div>
<p>To fix this problem, add your CA certificate file path to the Kibana startup
file by defining the <code class="literal">NODE_EXTRA_CA_CERTS</code> environment variable. More information
about this in <a class="xref" href="air-gapped.html#air-gapped-tls" title="TLS configuration of the Elastic Package Registry">TLS configuration of the Elastic Package Registry</a> section.</p>
<h4><a id="fleet-app-crashes"></a>Fleet in Kibana crashes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
To investigate the error, open your browser&#8217;s development console.
</li>
<li class="listitem">
<p>Select the <span class="strong strong"><strong>Network</strong></span> tab, and refresh the page.</p>
<p>One of the requests to the Fleet API will most likely have returned an error. If the error
message doesn&#8217;t give you enough information to fix the problem, please contact us in the <a href="https://discuss.elastic.co/" class="ulink" target="_top">discuss forum</a>.</p>
</li>
</ol>
</div>
<h4><a id="agent-enrollment-certs"></a>Elastic Agent enrollment fails on the host with <code class="literal">x509: certificate signed by unknown authority</code> message<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>To ensure that communication with Fleet Server is encrypted,
Fleet Server requires Elastic Agents to present a signed certificate. In a
self-managed cluster, if you don&#8217;t specify certificates when you set up
Fleet Server, self-signed certificates are generated automatically.</p>
<p>If you attempt to enroll an Elastic Agent in a Fleet Server with a self-signed
certificate, you will encounter the following error:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Error: fail to enroll: fail to execute request to fleet-server: x509: certificate signed by unknown authority
Error: enroll command failed with exit code: 1</pre>
</div>
<p>To fix this problem, pass the <code class="literal">--insecure</code> flag along with the <code class="literal">enroll</code> or
<code class="literal">install</code> command. For example:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">sudo ./elastic-agent install -f --url=https://&lt;fleet-server-ip&gt;:8220 --enrollment-token=&lt;token&gt; --insecure</pre>
</div>
<p>Traffic between Elastic Agents and Fleet Server over HTTPS will be encrypted; you&#8217;re
simply acknowledging that you understand that the certificate chain cannot be
verified.</p>
<p>Allowing Fleet Server to generate self-signed certificates is useful to get
things running for development, but not recommended in a production environment.</p>
<p>For more information, refer to <a class="xref" href="secure-connections.html" title="Configure SSL/TLS for self-managed Fleet Servers">Configure SSL/TLS for self-managed Fleet Servers</a>.</p>
<h4><a id="es-enrollment-certs"></a>Elastic Agent enrollment fails on the host with <code class="literal">x509: cannot validate certificate for x.x.x.x because it doesn't contain any IP SANs</code> message<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>To ensure that communication with Elasticsearch is encrypted,
Fleet Server requires Elasticsearch to present a signed certificate.</p>
<p>This error occurs when you use self-signed certificates with Elasticsearch using IP as a Common Name (CN).
With IP as a CN, Fleet Server looks into subject alternative names (SANs), which is empty. To work
around this situation, use the <code class="literal">--fleet-server-es-insecure</code> flag to disable certificate verification.</p>
<p>You will also need to set <code class="literal">ssl.verification_mode: none</code> in the Output settings in Fleet and Integrations UI.</p>
<h4><a id="agent-enrollment-timeout"></a>Elastic Agent enrollment fails on the host with <code class="literal">Client.Timeout exceeded</code> message<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>To enroll in Fleet, Elastic Agent must connect to the Fleet Server instance.
If the agent is unable to connect, you see the following failure:</p>
<div class="pre_wrapper lang-output">
<pre class="programlisting prettyprint lang-output">fail to enroll: fail to execute request to {fleet-server}:Post http://fleet-server:8220/api/fleet/agents/enroll?: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</pre>
</div>
<p>Here are several steps to help you troubleshoot the problem.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Check for networking problems. From the host, run the <code class="literal">ping</code> command to confirm
that it can reach the Fleet Server instance.
</li>
<li class="listitem">
<p>Additionally, <code class="literal">curl</code> the <code class="literal">/status</code> API of Fleet Server:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">curl -f http://&lt;fleet-server-url&gt;:8220/api/status</pre>
</div>
</li>
<li class="listitem">
<p>Verify that you have specified the correct Kibana Fleet settings URL and port for
your environment.</p>
<p>By default, HTTPS protocol and port 8220 is expected by Fleet Server to communicate
with Elasticsearch unless you have explicitly set it otherwise.</p>
</li>
<li class="listitem">
<p>Check that you specified a valid enrollment key during enrollment. To do this:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Fleet, select <span class="strong strong"><strong>Enrollment tokens</strong></span>.
</li>
<li class="listitem">
To view the secret, click the eyeball icon. The secret should match the string
that you used to enroll Elastic Agent on your host.
</li>
<li class="listitem">
If the secret doesn&#8217;t match, create a new enrollment token and use this
token when you run the <code class="literal">elastic-agent enroll</code> command.
</li>
</ol>
</div>
</li>
</ol>
</div>
<h4><a id="general-fleet-server-triage"></a>Many Fleet Server problems can be triaged and fixed with the below tips<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>When creating an issue or sending a support forum communication, this section
can help you identify what is required.</p>
</div>
</div>
<p>Fleet Server allows Elastic Agent to connect to Elasticsearch, which is the same as the connection
to Kibana in prior releases. However, because Fleet Server is on the edge host, it may
result in additional networking setup and troubleshooting.</p>
<h5><a id="_retrieve_the_elastic_agent_version"></a>Retrieve the Elastic Agent version<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h5>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>If you installed the Elastic Agent, run the following command (the example is for POSIX
based systems):</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">elastic-agent version</pre>
</div>
</li>
<li class="listitem">
<p>If you have not installed the Elastic Agent and you are running it as a temporary process, you can run:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">./elastic-agent version</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Both of the above commands are accessible via Windows or macOS with their OS-specific slight variation in
how you call them. If needed, please refer to <a class="xref" href="elastic-agent-installation.html" title="Install Elastic Agents"><em>Install Elastic Agents</em></a>
for examples of how to adjust them.</p>
</div>
</div>
</li>
</ol>
</div>
<h5><a id="_check_the_elastic_agent_status"></a>Check the Elastic Agent status<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h5>
<p>Run the following command to view the current status of the Elastic Agent.</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">elastic-agent status</pre>
</div>
<p>Based on the information returned, you can take further action.</p>
<p>If Elastic Agent is running, but you do not see what you expect, here are some items to review:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Fleet, click <span class="strong strong"><strong>Agents</strong></span>. Check which policy is associated with the running Elastic Agent. If it is not the policy you expected, you can change it.
</li>
<li class="listitem">
<p>In Fleet, click <span class="strong strong"><strong>Agents</strong></span>, and then select the Elastic Agent policy. Check for the integrations that should be included.</p>
<p>For example, if you want to include system data, make sure the <span class="strong strong"><strong>System</strong></span> integration is included in the policy.</p>
</li>
<li class="listitem">
<p>Confirm if the <span class="strong strong"><strong>Collect agent logs</strong></span> and <span class="strong strong"><strong>Collect agent metrics</strong></span> options are selected.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Fleet, click <span class="strong strong"><strong>Agents</strong></span>, and then select the Elastic Agent policy.
</li>
<li class="listitem">
<p>Select the <span class="strong strong"><strong>Settings</strong></span> tab. If you want to collect agent logs or metrics, select these options.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <span class="strong strong"><strong>Elastic Cloud agent policy</strong></span> is created only in Elastic Cloud deployments and, by default,
does not include the collection of logs of metrics.</p>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<p>You can collect other files to assess and pass to the Elastic team for review for some more advanced debugging cases.
These files should all be in the Elastic Agent directory on disk: <code class="literal">state.yml</code>, <code class="literal">fleet.yml</code> and <code class="literal">elastic-agent.yml</code>.</p>
<h5><a id="_collect_elastic_agent_diagnostics_bundle"></a>Collect Elastic Agent diagnostics bundle<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h5>
<p>Run the following command to generate a zip archive containing diagnostics information that the Elastic team can use for debugging cases.</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">elastic-agent diagnostics collect</pre>
</div>
<p>This archive collects the following information:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Elastic Agent versions numbers
</li>
<li class="listitem">
Beats (and other process) version numbers and process metadata
</li>
<li class="listitem">
Local configuration, elastic-agent policy, and the configuration that is rendered and passed to Beats and other processes
</li>
<li class="listitem">
Elastic Agent&#8217;s local log files
</li>
</ol>
</div>
<p>Note that the diagnostics bundle is intended for debugging purposes only, its structure may change between releases.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>The configuration files in the archive may have credentials in <span class="strong strong"><strong>plain text</strong></span>.
These will need to be manually redacted before the archive is shared.</p>
</div>
</div>
<p>The diagnostics command is also able to collect <code class="literal">pprof</code> data in the archive if the <code class="literal">--pprof</code> flag is passed:</p>
<p>If <code class="literal">agent.monitoring.http.buffer.enabled</code> is set to <code class="literal">true</code>, the archive will also contain recent metrics from the Elastic Agent and Beats processes.</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">elastic-agent diagnostics collect --pprof</pre>
</div>
<p>By default this command takes a little more than 30 seconds to run because it collects 30 seconds trace and profile information from the Elastic Agent and all underlying Beats.
To change the duration of the trace and profile data, set the <code class="literal">--pprof-duration</code> flag.</p>
<p>To set the timeout value for the collection command, use the <code class="literal">--timeout</code> flag. The timeout defaults to 30 seconds + <code class="literal">pprof-duration</code>.
Use this flag to increase the timeout if the diagnostics command times out before creating the archive.</p>
<h4><a id="not-installing-no-logs-in-terminal"></a>Some problems occur so early that insufficient logging is available<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>If some problems occur early and insufficient logging is available, run the following command:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">./elastic-agent install -f</pre>
</div>
<p>The stand-alone install command installs the Elastic Agent, and all of the service configuration is set up. You can now run the
<em>enrollment</em> command. For example:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">elastic-agent enroll -f --fleet-server-es=https://&lt;es-url&gt;:443 --fleet-server-service-token=&lt;token&gt; --fleet-server-policy=&lt;policy-id&gt;</pre>
</div>
<p>Note: Port <code class="literal">443</code> is commonly used in Elastic Cloud. However, with self-managed deployments, your Elasticsearch may run on port <code class="literal">9200</code> or something entirely different.</p>
<p>For information on where to find agent logs, refer to our <a class="xref" href="fleet-faq.html#where-are-the-agent-logs" title="Where does Elastic Agent store logs after startup?">FAQ</a>.</p>
<h4><a id="agent-healthy-but-no-data-in-es"></a>The Elastic Agent is cited as <code class="literal">Healthy</code> but still has set up problems sending data to Elasticsearch<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>To confirm that the Elastic Agent is running and its status is <code class="literal">Healthy</code>, select the <span class="strong strong"><strong>Agents</strong></span> tab.</p>
<p>If you previously selected the <span class="strong strong"><strong>Collect agent logs</strong></span> option, you can now look at the agent logs.</p>
</li>
<li class="listitem">
<p>Click the agent name and then select the <span class="strong strong"><strong>Logs</strong></span> tab.</p>
<p>If there are no logs displayed, it suggests a communication problem between your host and Elasticsearch. The possible reason for this is
that the port is already in use.</p>
</li>
<li class="listitem">
<p>You can check the port usage using tools like Wireshark or netstat. On a POSIX system, you can run the following command:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">netstat -nat | grep :8220</pre>
</div>
<p>Any response data indicates that the port is in use. This could be correct or not
if you had intended to uninstall the Fleet Server. In which case, re-check and continue.</p>
</li>
</ol>
</div>
<h4><a id="secondary-agent-not-connecting"></a>Fleet Server is running and healthy with data, but other Agents cannot use it to connect to Elasticsearch<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>Some settings are only used when you have multiple Elastic Agents.  If this is the case, it may help
to check that the hosts can communicate with the Fleet Server.</p>
<p>From the non-Fleet Server host, run the following command:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">curl -f http://&lt;fleet-server-ip&gt;:8220/api/status</pre>
</div>
<p>The response may yield errors that you can be debug further, or it may work and show that communication ports and
networking are not the problems.</p>
<p>One common problem is that the default Fleet Server port of <code class="literal">8220</code> isn’t open on the Fleet Server
host to communicate. You can review and correct this using common tools in alignment with any
networking and security concerns you may have.</p>
<h4><a id="es-apikey-failed"></a>Elasticsearch authentication service fails with <code class="literal">Authentication using apikey failed</code> message<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>To save API keys and encrypt them in Elasticsearch, Fleet requires an encryption key.</p>
<p>To provide an API key, in the <code class="literal">kibana.yml</code> configuration file, set the <code class="literal">xpack.encryptedSavedObjects.encryptionKey</code> property.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.encryptedSavedObjects.encryptionKey: "something_at_least_32_characters"</pre>
</div>
<h4><a id="process-not-root"></a>Elastic Agent fails with <code class="literal">Agent process is not root/admin or validation failed</code> message<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>Ensure the user running Elastic Agent has root privileges as some integrations
require root privileges to collect sensitive data.</p>
<p>If you&#8217;re running Elastic Agent in the foreground (and not as a service) on Linux or macOS, run the
agent under the root user: <code class="literal">sudo</code> or <code class="literal">su</code>.</p>
<p>If you&#8217;re using the Endpoint and Cloud Security integration, make sure you&#8217;re
running Elastic Agent under the SYSTEM account.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you install Elastic Agent as a service as described in
<a class="xref" href="elastic-agent-installation.html" title="Install Elastic Agents"><em>Install Elastic Agents</em></a>, Elastic Agent runs under the SYSTEM account by
default.</p>
</div>
</div>
<p>To run Elastic Agent under the SYSTEM account, you can do the following:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Download <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec" class="ulink" target="_top">PsExec</a>
and extract the contents to a folder. For example, <code class="literal">d:\tools</code>.
</li>
<li class="listitem">
Open a command prompt as an Administrator (right-click the command prompt
icon and select <span class="strong strong"><strong>Run As Administrator</strong></span>).
</li>
<li class="listitem">
<p>From the command prompt, run Elastic Agent under the SYSTEM account:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">d:\tools\psexec.exe -sid "C:\Program Files\Elastic-Agent\elastic-agent.exe" run</pre>
</div>
</li>
</ol>
</div>
<h4><a id="upgrading-integration-too-many-conflicts"></a>Integration policy upgrade has too many conflicts<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>If you try to upgrade an integration policy that is several versions old, there
may be substantial conflicts or configuration issues. Rather than trying to fix
these problems, it might be faster to create a new policy, test it, and roll
out the integration upgrade to additional hosts.</p>
<p>After <a class="xref" href="upgrade-integration.html" title="Upgrade an Elastic Agent integration">upgrading the integration</a>:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="agent-policy.html#create-a-policy" title="Create a policy">Create a new policy</a>.
</li>
<li class="listitem">
<a class="xref" href="agent-policy.html#add-integration" title="Add an integration to a policy">Add the integration to the policy</a>.
The newer version is automatically used.
</li>
<li class="listitem">
<p><a class="xref" href="agent-policy.html#apply-a-policy" title="Apply a policy">Apply the policy</a> to an Elastic Agent.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>In larger deployments, you should test integration upgrades on a sample Elastic Agent
before rolling out a larger upgrade initiative.
Only after a small trial is deemed successful should the updated policy be
rolled out all hosts.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Roll out the integration update to additional hosts:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Fleet, click <span class="strong strong"><strong>Agent policies</strong></span>.
Click on the name of the policy you want to edit.
</li>
<li class="listitem">
Search or scroll to a specific integration.
Open the <span class="strong strong"><strong>Actions</strong></span> menu and select <span class="strong strong"><strong>Delete integration</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Add integration</strong></span> and re-add the freshly deleted integration.
The updated version will be used and applied to all Elastic Agents.
</li>
<li class="listitem">
<p>Repeat this process for each policy with the out-of-date integration.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In some instances, for example, when there are hundreds or thousands of different Elastic Agents and
policies that need to be updated, this upgrade path is not feasible.
In this case, update one policy and use the <a class="xref" href="agent-policy.html#copy-policy" title="Copy a policy">Copy a policy</a> action to apply the updated policy versions to additional policies.
This method&#8217;s downside is losing
the granularity of assessing the individual Integration version changes individually across policies.</p>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<h4><a id="agent-hangs-while-unenrolling"></a>Elastic Agent hangs while unenrolling<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>When unenrolling Elastic Agent, Fleet waits for acknowledgment from the agent
before it completes the unenroll process. If Fleet doesn&#8217;t receive an
acknowledgment, the status hangs at <code class="literal">unenrolling.</code></p>
<p>You can unenroll an agent to invalidate all API keys related to the agent and change the status to
<code class="literal">inactive</code> so that the agent no longer appears in Fleet.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Fleet, select <span class="strong strong"><strong>Agents</strong></span>.
</li>
<li class="listitem">
Under Agents, choose <span class="strong strong"><strong>Unenroll agent</strong></span> from the <span class="strong strong"><strong>Actions</strong></span> menu next to the
agent you want to unenroll.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Force unenroll</strong></span>.
</li>
</ol>
</div>
<h4><a id="ca-cert-testing"></a>On Fleet Server startup, ERROR seen with <code class="literal">State changed to CRASHED: exited with code: 1</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>You may see this error message for a number of different reasons. A common reason is when attempting production-like usage and the ca.crt file passed in cannot be found.  To verify if this is the problem, bootstrap Fleet Server without passing a ca.crt file. This implies you would test any subsequent
Elastic Agent installs temporarily with {fleet-sever}'s own self-signed cert.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Ensure to pass in the full path to the ca.crt file. A relative path is not viable.</p>
</div>
</div>
<p>You will know if your Fleet Server is set up with its testing oriented self-signed certificate usage,
when you see the following error during Elastic Agent installs:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Error: fail to enroll: fail to execute request to fleet-server: x509: certificate signed by unknown authority
Error: enroll command failed with exit code: 1</pre>
</div>
<p>To install or enroll against a self-signed cert Fleet Server Elastic Agent, add in the <code class="literal">--insecure</code> option to the
command:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">sudo ./elastic-agent install -f --url=https://&lt;fleet-server-ip&gt;:8220 --enrollment-token=&lt;token&gt; --insecure</pre>
</div>
<p>For more information, refer to <a class="xref" href="fleet-troubleshooting.html#agent-enrollment-certs" title="Elastic Agent enrollment fails on the host with x509: certificate signed by unknown authority message">Elastic Agent enrollment fails on the host with <code class="literal">x509: certificate signed by unknown authority</code> message</a>.</p>
<h4><a id="endpoint-not-uninstalled-with-agent"></a>Uninstalling Elastic Endpoint fails<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>When you uninstall Elastic Agent, all the programs managed by Elastic Agent, such as
Elastic Endpoint, are also removed. If uninstalling fails,
Elastic Endpoint might remain on your system.</p>
<p>To remove Elastic Endpoint, run the following commands:</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Uninstall">
    <button role="tab"
            aria-selected="true"
            aria-controls="mac-tab-uninstall"
            id="mac-uninstall">
      macOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-uninstall"
            id="linux-uninstall"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-uninstall"
            id="win-uninstall"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-uninstall"
       aria-labelledby="mac-uninstall">
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">cd /tmp
cp /Library/Elastic/Endpoint/elastic-endpoint elastic-endpoint
sudo ./elastic-endpoint uninstall
rm elastic-endpoint</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-uninstall"
       aria-labelledby="linux-uninstall"
       hidden="">
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">cd /tmp
cp /opt/Elastic/Endpoint/elastic-endpoint elastic-endpoint
sudo ./elastic-endpoint uninstall
rm elastic-endpoint</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-uninstall"
       aria-labelledby="win-uninstall"
       hidden="">
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">cd %TEMP%
copy "c:\Program Files\Elastic\Endpoint\elastic-endpoint.exe" elastic-endpoint.exe
.\elastic-endpoint.exe uninstall
del .\elastic-endpoint.exe</pre>
</div>
  </div>
</div>
<h4><a id="endpoint-unauthorized"></a>API key is unauthorized to send telemetry to <code class="literal">.logs-endpoint.diagnostic.collection-*</code> indices<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>By default, telemetry is turned on in the Elastic Stack to helps us learn about the
features that our users are most interested in. This helps us to focus our efforts on
making features even better.</p>
<p>If you&#8217;ve recently upgraded from version <code class="literal">7.10</code> to <code class="literal">7.11</code>, you might see the
following message when you view Endpoint and Cloud Security logs:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">action [indices:admin/auto_create] is unauthorized for API key id [KbvCi3YB96EBa6C9k2Cm]
of user [fleet_enroll] on indices [.logs-endpoint.diagnostic.collection-default]</pre>
</div>
<p>The above message indicates that Elastic Endpoint does not have the correct
permissions to send telemetry. This is a known problem in 7.11 that will be
fixed in an upcoming patch release.</p>
<p>To remove this message from your logs, you can turn off telemetry for the Endpoint and Cloud Security integration
until the next patch release is available.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Kibana, click <span class="strong strong"><strong>Integrations</strong></span>, and then select the <span class="strong strong"><strong>Manage</strong></span> tab.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Endpoint and Cloud Security</strong></span>, and then select the <span class="strong strong"><strong>Policies</strong></span> tab to view all the
installed integrations.
</li>
<li class="listitem">
Click the integration to edit it.
</li>
<li class="listitem">
Under advanced settings, set <code class="literal">windows.advanced.diagnostic.enabled</code>
to <code class="literal">false</code>, and then save the integration.
</li>
</ol>
</div>
<h4><a id="hosted-agent-offline"></a>Hosted Elastic Agent is offline<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>To scale the Fleet Server deployment, Elastic Cloud starts new containers or shuts down old ones when hosted Elastic Agents are required or no longer needed. The old Elastic Agents will show in the Agents list for 24 hours then automatically disappear.</p>
<h4><a id="hosted-agent-8-x-upgrade-fail"></a>APM &amp; Fleet fails to upgrade to 8.x on Elastic Cloud<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>In some scenarios, upgrading APM &amp; Fleet to 8.x may fail if the Elastic Cloud agent policy was modified manually. The Fleet app in Kibana may show a message like:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Unable to create package policy. Package 'apm' already exists on this agent policy</pre>
</div>
<p>To work around this problem, you can reset the Elastic Cloud agent policy with an API call. Note that this will remove any custom integration policies that you&#8217;ve added to the policy, such as Synthetics monitors.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -u elastic:&lt;password&gt; --request POST \
  --url &lt;kibana_url&gt;/internal/fleet/reset_preconfigured_agent_policies/policy-elastic-agent-on-cloud \
  --header 'Content-Type: application/json' \
  --header 'kbn-xsrf: xyz' \</pre>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="troubleshooting-intro.html">« Troubleshoot</a>
</span>
<span class="next">
<a href="fleet-faq.html">Frequently asked questions »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
