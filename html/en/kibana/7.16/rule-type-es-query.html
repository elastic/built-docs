<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<meta name="description" content="Kibana provides you with several options to share *Discover* saved searches, dashboards, *Visualize Library* visualizations, and *Canvas* workpads with others, or on a website.">
<meta name="keywords" content="analyst, concept, task, reporting">
<title>Elasticsearch query | Kibana Guide [7.16] | Elastic</title>
<meta class="elastic" name="content" content="Elasticsearch query | Kibana Guide [7.16]">

<link rel="home" href="index.html" title="Kibana Guide [7.16]"/>
<link rel="up" href="rule-types.html" title="Rule types"/>
<link rel="prev" href="rule-type-index-threshold.html" title="Index threshold"/>
<link rel="next" href="geo-alerting.html" title="Tracking containment"/>
<meta class="elastic" name="product_version" content="7.16"/>
<meta class="elastic" name="product_name" content="Kibana"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Kibana/Reference/7.16"/>
<meta name="DC.subject" content="Kibana"/>
<meta name="DC.identifier" content="7.16"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Kibana Guide [7.16]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="alerting-getting-started.html">Alerting</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="rule-types.html">Rule types</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="rule-type-index-threshold.html">« Index threshold</a>
</span>
<span class="next">
<a href="geo-alerting.html">Tracking containment »</a>
</span>
</div>
<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="rule-type-es-query"></a>Elasticsearch query<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/user/alerting/rule-types/es-query.asciidoc">edit</a></h2>
</div></div></div>
<p>The Elasticsearch query rule type runs a user-configured Elasticsearch query, compares the number of matches to a configured threshold, and schedules actions to run when the threshold condition is met.</p>
<h4><a id="_create_the_rule_2"></a>Create the rule<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/user/alerting/rule-types/es-query.asciidoc">edit</a></h4>
<p>Fill in the <a class="xref" href="create-and-manage-rules.html#defining-rules-general-details" title="General rule details">rule details</a>, then select <span class="strong strong"><strong>Elasticsearch query</strong></span>.</p>
<h4><a id="_define_the_conditions_2"></a>Define the conditions<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/user/alerting/rule-types/es-query.asciidoc">edit</a></h4>
<p>Define properties to detect the condition.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/rule-types-es-query-conditions.png" alt="Five clauses define the condition to detect">
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
Index
</span>
</dt>
<dd>
This clause requires an <span class="strong strong"><strong>index or index pattern</strong></span> and a <span class="strong strong"><strong>time field</strong></span> that will be used for the <span class="strong strong"><strong>time window</strong></span>.
</dd>
<dt>
<span class="term">
Size
</span>
</dt>
<dd>
This clause specifies the number of documents to pass to the configured actions when the the threshold condition is met.
</dd>
<dt>
<span class="term">
Elasticsearch query
</span>
</dt>
<dd>
This clause specifies the ES DSL query to execute. The number of documents that match this query will be evaulated against the threshold
condition. Aggregations are not supported at this time.
</dd>
<dt>
<span class="term">
Threshold
</span>
</dt>
<dd>
This clause defines a threshold value and a comparison operator  (<code class="literal">is above</code>, <code class="literal">is above or equals</code>, <code class="literal">is below</code>, <code class="literal">is below or equals</code>, or <code class="literal">is between</code>). The number of documents that match the specified query is compared to this threshold.
</dd>
<dt>
<span class="term">
Time window
</span>
</dt>
<dd>
This clause determines how far back to search for documents, using the <span class="strong strong"><strong>time field</strong></span> set in the <span class="strong strong"><strong>index</strong></span> clause. Generally this value should be set to a value higher than the <span class="strong strong"><strong>check every</strong></span> value in the <a class="xref" href="create-and-manage-rules.html#defining-rules-general-details" title="General rule details">general rule details</a>, to avoid gaps in detection.
</dd>
</dl>
</div>
<h4><a id="_add_action_variables_2"></a>Add action variables<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/user/alerting/rule-types/es-query.asciidoc">edit</a></h4>
<p><a class="xref" href="create-and-manage-rules.html#defining-rules-actions-details" title="Action type and details">Add an action</a> to run when the rule condition is met. The following variables are specific to the Elasticsearch query rule. You can also specify <a class="xref" href="create-and-manage-rules.html#defining-rules-actions-variables" title="Action variables">variables common to all rules</a>.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">context.title</code>
</span>
</dt>
<dd>
A preconstructed title for the rule. Example: <code class="literal">rule term match alert query matched</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.message</code>
</span>
</dt>
<dd>
A preconstructed message for the rule. Example:<br>
<code class="literal">rule 'term match alert' is active:</code><br>
<code class="literal">- Value: 42</code><br>
<code class="literal">- Conditions Met: count greater than 4 over 5m</code><br>
<code class="literal">- Timestamp: 2020-01-01T00:00:00.000Z</code>
</dd>
<dt>
<span class="term">
<code class="literal">context.group</code>
</span>
</dt>
<dd>
The name of the action group associated with the condition. Example: <code class="literal">query matched</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.date</code>
</span>
</dt>
<dd>
The date, in ISO format, that the rule met the condition. Example: <code class="literal">2020-01-01T00:00:00.000Z</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.value</code>
</span>
</dt>
<dd>
The value of the rule that met the condition.
</dd>
<dt>
<span class="term">
<code class="literal">context.conditions</code>
</span>
</dt>
<dd>
A description of the condition. Example: <code class="literal">count greater than 4</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.hits</code>
</span>
</dt>
<dd>
<p>
The most recent ES documents that matched the query. Using the <a href="https://mustache.github.io/" class="ulink" target="_top">Mustache</a> template array syntax, you can iterate over these hits to get values from the ES documents into your actions.
</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/rule-types-es-query-example-action-variable.png" alt="Iterate over hits using Mustache template syntax">
</div>
</div>
</dd>
</dl>
</div>
<h4><a id="_test_your_query"></a>Test your query<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/user/alerting/rule-types/es-query.asciidoc">edit</a></h4>
<p>Use the <span class="strong strong"><strong>Test query</strong></span> feature to verify that your query DSL is valid.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Valid queries are executed against the configured <span class="strong strong"><strong>index</strong></span> using the configured <span class="strong strong"><strong>time window</strong></span>. The number of documents that
match the query will be displayed.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/rule-types-es-query-valid.png" alt="Test Elasticsearch query returns number of matches when valid">
</div>
</div>
</li>
<li class="listitem">
<p>An error message is shown if the query is invalid.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/rule-types-es-query-invalid.png" alt="Test Elasticsearch query shows error when invalid">
</div>
</div>
</li>
</ul>
</div>
<h4><a id="_match_de_duplication"></a>Match de-duplication<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/user/alerting/rule-types/es-query.asciidoc">edit</a></h4>
<p>The Elasticsearch query rule type performs de-duplication of document matches across rule executions. If you configure the rule with a schedule interval smaller than the time window, and a document matches a query in multiple rule executions, it will be alerted on only once.</p>
<p>Suppose you have a rule configured to run every minute.  The rule uses a time window of 1 hour and checks if there are more than 99 matches for the query. The Elasticsearch query rule type will do the following:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">Execution 1 (0:00)</code></p></td>
<td align="left" valign="top"><p>Rule finds 113 matches in the last hour: <code class="literal">113 &gt; 99</code></p></td>
<td align="left" valign="top"><p>Rule is active and user will be alerted.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">Execution 2 (0:01)</code></p></td>
<td align="left" valign="top"><p>Rule finds 127 matches in the last hour. 105 of the matches are duplicates that were alerted on in Execution 1, so you actually have 22 matches: <code class="literal">22 !&gt; 99</code></p></td>
<td align="left" valign="top"><p>No alert.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">Execution 3 (0:02)</code></p></td>
<td align="left" valign="top"><p>Rule finds 159 matches in the last hour. 88 of the matches are duplicates that were alerted on in Execution 1, so you actually have 71 matches: <code class="literal">71 !&gt; 99</code></p></td>
<td align="left" valign="top"><p>No alert.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">Execution 4 (0:03)</code></p></td>
<td align="left" valign="top"><p>Rule finds 190 matches in the last hour. 71 of them are duplicates that were alerted on in Exeuction 1, so you actually have 119 matches: <code class="literal">119 &gt; 99</code></p></td>
<td align="left" valign="top"><p>Rule is active and user will be alerted.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="rule-type-index-threshold.html">« Index threshold</a>
</span>
<span class="next">
<a href="geo-alerting.html">Tracking containment »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
