<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<meta name="description" content="A reference of the reporting settings administrators configure in kibana.yml.">
<meta name="keywords" content="administrator, reference, setup, reporting">
<title>Upgrade migrations | Kibana Guide [7.17] | Elastic</title>
<link rel="home" href="index.html" title="Kibana Guide [7.17]"/>
<link rel="up" href="upgrade.html" title="Upgrade Kibana"/>
<link rel="prev" href="upgrade-standard.html" title="Standard upgrade"/>
<link rel="next" href="logging-configuration-migration.html" title="Logging configuration migration"/>
<meta name="DC.type" content="Learn/Docs/Kibana/Reference/7.17"/>
<meta name="DC.subject" content="Kibana"/>
<meta name="DC.identifier" content="7.17"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
A newer version is available. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Kibana Guide [7.17]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="setup.html">Set up</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="upgrade.html">Upgrade Kibana</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="upgrade-standard.html">« Standard upgrade</a>
</span>
<span class="next">
<a href="logging-configuration-migration.html">Logging configuration migration »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="upgrade-migrations"></a>Upgrade migrations<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h2>
</div></div></div>
<p>Every time Kibana is upgraded it will perform an upgrade migration to ensure that all <a class="xref" href="managing-saved-objects.html" title="Saved Objects">saved objects</a> are compatible with the new version.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>6.7 includes an <a href="/guide/en/kibana/6.7/upgrade-assistant.html" class="ulink" target="_top">Upgrade Assistant</a>
to help you prepare for your upgrade to 7.0. To access the assistant, go to <span class="strong strong"><strong>Management &gt; 7.0 Upgrade Assistant</strong></span>.</p>
</div>
</div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Kibana 7.12.0 and later uses a new migration process and index naming scheme. Be sure to read the documentation for your version of Kibana before proceeding.</p>
</div>
</div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>The following instructions assumes Kibana is using the default index names. If the <code class="literal">kibana.index</code> or <code class="literal">xpack.tasks.index</code> configuration settings were changed these instructions will have to be adapted accordingly.</p>
</div>
</div>
<h4><a id="upgrade-migrations-process"></a>Background<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h4>
<p>Saved objects are stored in two indices:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">.kibana_{kibana_version}_001</code>, or if the <code class="literal">kibana.index</code> configuration setting is set <code class="literal">.{kibana.index}_{kibana_version}_001</code>. E.g. for Kibana v7.12.0 <code class="literal">.kibana_7.12.0_001</code>.
</li>
<li class="listitem">
<code class="literal">.kibana_task_manager_{kibana_version}_001</code>, or if the <code class="literal">xpack.tasks.index</code> configuration setting is set <code class="literal">.{xpack.tasks.index}_{kibana_version}_001</code> E.g. for Kibana v7.12.0 <code class="literal">.kibana_task_manager_7.12.0_001</code>.
</li>
</ul>
</div>
<p>The index aliases <code class="literal">.kibana</code> and <code class="literal">.kibana_task_manager</code> will always point to
the most up-to-date saved object indices.</p>
<p>The first time a newer Kibana starts, it will first perform an upgrade migration before starting plugins or serving HTTP traffic. To prevent losing acknowledged writes old nodes should be shutdown before starting the upgrade. To reduce the likelihood of old nodes losing acknowledged writes, Kibana 7.12.0 and later will add a write block to the outdated index. Table 1 lists the saved objects indices used by previous versions of Kibana.</p>
<div class="table">
<p class="title"><strong>Table 1. Saved object indices and aliases per Kibana version</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="Saved object indices and aliases per Kibana version">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Upgrading from version</th>
<th align="left" valign="top">Outdated index (alias)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>6.0.0 through 6.4.x</p></td>
<td align="left" valign="top"><p><code class="literal">.kibana</code></p>
<p><code class="literal">.kibana_task_manager_7.12.0_001</code> (<code class="literal">.kibana_task_manager</code> alias)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>6.5.0 through 7.3.x</p></td>
<td align="left" valign="top"><p><code class="literal">.kibana_N</code> (<code class="literal">.kibana</code> alias)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>7.4.0 through 7.11.x</p></td>
<td align="left" valign="top"><p><code class="literal">.kibana_N</code> (<code class="literal">.kibana</code> alias)</p>
<p><code class="literal">.kibana_task_manager_N</code> (<code class="literal">.kibana_task_manager</code> alias)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_upgrading_multiple_kibana_instances_2"></a>Upgrading multiple Kibana instances<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h3>
</div></div></div>
<p>When upgrading several Kibana instances connected to the same Elasticsearch cluster, ensure that all outdated instances are shutdown before starting the upgrade.</p>
<p>Kibana does not support rolling upgrades. However, once outdated instances are shutdown, all upgraded instances can be started in parallel in which case all instances will participate in the upgrade migration in parallel.</p>
<p>For large deployments with more than 10 Kibana instances and more than 10 000 saved objects, the upgrade downtime can be reduced by bringing up a single Kibana instance and waiting for it to complete the upgrade migration before bringing up the remaining instances.</p>
<h4><a id="preventing-migration-failures"></a>Preventing migration failures<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h4>
<p>This section highlights common causes of Kibana upgrade failures and how to prevent them.</p>
<h5><a id="_timeout_exception_or_receive_timeout_transport_exception"></a>timeout_exception or receive_timeout_transport_exception<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h5>
<p>There is a known issue in v7.12.0 for users who tried the fleet beta. Upgrade migrations fail because of a large number of documents in the <code class="literal">.kibana</code> index.</p>
<p>This can cause Kibana to log errors like:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Error: Unable to complete saved object migrations for the [.kibana] index. Please check the health of your Elasticsearch cluster and try again. Error: [receive_timeout_transport_exception]: [instance-0000000002][10.32.1.112:19541][cluster:monitor/task/get] request_id [2648] timed out after [59940ms]

Error: Unable to complete saved object migrations for the [.kibana] index. Please check the health of your Elasticsearch cluster and try again. Error: [timeout_exception]: Timed out waiting for completion of [org.elasticsearch.index.reindex.BulkByScrollTask@6a74c54]</pre>
</div>
<p>See <a href="https://github.com/elastic/kibana/issues/95321" class="ulink" target="_top">https://github.com/elastic/kibana/issues/95321</a> for instructions to work around this issue.</p>
<h5><a id="_corrupt_saved_objects"></a>Corrupt saved objects<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h5>
<p>We highly recommend testing your Kibana upgrade in a development cluster to discover and remedy problems caused by corrupt documents, especially when there are custom integrations creating saved objects in your environment.</p>
<p>Saved objects that were corrupted through manual editing or integrations will cause migration failures with a log message like <code class="literal">Failed to transform document. Transform: index-pattern:7.0.0\n Doc: {...}</code> or <code class="literal">Unable to migrate the corrupt Saved Object document ...</code>. Corrupt documents will have to be fixed or deleted before an upgrade migration can succeed.</p>
<p>For example, given the following error message:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Unable to migrate the corrupt saved object document with _id: 'marketing_space:dashboard:e3c5fc71-ac71-4805-bcab-2bcc9cc93275'. To allow migrations to proceed, please delete this document from the [.kibana_7.12.0_001] index.</pre>
</div>
<p>The following steps must be followed to delete the document that is causing the migration to fail:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Remove the write block which the migration system has placed on the previous index:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">PUT .kibana_7.12.1_001/_settings
{
  "index": {
    "blocks.write": false
  }
}</pre>
</div>
</li>
<li class="listitem">
<p>Delete the corrupt document:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">DELETE .kibana_7.12.0_001/_doc/marketing_space:dashboard:e3c5fc71-ac71-4805-bcab-2bcc9cc93275</pre>
</div>
</li>
<li class="listitem">
Restart Kibana.
</li>
</ol>
</div>
<p>In this example, the Dashboard with ID <code class="literal">e3c5fc71-ac71-4805-bcab-2bcc9cc93275</code> that belongs to the space <code class="literal">marketing_space</code> <span class="strong strong"><strong>will no longer be available</strong></span>.</p>
<p>Be sure you have a snapshot before you delete the corrupt document. If restoring from a snapshot is not an option, it is recommended to also delete the <code class="literal">temp</code> and <code class="literal">target</code> indices the migration created before restarting Kibana and retrying.</p>
<h5><a id="_user_defined_index_templates_that_causes_new_kibana_indices_to_have_incompatible_settings_or_mappings"></a>User defined index templates that causes new <code class="literal">.kibana*</code> indices to have incompatible settings or mappings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h5>
<p>Matching index templates which specify <code class="literal">settings.refresh_interval</code> or <code class="literal">mappings</code> are known to interfere with Kibana upgrades.</p>
<p>Prevention: narrow down the index patterns of any user-defined index templates to ensure that these won&#8217;t apply to new <code class="literal">.kibana*</code> indices.</p>
<p>Note: Kibana &lt; 6.5 creates it&#8217;s own index template called <code class="literal">kibana_index_template:.kibana</code> and index pattern <code class="literal">.kibana</code>. This index template will not interfere and does not need to be changed or removed.</p>
<h5><a id="_an_unhealthy_elasticsearch_cluster"></a>An unhealthy Elasticsearch cluster<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h5>
<p>Problems with your Elasticsearch cluster can prevent Kibana upgrades from succeeding. Ensure that your cluster has:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
enough free disk space, at least twice the amount of storage taken up by the <code class="literal">.kibana</code> and <code class="literal">.kibana_task_manager</code> indices
</li>
<li class="listitem">
sufficient heap size
</li>
<li class="listitem">
a "green" cluster status
</li>
</ul>
</div>
<h5><a id="_unsupported_routing_allocation_elasticsearch_cluster_settings"></a>Unsupported routing allocation Elasticsearch cluster settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h5>
<p>As part of upgrade migrations, Kibana creates indices with an auto-expanded replica. When routing allocation is disabled or restricted (<code class="literal">cluster.routing.allocation.enable: none/primaries/new_primaries</code>) the replica shard won&#8217;t get assigned causing the upgrade to fail.</p>
<p>If routing allocation does not allow auto-expanded replica creation, you might see a log entry similar to:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Action failed with 'Timeout waiting for the status of the [.kibana_task_manager_7.17.1_reindex_temp] index to become 'yellow''. Retrying attempt 11 in 64 seconds.</pre>
</div>
<p>To prevent the issue, remove the transient and persisted routing allocation settings if they are set:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">PUT /_cluster/settings
{
  "transient": {
    "cluster.routing.allocation.enable": null
  },
  "persistent": {
    "cluster.routing.allocation.enable": null
  }
}</pre>
</div>
<h5><a id="_different_versions_of_kibana_connected_to_the_same_elasticsearch_index"></a>Different versions of Kibana connected to the same Elasticsearch index<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h5>
<p>When different versions of Kibana are attempting an upgrade migration in parallel this can lead to migration failures. Ensure that all Kibana instances are running the same version, configuration and plugins.</p>
<h5><a id="_incompatible_xpack_tasks_index_configuration_setting"></a>Incompatible <code class="literal">xpack.tasks.index</code> configuration setting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h5>
<p>For Kibana versions prior to 7.5.1, if the task manager index is set to <code class="literal">.tasks</code> with the configuration setting <code class="literal">xpack.tasks.index: ".tasks"</code>, upgrade migrations will fail. Kibana 7.5.1 and later prevents this by refusing to start with an incompatible configuration setting.</p>
<h4><a id="resolve-migrations-failures"></a>Resolving migration failures<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h4>
<p>If Kibana terminates unexpectedly while migrating a saved object index it will automatically attempt to perform the migration again once the process has restarted. Do not delete any saved objects indices to attempt to fix a failed migration. Unlike previous versions, Kibana version 7.12.0 and later does not require deleting any indices to release a failed migration lock.</p>
<p>If upgrade migrations fail repeatedly, follow the advice in <a class="xref" href="upgrade-migrations.html#preventing-migration-failures" title="Preventing migration failures">preventing migration failures</a>. Once the root cause for the migration failure has been addressed, Kibana will automatically retry the migration without any further intervention. If you&#8217;re unable to resolve a failed migration following these steps, please contact support.</p>
<h4><a id="upgrade-migrations-rolling-back"></a>Rolling back to a previous version of Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h4>
<p>If you&#8217;ve followed the advice in <a class="xref" href="upgrade-migrations.html#preventing-migration-failures" title="Preventing migration failures">preventing migration failures</a> and <a class="xref" href="upgrade-migrations.html#resolve-migrations-failures" title="Resolving migration failures">resolving migration failures</a> and Kibana is still not able to upgrade successfully, you might choose to rollback Kibana until you&#8217;re able to identify and fix the root cause.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Before rolling back Kibana, ensure that the version you wish to rollback to is compatible with your Elasticsearch cluster. If the version you&#8217;re rolling back to is not compatible, you will have to also rollback Elasticsearch.<br>
Any changes made after an upgrade will be lost when rolling back to a previous version.</p>
</div>
</div>
<p>In order to rollback after a failed upgrade migration, the saved object indices have to be rolled back to be compatible with the previous {kibana} version.</p>
<h5><a id="_rollback_by_restoring_a_backup_snapshot"></a>Rollback by restoring a backup snapshot:<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h5>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Before proceeding, <a href="/guide/en/elasticsearch/reference/7.17/snapshots-take-snapshot.html" class="ulink" target="_top">take a snapshot</a> that contains the <code class="literal">kibana</code> feature state or all <code class="literal">.kibana*</code> indices.
</li>
<li class="listitem">
Shutdown all Kibana instances to be 100% sure that there are no instances currently performing a migration.
</li>
<li class="listitem">
Delete all saved object indices with <code class="literal">DELETE /.kibana*</code>
</li>
<li class="listitem">
<a href="/guide/en/elasticsearch/reference/7.17/snapshots-restore-snapshot.html" class="ulink" target="_top">Restore</a> the <code class="literal">kibana</code> feature state or all `.kibana* indices and their aliases from the snapshot.
</li>
<li class="listitem">
Start up all Kibana instances on the older version you wish to rollback to.
</li>
</ol>
</div>
<h5><a id="_not_recommended_rollback_without_a_backup_snapshot"></a>(Not recommended) Rollback without a backup snapshot:<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h5>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Shutdown all Kibana instances to be 100% sure that there are no Kibana instances currently performing a migration.
</li>
<li class="listitem">
<a href="/guide/en/elasticsearch/reference/7.17/snapshots-take-snapshot.html" class="ulink" target="_top">Take a snapshot</a> that includes the <code class="literal">kibana</code> feature state or all <code class="literal">.kibana*</code> indices.
</li>
<li class="listitem">
Delete the version specific indices created by the failed upgrade migration. E.g. if you wish to rollback from a failed upgrade to v7.12.0 <code class="literal">DELETE /.kibana_7.12.0_*,.kibana_task_manager_7.12.0_*</code>
</li>
<li class="listitem">
Inspect the output of <code class="literal">GET /_cat/aliases</code>. If either the <code class="literal">.kibana</code> and/or <code class="literal">.kibana_task_manager</code> alias is missing, these will have to be created manually. Find the latest index from the output of <code class="literal">GET /_cat/indices</code> and create the missing alias to point to the latest index. E.g. if the <code class="literal">.kibana</code> alias was missing and the latest index is <code class="literal">.kibana_3</code> create a new alias with <code class="literal">POST /.kibana_3/_aliases/.kibana</code>.
</li>
<li class="listitem">
Remove the write block from the rollback indices. <code class="literal">PUT /.kibana,.kibana_task_manager/_settings {"index.blocks.write": false}</code>
</li>
<li class="listitem">
Start up Kibana on the older version you wish to rollback to.
</li>
</ol>
</div>
<h4><a id="upgrade-migrations-old-indices"></a>Handling old <code class="literal">.kibana_N</code> indices<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/7.17/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h4>
<p>After migrations have completed, there will be multiple Kibana indices in Elasticsearch: (<code class="literal">.kibana_1</code>, <code class="literal">.kibana_2</code>, <code class="literal">.kibana_7.12.0</code> etc). Kibana only uses the index that the <code class="literal">.kibana</code> and <code class="literal">.kibana_task_manager</code> alias points to. The other Kibana indices can be safely deleted, but are left around as a matter of historical record, and to facilitate rolling Kibana back to a previous version.</p>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="upgrade-standard.html">« Standard upgrade</a>
</span>
<span class="next">
<a href="logging-configuration-migration.html">Logging configuration migration »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
