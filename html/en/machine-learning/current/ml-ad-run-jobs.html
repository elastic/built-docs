<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<meta name="keywords" content="ML, Elastic Stack, anomaly detection">
<title>Run anomaly detection jobs | Machine Learning in the Elastic Stack [8.7] | Elastic</title>
<meta class="elastic" name="content" content="Run anomaly detection jobs | Machine Learning in the Elastic Stack [8.7]">

<link rel="home" href="index.html" title="Machine Learning in the Elastic Stack [8.7]"/>
<link rel="up" href="ml-ad-finding-anomalies.html" title="Finding anomalies in time series data"/>
<link rel="prev" href="ml-ad-plan.html" title="Plan your anomaly detection analysis"/>
<link rel="next" href="ml-ad-view-results.html" title="View anomaly detection job results"/>
<meta class="elastic" name="product_version" content="8.7"/>
<meta class="elastic" name="product_name" content="Machine Learning"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elastic Stack/Machine Learning/8.7"/>
<meta name="DC.subject" content="Machine Learning"/>
<meta name="DC.identifier" content="8.7"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Machine Learning in the Elastic Stack [8.7]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="ml-ad-overview.html">Anomaly detection</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="ml-ad-finding-anomalies.html">Finding anomalies in time series data</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="ml-ad-plan.html">« Plan your anomaly detection analysis</a>
</span>
<span class="next">
<a href="ml-ad-view-results.html">View anomaly detection job results »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="ml-ad-run-jobs"></a>Run anomaly detection jobs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/ml-ad-run-jobs.asciidoc">edit</a></h2>
</div></div></div>

<p>Anomaly detection jobs contain the configuration information and metadata
necessary to perform the machine learning analysis. They can run for a specific time period
or continuously against incoming data.</p>
<h4><a id="ml-ad-setup"></a>Set up the environment<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/ml-ad-run-jobs.asciidoc">edit</a></h4>
<p>Before you can use the Elastic Stack machine learning features, there are some configuration
requirements (such as security privileges) that must be addressed. Refer to
<a class="xref" href="setup.html" title="Set up machine learning features"><em>Setup and security</em></a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If your data is located outside of Elasticsearch, you cannot use Kibana to create
your jobs and you cannot use datafeeds to retrieve your data in real time.
Posting data directly to anomaly detection jobs is deprecated, in a future major version
a datafeed will be required.</p>
</div>
</div>
<h4><a id="ml-ad-create-job"></a>Create an anomaly detection job<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/ml-ad-run-jobs.asciidoc">edit</a></h4>
<p>You can create anomaly detection jobs by using the
<a href="/guide/en/elasticsearch/reference/8.7/ml-put-job.html" class="ulink" target="_top">create anomaly detection jobs API</a>. Kibana also provides
wizards to simplify the process, which vary depending on whether you are using
the Machine Learning app, Elastic Security app or Observability apps. In <span class="strong strong"><strong>Machine Learning</strong></span> &gt;
<span class="strong strong"><strong>Anomaly Detection</strong></span>:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/ml-create-job.png" alt="Create New Job">
</div>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The single metric wizard creates simple jobs that have a single detector. A
<em>detector</em> applies an analytical function to specific fields in your data. In
addition to limiting the number of detectors, the single metric wizard omits
many of the more advanced configuration options.
</li>
<li class="listitem">
The multi-metric wizard creates jobs that can have more than one detector,
which is more efficient than running multiple jobs against the same data.
</li>
<li class="listitem">
The population wizard creates jobs that detect activity that is unusual compared
to the behavior of the population.
</li>
<li class="listitem">
The categorization wizard creates jobs that group log messages into categories
and use <code class="literal">count</code> or <code class="literal">rare</code> functions to detect anomalies within them.
</li>
<li class="listitem">
The advanced wizard creates jobs that can have multiple detectors and enables
you to configure all job settings.
</li>
</ul>
</div>
<p>Kibana can also recognize certain types of data and provide specialized wizards
for that context. For example, there are anomaly detection jobs for the sample
eCommerce orders and sample web logs data sets, as well as for data generated by
the Elastic Security and Observability solutions, Beats, and Elastic Agent
Integrations. For a list of all the preconfigured jobs, see <a class="xref" href="ootb-ml-jobs.html" title="Supplied anomaly detection configurations">Supplied configurations</a>.</p>
<p><a id="ml-ad-job-tips"></a>When you create an anomaly detection job in Kibana, the job creation wizards can
provide advice based on the characteristics of your data. By heeding these
suggestions, you can create jobs that are more likely to produce insightful machine learning
results. The most important concepts are covered here; for a description of all
the job properties, see the
<a href="/guide/en/elasticsearch/reference/8.7/ml-put-job.html" class="ulink" target="_top">create anomaly detection jobs API</a>.</p>
<h5><a id="ml-ad-bucket-span"></a>Bucket span<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/job-tips.asciidoc">edit</a></h5>
<p>The machine learning features use the concept of a <em>bucket</em> to divide the time series into
batches for processing.</p>
<p>The <em>bucket span</em> is part of the configuration information for an anomaly detection job.
It defines the time interval that is used to summarize and model the data. This
is typically between 5 minutes to 1 hour and it depends on your data
characteristics. When you set the bucket span, take into account the granularity
at which you want to analyze, the frequency of the input data, the typical
duration of the anomalies, and the frequency at which alerting is required.</p>
<p>The bucket span must contain a valid <a href="/guide/en/elasticsearch/reference/8.7/api-conventions.html#time-units" class="ulink" target="_top">time interval</a>. When you
create an anomaly detection job in Kibana, you can choose to estimate a bucket span value
based on your data characteristics. If you choose a value that is larger than
one day or is significantly different than the estimated value, you receive an
informational message.</p>
<h5><a id="ml-ad-detectors"></a>Detectors<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/job-tips.asciidoc">edit</a></h5>
<p>Each anomaly detection job must have one or more <em>detectors</em>. A detector defines the
type of analysis that will occur and which fields to analyze.</p>
<p>Detectors can also contain properties that affect which types of entities or
events are considered anomalous. For example, you can specify whether entities
are analyzed relative to their own previous behavior or relative to other
entities in a population. There are also multiple options for splitting the data
into categories and partitions.</p>
<p>If your job does not contain a  detector or the detector does not contain a
<a class="xref" href="ml-functions.html" title="Function reference">valid function</a>, you receive an error. If a job contains
duplicate detectors, you also receive an error. Detectors are
duplicates if they have the same <code class="literal">function</code>, <code class="literal">field_name</code>, <code class="literal">by_field_name</code>,
<code class="literal">over_field_name</code> and <code class="literal">partition_field_name</code>.</p>
<h5><a id="ml-ad-influencers"></a>Influencers<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/job-tips.asciidoc">edit</a></h5>
<p>When anomalous events occur, we want to know why. To determine the cause,
however, you often need a broader knowledge of the domain. If you have
suspicions about which entities in your data set are likely causing
irregularities, you can identify them as influencers in your anomaly detection jobs.
That is to say, <em>influencers</em> are fields that you suspect contain information
about someone or something that influences or contributes to anomalies in your
data. Influencers can be any field in your data.</p>
<p>You can pick influencers when you create your anomaly detection job by using the
<span class="strong strong"><strong>Advanced job wizard</strong></span>.</p>
<details>
<summary class="title"><span class="strong strong"><strong>Requirements when using the machine learning APIs to pick influencers</strong></span></summary>
<div class="content">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The influencer field must exist in your datafeed query or aggregation;
otherwise it is not included in the job analysis.
</li>
<li class="listitem">
If you use a query in your datafeed: influencer fields must exist in the query
results in the same hit as the detector fields. Datafeeds process data by
paging through the query results; since search hits cannot span multiple indices
or documents, datafeeds have the same limitation.
</li>
<li class="listitem">
If you use aggregations in your datafeed, it is possible to use influencers
that come from different indices than the detector fields. However, both indices
must have a date field with the same name, which you specify in the
<code class="literal">data_description</code>.<code class="literal">time_field</code> property for the datafeed.
</li>
<li class="listitem">
Influencers do not need to be fields that are specified in your anomaly detection job
detectors, though they often are.
</li>
</ul>
</div>
</div>
</details>
<p>Picking an influencer is strongly recommended for the following reasons:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
It allows you to more easily assign blame for anomalies.
</li>
<li class="listitem">
It simplifies and aggregates the results.
</li>
</ul>
</div>
<p>If you use Kibana, the job creation wizards can suggest which fields to use as
influencers. The best influencer is the person or thing that you want to blame
for the anomaly. In many cases, categorical data fields – like users or client
IP addresses – make excellent influencers.</p>
<p>The <span class="strong strong"><strong>Anomaly Explorer</strong></span> in Kibana lists the top influencers for a job and shows
the most influental values for every anomaly. It also enables you to filter the
data by a given influencer.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Do not pick too many influencers. For example, you generally do not need
more than three. If you pick many influencers, the results can be overwhelming
and there is a small overhead to the analysis.</p>
</div>
</div>
<p>Refer to
<a href="/blog/interpretability-in-ml-identifying-anomalies-influencers-root-causes" class="ulink" target="_top">this blog post</a>
for further details on influencers.</p>
<h5><a id="ml-ad-cardinality"></a>Cardinality<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/job-tips.asciidoc">edit</a></h5>
<p>If there are logical groupings of related entities in your data, machine learning analytics
can make data models and generate results that take these groupings into
consideration. For example, you might choose to split your data by user ID and
detect when users are accessing resources differently than they usually do.</p>
<p>If the field that you use to split your data has many different values, the
job uses more memory resources. In Kibana, if the cardinality of the
<code class="literal">by_field_name</code>, <code class="literal">over_field_name</code>, or <code class="literal">partition_field_name</code> is greater than
1000, the job creation wizards advise that there might be high memory usage.
Likewise if you are performing population analysis and the cardinality of the
<code class="literal">over_field_name</code> is below 10, you are advised that this might not be a suitable
field to use.</p>
<h5><a id="ml-ad-model-memory-limits"></a>Model memory limits<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/job-tips.asciidoc">edit</a></h5>
<p>For each anomaly detection job, you can optionally specify a <code class="literal">model_memory_limit</code>, which
is the approximate maximum amount of memory resources that are required for
analytical processing. The default value is 1 GB. Once this limit is approached,
data pruning becomes more aggressive. Upon exceeding this limit, new entities
are not modeled.</p>
<p>You can also optionally specify the <code class="literal">xpack.ml.max_model_memory_limit</code> setting.
By default, it&#8217;s not set, which means there is no upper bound on the acceptable
<code class="literal">model_memory_limit</code> values in your jobs.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you set the <code class="literal">model_memory_limit</code> too high, it will be impossible to open
the job; jobs cannot be allocated to nodes that have insufficient memory to run
them.</p>
</div>
</div>
<p>If the estimated model memory limit for an anomaly detection job is greater than the
model memory limit for the job or the maximum model memory limit for the cluster,
the job creation wizards in Kibana generate a warning. If the estimated memory
requirement is only a little higher than the <code class="literal">model_memory_limit</code>, the job will
probably produce useful results. Otherwise, the actions you take to address
these warnings vary depending on the resources available in your cluster:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If you are using the default value for the <code class="literal">model_memory_limit</code> and the machine learning
nodes in the cluster have lots of memory, the best course of action might be to
simply increase the job&#8217;s <code class="literal">model_memory_limit</code>. Before doing this, however,
double-check that the chosen analysis makes sense. The default
<code class="literal">model_memory_limit</code> is relatively low to avoid accidentally creating a job that
uses a huge amount of memory.
</li>
<li class="listitem">
<p>If the machine learning nodes in the cluster do not have sufficient memory to accommodate
a job of the estimated size, the only options are:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add bigger machine learning nodes to the cluster, or
</li>
<li class="listitem">
Accept that the job will hit its memory limit and will not necessarily find
all the anomalies it could otherwise find.
</li>
</ul>
</div>
</li>
</ul>
</div>
<p>If you are using Elastic Cloud Enterprise or the hosted Elasticsearch Service on Elastic Cloud,
<code class="literal">xpack.ml.max_model_memory_limit</code> is set to prevent you from creating jobs
that cannot be allocated to any machine learning nodes in the cluster. If you find that you
cannot increase <code class="literal">model_memory_limit</code> for your machine learning jobs, the solution is to
increase the size of the machine learning nodes in your cluster.</p>
<h5><a id="ml-ad-dedicated-indices"></a>Dedicated indices<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/job-tips.asciidoc">edit</a></h5>
<p>For each anomaly detection job, you can optionally specify a dedicated index to store
the anomaly detection results. As anomaly detection jobs may produce a large amount
of results (for example, jobs with many time series, small bucket span, or with
long running period), it is recommended to use a dedicated results index by
choosing the <span class="strong strong"><strong>Use dedicated index</strong></span> option in Kibana or specifying the
<code class="literal">results_index_name</code> via the <a href="/guide/en/elasticsearch/reference/8.7/ml-put-job.html" class="ulink" target="_top">Create anomaly detection jobs API</a>.</p>
<h5><a id="ml-ad-datafeeds"></a>Datafeeds<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/ml-ad-run-jobs.asciidoc">edit</a></h5>
<p>If you create anomaly detection jobs in Kibana, you <em>must</em> use datafeeds to retrieve data
from Elasticsearch for analysis. When you create an anomaly detection job, you select a
data view and Kibana configures the datafeed for you under the covers.</p>
<p>You can associate only one datafeed with each anomaly detection job. The datafeed contains
a query that runs at a defined interval (<code class="literal">frequency</code>). By default, this interval
is calculated relative to the <a class="xref" href="ml-buckets.html" title="Buckets">bucket span</a> of the anomaly detection job.
If you are concerned about delayed data, you can add a delay before the query
runs at each interval. See <a class="xref" href="ml-delayed-data-detection.html" title="Handling delayed data">Handling delayed data</a>.</p>
<p>Datafeeds can also aggregate data before sending it to the anomaly detection job.
There are some limitations, however, and aggregations should generally be used
only for low cardinality data. See <a class="xref" href="ml-configuring-aggregation.html" title="Aggregating data for faster performance">Aggregating data for faster performance</a>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>When the Elasticsearch security features are enabled, a datafeed stores the roles of the
user who created or updated the datafeed at that time. This means that if those
roles are updated, the datafeed subsequently runs with the new permissions that
are associated with the roles. However, if the user’s roles are adjusted after
creating or updating the datafeed, the datafeed continues to run with the
permissions that were associated with the original roles.</p>
<p>One way to update the roles that are stored within the datafeed without changing
any other settings is to submit an empty JSON document ({}) to the
<a href="/guide/en/elasticsearch/reference/8.7/ml-update-datafeed.html" class="ulink" target="_top">update datafeed API</a>.</p>
</div>
</div>
<p>If the data that you want to analyze is not stored in Elasticsearch, you cannot use
datafeeds. You can however send batches of data directly to the job by using the
<a href="/guide/en/elasticsearch/reference/8.7/ml-post-data.html" class="ulink" target="_top">post data to jobs API</a>. <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono u-strikethrough">7.11.0</span>]
<span class="Admonishment-detail">
Deprecated in 7.11.0.
</span>
</span></p>
<h4><a id="ml-ad-open-job"></a>Open the job<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/ml-ad-run-jobs.asciidoc">edit</a></h4>
<p>An anomaly detection job must be opened in order for it to be ready to receive and
analyze data. It can be opened and closed multiple times throughout its
lifecycle.</p>
<p>After you start the job, you can start the datafeed, which retrieves data from
your cluster. A datafeed can be started and stopped multiple times throughout its
lifecycle. When you start it, you can optionally specify start and end times. If
you do not specify an end time, the datafeed runs continuously.</p>
<p>You can perform both these tasks in Kibana or use the
<a href="/guide/en/elasticsearch/reference/8.7/ml-open-job.html" class="ulink" target="_top">open anomaly detection jobs</a> and
<a href="/guide/en/elasticsearch/reference/8.7/ml-start-datafeed.html" class="ulink" target="_top">start datafeeds</a> APIs.</p>
<h4><a id="ml-ad-tune"></a>Tune the job<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/ml-ad-run-jobs.asciidoc">edit</a></h4>
<p>Typically after you open a job, the next step is to
<a class="xref" href="ml-ad-view-results.html" title="View anomaly detection job results">view the results</a>. You might find that you need to alter
the job configuration or settings.</p>
<h5><a id="ml-ad-calendars"></a>Calendars and scheduled events<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/ml-ad-run-jobs.asciidoc">edit</a></h5>
<p>Sometimes there are periods when you expect unusual activity to take place,
such as bank holidays, "Black Friday", or planned system outages. If you
identify these events in advance, no anomalies are generated during that period.
The machine learning model is not ill-affected and you do not receive spurious results.</p>
<p>You can create calendars and scheduled events in the <span class="strong strong"><strong>Settings</strong></span> pane on the
<span class="strong strong"><strong>Machine Learning</strong></span> page in Kibana or by using
<a href="/guide/en/elasticsearch/reference/8.7/ml-ad-apis.html" class="ulink" target="_top">Machine learning anomaly detection APIs</a>.</p>
<p>A scheduled event must have a start time, end time, and description. In general,
scheduled events are short in duration (typically lasting from a few hours to a
day) and occur infrequently. If you have regularly occurring events, such as
weekly maintenance periods, you do not need to create scheduled events for these
circumstances; they are already handled by the machine learning analytics.</p>
<p>You can identify zero or more scheduled events in a calendar. Anomaly detection jobs
can then subscribe to calendars and the machine learning analytics handle all subsequent
scheduled events appropriately.</p>
<p>If you want to add multiple scheduled events at once, you can import an
iCalendar (<code class="literal">.ics</code>) file in Kibana or a JSON file in the
<a href="/guide/en/elasticsearch/reference/8.7/ml-post-calendar-event.html" class="ulink" target="_top">add events to calendar API</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
You must identify scheduled events before your anomaly detection job analyzes the data
for that time period. Machine learning results are not updated retroactively.
</li>
<li class="listitem">
If your iCalendar file contains recurring events, only the first occurrence is
imported.
</li>
<li class="listitem">
<a class="xref" href="ml-bucket-results.html" title="Bucket results">Bucket results</a> are generated during scheduled events but
they have an anomaly score of zero.
</li>
<li class="listitem">
If you use long or frequent scheduled events, it might take longer for the
machine learning analytics to learn to model your data and some anomalous behavior might be
missed.
</li>
</ul>
</div>
</div>
</div>
<h5><a id="ml-ad-rules"></a>Custom rules<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/ml-ad-run-jobs.asciidoc">edit</a></h5>
<p>By default, anomaly detection is unsupervised and the machine learning models have no
awareness of the domain of your data. As a result, anomaly detection jobs might
identify events that are statistically significant but are uninteresting when
you know the larger context. Machine learning custom rules enable you to customize
anomaly detection.</p>
<p><em>Custom rules</em> – or <em>job rules</em> as Kibana refers to them – instruct anomaly
detectors to change their behavior based on domain-specific knowledge that you
provide. When you create a rule, you can specify conditions, scope, and actions.
When the conditions of a rule are satisfied, its actions are triggered.</p>
<p>For example, if you have an anomaly detector that is analyzing CPU usage, you
might decide you are only interested in anomalies where the CPU usage is greater
than a certain threshold. You can define a rule with conditions and actions that
instruct the detector to refrain from generating machine learning results when there are
anomalous events related to low CPU usage. You might also decide to add a scope
for the rule, such that it applies only to certain machines. The scope is
defined by using machine learning filters.</p>
<p><em>Filters</em> contain a list of values that you can use to include or exclude events
from the machine learning analysis. You can use the same filter in multiple anomaly detection jobs.</p>
<p>If you are analyzing web traffic, you might create a filter that contains a list
of IP addresses. For example, maybe they are IP addresses that you trust to
upload data to your website or to send large amounts of data from behind your
firewall. You can define the scope of a rule such that it triggers only when a
specific field in your data matches one of the values in the filter.
Alternatively, you can make it trigger only when the field value does not match
one of the filter values. You therefore have much greater control over which
anomalous events affect the machine learning model and appear in the machine learning results.</p>
<p>For more information, see <a class="xref" href="ml-configuring-detector-custom-rules.html" title="Customizing detectors with custom rules">Customizing detectors with custom rules</a>.</p>
<h5><a id="ml-ad-model-snapshots"></a>Model snapshots<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/ml-ad-run-jobs.asciidoc">edit</a></h5>
<p>Elastic Stack machine learning features calculate baselines of normal behavior then extrapolate
anomalous events. These baselines are accomplished by generating models of your
data.</p>
<p>To ensure resilience in the event of a system failure, snapshots of the machine learning
model for each anomaly detection job are saved to an internal index within the Elasticsearch
cluster. The amount of time necessary to save these snapshots is proportional to
the size of the model in memory. By default, snapshots are captured
approximately every 3 to 4 hours. You can change this interval
(<code class="literal">background_persist_interval</code>) when you create or update a job.</p>
<p>To reduce the number of snapshots consuming space on your cluster, at the end of
each day, old snapshots are automatically deleted. The age of each snapshot is
calculated relative to the timestamp of the most recent snapshot. By default, if
there are snapshots over one day older than the newest snapshot, they are
deleted except for the first snapshot each day. As well, all snapshots over ten
days older than the newest snapshot are deleted. You can change these retention
settings (<code class="literal">daily_model_snapshot_retention_after_days</code> and
<code class="literal">model_snapshot_retention_days</code>) when you create or update a job. If you want to
exempt a specific snapshot from this clean up, use Kibana or the
<a href="/guide/en/elasticsearch/reference/8.7/ml-update-snapshot.html" class="ulink" target="_top">update model snapshots API</a> to set <code class="literal">retain</code> to
<code class="literal">true</code>.</p>
<p>You can see the list of model snapshots for each job with the
<a href="/guide/en/elasticsearch/reference/8.7/ml-get-snapshot.html" class="ulink" target="_top">get model snapshots API</a> or in the
<span class="strong strong"><strong>Model snapshots</strong></span> tab on the <span class="strong strong"><strong>Job Management</strong></span> page in Kibana:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/ml-model-snapshots.png" alt="Example screenshot with a list of model snapshots">
</div>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>There are situations other than system failures where you might want to
<a href="/guide/en/elasticsearch/reference/8.7/ml-revert-snapshot.html" class="ulink" target="_top">revert</a> to using a specific model snapshot. The
machine learning features react quickly to anomalous input and new behaviors in data. Highly
anomalous input increases the variance in the models and machine learning analytics must
determine whether it is a new step-change in behavior or a one-off event. In the
case where you know this anomalous input is a one-off, it might be appropriate
to reset the model state to a time before this event. For example, after a Black
Friday sales day you might consider reverting to a saved snapshot. If you know
about such events in advance, however, you can use
<a class="xref" href="ml-calendars.html" title="Calendars and scheduled events">calendars and scheduled events</a> to avoid impacting your model.</p>
</div>
</div>
<h4><a id="ml-ad-close-job"></a>Close the job<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/ml-ad-run-jobs.asciidoc">edit</a></h4>
<p>When historical data is analyzed, there is no need to stop the datafeed and/or
close the job as they are stopped and closed automatically when the end time is
reached.</p>
<p>If you need to stop your anomaly detection job, an orderly shutdown ensures that:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Datafeeds are stopped
</li>
<li class="listitem">
Buffers are flushed
</li>
<li class="listitem">
Model history is pruned
</li>
<li class="listitem">
Final results are calculated
</li>
<li class="listitem">
Model snapshots are saved
</li>
<li class="listitem">
Anomaly detection jobs are closed
</li>
</ul>
</div>
<p>This process ensures that jobs are in a consistent state in case you want to
subsequently re-open them.</p>
<h5><a id="stopping-ml-datafeeds"></a>Stopping datafeeds<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/stopping-ml.asciidoc">edit</a></h5>
<p>When you stop a datafeed, it ceases to retrieve data from Elasticsearch. You can stop a
datafeed by using Kibana or the
<a href="/guide/en/elasticsearch/reference/8.7/ml-stop-datafeed.html" class="ulink" target="_top">stop datafeeds API</a>. For example, the following
request stops the <code class="literal">feed1</code> datafeed:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _ml/datafeeds/feed1/_stop</pre>
</div>
<div class="console_widget" data-snippet="snippets/1.console"></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You must have <code class="literal">manage_ml</code>, or <code class="literal">manage</code> cluster privileges to stop datafeeds.
For more information, see <a href="/guide/en/elasticsearch/reference/8.7/security-privileges.html" class="ulink" target="_top">Security privileges</a>.</p>
</div>
</div>
<p>A datafeed can be started and stopped multiple times throughout its lifecycle.</p>
<h5><a id="stopping-all-ml-datafeeds"></a>Stopping all datafeeds<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/stopping-ml.asciidoc">edit</a></h5>
<p>If you are upgrading your cluster, you can use the following request to stop all
datafeeds:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _ml/datafeeds/_all/_stop</pre>
</div>
<div class="console_widget" data-snippet="snippets/2.console"></div>
<h5><a id="closing-ml-jobs"></a>Closing anomaly detection jobs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/stopping-ml.asciidoc">edit</a></h5>
<p>When you close an anomaly detection job, it cannot receive data or perform analysis
operations. You can close a job by using the
<a href="/guide/en/elasticsearch/reference/8.7/ml-close-job.html" class="ulink" target="_top">close anomaly detection job API</a>. For example, the following
request closes the <code class="literal">job1</code> job:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _ml/anomaly_detectors/job1/_close</pre>
</div>
<div class="console_widget" data-snippet="snippets/3.console"></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You must have <code class="literal">manage_ml</code>, or <code class="literal">manage</code> cluster privileges to stop
anomaly detection jobs. For more information, see
<a href="/guide/en/elasticsearch/reference/8.7/security-privileges.html" class="ulink" target="_top">Security privileges</a>.</p>
</div>
</div>
<p>If you submit a request to close an anomaly detection job and its datafeed is running,
the request first tries to stop the datafeed. This behavior is equivalent to
calling the <a href="/guide/en/elasticsearch/reference/8.7/ml-stop-datafeed.html" class="ulink" target="_top">stop datafeeds API</a> with the same
<code class="literal">timeout</code> and <code class="literal">force</code> parameters as the close job request.</p>
<p>Anomaly detection jobs can be opened and closed multiple times throughout their
lifecycle.</p>
<h5><a id="closing-all-ml-jobs"></a>Closing all anomaly detection jobs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.7/docs/en/stack/ml/anomaly-detection/stopping-ml.asciidoc">edit</a></h5>
<p>If you are upgrading your cluster, you can use the following request to close
all open anomaly detection jobs on the cluster:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _ml/anomaly_detectors/_all/_close</pre>
</div>
<div class="console_widget" data-snippet="snippets/4.console"></div>
</div>
<div class="navfooter">
<span class="prev">
<a href="ml-ad-plan.html">« Plan your anomaly detection analysis</a>
</span>
<span class="next">
<a href="ml-ad-view-results.html">View anomaly detection job results »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
