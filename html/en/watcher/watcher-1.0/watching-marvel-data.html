<!DOCTYPE html>
<html lang="en-us">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Watching Marvel Data
        | Elasticsearch Watcher [watcher-1.0]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch Watcher [watcher-1.0]" /><link rel="up" href="example-watches.html" title="Example Watches" /><link rel="prev" href="example-watches.html" title="Example Watches" /><link rel="next" href="watching-time-series-data.html" title="Watching Time Series Data" /><meta name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta name="DC.type" content="Learn/Docs/Legacy/Watcher/Reference/watcher-1.0" /><meta name="DC.subject" content="Watcher" /><meta name="DC.identifier" content="watcher-1.0" /><meta name="robots" content="noindex,nofollow" />
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <!-- DC tags section -->
    <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" >
    <link rel="schema.DCTERMS" href="http://purl.org/dc/terms/" >
    
    <!-- end DC tags -->
    <meta name="description" content="" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- For third-generation iPad with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <!-- For iPhone with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <!-- For first- and second-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- css -->
    <link href="/static/css/main.css" rel="stylesheet">
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/jquery.cookie.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script type="text/javascript">
      // -------------------- set language based on browser language --------------------
      var lang = '/'+(navigator.language || navigator.userLanguage).slice(0,2)+'/',
      locales = {
        '/en':'/',
        '/de/': '/de/',
        '/fr/': '/fr/',
        '/ja/':'/jp/',
        '/ko/':'/kr/',
        '/zh/':'/cn/',
        '/es/': '/es/'
      },
      localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}',
      currentlocale = JSON.parse(localeUrl).relative_url_prefix;

      if($.cookie("is_lang_detected") == undefined){
        if(locales[lang] != undefined && locales[lang] != currentlocale){
          locale_lang_url = locales[lang] + window.location.pathname.slice(1,window.location.pathname.length);
          $.cookie("is_lang_detected",true ,{ path: '/'});
          window.location = locale_lang_url;
        }
      }
            
      // --------------------- end of set language based on browser language -----------------
    </script>
    <link type="text/css" rel="stylesheet" href="/static/css/guide.css" />
  
<link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />

</head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- new ga for staging server -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>
    <!-- new ga for staging server -->

    <!-- Elastic APM -->
    <!--
    <script src="https://www.elastic.co/static/js/elastic-apm-js-base.umd.min.2.2.0.js"></script>
    <script type="text/javascript">
      var elasticApm = init({
        serviceName: 'elastic-co-frontend',
        serverUrl: 'https://3ddd1ee09cc242c4b169d36f5a2b8b77.apm.us-west1.gcp.cloud.es.io:443',
        stackTraceLimit: 5,
        serviceVersion: '1.0.0'
      })
    
      var pageLoadName
      var pathname = window.location.pathname.replace(/\/es|\/pt|\/jp|\/pt|\/fr|\/kr|\/cn|\/de/g, '')
      var parts = pathname.split('/');
    
      if (parts.length && parts[1] === 'blog') {
        if (parts.length === 2) {
          pageLoadName =  '/blog';
        }
        else if (parts[2] === 'category') {
          pageLoadName =  '/blog/category';
        }
        else if (parts[2] === 'archive') {
          pageLoadName =  '/blog/archive';
        }
        else {
          pageLoadName =  '/blog/detail';
        }
      }
      else if (parts.length && parts[1] === 'elasticon') {
        if (parts.length === 2) {
          pageLoadName =  '/elasticon';
        }
        else if (parts.length === 5 && (parts[2] === 'conf' || parts[2] === 'tour')) {
          pageLoadName =  '/elasticon/overview';
        }
        else if (parts.length > 5 && (parts[2] === 'conf' || parts[2] === 'tour')) {
          pageLoadName =  '/elasticon/video';
        }
      }
      else if (parts.length && parts[1] === 'guide') {
        pageLoadName =  '/guide';
      }
      else if (parts.length === 2 && parts[1] === 'videos') {
        pageLoadName =  '/videos';
      }
      else if (parts.length > 2 && parts[1] === 'videos') {
        pageLoadName =  '/videos/detail';
      }
      else if (parts.length > 2 && parts[1] === 'webinars') {
        pageLoadName =  '/webinars/detail';
      }
      else {
        pageLoadName =  window.location.pathname;
      }
    
      console.log('apm pageLoadName:', pageLoadName, parts)
      elasticApm.setTags({env:"production"});
      elasticApm.setInitialPageLoadName(pageLoadName);
    </script>
    -->

    <!-- Header Section -->
    
    <div id='elastic-nav'></div>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <link rel="stylesheet" type="text/css" href="/static/css/horizon-swiper.min.css">

    <style> 
      .m-shortcuts li a.m-search {
        background: url("/assets/blt7b9c4fe6528dc4ef/m-search-icon.png") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}

      .m-shortcuts li a.m-docs {
        background: url("/assets/blt44d8b7530a76d01c/m-guide-icon.png") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}

      .m-shortcuts li a.m-contact {
        background: url("/assets/blt878040795c9d083b/m-contact-icon.png") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}
    </style>

    <script type="text/javascript" src="/static/js/horizon-swiper.min.js"></script>

    <script type="text/javascript">
      $(document).ready( function(){
        // if($('#scrollable-pane li').length > 3){
          $('.horizon-swiper').horizonSwiper({
            showItems: 3,
            arrows: true
          }); 
        // }
        
        $('.navbar-toggle').on('click', function(){
          $('.mobile-navigation, .menu-open').hide();
          $('.navigation-wrapper').addClass('mobile-navigation');
          $('.navbar').addClass('menu-open');
          $('.menu-close').show();
        });
        $('.menu-close').on('click', function(){
          $('.navigation-wrapper').removeClass('mobile-navigation');
          $('.navbar').removeClass('menu-open');
          $('.menu-close').hide();
        });
    
        var active_url = "";
    
        $(".navbar-mobile-header-icon").click(function(index){
          $('.navigation-wrapper').toggleClass('menu-overlay');
          $(this).toggleClass("navbar-mobile-header-icon-click navbar-mobile-header-icon-out");
          $(".mobile-inner-nav").slideToggle(500);
          $(".mobile-inner-nav .navbar-nav a").each(function( index ) {
            $(this).css({'animation-delay': (index/25)+'0.4s'});
          });
        });
    
        $('.dropdown-btn').on('click', function(e){
          e.preventDefault();
          setDropdown();
        });
        
        function setDropdown() {
          $('#myDropdown').slideToggle();
        }
    
        $('body').on('click', function(event){
          if (!event.target.matches('.dropdown-btn')) {
    
            var dropdowns = $(".dropdown-content");
            var i;
            for (i = 0; i < dropdowns.length; i++) {
              var openDropdown = dropdowns[i];
              if (openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
              }
            }
          }
        });
    
      });
      $(window).resize(function () {
        $('.horizon-swiper').horizonSwiper({
          showItems: 3,
          arrows: true
        });
      });
    </script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">   

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <!-- start body -->
                
            <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
            <!-- start body -->
<div class="page_header"><<<<<<< HEAD
You are looking at documentation for an older release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
=======
From version 5.0 onward, Watcher is part of X-Pack. For more information, see 
<a href=https://www.elastic.co/guide/en/elastic-stack-overview/current/xpack-alerting.html>
    Alerting on cluster and index events</a>. 
>>>>>>> 01453a8dd3... [DOCS] Updates links in Watcher header
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch Watcher
      [watcher-1.0]
    </a></span> » <span class="breadcrumb-link"><a href="example-watches.html">Example Watches</a></span> » <span class="breadcrumb-node">Watching Marvel Data</span></div><div class="navheader"><span class="prev"><a href="example-watches.html">
              « 
              Example Watches</a>
           
        </span><span class="next">
           
          <a href="watching-time-series-data.html">Watching Time Series Data
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="watching-marvel-data"></a>Watching Marvel Data</h2></div></div></div><p>If you use Marvel to monitor your Elasticsearch deployment, you can set up
watches to take action when something out of the ordinary occurs. For example,
you could set up watches to alert on:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><a class="link" href="watching-marvel-data.html#watching-cluster-health" title="Watching Cluster Health">Cluster health changes</a></li><li class="listitem"><a class="link" href="watching-marvel-data.html#watching-memory-usage" title="Watching Memory Usage">High memory usage</a></li><li class="listitem"><a class="link" href="watching-marvel-data.html#watching-cpu-usage" title="Watching CPU Usage">High cpu usage</a></li><li class="listitem"><a class="link" href="watching-marvel-data.html#watching-open-file-descriptors" title="Watching Open File Descriptors">High file descriptor usage</a></li><li class="listitem"><a class="link" href="watching-marvel-data.html#watching-fielddata" title="Watching Field Data Utilization">High fielddata cache usage</a></li><li class="listitem"><a class="link" href="watching-marvel-data.html#watching-nodes" title="Watching for Nodes Joining or Leaving a Cluster">Nodes joining or leaving the cluster</a></li></ul></div><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>These watches query the index where your cluster’s Marvel data is stored.
If you don’t have Marvel installed, the queries won’t return any results, the conditions
evaluate to false, and no actions are performed.</p></div></div><h4><a id="watching-cluster-health"></a>Watching Cluster Health</h4><p>This watch checks the cluster health once a minute and takes action if the cluster state has
been red for the last 60 seconds:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">The watch schedule is set to execute the watch every minute.</li><li class="listitem">The watch input gets the most recent cluster status from the <code class="literal">.marvel-*</code> indices.</li><li class="listitem">The watch condition checks the cluster status to see if it’s been red for the last 60 seconds.</li><li class="listitem">The watch action is to send an email. (You could also call a <code class="literal">webhook</code> or store the event.)</li></ul></div><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">PUT _watcher/watch/cluster_red_alert
{
  "trigger": {
    "schedule": {
      "interval": "1m"
    }
  },
  "input": {
    "search": {
      "request": {
        "indices": ".marvel-*",
        "types": "cluster_stats",
        "body": {
          "query": {
            "filtered": {
              "filter": {
                "bool": {
                  "must": [
                    {
                      "range": {
                        "@timestamp": {
                          "gte": "now-2m",
                          "lte": "now"
                        }
                      }
                    }
                  ],
                  "should": [
                    {
                      "term": {
                        "status.raw": "red"
                      }
                    },
                    {
                      "term": {
                        "status.raw": "green"
                      }
                    },
                    {
                      "term": {
                        "status.raw": "yellow"
                      }
                    }
                  ]
                }
              }
            }
          },
          "fields": ["@timestamp","status"],
          "sort": [
            {
              "@timestamp": {
                "order": "desc"
              }
            }
          ],
          "size": 1,
          "aggs": {
            "minutes": {
              "date_histogram": {
                "field": "@timestamp",
                "interval": "5s"
              },
              "aggs": {
                "status": {
                  "terms": {
                    "field": "status.raw",
                    "size": 3
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "throttle_period": "30m", <a id="CO13-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
  "condition": {
    "script": {
      "inline": "if (ctx.payload.hits.total &lt; 1) return false; def rows = ctx.payload.hits.hits; if (rows[0].fields.status[0] != 'red') return false; if (ctx.payload.aggregations.minutes.buckets.size() &lt; 12) return false; def last60Seconds = ctx.payload.aggregations.minutes.buckets[-12..-1]; return last60Seconds.every { it.status.buckets.every { s -&gt; s.key == 'red' } }"
    }
  },
  "actions": {
    "send_email": { <a id="CO13-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
      "email": {
        "to": "&lt;username&gt;@&lt;domainname&gt;", <a id="CO13-3"></a><span><img src="images/icons/callouts/3.png" alt="" /></span>
        "subject": "Watcher Notification - Cluster has been RED for the last 60 seconds",
        "body": "Your cluster has been red for the last 60 seconds."
      }
    }
  }
}</pre></div><div class="sense_widget" data-snippet="snippets/10.sense"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>The throttle period prevents notifications from being sent more than once every 30 minutes.
You can change the throttle period to receive notifications more or less frequently.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>To send email notifications, you must configure at least one email account in <code class="literal">elasticsearch.yml</code>.
See <a class="link" href="email-services.html" title="Configuring Watcher to Send Email">Configuring Email Services</a> for more information.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-3"><span><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>Specify the email address you want to notify.</p></td></tr></table></div><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This example uses an inline script, which requires you to enable dynamic scripting in
      Elasticsearch. While this is convenient when you’re experimenting with Watcher, in a
      production environment we recommend disabling dynamic scripting and using file scripts.</p></div></div><h4><a id="watching-memory-usage"></a>Watching Memory Usage</h4><p>This watch runs every minute and takes action if a node in the cluster has averaged 75% or greater
heap usage for the past 60 seconds.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">The watch schedule is set to execute the watch every minute.</li><li class="listitem">The watch input gets the average <code class="literal">jvm.mem.heap_used_percent</code> for each node from the <code class="literal">.marvel-*</code> indices.</li><li class="listitem">The watch condition checks to see if any node’s average heap usage is 75% or greater.</li><li class="listitem">The watch action is to send an email. (You could also call a <code class="literal">webhook</code> or store the event.)</li></ul></div><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">PUT _watcher/watch/mem_watch
{
  "trigger": {
    "schedule": {
      "interval": "1m"
    }
  },
  "input": {
    "search": {
      "request": {
        "indices": [
          ".marvel-*"
        ],
        "search_type": "count",
        "body": {
          "query": {
            "filtered": {
              "filter": {
                "range": {
                  "@timestamp": {
                    "gte": "now-2m",
                    "lte": "now"
                  }
                }
              }
            }
          },
          "aggs": {
            "minutes": {
              "date_histogram": {
                "field": "@timestamp",
                "interval": "minute"
              },
              "aggs": {
                "nodes": {
                  "terms": {
                    "field": "node.name.raw",
                    "size": 10,
                    "order": {
                      "memory": "desc"
                    }
                  },
                  "aggs": {
                    "memory": {
                      "avg": {
                        "field": "jvm.mem.heap_used_percent"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "throttle_period": "30m", <a id="CO14-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
  "condition": {
    "script":  "if (ctx.payload.aggregations.minutes.buckets.size() == 0) return false; def latest = ctx.payload.aggregations.minutes.buckets[-1]; def node = latest.nodes.buckets[0]; return node &amp;&amp; node.memory &amp;&amp; node.memory.value &gt;= 75;"
  },
  "actions": {
    "send_email": {
      "transform": {
        "script": "def latest = ctx.payload.aggregations.minutes.buckets[-1]; return latest.nodes.buckets.findAll { return it.memory &amp;&amp; it.memory.value &gt;= 75 };"
      },
      "email": { <a id="CO14-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
        "to": "&lt;username&gt;@&lt;domainname&gt;", <a id="CO14-3"></a><span><img src="images/icons/callouts/3.png" alt="" /></span>
        "subject": "Watcher Notification - HIGH MEMORY USAGE",
        "body": "Nodes with HIGH MEMORY Usage (above 75%):\n\n{{#ctx.payload._value}}\"{{key}}\" - Memory Usage is at {{memory.value}}%\n{{/ctx.payload._value}}"
      }
    }
  }
}</pre></div><div class="sense_widget" data-snippet="snippets/11.sense"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>The throttle period prevents notifications from being sent more than once every 30 minutes.
You can change the throttle period to receive notifications more or less frequently.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>To send email notifications, you must configure at least one email account in <code class="literal">elasticsearch.yml</code>.
See <a class="link" href="email-services.html" title="Configuring Watcher to Send Email">Configuring Email Services</a> for more information.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-3"><span><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>Specify the email address you want to notify.</p></td></tr></table></div><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This example uses an inline script, which requires you to enable dynamic scripting in Elasticsearch.
      While this is convenient when you’re experimenting with Watcher, in a production
      environment we recommend disabling dynamic scripting and using file scripts.</p></div></div><h4><a id="watching-cpu-usage"></a>Watching CPU Usage</h4><p>This watch runs every minute and takes action if a node in the cluster has averaged 75% or greater CPU
usage for the past 60 seconds.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">The watch schedule is set to execute the watch every minute.</li><li class="listitem">The watch input gets the average CPU usage for each node from the <code class="literal">.marvel-*</code> indices.</li><li class="listitem">The watch condition checks to see if any node’s average CPU usage is 75% or greater.</li><li class="listitem">The watch action is to send an email. (You could also call a <code class="literal">webhook</code> or store the event.)</li></ul></div><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">PUT _watcher/watch/cpu_usage
{
  "trigger": {
    "schedule": {
      "interval": "1m"
    }
  },
  "input": {
    "search": {
      "request": {
        "indices": [
          ".marvel-*"
        ],
        "search_type": "count",
        "body": {
          "query": {
            "filtered": {
              "filter": {
                "range": {
                  "@timestamp": {
                    "gte": "now-2m",
                    "lte": "now"
                  }
                }
              }
            }
          },
          "aggs": {
            "minutes": {
              "date_histogram": {
                "field": "@timestamp",
                "interval": "minute"
              },
              "aggs": {
                "nodes": {
                  "terms": {
                    "field": "node.name.raw",
                    "size": 10,
                    "order": {
                      "cpu": "desc"
                    }
                  },
                  "aggs": {
                    "cpu": {
                      "avg": {
                        "field": "os.cpu.user"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "throttle_period": "30m", <a id="CO15-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
  "condition": {
    "script":  "if (ctx.payload.aggregations.minutes.buckets.size() == 0) return false; def latest = ctx.payload.aggregations.minutes.buckets[-1]; def node = latest.nodes.buckets[0]; return node &amp;&amp; node.cpu &amp;&amp; node.cpu.value &gt;= 75;"
  },
  "actions": {
    "send_email": { <a id="CO15-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
      "transform": {
        "script": "def latest = ctx.payload.aggregations.minutes.buckets[-1]; return latest.nodes.buckets.findAll { return it.cpu &amp;&amp; it.cpu.value &gt;= 75 };"
      },
      "email": {
        "to": "user@example.com", <a id="CO15-3"></a><span><img src="images/icons/callouts/3.png" alt="" /></span>
        "subject": "Watcher Notification - HIGH CPU USAGE",
        "body": "Nodes with HIGH CPU Usage (above 75%):\n\n{{#ctx.payload._value}}\"{{key}}\" - CPU Usage is at {{cpu.value}}%\n{{/ctx.payload._value}}"
      }
    }
  }
}</pre></div><div class="sense_widget" data-snippet="snippets/12.sense"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>The throttle period prevents notifications from being sent more than once every 30 minutes.
You can change the throttle period to receive notifications more or less frequently.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>To send email notifications, you must configure at least one email account in <code class="literal">elasticsearch.yml</code>.
See <a class="link" href="email-services.html" title="Configuring Watcher to Send Email">Configuring Email Services</a> for more information.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-3"><span><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>Specify the email address you want to notify.</p></td></tr></table></div><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This example uses an inline script, which requires you to enable dynamic scripting in Elasticsearch.
      While this is convenient when you’re experimenting with Watcher, in a production
      environment we recommend disabling dynamic scripting and using file scripts.</p></div></div><h4><a id="watching-open-file-descriptors"></a>Watching Open File Descriptors</h4><p>This watch runs once a minute and takes action if there are nodes that
are using 80% or more of the available file descriptors.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">The watch schedule is set to execute the watch every minute.</li><li class="listitem">The watch input gets the average number of open file descriptors on each node from the <code class="literal">.marvel-*</code>
indices. The input search returns the top ten nodes with the highest average number of open file
descriptors.</li><li class="listitem">The watch condition checks the cluster status to see if any node’s average number of open file
descriptors is 80% or greater.</li><li class="listitem">The watch action is to send an email. (You could also call a <code class="literal">webhook</code> or store the event.)</li></ul></div><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">PUT _watcher/watch/open_file_descriptors
{
  "metadata": {
    "system_fd": 65535,
    "threshold": 0.8
  },
  "trigger": {
    "schedule": {
      "interval": "1m"
    }
  },
  "input": {
    "search": {
      "request": {
        "indices": [
          ".marvel-*"
        ],
        "types": "node_stats",
        "search_type": "count",
        "body": {
          "query": {
            "filtered": {
              "filter": {
                "range": {
                  "@timestamp": {
                    "gte": "now-1m",
                    "lte": "now"
                  }
                }
              }
            }
          },
          "aggs": {
            "minutes": {
              "date_histogram": {
                "field": "@timestamp",
                "interval": "5s"
              },
              "aggs": {
                "nodes": {
                  "terms": {
                    "field": "node.name.raw",
                    "size": 10,
                    "order": {
                      "fd": "desc"
                    }
                  },
                  "aggs": {
                    "fd": {
                      "avg": {
                        "field": "process.open_file_descriptors"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "throttle_period": "30m", <a id="CO16-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
  "condition": {
    "script": "if (ctx.payload.aggregations.minutes.buckets.size() == 0) return false; def latest = ctx.payload.aggregations.minutes.buckets[-1]; def node = latest.nodes.buckets[0]; return node &amp;&amp; node.fd &amp;&amp; node.fd.value &gt;= (ctx.metadata.system_fd * ctx.metadata.threshold);"
  },
  "actions": {
    "send_email": { <a id="CO16-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
      "transform": {
        "script": "def latest = ctx.payload.aggregations.minutes.buckets[-1]; return latest.nodes.buckets.findAll({ return it.fd &amp;&amp; it.fd.value &gt;= (ctx.metadata.system_fd * ctx.metadata.threshold) }).collect({ it.fd.percent = Math.round((it.fd.value/ctx.metadata.system_fd)*100); it });"
      },
      "email": {
        "to": "&lt;username&gt;@&lt;domainname&gt;", <a id="CO16-3"></a><span><img src="images/icons/callouts/3.png" alt="" /></span>
        "subject": "Watcher Notification - NODES WITH 80% FILE DESCRIPTORS USED",
        "body": "Nodes with 80% FILE DESCRIPTORS USED (above 80%):\n\n{{#ctx.payload._value}}\"{{key}}\" - File Descriptors is at {{fd.value}} ({{fd.percent}}%)\n{{/ctx.payload._value}}"
      }
    }
  }
}</pre></div><div class="sense_widget" data-snippet="snippets/13.sense"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>The throttle period prevents notifications from being sent more than once a minute.
You can change the throttle period to receive notifications more or less frequently.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>To send email notifications, you must configure at least one email account in
<code class="literal">elasticsearch.yml</code>. See <a class="link" href="email-services.html" title="Configuring Watcher to Send Email">Configuring Email Services</a> for more
information.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-3"><span><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>Specify the email address you want to notify.</p></td></tr></table></div><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This example uses an inline script, which requires you to enable dynamic scripting in
      Elasticsearch. While this is convenient when you’re experimenting with Watcher, in a
      production environment we recommend disabling dynamic scripting and using file scripts.</p></div></div><h4><a id="watching-fielddata"></a>Watching Field Data Utilization</h4><p>This watch runs once a minute and takes action if there are nodes that
are using 80% or more of their field data cache.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">The watch schedule is set to execute the watch every minute.</li><li class="listitem">The watch input gets the average field data memory usage on each node from the <code class="literal">.marvel-*</code> indices.
The input search returns the top ten nodes with the highest average field data usage.</li><li class="listitem">The watch condition checks the cluster status to see if any node’s average field data usage is 80%
or more of the field data cache size.</li><li class="listitem">The watch action is to send an email. (You could also call a <code class="literal">webhook</code> or store the event.)</li></ul></div><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">PUT _watcher/watch/fielddata_utilization
{
  "metadata": {
    "fielddata_cache_size": 100000, <a id="CO17-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
    "threshold": 0.8
  },
  "trigger": {
    "schedule": {
      "interval": "1m"
    }
  },
  "input": {
    "search": {
      "request": {
        "indices": [
          ".marvel-*"
        ],
        "types": "node_stats",
        "search_type": "count",
        "body": {
          "query": {
            "filtered": {
              "filter": {
                "range": {
                  "@timestamp": {
                    "gte": "now-1m",
                    "lte": "now"
                  }
                }
              }
            }
          },
          "aggs": {
            "minutes": {
              "date_histogram": {
                "field": "@timestamp",
                "interval": "5s"
              },
              "aggs": {
                "nodes": {
                  "terms": {
                    "field": "node.name.raw",
                    "size": 10,
                    "order": {
                      "fielddata": "desc"
                    }
                  },
                  "aggs": {
                    "fielddata": {
                      "avg": {
                        "field": "indices.fielddata.memory_size_in_bytes"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "throttle_period": "30m", <a id="CO17-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
  "condition": {
    "script": "if (ctx.payload.aggregations.minutes.buckets.size() == 0) return false; def latest = ctx.payload.aggregations.minutes.buckets[-1]; def node = latest.nodes.buckets[0]; return node &amp;&amp; node.fielddata &amp;&amp; node.fielddata.value &gt;= (ctx.metadata.fielddata_cache_size * ctx.metadata.threshold);"
  },
  "actions": {
    "send_email": { <a id="CO17-3"></a><span><img src="images/icons/callouts/3.png" alt="" /></span>
      "transform": {
        "script": "def latest = ctx.payload.aggregations.minutes.buckets[-1]; return latest.nodes.buckets.findAll({ return it.fielddata &amp;&amp; it.fielddata.value &gt;= (ctx.metadata.fielddata_cache_size * ctx.metadata.threshold) }).collect({ it.fielddata.percent = Math.round((it.fielddata.value/ctx.metadata.fielddata_cache_size)*100); it });"
      },
      "email": {
        "to": "&lt;username&gt;@&lt;domainname&gt;", <a id="CO17-4"></a><span><img src="images/icons/callouts/4.png" alt="" /></span>
        "subject": "Watcher Notification - NODES WITH 80% FIELDDATA UTILIZATION",
        "body": "Nodes with 80% FIELDDATA UTILIZATION (above 80%):\n\n{{#ctx.payload._value}}\"{{key}}\" - Fielddata utilization is at {{fielddata.value}} bytes ({{fielddata.percent}}%)\n{{/ctx.payload._value}}"
      }
    }
  }
}</pre></div><div class="sense_widget" data-snippet="snippets/14.sense"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>The size of the field data cache. Set to the actual cache size configured for your nodes.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>The throttle period prevents notifications from being sent more than once a minute.
You can change the throttle period to receive notifications more or less frequently.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-3"><span><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>To send email notifications, you must configure at least one email account in
<code class="literal">elasticsearch.yml</code>. See <a class="link" href="email-services.html" title="Configuring Watcher to Send Email">Configuring Email Services</a> for more
information.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-4"><span><img src="images/icons/callouts/4.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>Specify the email address you want to notify.</p></td></tr></table></div><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This example uses an inline script, which requires you to enable dynamic scripting in
      Elasticsearch. While this is convenient when you’re experimenting with Watcher, in a
      production environment we recommend disabling dynamic scripting and using file scripts.</p></div></div><h4><a id="watching-nodes"></a>Watching for Nodes Joining or Leaving a Cluster</h4><p>This watch checks every minute to see if a node has joined or left the cluster:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">The watch schedule is set to execute the watch every minute.</li><li class="listitem">The watch input searches for <code class="literal">node_left</code> and <code class="literal">node_joined</code> events in the past 60 seconds.</li><li class="listitem">The watch condition checks to see if there are any search results in the payload. If so,
the watch actions are performed.</li><li class="listitem">The watch action is to send an email. (You could also call a <code class="literal">webhook</code> or store the event.)</li></ul></div><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">PUT _watcher/watch/node_event
{
  "trigger": {
    "schedule": {
      "interval": "60s"
    }
  },
  "input": {
    "search": {
      "request": {
        "indices": [
          ".marvel-*"
        ],
        "search_type": "query_then_fetch",
        "body": {
          "query": {
            "filtered": {
              "query": {
                "bool": {
                  "should": [
                    {
                      "match": {
                        "event": "node_left"
                      }
                    },
                    {
                      "match": {
                        "event": "node_joined"
                      }
                    }
                  ]
                }
              },
              "filter": {
                "range": {
                  "@timestamp": {
                    "from": "{{ctx.trigger.scheduled_time}}||-60s",
                    "to": "{{ctx.trigger.triggered_time}}"
                  }
                }
              }
            }
          },
          "fields": [
            "event",
            "message",
            "cluster_name"
          ],
          "sort": [
            {
              "@timestamp": {
                "order": "desc"
              }
            }
          ]
        }
      }
    }
  },
  "throttle_period": "60s", <a id="CO18-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
  "condition": {
    "script": {
      "inline": "ctx.payload.hits.size() &gt; 0 "
    }
  },
  "actions": {
    "send_email": { <a id="CO18-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
      "email": {
        "to": "&lt;username&gt;@&lt;domainname&gt;", <a id="CO18-3"></a><span><img src="images/icons/callouts/3.png" alt="" /></span>
        "subject": "{{ctx.payload.hits.hits.0.fields.event}} the cluster",
        "body": "{{ctx.payload.hits.hits.0.fields.message}} the cluster {{ctx.payload.hits.hits.0.fields.cluster_name}} "
      }
    }
  }
}</pre></div><div class="sense_widget" data-snippet="snippets/15.sense"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>The throttle period prevents notifications from being sent more than once a minute.
You can change the throttle period to receive notifications more or less frequently.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>To send email notifications, you must configure at least one email account in
<code class="literal">elasticsearch.yml</code>. See <a class="link" href="email-services.html" title="Configuring Watcher to Send Email">Configuring Email Services</a> for more
information.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-3"><span><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>Specify the email address you want to notify.</p></td></tr></table></div><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This example uses an inline script, which requires you to enable dynamic scripting in
      Elasticsearch. While this is convenient when you’re experimenting with Watcher, in a
      production environment we recommend disabling dynamic scripting and using file scripts.</p></div></div></div><div class="navfooter"><span class="prev"><a href="example-watches.html">
              « 
              Example Watches</a>
           
        </span><span class="next">
           
          <a href="watching-time-series-data.html">Watching Time Series Data
               »
            </a></span></div>
<!-- end body -->

            </div>
            <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
        
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Getting Started Videos</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Starting Elasticsearch</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Introduction to Kibana</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Starter Guide</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'</div>
<!-- Footer Section end-->

<script src='https://www.elastic.co/elastic-nav.js'></script>
<script src='https://www.elastic.co/elastic-footer.js'></script>

<style type="text/css">
	
        
            .Facebook a {background:url("/assets/bltf546ff2e0a8f2de5/facebook.svg") no-repeat;}
            .Facebook a:before {
                content: url("/assets/bltc24cf11c714ecfc4/facebook-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .Facebook a:hover {background:url("/assets/bltc24cf11c714ecfc4/facebook-hover.svg")}		
        
	
        
            .Twitter a {background:url("/assets/bltdd9556d6b24e2b85/twitter.svg") no-repeat;}
            .Twitter a:before {
                content: url("/assets/blt90b0372cc07a54d3/twitter-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .Twitter a:hover {background:url("/assets/blt90b0372cc07a54d3/twitter-hover.svg")}		
        
	
        
            .LinkedIn a {background:url("/assets/bltc4a77e0f52ce07f1/linkedin.svg") no-repeat;}
            .LinkedIn a:before {
                content: url("/assets/blt01ce654380e4ea6c/linkedin-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .LinkedIn a:hover {background:url("/assets/blt01ce654380e4ea6c/linkedin-hover.svg")}		
        
	
        
            .Xing a {background:url("/assets/bltc6347078dcc9ec76/xing.svg") no-repeat;}
            .Xing a:before {
                content: url("/assets/bltededebe5f7521a39/xing-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .Xing a:hover {background:url("/assets/bltededebe5f7521a39/xing-hover.svg")}		
        
	
        
            .YouTube a {background:url("/assets/blt4982061ce1aebc7f/youtube.svg") no-repeat;}
            .YouTube a:before {
                content: url("/assets/bltddeb6c6404ae81a5/youtube-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .YouTube a:hover {background:url("/assets/bltddeb6c6404ae81a5/youtube-hover.svg")}		
        
	
</style>

<script src="//app-lon02.marketo.com/js/forms2/js/forms2.min.js"></script>
<script>
$(document).ready(function(){

    var ipSuccess = function(data) {
        country = data.country_code;
        if (data.in_eu){
                        
            marketo_id = "6196";
            
        }else{ 
            marketo_id = "1398";

        }

        $('.subscribe-form form.sb-form').attr('id', 'mktoForm_' + marketo_id);
        if(window.MktoForms2){
            MktoForms2.loadForm("//app-lon02.marketo.com", "813-MAM-392", marketo_id,function(form){
                form.onSuccess(function(form){
                    $('#mktoForm_'+marketo_id).css('display','none');
                    $('.subscribe-wrapper .subscribe-form-container').hide();
                    $('.subscribe-wrapper').find('.form_thanks').removeClass('hide')
                    dataLayer.push({'event': 'mktoFormSubmit'});
                    return false;
                });
            });  
        }
    }

    var marketo_id;

    $.ajax({
        url: "/gdpr-data"
    }).success(function(data) {
        ipSuccess(data);
    });

})
</script>

      </section>
    </div>

    
     <script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/static/js/jquery.autocomplete.js"></script>
<script type="text/javascript" src="/static/js/slick.min.js"></script>
<script src="/static/js/nav-v5.js"></script>
<script src="/static/js/script.js"></script>

  
            <script type="text/javascript" src="/guide/static/docs.js"></script>

            </body>
        
</html>
