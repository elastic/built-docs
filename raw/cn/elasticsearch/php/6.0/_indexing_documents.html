<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>索引文档 | Elasticsearch-PHP | Elastic</title>
<link rel="home" href="index.html" title="Elasticsearch-PHP"/>
<link rel="up" href="index.html" title="Elasticsearch-PHP"/>
<link rel="prev" href="_index_management_operations.html" title="索引管理"/>
<link rel="next" href="_getting_documents.html" title="获取文档"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/PHP"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="6.0"/>
</head>
<body><div class="page_header">
You are looking at community translated documentation. See the <a href="https://www.elastic.co/guide/en/elasticsearch/client/php-api/current/index.html">current release</a> documentation in English for the most up to date content.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch-PHP</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="_index_management_operations.html">« 索引管理</a>
</span>
<span class="next">
<a href="_getting_documents.html">获取文档 »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="_indexing_documents"></a>索引文档<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elasticsearch-cn/elasticsearch-php/edit/cn/crud.asciidoc">edit</a></h1>
</div></div></div>
<p>当你要在 Elasticsearch 增加文档时，你就需要索引 JSON 文档。JSON 文档会映射 PHP 关联数组，因为 PHP 关联数组可以 encode 为 JSON 数据格式。</p>
<p>因此在 Elasticsearch-PHP 中你可以传递关联数组给客户端来索引文档。我们会概述几种方法来增加文档到 Elasticsearch。</p>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="_单一文档索引"></a>单一文档索引<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elasticsearch-cn/elasticsearch-php/edit/cn/crud.asciidoc">edit</a></h2>
</div></div></div>
<p>当索引一个文档时，你可以提供一个 ID 或者让 Elasticsearch 自动生成。</p>
<p>提供 ID 值：</p>
<div class="pre_wrapper lang-php">
<pre class="programlisting prettyprint lang-php">$params = [
    'index' =&gt; 'my_index',
    'type' =&gt; 'my_type',
    'id' =&gt; 'my_id',
    'body' =&gt; [ 'testField' =&gt; 'abc']
];

// Document will be indexed to my_index/my_type/my_id
$response = $client-&gt;index($params);</pre>
</div>
<p>不提供 ID 值：</p>
<div class="pre_wrapper lang-php">
<pre class="programlisting prettyprint lang-php">$params = [
    'index' =&gt; 'my_index',
    'type' =&gt; 'my_type',
    'body' =&gt; [ 'testField' =&gt; 'abc']
];

// Document will be indexed to my_index/my_type/&lt;autogenerated ID&gt;
$response = $client-&gt;index($params);</pre>
</div>
<p>如果你需要设置其他的参数，如 <code class="literal">routing</code> 的值，你可以指定这些参数到 <code class="literal">index</code> ,  <code class="literal">type</code> 等参数后。例如，索引一个新的文档时设置 routing 值和 timestamp 值：</p>
<div class="pre_wrapper lang-php">
<pre class="programlisting prettyprint lang-php">$params = [
    'index' =&gt; 'my_index',
    'type' =&gt; 'my_type',
    'id' =&gt; 'my_id',
    'routing' =&gt; 'company_xyz',
    'timestamp' =&gt; strtotime("-1d"),
    'body' =&gt; [ 'testField' =&gt; 'abc']
];


$response = $client-&gt;index($params);</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="_批量bulk索引"></a>批量（bulk）索引<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elasticsearch-cn/elasticsearch-php/edit/cn/crud.asciidoc">edit</a></h2>
</div></div></div>
<p>Elasticsearch 也支持批量（bulk）索引文档。bulk API 要求提供 JSON 格式的 action/元数据 键值对。在 PHP 中构建批量文档数据也是相似的。你首先要创建一个 action 数组对象（如 <code class="literal">index</code> 对象），然后你还要创建一个 body 对象。而 PHP 程序则重复上述操作构建文档数据。</p>
<p>一个简单的例子如下所示：</p>
<div class="pre_wrapper lang-php">
<pre class="programlisting prettyprint lang-php">for($i = 0; $i &lt; 100; $i++) {
    $params['body'][] = [
        'index' =&gt; [
            '_index' =&gt; 'my_index',
            '_type' =&gt; 'my_type',
        ]
    ];

    $params['body'][] = [
        'my_field' =&gt; 'my_value',
        'second_field' =&gt; 'some more values'
    ];
}

$responses = $client-&gt;bulk($params);</pre>
</div>
<p>实际上在一次 bulk 请求中发送数量会比文档实际数量少。如果是这种情况，你就要设置批量值然后周期性地发送：</p>
<div class="pre_wrapper lang-php">
<pre class="programlisting prettyprint lang-php">$params = ['body' =&gt; []];

for ($i = 1; $i &lt;= 1234567; $i++) {
    $params['body'][] = [
        'index' =&gt; [
            '_index' =&gt; 'my_index',
            '_type' =&gt; 'my_type',
            '_id' =&gt; $i
        ]
    ];

    $params['body'][] = [
        'my_field' =&gt; 'my_value',
        'second_field' =&gt; 'some more values'
    ];

    // Every 1000 documents stop and send the bulk request
    if ($i % 1000 == 0) {
        $responses = $client-&gt;bulk($params);

        // erase the old bulk request
        $params = ['body' =&gt; []];

        // unset the bulk response when you are done to save memory
        unset($responses);
    }
}

// Send the last batch if it exists
if (!empty($params['body'])) {
    $responses = $client-&gt;bulk($params);
}</pre>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="_index_management_operations.html">« 索引管理</a>
</span>
<span class="next">
<a href="_getting_documents.html">获取文档 »</a>
</span>
</div>
</div>
</body>
</html>
