<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Public API | APM .NET Agent Reference [master] | Elastic</title>
<link rel="home" href="index.html" title="APM .NET Agent Reference [master]"/>
<link rel="up" href="index.html" title="APM .NET Agent Reference [master]"/>
<link rel="prev" href="config-all-options-summary.html" title="All options summary"/>
<link rel="next" href="metrics.html" title="Metrics"/>
<meta name="DC.type" content="Learn/Docs/APM .NET Agent/Reference/master"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="master"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">APM .NET Agent Reference [master]</a></span>
»
<span class="breadcrumb-node">Public API</span>
</div>
<div class="navheader">
<span class="prev">
<a href="config-all-options-summary.html">« All options summary</a>
</span>
<span class="next">
<a href="metrics.html">Metrics »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="public-api"></a>Public API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h1>
</div></div></div>
<p>The public API of the Elastic APM .NET agent lets you
customize and manually create spans and transactions,
as well as track errors.</p>
<h2><a id="api-initialization"></a>Initialization<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h2>
<p>The API does not require explicit Agent initialization—agent initialization is optional. The <code class="literal">Elastic.Apm.Agent.IsConfigured</code> property lets you check whether the agent is already initialized.</p>
<h3><a id="implicit-initialization"></a>Implicit agent initialization<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h3>
<p>If you don&#8217;t explicitly initialize the agent, it will be started with a default component setup. This means the Agent will read <a class="xref" href="configuration.html" title="Configuration">configuration settings</a> from environment variables. If you don&#8217;t set an environment variable, the Agent will use the default value. For example, the <code class="literal">ServerUrl</code> default is <code class="literal">http://localhost:8200</code>.</p>
<p>This implicit initialization of the agent happens on the first call on the <code class="literal">Elastic.Apm.Agent</code> class.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>One exception is the <code class="literal">Elastic.Apm.Agent.IsConfigured</code> method. This method never initializes the agent, it only checks if the agent is already initialized.</p>
</div>
</div>
<p>Another example of initialization is when you enable the Agent with one of the technology-specific methods from the <a class="xref" href="setup.html" title="Set up the Agent"><em>Set up the Agent</em></a> instructions. Specifically when the <code class="literal">UseElasticApm</code> or <code class="literal">UseAllElasticApm</code> method is called in ASP.NET Core or when the IIS module is initialized in an IIS application.</p>
<p>The default agent setup should cover most of the use cases and the primary way to configure the agent is through environment variables.</p>
<h3><a id="explicit-initialization"></a>Explicit agent initialization<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h3>
<p>If you would like to replace one of the agent components, you can do so by calling the <code class="literal">Elastic.Apm.Agent.Setup(AgentComponents)</code> method.
In the AgentComponents you can pass following optional components to the agent:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">IApmLogger</code>: A logger implementation that will be used to print log messages. Default: A console logger.
</li>
<li class="listitem">
<code class="literal">IPayloadSender</code>: A component that receives all the captured events like spans, transactions, and metrics. The default implementation serializes all events and sends them to the Elastic APM Server
</li>
<li class="listitem">
<code class="literal">IConfigurationReader</code>: A component that reads <a class="xref" href="configuration.html" title="Configuration">agent configuration settings</a>. The default implementation reads configuration through environment variables.
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In the case of ASP.NET Core, when you register the agent, the <code class="literal">UseElasticApm</code> and the <code class="literal">UseAllElasticApm</code> methods both implicitly initialize the agent by calling the <code class="literal">Elastic.Apm.Agent.Setup</code> method internally. In that setup, the <code class="literal">IConfigurationReader</code> implementation will read configuration from the ASP.NET Core configuration system in case you pass an <code class="literal">IConfiguration</code> instance to the method. The <code class="literal">IApmLogger</code> instance will also log through the configured logging provider by integrating into the ASP.NET Core logging system.</p>
</div>
</div>
<h2><a id="auto-instrumentation-and-agent-api"></a>Auto instrumentation in combination with the Public Agent API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h2>
<p>With the <code class="literal">Elastic.ApmAgent.Subscribe(params IDiagnosticsSubscriber[] subscribers)</code> method you can turn on auto instrumentation for supported libraries.</p>
<p>In the case of ASP.NET Core, when you turn on the agent with the <code class="literal">UseAllElasticApm</code> method, the agent will do this automatically.</p>
<p>With a typical console application, you need to do this manually.</p>
<p><code class="literal">IDiagnosticsSubscriber</code> implementations are offered by the agent and they subscribe to diagnostic source events or other data sources in order to capture events automatically.</p>
<p>Some examples:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">HttpDiagnosticsSubscriber</code>: captures HTTP calls through <code class="literal">HttpClient</code>
</li>
<li class="listitem">
<code class="literal">EfCoreDiagnosticsSubscriber</code>: captures database calls through Entity Framework Core
</li>
<li class="listitem">
<code class="literal">SqlClientDiagnosticSubscriber</code>: captures database calls through <code class="literal">SqlClient</code>
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When the agent is configured with <a class="xref" href="config-core.html#config-enabled" title="Enabled ()"><code class="literal">Enabled</code> set to <code class="literal">false</code></a>, <code class="literal">Elastic.ApmAgent.Subscribe(params IDiagnosticsSubscriber[] subscribers)</code> will not subscribe the subscribers to
diagnostic source events.</p>
</div>
</div>
<h2><a id="api-tracer-api"></a>Tracer API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h2>
<p>The tracer gives you access to the currently active transaction and it enables you to manually start a transaction.</p>
<p>You can access the API by using the static property on the Agent: <code class="literal">Elastic.Apm.Agent.Tracer</code>.</p>
<h4><a id="api-start-transaction"></a><code class="literal">ITransaction StartTransaction(string name, string type, DistributedTracingData = null)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Use this method to create a custom transaction.</p>
<p>Note that in the case of auto-instrumentation, the agent will automatically do this for you. For example, if you have incoming HTTP calls in an ASP.NET Core application, the agent automatically starts a transaction. In these instances, this method is not needed.</p>
<p>It&#8217;s important to call <a class="xref" href="public-api.html#api-transaction-end" title="void End()"><code class="literal">void End()</code></a> when the transaction has ended.
A best practice is to use the transaction in a try-catch-finally block or to use the <a class="xref" href="public-api.html#convenient-capture-transaction" title="CaptureTransaction"><code class="literal">CaptureTransaction</code></a> method.</p>
<p>Example:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">var transaction = Elastic.Apm.Agent
        .Tracer.StartTransaction("MyTransaction", ApiConstants.TypeRequest);
try
{
    //application code that is captured as a transaction
}
catch (Exception e)
{
    transaction.CaptureException(e);
    throw;
}
finally
{
    transaction.End();
}</pre>
</div>
<h4><a id="api-current-transaction"></a><code class="literal">ITransaction CurrentTransaction</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Returns the currently active transaction.
See the <a class="xref" href="public-api.html#api-transaction" title="Transaction API">Transaction API</a> to customize the current transaction.</p>
<p>If there is no current transaction,
this method will return <code class="literal">null</code>.</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">var transaction = Elastic.Apm.Agent.Tracer.CurrentTransaction;</pre>
</div>
<h4><a id="api-current-span"></a><code class="literal">ISpan CurrentSpan</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Returns the currently active span.
See the <a class="xref" href="public-api.html#api-span" title="Span API">Span API</a> to customize the current span.</p>
<p>If there is no current span,
this method will return <code class="literal">null</code>.</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">var span = Elastic.Apm.Agent.Tracer.CurrentSpan;</pre>
</div>
<h4><a id="convenient-capture-transaction"></a><code class="literal">CaptureTransaction</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>This is a convenient method which starts and ends a transaction and captures unhandled exceptions.
It has 3 required parameters:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code>: The name of the transaction
</li>
<li class="listitem">
<code class="literal">type</code> The type of the transaction
</li>
<li class="listitem">
<p>One of the following types which references the code that you want to capture as a transaction:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">Action</code>
</li>
<li class="listitem">
<code class="literal">Action&lt;ITransaction&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;T&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;ITransaction,T&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;Task&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;ITransaction,Task&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;Task&lt;T&gt;&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;ITransaction,Task&lt;T&gt;&gt;</code>
</li>
</ul>
</div>
</li>
</ul>
</div>
<p>And an optional parameter:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">distributedTracingData</code>: A <code class="literal">DistributedTracingData</code> instance that contains the distributed tracing information in case you want the new transaction to be a part of a trace.
</li>
</ul>
</div>
<p>The following code is the equivalent of the previous example with the convenient API. It automatically starts and ends the transaction and reports unhandled exceptions. The <code class="literal">t</code> parameter gives you access to the <code class="literal">ITransaction</code> instance which represents the transaction that you just created.</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">Elastic.Apm.Agent.Tracer
        .CaptureTransaction("TestTransaction", ApiConstants.TypeRequest, (t) =&gt;
{
   //application code that is captured as a transaction
});</pre>
</div>
<p>This API also supports <code class="literal">async</code> methods with the <code class="literal">Func&lt;Task&gt;</code> overloads.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The duration of the transaction will be the timespan between the first and the last line of the <code class="literal">async</code> lambda expression.</p>
</div>
</div>
<p>Example:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">await Elastic.Apm.Agent.Tracer
        .CaptureTransaction("TestTransaction", "TestType", async () =&gt;
{
    //application code that is captured as a transaction
    await Task.Delay(500); //sample async code
});</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Return value of <a class="xref" href="public-api.html#convenient-capture-transaction" title="CaptureTransaction"><code class="literal">CaptureTransaction</code></a> method overloads that accept Task (or Task&lt;T&gt;) is the same Task (or Task&lt;T&gt;) instance as the one passed as the argument so if your application should continue only after the task completes you have to call <a class="xref" href="public-api.html#convenient-capture-transaction" title="CaptureTransaction"><code class="literal">CaptureTransaction</code></a> with <code class="literal">await</code> keyword.</p>
</div>
</div>
<h4><a id="manually-propagating-distributed-tracing-context"></a>Manually propagating distributed tracing context<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Agent automatically propagates distributed tracing context for the supported technologies (see <a class="xref" href="supported-technologies.html#supported-networking-client-side-technologies" title="Networking client-side technologies">Networking client-side technologies</a>).
If your application communicates over a protocol that is not supported by the agent
you can manually propagate distributed tracing context from the caller to the callee side using Public Agent API.</p>
<p>First you serialize distributed tracing context on the caller side:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">string outgoingDistributedTracingData =
    (Agent.Tracer.CurrentSpan?.OutgoingDistributedTracingData
        ?? Agent.Tracer.CurrentTransaction?.OutgoingDistributedTracingData)?.SerializeToString();</pre>
</div>
<p>Then you transfer the resulted string to the callee side
and you continue the trace by passing deserialized distributed tracing context to any of
<a class="xref" href="public-api.html#api-start-transaction" title="ITransaction StartTransaction(string name, string type, DistributedTracingData = null)"><code class="literal">ITransaction StartTransaction(string name, string type, DistributedTracingData = null)</code></a> or <a class="xref" href="public-api.html#convenient-capture-transaction" title="CaptureTransaction"><code class="literal">CaptureTransaction</code></a> APIs
- all of these APIs have an optional <code class="literal">DistributedTracingData</code> parameter.
For example:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">var transaction2 = Agent.Tracer.StartTransaction("Transaction2", "TestTransaction",
     DistributedTracingData.TryDeserializeFromString(serializedDistributedTracingData));</pre>
</div>
<h2><a id="api-transaction"></a>Transaction API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h2>
<p>A transaction describes an event captured by an Elastic APM agent monitoring a service. Transactions help combine multiple <a class="xref" href="public-api.html#api-span" title="Span API">Spans</a> into logical groups, and they are the first <a class="xref" href="public-api.html#api-span" title="Span API">Span</a> of a service. More information on Transactions and Spans is available in the <a href="/guide/en/apm/get-started/7.10/apm-data-model.html" class="ulink" target="_top">APM data model</a> documentation.</p>
<p>See <a class="xref" href="public-api.html#api-current-transaction" title="ITransaction CurrentTransaction"><code class="literal">ITransaction CurrentTransaction</code></a> on how to get a reference of the current transaction.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Calling any of the transaction&#8217;s methods after <a class="xref" href="public-api.html#api-transaction-end" title="void End()"><code class="literal">void End()</code></a> has been called is illegal.
You may only interact with a transaction when you have control over its lifecycle.</p>
</div>
</div>
<h4><a id="api-transaction-create-span"></a><code class="literal">ISpan StartSpan(string name, string type, string subType = null, string action = null)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Start and return a new custom span as a child of the given transaction.</p>
<p>It is important to call <a class="xref" href="public-api.html#api-span-end" title="void End()"><code class="literal">void End()</code></a> when the span has ended or to use the <a class="xref" href="public-api.html#convenient-capture-span" title="CaptureSpan"><code class="literal">CaptureSpan</code></a> method.
A best practice is to use the span in a try-catch-finally block.</p>
<p>Example:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">ISpan span = transaction.StartSpan("Select FROM customer",
     ApiConstants.TypeDb, ApiConstants.SubtypeMssql, ApiConstants.ActionQuery);
try
{
    //execute db query
}
catch(Exception e)
{
    span.CaptureException(e);
    throw;
}
finally
{
    span.End();
}</pre>
</div>
<h4><a id="api-transaction-set-label"></a><code class="literal">void SetLabel(string key, T value)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.7.0</span>]
<span class="Admonishment-detail">
Added in 1.7.0. Number and boolean labels require APM Server 6.7+
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Labels are used to add <span class="strong strong"><strong>indexed</strong></span> information to transactions, spans, and errors.
Indexed means the data is searchable and aggregatable in Elasticsearch.
Multiple labels can be defined with different key-value pairs.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Indexed: Yes
</li>
<li class="listitem">
Elasticsearch type: <a href="/guide/en/elasticsearch/reference/7.10/object.html" class="ulink" target="_top">object</a>
</li>
<li class="listitem">
Elasticsearch field: <code class="literal">labels</code> (previously <code class="literal">context.tags</code> in &lt;v.7.0)
</li>
</ul>
</div>
<p>Label values can be a string, boolean, or number.
Because labels for a given key are stored in the same place in Elasticsearch, all label values of a given key must have the same data type.
Multiple data types per key will throw an exception, e.g., <code class="literal">{"foo": "bar"}</code> and <code class="literal">{"foo": 42}</code>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Number and boolean labels were only introduced in APM Server 6.7+.
Using this API in combination with an older APM Server versions leads to validation errors.</p>
</div>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Avoid defining too many user-specified labels.
Defining too many unique fields in an index is a condition that can lead to a
<a href="/guide/en/elasticsearch/reference/7.10/mapping.html#mapping-limit-settings" class="ulink" target="_top">mapping explosion</a>.</p>
</div>
</div>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">transaction.SetLabel("stringSample", "bar");
transaction.SetLabel("boolSample", true);
transaction.SetLabel("intSample", 42);</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">String key</code>:   The tag key
</li>
<li class="listitem">
<code class="literal">String|Number|bool value</code>: The tag value
</li>
</ul>
</div>
<h4><a id="api-transaction-try-get-label"></a><code class="literal">T GetLabel&lt;T&gt;(string key, out T value)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.7.1</span>]
<span class="Admonishment-detail">
Added in 1.7.1. Number and boolean labels require APM Server 6.7+
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Returns the transaction&#8217;s label in the <code class="literal">value</code> out parameter. If the <code class="literal">key</code> does not exist, this method returns false.
Labels can be added with the <a class="xref" href="public-api.html#api-transaction-set-label" title="void SetLabel(string key, T value)">SetLabel</a> method.</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">if(transaction.TryGetLabel&lt;int&gt;("foo", our var myLabel))
    Console.WriteLine(myLabel);</pre>
</div>
<h4><a id="api-transaction-tags"></a><code class="literal">Dictionary&lt;string,string&gt; Labels</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This property is obsolete and will be be removed in a future version. Use the <a class="xref" href="public-api.html#api-transaction-set-label" title="void SetLabel(string key, T value)"><code class="literal">void SetLabel()</code></a> method instead, which allows setting labels of string, boolean and number. This property remains for now in order to not break binary compatibility, and at serialization time, the values set with <code class="literal">.SetLabel()</code> are combined with <code class="literal">Labels</code> to form the set of labels sent to APM server, with values in <code class="literal">Labels</code> taking precedence.</p>
</div>
</div>
<p>A flat mapping of user-defined labels with string values.</p>
<p>If the key contains any special characters (<code class="literal">.</code>,<code class="literal">*</code>, <code class="literal">"</code>), they will be replaced with underscores. For example <code class="literal">a.b</code> will be stored as <code class="literal">a_b</code>.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Before using custom labels, ensure you understand the different types of
<a href="/guide/en/apm/get-started/7.10/metadata.html" class="ulink" target="_top">metadata</a> that are available.</p>
</div>
</div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Avoid defining too many user-specified labels.
Defining too many unique fields in an index is a condition that can lead to a
<a href="/guide/en/elasticsearch/reference/7.10/mapping.html#mapping-limit-settings" class="ulink" target="_top">mapping explosion</a>.</p>
</div>
</div>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">Agent.Tracer
 .CaptureTransaction(TransactionName, TransactionType,
    transaction =&gt;
    {
        transaction.Labels["foo"] = "bar";
        //application code that is captured as a transaction
    });</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">key</code>:   The label key
</li>
<li class="listitem">
<code class="literal">value</code>: The label value
</li>
</ul>
</div>
<h4><a id="api-transaction-end"></a><code class="literal">void End()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Ends the transaction and schedules it to be reported to the APM Server.</p>
<p>It is illegal to call any methods on a span instance which has already ended.
This also includes this method and <a class="xref" href="public-api.html#api-transaction-create-span" title="ISpan StartSpan(string name, string type, string subType = null, string action = null)"><code class="literal">ISpan StartSpan(string name, string type, string subType = null, string action = null)</code></a>.</p>
<p>Example:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">transaction.End();</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you use the <a class="xref" href="public-api.html#convenient-capture-transaction" title="CaptureTransaction"><code class="literal">CaptureTransaction</code></a> method you must not call <a class="xref" href="public-api.html#api-transaction-end" title="void End()"><code class="literal">void End()</code></a>.</p>
</div>
</div>
<h4><a id="api-transaction-capture-exception"></a><code class="literal">void CaptureException(Exception e)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Captures an exception and reports it to the APM server.</p>
<h4><a id="api-transaction-capture-error"></a><code class="literal">void CaptureError(string message, string culprit, StackFrame[] frames)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Captures a custom error and reports it to the APM server.</p>
<p>This method is typically used when you want to report an error, but you don&#8217;t have an <code class="literal">Exception</code> instance.</p>
<h4><a id="convenient-capture-span"></a><code class="literal">CaptureSpan</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>This is a convenient method which starts and ends a span on the given transaction and captures unhandled exceptions. It has the same overloads as the <a class="xref" href="public-api.html#convenient-capture-transaction" title="CaptureTransaction"><code class="literal">CaptureTransaction</code></a> method.</p>
<p>It has 3 required parameters:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code>: The name of the span
</li>
<li class="listitem">
<code class="literal">type</code> The type of the span
</li>
<li class="listitem">
<p>One of the following types which references the code that you want to capture as a transaction:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">Action</code>
</li>
<li class="listitem">
<code class="literal">Action&lt;ITransaction&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;T&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;ITransaction,T&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;Task&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;ITransaction,Task&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;Task&lt;T&gt;&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;ITransaction,Task&lt;T&gt;&gt;</code>
</li>
</ul>
</div>
</li>
</ul>
</div>
<p>and 2 optional parameters:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">supType</code>: The subtype of the span
</li>
<li class="listitem">
<code class="literal">action</code>: The action of the span
</li>
</ul>
</div>
<p>The following code is the equivalent of the previous example from the <a class="xref" href="public-api.html#api-transaction-create-span" title="ISpan StartSpan(string name, string type, string subType = null, string action = null)"><code class="literal">ISpan StartSpan(string name, string type, string subType = null, string action = null)</code></a> section with the convenient API. It automatically starts and ends the span and reports unhandled exceptions. The <code class="literal">s</code> parameter gives you access to the <code class="literal">ISpan</code> instance which represents the span that you just created.</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">ITransaction transaction = Elastic.Apm.Agent.Tracer.CurrentTransaction;

transaction.CaptureSpan("SampleSpan", ApiConstants.TypeDb, (s) =&gt;
{
    //execute db query
}, ApiConstants.SubtypeMssql, ApiConstants.ActionQuery);</pre>
</div>
<p>Similar to the <a class="xref" href="public-api.html#convenient-capture-transaction" title="CaptureTransaction"><code class="literal">CaptureTransaction</code></a> API, this method also supports <code class="literal">async</code> methods with the <code class="literal">Func&lt;Task&gt;</code> overloads.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The duration of the span will be the timespan between the first and the last line of the <code class="literal">async</code> lambda expression.</p>
</div>
</div>
<p>This example shows you how to track an <code class="literal">async</code> code block that returns a result (<code class="literal">Task&lt;T&gt;</code>) as a span:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">ITransaction transaction = Elastic.Apm.Agent.Tracer.CurrentTransaction;
var asyncResult = await transaction.CaptureSpan("Select FROM customer", ApiConstants.TypeDb, async(s) =&gt;
{
    //application code that is captured as a span
    await Task.Delay(500); //sample async code
    return 42;
});</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Return value of <a class="xref" href="public-api.html#convenient-capture-span" title="CaptureSpan"><code class="literal">CaptureSpan</code></a> method overloads that accept Task (or Task&lt;T&gt;) is the same Task (or Task&lt;T&gt;) instance as the one passed as the argument so if your application should continue only after the task completes you have to call <a class="xref" href="public-api.html#convenient-capture-span" title="CaptureSpan"><code class="literal">CaptureSpan</code></a> with <code class="literal">await</code> keyword.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Code samples above use <code class="literal">Elastic.Apm.Agent.Tracer.CurrentTransaction</code>. In production code you should make sure the <code class="literal">CurrentTransaction</code> is not <code class="literal">null</code>.</p>
</div>
</div>
<h4><a id="api-transaction-ensure-parent-id"></a><code class="literal">EnsureParentId</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>If the transaction does not have a ParentId yet, calling this method generates a new ID, sets it as the ParentId of this transaction, and returns it as a <code class="literal">string</code>.</p>
<p>This enables the correlation of the spans the JavaScript Real User Monitoring (RUM) agent creates for the initial page load with the transaction of the backend service.</p>
<p>If your service generates the HTML page dynamically, initializing the JavaScript RUM agent with the value of this method allows analyzing the time spent in the browser vs in the backend services.</p>
<p>To enable the JavaScript RUM agent in ASP.NET Core, initialize the RUM agent with the .NET agent’s current transaction:</p>
<div class="pre_wrapper lang-JavaScript">
<pre class="programlisting prettyprint lang-JavaScript">&lt;script&gt;
	elasticApm.init({
		serviceName: 'MyService',
		serverUrl: 'http://localhost:8200',
		pageLoadTraceId: '@Elastic.Apm.Agent.Tracer.CurrentTransaction?.TraceId',
		pageLoadSpanId: '@Elastic.Apm.Agent.Tracer.CurrentTransaction?.EnsureParentId()',
		pageLoadSampled: @Json.Serialize(Elastic.Apm.Agent.Tracer?.CurrentTransaction.IsSampled)
		})
&lt;/script&gt;</pre>
</div>
<p>See the  <a href="/guide/en/apm/agent/rum-js/current" class="ulink" target="_top">JavaScript RUM agent documentation</a> for more information.</p>
<h4><a id="api-transaction-custom"></a><code class="literal">Dictionary&lt;string,string&gt; Custom</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Custom context is used to add non-indexed, custom contextual information to transactions.
Non-indexed means the data is not searchable or aggregatable in Elasticsearch, and you cannot build dashboards on top of the data.
However, non-indexed information is useful for other reasons, like providing contextual information to help you quickly debug performance issues or errors.</p>
<p>If the key contains any special characters (<code class="literal">.</code>,<code class="literal">*</code>, <code class="literal">"</code>), they will be replaced with underscores. For example <code class="literal">a.b</code> will be stored as <code class="literal">a_b</code>.</p>
<p>Unlike <a class="xref" href="public-api.html#api-transaction-tags" title="Dictionary&lt;string,string&gt; Labels"><code class="literal">Dictionary&lt;string,string&gt; Labels</code></a>, the data in this property is not trimmed.</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">Agent.Tracer.CaptureTransaction(transactionName, transactionType, (transaction) =&gt;
{
	transaction.Custom["foo"] = "bar";
	transaction.End();
});</pre>
</div>
<h4><a id="api-transaction-set-service"></a><code class="literal">void SetService(string serviceName, string serviceVersion)</code> (<span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.7</span>]
<span class="Admonishment-detail">
Added in 1.7.
</span>
</span>)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Overwrite the service name and version on a per transaction basis. This is useful when you host multiple services in a single process.</p>
<p>When not set, transactions are associated with the default service.</p>
<p>This method has two <code class="literal">string</code> parameters:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">serviceName</code>: The name of the service to associate with the transaction.
</li>
<li class="listitem">
<code class="literal">serviceVersion</code>: The version of the service to associate with the transaction.
</li>
</ul>
</div>
<p>Usage:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">var transaction = agent.Tracer.StartTransaction("Transaction1", "sample");
transaction.SetService("MyServiceName", "1.0-beta1");</pre>
</div>
<p>It can also be used with the <a class="xref" href="public-api.html#filter-api" title="Filter API ()">Filter API (<span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.5</span>]
<span class="Admonishment-detail">
Added in 1.5.
</span>
</span>)</a>:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">Agent.AddFilter( transaction =&gt;
{
	transaction.SetService("MyServiceName", "1.0-beta1");
	return transaction;
});</pre>
</div>
<h4><a id="api-transaction-context"></a><code class="literal">Context</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>You can attach additional context to manually captured transactions.</p>
<p>If you use a web framework for which agent doesn&#8217;t capture transactions automatically (see <a class="xref" href="supported-technologies.html#supported-web-frameworks" title="Web frameworks">Web frameworks</a>),
you can add context related to the captured transaction by setting various properties of transaction&#8217;s <code class="literal">Context</code> property.
For example:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">Agent.Tracer.CaptureTransaction("MyCustomTransaction",ApiConstants.TypeRequest, (transaction) =&gt;
{
  transaction.Context.Request = new Request(myRequestMethod, myRequestUri);

  // ... code executing the request

  transaction.Context.Response =
     new Response { StatusCode = myStatusCode, Finished = wasFinished };
});</pre>
</div>
<h2><a id="api-span"></a>Span API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h2>
<p>A span contains information about a specific code path, executed as part of a transaction.</p>
<p>If for example a database query happens within a recorded transaction,
a span representing this database query may be created.
In such a case, the name of the span will contain information about the query itself,
and the type will hold information about the database type.</p>
<h4><a id="api-span-create-span"></a><code class="literal">ISpan StartSpan(string name, string type, string subType = null, string action = null)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Start and return a new custom span as a child of the given span. Very similar to the <a class="xref" href="public-api.html#api-transaction-create-span" title="ISpan StartSpan(string name, string type, string subType = null, string action = null)"><code class="literal">ISpan StartSpan(string name, string type, string subType = null, string action = null)</code></a> method on <code class="literal">ITransaction</code>, but in this case the parent of the newly created span is a span itself.</p>
<p>It is important to call <a class="xref" href="public-api.html#api-span-end" title="void End()"><code class="literal">void End()</code></a> when the span has ended or to use the <a class="xref" href="public-api.html#convenient-capture-span" title="CaptureSpan"><code class="literal">CaptureSpan</code></a> method.
A best practice is to use the span in a try-catch-finally block.</p>
<p>Example:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">ISpan childSpan = parentSpan.StartSpan("Select FROM customer",
     ApiConstants.TypeDb, ApiConstants.SubtypeMssql, ApiConstants.ActionQuery);
try
{
    //execute db query
}
catch(Exception e)
{
    childSpan?.CaptureException(e);
    throw;
}
finally
{
    childSpan?.End();
}</pre>
</div>
<h4><a id="api-span-set-label"></a>`void SetLabel(string key, T value) <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.7.0</span>]
<span class="Admonishment-detail">
Added in 1.7.0. Number and boolean labels require APM Server 6.7
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>A flat mapping of user-defined labels with string, number or boolean values.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In version 6.x, labels are stored under <code class="literal">context.tags</code> in Elasticsearch.
As of version 7.x, they are stored as <code class="literal">labels</code> to comply with the <a href="https://github.com/elastic/ecs" class="ulink" target="_top">Elastic Common Schema (ECS)</a>.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The labels are indexed in Elasticsearch so that they are searchable and aggregatable.
By all means,
you should avoid that user specified data,
like URL parameters,
is used as a tag key as it can lead to mapping explosions.</p>
</div>
</div>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">span.SetLabel("stringSample", "bar");
span.SetLabel("boolSample", true);
span.SetLabel("intSample", 42);</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">String key</code>:   The tag key
</li>
<li class="listitem">
<code class="literal">String|Number|bool value</code>: The tag value
</li>
</ul>
</div>
<h4><a id="api-span-try-get-label"></a><code class="literal">T GetLabel&lt;T&gt;(string key, out T value)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.7.1</span>]
<span class="Admonishment-detail">
Added in 1.7.1. Number and boolean labels require APM Server 6.7+
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Returns the span&#8217;s label in the <code class="literal">value</code> out parameter. If the <code class="literal">key</code> does not exist, this method returns false.
Labels can be added with the <a class="xref" href="public-api.html#api-span-set-label" title="`void SetLabel(string key, T value)">SetLabel</a> method.</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">if(span.TryGetLabel&lt;bool&gt;("foo", out var myLabel))
    Console.WriteLine(myLabel);</pre>
</div>
<h4><a id="api-span-tags"></a><code class="literal">Dictionary&lt;string,string&gt; Labels</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This property is obsolete and will be be removed in a future version. Use the <a class="xref" href="public-api.html#api-span-set-label" title="`void SetLabel(string key, T value)"><code class="literal">void SetLabel()</code></a> method instead, which allows setting labels of string, boolean and number. This property remains for now in order to not break binary compatibility, and at serialization time, the values set with <code class="literal">.SetLabel()</code> are combined with <code class="literal">Labels</code> to form the set of labels sent to APM server, with values in <code class="literal">Labels</code> taking precedence.</p>
</div>
</div>
<p>Similar to <a class="xref" href="public-api.html#api-transaction-tags" title="Dictionary&lt;string,string&gt; Labels"><code class="literal">Dictionary&lt;string,string&gt; Labels</code></a> on the <a class="xref" href="public-api.html#api-transaction" title="Transaction API">Transaction API</a>: A flat mapping of user-defined labels with string values.</p>
<p>If the key contains any special characters (<code class="literal">.</code>,<code class="literal">*</code>, <code class="literal">"</code>), they will be replaced with underscores. For example <code class="literal">a.b</code> will be stored as <code class="literal">a_b</code>.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Before using custom labels, ensure you understand the different types of
<a href="/guide/en/apm/get-started/7.10/metadata.html" class="ulink" target="_top">metadata</a> that are available.</p>
</div>
</div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Avoid defining too many user-specified labels.
Defining too many unique fields in an index is a condition that can lead to a
<a href="/guide/en/elasticsearch/reference/7.10/mapping.html#mapping-limit-settings" class="ulink" target="_top">mapping explosion</a>.</p>
</div>
</div>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">transaction.CaptureSpan(SpanName, SpanType,
span =&gt;
    {
        span.Labels["foo"] = "bar";
        //application code that is captured as a span
    });</pre>
</div>
<h4><a id="api-span-capture-exception"></a><code class="literal">void CaptureException(Exception e)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Captures an exception and reports it to the APM server.</p>
<h4><a id="api-span-capture-error"></a><code class="literal">void CaptureError(string message, string culprit, StackFrame[] frames)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Captures a custom error and reports it to the APM server.</p>
<p>This method is typically used when you want to report an error, but you don&#8217;t have an <code class="literal">Exception</code> instance.</p>
<h4><a id="api-span-end"></a><code class="literal">void End()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>Ends the span and schedules it to be reported to the APM Server.</p>
<p>It is illegal to call any methods on a span instance which has already ended.</p>
<h4><a id="api-span-context"></a><code class="literal">Context</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>You can attach additional context to manually captured spans.</p>
<p>If you use a database library for which agent doesn&#8217;t capture spans automatically (see <a class="xref" href="supported-technologies.html#supported-data-access-technologies" title="Data access technologies">Data access technologies</a>),
you can add context related to the captured database operation by setting span&#8217;s <code class="literal">Context.Db</code> property.
For example:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">Agent.Tracer.CurrentTransaction.CaptureSpan("MyDbWrite", ApiConstants.TypeDb, (span) =&gt;
{
    span.Context.Db = new Database
        { Statement = myDbStatement, Type = myDbType, Instance = myDbInstance };

    // ... code executing the database operation
});</pre>
</div>
<p>If you use an HTTP library for which agent doesn&#8217;t capture spans automatically (see <a class="xref" href="supported-technologies.html#supported-networking-client-side-technologies" title="Networking client-side technologies">Networking client-side technologies</a>),
you can add context related to the captured HTTP operation by setting span&#8217;s <code class="literal">Context.Http</code> property.
For example:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">Agent.Tracer.CurrentTransaction.CaptureSpan("MyHttpOperation", ApiConstants.TypeExternal, (span) =&gt;
{
    span.Context.Http = new Http
        { Url = myUrl, Method = myMethod };

    // ... code executing the HTTP operation

    span.Context.Http.StatusCode = myStatusCode;
});</pre>
</div>
<h4><a id="convenient-span-capture-span"></a><code class="literal">CaptureSpan</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h4>
<p>This is a convenient method which starts and ends a child span on the given span and captures unhandled exceptions.</p>
<p>Very similar to the <a class="xref" href="public-api.html#convenient-capture-span" title="CaptureSpan"><code class="literal">CaptureSpan</code></a> method on <code class="literal">ITransaction</code>, but in this case the parent of the newly created span is a span itself.</p>
<p>It has 3 required parameters:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code>: The name of the span
</li>
<li class="listitem">
<code class="literal">type</code> The type of the span
</li>
<li class="listitem">
<p>One of the following types which references the code that you want to capture as a transaction:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">Action</code>
</li>
<li class="listitem">
<code class="literal">Action&lt;ITransaction&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;T&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;ITransaction,T&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;Task&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;ITransaction,Task&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;Task&lt;T&gt;&gt;</code>
</li>
<li class="listitem">
<code class="literal">Func&lt;ITransaction,Task&lt;T&gt;&gt;</code>
</li>
</ul>
</div>
</li>
</ul>
</div>
<p>and 2 optional parameters:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">supType</code>: The subtype of the span
</li>
<li class="listitem">
<code class="literal">action</code>: The action of the span
</li>
</ul>
</div>
<p>The following code is the equivalent of the previous example from the <a class="xref" href="public-api.html#api-span-create-span" title="ISpan StartSpan(string name, string type, string subType = null, string action = null)"><code class="literal">ISpan StartSpan(string name, string type, string subType = null, string action = null)</code></a> section with the convenient API. It automatically starts and ends the span and reports unhandled exceptions. The <code class="literal">s</code> parameter gives you access to the <code class="literal">ISpan</code> instance which represents the span that you just created.</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">span.CaptureSpan("SampleSpan", ApiConstants.TypeDb, (s) =&gt;
{
    //execute db query
}, ApiConstants.SubtypeMssql, ApiConstants.ActionQuery);</pre>
</div>
<p>Similar to the <a class="xref" href="public-api.html#convenient-capture-transaction" title="CaptureTransaction"><code class="literal">CaptureTransaction</code></a> API, this method also supports <code class="literal">async</code> methods with the <code class="literal">Func&lt;Task&gt;</code> overloads.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The duration of the span will be the timespan between the first and the last line of the <code class="literal">async</code> lambda expression.</p>
</div>
</div>
<p>This example shows you how to track an <code class="literal">async</code> code block that returns a result (<code class="literal">Task&lt;T&gt;</code>) as a span:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">var asyncResult = await span.CaptureSpan("Select FROM customer", ApiConstants.TypeDb, async(s) =&gt;
{
    //application code that is captured as a span
    await Task.Delay(500); //sample async code
    return 42;
});</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Return value of <a class="xref" href="public-api.html#convenient-capture-span" title="CaptureSpan"><code class="literal">CaptureSpan</code></a> method overloads that accept Task (or Task&lt;T&gt;) is the same Task (or Task&lt;T&gt;) instance as the one passed as the argument so if your application should continue only after the task completes you have to call <a class="xref" href="public-api.html#convenient-capture-span" title="CaptureSpan"><code class="literal">CaptureSpan</code></a> with <code class="literal">await</code> keyword.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Code samples above use <code class="literal">Elastic.Apm.Agent.Tracer.CurrentTransaction</code>. In production code you should make sure the <code class="literal">CurrentTransaction</code> is not <code class="literal">null</code>.</p>
</div>
</div>
<h2><a id="filter-api"></a>Filter API (<span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.5</span>]
<span class="Admonishment-detail">
Added in 1.5.
</span>
</span>)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/master/docs/public-api.asciidoc">edit</a></h2>
<p>Use <code class="literal">Agent.AddFilter(filter)</code> to supply a filter callback.</p>
<p>Each filter callback will be called just before data is sent to the APM Server. This allows you to manipulate the data being sent, like to remove sensitive information such as passwords.</p>
<p>Each filter callback is called in the order they are added and will receive a payload object containing the data about to be sent to the APM Server as the only argument.</p>
<p>The filter callback is synchronous and should return the manipulated payload object. If a filter callback doesn’t return any value or returns a falsy value, the remaining filter callback will not be called and the payload will not be sent to the APM Server.</p>
<p>There are 3 overloads of the <code class="literal">Agent.AddFilter</code> method with the following arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">Func&lt;ITransaction, ITransaction&gt;</code>: A filter called for every transaction.
</li>
<li class="listitem">
<code class="literal">Func&lt;ISpan, ISpan&gt;</code>: A filter called for every span.
</li>
<li class="listitem">
<code class="literal">Func&lt;IError, IError&gt;</code>: A filter called for every error.
</li>
</ul>
</div>
<p>Below are some usage examples of the Agent.AddFilter method.</p>
<p>Drop all spans for a specific database:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">Agent.AddFilter((ISpan span) =&gt;
{
	if (span.Context?.Db?.Instance == "VerySecretDb")
		return null;
	return span;
});</pre>
</div>
<p>Hide some data:</p>
<div class="pre_wrapper lang-csharp">
<pre class="programlisting prettyprint lang-csharp">Agent.AddFilter((ITransaction transaction) =&gt;
{
	transaction.Context.Request.Url.Protocol = "[HIDDEN]";
	return transaction;
});</pre>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="config-all-options-summary.html">« All options summary</a>
</span>
<span class="next">
<a href="metrics.html">Metrics »</a>
</span>
</div>
</div>
</body>
</html>
