<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>.NET Core and .NET 5+ | APM .NET Agent Reference [master] | Elastic</title>
<meta class="elastic" name="content" content=".NET Core and .NET 5+ | APM .NET Agent Reference [master]">

<link rel="home" href="index.html" title="APM .NET Agent Reference [master]"/>
<link rel="up" href="setup.html" title="Set up the Agent"/>
<link rel="prev" href="setup-asp-net-core.html" title="ASP.NET Core"/>
<link rel="next" href="setup-asp-dot-net.html" title="ASP.NET"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="APM"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/APM .NET Agent/Reference/master"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="setup-asp-net-core.html">« ASP.NET Core</a>
</span>
<span class="next">
<a href="setup-asp-dot-net.html">ASP.NET »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link">
  <div id="related-products" class="dropdown">
  <div class="related-products-title">APM:</div>
  <div class="dropdown-anchor" tabindex="0">.NET Agent Reference<span class="dropdown-icon"></span></div>
  <div class="dropdown-content">
  <ul>
  <li class="dropdown-category">APM</li>
  <ul>
  <li><a href="/guide/en/observability/current/apm.html">Observability › APM</a></li>
  </ul>
  <li class="dropdown-category">APM agents</li>
  <ul>
  <li><a href="/guide/en/apm/agent/android/current/intro.html">Android Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/go/current/introduction.html">Go Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/swift/current/intro.html">iOS Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/java/current/intro.html">Java Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/dotnet/current/intro.html">.NET Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/nodejs/current/intro.html">Node.js Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/php/current/intro.html">PHP Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/python/current/getting-started.html">Python Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/ruby/current/introduction.html">Ruby Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/rum-js/current/intro.html">Real User Monitoring JavaScript Agent Reference</a></li>
  </ul>
  <li class="dropdown-category">APM extensions</li>
  <ul>
  <li><a href="/guide/en/apm/lambda/current/aws-lambda-arch.html">AWS Lambda extension</a></li>
  <li><a href="/guide/en/apm/attacher/current/apm-attacher.html">Attacher</a></li>
  </ul>
  </ul>
  </div>
  </div>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="setup.html">Set up the Agent</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>.NET Core and .NET 5+</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/main/docs/setup-dotnet-net-core.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="setup-dotnet-net-core"></a>.NET Core and .NET 5+<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/main/docs/setup-dotnet-net-core.asciidoc">edit</a></h2>
</div></div></div>
<h4><a id="_quick_start_3"></a>Quick start<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/main/docs/setup-dotnet-net-core.asciidoc">edit</a></h4>
<p>In .NET (Core) applications using <code class="literal">Microsoft.Extensions.Hosting</code>, the agent can be registered on the <code class="literal">IServiceCollection</code>. This applies to ASP.NET Core and to other .NET applications that depend on the hosting APIs, such as those created using the <a href="https://learn.microsoft.com/en-us/dotnet/core/extensions/workers" class="ulink" target="_top">worker services</a> template.</p>
<p>The simplest way to enable the agent and its instrumentations requires a reference to the <a href="https://www.nuget.org/packages/Elastic.Apm.NetCoreAll" class="ulink" target="_top"><code class="literal">Elastic.Apm.NetCoreAll</code></a> package.</p>
<div class="pre_wrapper lang-xml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-xml">&lt;PackageReference Include="Elastic.Apm.NetCoreAll" Version="&lt;LATEST&gt;" /&gt; <a id="CO10-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO10-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Replace the <code class="literal">&lt;LATEST&gt;</code> placeholder with the latest version of the agent available on NuGet.</p>
</td>
</tr>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The following code sample assumes the instrumentation of a .NET 8 worker service, using <a href="https://learn.microsoft.com/en-us/dotnet/csharp/tutorials/top-level-statements" class="ulink" target="_top">top-level statements</a>.</p>
</div>
</div>
<p><span class="strong strong"><strong>Program.cs</strong></span></p>
<div class="pre_wrapper lang-csharp">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-csharp">using WorkerServiceSample;

var builder = Host.CreateApplicationBuilder(args);

builder.Services.AddHttpClient();
builder.Services.AddAllElasticApm(); <a id="CO11-1"></a><i class="conum" data-value="1"></i>
builder.Services.AddHostedService&lt;Worker&gt;();

var host = builder.Build();
host.Run();</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO11-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Register Elastic APM before registering other IHostedServices to ensure its dependencies are initialized first.</p>
</td>
</tr>
</table>
</div>
<p>When registering services with <code class="literal">AddAllElasticApm()</code>, an APM agent with all instrumentations is enabled. On ASP.NET Core, it&#8217;ll automatically capture incoming requests, database calls through supported technologies, outgoing HTTP requests, etc.</p>
<p>For other application templates, such as worker services, you must manually instrument your <code class="literal">BackgroundService</code> to identify one or more units of work that should be captured.</p>
<h4><a id="_manual_instrumentation_using_itracer"></a>Manual instrumentation using <code class="literal">ITracer</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/main/docs/setup-dotnet-net-core.asciidoc">edit</a></h4>
<p><code class="literal">AddAllElasticApm</code> adds an <code class="literal">ITracer</code> to the Dependency Injection system, which can be used in your code to manually instrument your application, using the <a class="xref" href="public-api.html" title="Public API"><em>Public API</em></a></p>
<p><span class="strong strong"><strong>Worker.cs</strong></span></p>
<div class="pre_wrapper lang-csharp">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-csharp">using Elastic.Apm.Api;

namespace WorkerServiceSample
{
  public class Worker : BackgroundService
  {
    private readonly IHttpClientFactory _httpClientFactory;
    private readonly ITracer _tracer;

    public Worker(IHttpClientFactory httpClientFactory, ITracer tracer)
    {
      _httpClientFactory = httpClientFactory;
      _tracer = tracer;
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
      while (!stoppingToken.IsCancellationRequested)
      {
        await _tracer.CaptureTransaction("UnitOfWork", ApiConstants.TypeApp, async () =&gt; <a id="CO12-1"></a><i class="conum" data-value="1"></i>
        {
          var client = _httpClientFactory.CreateClient();
          await client.GetAsync("https://www.elastic.co", stoppingToken);
          await Task.Delay(5000, stoppingToken);
        });
      }
    }
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO12-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">CaptureTransaction</code> method creates a transaction named <em>UnitOfWork</em> and type <em>App</em>. The lambda passed to it represents the unit of work that should be captured within the context of the transaction.</p>
</td>
</tr>
</table>
</div>
<p>When this application runs, a new transaction will be captured and sent for each while loop iteration. A span named <em>HTTP GET</em> within the transaction will be created for the HTTP request to <code class="literal">https://www.elastic.co</code>. The HTTP span is captured because the NetCoreAll package enables this instrumentation automatically.</p>
<h4><a id="_manual_instrumentation_using_opentelemetry"></a>Manual instrumentation using OpenTelemetry<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/main/docs/setup-dotnet-net-core.asciidoc">edit</a></h4>
<p>As an alternative to using the Elastic APM API by injecting an <code class="literal">ITracer</code>, you can use the OpenTelemetry API to manually instrument your application. The Elastic APM agent automatically bridges instrumentations created using the OpenTelemetry API, so you can use it to create spans and transactions. In .NET, the <a href="https://learn.microsoft.com/en-us/dotnet/core/diagnostics/distributed-tracing-instrumentation-walkthroughs" class="ulink" target="_top"><code class="literal">Activity</code> API</a> can be used to instrument applications.</p>
<p>In the case of this sample worker service, we can update the code to prefer the OpenTelemetry API.</p>
<p><span class="strong strong"><strong>Worker.cs</strong></span></p>
<div class="pre_wrapper lang-csharp">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-csharp">using System.Diagnostics;

namespace WorkerServiceSample
{
  public class Worker : BackgroundService
  {
    private readonly IHttpClientFactory _httpClientFactory;
    private static readonly ActivitySource ActivitySource = new("MyActivitySource"); <a id="CO13-1"></a><i class="conum" data-value="1"></i>

    public Worker(IHttpClientFactory httpClientFactory)
    {
      _httpClientFactory = httpClientFactory;
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
      while (!stoppingToken.IsCancellationRequested)
      {
        using var activity = ActivitySource.StartActivity("UnitOfWork"); <a id="CO13-2"></a><i class="conum" data-value="2"></i>
        var client = _httpClientFactory.CreateClient();
        await client.GetAsync("https://www.elastic.co", stoppingToken);
        await Task.Delay(5000, stoppingToken);
      }
    }
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO13-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Defines an <code class="literal">ActivitySource</code> for this application from which activities can be created.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO13-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Starts an <code class="literal">Activity</code> with the name <code class="literal">UnitOfWork</code>. As this is <code class="literal">IDisposable</code>, it will automatically end when each iteration of the  <code class="literal">while</code> block ends.</p>
</td>
</tr>
</table>
</div>
<h4><a id="_instrumentation_modules"></a>Instrumentation modules<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/main/docs/setup-dotnet-net-core.asciidoc">edit</a></h4>
<p>The <code class="literal">Elastic.Apm.NetCoreAll</code> package references every agent component that can be automatically configured. This is usually not a problem, but if you want to keep dependencies minimal, you can instead reference the <code class="literal">Elastic.Apm.Extensions.Hosting</code> package and register services with <code class="literal">AddElasticApm</code> method, instead of <code class="literal">AddAllElasticApm</code>. With this setup you can explicitly control what the agent will listen for.</p>
<p>The following example only turns on outgoing HTTP monitoring (so, for instance, database and Elasticsearch calls won&#8217;t be automatically captured):</p>
<div class="pre_wrapper lang-csharp">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-csharp">using Elastic.Apm.DiagnosticSource;
using WorkerServiceSample;

var builder = Host.CreateApplicationBuilder(args);

builder.Services.AddHttpClient();
builder.Services.AddElasticApm(new HttpDiagnosticsSubscriber()); <a id="CO14-1"></a><i class="conum" data-value="1"></i>
builder.Services.AddHostedService&lt;Worker&gt;();

var host = builder.Build();
host.Run();</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO14-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">HttpDiagnosticsSubscriber</code> is a diagnostic listener that captures spans for outgoing HTTP requests.</p>
</td>
</tr>
</table>
</div>
<h4><a id="zero-code-change-setup"></a>Zero code change setup on .NET Core and .NET 5+ (<span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.7</span>]
<span class="Admonishment-detail">
Added in 1.7.
</span>
</span>)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-dotnet/edit/main/docs/setup-dotnet-net-core.asciidoc">edit</a></h4>
<p>If you can&#8217;t or don&#8217;t want to reference NuGet packages in your application, you can use the startup hook feature to inject the agent during startup, if your application runs on .NET Core 3.0, .NET Core 3.1 or .NET 5 or newer.</p>
<p>To configure startup hooks</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Download the <code class="literal">ElasticApmAgent_&lt;version&gt;.zip</code> file from the <a href="https://github.com/elastic/apm-agent-dotnet/releases" class="ulink" target="_top">Releases</a> page of the .NET APM Agent GitHub repository. You can find the file under Assets.
</li>
<li class="listitem">
Unzip the zip file into a folder.
</li>
<li class="listitem">
<p>Set the <code class="literal">DOTNET_STARTUP_HOOKS</code> environment variable to point to the <code class="literal">ElasticApmAgentStartupHook.dll</code> file in the unzipped folder</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">set DOTNET_STARTUP_HOOKS=&lt;path-to-agent&gt;\ElasticApmAgentStartupHook.dll <a id="CO15-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO15-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">&lt;path-to-agent&gt;</code> is the unzipped directory from step 2.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
Start your .NET Core application in a context where the <code class="literal">DOTNET_STARTUP_HOOKS</code> environment variable is visible.
</li>
</ol>
</div>
<p>With this setup, the agent will be injected into the application during startup, enabling every instrumentation feature. Incoming requests will be automatically captured on ASP.NET Core (including gRPC).</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Agent configuration can be controlled through environment variables when using the startup hook feature.</p>
</div>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="setup-asp-net-core.html">« ASP.NET Core</a>
</span>
<span class="next">
<a href="setup-asp-dot-net.html">ASP.NET »</a>
</span>
</div>
</body>
</html>
