<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Public API | APM Java Agent Reference [1.x] | Elastic</title>
<link rel="home" href="index.html" title="APM Java Agent Reference [1.x]"/>
<link rel="up" href="index.html" title="APM Java Agent Reference [1.x]"/>
<link rel="prev" href="config-reference-properties-file.html" title="Property file reference"/>
<link rel="next" href="metrics.html" title="Metrics"/>
<meta name="DC.type" content="Learn/Docs/APM Java Agent/Reference/1.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="1.x"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">APM Java Agent Reference [1.x]</a></span>
»
<span class="breadcrumb-node">Public API</span>
</div>
<div class="navheader">
<span class="prev">
<a href="config-reference-properties-file.html">« Property file reference</a>
</span>
<span class="next">
<a href="metrics.html">Metrics »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="public-api"></a>Public API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h1>
</div></div></div>
<p>The public API of the Elastic APM Java agent lets you
customize and manually create spans and transactions,
as well as track errors.</p>
<p>The first step in getting started with the API is to declare a dependency to the API:</p>
<p><strong>pom.xml.</strong></p>
<div class="pre_wrapper lang-xml">
<pre class="programlisting prettyprint lang-xml">&lt;dependency&gt;
    &lt;groupId&gt;co.elastic.apm&lt;/groupId&gt;
    &lt;artifactId&gt;apm-agent-api&lt;/artifactId&gt;
    &lt;version&gt;${elastic-apm.version}&lt;/version&gt;
&lt;/dependency&gt;</pre>
</div>
<p><strong>build.gradle.</strong></p>
<div class="pre_wrapper lang-groovy">
<pre class="programlisting prettyprint lang-groovy">compile "co.elastic.apm:apm-agent-api:$elasticApmVersion"</pre>
</div>
<p>Replace the version placeholders with the
<a href="https://search.maven.org/search?q=g:co.elastic.apm%20AND%20a:apm-agent-api" class="ulink" target="_top">
latest version from maven central</a>:
<span class="image"><img src="https://img.shields.io/maven-central/v/co.elastic.apm/apm-agent-api.svg" alt="Maven Central"></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="public-api.html#api-tracer-api" title="Tracer API">Tracer API</a> - Access the currently active transaction and span
</li>
<li class="listitem">
<a class="xref" href="public-api.html#api-annotation" title="Annotation API">Annotation API</a> - Annotations that make easier to create custom spans and transactions
</li>
<li class="listitem">
<a class="xref" href="public-api.html#api-transaction" title="Transaction API">Transaction API</a> - Transaction methods
</li>
<li class="listitem">
<a class="xref" href="public-api.html#api-span" title="Span API">Span API</a> - Span methods
</li>
</ul>
</div>
<h3><a id="api-tracer-api"></a>Tracer API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h3>
<p>The tracer gives you access to the currently active transaction and span.
It can also be used to track an exception.</p>
<p>To use the API, you can just invoke the static methods on the class <code class="literal">co.elastic.apm.api.ElasticApm</code>.</p>
<h4><a id="api-current-transaction"></a><code class="literal">Transaction currentTransaction()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Returns the currently active transaction.
See <a class="xref" href="public-api.html#api-transaction" title="Transaction API">Transaction API</a> on how to customize the current transaction.</p>
<p>If there is no current transaction,
this method will return a noop transaction,
which means that you never have to check for <code class="literal">null</code> values.</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">import co.elastic.apm.api.ElasticApm;
import co.elastic.apm.api.Transaction;

Transaction transaction = ElasticApm.currentTransaction();</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Transactions created via <a class="xref" href="public-api.html#api-start-transaction" title="Transaction startTransaction()"><code class="literal">ElasticApm.startTransaction()</code></a>
can not be retrieved by calling this method.
See <a class="xref" href="public-api.html#api-span-activate" title="Scope activate()"><code class="literal">span.activate()</code></a> on how to achieve that.</p>
</div>
</div>
<h4><a id="api-current-span"></a><code class="literal">Span currentSpan()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Returns the currently active span or transaction.
See <a class="xref" href="public-api.html#api-span" title="Span API">Span API</a> on how to customize the current span.</p>
<p>If there is no current span,
this method will return a noop span,
which means that you never have to check for <code class="literal">null</code> values.</p>
<p>Note that even if this method is returning a noop span,
you can still <a class="xref" href="public-api.html#api-span-capture-exception" title="String captureException(Exception e)">capture exceptions</a> on it.
These exceptions will not have a link to a Span or a Transaction.</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">import co.elastic.apm.api.ElasticApm;
import co.elastic.apm.api.Span;

Span span = ElasticApm.currentSpan();</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Spans created via <a class="xref" href="public-api.html#api-span-start-span" title="Span startSpan()"><code class="literal">startSpan()</code></a> or <a class="xref" href="public-api.html#api-span-start-span-with-type" title="Span startSpan(String type, String subtype, String action)"><code class="literal">startSpan(String, String, String)</code></a>
can not be retrieved by calling this method.
See <a class="xref" href="public-api.html#api-span-activate" title="Scope activate()"><code class="literal">span.activate()</code></a> on how to achieve that.</p>
</div>
</div>
<h4><a id="api-start-transaction"></a><code class="literal">Transaction startTransaction()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Use this method to create a custom transaction.</p>
<p>Note that the agent will do this for you automatically when ever your application receives an incoming HTTP request.
You only need to use this method to create custom transactions.</p>
<p>It is important to call <a class="xref" href="public-api.html#api-transaction-end" title="void end()"><code class="literal">void end()</code></a> when the transaction has ended.
A best practice is to use the transaction in a try-catch-finally block.
Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">Transaction transaction = ElasticApm.startTransaction();
try {
    transaction.setName("MyController#myAction");
    transaction.setType(Transaction.TYPE_REQUEST);
    // do your thing...
} catch (Exception e) {
    transaction.captureException(e);
    throw e;
} finally {
    transaction.end();
}</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Transactions created via this method can not be retrieved by calling <a class="xref" href="public-api.html#api-current-span" title="Span currentSpan()"><code class="literal">ElasticApm.currentSpan()</code></a>
or <a class="xref" href="public-api.html#api-current-transaction" title="Transaction currentTransaction()"><code class="literal">ElasticApm.currentTransaction()</code></a>.
See <a class="xref" href="public-api.html#api-transaction-activate" title="Scope activate()"><code class="literal">transaction.activate()</code></a> on how to achieve that.</p>
</div>
</div>
<h4><a id="api-start-transaction-with-remote-parent-header"></a><code class="literal">Transaction startTransactionWithRemoteParent(HeaderExtractor)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.3.0</span>]
<span class="Admonishment-detail">
Added in 1.3.0.
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Similar to <a class="xref" href="public-api.html#api-start-transaction" title="Transaction startTransaction()"><code class="literal">Transaction startTransaction()</code></a> but creates this transaction as the child of a remote parent.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">headerExtractor</code>: a functional interface which receives a header name and returns the first header with that name
</li>
</ul>
</div>
<p>Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">// Hook into a callback provided by the framework that is called on incoming requests
public Response onIncomingRequest(Request request) throws Exception {
    // creates a transaction representing the server-side handling of the request
    Transaction transaction = ElasticApm.startTransactionWithRemoteParent(key -&gt; request.getHeader(key));
    try (final Scope scope = transaction.activate()) {
        String name = "a useful name like ClassName#methodName where the request is handled";
        transaction.setName(name);
        transaction.setType(Transaction.TYPE_REQUEST);
        return request.handle();
    } catch (Exception e) {
        transaction.captureException(e);
        throw e;
    } finally {
        transaction.end();
    }
}</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If the protocol supports multi-value headers, use <a class="xref" href="public-api.html#api-start-transaction-with-remote-parent-headers" title="Transaction startTransactionWithRemoteParent(HeaderExtractor, HeadersExtractor)"><code class="literal">Transaction startTransactionWithRemoteParent(HeaderExtractor, HeadersExtractor)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.3.0</span>]
<span class="Admonishment-detail">
Added in 1.3.0.
</span>
</span></a></p>
</div>
</div>
<h4><a id="api-start-transaction-with-remote-parent-headers"></a><code class="literal">Transaction startTransactionWithRemoteParent(HeaderExtractor, HeadersExtractor)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.3.0</span>]
<span class="Admonishment-detail">
Added in 1.3.0.
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Similar to <a class="xref" href="public-api.html#api-start-transaction" title="Transaction startTransaction()"><code class="literal">Transaction startTransaction()</code></a> but creates this transaction as the child of a remote parent.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">headerExtractor</code>:  a functional interface which receives a header name and returns the first header with that name
</li>
<li class="listitem">
<code class="literal">headersExtractor</code>: a functional interface which receives a header name and returns all headers with that name
</li>
</ul>
</div>
<p>Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">// Hook into a callback provided by the framework that is called on incoming requests
public Response onIncomingRequest(Request request) throws Exception {
    // creates a transaction representing the server-side handling of the request
    Transaction transaction = ElasticApm.startTransactionWithRemoteParent(request::getHeader, request::getHeaders);
    try (final Scope scope = transaction.activate()) {
        String name = "a useful name like ClassName#methodName where the request is handled";
        transaction.setName(name);
        transaction.setType(Transaction.TYPE_REQUEST);
        return request.handle();
    } catch (Exception e) {
        transaction.captureException(e);
        throw e;
    } finally {
        transaction.end();
    }
}</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If the protocol does not support multi-value headers, use <a class="xref" href="public-api.html#api-start-transaction-with-remote-parent-header" title="Transaction startTransactionWithRemoteParent(HeaderExtractor)"><code class="literal">Transaction startTransactionWithRemoteParent(HeaderExtractor)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.3.0</span>]
<span class="Admonishment-detail">
Added in 1.3.0.
</span>
</span></a></p>
</div>
</div>
<h3><a id="api-annotation"></a>Annotation API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h3>
<p>The API comes with two annotations which make it easier to create custom spans and transactions.
Just put the annotations on top of your methods and the agent will take care of creating and reporting the corresponding transaction and spans.
It will also make sure to capture any uncaught exceptions.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>It is required to configure the <a class="xref" href="config-stacktrace.html#config-application-packages" title="application_packages"><code class="literal">application_packages</code></a>, otherwise these annotations will be ignored.</p>
</div>
</div>
<h4><a id="api-capture-transaction"></a><code class="literal">@CaptureTransaction</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Annotating a method with <code class="literal">@CaptureTransaction</code> creates a transaction for that method.</p>
<p>Note that this only works when there is no active transaction on the same thread.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">value</code>: The name of the transaction. Defaults to <code class="literal">ClassName#methodName</code>
</li>
<li class="listitem">
<code class="literal">type</code>: The type of the transaction. Defaults to <code class="literal">request</code>
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Using this annotation implicitly creates a Transaction and activates it when entering the annotated
method. It also implicitly ends it and deactivates it before exiting the annotated method.
See <a class="xref" href="public-api.html#api-start-transaction" title="Transaction startTransaction()"><code class="literal">ElasticApm.startTransaction()</code></a>, <a class="xref" href="public-api.html#api-transaction-activate" title="Scope activate()"><code class="literal">transaction.activate()</code></a>
and <a class="xref" href="public-api.html#api-transaction-end" title="void end()"><code class="literal">transaction.end()</code></a></p>
</div>
</div>
<h4><a id="api-capture-span"></a><code class="literal">@CaptureSpan</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Annotating a method with <code class="literal">@CaptureSpan</code> creates a span as the child of the currently active span or transaction
(<a class="xref" href="public-api.html#api-current-span" title="Span currentSpan()"><code class="literal">Span currentSpan()</code></a>).</p>
<p>When there is no current span,
no span will be created.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">value</code>: The name of the span. Defaults to <code class="literal">ClassName#methodName</code>
</li>
<li class="listitem">
<code class="literal">type</code>: The type of the span, e.g. <code class="literal">db</code> for DB span. Defaults to <code class="literal">app</code>
</li>
<li class="listitem">
<code class="literal">subtype</code>: The subtype of the span, e.g. <code class="literal">mysql</code> for DB span. Defaults to empty string
</li>
<li class="listitem">
<code class="literal">action</code>: The action related to the span, e.g. <code class="literal">query</code> for DB spans. Defaults to empty string
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Using this annotation implicitly creates a Span and activates it when entering the annotated
method. It also implicitly ends it and deactivates it before exiting the annotated method.
See <a class="xref" href="public-api.html#api-span-start-span" title="Span startSpan()"><code class="literal">startSpan()</code></a>, <a class="xref" href="public-api.html#api-span-start-span-with-type" title="Span startSpan(String type, String subtype, String action)"><code class="literal">startSpan(String, String, String)</code></a>,
<a class="xref" href="public-api.html#api-transaction-activate" title="Scope activate()"><code class="literal">span.activate()</code></a> and <a class="xref" href="public-api.html#api-span-end" title="void end()"><code class="literal">span.end()</code></a></p>
</div>
</div>
<h4><a id="api-traced"></a><code class="literal">@Traced</code>  <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.11.0</span>]
<span class="Admonishment-detail">
Added in 1.11.0.
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Annotating a method with <code class="literal">@Traced</code> creates a span as the child of the currently active span or transaction.</p>
<p>When there is no current span,
a transaction will be created instead.</p>
<p>Use this annotation over <a class="xref" href="public-api.html#api-capture-span" title="@CaptureSpan"><code class="literal">@CaptureSpan</code></a> or <a class="xref" href="public-api.html#api-capture-transaction" title="@CaptureTransaction"><code class="literal">@CaptureTransaction</code></a> if a method can both be an entry point (a transaction)
or a unit of work within a transaction (a span).</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">value</code>: The name of the span or transaction. Defaults to <code class="literal">ClassName#methodName</code>
</li>
<li class="listitem">
<code class="literal">type</code>: The type of the span or transaction. Defaults to <code class="literal">request</code> for transactions and <code class="literal">app</code> for spans
</li>
<li class="listitem">
<code class="literal">subtype</code>: The subtype of the span, e.g. <code class="literal">mysql</code> for DB span. Defaults to empty string. Has no effect when a transaction is created.
</li>
<li class="listitem">
<code class="literal">action</code>: The action related to the span, e.g. <code class="literal">query</code> for DB spans. Defaults to empty string. Has no effect when a transaction is created.
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Using this annotation implicitly creates a span or transaction and activates it when entering the annotated
method. It also implicitly ends it and deactivates it before exiting the annotated method.
See <a class="xref" href="public-api.html#api-span-start-span" title="Span startSpan()"><code class="literal">startSpan()</code></a>, <a class="xref" href="public-api.html#api-span-start-span-with-type" title="Span startSpan(String type, String subtype, String action)"><code class="literal">startSpan(String, String, String)</code></a>,
<a class="xref" href="public-api.html#api-transaction-activate" title="Scope activate()"><code class="literal">span.activate()</code></a> and <a class="xref" href="public-api.html#api-span-end" title="void end()"><code class="literal">span.end()</code></a></p>
</div>
</div>
<h3><a id="api-transaction"></a>Transaction API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h3>
<p>A transaction is the data captured by an agent representing an event occurring in a monitored service
and groups multiple spans in a logical group.
A transaction is the first <a class="xref" href="public-api.html#api-span" title="Span API"><code class="literal">Span</code></a> of a service, and is also known under the term entry span.</p>
<p>See <a class="xref" href="public-api.html#api-current-transaction" title="Transaction currentTransaction()"><code class="literal">Transaction currentTransaction()</code></a> on how to get a reference of the current transaction.</p>
<p><code class="literal">Transaction</code> is a sub-type of <code class="literal">Span</code>.
So it has all the methods a <a class="xref" href="public-api.html#api-span" title="Span API"><code class="literal">Span</code></a> offers plus additional ones.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Calling any of the transaction&#8217;s methods after <a class="xref" href="public-api.html#api-transaction-end" title="void end()"><code class="literal">void end()</code></a> has been called is illegal.
You may only interact with transaction when you have control over its lifecycle.
For example, if a span is ended in another thread you must not add labels if there is a chance for a race between the <a class="xref" href="public-api.html#api-transaction-end" title="void end()"><code class="literal">void end()</code></a>
and the <a class="xref" href="public-api.html#api-transaction-add-tag" title="Transaction setLabel(String key, value)"><code class="literal">Transaction setLabel(String key, value)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.5.0 as <code class="literal">addLabel</code></span>]
<span class="Admonishment-detail">
Added in 1.5.0 as <code class="literal">addLabel</code>. Number and boolean labels require APM Server 6.7
</span>
</span></a> method.</p>
</div>
</div>
<h4><a id="api-set-name"></a><code class="literal">Transaction setName(String name)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Override the name of the current transaction.
For supported frameworks,
the transaction name is determined automatically,
and can be overridden using this method.</p>
<p>Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">transaction.setName("My Transaction");</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code>: (required) A string describing name of the transaction
</li>
</ul>
</div>
<h4><a id="api-transaction-set-type"></a><code class="literal">Transaction setType(String type)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Sets the type of the transaction.
There’s a special type called <code class="literal">request</code>,
which is used by the agent for the transactions automatically created when an incoming HTTP request is detected.</p>
<p>Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">transaction.setType(Transaction.TYPE_REQUEST);</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">type</code>: The type of the transaction
</li>
</ul>
</div>
<h4><a id="api-transaction-add-tag"></a><code class="literal">Transaction setLabel(String key, value)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.5.0 as <code class="literal">addLabel</code></span>]
<span class="Admonishment-detail">
Added in 1.5.0 as <code class="literal">addLabel</code>. Number and boolean labels require APM Server 6.7
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Labels are used to add <span class="strong strong"><strong>indexed</strong></span> information to transactions, spans, and errors.
Indexed means the data is searchable and aggregatable in Elasticsearch.
Multiple labels can be defined with different key-value pairs.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Indexed: Yes
</li>
<li class="listitem">
Elasticsearch type: <a href="/guide/en/elasticsearch/reference/7.10/object.html" class="ulink" target="_top">object</a>
</li>
<li class="listitem">
Elasticsearch field: <code class="literal">labels</code> (previously <code class="literal">context.tags</code> in &lt;v.7.0)
</li>
</ul>
</div>
<p>Label values can be a string, boolean, or number.
Because labels for a given key are stored in the same place in Elasticsearch, all label values of a given key must have the same data type.
Multiple data types per key will throw an exception, e.g. <code class="literal">{foo: bar}</code> and <code class="literal">{foo: 42}</code></p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Number and boolean labels were only introduced in APM Server 6.7+.
Using this API in combination with an older APM Server versions leads to validation errors.</p>
</div>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Avoid defining too many user-specified labels.
Defining too many unique fields in an index is a condition that can lead to a
<a href="/guide/en/elasticsearch/reference/7.10/mapping.html#mapping-limit-settings" class="ulink" target="_top">mapping explosion</a>.</p>
</div>
</div>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">transaction.setLabel("foo", "bar");</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">String key</code>:   The tag key
</li>
<li class="listitem">
<code class="literal">String|Number|boolean value</code>: The tag value
</li>
</ul>
</div>
<h4><a id="api-transaction-add-custom-context"></a><code class="literal">Transaction addCustomContext(String key, value)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.7.0</span>]
<span class="Admonishment-detail">
Added in 1.7.0.
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Custom context is used to add non-indexed,
custom contextual information to transactions.
Non-indexed means the data is not searchable or aggregatable in Elasticsearch,
and you cannot build dashboards on top of the data.
However, non-indexed information is useful for other reasons,
like providing contextual information to help you quickly debug performance issues or errors.</p>
<p>The value can be a <code class="literal">String</code>, <code class="literal">Number</code> or <code class="literal">boolean</code>.</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">transaction.addCustomContext("foo", "bar");</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">String key</code>:   The tag key
</li>
<li class="listitem">
<code class="literal">String|Number|boolean value</code>: The tag value
</li>
</ul>
</div>
<h4><a id="api-transaction-set-user"></a><code class="literal">Transaction setUser(String id, String email, String username)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Call this to enrich collected performance data and errors with information about the user/client.
This method can be called at any point during the request/response life cycle (i.e. while a transaction is active).
The given context will be added to the active transaction.</p>
<p>If an error is captured, the context from the active transaction is used as context for the captured error.</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">transaction.setUser(user.getId(), user.getEmail(), user.getUsername());</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">id</code>:       The user&#8217;s id or <code class="literal">null</code>, if not applicable.
</li>
<li class="listitem">
<code class="literal">email</code>:    The user&#8217;s email address or <code class="literal">null</code>, if not applicable.
</li>
<li class="listitem">
<code class="literal">username</code>: The user&#8217;s name or <code class="literal">null</code>, if not applicable.
</li>
</ul>
</div>
<h4><a id="api-transaction-capture-exception"></a><code class="literal">String captureException(Exception e)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Captures an exception and reports it to the APM server. Since version 1.14.0 - returns the id of reported error.</p>
<h4><a id="api-transaction-get-id"></a><code class="literal">String getId()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Returns the id of this transaction (never <code class="literal">null</code>)</p>
<p>If this transaction represents a noop,
this method returns an empty string.</p>
<h4><a id="api-transaction-get-trace-id"></a><code class="literal">String getTraceId()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Returns the trace-id of this transaction.</p>
<p>The trace-id is consistent across all transactions and spans which belong to the same logical trace,
even for transactions and spans which happened in another service (given this service is also monitored by Elastic APM).</p>
<p>If this span represents a noop,
this method returns an empty string.</p>
<h4><a id="api-ensure-parent-id"></a><code class="literal">String ensureParentId()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>If the transaction does not have a parent-ID yet,
calling this method generates a new ID,
sets it as the parent-ID of this transaction,
and returns it as a <code class="literal">String</code>.</p>
<p>This enables the correlation of the spans the JavaScript Real User Monitoring (RUM) agent creates for the initial page load
with the transaction of the backend service.
If your backend service generates the HTML page dynamically,
initializing the JavaScript RUM agent with the value of this method allows analyzing the time spent in the browser vs in the backend services.</p>
<p>To enable the JavaScript RUM agent when using an HTML templating language like Freemarker,
add <code class="literal">ElasticApm.currentTransaction()</code> with the key <code class="literal">"transaction"</code> to the model.</p>
<p>Also, add a snippet similar to this to the body of your HTML page,
preferably before other JS libraries:</p>
<div class="pre_wrapper lang-html">
<pre class="programlisting prettyprint lang-html">&lt;script src="elastic-apm-js-base/dist/bundles/elastic-apm-js-base.umd.min.js"&gt;&lt;/script&gt;
&lt;script&gt;
  elasticApm.init({
    serviceName: "service-name",
    serverUrl: "http://localhost:8200",
    pageLoadTraceId: "${transaction.traceId}",
    pageLoadSpanId: "${transaction.ensureParentId()}",
    pageLoadSampled: ${transaction.sampled}
  })
&lt;/script&gt;</pre>
</div>
<p>See the <a href="/guide/en/apm/agent/rum-js/current" class="ulink" target="_top">JavaScript RUM agent documentation</a> for more information.</p>
<h4><a id="api-transaction-start-span-with-type"></a><code class="literal">Span startSpan(String type, String subtype, String action)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Start and return a new span with a type, a subtype and an action, as a child of this transaction.</p>
<p>The type, subtype and action strings are used to group similar spans together, with different resolution.
For instance, all DB spans are given the type <code class="literal">db</code>; all spans of MySQL queries are given the subtype <code class="literal">mysql</code> and all spans
describing queries are given the action <code class="literal">query</code>.
In this example <code class="literal">db</code> is considered the general type. Though there are no naming restrictions for the general types,
the following are standardized across all Elastic APM agents: <code class="literal">app</code>, <code class="literal">db</code>, <code class="literal">cache</code>, <code class="literal">template</code>, and <code class="literal">ext</code>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p><em>.</em> (dot) character is not allowed within type, subtype and action. Any such character will be replaced with a <em>_</em>
(underscore) character.</p>
</div>
</div>
<p>It is important to call <a class="xref" href="public-api.html#api-span-end" title="void end()"><code class="literal">void end()</code></a> when the span has ended.
A best practice is to use the span in a try-catch-finally block.
Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">Span span = parent.startSpan("db", "mysql", "query");
try {
    span.setName("SELECT FROM customer");
    // do your thing...
} catch (Exception e) {
    span.captureException(e);
    throw e;
} finally {
    span.end();
}</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Spans created via this method can not be retrieved by calling <a class="xref" href="public-api.html#api-current-span" title="Span currentSpan()"><code class="literal">ElasticApm.currentSpan()</code></a>.
See <a class="xref" href="public-api.html#api-span-activate" title="Scope activate()"><code class="literal">span.activate()</code></a> on how to achieve that.</p>
</div>
</div>
<h4><a id="api-transaction-start-span"></a><code class="literal">Span startSpan()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Start and return a new custom span with no type as a child of this transaction.</p>
<p>It is important to call <a class="xref" href="public-api.html#api-span-end" title="void end()"><code class="literal">void end()</code></a> when the span has ended.
A best practice is to use the span in a try-catch-finally block.
Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">Span span = parent.startSpan();
try {
    span.setName("SELECT FROM customer");
    // do your thing...
} catch (Exception e) {
    span.captureException(e);
    throw e;
} finally {
    span.end();
}</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Spans created via this method can not be retrieved by calling <a class="xref" href="public-api.html#api-current-span" title="Span currentSpan()"><code class="literal">ElasticApm.currentSpan()</code></a>.
See <a class="xref" href="public-api.html#api-span-activate" title="Scope activate()"><code class="literal">span.activate()</code></a> on how to achieve that.</p>
</div>
</div>
<h4><a id="api-transaction-set-result"></a><code class="literal">Transaction setResult(String result)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>A string describing the result of the transaction.
This is typically the HTTP status code, or e.g. "success" for a background task</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">result</code>: a string describing the result of the transaction
</li>
</ul>
</div>
<p>The result value set through API will have priority over the value that might be set by auto-instrumentation.</p>
<h4><a id="api-transaction-set-outcome"></a><code class="literal">Span setOutcome(Outcome outcome)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.21.0</span>]
<span class="Admonishment-detail">
Added in 1.21.0.
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Sets the transaction or span outcome. Use either <code class="literal">FAILURE</code> or <code class="literal">SUCCESS</code> to indicate success or failure,
use <code class="literal">UNKNOWN</code> when the outcome can&#8217;t be properly known.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">outcome</code>: transaction or span outcome
</li>
</ul>
</div>
<p>Outcome is used to compute error rates between services, using <code class="literal">UNKNOWN</code> will not alter those rates.
The value set through API will have higher priority over the value that might be set by auto-instrumentation.</p>
<h4><a id="api-transaction-set-start-timestamp"></a><code class="literal">Transaction setStartTimestamp(long epochMicros)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.5.0</span>]
<span class="Admonishment-detail">
Added in 1.5.0.
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Sets the start timestamp of this event.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">epochMicros</code>: the timestamp of when this event started, in microseconds (µs) since epoch
</li>
</ul>
</div>
<h4><a id="api-transaction-end"></a><code class="literal">void end()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Ends the transaction and schedules it to be reported to the APM Server.
It is illegal to call any methods on a transaction instance which has already ended.
This also includes this method and <a class="xref" href="public-api.html#api-transaction-start-span" title="Span startSpan()"><code class="literal">Span startSpan()</code></a>.
Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">transaction.end();</pre>
</div>
<h4><a id="api-transaction-end-timestamp"></a><code class="literal">void end(long epochMicros)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.5.0</span>]
<span class="Admonishment-detail">
Added in 1.5.0.
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Ends the transaction and schedules it to be reported to the APM Server.
It is illegal to call any methods on a transaction instance which has already ended.
This also includes this method and <a class="xref" href="public-api.html#api-transaction-start-span" title="Span startSpan()"><code class="literal">Span startSpan()</code></a>.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">epochMicros</code>: the timestamp of when this event ended, in microseconds (µs) since epoch
</li>
</ul>
</div>
<p>Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">transaction.end(System.currentTimeMillis() * 1000);</pre>
</div>
<h4><a id="api-transaction-activate"></a><code class="literal">Scope activate()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Makes this span the active span on the current thread until <code class="literal">Scope#close()</code> has been called.
Scopes should only be used in try-with-resource statements in order to make sure the <code class="literal">Scope#close()</code> method is called in all
circumstances.
Failing to close a scope can lead to memory leaks and corrupts the parent-child relationships.</p>
<p>This method should always be used within a try-with-resources statement:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">Transaction transaction = ElasticApm.startTransaction();
// Within the try block the transaction is available
// on the current thread via ElasticApm.currentTransaction().
// This is also true for methods called within the try block.
try (final Scope scope = transaction.activate()) {
    transaction.setName("MyController#myAction");
    transaction.setType(Transaction.TYPE_REQUEST);
    // do your thing...
} catch (Exception e) {
    transaction.captureException(e);
    throw e;
} finally {
    transaction.end();
}</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p><a class="xref" href="public-api.html#api-transaction-activate" title="Scope activate()"><code class="literal">Scope activate()</code></a> and <code class="literal">Scope#close()</code> have to be called on the same thread.</p>
</div>
</div>
<h4><a id="api-transaction-is-sampled"></a><code class="literal">boolean isSampled()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Returns true if this transaction is recorded and sent to the APM Server</p>
<h4><a id="api-transaction-inject-trace-headers"></a><code class="literal">void injectTraceHeaders(HeaderInjector headerInjector)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.3.0</span>]
<span class="Admonishment-detail">
Added in 1.3.0.
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">headerInjector</code>: tells the agent how to inject a header into the request object
</li>
</ul>
</div>
<p>Allows for manual propagation of the tracing headers.</p>
<p>If you want to manually instrument an RPC framework which is not already supported by the auto-instrumentation capabilities of the agent,
you can use this method to inject the required tracing headers into the header section of that framework&#8217;s request object.</p>
<p>Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">// Hook into a callback provided by the RPC framework that is called on outgoing requests
public Response onOutgoingRequest(Request request) throws Exception {
    // creates a span representing the external call
    Span span = ElasticApm.currentSpan()
            .startSpan("external", "http", null)
            .setName(request.getMethod() + " " + request.getHost());
    try (final Scope scope = transaction.activate()) {
        span.injectTraceHeaders((name, value) -&gt; request.addHeader(name, value));
        return request.execute();
    } catch (Exception e) {
        span.captureException(e);
        throw e;
    } finally {
        span.end();
    }
}</pre>
</div>
<h3><a id="api-span"></a>Span API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h3>
<p>A span contains information about a specific code path, executed as part of a transaction.</p>
<p>If for example a database query happens within a recorded transaction,
a span representing this database query may be created.
In such a case the name of the span will contain information about the query itself,
and the type will hold information about the database type.</p>
<p>See <a class="xref" href="public-api.html#api-current-span" title="Span currentSpan()"><code class="literal">Span currentSpan()</code></a> on how to get a reference of the current span.</p>
<h4><a id="api-span-set-name"></a><code class="literal">Span setName(String name)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Override the name of the current span.</p>
<p>Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">span.setName("SELECT FROM customer");</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code>: the name of the span
</li>
</ul>
</div>
<h4><a id="api-span-add-tag"></a><code class="literal">Span setLabel(String key, value)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.5.0 as <code class="literal">addLabel</code></span>]
<span class="Admonishment-detail">
Added in 1.5.0 as <code class="literal">addLabel</code>.
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>A flat mapping of user-defined labels with string, number or boolean values.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In version 6.x, labels are stored under <code class="literal">context.tags</code> in Elasticsearch.
As of version 7.x, they are stored as <code class="literal">labels</code> to comply with the <a href="https://github.com/elastic/ecs" class="ulink" target="_top">Elastic Common Schema (ECS)</a>.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The labels are indexed in Elasticsearch so that they are searchable and aggregatable.
By all means,
you should avoid that user specified data,
like URL parameters,
is used as a tag key as it can lead to mapping explosions.</p>
</div>
</div>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">span.setLabel("foo", "bar");</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">String key</code>:   The tag key
</li>
<li class="listitem">
<code class="literal">String|Number|boolean value</code>: The tag value
</li>
</ul>
</div>
<h4><a id="api-span-capture-exception"></a><code class="literal">String captureException(Exception e)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Captures an exception and reports it to the APM server. Since version 1.14.0 - returns the id of reported error.</p>
<h4><a id="api-span-get-id"></a><code class="literal">String getId()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Returns the id of this span (never <code class="literal">null</code>)</p>
<p>If this span represents a noop,
this method returns an empty string.</p>
<h4><a id="api-span-get-trace-id"></a><code class="literal">String getTraceId()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Returns the trace-ID of this span.</p>
<p>The trace-ID is consistent across all transactions and spans which belong to the same logical trace,
even for transactions and spans which happened in another service (given this service is also monitored by Elastic APM).</p>
<p>If this span represents a noop,
this method returns an empty string.</p>
<h4><a id="api-span-set-start-timestamp"></a><code class="literal">Span setStartTimestamp(long epochMicros)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.5.0</span>]
<span class="Admonishment-detail">
Added in 1.5.0.
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Sets the start timestamp of this event.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">epochMicros</code>: the timestamp of when this event started, in microseconds (µs) since epoch
</li>
</ul>
</div>
<h4><a id="api-span-end"></a><code class="literal">void end()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Ends the span and schedules it to be reported to the APM Server.
It is illegal to call any methods on a span instance which has already ended.
This also includes this method and <a class="xref" href="public-api.html#api-span-start-span" title="Span startSpan()"><code class="literal">Span startSpan()</code></a>.</p>
<h4><a id="api-span-end-timestamp"></a><code class="literal">void end(long epochMicros)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.5.0</span>]
<span class="Admonishment-detail">
Added in 1.5.0.
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Ends the span and schedules it to be reported to the APM Server.
It is illegal to call any methods on a span instance which has already ended.
This also includes this method and <a class="xref" href="public-api.html#api-span-start-span" title="Span startSpan()"><code class="literal">Span startSpan()</code></a>.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">epochMicros</code>: the timestamp of when this event ended, in microseconds (µs) since epoch
</li>
</ul>
</div>
<p>Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">span.end(System.currentTimeMillis() * 1000);</pre>
</div>
<h4><a id="api-span-start-span-with-type"></a><code class="literal">Span startSpan(String type, String subtype, String action)</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Start and return a new span with a type, a subtype and an action, as a child of this transaction.</p>
<p>The type, subtype and action strings are used to group similar spans together, with different resolution.
For instance, all DB spans are given the type <code class="literal">db</code>; all spans of MySQL queries are given the subtype <code class="literal">mysql</code> and all spans
describing queries are give the action <code class="literal">query</code>.
In this example <code class="literal">db</code> is considered the general type. Though there are no naming restrictions for the general types,
the following are standardized across all Elastic APM agents: <code class="literal">app</code>, <code class="literal">db</code>, <code class="literal">cache</code>, <code class="literal">template</code>, and <code class="literal">ext</code>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p><em>.</em> (dot) character is not allowed within type, subtype and action. Any such character will be replaced with a <em>_</em>
(underscore) character.</p>
</div>
</div>
<p>It is important to call <a class="xref" href="public-api.html#api-span-end" title="void end()"><code class="literal">void end()</code></a> when the span has ended.
A best practice is to use the span in a try-catch-finally block.
Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">Span span = parent.startSpan("db", "mysql", "query");
try {
    span.setName("SELECT FROM customer");
    // do your thing...
} catch (Exception e) {
    span.captureException(e);
    throw e;
} finally {
    span.end();
}</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Spans created via this method can not be retrieved by calling <a class="xref" href="public-api.html#api-current-span" title="Span currentSpan()"><code class="literal">ElasticApm.currentSpan()</code></a>.
See <a class="xref" href="public-api.html#api-span-activate" title="Scope activate()"><code class="literal">span.activate()</code></a> on how to achieve that.</p>
</div>
</div>
<h4><a id="api-span-start-span"></a><code class="literal">Span startSpan()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Start and return a new custom span with no type as a child of this transaction.</p>
<p>It is important to call <a class="xref" href="public-api.html#api-span-end" title="void end()"><code class="literal">void end()</code></a> when the span has ended.
A best practice is to use the span in a try-catch-finally block.
Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">Span span = parent.startSpan();
try {
    span.setName("SELECT FROM customer");
    // do your thing...
} catch (Exception e) {
    span.captureException(e);
    throw e;
} finally {
    span.end();
}</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Spans created via this method can not be retrieved by calling <a class="xref" href="public-api.html#api-current-span" title="Span currentSpan()"><code class="literal">ElasticApm.currentSpan()</code></a>.
See <a class="xref" href="public-api.html#api-span-activate" title="Scope activate()"><code class="literal">span.activate()</code></a> on how to achieve that.</p>
</div>
</div>
<h4><a id="api-span-activate"></a><code class="literal">Scope activate()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Makes this span the active span on the current thread until <code class="literal">Scope#close()</code> has been called.
Scopes should only be used in try-with-resource statements in order to make sure the <code class="literal">Scope#close()</code> method is called in all
circumstances.
Failing to close a scope can lead to memory leaks and corrupts the parent-child relationships.</p>
<p>This method should always be used within a try-with-resources statement:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">Span span = parent.startSpan("db", "mysql", "query");
// Within the try block the span is available
// on the current thread via ElasticApm.currentSpan().
// This is also true for methods called within the try block.
try (final Scope scope = span.activate()) {
    span.setName("SELECT FROM customer");
    // do your thing...
} catch (Exception e) {
    span.captureException(e);
    throw e;
} finally {
    span.end();
}</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Calling any of the span&#8217;s methods after <a class="xref" href="public-api.html#api-span-end" title="void end()"><code class="literal">void end()</code></a> has been called is illegal.
You may only interact with span when you have control over its lifecycle.
For example, if a span is ended in another thread you must not add labels if there is a chance for a race between the <a class="xref" href="public-api.html#api-span-end" title="void end()"><code class="literal">void end()</code></a>
and the <a class="xref" href="public-api.html#api-span-add-tag" title="Span setLabel(String key, value)"><code class="literal">Span setLabel(String key, value)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.5.0 as <code class="literal">addLabel</code></span>]
<span class="Admonishment-detail">
Added in 1.5.0 as <code class="literal">addLabel</code>.
</span>
</span></a> method.</p>
</div>
</div>
<h4><a id="api-span-is-sampled"></a><code class="literal">boolean isSampled()</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<p>Returns true if this span is recorded and sent to the APM Server</p>
<h4><a id="api-span-inject-trace-headers"></a><code class="literal">void injectTraceHeaders(HeaderInjector headerInjector)</code> <span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">1.3.0</span>]
<span class="Admonishment-detail">
Added in 1.3.0.
</span>
</span><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/public-api.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">headerInjector</code>: tells the agent how to inject a header into the request object
</li>
</ul>
</div>
<p>Allows for manual propagation of the tracing headers.</p>
<p>If you want to manually instrument an RPC framework which is not already supported by the auto-instrumentation capabilities of the agent,
you can use this method to inject the required tracing headers into the header section of that framework&#8217;s request object.</p>
<p>Example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">// Hook into a callback provided by the RPC framework that is called on outgoing requests
public Response onOutgoingRequest(Request request) throws Exception {
    // creates a span representing the external call
    Span span = ElasticApm.currentSpan()
            .startSpan("external", "http", null)
            .setName(request.getMethod() + " " + request.getHost());
    try (final Scope scope = transaction.activate()) {
        span.injectTraceHeaders((name, value) -&gt; request.addHeader(name, value));
        return request.execute();
    } catch (Exception e) {
        span.captureException(e);
        throw e;
    } finally {
        span.end();
    }
}</pre>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="config-reference-properties-file.html">« Property file reference</a>
</span>
<span class="next">
<a href="metrics.html">Metrics »</a>
</span>
</div>
</div>
</body>
</html>
