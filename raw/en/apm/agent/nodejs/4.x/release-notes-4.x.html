<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Node.js Agent version 4.x | APM Node.js Agent Reference [4.x] | Elastic</title>
<meta class="elastic" name="content" content="Node.js Agent version 4.x | APM Node.js Agent Reference [4.x]">

<link rel="home" href="index.html" title="APM Node.js Agent Reference [4.x]"/>
<link rel="up" href="release-notes.html" title="Release notes"/>
<link rel="prev" href="release-notes.html" title="Release notes"/>
<link rel="next" href="release-notes-3.x.html" title="Node.js Agent version 3.x"/>
<meta class="elastic" name="product_version" content="4.x"/>
<meta class="elastic" name="product_name" content="APM"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/APM Node.js Agent/Reference/4.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="4.x"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link">
  <div id="related-products" class="dropdown">
  <div class="related-products-title">APM:</div>
  <div class="dropdown-anchor" tabindex="0">Node.js Agent Reference<span class="dropdown-icon"></span></div>
  <div class="dropdown-content">
  <ul>
  <li class="dropdown-category">APM</li>
  <ul>
  <li><a href="/guide/en/observability/current/apm.html">Observability › APM</a></li>
  </ul>
  <li class="dropdown-category">APM agents</li>
  <ul>
  <li><a href="/guide/en/apm/agent/android/current/intro.html">Android Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/go/current/introduction.html">Go Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/swift/current/intro.html">iOS Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/java/current/intro.html">Java Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/dotnet/current/intro.html">.NET Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/nodejs/current/intro.html">Node.js Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/php/current/intro.html">PHP Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/python/current/getting-started.html">Python Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/ruby/current/introduction.html">Ruby Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/rum-js/current/intro.html">Real User Monitoring JavaScript Agent Reference</a></li>
  </ul>
  <li class="dropdown-category">APM extensions</li>
  <ul>
  <li><a href="/guide/en/apm/lambda/current/aws-lambda-arch.html">AWS Lambda extension</a></li>
  <li><a href="/guide/en/apm/attacher/current/apm-attacher.html">Attacher</a></li>
  </ul>
  </ul>
  </div>
  </div>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="release-notes.html">Release notes</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="release-notes.html">« Release notes</a>
</span>
<span class="next">
<a href="release-notes-3.x.html">Node.js Agent version 3.x »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="release-notes-4.x"></a>Node.js Agent version 4.x<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h2>
</div></div></div>
<p>See the <a class="xref" href="upgrade-to-v4.html" title="Upgrade to v4.x">Upgrade to v4.x</a> guide.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.6.0"></a>4.6.0 - 2024/06/05<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Make published <code class="literal">docker.elastic.co/observability/apm-agent-nodejs</code> Docker
images multi-platform, with support for <code class="literal">linux/amd64,linux/arm64</code> for now.
This is necessary for users of the Elastic APM Attacher for Kubernetes,
when deploying to k8s nodes that are ARM64 (e.g. Gravitron on AWS).
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/4038" class="ulink" target="_top">#4038</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix instrumentation for recent <code class="literal">@aws-sdk/client-*</code> releases that use
<code class="literal">@smithy/smithy-client</code> v3. (For example <code class="literal">@aws-sdk/client-s3@3.575.0</code> released
2024-05-13 updated to smithy-client v3.) Before this change the APM agent had
been limiting patching of <code class="literal">@smithy/smithy-client</code> to <code class="literal">&gt;=1 &lt;3</code>.
(<a href="https://github.com/elastic/apm-agent-nodejs/pull/4036" class="ulink" target="_top">#4036</a>)
</li>
<li class="listitem">
<p>Mark the published AWS Lambda layers as supporting the "nodejs20.x" Lambda
Runtime (<code class="literal">--compatible-runtimes</code>). The "nodejs20.x" runtime was released by
AWS on 2023-11-15. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/4033" class="ulink" target="_top">#4033</a>)</p>
<p>Note that this Node.js APM agent supports Node.js 20.x, so the new AWS Lambda
runtime was supported when it was released. However, the metadata stating
compatible runtimes (which is advisory) was not updated until now.</p>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.5.4"></a>4.5.4 - 2024/05/13<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_bug_fixes_2"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Change how the "cookie" HTTP request header is represented in APM transaction
data to avoid a rare, but possible, intake bug where the transaction could be
rejected due to a mapping conflict.</p>
<p>Before this change a <code class="literal">Cookie: foo=bar; sessionid=42</code> HTTP request header
would be represented in the transaction document in Elasticsearch with these
document fields (the example assumes <a class="xref" href="configuration.html#sanitize-field-names" title="sanitizeFieldNames"><code class="literal">sanitizeFieldNames</code></a> matches
"sessionid", as it does by default):</p>
<pre class="screen">http.request.headers.cookie: "[REDACTED]"
...
http.request.cookies.foo: "bar"
http.request.cookies.sessionid: "[REDACTED]"</pre>
<p>After this change it is represented as:</p>
<pre class="screen">http.request.headers.cookie: "foo=bar; sessionid=REDACTED"</pre>
<p>In other words, <code class="literal">http.request.cookies</code> are no longer separated out.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/4006" class="ulink" target="_top">#4006</a>)</p>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.5.3"></a>4.5.3 - 2024/04/23<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_bug_fixes_3"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix message handling for tombstone messages in <code class="literal">kafkajs</code> instrumentation.
(<a href="https://github.com/elastic/apm-agent-nodejs/pull/3985" class="ulink" target="_top">#3985</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.5.2"></a>4.5.2 - 2024/04/12<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_bug_fixes_4"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix path resolution for requests that contain invalid characters in its
host header. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3923" class="ulink" target="_top">#3923</a>)
</li>
<li class="listitem">
Fix span names for <code class="literal">getMore</code> command of mongodb. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3919" class="ulink" target="_top">#3919</a>)
</li>
<li class="listitem">
Fix undici instrumentation to cope with a bug in undici@6.11.0 where
<code class="literal">request.addHeader()</code> was accidentally removed. (It was re-added in
undici@6.11.1.) (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3963" class="ulink" target="_top">#3963</a>)
</li>
<li class="listitem">
Update undici instrumentation to avoid possibly adding a <span class="strong strong"><strong>second</strong></span>
<em>traceparent</em> header to outgoing HTTP requests, because this can break
Elasticsearch requests. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/3964" class="ulink" target="_top">#3964</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.5.0"></a>4.5.0 - 2024/03/13<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_2"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Update <a class="xref" href="opentelemetry-bridge.html" title="OpenTelemetry bridge"><em>OpenTelemetry bridge</em></a> support to <code class="literal">@opentelemetry/api</code> version 1.8.0.
</li>
<li class="listitem">
Update <code class="literal">tedious</code> instrumentation to support versions 17 and 18. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3901" class="ulink" target="_top">#3901</a>, <a href="https://github.com/elastic/apm-agent-nodejs/pull/3911" class="ulink" target="_top">#3911</a>)
</li>
<li class="listitem">
Add new <code class="literal">kafkajs</code> instrumentation. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2905" class="ulink" target="_top">#2905</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_5"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix instrumentation of mongodb to not break mongodb@6.4.0. Mongodb v6.4.0
included changes that resulted in the APM agent&#8217;s instrumentation breaking it.
(<a href="https://github.com/elastic/apm-agent-nodejs/pull/3897" class="ulink" target="_top">#3897</a>)
</li>
<li class="listitem">
Fix hostname detection on Windows in some cases (where a powershell profile
could break collection). (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3899" class="ulink" target="_top">#3899</a>)
</li>
<li class="listitem">
Fix a path normalization issue that broke (or partially broke) instrumentation
of some modules on Windows: Next.js, redis v4+, mongodb. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3905" class="ulink" target="_top">#3905</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.4.1"></a>4.4.1 - 2024/02/06<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_bug_fixes_6"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add support for <a class="xref" href="esm.html" title="ECMAScript module support">instrumentation of ES module-using (ESM) code</a> with
Node.js versions matching <code class="literal">^18.19.0 || &gt;=20.2.0</code>. Before this version of
the APM agent, ESM instrumentation was only supported for some <span class="strong strong"><strong>earlier</strong></span>
Node.js versions. Changes in Node.js&#8217;s ESM loader in v18.19.0 and v20 broke
earlier ESM support. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/3784" class="ulink" target="_top">#3784</a>, <a href="https://github.com/elastic/apm-agent-nodejs/pull/3844" class="ulink" target="_top">#3844</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.4.0"></a>4.4.0 - 2024/01/12<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="strong strong"><strong>Known issue</strong></span>: Using the APM agent&#8217;s <a class="xref" href="esm.html" title="ECMAScript module support"><em>ECMAScript module support</em></a> with Node.js <span class="strong strong"><strong>v18.19.0</strong></span> is not
supported in this version. Upgrade to APM agent version v4.5.0 or later, or use
Node.js v18.18.1 or earlier.
See <a href="https://github.com/elastic/apm-agent-nodejs/issues/3784" class="ulink" target="_top">https://github.com/elastic/apm-agent-nodejs/issues/3784</a> for details.</p>
<h5><a id="_features_3"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Support <code class="literal">ELASTIC_APM_ACTIVATION_METHOD=K8S_ATTACH</code> (in addition to the
current <code class="literal">K8S</code> value) to indicate the agent is being started by
apm-k8s-attacher.  Newer releases of apm-k8s-attacher will be using this
value (to have a common value used between APM agents).
</li>
</ul>
</div>
<h5><a id="_bug_fixes_7"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix bug where <code class="literal">NODE_ENV</code> environment value was not used as a default for
the <a class="xref" href="configuration.html#environment" title="environment"><code class="literal">environment</code></a> config setting. The bug was introduced in v4.2.0.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/3807" class="ulink" target="_top">#3807</a>)
</li>
<li class="listitem">
Improve Fastify instrumentation to no longer cause the <a href="https://fastify.dev/docs/latest/Reference/Warnings/#FSTDEP017" class="ulink" target="_top"><code class="literal">FSTDEP017</code></a>
and <a href="https://fastify.dev/docs/latest/Reference/Warnings/#FSTDEP018" class="ulink" target="_top"><code class="literal">FSTDEP018</code></a>
deprecation warnings. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3814" class="ulink" target="_top">#3814</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.3.0"></a>4.3.0 - 2023/12/05<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="strong strong"><strong>Known issue</strong></span>: Using the APM agent&#8217;s <a class="xref" href="esm.html" title="ECMAScript module support"><em>ECMAScript module support</em></a> with Node.js <span class="strong strong"><strong>v18.19.0</strong></span> is not
supported in this version. Upgrade to APM agent version v4.5.0 or later, or use
Node.js v18.18.1 or earlier.
See <a href="https://github.com/elastic/apm-agent-nodejs/issues/3784" class="ulink" target="_top">https://github.com/elastic/apm-agent-nodejs/issues/3784</a> for details.</p>
<h5><a id="_features_4"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add the <a class="xref" href="configuration.html#apm-client-headers" title="apmClientHeaders"><code class="literal">apmClientHeaders</code></a> config option, to allow adding custom headers
to HTTP requests made to APM server by the APM agent. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/3759" class="ulink" target="_top">#3759</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_8"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix the dependency version range for <code class="literal">@elastic/ecs-pino-format</code>.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/3774" class="ulink" target="_top">#3774</a>)
</li>
</ul>
</div>
<h5><a id="_chores"></a>Chores<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Skip undici tests for <code class="literal">undici</code> <code class="literal">&gt;=5.28.0</code> and NodeJS <code class="literal">&lt;14.18.0</code>.
(<a href="https://github.com/elastic/apm-agent-nodejs/pull/3755" class="ulink" target="_top">#3755</a>)
</li>
<li class="listitem">
Change the log level of <code class="literal">Sending error to Elastic APM: ...</code> from <code class="literal">info</code> to
<code class="literal">debug</code>. There is no need to clutter the log output with this message.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/3748" class="ulink" target="_top">#3748</a>)
</li>
<li class="listitem">
Explicitly mark this package as being of type="commonjs". The experimental
<code class="literal">node --experimental-default-type=module ...</code> option
<a href="https://nodejs.org/en/blog/release/v20.10.0#--experimental-default-type-flag-to-flip-module-defaults" class="ulink" target="_top">added in Node.js v20.10.0</a>
means that a default to "commonjs" isn&#8217;t guaranteed.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.2.0"></a>4.2.0 - 2023/11/23<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_breaking_changes"></a>Breaking changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Drop support for next@11. Next.js instrumentation support is currently in
technical preview, so it is not considered a semver-major change to drop
support for this old version of next. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3664" class="ulink" target="_top">#3664</a>)
</li>
</ul>
</div>
<h5><a id="_features_5"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add <a class="xref" href="agent-api.html#apm-get-service-version" title="apm.getServiceVersion()"><code class="literal">apm.getServiceVersion()</code></a>, <a class="xref" href="agent-api.html#apm-get-service-environment" title="apm.getServiceEnvironment()"><code class="literal">apm.getServiceEnvironment()</code></a>, and
<a class="xref" href="agent-api.html#apm-get-service-node-name" title="apm.getServiceNodeName()"><code class="literal">apm.getServiceNodeName()</code></a>. These are intended for use by
<a href="/guide/en/ecs-logging/nodejs/master/intro.html" class="ulink" target="_top">ecs-logging-nodejs formatting packages</a>.
See <a href="https://github.com/elastic/ecs-logging-nodejs/pull/152" class="ulink" target="_top">https://github.com/elastic/ecs-logging-nodejs/pull/152</a>.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/3195" class="ulink" target="_top">#3195</a>)
</li>
<li class="listitem">
Add knex@3 instrumentation. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3659" class="ulink" target="_top">#3659</a>)
</li>
<li class="listitem">
Update <a class="xref" href="opentelemetry-bridge.html" title="OpenTelemetry bridge"><em>OpenTelemetry bridge</em></a> support to <code class="literal">@opentelemetry/api</code> version 1.7.0.
</li>
</ul>
</div>
<h5><a id="_bug_fixes_9"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix <code class="literal">mongodb</code> instrumentation to avoid loosing context when multiple cursors
are running concurrently. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/3161" class="ulink" target="_top">#3161</a>)
</li>
<li class="listitem">
Set <code class="literal">mongodb</code> span&#8217;s outcome according to the result of the command being traced.
(<a href="https://github.com/elastic/apm-agent-nodejs/pull/3695" class="ulink" target="_top">#3695</a>)
</li>
<li class="listitem">
Fix <code class="literal">@aws-sdk/client-sqs</code> instrumentation which was failing for <code class="literal">SendMessageBatch</code>
command when any of the entities does not contain <code class="literal">MessageAttributes</code>.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/3746" class="ulink" target="_top">#3746</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.1.0"></a>4.1.0 - 2023/10/09<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_6"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Update <a class="xref" href="opentelemetry-bridge.html" title="OpenTelemetry bridge"><em>OpenTelemetry bridge</em></a> support to <code class="literal">@opentelemetry/api</code> version 1.6.0.
<a href="https://github.com/elastic/apm-agent-nodejs/pull/3622" class="ulink" target="_top">#3622</a>
</li>
<li class="listitem">
Add support for <code class="literal">@aws-sdk/client-dynamodb</code>, one of the AWS SDK v3 clients.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2958" class="ulink" target="_top">#2958</a>)
</li>
<li class="listitem">
Add support for <code class="literal">@aws-sdk/client-sns</code>, one of the AWS SDK v3 clients.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2956" class="ulink" target="_top">#2956</a>)
</li>
<li class="listitem">
Add support for <code class="literal">@aws-sdk/client-sqs</code>, one of the AWS SDK v3 clients.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2957" class="ulink" target="_top">#2957</a>)
</li>
<li class="listitem">
Fixes for some values of the <a class="xref" href="configuration.html#disable-instrumentations" title="disableInstrumentations"><code class="literal">disableInstrumentations</code></a> config setting.
"redis" will now properly disable instrumentation for redis@4.
"next" will propertly disable all Next.js instrumentation.
(<a href="https://github.com/elastic/apm-agent-nodejs/pull/3658" class="ulink" target="_top">#3658</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_10"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Changes to cloud metadata collection for Google Cloud (GCP). Most notably
the <code class="literal">cloud.project.id</code> field is now the <code class="literal">project-id</code> from
<a href="https://cloud.google.com/compute/docs/metadata/default-metadata-values#project_metadata" class="ulink" target="_top">https://cloud.google.com/compute/docs/metadata/default-metadata-values#project_metadata</a>
rather than the <code class="literal">numeric-project-id</code>. This matches the value produced by
Elastic Beats (like filebeat). <a href="https://github.com/elastic/apm-agent-nodejs/issues/3614" class="ulink" target="_top">#3614</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.0.0"></a>4.0.0 - 2023/09/07<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<p>See the <a class="xref" href="upgrade-to-v4.html" title="Upgrade to v4.x">Upgrade to v4.x</a> guide.</p>
<h5><a id="_breaking_changes_2"></a>Breaking changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Set the new minimum supported Node.js to version 14.17.0.
Users of earlier Node.js versions can use elastic-apm-node v3.x, which
supports back to Node.js v8.6.
</li>
<li class="listitem">
Ignore a <code class="literal">timer</code> option passed to <code class="literal">startTransaction()</code> and <code class="literal">startSpan()</code> APIs.
This option was never documented. It would be surprising if any user is
impacted by this.
</li>
<li class="listitem">
Remove long deprecated support for the <code class="literal">ELASTIC_APM_</code>-prefixed environment
variables for the <a class="xref" href="configuration.html#kubernetes-node-name" title="kubernetesNodeName">Kubernetes config options</a>. For
example, one must use <code class="literal">KUBERNETES_POD_NAME</code> and not
<code class="literal">ELASTIC_APM_KUBERNETES_POD_NAME</code>. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2661" class="ulink" target="_top">#2661</a>)
</li>
<li class="listitem">
The config option <code class="literal">filterHttpHeaders</code> is now <em>removed</em>. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3539" class="ulink" target="_top">#3539</a>)
</li>
<li class="listitem">
Remove the deprecated <code class="literal">span.toString()</code> and <code class="literal">transaction.toString()</code> APIs.
See <a class="xref" href="upgrade-to-v4.html#v4-api-to-string" title="span.toString(), transaction.toString()">the upgrading doc</a> for details. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2348" class="ulink" target="_top">#2348</a>)
</li>
<li class="listitem">
Remove instrumentation support for the old <em>hapi</em> package&#8201;&#8212;&#8201;the current
<em>@hapi/hapi</em> package is still instrumented. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2691" class="ulink" target="_top">#2691</a>)
</li>
<li class="listitem">
Change <code class="literal">apm.startTransaction()</code> api to return a noop transaction instead of
null, if the agent is not yet started. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2429" class="ulink" target="_top">#2429</a>)
</li>
<li class="listitem">
Drop support for the obsolete "patch" context manager, i.e. the
<code class="literal">contextManager: "patch"</code> config option. This was a limited async context
management that predated the preferred <code class="literal">AsyncLocalStorage</code> core Node.js
mechanism for context tracking. It was deprecated in v3.37.0.  As well, the
related and deprecated <code class="literal">asyncHooks</code> config option has been removed.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/3529" class="ulink" target="_top">#3529</a>)
</li>
<li class="listitem">
Remove the <code class="literal">logUncaughtExceptions</code> config option.
See <a class="xref" href="upgrade-to-v4.html#v4-config-options" title="Config options">Upgrading to v4</a> for details.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2412" class="ulink" target="_top">#2412</a>)
</li>
<li class="listitem">
Remove <code class="literal">transaction.subtype</code> and <code class="literal">transaction.action</code> properties from API.
This also impacts <a class="xref" href="agent-api.html#apm-start-transaction" title="apm.startTransaction([name][, type][, options])"><code class="literal">apm.startTransaction([name][, type][, options])</code></a> and <code class="literal">transaction.setType(...)</code>,
both of which now no longer accept <code class="literal">subtype</code> and <code class="literal">action</code> parameters.
These two properties were deprecated in v3.25.0.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/3557" class="ulink" target="_top">#3557</a>)
</li>
<li class="listitem">
Remove support for the erroneous <code class="literal">ELASTIC_SANITIZE_FIELD_NAMES</code> and
<code class="literal">ELASTIC_IGNORE_MESSAGE_QUEUES</code> config environment variables. The correct env
vars are <code class="literal">ELASTIC_APM_SANITIZE_FIELD_NAMES</code> and
<code class="literal">ELASTIC_APM_IGNORE_MESSAGE_QUEUES</code>, respectively, and were supported starting
in v3.36.0.
</li>
</ul>
</div>
<h5><a id="_features_7"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The <code class="literal">apm.destroy()</code> method is now async. Almost no users should need to use
this method. However, if used, to be sure to wait for APM agent shutdown to
be complete, one can now <code class="literal">await apm.destroy()</code>. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/3222" class="ulink" target="_top">#3222</a>)
</li>
<li class="listitem">
Support instrumenting <code class="literal">mongodb</code> v6. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3596" class="ulink" target="_top">#3596</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_11"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix instrumentation of <code class="literal">mongodb</code> to avoid multiple command handler
registrations when client is created via <code class="literal">MongoClient.connect</code> static
method. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3586" class="ulink" target="_top">#3586</a>)
</li>
</ul>
</div>
<h5><a id="_chores_2"></a>Chores<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/4.x/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add a warning message when a duration or size config option is provided
without units. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2121" class="ulink" target="_top">#2121</a>)
</li>
<li class="listitem">
Change default value of <code class="literal">useElasticTraceparentHeader</code> config option to <code class="literal">false</code>.
This means that for outgoing HTTP requests, the APM agent will no longer add the
<code class="literal">elastic-apm-traceparent</code> header. This vendor-specific header was used in the past
while the <a href="https://w3c.github.io/trace-context/" class="ulink" target="_top">W3C trace-context</a> spec was still
in development. Now that it is in wide use, the <code class="literal">elastic-apm-traceparent</code> header is
only useful for interaction with very old Elastic APM agents.
</li>
<li class="listitem">
Add default ports into <code class="literal">context.service.target.name</code> for HTTP spans conforming to the
spec update done in <a href="https://github.com/elastic/apm/pull/700" class="ulink" target="_top">https://github.com/elastic/apm/pull/700</a> (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3590" class="ulink" target="_top">#3590</a>)
</li>
</ul>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="release-notes.html">« Release notes</a>
</span>
<span class="next">
<a href="release-notes-3.x.html">Node.js Agent version 3.x »</a>
</span>
</div>
</div>
</body>
</html>
