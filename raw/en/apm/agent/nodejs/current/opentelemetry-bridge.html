<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>OpenTelemetry bridge | APM Node.js Agent Reference [3.x] | Elastic</title>
<meta class="elastic" name="content" content="OpenTelemetry bridge | APM Node.js Agent Reference [3.x]">

<link rel="home" href="index.html" title="APM Node.js Agent Reference [3.x]"/>
<link rel="up" href="index.html" title="APM Node.js Agent Reference [3.x]"/>
<link rel="prev" href="logs.html" title="Logs"/>
<link rel="next" href="opentracing.html" title="OpenTracing bridge"/>
<meta class="elastic" name="product_version" content="3.x"/>
<meta class="elastic" name="product_name" content="APM"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/APM Node.js Agent/Reference/3.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="3.x"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link">
  <div id="related-products" class="dropdown">
  <div class="related-products-title">APM:</div>
  <div class="dropdown-anchor" tabindex="0">Node.js Agent Reference<span class="dropdown-icon"></span></div>
  <div class="dropdown-content">
  <ul>
  <li class="dropdown-category">APM</li>
  <ul>
  <li><a href="/guide/en/apm/guide/current/apm-overview.html">User Guide</a></li>
  </ul>
  <li class="dropdown-category">APM agents</li>
  <ul>
  <li><a href="/guide/en/apm/agent/android/current/intro.html">Android Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/go/current/introduction.html">Go Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/swift/current/intro.html">iOS Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/java/current/intro.html">Java Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/dotnet/current/intro.html">.NET Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/nodejs/current/intro.html">Node.js Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/php/current/intro.html">PHP Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/python/current/getting-started.html">Python Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/ruby/current/introduction.html">Ruby Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/rum-js/current/intro.html">Real User Monitoring JavaScript Agent Reference</a></li>
  </ul>
  <li class="dropdown-category">APM extensions</li>
  <ul>
  <li><a href="/guide/en/apm/lambda/current/aws-lambda-arch.html">Monitoring AWS Lambda Functions</a></li>
  <li><a href="/guide/en/apm/attacher/current/apm-attacher.html">Attacher</a></li>
  </ul>
  </ul>
  </div>
  </div>
</div>
<div class="navheader">
<span class="prev">
<a href="logs.html">« Logs</a>
</span>
<span class="next">
<a href="opentracing.html">OpenTracing bridge »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="opentelemetry-bridge"></a>OpenTelemetry bridge<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/api-opentelemetry.asciidoc">edit</a></h1>
</div></div></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Integration with the OpenTelemetry Tracing API was added as experimental in v3.34.0.
Integration with the OpenTelemetry Metrics API was added as experimental in v3.45.0.</p>
</div>
</div>
<p>The Elastic APM OpenTelemetry bridge allows one to use the vendor-neutral
<a href="https://opentelemetry.io/docs/instrumentation/js/" class="ulink" target="_top">OpenTelemetry API</a>
(<a href="https://www.npmjs.com/package/@opentelemetry/api" class="ulink" target="_top"><code class="literal">@opentelemetry/api</code></a>) in
your code, and have the Elastic Node.js APM agent handle those API calls.
This allows one to use the Elastic APM agent for tracing and metrics without any
vendor lock-in to the APM agent&#8217;s own <a class="xref" href="api.html" title="API Reference">public API</a> when adding manual
tracing or custom metrics.</p>
<h3><a id="otel-tracing-api"></a>Using the OpenTelemetry Tracing API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/api-opentelemetry.asciidoc">edit</a></h3>
<p>① First, you will need to add the Elastic APM agent and OpenTelemetry API
dependencies to your project. The minimum required OpenTelemetry API version is
1.0.0; see <a class="xref" href="supported-technologies.html#compatibility-opentelemetry" title="OpenTelemetry">the OpenTelemetry compatibility section</a>
for the current maximum supported API version. For example:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">npm install --save elastic-apm-node @opentelemetry/api</pre>
</div>
<p>② Second, you will need to configure and start the APM agent. This can be done
completely with environment variables (so that there is no need to touch
your application code):</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">export ELASTIC_APM_SERVER_URL='&lt;url of your APM server&gt;'
export ELASTIC_APM_SECRET_TOKEN='&lt;secret token for your APM server&gt;'  # or ELASTIC_APM_API_KEY=...
export ELASTIC_APM_OPENTELEMETRY_BRIDGE_ENABLED=true <a id="CO5-1"></a><i class="conum" data-value="1"></i>
export NODE_OPTIONS='-r elastic-apm-node/start.js'  # Tell node to preload and start the APM agent
node my-app.js</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO5-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Future versions may drop this config var and enable usage of the tracing API by default.</p>
</td>
</tr>
</table>
</div>
<p>Or, alternatively, you can configure and start the APM agent at the top of your
application code:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">require('elastic-apm-node').start({
    serverUrl: '&lt;url of your APM server&gt;',
    secretToken: '&lt;secret token for your APM server&gt;', // or, apiKey: '&lt;your API key&gt;'
    opentelemetryBridgeEnabled: true
});

// Application code ...</pre>
</div>
<p>See <a class="xref" href="configuration.html" title="Configuration options">the full APM agent configuration reference</a> for other configuration options.</p>
<p>③ Finally, you can use the <a href="https://open-telemetry.github.io/opentelemetry-js/modules/_opentelemetry_api.html" class="ulink" target="_top">OpenTelemetry API</a>
for any manual tracing in your code. For example, the following script uses
<a href="https://open-telemetry.github.io/opentelemetry-js/interfaces/_opentelemetry_api.Tracer.html#startActiveSpan" class="ulink" target="_top">Tracer#startActiveSpan()</a>
to trace an outgoing HTTPS request:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">const https = require('https')
const otel = require('@opentelemetry/api')
const tracer = otel.trace.getTracer('trace-https-request')

tracer.startActiveSpan('makeRequest', span =&gt; {
  https.get('https://httpstat.us/200', (response) =&gt; {
    console.log('STATUS:', response.statusCode)
    const body = []
    response.on('data', (chunk) =&gt; body.push(chunk))
    response.on('end', () =&gt; {
      console.log('BODY:', body.toString())
      span.end()
    })
  })
})</pre>
</div>
<p>The APM agent source code repository includes
<a href="https://github.com/elastic/apm-agent-nodejs/tree/main/examples/opentelemetry-bridge" class="ulink" target="_top">some examples using the OpenTelemetry tracing bridge</a>.</p>
<h3><a id="otel-metrics-api"></a>Using the OpenTelemetry Metrics API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/api-opentelemetry.asciidoc">edit</a></h3>
<p>① As above, install the needed dependencies. The minimum required OpenTelemetry
API version is 1.3.0 (the version when metrics were added); see <a class="xref" href="supported-technologies.html#compatibility-opentelemetry" title="OpenTelemetry">the OpenTelemetry compatibility section</a>
for the current maximum supported API version. For example:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">npm install --save elastic-apm-node @opentelemetry/api</pre>
</div>
<p>② Configure and start the APM agent. This can be done completely with
environment variables&#8201;&#8212;&#8201;as shown below&#8201;&#8212;&#8201;or in code. (See <a class="xref" href="starting-the-agent.html" title="Starting the agent">Starting the agent</a>
and <a class="xref" href="configuration.html" title="Configuration options">the full APM agent configuration reference</a> for other
configuration options.)</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">export ELASTIC_APM_SERVER_URL='&lt;url of your APM server&gt;'
export ELASTIC_APM_SECRET_TOKEN='&lt;secret token for your APM server&gt;'  # or ELASTIC_APM_API_KEY=...
export NODE_OPTIONS='-r elastic-apm-node/start.js'  # Tell node to preload and start the APM agent
node my-app.js</pre>
</div>
<p>③ Finally, you can use the OpenTelemetry Metrics API, to
<a href="https://open-telemetry.github.io/opentelemetry-js/interfaces/_opentelemetry_api.Meter.html" class="ulink" target="_top">create metrics</a>
and the APM agent will periodically ship those metrics to your Elastic APM
deployment where you can visualize them in Kibana.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">// otel-metrics-hello-world.js <a id="CO6-1"></a><i class="conum" data-value="1"></i>
const { createServer } = require('http')
const otel = require('@opentelemetry/api')

const meter = otel.metrics.getMeter('my-meter')
const numReqs = meter.createCounter('num_requests', { description: 'number of HTTP requests' })

const server = createServer((req, res) =&gt; {
  numReqs.add(1)
  req.resume()
  req.on('end', () =&gt; {
    res.end('pong\n')
  })
})
server.listen(3000, () =&gt; {
  console.log('listening at http://127.0.0.1:3000/')
})</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO6-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The full example is <a href="https://github.com/elastic/apm-agent-nodejs/blob/main/examples/opentelemetry-metrics/otel-metrics-hello-world.js" class="ulink" target="_top">here</a>.</p>
</td>
</tr>
</table>
</div>
<h4><a id="otel-metrics-sdk"></a>Using the OpenTelemetry Metrics SDK<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/api-opentelemetry.asciidoc">edit</a></h4>
<p>The Elastic APM agent also supports exporting metrics to APM server when the
OpenTelemetry Metrics <span class="strong strong"><strong>SDK</strong></span> is being used directly. You might want to use
the OpenTelemetry Metrics SDK to use a <a href="https://opentelemetry.io/docs/reference/specification/metrics/sdk/#view" class="ulink" target="_top"><code class="literal">View</code></a>
to configure histogram bucket sizes, to setup a Prometheus exporter, or for
other reasons. For example:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">// use-otel-metrics-sdk.js <a id="CO7-1"></a><i class="conum" data-value="1"></i>
const otel = require('@opentelemetry/api')
const { MeterProvider } = require('@opentelemetry/sdk-metrics')
const { PrometheusExporter } = require('@opentelemetry/exporter-prometheus')

const exporter = new PrometheusExporter({ host: '127.0.0.1', port: 3001 })
const meterProvider = new MeterProvider()
meterProvider.addMetricReader(exporter)
otel.metrics.setGlobalMeterProvider(meterProvider)

const meter = otel.metrics.getMeter('my-meter')
const latency = meter.createHistogram('latency', { description: 'Response latency (s)' })
// ...</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO7-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The full example is <a href="https://github.com/elastic/apm-agent-nodejs/blob/main/examples/opentelemetry-metrics/use-otel-metrics-sdk.js" class="ulink" target="_top">here</a>.</p>
</td>
</tr>
</table>
</div>
<h4><a id="otel-metrics-conf"></a>OpenTelemetry Metrics configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/api-opentelemetry.asciidoc">edit</a></h4>
<p>A few configuration options can be used to control OpenTelemetry Metrics support.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Specific metrics names can be filtered out via the <a class="xref" href="configuration.html#disable-metrics" title="disableMetrics"><code class="literal">disableMetrics</code></a> configuration option.
</li>
<li class="listitem">
Integration with the OpenTelemetry Metrics API can be disabled via the <a class="xref" href="configuration.html#disable-instrumentations" title="disableInstrumentations"><code class="literal">disableInstrumentations: '@opentelemetry/api'</code></a> configuration option.
</li>
<li class="listitem">
Integration with the OpenTelemetry Metrics SDK can be disabled via the <a class="xref" href="configuration.html#disable-instrumentations" title="disableInstrumentations"><code class="literal">disableInstrumentations: '@opentelemetry/sdk-metrics'</code></a> configuration option.
</li>
<li class="listitem">
All metrics support in the APM agent can be disabled via the <a class="xref" href="configuration.html#metrics-interval" title="metricsInterval"><code class="literal">metricsInterval: '0s'</code></a> configuration option.
</li>
<li class="listitem">
The default histogram bucket boundaries are different from the OpenTelemetry default, to provide better resolution. The boundaries used by the APM agent can be configured with the <a class="xref" href="configuration.html#custom-metrics-histogram-boundaries" title="customMetricsHistogramBoundaries"><code class="literal">customMetricsHistogramBoundaries</code></a> configuration option.
</li>
</ul>
</div>
<h3><a id="otel-architecture"></a>Bridge architecture<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/api-opentelemetry.asciidoc">edit</a></h3>
<p>The OpenTelemetry Tracing bridge works similarly to the
<a href="https://github.com/open-telemetry/opentelemetry-js/tree/main/packages/opentelemetry-sdk-trace-node/" class="ulink" target="_top">OpenTelemetry Node.js Trace SDK</a>.
It registers Tracer and ContextManager providers with the OpenTelemetry API.
Subsequent <code class="literal">@opentelemetry/api</code> calls in user code will use those providers.
The APM agent translates from OpenTelemetry to Elastic APM semantics and sends
tracing data to your APM server for full support in
<a href="/apm" class="ulink" target="_top">Elastic Observability&#8217;s APM app</a>.</p>
<p>Some examples of semantic translations: The first entry span of a
service (e.g. an incoming HTTP request) will be converted to an
<a href="/guide/en/apm/guide/8.8/data-model-transactions.html" class="ulink" target="_top">Elasic APM <code class="literal">Transaction</code></a>,
subsequent spans are mapped to
<a href="/guide/en/apm/guide/8.8/data-model-spans.html" class="ulink" target="_top">Elastic APM `Span`s</a>. OpenTelemetry Span
attributes are translated into the appropriate fields in Elastic APM&#8217;s data
model.</p>
<p>The only difference, from the user&#8217;s point of view, is in the setup of tracing.
Instead of setting up the OpenTelemetry JS SDK, one sets up the APM agent
as <a class="xref" href="opentelemetry-bridge.html#otel-tracing-api" title="Using the OpenTelemetry Tracing API">described above</a>.</p>
<hr>
<p>The OpenTelemetry Metrics support, is slightly different. If your code uses
just the Metrics <span class="strong strong"><strong>API</strong></span>, then the APM agent provides a full MeterProvider so
that metrics are accumulated and sent to APM server. If your code uses the
Metrics <span class="strong strong"><strong>SDK</strong></span>, then the APM agents adds a MetricReader to your MeterProvider
to send metrics on to APM server. This allows you to use the APM agent as
either an easy setup for using metrics or in conjunction with your existing
OpenTelemetry Metrics configuration.</p>
<h3><a id="otel-caveats"></a>Caveats<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/api-opentelemetry.asciidoc">edit</a></h3>
<p>Not all features of the OpenTelemetry API are supported. This section describes
any limitations and differences.</p>
<h5><a id="otel-caveats-tracing"></a>Tracing<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/api-opentelemetry.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Span Link Attributes. Adding links when <a href="https://open-telemetry.github.io/opentelemetry-js/interfaces/\_opentelemetry_api.Tracer.html" class="ulink" target="_top">starting a span</a> is supported, but any added span link <span class="strong strong"><strong>attributes</strong></span> are silently dropped.
</li>
<li class="listitem">
Span events (<a href="https://open-telemetry.github.io/opentelemetry-js/interfaces/_opentelemetry_api.Span.html#addEvent" class="ulink" target="_top"><code class="literal">Span#addEvent()</code></a>) are not currently supported. Events will be silently dropped.
</li>
<li class="listitem">
<a href="https://open-telemetry.github.io/opentelemetry-js/classes/_opentelemetry_api.PropagationAPI.html" class="ulink" target="_top">Propagating baggage</a> within or outside the process is not supported. Baggage items are silently dropped.
</li>
</ul>
</div>
<h5><a id="otel-caveats-metrics"></a>Metrics<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/api-opentelemetry.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Metrics <a href="https://opentelemetry.io/docs/reference/specification/metrics/data-model/#exemplars" class="ulink" target="_top">exemplars</a> are not supported.
</li>
<li class="listitem">
<a href="https://opentelemetry.io/docs/reference/specification/metrics/data-model/#summary-legacy" class="ulink" target="_top">Summary metrics</a> are not supported.
</li>
<li class="listitem">
<a href="https://opentelemetry.io/docs/reference/specification/metrics/data-model/#exponentialhistogram" class="ulink" target="_top">Exponential Histograms</a> are not yet supported.
</li>
<li class="listitem">
The <code class="literal">sum</code>, <code class="literal">count</code>, <code class="literal">min</code> and <code class="literal">max</code> within the OpenTelemetry histogram data are discarded.
</li>
<li class="listitem">
The default histogram bucket boundaries are different from the OpenTelemetry default. They provide better resolution. They can be configured with the <a class="xref" href="configuration.html#custom-metrics-histogram-boundaries" title="customMetricsHistogramBoundaries"><code class="literal">customMetricsHistogramBoundaries</code></a> configuration option.
</li>
<li class="listitem">
Metrics label names are dedotted (<code class="literal">s/\./_/g</code>) in APM server to avoid possible mapping collisions in Elasticsearch.
</li>
<li class="listitem">
The default <a href="https://github.com/elastic/apm/blob/main/specs/agents/metrics-otel.md#aggregation-temporality" class="ulink" target="_top">Aggregation Temporality</a> used differs from the OpenTelemetry default&#8201;&#8212;&#8201;preferring <span class="strong strong"><strong>delta</strong></span>-temporality (nicer for visualizing in Kibana) to cumulative-temporality.
</li>
</ul>
</div>
<p>Metrics support requires an APM server &gt;=7.11&#8201;&#8212;&#8201;for earlier APM server
versions, metrics with label names including <code class="literal">.</code>, <code class="literal">*</code>, or <code class="literal">"</code> will get dropped.</p>
<h5><a id="otel-caveats-logs"></a>Logs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/3.x/docs/api-opentelemetry.asciidoc">edit</a></h5>
<p>The OpenTelemetry Logs API is currently not support&#8201;&#8212;&#8201;only the Tracing and
Metrics APIs.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="logs.html">« Logs</a>
</span>
<span class="next">
<a href="opentracing.html">OpenTracing bridge »</a>
</span>
</div>
</div>
</body>
</html>
