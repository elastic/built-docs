<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Node.js Agent version 3.x | APM Node.js Agent Reference [master] | Elastic</title>
<link rel="home" href="index.html" title="APM Node.js Agent Reference [master]"/>
<link rel="up" href="release-notes.html" title="Release notes"/>
<link rel="prev" href="release-notes.html" title="Release notes"/>
<link rel="next" href="release-notes-2.x.html" title="Node.js Agent version 2.x"/>
<meta name="DC.type" content="Learn/Docs/APM Node.js Agent/Reference/master"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="master"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">APM Node.js Agent Reference [master]</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="release-notes.html">Release notes</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="release-notes.html">« Release notes</a>
</span>
<span class="next">
<a href="release-notes-2.x.html">Node.js Agent version 2.x »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="release-notes-3.x"></a>Node.js Agent version 3.x<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h2>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_unreleased"></a>Unreleased<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_breaking_changes"></a>Breaking changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<h5><a id="_features"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Support for tracing/monitoring <a href="https://learn.microsoft.com/en-us/azure/azure-functions/" class="ulink" target="_top">Azure Functions</a>.
See the <a class="xref" href="azure-functions.html" title="Monitoring Node.js Azure Functions">Monitoring Node.js Azure Functions</a> document.
(<a href="https://github.com/elastic/apm-agent-nodejs/pull/3071" class="ulink" target="_top">#3071</a>, <a href="https://github.com/elastic/apm/blob/main/specs/agents/tracing-instrumentation-azure-functions.md" class="ulink" target="_top">spec</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<h5><a id="_chores"></a>Chores<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.41.1"></a>3.41.1 2022/12/21<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_bug_fixes_2"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix a bug in span compression with sending spans that were buffered for
possible compression. Before this fix, in some cases a compressible span could
be sent <span class="strong strong"><strong>twice</strong></span> or not sent at all. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3076" class="ulink" target="_top">#3076</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.41.0"></a>3.41.0 2022/12/12<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_2"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Capture HTTP context (status code, headers, etc.) on transactions (and
captured errors) for Lambda functions triggered by API Gateway.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2419" class="ulink" target="_top">#2419</a>)
</li>
<li class="listitem">
Support instrumentation for restify@10.
</li>
</ul>
</div>
<h5><a id="_bug_fixes_3"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Change default <code class="literal">serverUrl</code> from <code class="literal">http://localhost:8200</code> to <code class="literal">http://127.0.0.1:8200</code>
to avoid ambiguity between possible IPv4 and IPv6 DNS-resolved values for "localhost".
APM server only listens on IPv4 by default, so this avoids a possible surprising
mismatch. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/3045" class="ulink" target="_top">#3045</a>)
</li>
<li class="listitem">
Add <code class="literal">tracestate</code> to the <code class="literal">TransactionOptions</code> TypeScript type for
<code class="literal">apm.startTransaction(..., options)</code>. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/3061" class="ulink" target="_top">#3061</a>)
</li>
</ul>
</div>
<h5><a id="_chores_2"></a>Chores<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Mark the published Lambda layer as supporting the recently released
"nodejs18.x" Lambda Runtime (<code class="literal">--compatible-runtimes</code>).
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.40.1"></a>3.40.1 2022/11/15<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_bug_fixes_4"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Prevent a possible tight loop in central config fetching. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/3029" class="ulink" target="_top">#3029</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.40.0"></a>3.40.0 2022/10/31<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_3"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Enable support for redis v4 (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2945" class="ulink" target="_top">#2945</a>)
</li>
<li class="listitem">
<p><span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will apply best effort to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> Next.js server-side instrumentation. See the <a class="xref" href="nextjs.html" title="Get started with Next.js">Get started with Next.js</a> document.</p>
<p>This adds instrumentation of the Next.js dev server (<code class="literal">next dev</code>) and prod
server (<code class="literal">next start</code>). The APM transactions for incoming HTTP requests to the
server will be named appropriately based on Next.js&#8217;s routing&#8201;&#8212;&#8201;both for
user page routes (e.g. <code class="literal">GET /a-dynamic-page/[id]</code>) and for internal Next.js
routes (e.g. <code class="literal">Next.js _next/data route my-page</code>,
<code class="literal">Next.js Rewrite route /foo -&gt; /bar</code>). As well, exceptions in server-side code
(e.g. <code class="literal">getServerSideProps</code>, server-side run page handlers, API handlers) will
be reported. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2959" class="ulink" target="_top">#2959</a>)</p>
<p>This is a technical preview to get feedback from Next.js users. The details on
how exactly the instrumentation works may change in future versions.</p>
</li>
<li class="listitem">
Improve container-info gathering to support AWS ECS/Fargate environments.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2914" class="ulink" target="_top">#2914</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_5"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Source lines of context in stacktraces is <span class="strong strong"><strong>no longer reported</strong></span> for "*.min.js"
files that do not have source-map information. These files are assumed to
be minimized files, for which source line context won&#8217;t be useful. This
change is to guard against excessively large stacktrace data.
</li>
</ul>
</div>
<h5><a id="_chores_3"></a>Chores<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add guards to ensure that a crazy <code class="literal">Cache-Control: max-age=...</code> response
header cannot accidentally result in inappropriate intervals for fetching
central config. The re-fetch delay is clamped to <code class="literal">[5 seconds, 1 day]</code>.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2941" class="ulink" target="_top">#2941</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.39.0"></a>3.39.0 2022/10/17<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_4"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Improve the granularity of data captured about downstream services, e.g.
databases, for spans that represent an external call (known as "exit spans").
This data is used for
<a href="/guide/en/kibana/current/service-maps.html" class="ulink" target="_top">Service Maps</a>
and
<a href="/guide/en/kibana/current/dependencies.html" class="ulink" target="_top">Dependencies</a>
in the Kibana APM app.</p>
<p>This is handled via the new span <code class="literal">service.target.*</code> fields that replace the
deprecated <code class="literal">destination.service.resource</code> field (<a href="https://github.com/elastic/apm/blob/main/specs/agents/tracing-spans-service-target.md" class="ulink" target="_top">spec</a>). All instrumentations have
been updated to set appropriate service target values. If necessary, e.g. for manual
instrumentation, a new public <a class="xref" href="span-api.html#span-setservicetarget" title="span.setServiceTarget(type, name)"><code class="literal">span.setServiceTarget(type, name)</code></a> API has been added to specify these values.
(<a href="https://github.com/elastic/apm-agent-nodejs/pull/2882" class="ulink" target="_top">#2882</a>)</p>
<p>The never-public-but-available <code class="literal">span.setDestinationContext()</code> has been marked
for removal (using it will <code class="literal">process.emitWarning()</code>). Users of this internal
method should switch to the public <a class="xref" href="span-api.html#span-setservicetarget" title="span.setServiceTarget(type, name)"><code class="literal">span.setServiceTarget(type, name)</code></a>.</p>
<p>As part of this change, improvements have been made to some module instrumentations:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">redis</code> and <code class="literal">ioredis</code>: <code class="literal">span.type</code> has changed from "cache" to "db" per <a href="https://github.com/elastic/apm/blob/main/specs/agents/tracing-instrumentation-db.md#redis" class="ulink" target="_top">spec</a>
</li>
<li class="listitem">
<code class="literal">mongodb</code>: <code class="literal">span.action</code> used to be "query", now it will be the mongodb command name, e.g. "find", "insert".
</li>
<li class="listitem">
<code class="literal">mongodb</code> and <code class="literal">mongodb-core</code>: <code class="literal">span.db.instance</code> is now set to the database name (<a href="https://github.com/elastic/apm-agent-nodejs/issues/1494" class="ulink" target="_top">#1494</a>)
</li>
<li class="listitem">
<code class="literal">mysql</code> and <code class="literal">mysql2</code>: <code class="literal">span.db.{instance,user}</code> are now populated.
</li>
<li class="listitem">
<code class="literal">@elastic/elasticsearch</code>: The cluster name is heuristically determined for Elastic Cloud deployments and used for the service target name.
</li>
<li class="listitem">
<code class="literal">sqs</code>: <code class="literal">span.destination.{address,port}</code> are now populated.
</li>
<li class="listitem">
<code class="literal">pg</code>: <code class="literal">span.db.{instance,user}</code> are now populated.
</li>
<li class="listitem">
<code class="literal">cassandra-driver</code>: the Cassandra keyspace is captured for service target data, if available.
</li>
<li class="listitem">
OpenTelemetry Bridge: OTel spans with kind PRODUCER and CLIENT are now handled as exit spans (e.g. span compression could apply).
</li>
</ul>
</div>
</li>
<li class="listitem">
Support instrumentation of <code class="literal">@koa/router</code> (and <code class="literal">koa-router</code>) versions 11 and 12.
Contributed by @sibelius. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2811" class="ulink" target="_top">#2811</a>)
</li>
<li class="listitem">
Support instrumentation of tedious@15. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2897" class="ulink" target="_top">#2897</a>)
</li>
<li class="listitem">
<p>Improve the captured information for Elasticsearch client instrumentation.
For all outgoing Elasticsearch client requests, the full HTTP url is
now captured (stored in the "url.original" field). For Elasticsearch requests
that do a search, the outgoing request body is captured (to the
"span.db.statement" field) as before, but the format has changed to only
hold the request body. Before this change the "span.db.statement" would
also hold any HTTP query parameters. These are now more naturally captured
in "url.original". (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2019" class="ulink" target="_top">#2019</a>)</p>
<p>This change also introduces the <a class="xref" href="configuration.html#elasticsearch-capture-body-urls" title="elasticsearchCaptureBodyUrls"><code class="literal">elasticsearchCaptureBodyUrls</code></a>
configuration option to enable controlling which Elasticsearch REST API
paths are considered for request body capture. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2873" class="ulink" target="_top">#2873</a>)</p>
</li>
<li class="listitem">
Support instrumenting core modules when require&#8217;d with the optional
<a href="https://nodejs.org/api/modules.html#core-modules" class="ulink" target="_top"><em>node:</em>-prefix</a>.
For example <code class="literal">require('node:http')</code> will now be instrumented.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2816" class="ulink" target="_top">#2816</a>)
</li>
<li class="listitem">
Agent will delay loading of the <code class="literal">error-callsites</code> module until agent start time,
and will not load the module if the agent is disabled/inactive. This prevents the
setting of an <code class="literal">Error.prepareStackTrace</code> handler until necessary for stacktrace
collection. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2833" class="ulink" target="_top">#2833</a> <a href="https://github.com/elastic/apm-agent-nodejs/pull/2906" class="ulink" target="_top">#2906</a>)
</li>
<li class="listitem">
Add <code class="literal">*principal*</code> pattern to default value for <code class="literal">sanitizeFieldNames</code> config
var, so that it is more likely to redact authentication-related HTTP headers,
e.g. on Azure. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2938" class="ulink" target="_top">#2938</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_6"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Avoid a possible <code class="literal">RangeError: Maximum call stack size exceeded</code> in
Span timer handler for exceedingly deep Span trees. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2939" class="ulink" target="_top">#2939</a>)
</li>
<li class="listitem">
Fix instrumentation of (very old) <em>graphql</em> module versions &#8656;0.9.6.
Instrumentation of these older graphql versions was broken in v3.36.0.
(<a href="https://github.com/elastic/apm-agent-nodejs/pull/2927" class="ulink" target="_top">#2927</a>)
</li>
</ul>
</div>
<h5><a id="_chores_4"></a>Chores<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Disable knex instrumentation when not collecting span stack traces
(because there is no point). This is a performance improvement for
Knex usage in the default configuration. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2879" class="ulink" target="_top">#2879</a>)
</li>
<li class="listitem">
Document and add types for <code class="literal">parent</code> option to
<a class="xref" href="agent-api.html#apm-capture-error" title="apm.captureError(error[, options][, callback])"><code class="literal">apm.captureError()</code></a>. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2977" class="ulink" target="_top">#2977</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.38.0"></a>3.38.0 2022/08/11<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_5"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add instrumentation for the <a href="https://undici.nodejs.org" class="ulink" target="_top">undici</a> HTTP client
library. This also adds instrumentation of Node.js v18&#8217;s
<a href="https://nodejs.org/api/all.html#all_globals_fetch" class="ulink" target="_top"><code class="literal">fetch()</code></a>, which uses
undici under the hood. For the instrumentation to work one must be using
node v14.17.0 or later, or have installed the
<a href="https://www.npmjs.com/package/diagnostics_channel" class="ulink" target="_top"><em>diagnostics_channel</em> polyfill</a>.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2383" class="ulink" target="_top">#2383</a>)
</li>
<li class="listitem">
Added <code class="literal">exitSpanMinDuration</code> configuration field, allowing end users to
set a time threshold for dropping exit spans. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2843" class="ulink" target="_top">#2843</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_7"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Capturing an error would fail if the Error instance had an attribute that
was an invalid date. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2030" class="ulink" target="_top">#2030</a>)
</li>
<li class="listitem">
Fix the span for an instrumented S3 ListBuckets API call to not be invalid
for APM server intake. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2866" class="ulink" target="_top">#2866</a>)
</li>
<li class="listitem">
Fix an issue where the transaction <code class="literal">name</code> for a trace of a Lambda function
implementing a GraphQL server (e.g. via <a href="https://www.apollographql.com/docs/apollo-server/deployment/lambda/" class="ulink" target="_top">apollo-server-lambda</a>)
would not get the GraphQL-specific naming. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2832" class="ulink" target="_top">#2832</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.37.0"></a>3.37.0 2022/07/18<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_6"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>The agent will now use <a href="https://nodejs.org/api/async_context.html#class-asynclocalstorage" class="ulink" target="_top"><code class="literal">AsyncLocalStorage</code></a>
for run-context tracking in new enough versions of Node.js (versions &gt;=14.5
and &gt;=12.19). This can reduce overhead from using the APM agent, especially in
Promise-heavy applications. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2786" class="ulink" target="_top">#2786</a>)</p>
<p>This also adds a new <a class="xref" href="configuration.html#context-manager" title="contextManager"><code class="literal">contextManager</code></a> configuration option
to control which mechanism the agent uses for run-context tracking. It replaces
the, now deprecated, <a class="xref" href="configuration.html#async-hooks" title="asyncHooks"><code class="literal">asyncHooks</code></a> configuration option. If
you experience problems with the new AsyncLocalStorage-based tracking, you can
restore the older behavior with <code class="literal">contextManager: "asynchooks"</code>.</p>
</li>
</ul>
</div>
<h5><a id="_chores_5"></a>Chores<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The old "patch" mechanism that the APM agent uses for run-context tracking
(enabled via <a class="xref" href="configuration.html#context-manager" title="contextManager"><code class="literal">contextManager: "patch"</code></a>, or previously
enabled via <code class="literal">asyncHooks: false</code>) is now <span class="strong strong"><strong>deprecated</strong></span>. It will be removed in a
future major version (after an 18 month deprecation period).
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.36.0"></a>3.36.0 2022/06/15<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_7"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Adds <a href="https://github.com/elastic/apm/blob/main/specs/agents/handling-huge-traces/tracing-spans-dropped-stats.md" class="ulink" target="_top">dropped span statistics</a>
to transaction payloads allowing APM Server to calculate more accurate
throughput metrics. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2302" class="ulink" target="_top">#2302</a>)
</li>
<li class="listitem">
Improve the grouping of captured API errors from <code class="literal">@elastic/elasticsearch</code>
instrumentation. When an Elasticsearch client API error is captured, if
the response body includes a <code class="literal">error.type</code>, e.g. <code class="literal">illegal_argument_exception</code>,
the captured <code class="literal">error.exception.type</code> will be <code class="literal">ResponseError (illegal_argument_exception)</code>
rather than <code class="literal">ResponseError</code>. This means that API errors will be grouped
separately in the Kibana APM app based on their client API error type.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2770" class="ulink" target="_top">#2770</a>)
</li>
<li class="listitem">
Graphql v16 support (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2508" class="ulink" target="_top">#2508</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_8"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix the automatic wrapping of Lambda handlers to support handler modules
created by <code class="literal">esbuild</code> bundling&#8201;&#8212;&#8201;as is done in some Serverless Framework
functions that use TypeScript. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2753" class="ulink" target="_top">#2753</a>)
</li>
<li class="listitem">
Fix Express route tracking (used for <code class="literal">transaction.name</code>) when an argument
is passed to the <code class="literal">next(arg)</code> callback of a request handler. Before this
change passing <code class="literal">next(&lt;some object not an instance of Error&gt;)</code> would be
considered an error by Express, but not by the APM agent&#8217;s route
tracking. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2750" class="ulink" target="_top">#2750</a>)
</li>
<li class="listitem">
Updated <code class="literal">sanitizeFieldNames</code> and <code class="literal">ignoreMessageQueues</code> environment variables
to use <code class="literal">ELASTIC_APM_</code> prefix. (previous variable names are still recgonized,
but not documented) (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2636" class="ulink" target="_top">#2636</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.35.0"></a>3.35.0 2022/06/01<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_8"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add support for <em>knex</em> version v0.21 to v1 (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2699" class="ulink" target="_top">#2699</a>).
Note that instrumentation of knex &gt;=0.95.0 is not support when using the
deprecated <a class="xref" href="configuration.html#context-manager" title="contextManager"><code class="literal">contextManager=patch</code></a> configuration option.
</li>
<li class="listitem">
Change the instrumentation of SQS- and SNS-triggered AWS Lambda invocations:
The special-casing of triggers with a <span class="strong strong"><strong>single</strong></span> message/record has been
removed.  That means that instead of a possible continued distributed trace
(if a single received message has a <em>traceparent</em>), a <span class="strong strong"><strong>span link</strong></span> will be
added to the APM transaction for each message with a <em>traceparent</em>.
<code class="literal">transaction.context.message.</code> fields are no longer collected.
(<a href="https://github.com/elastic/apm-agent-nodejs/pull/2708" class="ulink" target="_top">#2708</a>)
</li>
<li class="listitem">
Enable support for ioredis v5 (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2714" class="ulink" target="_top">#2714</a>)
</li>
<li class="listitem">
A Docker image with the APM agent will be published for each release to
<code class="literal">docker.elastic.co/observability/apm-agent-nodejs:VERSION</code>, for example:
<code class="literal">docker.elastic.co/observability/apm-agent-nodejs:3.35.0</code>. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2742" class="ulink" target="_top">#2742</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_9"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fixes automatic Lambda handler wrapping to work with handlers that point to
subfolders (ex. <code class="literal">_HANDLER=path/to/folder.methodName</code>) (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2709" class="ulink" target="_top">#2709</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.34.0"></a>3.34.0 2022/05/26<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_9"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add support for <em>tedious</em> version v10 to v14 (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2517" class="ulink" target="_top">#2517</a>)
</li>
<li class="listitem">
When automatically determining <a class="xref" href="configuration.html#service-name" title="serviceName"><code class="literal">serviceName</code></a> and <a class="xref" href="configuration.html#service-version" title="serviceVersion"><code class="literal">serviceVersion</code></a> by
looking for a "package.json", the agent will now prefer to start looking
from the directory of the script being executed, rather than the current
working directory. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2420" class="ulink" target="_top">#2420</a>)
</li>
<li class="listitem">
Add an experimental <a class="xref" href="opentelemetry-bridge.html" title="OpenTelemetry bridge"><em>OpenTelemetry bridge</em></a>.  Briefly, the OpenTelemetry
Bridge allows one to use the vendor-neutral
<a href="https://opentelemetry.io/docs/instrumentation/js/api/" class="ulink" target="_top">OpenTelemetry Tracing
API</a> (<a href="https://www.npmjs.com/package/@opentelemetry/api" class="ulink" target="_top"><code class="literal">@opentelemetry/api</code></a>)
to manually instrument your code, and have the Elastic Node.js APM agent
handle those API calls. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2641" class="ulink" target="_top">#2641</a>)
</li>
<li class="listitem">
<p>Add <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/overview.md#links-between-spans)" class="ulink" target="_top">Span Links</a> support. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2673" class="ulink" target="_top">#2673</a>)</p>
<p>The <a class="xref" href="transaction-api.html#transaction-start-span" title="transaction.startSpan([name][, type][, subtype][, action][, options])"><code class="literal">transaction.startSpan()</code></a> and
<a class="xref" href="agent-api.html#apm-start-transaction" title="apm.startTransaction([name][, type][, subtype][, action][, options])"><code class="literal">apm.startTransaction()</code></a> public APIs now accept
a <code class="literal">links</code> option for specify links. The OpenTelemetry Bridge also supports
specifying links during span creation (with the limitation that span link
<span class="strong strong"><strong>attributes</strong></span> are not supported).</p>
</li>
<li class="listitem">
Add a <a class="xref" href="configuration.html#trace-continuation-strategy" title="traceContinuationStrategy"><code class="literal">traceContinuationStrategy</code></a> configuration option to allow some
control over how the APM Agent uses incoming trace-context headers for context
propagation. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2592" class="ulink" target="_top">#2592</a>)
</li>
<li class="listitem">
Add span links to AWS SQS messaging spans on <em>ReceiveMessage</em>, one for each
message (up to 1000) which has a <em>traceparent</em> message attribute.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2593" class="ulink" target="_top">#2593</a>)
</li>
<li class="listitem">
Add "nodejs16.x" as one of the compatible runtimes for the Node.js APM agent
Lambda layers now that
<a href="https://aws.amazon.com/blogs/compute/node-js-16-x-runtime-now-available-in-aws-lambda/" class="ulink" target="_top">this runtime is available on AWS</a>.
</li>
</ul>
</div>
<h5><a id="_bug_fixes_10"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fixes a bug where the the agent would not serialize the database context of
a span. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2715" class="ulink" target="_top">#2715</a>)
</li>
<li class="listitem">
Fix a possible crash in span compression handling on a span that was manually
created without a parent span (e.g. if created with a custom <code class="literal">childOf</code>
option). (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2701" class="ulink" target="_top">#2701</a>)
</li>
</ul>
</div>
<h5><a id="_chores_6"></a>Chores<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add a package-lock.json file to ensure repeatable builds of the AWS Lambda
layer and to assist with security issue auditing. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2626" class="ulink" target="_top">#2626</a>)
</li>
<li class="listitem">
Deprecate instrumentation for the legacy "hapi" package. While the APM agent
still supports it, that instrumentation is no longer tested and support
will be dropped in the next major version of the agent. Note that the
"@hapi/hapi" package is still fully supported. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2698" class="ulink" target="_top">#2698</a>)
</li>
<li class="listitem">
Deprecate instrumentation for the obsolete "jade" package. "jade" was renamed
to "pug" in 2015.  While the APM agent still supports "jade", that
instrumentation is no longer tested. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2711" class="ulink" target="_top">#2711</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.33.0"></a>3.33.0 2022/05/05<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_10"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Add a <code class="literal">parent</code> option to <code class="literal">agent.captureError(err[, options][, cb])</code> to allow
passing in a Transaction or Span to use as the parent for the error. Before
this change the <span class="strong strong"><strong>current</strong></span> span or transaction, if any, was always used.</p>
<p>This option is not documented in the user docs, nor added to the TypeScript
types, because it is only expected to be useful for coming OTel Bridge work.</p>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_11"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix a possible crash in the instrumentation of an incoming HTTP/2 request: if
the underlying Http2Session was destroyed before the APM transaction was
ended (on Http2Stream end). This resulted in the instrumentation using the
[<code class="literal">stream.session.socket</code>](<a href="https://nodejs.org/api/http2.html#http2sessionsocket" class="ulink" target="_top">https://nodejs.org/api/http2.html#http2sessionsocket</a>)
proxy, which can throw <code class="literal">ERR_HTTP2_SOCKET_UNBOUND</code> after the session is
destroyed. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2670" class="ulink" target="_top">#2670</a>)
</li>
</ul>
</div>
<h5><a id="_chores_7"></a>Chores<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The release process is slightly changed. CI (Jenkins) now handles <code class="literal">npm
publish ...</code> when a tag is pushed. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2667" class="ulink" target="_top">#2667</a>)
</li>
<li class="listitem">
Pulled the <code class="literal">traceparent</code> NPM module into a local module and replaced the
<code class="literal">random-poly-fill</code> module with the built in <code class="literal">require('crypto').randomFillSync</code>
function call (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2669" class="ulink" target="_top">#2669</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.32.0"></a>3.32.0 2022/04/27<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_11"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add support for node v18. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2652" class="ulink" target="_top">#2652</a>)
</li>
<li class="listitem">
<p>Add support for <a href="https://github.com/elastic/apm/blob/main/specs/agents/handling-huge-traces/tracing-spans-compress.md" class="ulink" target="_top">span compression</a>.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2100" class="ulink" target="_top">#2100</a>, <a href="https://github.com/elastic/apm-agent-nodejs/issues/2604" class="ulink" target="_top">#2604</a>)</p>
<p>By default, consecutive (sibling) exit spans of the same name, type, subtype,
and destination with a duration of less than 50ms will be compressed into
a single composite span. A possible case is the
<a href="https://duckduckgo.com/?q=N%252B1+query+problem" class="ulink" target="_top">N+1 query problem</a>.
Traces with many consecutive matching spans will be represented&#8201;&#8212;&#8201;both in data
and the APM UI&#8201;&#8212;&#8201;more efficiently.</p>
<p>Span compression can be disabled or matching behavior configured with the
<a class="xref" href="configuration.html#span-compression-enabled" title="spanCompressionEnabled"><code class="literal">spanCompression* configuration options</code></a>.</p>
</li>
<li class="listitem">
Marks spans as "exit spans" across all instrumentations, preventing additional
child spans from being added to the exit spans.  See issue for a full list of
spans types that will be treated as exit spans. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2601" class="ulink" target="_top">#2601</a>)
</li>
<li class="listitem">
Allow a new span to be created/started even if its transaction has ended.
This is expected to be a very rare use case. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2653" class="ulink" target="_top">#2653</a>)
</li>
<li class="listitem">
The Trace Context headers are now propagated for http2 requests. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2656" class="ulink" target="_top">#2656</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.31.0"></a>3.31.0 2022/03/23<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_12"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add <code class="literal">captureBody</code> support for Hapi. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/1905" class="ulink" target="_top">#1905</a>)
</li>
<li class="listitem">
If a SNS or SQS single event trigger to an instrumented Lambda function
includes message attributes with the name "traceparent" (and "tracestate"),
case-insensitive, then those are used to continue the trace. This was already
being done for API Gateway event headers.
</li>
</ul>
</div>
<h5><a id="_bug_fixes_12"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix a bug with Lambda instrumentation where the APM agent would result in
an otherwise working Lambda function to respond with <code class="literal">null</code> if the Lambda
was missing the <a href="https://github.com/elastic/apm-aws-lambda" class="ulink" target="_top">Elastic APM Lambda Extension</a>.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2598" class="ulink" target="_top">#2598</a>)
</li>
<li class="listitem">
Fix a bug in Lambda instrumentation in the capturing of SNS and SQS event
message attributes. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2605" class="ulink" target="_top">#2605</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.30.0"></a>3.30.0 2022/03/10<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_breaking_changes_2"></a>Breaking changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Added a new config option <a class="xref" href="configuration.html#span-stack-trace-min-duration" title="spanStackTraceMinDuration"><code class="literal">spanStackTraceMinDuration</code></a>
that replaces both <a class="xref" href="configuration.html#capture-span-stack-traces" title="captureSpanStackTraces"><code class="literal">captureSpanStackTraces</code></a>
and <a class="xref" href="configuration.html#span-frames-min-duration" title="spanFramesMinDuration"><code class="literal">spanFramesMinDuration</code></a>. The latter two are
now deprecated, but still supported. If <code class="literal">spanStackTraceMinDuration</code> is
specified, then any value for the deprecated two options will be ignored.</p>
<p>There is a significant change in <em>default</em> behavior of the APM agent. If none
of these configuration options is specified, then the default
(<code class="literal">spanStackTraceMinDuration: -1</code>) is that stack traces are <span class="strong strong"><strong>not</strong></span> collected
and reported for any spans. This change in default behavior was made because
the CPU performance impact of collecting span stack traces was found to be
too high in practice for busy and/or complex applications. This is mentioned
in the "Breaking changes" section to highlight the change, but it is not
considered breaking in general. The impact is that the "Stack Trace" tab in
the "Span details" view in the Kibana APM app will be empty. This was already
the case for some spans based on span duration. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2565" class="ulink" target="_top">#2565</a>)</p>
</li>
<li class="listitem">
<p>Implement the explicit signaling of Lambda invocation completion to the
Elastic AWS Lambda Extension. This improves data flushing in a Lambda
environment to ensure tracing data is only sent when the Lambda is active.
This avoids possible tracing data loss while a Lambda VM is frozen.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2485" class="ulink" target="_top">#2485</a>)</p>
<p>However, because this change triggers a bug in the extension, this version of
the APM Node.js Agent must only be used with versions of the
<a class="xref" href="lambda.html" title="Monitoring AWS Lambda Node.js Functions">AWS Lambda Extension</a>
after v0.0.3.</p>
</li>
</ul>
</div>
<h5><a id="_features_13"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add <code class="literal">faas.name</code> and <code class="literal">faas.version</code> fields to Lambda transactions. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2587" class="ulink" target="_top">#2587</a>)
</li>
<li class="listitem">
Added automatic wrapping of AWS Lambda handlers (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2577" class="ulink" target="_top">#2577</a>)
</li>
<li class="listitem">
Improvements to AWS Lambda instrumentation: Better <code class="literal">transaction.name</code> for
API Gateway-triggered lambdas. Respect explicitly set <code class="literal">serviceName</code>,
<code class="literal">serviceVersion</code>, and <code class="literal">usePathAsTransactionName</code> config settings. Default
<code class="literal">cloudProvider: none</code> and <code class="literal">centralConfig: false</code> to reduce required
environment variables for setting up APM instrumentation of Lambdas.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2531" class="ulink" target="_top">#2531</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.29.0"></a>3.29.0 2022/02/10<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix a bug in instrumentation of <code class="literal">@elastic/elasticsearch</code> that caused a
memory leak. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2569" class="ulink" target="_top">#2569</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.28.0"></a>3.28.0 2022/02/08<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<p>Known issue: This release includes a memory leak in instrumentation of the
<code class="literal">@elastic/elasticsearch</code> package. If you use that package, you should not
use v3.28.0 of this APM agent. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2569" class="ulink" target="_top">#2569</a>)</p>
<h5><a id="_breaking_changes_3"></a>Breaking changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<p>The following changes are not considered <span class="strong strong"><strong>breaking</strong></span>. However, they result in
a change in behavior and trace output that might impact some users, so they
are highlighted here.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Change the <code class="literal">redis</code> and <code class="literal">mysql</code> instrumentations to not patch at all if
they are listed in <a class="xref" href="configuration.html#disable-instrumentations" title="disableInstrumentations"><code class="literal">disableInstrumentations</code></a>.
This means that an application that uses one of these packages <span class="strong strong"><strong>and</strong></span> lists
that package in <code class="literal">disableInstrumentations</code> could see changes in the async
run-context of callbacks.  See <a href="https://github.com/elastic/apm-agent-nodejs/issues/2498" class="ulink" target="_top">#2498</a> and the
<a class="xref" href="release-notes-3.x.html#release-notes-3.26.0" title="3.26.0 2021/12/07">v3.26.0 release notes</a> which has a similar change.
</li>
<li class="listitem">
<p>Elasticsearch spans (from <code class="literal">elasticsearch</code>, <code class="literal">@elastic/elasticsearch</code>, and
<code class="literal">@elastic/elasticsearch-canary</code> instrumentation) will no longer have an HTTP
child span(s) for the underlying HTTP request. This is listed in this section
to provide awareness in case some users have custom analysis of APM trace
data that expects those HTTP spans.</p>
<p>Per <a href="https://github.com/elastic/apm/blob/main/specs/agents/tracing-spans.md#exit-spans" class="ulink" target="_top">the APM Agent spec for exit spans</a>,
Elasticsearch spans are now marked as exit spans and as a result, HTTP child
spans are suppressed. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2000" class="ulink" target="_top">#2000</a>)</p>
<p>As part of this change, some HTTP context has been added to Elasticsearch
spans, when available: the HTTP response <code class="literal">status_code</code>, and the size of the
response body (<code class="literal">encoded_body_size</code>). (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2484" class="ulink" target="_top">#2484</a>)</p>
</li>
</ul>
</div>
<h5><a id="_features_14"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Drop unsampled transactions when sending to APM Server v8.0+. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2455" class="ulink" target="_top">#2455</a>)
</li>
<li class="listitem">
The default <a class="xref" href="configuration.html#service-name" title="serviceName"><code class="literal">serviceName</code></a> string (when it is not configured
and cannot be inferred from a "package.json" file) has been changed from
"nodejs_service" to "unknown-nodejs-service". This is a standardized pattern
used across Elastic APM agents to allow the Kibana APM app to recognize when
to provide help to the user on configuring the service name.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2491" class="ulink" target="_top">#2491</a>)
</li>
<li class="listitem">
Add <code class="literal">transaction.name</code> to captured APM errors. This will allow the Kibana APM
app to correlate error groups and transaction groups. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2456" class="ulink" target="_top">#2456</a>)
</li>
<li class="listitem">
Mark S3 spans (from <em>aws-sdk</em> instrumentation) as exit spans (per
<a href="https://github.com/elastic/apm/blob/main/specs/agents/tracing-spans.md#exit-spans" class="ulink" target="_top">https://github.com/elastic/apm/blob/main/specs/agents/tracing-spans.md#exit-spans</a>).
The result is that HTTP child spans of S3 spans are no longer captured.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2125" class="ulink" target="_top">#2125</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_13"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fixes for run context handling for <em>@elastic/elasticsearch</em> instrumentation.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>)
</li>
<li class="listitem">
Fixes for run context handling for <em>cassandra-driver</em> instrumentation.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>)
</li>
<li class="listitem">
Fixes for run context handling for <em>mongodb-core</em> instrumentation.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>)
</li>
<li class="listitem">
Fixes for run context handling for <em>elasticsearch</em> instrumentation.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.27.0"></a>3.27.0 2022/01/17<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_15"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add support for express-graphql 0.10.0 - 0.12.0 inclusive. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2511" class="ulink" target="_top">#2511</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_14"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Fix an issue where the agent&#8217;s async task tracking could cause the user&#8217;s
application to use too much memory. In cases where an application is under
sustained load and is running in a memory constrained container, this looked
like a memory leak.</p>
<p>This high memory usage could happen when application code starts async tasks
(e.g. Promises, setTimeouts, async I/O) that outlive the APM Transaction
(typically an HTTP request handler). The agent&#8217;s async task tracking keeps a
reference to the APM Transaction (and any APM Spans) until the async task
ends, thus extending the lifetime of those APM objects and the references
they hold&#8201;&#8212;&#8201;in particular, HTTP request and response objects. This could lead
to higher memory usage.</p>
<p>With this change, those references are removed when APM Transactions and Spans
are ended, and agent memory usage is now the same as what it was before
v3.24.0 when this issue was introduced. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2528" class="ulink" target="_top">#2528</a>, <a href="https://github.com/elastic/apm-agent-nodejs/issues/2489" class="ulink" target="_top">#2489</a>)</p>
</li>
<li class="listitem">
Fixes for run context handling for <em>graphql</em> instrumentation.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>)
</li>
<li class="listitem">
Fixes for run context handling for DynamoDB instrumentation (<em>aws-sdk</em>
package) so that a span created after an AWS client command (in the same
tick, in the command callback, or promise) is not a child of the automatic
AWS span. This change also ensures captured errors from failing client
commands are a child of the AWS span. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>)
</li>
<li class="listitem">
Fixes for run context handling for <em>pg</em> instrumentation. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>)
</li>
<li class="listitem">
Fixes for run context handling for <em>mongodb</em> instrumentation. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2512" class="ulink" target="_top">#2512</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.26.0"></a>3.26.0 2021/12/07<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_breaking_changes_4"></a>Breaking changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
In earlier versions, the agent would propagate run context in some packages
<span class="strong strong"><strong>even if instrumentation for that package was disabled via
<a class="xref" href="configuration.html#disable-instrumentations" title="disableInstrumentations"><code class="literal">disableInstrumentations</code></a></strong></span>. Recent versions
change the semantics of <code class="literal">disableInstrumentations</code> to mean the agent should
not touch the listed packages at all. This means that an application that
uses one of these packages <span class="strong strong"><strong>and</strong></span> lists that package in
<code class="literal">disableInstrumentations</code> could see changes in the async run-context of
callbacks. This affects: <code class="literal">pg</code> (v3.24.0), <code class="literal">redis</code> (v3.25.0), <code class="literal">mysql</code>
(v3.25.0), <code class="literal">ioredis</code> (v3.26.0), <code class="literal">mysql2</code> (v3.26.0).  See <a href="https://github.com/elastic/apm-agent-nodejs/issues/2498" class="ulink" target="_top">#2498</a>
for details.
</li>
</ul>
</div>
<h5><a id="_features_16"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add <code class="literal">*auth*</code> pattern to default value for <code class="literal">sanitizeFieldNames</code> config var, so
that it is more likely to redact authentication/authorization-related HTTP
headers and form fields. This pattern replaces the <code class="literal">authorization</code> pattern
in the set of defaults. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2427" class="ulink" target="_top">#2427</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_15"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix run-context handling for <em>tedious</em> instrumentation so that automatically
created <em>mssql</em> spans are never the <code class="literal">currentSpan</code> in user code.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>)
</li>
<li class="listitem">
Fix <em>http2</em> instrumentation for outgoing requests to not have the created
HTTP span context be active in user code. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>)
</li>
<li class="listitem">
Fix run-context handling in <em>ws</em> instrumentation so that the span created
for a <code class="literal">ws.send(...)</code> isn&#8217;t the "current span" in subsequent code in the
same tick. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2481" class="ulink" target="_top">#2481</a>)
</li>
<li class="listitem">
Fix run-context handling for <em>memcached</em> instrumentation so that the
automatically created Memcached span is never the <code class="literal">currentSpan</code> in user
code. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>)
</li>
<li class="listitem">
Fix a possible crash when serializing a Transaction if the incoming
<code class="literal">req.socket</code> is null (possible if the socket has been destroyed).
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2479" class="ulink" target="_top">#2479</a>)
</li>
<li class="listitem">
Fixes for run context handling for <em>aws-sdk</em> instrumentation (S3, SQS, SNS)
so that a span created after an AWS client command (in the same tick, in
the command callback, or promise) is not a child of the automatic AWS
span. This change also ensures captured errors from failing client commands
are a child of the AWS span. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>)
</li>
<li class="listitem">
Fix <em>http</em> and <em>https</em> instrumentation for outgoing requests to not have the
<em>http</em> span context be active in user code. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2470" class="ulink" target="_top">#2470</a>)
</li>
<li class="listitem">
<p>Fixes for <em>ioredis</em> instrumentation (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2460" class="ulink" target="_top">#2460</a>):</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix run-context so that a span created in the same tick as an ioredis
client command will no longer be a child of the redis span.
</li>
<li class="listitem">
Capture an APM error and correctly set span.outcome to "failure" when
a redis client command calls back with an error.
</li>
<li class="listitem">
Avoid a rare possible double-instrumentation of redis commands
internally-queued before the RedisClient is "ready". (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2459" class="ulink" target="_top">#2459</a>)
</li>
<li class="listitem">
Add destination context so Redis shows up on the Service Map.
</li>
</ul>
</div>
</li>
<li class="listitem">
Fix run-context handling for <em>mysql2</em> instrumentation to avoid accidental
creation of <span class="strong strong"><strong>child</strong></span> spans of the automatic mysql spans.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>})
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.25.0"></a>3.25.0 2021/11/24<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_bug_fixes_16"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Fixes for <em>redis</em> instrumentation:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix run-context so that a span created in the same tick as a redis client
command will no longer be a child of the redis span. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>)
</li>
<li class="listitem">
Capture an APM error and correctly set span.outcome to "failure" when
a redis client command calls back with an error.
</li>
<li class="listitem">
Avoid a rare possible double-instrumentation of redis commands
internally-queued before the RedisClient is "ready". (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2446" class="ulink" target="_top">#2446</a>)
</li>
</ul>
</div>
</li>
<li class="listitem">
Avoid setting the <code class="literal">tracestate</code> header for outgoing HTTP requests to the empty
string. This can happen for non-trace-root transactions. While the HTTP spec
allows empty header values, some servers do not. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2405" class="ulink" target="_top">#2405</a>)
</li>
<li class="listitem">
Deprecate <code class="literal">transaction.subtype</code> and <code class="literal">transaction.action</code>. These fields
were never used by APM server. This also deprecates the
<code class="literal">apm.startTransaction(...)</code> call signatures that take <code class="literal">subtype</code> and <code class="literal">action</code>
arguments. In the next major version these two fields will be removed.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2356" class="ulink" target="_top">#2356</a>)
</li>
<li class="listitem">
Fix run-context handling for <em>mysql</em> instrumentation to avoid accidental
creation of <span class="strong strong"><strong>child</strong></span> spans of the automatic <em>mysql</em> spans.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2430" class="ulink" target="_top">#2430</a>})
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.24.0"></a>3.24.0 2021/11/09<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_breaking_changes_5"></a>Breaking changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Change <a class="xref" href="configuration.html#disable-send" title="disableSend"><code class="literal">disableSend</code></a> to no longer skip internal processing
work. It now <span class="strong strong"><strong>only</strong></span> disables communication with APM Server. Use
<a class="xref" href="configuration.html#context-propagation-only" title="contextPropagationOnly"><code class="literal">contextPropagationOnly</code></a> if your use case is
to limit the APM agent&#8217;s processing to the minimum to support context
propagation and log correlation.</p>
<p>This is listed under "Breaking changes" as a heads-up. The only possible
negative result of this <code class="literal">disableSend</code> change is some extra CPU processing time
by the agent. There is no outward functionality change.</p>
</li>
</ul>
</div>
<h5><a id="_features_17"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Gather <a href="https://github.com/elastic/apm/blob/main/specs/agents/tracing-instrumentation-aws-lambda.md#overwriting-metadata" class="ulink" target="_top">AWS Lambda-specific metadata</a>
on first function invocation and ensure no intake requests to APM Server are
started before that metadata is available. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2404" class="ulink" target="_top">#2404</a>)
</li>
<li class="listitem">
<p>Add <a class="xref" href="configuration.html#context-propagation-only" title="contextPropagationOnly"><code class="literal">contextPropagationOnly</code></a> configuration
option. This supports the use case of using the APM agent to propagate HTTP
trace-context and to support log-correlation (adding <code class="literal">trace.id</code> et al fields
to log records) <span class="strong strong"><strong>without</strong></span> an APM server, and to otherwise reduce the
processing time of the agent. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2393" class="ulink" target="_top">#2393</a>)</p>
<p>This is similar to <a class="xref" href="configuration.html#disable-send" title="disableSend"><code class="literal">disableSend</code></a>, but differs in that
<code class="literal">contextPropagationOnly: true</code> tells the agent to skip unnecessary work.</p>
</li>
<li class="listitem">
The User-Agent header used for communication with APM Server now includes
the <code class="literal">serviceName</code> and <code class="literal">serviceVersion</code>. For some users this can be
<a href="https://github.com/elastic/apm/issues/509" class="ulink" target="_top">helpful for APM Server log analysis</a>.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2364" class="ulink" target="_top">#2364</a>)
</li>
<li class="listitem">
In a Lambda enviornment we now collect a number of additional data fields
on the Transaction object.  See the spec for more information on fields collected.
<a href="https://github.com/elastic/apm/blob/main/specs/agents/tracing-instrumentation-aws-lambda.md" class="ulink" target="_top">https://github.com/elastic/apm/blob/main/specs/agents/tracing-instrumentation-aws-lambda.md</a>
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2156" class="ulink" target="_top">#2156</a>)
</li>
<li class="listitem">
<p>Zero configuration support. The only required agent configuration option
is <a class="xref" href="configuration.html#service-name" title="serviceName"><code class="literal">serviceName</code></a>. Normally the agent will attempt to
infer <code class="literal">serviceName</code> for the "name" field in a package.json file. However,
that could fail. With this version, the agent will cope with: a scoped
package name (<code class="literal">@scope/name</code> is normalized to <code class="literal">scope-name</code>), a "name" that
isn&#8217;t a valid <code class="literal">serviceName</code>, not being able to find a "package.json" file,
etc. Ultimately it will fallback to "nodejs_service". (<a href="https://github.com/elastic/apm-agent-nodejs/issues/1944" class="ulink" target="_top">#1944</a>)</p>
<p>One consequence of this change is that <code class="literal">apm.getServiceName()</code> will return
<code class="literal">undefined</code> until the agent is started (check with <code class="literal">apm.isStarted()</code>).</p>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_17"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Stop collecting transaction breakdown metrics (<code class="literal">transaction.breakdown.count</code>,
<code class="literal">transaction.duration.sum.us</code>, <code class="literal">transaction.duration.count</code>), as they are not
being used in APM UI. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2370" class="ulink" target="_top">#2370</a>)
</li>
<li class="listitem">
Wrap <code class="literal">fs.realpath.native</code> when configured with <code class="literal">asyncHooks=false</code>. This
fixes using that function (which was undefined before this fix) and a
crash when importing fs-extra@10. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2401" class="ulink" target="_top">#2401</a>)
</li>
<li class="listitem">
<p>A significant change was made to internal run context tracking (a.k.a. async
context tracking). There are no configuration changes or API changes for
custom instrumentation. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2181" class="ulink" target="_top">#2181</a>)</p>
<p>One behavior change is that multiple spans created synchronously (in the same
async task) will form parent/child relationships; before this change they would
all be siblings. This fixes HTTP child spans of Elasticsearch and aws-sdk
automatic spans to properly be children. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/1889" class="ulink" target="_top">#1889</a>)</p>
<p>Another behavior change is that a span B started after having ended span A in
the same async task will <span class="strong strong"><strong>no longer</strong></span> be a child of span A. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/1964" class="ulink" target="_top">#1964</a>)</p>
<p>This fixes an issue with context binding of EventEmitters, where
<code class="literal">removeListener</code> would fail to actually remove if the same handler function was
added to multiple events.</p>
</li>
<li class="listitem">
Fix pino&#8217;s deprecation warning when using a custom logger with pino@6 (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2332" class="ulink" target="_top">#2332</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.23.0"></a>3.23.0 2021/10/25<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_breaking_changes_6"></a>Breaking changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Remove support for instrumenting versions of fastify earlier than 1.0.0.
This instrumentation might still work, but is no longer supported.
Fastify v1.0.0 was released in 2018. All current users should be using
fastify v2 or v3 at least. See <a href="https://www.fastify.io/docs/latest/LTS/" class="ulink" target="_top">https://www.fastify.io/docs/latest/LTS/</a>
(<a href="https://github.com/elastic/apm-agent-nodejs/pull/2387" class="ulink" target="_top">#2387</a>)
</li>
</ul>
</div>
<h5><a id="_features_18"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add initial support for version 8 of <code class="literal">@elastic/elasticsearch</code>, which is
still in pre-release. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2385" class="ulink" target="_top">#2385</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.22.0"></a>3.22.0 2021/10/21<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_19"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add support for node v17.
</li>
<li class="listitem">
When an error is captured, the APM agent will only immediately flush it to
APM server if it is an "unhandled" error. Unhandled errors are typically those
captured via the <code class="literal">uncaughtException</code> process event. Before this change, a
captured error (e.g. for a 4xx or 5xx response from an HTTP server) was
always immediately flushed. This could negatively impact performance for
a service that was generating <span class="strong strong"><strong>frequent</strong></span> errors. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/686" class="ulink" target="_top">#686</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_18"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Improve <a class="xref" href="agent-api.html#apm-flush" title="apm.flush([callback])"><code class="literal">apm.flush([cb])</code></a> to wait for inflight spans and errors
before flushing data to APM server. Before this change, a recently ended span
or recently <a class="xref" href="agent-api.html#apm-capture-error" title="apm.captureError(error[, options][, callback])">captured error</a> might not yet have completed
processing (for example, stacktrace collection is asynchronous) and might
not be included in the flush call. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2294" class="ulink" target="_top">#2294</a>)
</li>
<li class="listitem">
AWS Lambda changes: Disable metrics collection during the experimental phase
of (re)implementing Lambda support (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2363" class="ulink" target="_top">#2363</a>). Some fixes for better
flushing of data at the end of a Lambda invocation.
</li>
<li class="listitem">
<a class="xref" href="span-api.html#span-to-string" title="span.toString()"><code class="literal">span.toString()</code></a> and <a class="xref" href="transaction-api.html#transaction-to-string" title="transaction.toString()"><code class="literal">transaction.toString()</code></a>
have been <span class="strong strong"><strong>deprecated</strong></span>. The exact string output may change in v4 of the
agent.
</li>
<li class="listitem">
Add <code class="literal">Span.ids</code> and <code class="literal">Transaction.ids</code> to TypeScript types. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2347" class="ulink" target="_top">#2347</a>)
</li>
<li class="listitem">
Improve <code class="literal">span.sync</code> determination (fixes <a href="https://github.com/elastic/apm-agent-nodejs/issues/1996" class="ulink" target="_top">#1996</a>) and stop
reporting <code class="literal">transaction.sync</code> which was never used (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2292" class="ulink" target="_top">#2292</a>).
A minor semantic change is that <code class="literal">span.sync</code> is not set to a final value
until <code class="literal">span.end()</code> is called. Before <code class="literal">span.end()</code> the value will always
by <code class="literal">true</code>.
</li>
<li class="listitem">
<p>Guard against a negative value of <code class="literal">metricsInterval</code>, which can lead to
high CPU usage as metrics are collected as fast as possible. Also ensure
no metrics collection can happen if <code class="literal">metricsInterval="0s"</code> as intended.
Before this change it was possible for some metric collection to still
happen, even though none would be reported. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2330" class="ulink" target="_top">#2330</a>)</p>
<p>This change also guards against negative and invalid values in the following
configuration options: <code class="literal">abortedErrorThreshold</code>, <code class="literal">apiRequestTime</code>, and
<code class="literal">serverTimeout</code>. If an invalid value is given, then will fallback to their
default value.</p>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.21.1"></a>3.21.1 2021/09/16<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_bug_fixes_19"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Update types to avoid imports of <code class="literal">@types/...</code> modules (other than
<code class="literal">@types/node</code>), so that TypeScript users of elastic-apm-node need not
manually <code class="literal">npm install @types/connect @types/pino @types/aws-lambda</code> to
compile. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2331" class="ulink" target="_top">#2331</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.21.0"></a>3.21.0 2021/09/15<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_20"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Add the <code class="literal">longFieldMaxLength</code> integer configuration option (default <code class="literal">10000</code>).
Specific transaction/span/error fields (see the list below) will be truncated
at this number of unicode characters. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2193" class="ulink" target="_top">#2193</a>, <a href="https://github.com/elastic/apm-agent-nodejs/issues/1921" class="ulink" target="_top">#1921</a>)</p>
<p>The <code class="literal">errorMessageMaxLength</code> configuration option is now <span class="strong strong"><strong>deprecated</strong></span>, but
still supported. Users should switch to using <code class="literal">longFieldMaxLength</code>. If
<code class="literal">errorMessageMaxLength</code> is not specified, truncation of error messages will
now use the <code class="literal">longFieldMaxLength</code> value.</p>
<p>Note that ultimately the maximum length of any tracing field is limited by the
<a href="/guide/en/apm/guide/8.6/configuration-process.html#max_event_size" class="ulink" target="_top"><code class="literal">max_event_size</code></a>
configured for the receiving APM server.</p>
<p>The fields affected by <code class="literal">longFieldMaxLength</code> are:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">transaction.context.request.body</code>, <code class="literal">error.context.request.body</code> - Before
this change these fields were not truncated.
</li>
<li class="listitem">
<code class="literal">transaction.context.message.body</code>, <code class="literal">span.context.message.body</code>,
<code class="literal">error.context.message.body</code> - Before this change these fields were not
truncated.
</li>
<li class="listitem">
<code class="literal">span.context.db.statement</code> - Before this change this field was truncated
at 10000 <span class="strong strong"><strong>bytes</strong></span>. Truncation is now a number of unicode characters.
</li>
<li class="listitem">
<code class="literal">error.exception.message</code>, <code class="literal">error.log.message</code> - Before this change, the
default 2kB <code class="literal">errorMessageMaxLength</code> would apply.
</li>
</ul>
</div>
</li>
<li class="listitem">
Improve the TypeScript types by exporting more of interfaces:
<code class="literal">AgentConfigOptions</code>, <code class="literal">Transaction</code>, <code class="literal">Span</code>, <code class="literal">TransactionOptions</code>,
<code class="literal">SpanOptions</code>. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2118" class="ulink" target="_top">#2118</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_20"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix a bug in <code class="literal">apm.removePatch(module, aHandler)</code> that would remove the
last registered handler if <code class="literal">aHandler</code> did not match any currently
registered handlers. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2315" class="ulink" target="_top">#2315</a>)
</li>
<li class="listitem">
Fix a crash in instrumentation of the old Elasticsearch client
(<code class="literal">elasticsearch</code>) for some rarer cases of client options&#8201;&#8212;&#8201;for example
passing multiple hosts. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2312" class="ulink" target="_top">#2312</a>)
</li>
<li class="listitem">
Ensure the internal HTTP(S) client requests made by the APM agent to APM
server are not themselves traced. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/1168" class="ulink" target="_top">#1168</a>, <a href="https://github.com/elastic/apm-agent-nodejs/issues/1136" class="ulink" target="_top">#1136</a>)
</li>
<li class="listitem">
Fix crashing error with <code class="literal">agent.registerMetric</code> and <code class="literal">active:false</code> configuration. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/1799" class="ulink" target="_top">#1799</a>, <a href="https://github.com/elastic/apm-agent-nodejs/pull/2290" class="ulink" target="_top">#2290</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.20.0"></a>3.20.0 2021/08/12<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_bug_fixes_21"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix failing tests and a possible runtime crash in
<code class="literal">@elastic/elasticsearch@7.14.0</code> instrumentation. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2187" class="ulink" target="_top">#2187</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.19.0"></a>3.19.0 2021/08/05<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_21"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The agent now supports the 3.x branch of apollo-server-express. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2155" class="ulink" target="_top">#2155</a>)
</li>
<li class="listitem">
Add instrumentation support for mongodb@4.x. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2171" class="ulink" target="_top">#2171</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_22"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The agent will no longer report counting metrics with a value of zero, and will
remove these metrics from the registry. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2163" class="ulink" target="_top">#2163</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.18.0"></a>3.18.0 2021/07/20<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_22"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Trace an incoming HTTP/1.1 request to an HTTP/2 server using the
<a href="https://nodejs.org/api/http2.html#http2_http2_createsecureserver_options_onrequesthandler" class="ulink" target="_top">allowHTTP1</a>
option. Before this change only incoming requests supporting HTTP/2 would
be traced. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2143" class="ulink" target="_top">#2143</a>)
</li>
<li class="listitem">
Add instrumentation of the AWS SNS publish method when using the
<a href="https://www.npmjs.com/package/aws-sdk" class="ulink" target="_top">JavaScript AWS SDK v2</a> (<code class="literal">aws-sdk</code>). (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2157" class="ulink" target="_top">#2157</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes_23"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fixed naming for outgoing HTTP spans to comply with the spec.
<a href="https://github.com/elastic/apm/blob/main/specs/agents/tracing-instrumentation-http.md#http-client-spans" class="ulink" target="_top">https://github.com/elastic/apm/blob/main/specs/agents/tracing-instrumentation-http.md#http-client-spans</a>
Span names no longer include the path portion of the URL. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2161" class="ulink" target="_top">#2161</a>)
</li>
<li class="listitem">
Fix a header object re-use bug that prevented propagation of trace-context
headers (<code class="literal">traceparent</code> et al) in AWS requests using AWS v4 signature auth.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2134" class="ulink" target="_top">#2134</a>)
</li>
<li class="listitem">
Fix a possible infinite loop in <code class="literal">captureError</code> when handling uncaught
exceptions and the process is at or near its file descriptor limit
(receiving EMFILE errors).  (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2148" class="ulink" target="_top">#2148</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.17.0"></a>3.17.0 2021/07/05<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_23"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add instrumentation of all AWS S3 methods when using the
<a href="https://www.npmjs.com/package/aws-sdk" class="ulink" target="_top">JavaScript AWS SDK v2</a> (<code class="literal">aws-sdk</code>).
</li>
<li class="listitem">
Add <a class="xref" href="configuration.html#disable-send" title="disableSend"><code class="literal">disableSend</code></a> configuration option. This supports some
use cases using the APM agent <span class="strong strong"><strong>without</strong></span> an APM server. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2101" class="ulink" target="_top">#2101</a>)
</li>
<li class="listitem">
Add instrumentation of all DynamoDB methods when using the
<a href="https://www.npmjs.com/package/aws-sdk" class="ulink" target="_top">JavaScript AWS SDK v2</a> (<code class="literal">aws-sdk</code>).
</li>
</ul>
</div>
<h5><a id="_bug_fixes_24"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix inconsistencies in HTTP spans from other APM agents.
<a class="xref" href="span-api.html#span-subtype" title="span.subtype"><code class="literal">span.subtype</code></a> will now be "http" for HTTP, HTTPS, and
HTTP/2 outgoing spans&#8201;&#8212;&#8201;previously it was "http", "https", "http2",
respectively. As well, <a class="xref" href="span-api.html#span-action" title="span.action"><code class="literal">span.action</code></a> will now be the HTTP
method (e.g. "GET", "PUT", "POST"), rather than "http". (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2075" class="ulink" target="_top">#2075</a>)
</li>
<li class="listitem">
Fixed error where SQS messages sent without an active transactions could
crash the agent. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2113" class="ulink" target="_top">#2113</a>)
</li>
<li class="listitem">
Fixed support for proxies in destination context (<a href="https://github.com/elastic/apm-agent-nodejs/issues/1770" class="ulink" target="_top">#1770</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.16.0"></a>3.16.0 - 2021/06/14<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_24"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Added <a class="xref" href="configuration.html#span-frames-min-duration" title="spanFramesMinDuration"><code class="literal">spanFramesMinDuration</code></a>
configuration field, allowing users to set a time threshold value that spans
must reach before the agent will add a stack trace to the span. As a result,
many short spans that previously included stack traces by default no longer
will.
</li>
<li class="listitem">
Prefer W3C "traceparent" header over "elastic-apm-traceparent" for incoming
requests. <a href="https://github.com/elastic/apm-agent-nodejs/pull/2079" class="ulink" target="_top">#2079</a>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_25"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix a crash (<code class="literal">TypeError: lastPrepareStackTrace</code>) in the agent when used with
React v17 and later (<a href="https://github.com/elastic/apm-agent-nodejs/issues/1980" class="ulink" target="_top">#1980</a>).
</li>
<li class="listitem">
<p>Performance improvements have been made in error and stacktrace capture (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2094" class="ulink" target="_top">#2094</a>).
This also included in two bug fixes:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Before this change, some captured errors (for example a <code class="literal">next(new Error('boom')</code> from
an Express handler) would mark the error as "unhandled" incorrectly. "Unhandled"
exceptions are those caught by an <code class="literal">uncaughtException</code> handler.
</li>
<li class="listitem">
Before this change, source context lines for a stacktrace would not properly
use the "sourcesContext" field of a file&#8217;s source map.
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.15.0"></a>3.15.0 - 2021/05/19<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_25"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add support for Node.js v16. (This also drops testing of Node.js v13
releases.) <a href="https://github.com/elastic/apm-agent-nodejs/pull/2055" class="ulink" target="_top">#2055</a>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_26"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Update TypeScript typings for <code class="literal">Agent.setLabel</code> and <code class="literal">Agent.addLabels</code> to
include the <code class="literal">stringify</code> argument that was added in v3.11.0.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.14.0"></a>3.14.0 - 2021/04/19<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_26"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add <code class="literal">apm.addMetadataFilter(fn)</code> for filtering the
<a href="/guide/en/apm/server/current/metadata-api.html" class="ulink" target="_top">metadata object</a>
sent to APM server.
</li>
<li class="listitem">
<p>The handling of sending events (transactions, spans, errors) to APM server
has improved in a few ways. During temporary spikes in load and/or an APM
server that is unresponsive, the agent will buffer a number of events and
<span class="strong strong"><strong>drop</strong></span> them above a certain limit (configurable via <a class="xref" href="configuration.html#max-queue-size" title="maxQueueSize"><code class="literal">maxQueueSize</code></a>).
This helps ensure the agent does not overly consume memory and CPU. As well,
the agent will now <a href="https://github.com/elastic/apm/blob/main/specs/agents/transport.md#transport-errors" class="ulink" target="_top">backoff</a>
when the APM server errors. Finally, improved error handling means it will
terminate failing requests to the APM server more quickly.</p>
<p>Note: v1 of this agent (EOL&#8217;d 2 years ago), included a <code class="literal">maxQueueSize</code> config
variable with a different meaning. If you have a lingering usage of that
setting (also possibly as the <code class="literal">ELASTIC_APM_MAX_QUEUE_SIZE</code> environment
variable), then it should be removed.</p>
</li>
<li class="listitem">
Adds support for Amazon SQS queues via <code class="literal">aws-sdk</code> instrumentation that
partially implements the <a href="https://github.com/elastic/apm/blob/main/specs/agents/tracing-instrumentation-messaging.md" class="ulink" target="_top">APM messaging spec</a>,
and adds <code class="literal">queue.latency.min.ms</code>, <code class="literal">queue.latency.max.ms</code>, and <code class="literal">queue.latency.avg.ms</code>
metrics for SQS queues.
</li>
</ul>
</div>
<h5><a id="_bug_fixes_27"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fixed bug where the URL property for outgoing HTTP request spans was set
with the server&#8217;s IP address rather than its hostname. The Agent now sets
this property with the actual URL requested by Node.js. <a href="https://github.com/elastic/apm-agent-nodejs/issues/2035" class="ulink" target="_top">#2035</a>
</li>
<li class="listitem">
Fixed bug where external services were not listed under Dependencies on the
APM Service Overview page due to the trace-context propagated <code class="literal">sample_rate</code>
value not being set on either transactions or spans.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.13.0"></a>3.13.0 - 2021/04/06<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_27"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>The APM agent&#8217;s own internal logging now uses structured JSON logging using
the <a href="https://getpino.io/#/docs/api?id=logger" class="ulink" target="_top">pino API</a>, and formatted in
<a href="/guide/en/ecs-logging/overview/master/intro.html" class="ulink" target="_top">ecs-logging</a> format. The log records on stdout
are now single-line JSON objects. For example:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash"># Before
APM Server transport error (ECONNREFUSED): connect ECONNREFUSED 127.0.0.1:8200

# After
{"log.level":"error","@timestamp":"2021-03-19T00:21:17.571Z","log":{"logger":"elastic-apm-node"},
"ecs":{"version":"1.6.0"},"message":"APM Server transport error (ECONNREFUSED): connect ECONNREFUSED 127.0.0.1:8200"}</pre>
</div>
<p>Pretty formatting (and filtering) on the console may be done via the
<a href="https://github.com/trentm/go-ecslog" class="ulink" target="_top"><code class="literal">ecslog</code></a> tool.</p>
<p>A custom <a class="xref" href="configuration.html#logger" title="logger"><code class="literal">logger</code></a> is still supported as before. However, a non-pino custom
logger will only receive the "message" field, and not structured log fields
as they are added over time.</p>
</li>
<li class="listitem">
Add support for setting the <code class="literal">ELASTIC_APM_LOGGER=false</code> environment variable
to disable/ignore a given custom <a class="xref" href="configuration.html#logger" title="logger"><code class="literal">logger</code></a>. This is to support easier
<a class="xref" href="troubleshooting.html#debug-mode" title="Debug mode">Debug mode</a> for troubleshooting.
</li>
</ul>
</div>
<h5><a id="_bug_fixes_28"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Lock package dependency "elastic-apm-http-client@9.6.0" to avoid using
v9.7.0 for now, because it is breaking tests. A coming release will get back
on the latest of this dependency. <a href="https://github.com/elastic/apm-agent-nodejs/issues/2032" class="ulink" target="_top">#2032</a>
</li>
<li class="listitem">
Remove the "ancestors" field from a log.trace message on startup. Its info
is a duplicate of info in the "startTrace" field in the same log record.
<a href="https://github.com/elastic/apm-agent-nodejs/pull/2005" class="ulink" target="_top">#2005</a>
</li>
<li class="listitem">
Remove the accidental <code class="literal">nodejs.eventloop.delay.ns</code> metric that was always
reporting a zero value. The existing <code class="literal">nodejs.eventloop.delay.avg.ms</code> is
the intended metric. <a href="https://github.com/elastic/apm-agent-nodejs/pull/1993" class="ulink" target="_top">#1993</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.12.1"></a>3.12.1 - 2021/02/25<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_bug_fixes_29"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix: Update <a href="https://github.com/elastic/apm-nodejs-http-client/blob/main/CHANGELOG.md#v951" class="ulink" target="_top">apm-server client</a>
to fix a <a href="https://github.com/elastic/apm-agent-nodejs/issues/1749" class="ulink" target="_top">possible crash</a> when polling for central config.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.12.0"></a>3.12.0 - 2021/02/21<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_28"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: Set span outcome to success or failure depending on whether an error
was captured during when the span was active. <a href="https://github.com/elastic/apm-agent-nodejs/issues/1814" class="ulink" target="_top">#1814</a>
</li>
<li class="listitem">
feat: Adds public <code class="literal">setOutcome</code> method to span and transaction APIs, and
adds a top level <code class="literal">setTransactionOutcome</code> and <code class="literal">setSpanOutcome</code> to set
outcome values for the current active transaction or active span.
</li>
<li class="listitem">
Limit the <code class="literal">transactionSampleRate</code> value to 4 decimal places of precision
according to the shared <a href="https://github.com/elastic/apm/blob/main/specs/agents/tracing-sampling.md#transaction_sample_rate-configuration" class="ulink" target="_top">APM spec</a>. This ensures that propagated sampling rate
in the <code class="literal">tracestate</code> header is short and consistent. <a href="https://github.com/elastic/apm-agent-nodejs/pull/1979" class="ulink" target="_top">#1979</a>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_30"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix: It was possible for fetching central config to result in the
<code class="literal">cloudProvider</code> config value being reset to its default. <a href="https://github.com/elastic/apm-agent-nodejs/issues/1976" class="ulink" target="_top">#1976</a>
</li>
<li class="listitem">
fix: fixes bug where tedious could crash the agent on bulk inserts <a href="https://github.com/elastic/apm-agent-nodejs/pull/1935" class="ulink" target="_top">#1935</a><br>
Reported <a href="https://discuss.elastic.co/t/apm-agent-crashes-nodejs-after-reporting-exception-in-tedious-instrumentation-code/259851" class="ulink" target="_top">via the forum</a>.
The error symptom was: <code class="literal">Cannot read property 'statement' of undefined</code>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.11.0"></a>3.11.0 - 2021/02/08<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_29"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: add <code class="literal">apm.getServiceName()</code> <a href="https://github.com/elastic/apm-agent-nodejs/pull/1949" class="ulink" target="_top">#1949</a><br>
This will be used by <a href="https://github.com/elastic/ecs-logging-nodejs" class="ulink" target="_top">ecs-logging packages</a>
to integrate with APM.
</li>
<li class="listitem">
feat: support numeric and boolean labels <a href="https://github.com/elastic/apm-agent-nodejs/pull/1909" class="ulink" target="_top">#1909</a><br>
Add an optional <code class="literal">stringify</code> option to <code class="literal">apm.setLabel(name, version, stringify = true)</code>
and <code class="literal">apm.addLabels(labels, stringify = true)</code>, which can be set <code class="literal">false</code> to
allow numeric and boolean labels. Stringify defaults to true for backwards
compatibility&#8201;&#8212;&#8201;stringification will be removed in a future major version.
</li>
<li class="listitem">
feat: added support for cloud metadata fetching <a href="https://github.com/elastic/apm-agent-nodejs/pull/1937" class="ulink" target="_top">#1937</a><br>
Agent now collects information about its cloud environment and includes this
data in the APM Server&#8217;s metadata payload. See
<a href="https://github.com/elastic/apm/blob/3acd10afa0a9d3510e819229dfce0764133083d3/specs/agents/metadata.md#cloud-provider-metadata" class="ulink" target="_top">the spec</a>
for more information.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.10.0"></a>3.10.0 - 2021/01/11<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_30"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: Improve handling of raw body parsing
The agent will now report raw/<code class="literal">Buffer</code> encoded post bodies as <em>&lt;Buffer&gt;</em>.
</li>
<li class="listitem">
feat: Add support for api keys <a href="https://github.com/elastic/apm-agent-nodejs/pull/1818" class="ulink" target="_top">#1818</a><br>
This allows the usage of API keys for authentication to the APM server
</li>
<li class="listitem">
<p>feat: Add automatic instrumentation of the <a href="https://github.com/elastic/elasticsearch-js" class="ulink" target="_top">@elastic/elasticsearch</a> package <a href="https://github.com/elastic/apm-agent-nodejs/pull/1877" class="ulink" target="_top">#1870</a></p>
<p>The instrumentation of the legacy "elasticsearch" package has also changed
slightly to commonalize:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
"span.context.destination" is set on all Elasticsearch spans, not just a
subset of query-like API endpoints.
</li>
<li class="listitem">
For query-like API endpoints (e.g. <code class="literal">/_search</code>), the capturing of query details
on "span.context.db.statement" has changed (a) to include <span class="strong strong"><strong>both</strong></span> the
query params and the request body if both exist (separated by <code class="literal">\n\n</code>) and
(b) to <span class="strong strong"><strong>URL encode</strong></span> the query params, rather than JSON encoding.
</li>
</ul>
</div>
</li>
<li class="listitem">
feat: Add <code class="literal">captureAttributes</code> boolean option to <code class="literal">apm.captureError()</code> to
allow <span class="strong strong"><strong>disabling</strong></span> the automatic capture of Error object properties. This
is useful for cases where those properties should not be sent to the APM
Server, e.g. for performance (large string fields) or security (PII data).
<a href="https://github.com/elastic/apm-agent-nodejs/pull/1912" class="ulink" target="_top">#1912</a>
</li>
<li class="listitem">
feat: Add <code class="literal">log_level</code> central config support. <a href="https://github.com/elastic/apm-agent-nodejs/pull/1908" class="ulink" target="_top">#1908</a><br>
Spec: <a href="https://github.com/elastic/apm/blob/main/specs/agents/logging.md" class="ulink" target="_top">https://github.com/elastic/apm/blob/main/specs/agents/logging.md</a>
</li>
<li class="listitem">
<p>feat: Add <code class="literal">sanitize_field_names</code> configuration option.<br>
Allows users to configure a list of wildcard patterns to <em>remove</em> items
from the agent&#8217;s HTTP header and <code class="literal">application/x-www-form-urlencoded</code> payloads.
<a href="https://github.com/elastic/apm-agent-nodejs/pull/1898" class="ulink" target="_top">#1898</a></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://github.com/elastic/apm/blob/main/specs/agents/sanitization.md" class="ulink" target="_top">spec</a>
</li>
<li class="listitem">
<a href="https://github.com/elastic/apm-agent-nodejs/blob/main/docs/configuration.asciidoc#sanitize-field-names" class="ulink" target="_top">docs</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_31"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>fix: Fix parsing of comma-separated strings for relevant config vars to allow
whitespace around the commas. E.g.:</p>
<pre class="screen">export ELASTIC_APM_TRANSACTION_IGNORE_URLS='/ping, /metrics*'</pre>
<p>Config vars affected are: <code class="literal">disableInstrumentations</code>, <code class="literal">transactionIgnoreUrls</code>
<code class="literal">addPatch</code>, and <code class="literal">globalLabels</code>.</p>
</li>
<li class="listitem">
fix: Correct the environment variable for setting <code class="literal">transactionIgnoreUrl</code>
(added in v3.9.0) from <code class="literal">ELASTIC_TRANSACTION_IGNORE_URLS</code> to
<code class="literal">ELASTIC_APM_TRANSACTION_IGNORE_URLS</code>.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.9.0"></a>3.9.0 - 2020/11/30<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_31"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: support fastify 3 <a href="https://github.com/elastic/apm-agent-nodejs/pull/1891" class="ulink" target="_top">#1891</a><br>
Adds .default and .fastify module.exports to instrumented fastify function
for 3.x line, and prefers req.routerMethod and req.routerPath for
transaction name
</li>
<li class="listitem">
feat: Set "destination" context on spans for "mongodb". <a href="https://github.com/elastic/apm-agent-nodejs/pull/1893" class="ulink" target="_top">#1893</a><br>
This allows Kibana APM Service Maps to show a "mongodb" node for services using
the <a href="https://www.npmjs.com/package/mongodb" class="ulink" target="_top">mongodb</a> package (which includes
mongoose and mongojs).
</li>
<li class="listitem">
feat: transactionIgnoreUrl wildcard matching <a href="https://github.com/elastic/apm-agent-nodejs/pull/1870" class="ulink" target="_top">#1870</a><br>
Allows users to ignore URLs using simple wildcard matching patterns that behave
the same across language agents. See <a href="https://github.com/elastic/apm/issues/144" class="ulink" target="_top">https://github.com/elastic/apm/issues/144</a>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_32"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix: treat set-cookie in response headers as sensitive data <a href="https://github.com/elastic/apm-agent-nodejs/pull/1886" class="ulink" target="_top">#1886</a>
</li>
<li class="listitem">
fix: Synchronous spans would never have <code class="literal">span.sync == true</code>. <a href="https://github.com/elastic/apm-agent-nodejs/pull/1879" class="ulink" target="_top">#1879</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.8.0"></a>3.8.0 - 2020/11/09<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_32"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: expand k8s pod ID discovery regex <a href="https://github.com/elastic/apm-agent-nodejs/pull/1863" class="ulink" target="_top">#1863</a>
</li>
<li class="listitem">
feat: implements tracestate <a href="https://github.com/elastic/apm-agent-nodejs/pull/1828" class="ulink" target="_top">#1828</a><br>
Expands support for the W3C Trace Context specification by adding a tracestate
header implementation, and uses this new header to track the Elastic
transaction sample rate across a trace&#8217;s service boundaries.
</li>
<li class="listitem">
feat: add span and transaction outcome <a href="https://github.com/elastic/apm-agent-nodejs/pull/1824" class="ulink" target="_top">#1824</a><br>
This adds an "outcome" field to HTTP(S)
<a href="https://github.com/elastic/apm/blob/main/specs/agents/tracing-transactions.md#transaction-outcome" class="ulink" target="_top">transactions</a>
and <a href="https://github.com/elastic/apm/blob/main/specs/agents/tracing-spans.md#span-outcome" class="ulink" target="_top">spans</a>.
</li>
</ul>
</div>
<h5><a id="_bug_fixes_33"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix(pg): prevent unhandled promise rejection <a href="https://github.com/elastic/apm-agent-nodejs/pull/1846" class="ulink" target="_top">#1846</a>
</li>
<li class="listitem">
fix: redis@2.x instrumentation was broken <a href="https://github.com/elastic/apm-agent-nodejs/pull/1852" class="ulink" target="_top">#1852</a>
</li>
<li class="listitem">
A number of fixes to the test suite.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.7.0"></a>3.7.0 - 2020/8/10<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat(knex): add support for 0.21.x <a href="https://github.com/elastic/apm-agent-nodejs/pull/1801" class="ulink" target="_top">#1801</a>
</li>
<li class="listitem">
feat(redis): add support for v3.x <a href="https://github.com/elastic/apm-agent-nodejs/pull/1641" class="ulink" target="_top">#1641</a>
</li>
<li class="listitem">
feat(graphql): add support for 15.x <a href="https://github.com/elastic/apm-agent-nodejs/pull/1795" class="ulink" target="_top">#1795</a>
</li>
<li class="listitem">
feat(koa-router): add support for 9.x <a href="https://github.com/elastic/apm-agent-nodejs/pull/1772" class="ulink" target="_top">#1772</a>
</li>
<li class="listitem">
fix(elasticsearch): ensure requests can be aborted <a href="https://github.com/elastic/apm-agent-nodejs/pull/1566" class="ulink" target="_top">#1566</a>
</li>
<li class="listitem">
fix: end span if outgoing http request ends prematurely <a href="https://github.com/elastic/apm-agent-nodejs/pull/1583" class="ulink" target="_top">#1583</a>
</li>
<li class="listitem">
fix: don&#8217;t throw on invalid URL <a href="https://github.com/elastic/apm-agent-nodejs/pull/1771" class="ulink" target="_top">#1771</a>
</li>
<li class="listitem">
fix: patch apollo-server-core &gt; 2.14 correctly <a href="https://github.com/elastic/apm-agent-nodejs/pull/1796" class="ulink" target="_top">#1796</a>
</li>
<li class="listitem">
fix: add currentTraceIds to typings <a href="https://github.com/elastic/apm-agent-nodejs/pull/1733" class="ulink" target="_top">#1733</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.6.1"></a>3.6.1 - 2020/5/20<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix(package): bump elastic-apm-http-client to ^9.4.0 <a href="https://github.com/elastic/apm-agent-nodejs/pull/1756" class="ulink" target="_top">#1756</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.6.0"></a>3.6.0 - 2020/5/18<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: add destination metadata for db spans <a href="https://github.com/elastic/apm-agent-nodejs/pull/1687" class="ulink" target="_top">#1687</a>
</li>
<li class="listitem">
feat: add support for Node.js 14 <a href="https://github.com/elastic/apm-agent-nodejs/pull/1742" class="ulink" target="_top">#1742</a>
</li>
<li class="listitem">
feat(pg): add support for pg v8.x <a href="https://github.com/elastic/apm-agent-nodejs/pull/1743" class="ulink" target="_top">#1743</a>
</li>
<li class="listitem">
feat: add metrics for external memory <a href="https://github.com/elastic/apm-agent-nodejs/pull/1724" class="ulink" target="_top">#1724</a>
</li>
<li class="listitem">
feat: enrich spans with destination info <a href="https://github.com/elastic/apm-agent-nodejs/pull/1685" class="ulink" target="_top">#1685</a>
</li>
<li class="listitem">
fix(instrumentation): add .js to module path <a href="https://github.com/elastic/apm-agent-nodejs/pull/1711" class="ulink" target="_top">#1711</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.5.0"></a>3.5.0 - 2020/3/9<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat(error): get stack trace from Error-like objects <a href="https://github.com/elastic/apm-agent-nodejs/pull/1613" class="ulink" target="_top">#1613</a>
</li>
<li class="listitem">
fix: add logUncaughtExceptions conf option to TypeScript typings <a href="https://github.com/elastic/apm-agent-nodejs/pull/1668" class="ulink" target="_top">#1668</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.4.0"></a>3.4.0 - 2020/2/21<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: support W3C TraceContext traceparent header <a href="https://github.com/elastic/apm-agent-nodejs/pull/1587" class="ulink" target="_top">#1587</a>
</li>
<li class="listitem">
feat: add custom metrics API (experimental) <a href="https://github.com/elastic/apm-agent-nodejs/pull/1571" class="ulink" target="_top">#1571</a>
</li>
<li class="listitem">
feat(koa-router): add support for v8.x <a href="https://github.com/elastic/apm-agent-nodejs/pull/1642" class="ulink" target="_top">#1642</a>
</li>
<li class="listitem">
fix(cassandra): improve support for cassandra-driver v4.4.0+ <a href="https://github.com/elastic/apm-agent-nodejs/pull/1636" class="ulink" target="_top">#1636</a>
</li>
<li class="listitem">
fix: support promisifying setTimeout and friends <a href="https://github.com/elastic/apm-agent-nodejs/pull/1636" class="ulink" target="_top">#1636</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.3.0"></a>3.3.0 - 2019/12/13<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat(config): add serverCaCertFile config <a href="https://github.com/elastic/apm-agent-nodejs/pull/1560" class="ulink" target="_top">#1560</a>
</li>
<li class="listitem">
feat(config): add central config support for transactionMaxSpans and captureBody <a href="https://github.com/elastic/apm-agent-nodejs/pull/1555" class="ulink" target="_top">#1555</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.2.0"></a>3.2.0 - 2019/11/19<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix(metrics): only register collectors if enabled <a href="https://github.com/elastic/apm-agent-nodejs/pull/1520" class="ulink" target="_top">#1520</a>
</li>
<li class="listitem">
fix(ioredis): prevent unhandled promise rejection <a href="https://github.com/elastic/apm-agent-nodejs/pull/1523" class="ulink" target="_top">#1523</a>
</li>
<li class="listitem">
chore: add Node 13 to supported engines <a href="https://github.com/elastic/apm-agent-nodejs/pull/1524" class="ulink" target="_top">#1524</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.1.0"></a>3.1.0 - 2019/10/16<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_33"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat(mongodb): instrumentation <a href="https://github.com/elastic/apm-agent-nodejs/pull/1423" class="ulink" target="_top">#1423</a>
</li>
<li class="listitem">
fix(package): update elastic-apm-http-client to version 9.0.0 <a href="https://github.com/elastic/apm-agent-nodejs/pull/1419" class="ulink" target="_top">#1419</a>
</li>
<li class="listitem">
perf: cache <em>ids</em> value of transactions and spans <a href="https://github.com/elastic/apm-agent-nodejs/pull/1434" class="ulink" target="_top">#1434</a>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_34"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix: always end transaction when socket is closed prematurely <a href="https://github.com/elastic/apm-agent-nodejs/pull/1439" class="ulink" target="_top">#1439</a>
</li>
<li class="listitem">
fix: change logUncaughtExceptions default to false <a href="https://github.com/elastic/apm-agent-nodejs/pull/1432" class="ulink" target="_top">#1432</a>
</li>
<li class="listitem">
fix: write stack trace of uncaught exceptions to STDERR <a href="https://github.com/elastic/apm-agent-nodejs/pull/1429" class="ulink" target="_top">#1429</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.0.0"></a>3.0.0 - 2019/9/30<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_breaking_changes_7"></a>Breaking changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: allow manual instrumentation with <code class="literal">instrument: false</code> <a href="https://github.com/elastic/apm-agent-nodejs/pull/1114" class="ulink" target="_top">#1114</a>
</li>
<li class="listitem">
feat: allow setting span/transaction <code class="literal">type</code>, <code class="literal">subtype</code>, and <code class="literal">action</code> separately (the behavior of the old <code class="literal">type</code> has changed) <a href="https://github.com/elastic/apm-agent-nodejs/pull/1292" class="ulink" target="_top">#1292</a>
</li>
<li class="listitem">
feat: use <code class="literal">external</code> as span type instead of <code class="literal">ext</code> <a href="https://github.com/elastic/apm-agent-nodejs/pull/1291" class="ulink" target="_top">#1291</a>
</li>
<li class="listitem">
refactor(graphql): use custom transaction type <code class="literal">graphql</code> for graphql requests instead of <code class="literal">request</code> <a href="https://github.com/elastic/apm-agent-nodejs/pull/1245" class="ulink" target="_top">#1245</a>
</li>
<li class="listitem">
feat(http): add <code class="literal">instrumentIncomingHTTPRequests</code> config (<code class="literal">disableInstrumentations</code> now behaves differently) <a href="https://github.com/elastic/apm-agent-nodejs/pull/1298" class="ulink" target="_top">#1298</a>
</li>
<li class="listitem">
chore: remove deprecated APIs <a href="https://github.com/elastic/apm-agent-nodejs/pull/1413" class="ulink" target="_top">#1413</a>
</li>
<li class="listitem">
chore: drop support for older Node.js versions <a href="https://github.com/elastic/apm-agent-nodejs/pull/1383" class="ulink" target="_top">#1383</a>
</li>
</ul>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="release-notes.html">« Release notes</a>
</span>
<span class="next">
<a href="release-notes-2.x.html">Node.js Agent version 2.x »</a>
</span>
</div>
</div>
</body>
</html>
