<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Upgrade to v4.x | APM Node.js Agent Reference [master] | Elastic</title>
<meta class="elastic" name="content" content="Upgrade to v4.x | APM Node.js Agent Reference [master]">

<link rel="home" href="index.html" title="APM Node.js Agent Reference [master]"/>
<link rel="up" href="upgrading.html" title="Upgrading"/>
<link rel="prev" href="upgrading.html" title="Upgrading"/>
<link rel="next" href="upgrade-to-v3.html" title="Upgrade to v3.x"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="APM"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/APM Node.js Agent/Reference/master"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="upgrading.html">« Upgrading</a>
</span>
<span class="next">
<a href="upgrade-to-v3.html">Upgrade to v3.x »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link">
  <div id="related-products" class="dropdown">
  <div class="related-products-title">APM:</div>
  <div class="dropdown-anchor" tabindex="0">Node.js Agent Reference<span class="dropdown-icon"></span></div>
  <div class="dropdown-content">
  <ul>
  <li class="dropdown-category">APM</li>
  <ul>
  <li><a href="/guide/en/observability/current/apm.html">Observability › APM</a></li>
  </ul>
  <li class="dropdown-category">APM agents</li>
  <ul>
  <li><a href="/guide/en/apm/agent/android/current/intro.html">Android Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/go/current/introduction.html">Go Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/swift/current/intro.html">iOS Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/java/current/intro.html">Java Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/dotnet/current/intro.html">.NET Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/nodejs/current/intro.html">Node.js Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/php/current/intro.html">PHP Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/python/current/getting-started.html">Python Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/ruby/current/introduction.html">Ruby Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/rum-js/current/intro.html">Real User Monitoring JavaScript Agent Reference</a></li>
  </ul>
  <li class="dropdown-category">APM extensions</li>
  <ul>
  <li><a href="/guide/en/apm/lambda/current/aws-lambda-arch.html">AWS Lambda extension</a></li>
  <li><a href="/guide/en/apm/attacher/current/apm-attacher.html">Attacher</a></li>
  </ul>
  </ul>
  </div>
  </div>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="upgrading.html">Upgrading</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Upgrade to v4.x</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="upgrade-to-v4"></a>Upgrade to v4.x</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>The following is a guide on upgrading your usage of the Elastic APM Node.js agent
(<code class="literal">elastic-apm-node</code>) from version 3.x to version 4.x.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="v4-nodejs"></a>Node.js versions</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>Version 4.x of <code class="literal">elastic-apm-node</code> supports Node.js v14.17.0 and later.
(The previous 3.x major supported back to Node.js v8.6.0.)</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="v4-config-options"></a>Config options</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_elastic_apm_kubernetes"></a><code class="literal">ELASTIC_APM_KUBERNETES_*</code></h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>Support for the following Kubernetes environment variables have been removed:
<code class="literal">ELASTIC_APM_KUBERNETES_NAMESPACE</code>, <code class="literal">ELASTIC_APM_KUBERNETES_NODE_NAME</code>,
<code class="literal">ELASTIC_APM_KUBERNETES_POD_NAME</code>, and <code class="literal">ELASTIC_APM_KUBERNETES_POD_UID</code>. The
correct environment variables for these config vars are <em>without</em> the
<code class="literal">ELASTIC_APM_</code> prefix&#8201;&#8212;&#8201;for example
<a class="xref" href="configuration.html#kubernetes-pod-name" title="kubernetesPodName"><code class="literal">KUBERNETES_POD_NAME</code></a>&#8201;&#8212;&#8201;and has been documented that
way since v2.11.0.</p>
<p><span class="strong strong"><strong>How to check.</strong></span> Search for any usage of <code class="literal">ELASTIC_APM_KUBERNETES_</code> in your
project. For example, using <a href="https://github.com/BurntSushi/ripgrep" class="ulink" target="_top">ripgrep</a>,
run <code class="literal">rg ELASTIC_APM_KUBERNETES_</code>. If there are any hits, remove the
<code class="literal">ELASTIC_APM_</code> prefix.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_filterhttpheaders"></a><code class="literal">filterHttpHeaders</code></h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>Support for <code class="literal">filterHttpHeaders</code> config option has been removed. Redaction of
HTTP headers and also request cookies is controlled by the existing config
option <a class="xref" href="configuration.html#sanitize-field-names" title="sanitizeFieldNames"><code class="literal">sanitizeFieldNames</code></a>.</p>
<p><span class="strong strong"><strong>How to check.</strong></span> Search your project for <code class="literal">rg filterHttpHeaders</code> or
<code class="literal">rg ELASTIC_APM_FILTER_HTTP_HEADERS</code> and remove them.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_useelastictraceparentheader"></a><code class="literal">useElasticTraceparentHeader</code></h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>The default value of the <a class="xref" href="configuration.html#use-elastic-traceparent-header" title="useElasticTraceparentHeader"><code class="literal">useElasticTraceparentHeader</code></a> config option has
changed to <code class="literal">false</code>. This means that the vendor-specific
<code class="literal">elastic-apm-traceparent</code> header will no longer be added to outgoing HTTP
requests by default. The <code class="literal">traceparent</code> header (from the
<a href="https://w3c.github.io/trace-context/" class="ulink" target="_top">W3C trace-context standard</a>) is added by
the APM agent. If you need the agent to continue sending
<code class="literal">elastic-apm-traceparent</code> HTTP header you can set it to <code class="literal">true</code> via env var or
start options.</p>
<p><span class="strong strong"><strong>How to check.</strong></span> Search your project for <code class="literal">rg useElasticTraceparentHeader</code> or
<code class="literal">rg ELASTIC_APM_USE_ELASTIC_TRACEPARENT_HEADER</code>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_contextmanager_patch"></a><code class="literal">contextManager: "patch"</code></h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>The "patch" value for the <a class="xref" href="configuration.html#context-manager" title="contextManager"><code class="literal">contextManager</code></a> config option has been removed.
This was a limited async context management that predated the preferred
<code class="literal">AsyncLocalStorage</code> core Node.js mechanism for context tracking. As well, the
related and deprecated <code class="literal">asyncHooks</code> config option has been removed. Both were
deprecated in v3.37.0.</p>
<p><span class="strong strong"><strong>How to check.</strong></span> Search your project for <code class="literal">rg -w contextManager</code> or
<code class="literal">rg -w ELASTIC_APM_CONTEXT_MANAGER</code> which set the value to "patch". Also search
for <code class="literal">rg -w asyncHooks</code> or <code class="literal">rg -w ELASTIC_APM_ASYNC_HOOKS</code> which set the value to
<code class="literal">false</code>. If so, that config setting is no longer supported.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_loguncaughtexceptions"></a><code class="literal">logUncaughtExceptions</code></h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>The <code class="literal">logUncaughtExceptions</code> config option has been removed. In v3 and earlier,
when the APM agent was <a class="xref" href="configuration.html#capture-exceptions" title="captureExceptions">capturing an uncaught exception</a>
setting <code class="literal">logUncaughtExceptions: true</code> would tell the agent to print the error
details to stderr before exiting; but <code class="literal">logUncaughtExceptions</code> was <code class="literal">false</code> by
default. In v4, printing the error to stderr is done by default (to mimic the
default Node.js uncaught exception behavior) and there is no option to disable
that.</p>
<p><span class="strong strong"><strong>How to check.</strong></span> Search your project for <code class="literal">rg -w logUncaughtExceptions</code> or
<code class="literal">rg -w ELASTIC_APM_LOG_UNCAUGHT_EXCEPTIONS</code> and remove any usages.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_elastic_sanitize_field_names_elastic_ignore_message_queues"></a><code class="literal">ELASTIC_SANITIZE_FIELD_NAMES</code>, <code class="literal">ELASTIC_IGNORE_MESSAGE_QUEUES</code></h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>Support for the erroneous <code class="literal">ELASTIC_SANITIZE_FIELD_NAMES</code> and
<code class="literal">ELASTIC_IGNORE_MESSAGE_QUEUES</code> config environment variables has been removed.
The correct env vars are <code class="literal">ELASTIC_APM_SANITIZE_FIELD_NAMES</code> and
<code class="literal">ELASTIC_APM_IGNORE_MESSAGE_QUEUES</code>, respectively, and were supported starting
in v3.36.0.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="v4-api-changes"></a>API changes</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="v4-api-start-transaction"></a><code class="literal">apm.startTransaction(...)</code></h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>The <code class="literal">apm.startTransaction()</code> method has been changed to return a do-nothing
no-op Transaction, if the agent is not yet started. The return type has changed to
no longer include <code class="literal">| null</code>. The intent of these changes is to allow the user to use
<code class="literal">.startTransaction()</code> without having to worry if the agent is yet started, nor to
have to handle a possible <code class="literal">null</code> return value.</p>
<p><span class="strong strong"><strong>How to check.</strong></span> Search your project for <code class="literal">rg '\.startTransaction\b'</code>. If your
code handled a possible <code class="literal">null</code> return value from this function call, you can
remove that handling.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="v4-api-transaction-subtype-action"></a><code class="literal">transaction.subtype</code> and <code class="literal">transaction.action</code></h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>The <code class="literal">subtype</code> and <code class="literal">action</code> properties have been removed from <code class="literal">Transaction</code>.
This also impacts <a class="xref" href="agent-api.html#apm-start-transaction" title="apm.startTransaction([name][, type][, options])"><code class="literal">apm.startTransaction([name][, type][, options])</code></a> and <code class="literal">transaction.setType(...)</code>,
both of which now no longer accept <code class="literal">subtype</code> and <code class="literal">action</code> parameters.
These two properties were deprecated in v3.25.0.</p>
<p><span class="strong strong"><strong>How to check.</strong></span> Search your project for <code class="literal">rg '\.startTransaction\b'</code>. If your
code passed in <code class="literal">subtype</code> or <code class="literal">action</code> arguments, e.g.
<code class="literal">apm.startTransaction('a-name', 'a-type', 'a-subtype', 'an-action', { /* options */ })</code>,
then those need to be updated.  Also search your project for <code class="literal">rg '\.subtype\b'</code>
and <code class="literal">rg '\.action\b'</code>. If those property accesses are on an APM Transaction
object, then you should remove them. (Note that <code class="literal">subtype</code> and <code class="literal">action</code> on
APM <span class="strong strong"><strong>Span</strong></span> objects remain in the API.)</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="v4-api-to-string"></a><code class="literal">span.toString()</code>, <code class="literal">transaction.toString()</code></h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>The <code class="literal">span.toString()</code> and <code class="literal">transaction.toString()</code> methods have been removed as
documented APIs. They were never in the "index.d.ts" types and were deprecated
in v3.23.0.</p>
<p>Since v2.17.0 they would return a string of the form <code class="literal">trace.id=&lt;hex id the
trace&gt; span.id=&lt;hex id of the span&gt;</code>, with the intent that this could be used in
text-only loggers for log correlation. Using <code class="literal">.toString()</code> for this was
deprecated in v3.23.0, and has now been removed in v4. In v4 the output of
<code class="literal">.toString()</code> is not defined.</p>
<p>Instead, prefer the use of <a class="xref" href="span-api.html#span-ids" title="span.ids"><code class="literal">span.ids</code></a>,
<a class="xref" href="transaction-api.html#transaction-ids" title="transaction.ids"><code class="literal">transaction.ids</code></a>, or
<a class="xref" href="agent-api.html#apm-current-trace-ids" title="apm.currentTraceIds"><code class="literal">apm.currentTraceIds</code></a>. The v3 format may be reproduced
via:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">const {stringify} = require('querystring');
console.log(stringify(span.ids, ' ', '='));</pre>
</div>
<p>For log correlation with <em>structured</em> logs, see <a class="xref" href="logs.html#log-correlation-ids" title="Log correlation">Log correlation</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="v4-api-destroy"></a><code class="literal">apm.destroy()</code></h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>The <code class="literal">apm.destroy()</code> method is now async. Almost no users should need to use
this method. However, if used, to be sure to wait for APM agent shutdown to
be complete, one can now <code class="literal">await apm.destroy()</code>.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="v4-warnings"></a>Log warnings</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>This section documents some new log output warnings from the APM agent, and how to avoid them.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="v4-warning-duration-units"></a>"units missing in duration value"</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{"log.level":"warn","@timestamp":"2023-08-04T16:54:03.116Z","log":{"logger":"elastic-apm-node"},"ecs":{"version":"1.6.0"},"message":"units missing in duration value \"5\" for \"metricsInterval\" config option: using default units \"s\""}</pre>
</div>
<p>Configuration options that define a duration, like <code class="literal">metricsInterval</code> or
<code class="literal">exitSpanMinDuration</code>, expect to have their units specified in the value
(e.g. <code class="literal">"10s"</code>, <code class="literal">"100ms"</code>). While current duration options have a default
unit, to avoid ambiguity the APM agent will now warn if the units are not
provided.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="v4-warning-size-units"></a>"units missing in size value"</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/docs/upgrade-to-v4.asciidoc">edit</a></div>
</div></div></div>
<p>Byte size config options like <code class="literal">apiRequestSize</code> expect to have the size
units specified in the value (e.g. <code class="literal">"10kb"</code>, <code class="literal">"1gb"</code>). If the unit is not
in the value, the agent will warn about it and fallback to bytes (<code class="literal">b</code>).</p>
</div>

</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="upgrading.html">« Upgrading</a>
</span>
<span class="next">
<a href="upgrade-to-v3.html">Upgrade to v3.x »</a>
</span>
</div>
</body>
</html>
