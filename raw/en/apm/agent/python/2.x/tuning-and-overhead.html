<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tuning and Overhead considerations | APM Python Agent Reference [2.x] | Elastic</title>
<meta class="elastic" name="content" content="Tuning and Overhead considerations | APM Python Agent Reference [2.x]">

<link rel="home" href="index.html" title="APM Python Agent Reference [2.x]"/>
<link rel="up" href="index.html" title="APM Python Agent Reference [2.x]"/>
<link rel="prev" href="api.html" title="Public API"/>
<meta class="elastic" name="product_version" content="2.x"/>
<meta class="elastic" name="product_name" content="APM"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/APM Python Agent/Reference/2.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="2.x"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="api.html">« Public API</a>
</span>
<span class="next">
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link">
  <div id="related-products" class="dropdown">
  <div class="related-products-title">APM:</div>
  <div class="dropdown-anchor" tabindex="0">Python Agent Reference<span class="dropdown-icon"></span></div>
  <div class="dropdown-content">
  <ul>
  <li class="dropdown-category">APM</li>
  <ul>
  <li><a href="/guide/en/observability/current/apm.html">Observability › APM</a></li>
  </ul>
  <li class="dropdown-category">APM agents</li>
  <ul>
  <li><a href="/guide/en/apm/agent/android/current/intro.html">Android Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/go/current/introduction.html">Go Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/swift/current/intro.html">iOS Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/java/current/intro.html">Java Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/dotnet/current/intro.html">.NET Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/nodejs/current/intro.html">Node.js Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/php/current/intro.html">PHP Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/python/current/getting-started.html">Python Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/ruby/current/introduction.html">Ruby Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/rum-js/current/intro.html">Real User Monitoring JavaScript Agent Reference</a></li>
  </ul>
  <li class="dropdown-category">APM extensions</li>
  <ul>
  <li><a href="/guide/en/apm/lambda/current/aws-lambda-arch.html">AWS Lambda extension</a></li>
  <li><a href="/guide/en/apm/attacher/current/apm-attacher.html">Attacher</a></li>
  </ul>
  </ul>
  </div>
  </div>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Tuning and Overhead considerations</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-python/edit/2.x/docs/tuning.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs/reference/apm/agents/python/performance-tuning">latest documentation</a>.
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="tuning-and-overhead"></a>Tuning and Overhead considerations</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-python/edit/2.x/docs/tuning.asciidoc">edit</a></div>
</div></div></div>
<p>Using an APM solution comes with certain trade-offs, and the Python agent for Elastic APM is no different.
Instrumenting your code, measuring timings, recording context data etc. all need resources:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
CPU time
</li>
<li class="listitem">
memory
</li>
<li class="listitem">
bandwidth use
</li>
<li class="listitem">
Elasticsearch storage
</li>
</ul>
</div>
<p>We invested and continue to invest a lot of effort to keep the overhead of using Elastic APM as low as possible.
But because every deployment is different, there are some knobs you can turn to adapt it to your specific needs.</p>
<div class="position-relative"><h3><a id="tuning-sample-rate"></a>Transaction Sample Rate</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-python/edit/2.x/docs/tuning.asciidoc">edit</a></div>
<p>The most straight forward way to reduce the overhead of the agent is to tell the agent to do less.
If you set the <a class="xref" href="configuration.html#config-transaction-sample-rate" title="transaction_sample_rate"><code class="literal">transaction_sample_rate</code></a> to a value below <code class="literal">1.0</code>,
the agent will randomly sample only a subset of transactions.
If a transaction is not sampled, the agent has to do a lot less work,
as we only record the the name of the transaction, the overall transaction time and the result for unsampled transactions.</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Field</th>
<th align="left" valign="top">Sampled</th>
<th align="left" valign="top">Unsampled</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>Transaction name</p></td>
<td align="left" valign="top"><p>yes</p></td>
<td align="left" valign="top"><p>yes</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Duration</p></td>
<td align="left" valign="top"><p>yes</p></td>
<td align="left" valign="top"><p>yes</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Result</p></td>
<td align="left" valign="top"><p>yes</p></td>
<td align="left" valign="top"><p>yes</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Context</p></td>
<td align="left" valign="top"><p>yes</p></td>
<td align="left" valign="top"><p>no</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Tags</p></td>
<td align="left" valign="top"><p>yes</p></td>
<td align="left" valign="top"><p>no</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Spans</p></td>
<td align="left" valign="top"><p>yes</p></td>
<td align="left" valign="top"><p>no</p></td>
</tr>
</tbody>
</table>
</div>
<p>Reducing the sample rate to a fraction of all transactions can make a huge difference in all four of the mentioned resource types.</p>
<div class="position-relative"><h3><a id="tuning-queue"></a>Transaction Queue</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-python/edit/2.x/docs/tuning.asciidoc">edit</a></div>
<p>To reduce the load on the APM Server, the agent does not send every transaction up as it happens.
Instead, it queues them up, and flushes the queue periodically, or when it reaches a maximum size, using a background thread.</p>
<p>While this reduces the load on the APM Server (and to a certain extent on the agent),
holding on to the transaction data in a queue uses memory.
If you notice that using the Python agent results in a large increase of memory use,
you can use these settings:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="configuration.html#config-flush-interval" title="flush_interval"><code class="literal">flush_interval</code></a> to reduce the time between queue flushes
</li>
<li class="listitem">
<a class="xref" href="configuration.html#config-max-queue-size" title="max_queue_size"><code class="literal">max_queue_size</code></a> to reduce the maximum size of the queue
</li>
</ul>
</div>
<p>The first setting, <code class="literal">flush_interval</code>, is helpful if you have a sustained high number of transactions.
The second setting, <code class="literal">max_queue_size</code>, can help if you experience peaks of transactions
(a large amount of transactions in a short period of time).</p>
<p>Keep in mind that reducing the value of either setting will cause the agent to send more HTTP requests to the APM Server,
potentially causing a higher load.</p>
<div class="position-relative"><h3><a id="tuning-max-spans"></a>Spans per transaction</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/apm-agent-python/edit/2.x/docs/tuning.asciidoc">edit</a></div>
<p>The average amount of spans per transaction can influence how much time the agent spends in each transaction collecting contextual data for each span,
and the the storage space needed in Elasticsearch.
In our experience, most usual transactions should have well below 100 spans.
In some cases however, the number of spans can explode:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
long-running transactions
</li>
<li class="listitem">
unoptimized code, e.g. doing hundreds of SQL queries in a loop
</li>
</ul>
</div>
<p>To avoid that such edge cases overload both the agent and the APM Server,
the agent stops recording spans when a limit is reached.
You can configure this limit by changing the <a class="xref" href="configuration.html#config-transaction-max-spans" title="transaction_max_spans"><code class="literal">transaction_max_spans</code></a> setting.</p>
<p>Another option to reduce overhead of collecting contextual data for spans is to disable collection for very short spans.
While this contextual data (specifically, the stack trace) can be very useful to pinpoint where exectly the span is caused in your code,
it is less interesting for very short spans.
You can define a minimal threshold for span duration in milliseconds,
using the <a class="xref" href="configuration.html#config-span-frames-min-duration-ms" title="span_frames_min_duration"><code class="literal">span_frames_min_duration_ms</code></a> setting.
If a span takes less than this duration, no stack frames will be collected for this span.
Other contextual information, like the SQL query, will still be available.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="api.html">« Public API</a>
</span>
<span class="next">
</span>
</div>
</body>
</html>
