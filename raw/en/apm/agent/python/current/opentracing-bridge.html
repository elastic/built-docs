<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>OpenTracing API | APM Python Agent Reference [5.x] | Elastic</title>
<link rel="home" href="index.html" title="APM Python Agent Reference [5.x]"/>
<link rel="up" href="index.html" title="APM Python Agent Reference [5.x]"/>
<link rel="prev" href="metrics.html" title="Metrics"/>
<link rel="next" href="log-correlation.html" title="Log correlation"/>
<meta name="DC.type" content="Learn/Docs/APM Python Agent/Reference/5.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="5.x"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">APM Python Agent Reference [5.x]</a></span>
»
<span class="breadcrumb-node">OpenTracing API</span>
</div>
<div class="navheader">
<span class="prev">
<a href="metrics.html">« Metrics</a>
</span>
<span class="next">
<a href="log-correlation.html">Log correlation »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="opentracing-bridge"></a>OpenTracing API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc">edit</a></h1>
</div></div></div>
<p>The Elastic APM OpenTracing bridge allows you to create Elastic APM <code class="literal">Transactions</code> and <code class="literal">Spans</code>,
using the OpenTracing API.
In other words,
it translates calls to the OpenTracing API to Elastic APM events, which allows for the reuse of existing instrumentation.</p>
<p>The first span of a service will be converted to an Elastic APM
<a href="/guide/en/apm/get-started/7.10/transactions.html" class="ulink" target="_top"><code class="literal">Transaction</code></a>,
subsequent spans are mapped to Elastic APM
<a href="/guide/en/apm/get-started/7.10/transaction-spans.html" class="ulink" target="_top"><code class="literal">Span</code></a>.</p>
<h3><a id="opentracing-getting-started"></a>Getting started<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc">edit</a></h3>
<p>The first step in getting started with the OpenTracing API bridge is to install the <code class="literal">opentracing</code> library:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">pip install elastic-apm[opentracing]</pre>
</div>
<p>Or if you already have installed <code class="literal">elastic-apm</code></p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">pip install opentracing&gt;=2.0.0</pre>
</div>
<h3><a id="opentracing-init-tracer"></a>Initialize tracer<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc">edit</a></h3>
<div class="pre_wrapper lang-python">
<pre class="programlisting prettyprint lang-python">from elasticapm.contrib.opentracing import Tracer

tracer = Tracer();</pre>
</div>
<p><code class="literal">Tracer</code> accepts the following optional arguments:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">client_instance</code>: an already instantiated Elastic APM client
</li>
<li class="listitem">
<code class="literal">config</code>: a configuration dictionary, which will be used to instantiate a new Elastic APM client,
e.g. <code class="literal">{"SERVER_URL": "https://example.org"}</code>. See <a class="xref" href="configuration.html" title="Configuration">configuration</a> for more information.
</li>
<li class="listitem">
<code class="literal">scope_manager</code>: a scope manager instance. Defaults to <code class="literal">ThreadLocalScopeManager</code> (see
</li>
</ul>
</div>
<h3><a id="opentracing-elastic-apm-tags"></a>Elastic APM specific tags<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc">edit</a></h3>
<p>Elastic APM defines some tags which are not included in the OpenTracing API but are relevant in the context of Elastic APM.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">type</code> - sets the type of the transaction,
for example <code class="literal">request</code>, <code class="literal">ext</code> or <code class="literal">db</code>
</li>
<li class="listitem">
<code class="literal">user.id</code> - sets the user id,
appears in the "User" tab in the transaction details in the Elastic APM UI
</li>
<li class="listitem">
<code class="literal">user.email</code> - sets the user email,
appears in the "User" tab in the transaction details in the Elastic APM UI
</li>
<li class="listitem">
<code class="literal">user.username</code> - sets the user name,
appears in the "User" tab in the transaction details in the Elastic APM UI
</li>
<li class="listitem">
<code class="literal">result</code> - sets the result of the transaction. Overrides the default value of <code class="literal">success</code>.
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>these tags need to be set on the first span of an operation (e.g. an incoming request of your webapp).</p>
</div>
</div>
<h3><a id="opentracing-caveats"></a>Caveats<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc">edit</a></h3>
<p>Not all features of the OpenTracing API are supported.</p>
<h4><a id="opentracing-scope-managers"></a>Scope Managers<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc">edit</a></h4>
<p>Currently, only the <code class="literal">ThreadLocalScopeManager</code> is supported.
Using other scope managers will lead to unpredictable and possibly app-breaking behavior.</p>
<h4><a id="opentracing-instrumentation"></a>Instrumentation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc">edit</a></h4>
<p>It is recommended to not use the built-in instrumentations of Elastic APM together with third-party OpenTracing instrumentations
like <a href="https://pypi.org/project/opentracing_instrumentation/" class="ulink" target="_top">opentracing_instrumentation</a> in the same service.
If you would like to use such instrumentations, we recommend to disable the built-in instrumentation using the <a class="xref" href="configuration.html#config-instrument" title="instrument"><code class="literal">instrument</code></a> config option.</p>
<h4><a id="opentracing-propagation"></a>Context propagation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc">edit</a></h4>
<p>This bridge only supports the formats <code class="literal">Format.Builtin.TEXT_MAP</code> and <code class="literal">Format.Builtin.HTTP_HEADERS</code>.
<code class="literal">Format.Builtin.BINARY</code> is currently not supported.</p>
<h4><a id="opentracing-references"></a>Span references<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc">edit</a></h4>
<p>Currently, this bridge only supports <code class="literal">child_of</code> references.
Other references,
like <code class="literal">follows_from</code> are not supported yet.</p>
<h4><a id="opentracing-baggage"></a>Baggage<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc">edit</a></h4>
<p>The <code class="literal">Span.set_baggage_item(key, value)</code> method is not supported.
Baggage items are silently dropped.</p>
<h4><a id="opentracing-logs"></a>Logs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc">edit</a></h4>
<p>Only exception logging is supported.
Logging an Exception on the OpenTracing span will create an Elastic APM
<a href="/guide/en/apm/get-started/7.10/errors.html" class="ulink" target="_top"><code class="literal">Error</code></a>.
Example:</p>
<div class="pre_wrapper lang-python">
<pre class="programlisting prettyprint lang-python">with tracer.start_active_span("transaction") as tx_scope:
    try:
        raise ValueError("oops")
    except ValueError:
        exc_type, exc_val, exc_tb = sys.exc_info()[:3]
        tx_scope.span.log_kv({
            "python.exception.type": exc_type,
            "python.exception.val": exc_val,
            "python.exception.tb": exc_tb
        })</pre>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="metrics.html">« Metrics</a>
</span>
<span class="next">
<a href="log-correlation.html">Log correlation »</a>
</span>
</div>
</div>
</body>
</html>
