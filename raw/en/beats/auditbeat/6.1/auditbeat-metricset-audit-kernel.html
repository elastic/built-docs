<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Audit kernel metricset | Auditbeat Reference [6.1] | Elastic</title>
<link rel="home" href="index.html" title="Auditbeat Reference [6.1]"/>
<link rel="up" href="auditbeat-module-audit.html" title="Audit Module"/>
<link rel="prev" href="auditbeat-metricset-audit-file.html" title="Audit file metricset"/>
<link rel="next" href="exported-fields.html" title="Exported fields"/>
<meta name="DC.type" content="Learn/Docs/Auditbeat/Reference/6.1"/>
<meta name="DC.subject" content="Auditbeat"/>
<meta name="DC.identifier" content="6.1"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
<p>
  <strong>WARNING</strong>: Version 6.1 of Auditbeat has passed its 
  <a href="https://www.elastic.co/support/eol">EOL date</a>. 
</p>  
<p>
  This documentation is no longer being maintained and may be removed. 
  If you are running this version, we strongly advise you to upgrade. 
  For the latest information, see the 
  <a href="../current/index.html">current release documentation</a>. 
</p>
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Auditbeat Reference [6.1]</a></span>
»
<span class="breadcrumb-link"><a href="auditbeat-modules.html">Modules</a></span>
»
<span class="breadcrumb-link"><a href="auditbeat-module-audit.html">Audit Module</a></span>
»
<span class="breadcrumb-node">Audit kernel metricset</span>
</div>
<div class="navheader">
<span class="prev">
<a href="auditbeat-metricset-audit-file.html">« Audit file metricset</a>
</span>
<span class="next">
<a href="exported-fields.html">Exported fields »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="auditbeat-metricset-audit-kernel"></a>Audit kernel metricset<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/beats/edit/6.1/auditbeat/module/audit/kernel/_meta/docs.asciidoc">edit</a></h2>
</div></div></div>
<p>The <code class="literal">kernel</code> metricset receives audit events from the Linux Audit Framework that
is a part of the Linux kernel.</p>
<p>This metricset is available only for Linux.</p>
<h3><a id="_how_it_works_2"></a>How it works<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/beats/edit/6.1/auditbeat/module/audit/kernel/_meta/docs.asciidoc">edit</a></h3>
<p>This metricset establishes a subscription to the kernel to receive the events
as they occur. So unlike most other metricsets, the <code class="literal">period</code> configuration
option is unused because it is not implemented using polling.</p>
<p>The Linux Audit Framework can send multiple messages for a single auditable
event. For example, a <code class="literal">rename</code> syscall causes the kernel to send eight separate
messages. Each message describes a different aspect of the activity that is
occurring (the syscall itself, file paths, current working directory, process
title). This metricset will combine all of the data from each of the messages
into a single event.</p>
<p>Messages for one event can be interleaved with messages from another event. This
metricset will buffer the messages in order to combine related messages into a
single event even if they arrive interleaved or out of order.</p>
<h3><a id="_useful_commands"></a>Useful commands<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/beats/edit/6.1/auditbeat/module/audit/kernel/_meta/docs.asciidoc">edit</a></h3>
<p>When running Auditbeat with the <code class="literal">kernel</code> metricset enabled, you might find
that other monitoring systems interfere with Auditbeat.</p>
<p>For example, you might encounter errors if another process, such as <code class="literal">auditd</code>, is
registered to receive data from the Linux Audit Framework. You can use these
commands to see if the <code class="literal">auditd</code> service is running and stop it:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>See if <code class="literal">auditd</code> is running:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">service auditd status</pre>
</div>
</li>
<li class="listitem">
<p>Stop the <code class="literal">auditd</code> service:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">service auditd stop</pre>
</div>
</li>
<li class="listitem">
<p>Disable <code class="literal">auditd</code> from starting on boot:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">chkconfig auditd off</pre>
</div>
</li>
</ul>
</div>
<p>To save CPU usage and disk space, you can use this command to stop <code class="literal">journald</code>
from listening to audit messages:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">systemctl mask systemd-journald-audit.socket</pre>
</div>
<h3><a id="_configuration_options_14"></a>Configuration options<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/beats/edit/6.1/auditbeat/module/audit/kernel/_meta/docs.asciidoc">edit</a></h3>
<p>This metricset has some configuration options for tuning its behavior. The
following example shows all configuration options with their default values.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">- module: audit
  metricsets: ["kernel"]
  kernel.resolve_ids: true
  kernel.failure_mode: silent
  kernel.backlog_limit: 8196
  kernel.rate_limit: 0
  kernel.include_raw_message: false
  kernel.include_warnings: false</pre>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">kernel.socket_type</code></strong></span>
</span>
</dt>
<dd>
<p>
This optional setting controls the type of
socket that Auditbeat uses to receive events from the kernel. The two
options are <code class="literal">unicast</code> and <code class="literal">multicast</code>.
</p>
<p><code class="literal">unicast</code> should be used when Auditbeat is the primary userspace daemon for
receiving audit events and managing the rules. Only a single process can receive
audit events through the "unicast" connection so any other daemons should be
stopped (e.g. stop <code class="literal">auditd</code>).</p>
<p><code class="literal">multicast</code> can be used in kernel versions 3.16 and newer. By using <code class="literal">multicast</code>
Auditbeat will receive an audit event broadcast that is not exclusive to a
a single process. This is ideal for situations where <code class="literal">auditd</code> is running and
managing the rules. If <code class="literal">multicast</code> is specified, but the kernel version is less
than 3.16 Auditbeat will automatically revert to <code class="literal">unicast</code>.</p>
<p>By default Auditbeat will use <code class="literal">multicast</code> if the kernel version is 3.16 or
newer and no rules have been defined. Otherwise <code class="literal">unicast</code> will be used.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">kernel.resolve_ids</code></strong></span>
</span>
</dt>
<dd>
This boolean setting enables the resolution of UIDs and
GIDs to their associated names. The default value is true.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">kernel.failure_mode</code></strong></span>
</span>
</dt>
<dd>
This determines the kernel&#8217;s behavior on critical
failures such as errors sending events to Auditbeat, the backlog limit was
exceeded, the kernel ran out of memory, or the rate limit was exceeded. The
options are <code class="literal">silent</code>, <code class="literal">log</code>, or <code class="literal">panic</code>. <code class="literal">silent</code> basically makes the kernel
ignore the errors, <code class="literal">log</code> makes the kernel write the audit messages using
<code class="literal">printk</code> so they show up in system&#8217;s syslog, and <code class="literal">panic</code> causes the kernel to
panic to prevent use of the machine. Auditbeat&#8217;s default is <code class="literal">silent</code>.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">kernel.backlog_limit</code></strong></span>
</span>
</dt>
<dd>
This controls the maximum number of audit messages
that will be buffered by the kernel.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">kernel.rate_limit</code></strong></span>
</span>
</dt>
<dd>
This sets a rate limit on the number of messages/sec
delivered by the kernel. The default is 0, which disables rate limiting.
Changing this value to anything other than zero can cause messages to be lost.
The preferred approach to reduce the messaging rate is be more selective in the
audit ruleset.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">kernel.include_raw_message</code></strong></span>
</span>
</dt>
<dd>
This boolean setting causes Auditbeat to
include each of the raw messages that contributed to the event in the document
as a field called <code class="literal">messages</code>. The default value is false. This setting is
primarily used for development and debugging purposes.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">kernel.include_warnings</code></strong></span>
</span>
</dt>
<dd>
This boolean setting causes Auditbeat to
include as warnings any issues that were encountered while parsing the raw
messages. The default value is false. When this setting is enabled the raw
messages will be included in the event regardless of the
<code class="literal">kernel.include_raw_message</code> config setting. This setting is primarily used for
development and debugging purposes.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">kernel.audit_rules</code></strong></span>
</span>
</dt>
<dd>
A string containing the audit rules that should be
installed to the kernel. There should be one rule per line. Comments can be
embedded in the string using <code class="literal">#</code> as a prefix. The format for rules is the same
used by the Linux <code class="literal">auditctl</code> utility. Auditbeat supports adding file watches
(<code class="literal">-w</code>) and syscall rules (<code class="literal">-a</code> or <code class="literal">-A</code>).
</dd>
</dl>
</div>
<h3><a id="_audit_rules"></a>Audit rules<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/beats/edit/6.1/auditbeat/module/audit/kernel/_meta/docs.asciidoc">edit</a></h3>
<p>The audit rules are where you configure the activities that are audited. These
rules are configured as either syscalls or files that should be monitored. For
example you can track all <code class="literal">connect</code> syscalls or file system writes to
<code class="literal">/etc/passwd</code>.</p>
<p>Auditing a large number of syscalls can place a heavy load on the system so
consider carefully the rules you define and try to apply filters in the rules
themselves to be as selective as possible.</p>
<p>The kernel evaluates the rules in the order in which they were defined so place
the most active rules first in order to speed up evaluation.</p>
<p>You can assign keys to each rule for better identification of the rule that
triggered an event and easier filtering later in Elasticsearch.</p>
<p>Defining any audit rules in the config causes Auditbeat to purge all
existing audit rules prior to adding the rules specified in the config.
Therefore it is unnecessary and unsupported to include a <code class="literal">-D</code> (delete all) rule.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">auditbeat.modules:
- module: audit
  metricsets: ["kernel"]
  kernel.audit_rules: |
    # Things that affect identity.
    -w /etc/group -p wa -k identity
    -w /etc/passwd -p wa -k identity
    -w /etc/gshadow -p wa -k identity
    -w /etc/shadow -p wa -k identity

    # Unauthorized access attempts to files (unsuccessful).
    -a always,exit -F arch=b32 -S open,creat,truncate,ftruncate,openat,open_by_handle_at -F exit=-EACCES -F auid&gt;=1000 -F auid!=4294967295 -F key=access
    -a always,exit -F arch=b32 -S open,creat,truncate,ftruncate,openat,open_by_handle_at -F exit=-EPERM -F auid&gt;=1000 -F auid!=4294967295 -F key=access
    -a always,exit -F arch=b64 -S open,truncate,ftruncate,creat,openat,open_by_handle_at -F exit=-EACCES -F auid&gt;=1000 -F auid!=4294967295 -F key=access
    -a always,exit -F arch=b64 -S open,truncate,ftruncate,creat,openat,open_by_handle_at -F exit=-EPERM -F auid&gt;=1000 -F auid!=4294967295 -F key=access</pre>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_fields_2"></a>Fields<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/beats/edit/6.1/auditbeat/docs/modules/audit/kernel.asciidoc">edit</a></h3>
</div></div></div>
<p>For a description of each field in the metricset, see the
<a class="xref" href="exported-fields-audit.html" title="Audit fields">exported fields</a> section.</p>
<p>Here is an example document generated by this metricset:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{
    "@timestamp": "2017-04-22T21:25:01.818Z",
    "audit": {
        "kernel": {
            "action": "logged-in",
            "actor": {
                "attrs": {
                    "auid": "unset",
                    "uid": "root"
                },
                "primary": "unset",
                "secondary": "(invalid user)"
            },
            "category": "user-login",
            "data": {
                "acct": "(invalid user)",
                "addr": "179.38.151.221",
                "exe": "/usr/sbin/sshd",
                "op": "login",
                "pid": "12635",
                "terminal": "sshd"
            },
            "how": "/usr/sbin/sshd",
            "record_type": "user_login",
            "result": "fail",
            "sequence": 19955,
            "session": "unset",
            "thing": {
                "primary": "sshd",
                "secondary": "179.38.151.221",
                "what": "user-session"
            }
        }
    },
    "beat": {
        "hostname": "host.example.com",
        "name": "host.example.com"
    },
    "metricset": {
        "module": "audit",
        "name": "kernel",
        "rtt": 115
    },
    "type": "metricsets"
}</pre>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="auditbeat-metricset-audit-file.html">« Audit file metricset</a>
</span>
<span class="next">
<a href="exported-fields.html">Exported fields »</a>
</span>
</div>
</div>
</body>
</html>
