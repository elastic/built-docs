<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Add Kubernetes metadata | Filebeat Reference [master] | Elastic</title>
<link rel="home" href="index.html" title="Filebeat Reference [master]"/>
<link rel="up" href="filtering-and-enhancing-data.html" title="Filter and enhance data with processors"/>
<link rel="prev" href="add-id.html" title="Generate an ID for an event"/>
<link rel="next" href="add-labels.html" title="Add labels"/>
<meta name="DC.type" content="Learn/Docs/Filebeat/Reference/master"/>
<meta name="DC.subject" content="Filebeat"/>
<meta name="DC.identifier" content="master"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Filebeat Reference [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="configuring-howto-filebeat.html">Configure Filebeat</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="filtering-and-enhancing-data.html">Filter and enhance data with processors</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="add-id.html">« Generate an ID for an event</a>
</span>
<span class="next">
<a href="add-labels.html">Add labels »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="add-kubernetes-metadata"></a>Add Kubernetes metadata<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/libbeat/processors/add_kubernetes_metadata/docs/add_kubernetes_metadata.asciidoc">edit</a></h2>
</div></div></div>

<p>The <code class="literal">add_kubernetes_metadata</code> processor annotates each event with relevant
metadata based on which Kubernetes pod the event originated from.
At startup, it detects an <code class="literal">in_cluster</code> environment and caches the
Kubernetes-related metadata. Events are only annotated if a valid configuration
is detected. If it&#8217;s not able to detect a valid Kubernetes configuration,
the events are not annotated with Kubernetes-related metadata.</p>
<p>Each event is annotated with:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Pod Name
</li>
<li class="listitem">
Pod UID
</li>
<li class="listitem">
Namespace
</li>
<li class="listitem">
Labels
</li>
</ul>
</div>
<p>In addition, the node and namespace metadata are added to the pod metadata.</p>
<p>The <code class="literal">add_kubernetes_metadata</code> processor has two basic building blocks:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Indexers
</li>
<li class="listitem">
Matchers
</li>
</ul>
</div>
<p>Indexers use pod metadata to create unique identifiers for each one of the
pods. These identifiers help to correlate the metadata of the observed pods with
actual events. For example, the <code class="literal">ip_port</code> indexer can take a Kubernetes pod and
create identifiers for it based on all its <code class="literal">pod_ip:container_port</code> combinations.</p>
<p>Matchers use information in events to construct lookup keys that match the
identifiers created by the indexers. For example, when the <code class="literal">fields</code> matcher takes
<code class="literal">["metricset.host"]</code> as a lookup field, it would construct a lookup key with the
value of the field <code class="literal">metricset.host</code>. When one of these lookup keys matches with one
of the identifiers, the event is enriched with the metadata of the identified
pod.</p>
<p>When <code class="literal">add_kubernetes_metadata</code> is used with Filebeat, it uses the
<code class="literal">container</code> indexer and the <code class="literal">logs_path</code>. So events whose path in <code class="literal">log.file.path</code>
contains a reference to a container ID are enriched with metadata of the pod of
this container.</p>
<p>This behaviour can be disabled by disabling default indexers and matchers in the
configuration:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">processors:
  - add_kubernetes_metadata:
      default_indexers.enabled: false
      default_matchers.enabled: false</pre>
</div>
<p>You can find more information about the available indexers and matchers, and some
examples in <a class="xref" href="add-kubernetes-metadata.html#kubernetes-indexers-and-matchers" title="Indexers and matchers">Indexers and matchers</a>.</p>
<p>The configuration below enables the processor when filebeat is run as a pod in
Kubernetes.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">processors:
  - add_kubernetes_metadata:
      #labels.dedot: true
      #annotations.dedot: true</pre>
</div>
<p>The configuration below enables the processor on a Beat running as a process on
the Kubernetes node.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">processors:
  - add_kubernetes_metadata:
      host: &lt;hostname&gt;
      # If kube_config is not set, KUBECONFIG environment variable will be checked
      # and if not present it will fall back to InCluster
      kube_config: $Filebeat Reference [master]/.kube/config
      #labels.dedot: true
      #annotations.dedot: true</pre>
</div>
<p>The configuration below has the default indexers and matchers disabled and
enables ones that the user is interested in.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">processors:
  - add_kubernetes_metadata:
      host: &lt;hostname&gt;
      # If kube_config is not set, KUBECONFIG environment variable will be checked
      # and if not present it will fall back to InCluster
      kube_config: ~/.kube/config
      default_indexers.enabled: false
      default_matchers.enabled: false
      indexers:
        - ip_port:
      matchers:
        - fields:
            lookup_fields: ["metricset.host"]
      #labels.dedot: true
      #annotations.dedot: true</pre>
</div>
<p>The <code class="literal">add_kubernetes_metadata</code> processor has the following configuration settings:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">host</code>
</span>
</dt>
<dd>
(Optional) Specify the node to scope filebeat to in case it
cannot be accurately detected, as when running filebeat in host network
mode.
</dd>
<dt>
<span class="term">
<code class="literal">scope</code>
</span>
</dt>
<dd>
(Optional) Specify if the processor should have visibility at the node level or at the entire cluster
level. Possible values are <code class="literal">node</code> and <code class="literal">cluster</code>. Scope is <code class="literal">node</code> by default.
</dd>
<dt>
<span class="term">
<code class="literal">namespace</code>
</span>
</dt>
<dd>
(Optional) Select the namespace from which to collect the
metadata. If it is not set, the processor collects metadata from all namespaces.
It is unset by default.
</dd>
<dt>
<span class="term">
<code class="literal">add_resource_metadata</code>
</span>
</dt>
<dd>
<p>
(Optional) Specify filters and configuration for the extra metadata, that will be added to the event. Configuration parameters:
</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">node</code> or <code class="literal">namespace</code>: Specify labels and annotations filters for the extra metadata coming from node and namespace. By default all labels are included while annotations are not. To change default behaviour <code class="literal">include_labels</code>, <code class="literal">exclude_labels</code> and <code class="literal">include_annotations</code> can be defined. Those settings are useful when storing labels and annotations that require special handling to avoid overloading the storage output.
Note: wildcards are not supported for those settings.
The enrichment of <code class="literal">node</code> or <code class="literal">namespace</code> metadata can be individually disabled by setting <code class="literal">enabled: false</code>.
</li>
<li class="listitem">
<code class="literal">deployment</code>: If resource is <code class="literal">pod</code> and it is created from a <code class="literal">deployment</code>, by default the deployment name is added, this can be disabled by setting <code class="literal">deployment: false</code>.
</li>
<li class="listitem">
<p><code class="literal">cronjob</code>: If resource is <code class="literal">pod</code> and it is created from a <code class="literal">cronjob</code>, by default the cronjob name is added, this can be disabled by setting <code class="literal">cronjob: false</code>.</p>
<p>Example:</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">      add_resource_metadata:
        namespace:
          include_labels: ["namespacelabel1"]
          #labels.dedot: true
          #annotations.dedot: true
        node:
          include_labels: ["nodelabel2"]
          include_annotations: ["nodeannotation1"]
          #labels.dedot: true
          #annotations.dedot: true
        deployment: false
        cronjob: false</pre>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">kube_config</code>
</span>
</dt>
<dd>
(Optional) Use given config file as configuration for Kubernetes
client. It defaults to <code class="literal">KUBECONFIG</code> environment variable if present.
</dd>
<dt>
<span class="term">
<code class="literal">kube_client_options</code>
</span>
</dt>
<dd>
(Optional) Additional options can be configured for Kubernetes
client. Currently client QPS and burst are supported, if not set Kubernetes client&#8217;s
<a href="https://pkg.go.dev/k8s.io/client-go/rest#pkg-constants" class="ulink" target="_top">default QPS and burst</a> will be used.
Example:
</dd>
</dl>
</div>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">      kube_client_options:
        qps: 5
        burst: 10</pre>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">cleanup_timeout</code>
</span>
</dt>
<dd>
(Optional) Specify the time of inactivity before stopping the
running configuration for a container. This is <code class="literal">60s</code> by default.
</dd>
<dt>
<span class="term">
<code class="literal">sync_period</code>
</span>
</dt>
<dd>
(Optional) Specify the timeout for listing historical resources.
</dd>
<dt>
<span class="term">
<code class="literal">default_indexers.enabled</code>
</span>
</dt>
<dd>
(Optional) Enable or disable default pod indexers when you want to specify your own.
</dd>
<dt>
<span class="term">
<code class="literal">default_matchers.enabled</code>
</span>
</dt>
<dd>
(Optional) Enable or disable default pod matchers when you want to specify your own.
</dd>
<dt>
<span class="term">
<code class="literal">labels.dedot</code>
</span>
</dt>
<dd>
(Optional) Default to be true. If set to true, then <code class="literal">.</code> in labels will be replaced with <code class="literal">_</code>.
</dd>
<dt>
<span class="term">
<code class="literal">annotations.dedot</code>
</span>
</dt>
<dd>
(Optional) Default to be true. If set to true, then <code class="literal">.</code> in labels will be replaced with <code class="literal">_</code>.
</dd>
</dl>
</div>
<h3><a id="kubernetes-indexers-and-matchers"></a>Indexers and matchers<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/libbeat/processors/add_kubernetes_metadata/docs/indexers_and_matchers.asciidoc">edit</a></h3>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_indexers"></a>Indexers<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/libbeat/processors/add_kubernetes_metadata/docs/indexers_and_matchers.asciidoc">edit</a></h3>
</div></div></div>
<p>Indexers use pods metadata to create unique identifiers for each one of the
pods.</p>
<p>Available indexers are:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">container</code>
</span>
</dt>
<dd>
Identifies the pod metadata using the IDs of its containers.
</dd>
<dt>
<span class="term">
<code class="literal">ip_port</code>
</span>
</dt>
<dd>
Identifies the pod metadata using combinations of its IP and its exposed ports.
When using this indexer metadata is identified using the IP of the pods, and the
combination if <code class="literal">ip:port</code> for each one of the ports exposed by its containers.
</dd>
<dt>
<span class="term">
<code class="literal">pod_name</code>
</span>
</dt>
<dd>
Identifies the pod metadata using its namespace and its name as
<code class="literal">namespace/pod_name</code>.
</dd>
<dt>
<span class="term">
<code class="literal">pod_uid</code>
</span>
</dt>
<dd>
Identifies the pod metadata using the UID of the pod.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_matchers"></a>Matchers<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/libbeat/processors/add_kubernetes_metadata/docs/indexers_and_matchers.asciidoc">edit</a></h3>
</div></div></div>
<p>Matchers are used to construct the lookup keys that match with the identifiers
created by indexes.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_field_format"></a><code class="literal">field_format</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/libbeat/processors/add_kubernetes_metadata/docs/indexers_and_matchers.asciidoc">edit</a></h4>
</div></div></div>
<p>Looks up pod metadata using a key created with a string format that can include
event fields.</p>
<p>This matcher has an option <code class="literal">format</code> to define the string format. This string
format can contain placeholders for any field in the event.</p>
<p>For example, the following configuration uses the <code class="literal">ip_port</code> indexer to identify
the pod metadata by combinations of the pod IP and its exposed ports, and uses
the destination IP and port in events as match keys:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">processors:
- add_kubernetes_metadata:
    ...
    default_indexers.enabled: false
    default_matchers.enabled: false
    indexers:
      - ip_port:
    matchers:
      - field_format:
          format: '%{[destination.ip]}:%{[destination.port]}'</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_fields"></a><code class="literal">fields</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/libbeat/processors/add_kubernetes_metadata/docs/indexers_and_matchers.asciidoc">edit</a></h4>
</div></div></div>
<p>Looks up pod metadata using as key the value of some specific fields. When
multiple fields are defined, the first one included in the event is used.</p>
<p>This matcher has an option <code class="literal">lookup_fields</code> to define the files whose value will
be used for lookup.</p>
<p>For example, the following configuration uses the <code class="literal">ip_port</code> indexer to identify
pods, and defines a matcher that uses the destination IP or the server IP for the
lookup, the first it finds in the event:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">processors:
- add_kubernetes_metadata:
    ...
    default_indexers.enabled: false
    default_matchers.enabled: false
    indexers:
      - ip_port:
    matchers:
      - fields:
          lookup_fields: ['destination.ip', 'server.ip']</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_logs_path"></a><code class="literal">logs_path</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/libbeat/processors/add_kubernetes_metadata/docs/indexers_and_matchers.asciidoc">edit</a></h4>
</div></div></div>
<p>Looks up pod metadata using identifiers extracted from the log path stored in
the <code class="literal">log.file.path</code> field.</p>
<p>This matcher has the following configuration settings:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">logs_path</code>
</span>
</dt>
<dd>
(Optional) Base path of container logs. If not specified, it uses
the default logs path of the platform where Filebeat is running: for Linux -
<code class="literal">/var/lib/docker/containers/</code>, Windows - <code class="literal">C:\\ProgramData\\Docker\\containers</code>.
To change the default value: container ID must follow right after the <code class="literal">logs_path</code> -
<code class="literal">&lt;log_path&gt;/&lt;container_id&gt;</code>, where <code class="literal">container_id</code> is a 64-character-long
hexadecimal string.
</dd>
<dt>
<span class="term">
<code class="literal">resource_type</code>
</span>
</dt>
<dd>
<p>
(Optional) Type of the resource to obtain the ID of.
Valid <code class="literal">resource_type</code>:
</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p><code class="literal">pod</code>: to make the lookup based on the pod UID. When <code class="literal">resource_type</code> is set to
<code class="literal">pod</code>, <code class="literal">logs_path</code> must be set as well, supported path in this case:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">/var/lib/kubelet/pods/</code> used to read logs from mounted into the pod volumes,
those logs end up under <code class="literal">/var/lib/kubelet/pods/&lt;pod UID&gt;/volumes/&lt;volume name&gt;/...</code>
To use <code class="literal">/var/lib/kubelet/pods/</code> as a <code class="literal">log_path</code>, <code class="literal">/var/lib/kubelet/pods</code> must be
mounted into the filebeat Pods.
</li>
<li class="listitem">
<code class="literal">/var/log/pods/</code>
Note: when using <code class="literal">resource_type: 'pod'</code> logs will be enriched only with pod
metadata: pod id, pod name, etc., not container metadata.
</li>
</ul>
</div>
</li>
<li class="listitem">
<code class="literal">container</code>: to make the lookup based on the container ID, <code class="literal">logs_path</code> must
be set to <code class="literal">/var/log/containers/</code>.
It defaults to <code class="literal">container</code>.
</li>
</ul>
</div>
</dd>
</dl>
</div>
<p>To be able to use <code class="literal">logs_path</code> matcher filebeat input path must be a subdirectory
of directory defined in <code class="literal">logs_path</code> configuration setting.</p>
<p>The default configuration is able to lookup the metadata using the container ID
when the logs are collected from the default docker logs path
(<code class="literal">/var/lib/docker/containers/&lt;container ID&gt;/...</code> on Linux).</p>
<p>For example the following configuration would use the pod UID when the logs are
collected from <code class="literal">/var/lib/kubelet/pods/&lt;pod UID&gt;/...</code>.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">processors:
- add_kubernetes_metadata:
    ...
    default_indexers.enabled: false
    default_matchers.enabled: false
    indexers:
      - pod_uid:
    matchers:
      - logs_path:
          logs_path: '/var/lib/kubelet/pods'
          resource_type: 'pod'</pre>
</div>
</div>

</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="add-id.html">« Generate an ID for an event</a>
</span>
<span class="next">
<a href="add-labels.html">Add labels »</a>
</span>
</div>
</div>
</body>
</html>
