<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Windows wmi metricset | Metricbeat Reference [8.19] | Elastic</title>
<meta class="elastic" name="content" content="Windows wmi metricset | Metricbeat Reference [8.19]">

<link rel="home" href="index.html" title="Metricbeat Reference [8.19]"/>
<link rel="up" href="metricbeat-module-windows.html" title="Windows module"/>
<link rel="prev" href="metricbeat-metricset-windows-service.html" title="Windows service metricset"/>
<link rel="next" href="metricbeat-module-zookeeper.html" title="ZooKeeper module"/>
<meta class="elastic" name="product_version" content="8.19"/>
<meta class="elastic" name="product_name" content="Metricbeat"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Metricbeat/Reference/8.19"/>
<meta name="DC.subject" content="Metricbeat"/>
<meta name="DC.identifier" content="8.19"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="metricbeat-metricset-windows-service.html">« Windows service metricset</a>
</span>
<span class="next">
<a href="metricbeat-module-zookeeper.html">ZooKeeper module »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Metricbeat Reference [8.19]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="metricbeat-modules.html">Modules</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="metricbeat-module-windows.html">Windows module</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Windows wmi metricset</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/metricbeat/module/windows/wmi/_meta/docs.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="metricbeat-metricset-windows-wmi"></a>Windows wmi metricset</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/metricbeat/module/windows/wmi/_meta/docs.asciidoc">edit</a></div>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in beta and is subject to change. The design and code is less mature than official GA features and is being provided as-is with no warranties. Beta features are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>The <code class="literal">wmi</code> metricset of the Windows module collects metrics via <a href="https://learn.microsoft.com/en-us/windows/win32/wmisdk/about-wmi" class="ulink" target="_top">Windows Management Instrumentation</a> (WMI), a core management technology in the Windows Operating system.</p>
<p>By leveraging WMI Query Language (WQL), this metricset allows you to extract detailed
system information and metrics to monitor the health and performance of Windows
Systems.</p>
<p>This metricset leverages the <a href="https://github.com/microsoft/wmi" class="ulink" target="_top">Microsoft WMI</a> library, a
convenient wrapper around the <a href="https://github.com/go-ole" class="ulink" target="_top">Go-OLE</a> library, which allows to invoke the
<a href="https://learn.microsoft.com/en-us/windows/win32/wmisdk/scripting-api-for-wmi" class="ulink" target="_top">Scripting API for WMI</a>.</p>
<div class="position-relative"><h3><a id="_wmi_query_language_wql_support"></a>WMI Query Language (WQL) Support</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/metricbeat/module/windows/wmi/_meta/docs.asciidoc">edit</a></div>
<p>This metricset supports the execution of <a href="https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi" class="ulink" target="_top">WQL</a> queries, a SQL-like query language for retrieving information from WMI namespaces.</p>
<p>Currently, the metricset supports queries with <code class="literal">SELECT</code>, <code class="literal">FROM</code> and <code class="literal">WHERE</code> clauses.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When working with WMI queries, it is the user&#8217;s responsibility to ensure that queries are safe, efficient, and do not cause unintended side effects. A notorious example of a problematic WMI class is Win32_Product. Read more in <a href="https://learn.microsoft.com/en-us/troubleshoot/windows-server/admin-development/windows-installer-reconfigured-all-applications#more-information" class="ulink" target="_top">Windows Documentation</a>.</p>
</div>
</div>
<div class="position-relative"><h4><a id="wmi-arbitrator-and-query-execution"></a>WMI Arbitrator and Query Execution</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/metricbeat/module/windows/wmi/_meta/docs.asciidoc">edit</a></div>
<p>Query execution is managed by the underlying WMI Framework, specifically the <a href="https://learn.microsoft.com/en-us/troubleshoot/windows-server/system-management-components/new-wmi-arbitrator-behavior-in-windows-server" class="ulink" target="_top">WMI Arbitrator</a>.
The Arbitrator is responsible for:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Scheduling and controlling query execution
</li>
<li class="listitem">
Throttling or stopping queries based on system resource availability and conditions
</li>
</ul>
</div>
<p>There is no way to directly stop a query once it has started. To prevent Metricbeat from waiting indefinitely for a query to return a result or fail, Metricbeat has a timeout mechanism that stops waiting for query results after a specified timeout. This is controlled by the <code class="literal">wmi.warning_threshold</code> setting.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>While Metricbeat stops waiting for the result, the underlying WMI query may continue running until the WMI Arbitrator decides to stop execution.</p>
</div>
</div>
<div class="position-relative"><h4><a id="wmi-type-support"></a>WMI type support</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/metricbeat/module/windows/wmi/_meta/docs.asciidoc">edit</a></div>
<p>The <code class="literal">microsoft/wmi</code> library internally uses the WMI Scripting API. This API, as per the
<a href="https://learn.microsoft.com/en-us/windows/win32/wmisdk/querying-wmi" class="ulink" target="_top">official WMI Documentation</a>,
does not provide direct type conversion for <code class="literal">uint64</code>, <code class="literal">sint64</code>, and <code class="literal">datetime</code>
<a href="https://learn.microsoft.com/en-us/windows/win32/wmisdk/common-information-model" class="ulink" target="_top">Common Information Model</a> (CIM) types;
instead, these values are returned as strings.</p>
<p>To ensure the correct data type is reported, Metricbeat dynamically fetches the
CIM type definitions for the properties of the WMI instance classes returned by the query,
and then performs the necessary data type conversions.</p>
<p>To optimize performance and avoid repeatedly fetching these schema definitions
for every row and every request, an LRU cache is utilized. This cache stores
the schema definition for each WMI class-property pair encountered. For queries involving
superclasses, such as <code class="literal">CIM_LogicalDevice</code>, the cache will populate with individual entries
for each specific derived class (leaf of the class hierarchy) whose instances are returned by the query (for example, <code class="literal">Win32_DiskDrive</code> or <code class="literal">Win32_NetworkAdapter</code>).</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The properties of type <code class="literal">CIM_Object</code> (embedded objects) are not yet supported and are ignored.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Properties of type <code class="literal">CIM_Reference</code> (references), which are used in <a href="https://learn.microsoft.com/en-us/windows/win32/wmisdk/declaring-an-association-class" class="ulink" target="_top">WMI Association Classes</a>, are currently returned as string values exactly as reported by the
<a href="https://github.com/microsoft/wmi" class="ulink" target="_top">Microsoft WMI</a> library.</p>
</div>
</div>
<div class="position-relative"><h3><a id="_configuration_21"></a>Configuration</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/metricbeat/module/windows/wmi/_meta/docs.asciidoc">edit</a></div>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">- module: windows
  metricsets: ["wmi"]
  period: 10m
  wmi:
    namespace: "root\\cimv2" # Default Namespace
    warning_threshold: 10m
    include_queries: true
    include_null_properties: false
    include_empty_strings_properties: false
    queries:
    - class: Win32_OperatingSystem
      properties:
      - FreePhysicalMemory
      - FreeSpaceInPagingFiles
      - NumberOfUsers
      where: ""
    - class: Win32_PowerPlan
      properties: []
      where: "IsActive = True"
      namespace: "root\\cimv2\\power" # Overwrites the module namespace in this query</pre>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">wmi.namespace</code></strong></span>
</span>
</dt>
<dd>
The default WMI namespace used for queries. This can be overridden per query.
The default is <code class="literal">root\cimv2</code>.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">wmi.warning_threshold</code></strong></span>
</span>
</dt>
<dd>
The time threshold after which Metricbeat will stop
waiting for the query result and return control to the main flow of the program.
A warning is logged indicating that the query execution has exceeded the threshold.
The default is equal to the period. See <a class="xref" href="metricbeat-metricset-windows-wmi.html#wmi-arbitrator-and-query-execution" title="WMI Arbitrator and Query Execution">WMI Arbitrator and Query Execution</a>
for more details.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">wmi.include_query_class</code></strong></span>
</span>
</dt>
<dd>
If set to <code class="literal">true</code> the metricset include the queried class. Useful if superclasses are queried. The default value is <code class="literal">false</code>.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">wmi.include_queries</code></strong></span>
</span>
</dt>
<dd>
If set to <code class="literal">true</code> the metricset includes the query in the output document. The default value is <code class="literal">false</code>.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">wmi.include_null_properties</code></strong></span>
</span>
</dt>
<dd>
If set to <code class="literal">true</code> the metricset includes the properties that have null value in the output document.
properties that have a <code class="literal">null</code> value in the output document. The default value is <code class="literal">false</code>.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">wmi.include_empty_string_properties</code></strong></span>
</span>
</dt>
<dd>
A boolean option that causes the metricset to include
the properties that are empty string. The default value is <code class="literal">false</code>.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">wmi.max_rows_per_query</code></strong></span>
</span>
</dt>
<dd>
Limits the number of rows returned by a single WMI query.
The default value is <code class="literal">0</code>, which is a special value indicating that all fetched
results should be returned without a row limit.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">wmi.schema_cache_size</code></strong></span>
</span>
</dt>
<dd>
The maximum number of WMI class-property pairs that can be cached per single query. Every query keeps its own separate cache.
This cache helps improve performance when dealing with queries that involve inheritance hierarchies. Read more in <a class="xref" href="metricbeat-metricset-windows-wmi.html#wmi-type-support" title="WMI type support">WMI Type Support</a>. For example, if a superclass is queried, the cache stores entries for each WMI concrete instance class (the leaves of the class hierarchy) and their associated properties. Therefore, querying a superclass that returns a result set containing instances of <code class="literal">10</code> different classes, each with <code class="literal">50</code> properties, will result in a cache size of <code class="literal">500</code> entries (<code class="literal">10×50</code>).
The default value is <code class="literal">1000</code>.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">wmi.queries</code></strong></span>
</span>
</dt>
<dd>
The list of queries to execute. The list cannot be empty. See <a class="xref" href="metricbeat-metricset-windows-wmi.html#query-configuration" title="Query Configuration">Query Configuration</a> for the format of the queries.
</dd>
</dl>
</div>
<div class="position-relative"><h4><a id="query-configuration"></a>Query Configuration</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/metricbeat/module/windows/wmi/_meta/docs.asciidoc">edit</a></div>
<p>Each item in the <code class="literal">queries</code> list specifies a wmi query to perform.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">class</code></strong></span>
</span>
</dt>
<dd>
The wmi class. In the query it specifies the <code class="literal">FROM</code> clause. Required
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">properties</code></strong></span>
</span>
</dt>
<dd>
List of properties to return. In the query it specifies the <code class="literal">SELECT</code> clause. Set it to the empty list (default value) to retrieve all available properties.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">where</code></strong></span>
</span>
</dt>
<dd>
The where clause. In the query it specifies the <code class="literal">WHERE</code> clause. Read more about the format <a href="https://learn.microsoft.com/en-us/windows/win32/wmisdk/where-clause" class="ulink" target="_top">in the Windows Documentation</a>.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">namespace</code></strong></span>
</span>
</dt>
<dd>
The WMI Namespace for this particular query (it overwrites the metricset&#8217;s <code class="literal">namespace</code> value)
</dd>
</dl>
</div>
<div class="position-relative"><h5><a id="_example_6"></a>Example</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/metricbeat/module/windows/wmi/_meta/docs.asciidoc">edit</a></div>
<p>Example WQL Query:</p>
<div class="pre_wrapper lang-sql">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sql">SELECT Name, ProcessId, WorkingSetSize
FROM Win32_Process
WHERE Name = 'lsass.exe' AND WorkingSetSize &gt; 104857600</pre>
</div>
<p>Equivalent YAML Configuration:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">- class: Win32_Process
  properties:
  - Name
  - ProcessId
  - WorkingSetSize
  where: "Name = 'lsass.exe' AND WorkingSetSize &gt; 104857600"</pre>
</div>
<div class="position-relative"><h3><a id="_best_practices"></a>Best Practices</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/metricbeat/module/windows/wmi/_meta/docs.asciidoc">edit</a></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Test your queries in isolation using the <a href="https://learn.microsoft.com/en-us/powershell/module/cimcmdlets/get-ciminstance" class="ulink" target="_top"><code class="literal">Get-CimInstance</code></a> PowerShell cmdlet or <a href="https://github.com/vinaypamnani/wmie2" class="ulink" target="_top">the WMI Explorer tool</a>.
</li>
<li class="listitem">
Ensure that <code class="literal">wmi.warning_threshold</code> is less than or equal to the module&#8217;s <code class="literal">period</code>.
This configuration prevents Metricbeat from starting multiple concurrent executions of the same query.
</li>
<li class="listitem">
When possible, try querying concrete (leaf) classes or classes closer to the leaves of the WMI inheritance hierarchy. Querying abstract superclasses may require fetching and caching the schema definitions for numerous derived classes, which can lead to increased memory usage and potential performance penalties due to cache misses.
</li>
<li class="listitem">
Set up Kibana Alerts for documents generated by this metricset with the <code class="literal">error.message</code> field.
</li>
<li class="listitem">
Configure collection of WMI-Activity Operational Logs (found in Event Viewer under <code class="literal">Applications and Services Logs/Microsoft/Windows/WMI-Activity/Operational</code>). These logs can be invaluable for correlating issues with Metricbeat WMI warnings or documents containing <code class="literal">error.message</code>.
</li>
</ul>
</div>
<div class="position-relative"><h3><a id="_compatibility_51"></a>Compatibility</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/beats/edit/main/metricbeat/module/windows/wmi/_meta/docs.asciidoc">edit</a></div>
<p>This module has been tested on the following platform:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Operating System</th>
<th align="left" valign="top">Architecture</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>Microsoft Windows Server 2019 Datacenter</p></td>
<td align="left" valign="top"><p>x64</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Microsoft Windows 11 Pro</p></td>
<td align="left" valign="top"><p>x64</p></td>
</tr>
</tbody>
</table>
</div>
<p>Other Windows versions and architectures may also work but have not been explicitly tested.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_fields_267"></a>Fields</h3></div>
</div></div></div>
<p>For a description of each field in the metricset, see the
<a class="xref" href="exported-fields-windows.html" title="Windows fields">exported fields</a> section.</p>
<p>Here is an example document generated by this metricset:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
    "@timestamp": "2024-12-12T15:46:39.622Z",
    "event": {
        "dataset": "windows.wmi",
        "duration": 58982500,
        "module": "windows"
    },
    "metricset": {
        "name": "wmi",
        "period": 10000
    },
    "service": {
        "type": "windows"
    },
    "windows": {
        "wmi": {
            "FreePhysicalMemory": 7537796,
            "FreeSpaceInPagingFiles": 2257908,
            "FreeVirtualMemory": 9694064,
            "LocalDateTime": "2024-12-12T15:46:39.62Z",
            "NumberOfUsers": 1,
            "class": "Win32_OperatingSystem",
            "namespace": "root\\cimv2"
        }
    }
}</pre>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="metricbeat-metricset-windows-service.html">« Windows service metricset</a>
</span>
<span class="next">
<a href="metricbeat-module-zookeeper.html">ZooKeeper module »</a>
</span>
</div>
</body>
</html>
