<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Secure your 7.x clusters with LDAP or Active Directory | Elastic Cloud Enterprise Reference [2.2] | Elastic</title>
<link rel="home" href="index.html" title="Elastic Cloud Enterprise Reference [2.2]"/>
<link rel="up" href="ece-securing-clusters.html" title="Secure your clusters"/>
<link rel="prev" href="ece-configuring-keystore.html" title="Secure your settings"/>
<link rel="next" href="ece-securing-clusters-ldap-ad-5x.html" title="Secure your 5.x and 6.x clusters with LDAP or Active Directory"/>
<meta name="DC.type" content="Learn/Docs/CloudEnterprise/Reference/2.2"/>
<meta name="DC.subject" content="ECE"/>
<meta name="DC.identifier" content="2.2"/>
</head>
<body><div class="page_header">
A newer version is available. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Elastic Cloud Enterprise Reference [2.2]</a></span>
»
<span class="breadcrumb-link"><a href="ece-administering-deployments.html">Administering deployments</a></span>
»
<span class="breadcrumb-link"><a href="ece-securing-clusters.html">Secure your clusters</a></span>
»
<span class="breadcrumb-node">Secure your 7.x clusters with LDAP or Active Directory</span>
</div>
<div class="navheader">
<span class="prev">
<a href="ece-configuring-keystore.html">« Secure your settings</a>
</span>
<span class="next">
<a href="ece-securing-clusters-ldap-ad-5x.html">Secure your 5.x and 6.x clusters with LDAP or Active Directory »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="ece-securing-clusters-ldap-ad"></a>Secure your 7.x clusters with LDAP or Active Directory<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/2.2/docs/cloud-enterprise/ce-securing-clusters-ldap-ad.asciidoc">edit</a></h2>
</div></div></div>
<p>These steps show how you can secure your 7.x Elasticsearch clusters and Kibana instances with the Lightweight Directory Access Protocol (LDAP). To authenticate users through LDAP, you must first configure an <code class="literal">ldap</code> realm and map LDAP groups to user roles using the X-Pack security features.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For version 5.x and 6.x, see <a class="xref" href="ece-securing-clusters-ldap-ad-5x.html" title="Secure your 5.x and 6.x clusters with LDAP or Active Directory">Secure your 5.x and 6.x clusters with LDAP or Active Directory</a>.</p>
</div>
</div>
<h3><a id="ece_before_you_begin_21"></a>Before you begin<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/2.2/docs/cloud-enterprise/ce-securing-clusters-ldap-ad.asciidoc">edit</a></h3>
<p>The steps in this section require an understanding of LDAP. To learn more about how securing Elasticsearch clusters with LDAP works, see <a href="/guide/en/elasticsearch/reference/7.0/ldap-realm.html" class="ulink" target="_top">LDAP user authentication</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The LDAP credentials are valid against the deployment, not the ECE platform. You can try out our beta release of <a class="xref" href="ece-configure-rbac.html" title="Configure role-based access control">role-based access control</a> for the platform.</p>
</div>
</div>
<h3><a id="ece-securing-clusters-LDAP"></a>Configure LDAP for certificate-based authentication<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/2.2/docs/cloud-enterprise/ce-securing-clusters-ldap-ad.asciidoc">edit</a></h3>
<p>To configure certificate-based authentication that uses LDAP over SSL:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create an LDAP realm.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Decide which type of verification to perform when connecting to a LDAP server:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
For self-signed certificates: Use <code class="literal">ssl.verification_mode: certificate</code> together with the <code class="literal">ssl.truststore.path</code> and <code class="literal">ssl.truststore.password</code> settings.
</li>
<li class="listitem">
For certificates issued by a trusted source: Use <code class="literal">ssl.verification_mode: full</code> together with the <code class="literal">ssl.truststore.path</code> and <code class="literal">ssl.truststore.password</code> settings.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Create some LDAP entries. In this example, there is one organizational unit <code class="literal">groups</code> with the <code class="literal">administrators</code> and <code class="literal">readonly</code> groups under it. All of the entries are part of the domain LDAP object <code class="literal">dc=example,dc=com</code>.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">admin:
  - "cn=administrators,ou=groups,dc=example,dc=com"
readonly:
  - "cn=users,ou=groups,dc=example,dc=com"</pre>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
Prepare a custom bundle as a ZIP file that contains your keystore file with the private key and certificate inside of a <code class="literal">truststore</code> folder` <a href="/guide/en/cloud/current/ec-custom-bundles.html" class="ulink" target="_top">in the same way that you would on Elastic Cloud</a>. This bundle allows all Elasticsearch containers to access the same keystore file through your <code class="literal">ssl.truststore</code> settings.
</li>
<li class="listitem">
<p>Prepare a custom bundle ZIP file with a <a href="/guide/en/elasticsearch/reference/7.0/mapping-roles.html" class="ulink" target="_top">role mapping file</a> contained inside a <code class="literal">mappings</code> folder. The contents of the role mapping file in our example are:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">admin:
  - "cn=administrators,ou=groups,dc=example,dc=com"
readonly:
  - "cn=users,ou=groups,dc=example,dc=com"</pre>
</div>
</li>
<li class="listitem">
<a class="xref" href="ece-create-deployment.html" title="Create your deployment">Create a deployment</a> in the Cloud UI that you will update for use with LDAP later on. Use Elasticsearch version 7.x or later.
</li>
<li class="listitem">
<p>Update your new Elasticsearch cluster in the <a class="xref" href="ece-advanced-configuration.html" title="Advanced cluster configuration">advanced configuration editor</a> so that it uses the bundles you prepared in a previous step. You need to modify the <code class="literal">user_bundles</code> JSON attribute similar to the following example:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{
  "cluster_name": "xxxxxxx",
  "plan": {

    ...

    "elasticsearch": {
      "version": "7.1.1",
      "user_bundles": [
        {
          "name": "ldap-cert",
          "url": "https://www.myurl.com/ldapcert.zip",
          "elasticsearch_version": "7.1.1"
        },
        {
          "name": "role-mappings",
          "url": "https://www.myurl.com/role-mappings.zip",
          "elasticsearch_version": "7.1.1"
        }
      ]
    }
  }</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The URLs that point to the bundle ZIP files (here <code class="literal">ldapcert.zip</code> and <code class="literal">role-mappings.zip</code>) must be accessible to the cluster.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Note the file locations where custom bundles get unzipped, you will need them in the next step. Custom bundles get unzipped under the path <code class="literal">/app/config/BUNDLE_DIRECTORY_STRUCTURE</code>, where <code class="literal">BUNDLE_DIRECTORY_STRUCTURE</code> is the directory structure within the bundle ZIP file itself. For example:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ tree .
.
└── truststore
      └── keystore.ks</pre>
</div>
<p>In our example, the unzipped keystore file gets placed under <code class="literal">/app/config/truststore/keystore.ks</code> and the unzipped role mappings file under <code class="literal">/app/config/mappings/role-mappings.yml</code>.</p>
</li>
<li class="listitem">
<p><a class="xref" href="ece-add-user-settings.html" title="Add Elasticsearch user settings">Add your user settings</a> for the <code class="literal">ldap</code> realm for your users and groups, and specify your keystore and role mapping files from the previous step. For example:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">xpack:
  security:
    authc:
      realms:
        ldap.ldap1:
          order: 2
          url: "ldaps://SERVER_IP:636" <a id="CO9-1"></a><i class="conum" data-value="1"></i>
          user_search:
            base_dn: "dc=example,dc=com"
            attribute: cn
          group_search:
            base_dn: "ou=groups,dc=example,dc=com"
          ssl:
            verification_mode: certificate
            truststore:
              path: "/app/config/truststore/keystore.ks"
              password: "PASSWORD" <a id="CO9-2"></a><i class="conum" data-value="2"></i>
          files:
            role_mapping: "/app/config/mappings/role-mappings.yml"
          unmapped_groups_as_roles: false</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO9-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The IP address of the LDAP server.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO9-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The password you chose when creating the keystore.</p>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you set the realm <code class="literal">type</code> to <code class="literal">native</code>, the cluster fails to start. Do not combine the native realm with other authentication methods.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist" start="8">
<li class="listitem">
After the cluster configuration is updated, log into Kibana with the different users in your LDAP realm and verify that they can access the product features and data you expect. For example, in this case the <code class="literal">readonly</code> user should be able to read indices based on the roles you granted, but it should not be able to write to indices or manage security features.
</li>
</ol>
</div>
<h3><a id="ece-securing-clusters-LDAP-role-mapping"></a>Configure LDAP with the role mapping API<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/2.2/docs/cloud-enterprise/ce-securing-clusters-ldap-ad.asciidoc">edit</a></h3>
<p>To configure certificate-based authentication with LDAP using the <a href="/guide/en/elasticsearch/reference/7.0/security-api-role-mapping.html" class="ulink" target="_top">Role Mapping API</a>:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Follow steps 1 through 5 <a class="xref" href="ece-securing-clusters-ldap-ad.html#ece-securing-clusters-LDAP" title="Configure LDAP for certificate-based authentication">in the previous section</a>, <span class="strong strong"><strong>excluding step 3</strong></span>. These steps walk you through configuring an LDAP realm, creating a custom bundle with your keystore file, creating a deployment, and updating your Elasticsearch cluster configuration to use the bundle.
</li>
<li class="listitem">
<p><a class="xref" href="ece-add-user-settings.html" title="Add Elasticsearch user settings">Edit the user settings</a> for your cluster to add minimal LDAP settings, replacing <code class="literal">SERVER_IP</code> with your own information:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">xpack:
  security:
    authc:
      realms:
        ldap.ldap1:
          order: 2
          url: "ldap://SERVER_IP:389"
          user_search:
            base_dn: "dc=example,dc=com"
            attribute: cn
          group_search:
            base_dn: "ou=groups,dc=example,dc=com"
          unmapped_groups_as_roles: false</pre>
</div>
</li>
</ol>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you set the realm <code class="literal">type</code> to <code class="literal">native</code>, the cluster fails to start. Do not combine the native realm with other authentication methods.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist" start="3">
<li class="listitem">
Map roles to your users with the <a href="/guide/en/elasticsearch/reference/7.0/security-api-role-mapping.html" class="ulink" target="_top">Role Mapping API</a>. For example, you can create an <code class="literal">admin</code> user with roles that map to the <code class="literal">elastic</code> superuser role and a <code class="literal">readonly</code> user that maps to some read-only roles.
</li>
<li class="listitem">
After the cluster configuration is updated, log into Kibana with the different users in your LDAP realm and verify that they can access the functionality and data you expect. For example, in this case, the <code class="literal">readonly</code> user should be able to read indices based on the roles you granted, but it should not be able to write to indices or manage security features.
</li>
</ol>
</div>
<h3><a id="ece-configure-AD-settings"></a>Configure LDAP and Active Directory<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/2.2/docs/cloud-enterprise/ce-securing-clusters-ldap-ad.asciidoc">edit</a></h3>
<p>The steps in this section require an understanding of Active Directory. To learn more about how securing Elasticsearch clusters with Active Directory works, see <a href="/guide/en/elasticsearch/reference/7.0/active-directory-realm.html" class="ulink" target="_top">AD user authentication</a>.</p>
<p>To configure LDAP with Active Directory:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Create or use an existing deployment.
</li>
<li class="listitem">
<p>If you are planning to encrypt the communication between ECE and the Active directory, upload a custom bundle as a ZIP file to your Elasticsearch cluster in the <a class="xref" href="ece-advanced-configuration.html" title="Advanced cluster configuration">advanced configuration editor</a>.</p>
<p>The bundle should contain your keystore file with the private key and certificate inside of a <code class="literal">truststore</code> folder allowing all Elasticsearch containers to access the same keystore file through your <code class="literal">ssl.truststore</code> settings.</p>
<p>You need to modify the <code class="literal">user_bundles</code> JSON attribute similar to the following example:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{
  "cluster_name": "xxxxxxx",
  "plan": {

    ...

    "elasticsearch": {
      "version": "7.1.1",
      "user_bundles": [
        {
          "name": "ad-cert",
          "url": "https://www.myurl.com/adcert.zip",
          "elasticsearch_version": "7.1.1"
        },
        {
          "name": "role-mappings",
          "url": "https://www.myurl.com/role-mappings.zip",
          "elasticsearch_version": "7.1.1"
        }
      ]
    }
  }</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The URLs that point to the bundle ZIP files (here <code class="literal">ldapcert.zip</code> and <code class="literal">role-mappings.zip</code>) must be accessible to the cluster.</p>
</div>
</div>
</li>
<li class="listitem">
Restart the Elasticsearch cluster.
</li>
<li class="listitem">
<p>Configure the <a class="xref" href="ece-add-user-settings.html" title="Add Elasticsearch user settings">user settings</a> for your Elasticsearch cluster to use Active Directory:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">xpack:
  security:
    authc:
      realms:
        active_directory:
          my_ad:
            order: 2
            domain_name: AD_DOMAIN_NAME.com
            url: ldaps://SERVER_IP:636
            user_search:
              base_dn: "dc=example,dc=com"
              attribute: cn
            group_search:
              base_dn: "ou=groups,dc=example,dc=com"
              unmapped_groups_as_roles: false
            ssl:
              verification_mode: certificate
              truststore:
                path: "/app/config/pem/keystore.ks"
                password: "secret"</pre>
</div>
<p>There are three SSL verification mode options:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">certificate</code> for self-signed certificates. Must include the <code class="literal">path</code> and <code class="literal">password</code>.
</li>
<li class="listitem">
<code class="literal">full</code> for certificates issued by a trusted source. Must include the <code class="literal">path</code> and <code class="literal">password</code>.
</li>
<li class="listitem">
<p><code class="literal">none</code> where all certificates are trusted, regardless of issuer.</p>
<p>Alternatively, you can remove these lines entirely to avoid using SSL.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="olist orderedlist">
<ol class="orderedlist" start="5">
<li class="listitem">
After the cluster configuration is updated, log into Kibana with the different users in your Active Directory realm and verify that they can access the product features and data you expect. For example, in this case the <code class="literal">readonly</code> user should be able to read indices based on the roles you granted, but they should not be able to write to indices or manage security features.
</li>
</ol>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you set the realm <code class="literal">type</code> to <code class="literal">native</code>, the cluster fails to start. Do not combine the native realm with other authentication methods.</p>
</div>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="ece-configuring-keystore.html">« Secure your settings</a>
</span>
<span class="next">
<a href="ece-securing-clusters-ldap-ad-5x.html">Secure your 5.x and 6.x clusters with LDAP or Active Directory »</a>
</span>
</div>
</div>
</body>
</html>
