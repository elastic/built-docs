<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Rebuilding a broken Zookeeper quorum | Elastic Cloud Enterprise Reference [3.7] | Elastic</title>
<meta class="elastic" name="content" content="Rebuilding a broken Zookeeper quorum | Elastic Cloud Enterprise Reference [3.7]">

<link rel="home" href="index.html" title="Elastic Cloud Enterprise Reference [3.7]"/>
<link rel="up" href="ece-troubleshooting.html" title="Troubleshooting"/>
<link rel="prev" href="ece-zookeeper-sync.html" title="Verify ZooKeeper Sync Status"/>
<link rel="next" href="ece-run-ece-diagnostics.html" title="Run ECE diagnostics tool"/>
<meta class="elastic" name="product_version" content="3.7"/>
<meta class="elastic" name="product_name" content="ECE"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/CloudEnterprise/Reference/3.7"/>
<meta name="DC.subject" content="ECE"/>
<meta name="DC.identifier" content="3.7"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="ece-zookeeper-sync.html">« Verify ZooKeeper Sync Status</a>
</span>
<span class="next">
<a href="ece-run-ece-diagnostics.html">Run ECE diagnostics tool »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Cloud Enterprise Reference [3.7]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="ece-troubleshooting.html">Troubleshooting</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Rebuilding a broken Zookeeper quorum</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-105/docs/cloud-enterprise/ce-troubleshooting-zookeeper-quorum.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="chapter">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="ece-troubleshooting-zookeeper-quorum"></a>Rebuilding a broken Zookeeper quorum</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-105/docs/cloud-enterprise/ce-troubleshooting-zookeeper-quorum.asciidoc">edit</a></div>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This article covers an advanced recovery method involving directly modifying Zookeeper. This process can potentially corrupt your data. Elastic
recommends only following this outline after receiving
<a class="xref" href="ece-getting-help.html" title="Ask for help">confirmation by Elastic Support</a>.</p>
</div>
</div>
<p>This article describes how to recover a broken Zookeeper leader or follower
within Elastic Cloud Enterprise.</p>
<div class="position-relative"><h3><a id="ece-troubleshooting-zookeeper-quorum-check"></a>When to recover</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-105/docs/cloud-enterprise/ce-troubleshooting-zookeeper-quorum.asciidoc">edit</a></div>
<p>When an ECE director host&#8217;s Zookeeper status cannot be determined healthy using the
<a class="xref" href="ece-zookeeper-sync.html" title="Verify ZooKeeper Sync Status">Verify Zookeeper sync status</a> command or from <span class="strong strong"><strong>Elastic Cloud Enterprise</strong></span> &gt;
<span class="strong strong"><strong>Platform</strong></span> &gt; <span class="strong strong"><strong>Settings</strong></span>, then you might need to recover Zookeeper.</p>
<p>This situation might surface when recovering the Elastic Cloud Enterprise director
host from a full disk issue.</p>
<p>A healthy Zookeeper quorum returns a sync status similar to the following. Any other responses require further investigation.</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">$ # Zookeeper leader with id:10
$ echo mntr | nc 127.0.0.1 2191
zk_server_state  leader
# ...
zk_followers         2
zk_synced_followers  2

$ # Zookeeper follower with id:11
$ echo mntr | nc 127.0.0.1 2192
zk_server_state follower

$ # Zookeeper follower with id:12
$ echo mntr | nc 127.0.0.1 2193
zk_server_state follower</pre>
</div>
<div class="position-relative"><h3><a id="ece_back_up_data_directories"></a>Back up data directories</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-105/docs/cloud-enterprise/ce-troubleshooting-zookeeper-quorum.asciidoc">edit</a></div>
<p>Before recovering the Zookeeper leader or follower, back up all Elastic Cloud Enterprise hosts' Zookeeper data
directories. Normally this is only applicable to director hosts, but may apply
to other hosts during migrations.</p>
<p>Perform the following steps on each host to back up the Zookeeper data directory:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Extract the Zookeeper <code class="literal">/data</code> directory path:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">$ docker inspect --format '{{ range .Mounts }}{{ .Source }} {{ end }}' frc-zookeeper-servers-zookeeper | grep --color=auto \"zookeeper/data\"</pre>
</div>
</li>
<li class="listitem">
<p>Make a copy or backup of the emitted directory. For example, if data directory is <code class="literal">/mnt/data/elastic/172.16.0.30/services/zookeeper/data</code>,
then run the following command:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">$ cp -R /mnt/data/elastic/172.16.0.30/services/zookeeper/data /mnt/data/elastic/ZK_data_backup</pre>
</div>
</li>
</ol>
</div>
<div class="position-relative"><h3><a id="ece_determine_the_zookeeper_leader"></a>Determine the Zookeeper leader</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-105/docs/cloud-enterprise/ce-troubleshooting-zookeeper-quorum.asciidoc">edit</a></div>
<p>If a Zookeeper quorum is broken, you must establish the best
Zookeeper leader to use for recovery before you start the recovery proces.</p>
<p>The simplest way to check is using the
<a class="xref" href="ece-zookeeper-sync.html" title="Verify ZooKeeper Sync Status">Zookeeper sync status</a> command.</p>
<p>If this command is not reporting
any leaders, then perform the following actions on each director host:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
SSH into the host.
</li>
<li class="listitem">
<p>Enter the Docker <code class="literal">frc-zookeeper-servers-zookeeper</code> container and check its
<code class="literal">/app/logs/zookeeper.log</code> logs for <code class="literal">LEADING</code>:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">$ docker exec -it frc-zookeeper-servers-zookeeper bash
root@XXXXX:/# cat /app/logs/zookeeper.log | grep 'LEADING'</pre>
</div>
<p>This command will return results similar to the following:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">INFO  [QuorumPeer[myid=10](plain=0.0.0.0:2191)(secure=disabled):o.a.z.s.q.QuorumPeer@1549] - LEADING
INFO  [QuorumPeer[myid=10](plain=0.0.0.0:2191)(secure=disabled):o.a.z.s.q.Leader@588] - LEADING - LEADER ELECTION TOOK - 225 MS</pre>
</div>
</li>
<li class="listitem">
If multiple directors report this log, then determine the one with the latest
timestamp, which will contain the latest Zookeeper state.
</li>
</ol>
</div>
<div class="position-relative"><h3><a id="ece_recover_zookeeper_nodes"></a>Recover Zookeeper nodes</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-105/docs/cloud-enterprise/ce-troubleshooting-zookeeper-quorum.asciidoc">edit</a></div>
<p>In the following recovery steps, the steps for the determined leader are marked with <code class="literal">[leader]</code>, and the steps for all other
Zookeepers are marked with <code class="literal">[followers]</code>. The <code class="literal">[leader]</code> should be recovered as needed before
its <code class="literal">[followers]</code>. Steps marked <code class="literal">[followers]</code> should be performed on each
follower director host, and steps marked <code class="literal">[director]</code> should be performed only on problematic director hosts.</p>
<div class="position-relative"><h4><a id="ece-troubleshooting-zookeeper-quorum-leader"></a>Recover the Zookeeper Leader</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-105/docs/cloud-enterprise/ce-troubleshooting-zookeeper-quorum.asciidoc">edit</a></div>
<div class="position-relative"><h5><a id="ece_restart_the_zookeeper_container"></a>Restart the Zookeeper container</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-105/docs/cloud-enterprise/ce-troubleshooting-zookeeper-quorum.asciidoc">edit</a></div>
<p>To recover the Zookeeper leader, you should first try to restart the Docker
Zookeeper container. Restarting the container is often enough to trigger the leader to resync its
connection to its followers.</p>
<p>Within a SSH session of Zookeeper hosts, run the following command:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">$ docker restart frc-zookeeper-servers-zookeeper</pre>
</div>
<p>Wait a few minutes for state to attempt to sync across leader and
followers, then <a class="xref" href="ece-zookeeper-sync.html" title="Verify ZooKeeper Sync Status">verify the Zookeeper sync status</a> to
see if the quorum has recovered.</p>
<p>If the Zookeeper leader is still not recovered, proceed to the next section.</p>
<div class="position-relative"><h5><a id="ece_manually_set_the_zookeeper_leader"></a>Manually set the Zookeeper leader</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-105/docs/cloud-enterprise/ce-troubleshooting-zookeeper-quorum.asciidoc">edit</a></div>
<p>If restarting the Zookeeper container does not recover the leader, you can manually set the leader and rebuild the quorum.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p><code class="literal">[followers]</code> Shut down the Docker Runner and Zookeeper containers:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">$ docker stop frc-runners-runner
$ docker stop frc-zookeeper-servers-zookeeper</pre>
</div>
</li>
<li class="listitem">
<p><code class="literal">[leader]</code> Stop the Zookeeper service within the Docker container. Note this
is stopping the service within the Docker container and not stopping the
Zookeeper Docker container itself:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">$ docker exec -it frc-zookeeper-servers-zookeeper sv stop zookeeper</pre>
</div>
</li>
<li class="listitem">
<p><code class="literal">[leader]</code> Enter the Docker Zookeeper container and determine its Zookeeper ID:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">$ docker exec -it frc-zookeeper-servers-zookeeper bash
root@XXXXX:/# cat /app/data/myid
10</pre>
</div>
</li>
<li class="listitem">
<p><code class="literal">[leader]</code> In the directory <code class="literal">/app/managed/</code>, modify the Zookeeper file
<code class="literal">replicated.cfg.dynamic</code>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Remove the lines referencing other Zookeeper hosts.
</li>
<li class="listitem">
If multiple lines reference <code class="literal">localhost</code>, then remove all but the one containing
the Zookeeper ID from the previous step.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><code class="literal">[leader]</code> Restart the Docker Zookeeper and Director containers:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">$ docker restart frc-zookeeper-servers-zookeeper
$ docker restart frc-directors-director</pre>
</div>
</li>
<li class="listitem">
<code class="literal">[leader]</code> Check the <a class="xref" href="ece-zookeeper-sync.html" title="Verify ZooKeeper Sync Status">Zookeeper sync status</a>. The response should now show this director host as the Zookeeper leader.
</li>
<li class="listitem">
Confirm that Elastic Cloud Enterprise is now also able to check the Zookeeper status and make
changes.
</li>
<li class="listitem">
<p><code class="literal">[followers]</code> Restart the Docker Zookeeper, Director, and Runner containers:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">$ docker restart frc-zookeeper-servers-zookeeper
$ docker restart frc-directors-director
$ docker restart frc-runners-runner</pre>
</div>
</li>
<li class="listitem">
Verify that the <a class="xref" href="ece-zookeeper-sync.html" title="Verify ZooKeeper Sync Status">Zookeeper sync status</a> reports an odd number for <code class="literal">zk_quorum_size</code> and that no Zookeeper hosts are marked as <code class="literal">lost</code>.
</li>
</ol>
</div>
<div class="position-relative"><h4><a id="ece-troubleshooting-zookeeper-quorum-follower"></a>Recover the Zookeeper follower</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-105/docs/cloud-enterprise/ce-troubleshooting-zookeeper-quorum.asciidoc">edit</a></div>
<p>Zookeeper followers can sometimes refuse a <code class="literal">[leader]</code> election or become state
corrupted. The following steps can be used to recover a broken or corrupted
Zookeeper <code class="literal">[follower]</code>. These steps should only be considered after confirming
a Zookeeper leader, as the <code class="literal">[follower]</code> will be reset to copy the state from
<code class="literal">[leader]</code>.</p>
<p>On the <code class="literal">[follower]</code>, do the following:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Get the director host&#8217;s Zookeeper <code class="literal">/data</code> directory path:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">$ docker inspect --format '{{ range .Mounts }}{{ .Source }} {{ end }}' frc-zookeeper-servers-zookeeper | grep --color=auto \"zookeeper/data\"</pre>
</div>
</li>
<li class="listitem">
<p>Stop the Docker Runner and Zookeeper containers:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">$ docker stop frc-runners-runner
$ docker stop frc-zookeeper-servers-zookeeper</pre>
</div>
</li>
<li class="listitem">
<p>Under the determined <code class="literal">/data</code> directory, remove the sub-directory
<code class="literal">data/version-NUMBER</code>, replacing the <code class="literal">NUMBER</code> placeholder.</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">/mnt/data/elastic/MY_IP/services/zookeeper/data$ rm -R ./version-NUMBER/</pre>
</div>
<p>Make sure that <code class="literal">myid</code> file exists and is retained.</p>
</li>
<li class="listitem">
<p>Start the Runner container, which will auto-start the Docker Zookeeper
container.</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">$ docker start frc-runners-runner</pre>
</div>
</li>
<li class="listitem">
<p>Wait a few minutes for Zookeeper states to sync. Then check the <a class="xref" href="ece-zookeeper-sync.html" title="Verify ZooKeeper Sync Status">Zookeeper sync status</a> to confirm the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">zk_server_state follower</code>
</li>
<li class="listitem">
<code class="literal">zk_outstanding_requests 0</code>
</li>
</ul>
</div>
</li>
<li class="listitem">
Confirm that the <code class="literal">[leader]</code> recognizes the added <code class="literal">[follower]</code> by checking the <a class="xref" href="ece-zookeeper-sync.html" title="Verify ZooKeeper Sync Status">Zookeeper sync status</a> for an incremented <code class="literal">zk_synced_followers</code> count.
</li>
</ol>
</div>
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains('stemblock')) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</div><div class="navfooter">
<span class="prev">
<a href="ece-zookeeper-sync.html">« Verify ZooKeeper Sync Status</a>
</span>
<span class="next">
<a href="ece-run-ece-diagnostics.html">Run ECE diagnostics tool »</a>
</span>
</div>
</body>
</html>
