<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Secure your 7.x clusters with Active Directory | Elastic Cloud Enterprise Reference [3.5] | Elastic</title>
<meta class="elastic" name="content" content="Secure your 7.x clusters with Active Directory | Elastic Cloud Enterprise Reference [3.5]">

<link rel="home" href="index.html" title="Elastic Cloud Enterprise Reference [3.5]"/>
<link rel="up" href="ece-securing-clusters.html" title="Secure your clusters"/>
<link rel="prev" href="ece-securing-clusters-ldap.html" title="Secure your 7.x clusters with LDAP"/>
<link rel="next" href="ece-securing-clusters-ldap-5x.html" title="Secure your 5.x and 6.x clusters with LDAP"/>
<meta class="elastic" name="product_version" content="3.5"/>
<meta class="elastic" name="product_name" content="ECE"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/CloudEnterprise/Reference/3.5"/>
<meta name="DC.subject" content="ECE"/>
<meta name="DC.identifier" content="3.5"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Cloud Enterprise Reference [3.5]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="ece-administering-deployments.html">Administering deployments</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="ece-securing-clusters.html">Secure your clusters</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="ece-securing-clusters-ldap.html">« Secure your 7.x clusters with LDAP</a>
</span>
<span class="next">
<a href="ece-securing-clusters-ldap-5x.html">Secure your 5.x and 6.x clusters with LDAP »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="ece-securing-clusters-ad"></a>Secure your 7.x clusters with Active Directory<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-81/docs/cloud-enterprise/ce-securing-clusters-ad.asciidoc">edit</a></h2>
</div></div></div>
<p>These steps show how you can secure your 7.x Elasticsearch clusters and Kibana instances with the Lightweight Directory Access Protocol
(LDAP) using an Active Directory.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For version 5.x and 6.x, check <a class="xref" href="ece-securing-clusters-ad-5x.html" title="Secure your 5.x and 6.x clusters with Active Directory">Secure your 5.x and 6.x clusters with Active Directory</a>.</p>
</div>
</div>
<h3><a id="ece_before_you_begin_19"></a>Before you begin<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-81/docs/cloud-enterprise/ce-securing-clusters-ad.asciidoc">edit</a></h3>
<p>To learn more about how securing Elasticsearch clusters with Active Directory works,
check <a href="/guide/en/elasticsearch/reference/8.8/active-directory-realm.html" class="ulink" target="_top">Active Directory user authentication</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The AD credentials are valid against the deployment, not the ECE platform. You can configure
<a class="xref" href="ece-configure-rbac.html" title="Configure role-based access control">role-based access control</a> for the platform separately.</p>
</div>
</div>
<h3><a id="ece-securing-clusters-ad-configuration"></a>Configure authentication with Active Directory<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-81/docs/cloud-enterprise/ce-securing-clusters-ad.asciidoc">edit</a></h3>
<p>You can configure the deployment to authenticate users by communicating with an
Active Directory Domain Controller. To integrate with Active Directory, you need
to configure an <code class="literal">active_directory</code> realm and map Active Directory groups to user
roles in Elasticsearch.</p>
<p>Contrary to the <code class="literal">ldap</code> realm, the <code class="literal">active_directory</code> realm only supports a user
search mode, but you can choose whether to use a bind user.</p>
<h4><a id="ece-ad-configuration-without-bind-user"></a>Configure an Active Directory realm without a bind user<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-81/docs/cloud-enterprise/ce-securing-clusters-ad.asciidoc">edit</a></h4>
<p>The Active Directory realm authenticates users using an LDAP bind request. By
default, all LDAP operations run as the authenticated user if you don&#8217;t specify
a <code class="literal">bind_dn</code>. Alternatively, you can choose to
<a class="xref" href="ece-securing-clusters-ad.html#ece-ad-configuration-with-bind-user" title="Configure an Active Directory realm with a bind user">configure your realm with a bind user</a>.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p><a class="xref" href="ece-add-user-settings.html" title="Add Elasticsearch user settings">Add your user settings</a> for the <code class="literal">active_directory</code> realm as follows:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
 security:
   authc:
     realms:
       active_directory:
         my_ad:
           order: 2 <a id="CO42-1"></a><i class="conum" data-value="1"></i>
           domain_name: ad.example.com <a id="CO42-2"></a><i class="conum" data-value="2"></i>
           url: ldap://ad.example.com:389 <a id="CO42-3"></a><i class="conum" data-value="3"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO42-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The order in which the <code class="literal">active_directory</code> realm is consulted during an authentication attempt.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO42-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The primary domain in Active Directory. Binding to Active Directory fails if the domain name is not mapped in DNS.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO42-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The LDAP URL pointing to the Active Directory Domain Controller that should handle authentication. If your Domain Controller is configured to use
LDAP over TLS and it uses a self-signed certificate or a certificate that is signed by your organization&#8217;s CA, refer to <a class="xref" href="ece-securing-clusters-ad.html#ece-ad-configuration-encrypt-communications" title="Using self-signed certificates">using self-signed certificates</a>.</p>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<h4><a id="ece-ad-configuration-with-bind-user"></a>Configure an Active Directory realm with a bind user<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-81/docs/cloud-enterprise/ce-securing-clusters-ad.asciidoc">edit</a></h4>
<p>You can choose to configure an Active Directory realm using a bind user.
When you specify a <code class="literal">bind_dn</code>, this specific user is used to search for the
Distinguished Name (<code class="literal">DN</code>) of the authenticating user based on the provided
username and an LDAP attribute. If found, this user is authenticated by
attempting to bind to the LDAP server using the found <code class="literal">DN</code> and the provided
password.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p><a class="xref" href="ece-add-user-settings.html" title="Add Elasticsearch user settings">Add your user settings</a> for the <code class="literal">active_directory</code> realm as follows:</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>You must apply the user settings to each <a class="xref" href="ece-configuring-ece-templates.html" title="Configure deployment templates">deployment template</a>.</p>
</div>
</div>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">xpack:
 security:
   authc:
     realms:
       active_directory:
         my_ad:
           order: 2 <a id="CO43-1"></a><i class="conum" data-value="1"></i>
           domain_name: ad.example.com <a id="CO43-2"></a><i class="conum" data-value="2"></i>
           url: ldap://ad.example.com:389 <a id="CO43-3"></a><i class="conum" data-value="3"></i>
           bind_dn: es_svc_user@ad.example.com <a id="CO43-4"></a><i class="conum" data-value="4"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The order in which the <code class="literal">active_directory</code> realm is consulted during an authentication attempt.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The primary domain in Active Directory. Binding to Active Directory fails if the domain name is not mapped in DNS.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The LDAP URL pointing to the Active Directory Domain Controller that should handle authentication. If your Domain Controller is configured to use
LDAP over TLS and it uses a self-signed certificate or a certificate that is signed by your organization&#8217;s CA, refer to <a class="xref" href="ece-securing-clusters-ad.html#ece-ad-configuration-encrypt-communications" title="Using self-signed certificates">using self-signed certificates</a>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The user to run as for all Active Directory search requests.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>Configure the password for the <code class="literal">bind_dn</code> user by adding the appropriate
<code class="literal">secure_bind_password</code> setting to the Elasticsearch keystore.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>From the <span class="strong strong"><strong>Deployments</strong></span> page, select your deployment.</p>
<p>Narrow the list by name, ID, or choose from several other filters. To further define the list, use a combination of filters.</p>
</li>
<li class="listitem">
From your deployment menu, select <span class="strong strong"><strong>Security</strong></span>.
</li>
<li class="listitem">
Under the <span class="strong strong"><strong>Elasticsearch keystore</strong></span> section, select <span class="strong strong"><strong>Add settings</strong></span>.
</li>
<li class="listitem">
On the <span class="strong strong"><strong>Create setting</strong></span> window, select the secret <span class="strong strong"><strong>Type</strong></span> to be <code class="literal">Secret String</code>.
</li>
<li class="listitem">
<p>Set the <span class="strong strong"><strong>Setting name</strong></span> to <code class="literal">xpack.security.authc.realms.active_directory.&lt;my_ad&gt;.secure_bind_password</code> and add the password for the <code class="literal">bind_dn</code> user
in the <code class="literal">secret</code> field.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>After you configure <code class="literal">secure_bind_password</code>, any attempt to restart the deployment will fail until you complete the rest of the
configuration steps. If you wish to rollback the Active Directory realm related configuration effort, you need to remove the
<code class="literal">xpack.security.authc.realms.active_directory.my_ad.secure_bind_password</code> that was just added by clicking <span class="strong strong"><strong>Remove</strong></span> by the setting name under <code class="literal">Existing Keystores</code>.</p>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<h4><a id="ece-ad-configuration-encrypt-communications"></a>Using self-signed certificates<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-81/docs/cloud-enterprise/ce-securing-clusters-ad.asciidoc">edit</a></h4>
<p>If your LDAP server uses a self-signed certificate or a certificate
that is signed by your organization&#8217;s CA, you need to enable the deployment to
trust this certificate. These steps are required only if TLS is enabled and the
Active Directory controller is using self-signed certificates.</p>
<p>You&#8217;ll prepare a custom bundle that contains your certificate
<a href="/guide/en/cloud/current/ec-custom-bundles.html" class="ulink" target="_top">in the same way that you would on Elasticsearch Service</a>. Custom bundles are extracted in the path
<code class="literal">/app/config/BUNDLE_DIRECTORY_STRUCTURE</code>, where <code class="literal">BUNDLE_DIRECTORY_STRUCTURE</code> is
the directory structure within the bundle ZIP file itself. For example:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ tree .
.
└── adcert
     └── ca.crt</pre>
</div>
<p>In the following example, the keystore file would be extracted to
<code class="literal">/app/config/adcert/ca.crt</code>, where <code class="literal">ca.crt</code> is the name of the certificate.</p>
<div class="sidebar">
<div class="titlepage"><div><div>
<p class="title"><strong>Certificate formats</strong></p>
</div></div></div>
<p>The following example uses a PEM encoded certificate. If your CA certificate
is available as a <code class="literal">JKS</code> or <code class="literal">PKCS#12</code> keystore, you can upload that file in a
ZIP bundle and reference it in the user settings. For example, you can create a
ZIP file from a <code class="literal">truststore</code> folder that contains a keystore named
<code class="literal">ca.p12</code> and reference that file:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.active_directory.my_ad.ssl.truststore.path:
"/app/config/truststore/ca.p12"</pre>
</div>
<p>If the keystore is also password protected (which isn&#8217;t typical for keystores
that only contain CA certificates), you can also provide the password for the
keystore by adding <code class="literal">xpack.security.authc.realms.active_directory.my_ad.ssl.truststore.password: password</code> in the user settings.</p>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Create a ZIP file that contains your CA certificate file, such as <code class="literal">adcert.zip</code>.
</li>
<li class="listitem">
<p>Update your plan in the <a class="xref" href="ece-advanced-configuration.html" title="Advanced cluster configuration">advanced configuration editor</a>
so that it uses the bundle you prepared in the previous step. You need to modify
the <code class="literal">user_bundles</code> JSON attribute similar to the following example:</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You must specify the <code class="literal">user_bundles</code> attribute for each
<a class="xref" href="ece-configuring-ece-templates.html" title="Configure deployment templates">deployment template</a>.</p>
</div>
</div>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{
"cluster_name": "REPLACE_WITH_YOUR_CLUSTER_NAME",
"plan": {


   ...


   "elasticsearch": {
     "version": "7.*",
     "user_bundles": [
       {
         "name": "adcert",
         "url": "https://www.myurl.com/adcert.zip", <a id="CO44-1"></a><i class="conum" data-value="1"></i>
         "elasticsearch_version": "7.*" <a id="CO44-2"></a><i class="conum" data-value="2"></i>
       }
     ]
   }
 }</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO44-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The URL that points to the <code class="literal">adcert.zip</code> file must be accessible to the cluster. Uploaded files are stored using Amazon&#8217;s highly-available S3 service.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO44-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>This bundle is compatible with any Elasticsearch <code class="literal">7.*</code> version.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Using a wildcard for the minor version ensures that the bundle is
compatible with the specified Elasticsearch major version, and eliminates the need to
upload a new bundle when upgrading to a new minor version.</p>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>Update <a class="xref" href="ece-add-user-settings.html" title="Add Elasticsearch user settings">your user settings</a> for the <code class="literal">active_directory</code> realm as follows:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
 security:
   authc:
     realms:
       active_directory:
         my_ad:
           order: 2
           domain_name: ad.example.com
           url: /app/config/adcert/ca.crt <a id="CO45-1"></a><i class="conum" data-value="1"></i>
           bind_dn: es_svc_user@ad.example.com
           ssl:
             certificate_authorities: ["/app/config/cacerts/ca.crt"]</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO45-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">ldaps</code> URL pointing to the Active Directory Domain Controller.</p>
</td>
</tr>
</table>
</div>
<p>The <code class="literal">ssl.verification_mode</code> setting (not shown) indicates the type of verification
to use when using <code class="literal">ldaps</code> to protect against man-in-the-middle attacks and certificate
forgery. The value for this property defaults to <code class="literal">full</code>. When you configure Elasticsearch
to connect to a Domain Controller using TLS, it attempts to verify the hostname
or IP address specified by the <code class="literal">url</code> attribute in the realm configuration with
the Subject Alternative Names (SAN) in the certificate. If the SAN values in the
certificate and realm configuration don&#8217;t match, Elasticsearch does not allow a connection
to the Domain Controller. You can disable this behavior by setting the <code class="literal">ssl.
verification_mode</code> property to <code class="literal">certificate</code>.</p>
</li>
</ol>
</div>
<h3><a id="ece-securing-clusters-ad-role-mapping"></a>Mapping Active Directory groups to roles<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-81/docs/cloud-enterprise/ce-securing-clusters-ad.asciidoc">edit</a></h3>
<p>You have two ways of mapping Active Directory groups to roles for your users. The preferred one is to use the
<a href="/guide/en/elasticsearch/reference/8.8/security-api-put-role-mapping.html" class="ulink" target="_top">role mapping API</a>. If for some reason this is not possible, you can use
a <a href="/guide/en/elasticsearch/reference/8.8/mapping-roles.html" class="ulink" target="_top">role mapping file</a> to specify the mappings instead.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Only Active Directory security groups are supported. You cannot map distribution groups to roles.</p>
</div>
</div>
<h4><a id="ece_using_the_role_mapping_api_2"></a>Using the Role Mapping API<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-81/docs/cloud-enterprise/ce-securing-clusters-ad.asciidoc">edit</a></h4>
<p>Let&#8217;s assume that you want all your users that authenticate through AD to have read-only access to a certain index <code class="literal">my-index</code> and the AD users that are members of the <code class="literal">cn=administrators, dc=example, dc=com</code> group in LDAP, to become superusers in your deployment:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create the read-only role</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">POST /_security/role/read-only-my-index <a id="CO46-1"></a><i class="conum" data-value="1"></i>
{
"indices": [
{
"names": [ "my-index" ],
"privileges": [ "read" ]
}
 ]
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO46-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the role.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>Create the relevant role mapping rule for read only users</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">POST /_security/role_mapping/ad-read-only <a id="CO47-1"></a><i class="conum" data-value="1"></i>
{
"enabled": true,
"roles": [ "read-only-my-index" ], <a id="CO47-2"></a><i class="conum" data-value="2"></i>
"rules": {
"field": { "realm.name": "my_ad" } <a id="CO47-3"></a><i class="conum" data-value="3"></i>
},
"metadata": { "version": 1 }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO47-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the role mapping.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO47-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the role we created earlier.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO47-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of our Active Directory realm.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>Create the relevant role mapping rule for superusers</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">POST /_security/role_mapping/ldap-superuser <a id="CO48-1"></a><i class="conum" data-value="1"></i>
{
"enabled": true,
"roles": [ "superuser" ], <a id="CO48-2"></a><i class="conum" data-value="2"></i>
"rules": {
"all" : [
{ "field": { "realm.name": "my_ad" } },<a id="CO48-3"></a><i class="conum" data-value="3"></i>
{ "field": { "groups": "cn=administrators, dc=example, dc=com" } }<a id="CO48-4"></a><i class="conum" data-value="4"></i>
   ]
},
"metadata": { "version": 1 }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO48-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the role mapping.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO48-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the role we want to assign, in this case <code class="literal">superuser</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO48-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of our active_directory realm.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO48-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The DN of the AD group whose members should get the <code class="literal">superuser</code> role in the deployment.</p>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<h4><a id="ece_using_the_role_mapping_files_2"></a>Using the Role Mapping files<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-81/docs/cloud-enterprise/ce-securing-clusters-ad.asciidoc">edit</a></h4>
<p>Let&#8217;s assume that you want all your users that authenticate through AD and are members of the <code class="literal">cn=my-users,dc=example, dc=com</code> group in AD to have read-only access to a certain index <code class="literal">my-index</code> and only the users <code class="literal">cn=Senior Manager, cn=management, dc=example, dc=com</code> and
<code class="literal">cn=Senior Admin, cn=management, dc=example, dc=com</code> to become superusers in your deployment:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create a file named <code class="literal">role-mappings.yml</code> with the following contents:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">superuser:
- cn=Senior Manager, cn=management, dc=example, dc=com
- cn=Senior Admin, cn=management, dc=example, dc=com
read-only-user:
- cn=my-users, dc=example, dc=com</pre>
</div>
</li>
<li class="listitem">
Prepare the custom bundle ZIP file <code class="literal">mappings.zip</code>, that contains the <code class="literal">role-mappings.yml</code> file <a href="/guide/en/cloud/current/ec-custom-bundles.html" class="ulink" target="_top">in the same way that you would on Elastic Cloud</a>.
</li>
<li class="listitem">
<p>Custom bundles get unzipped under the path <code class="literal">/app/config/BUNDLE_DIRECTORY_STRUCTURE</code>, where <code class="literal">BUNDLE_DIRECTORY_STRUCTURE</code> is the directory structure within the bundle ZIP file itself. For example:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ tree .
.
└── mappings
     └── role-mappings.yml</pre>
</div>
<p>In our example, the role mappings file is extracted to <code class="literal">/app/config/mappings/role-mappings.yml</code></p>
</li>
<li class="listitem">
<p>Update your plan in the <a class="xref" href="ece-advanced-configuration.html" title="Advanced cluster configuration">advanced configuration editor</a> so that it uses the bundle you prepared in the previous step. Modify the <code class="literal">user_bundles</code> JSON attribute as shown in the following example:</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You must specify the <code class="literal">user_bundles</code> attribute for each <a class="xref" href="ece-configuring-ece-templates.html" title="Configure deployment templates">deployment template</a>.</p>
</div>
</div>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{
"cluster_name": "REPLACE_WITH_YOUR_CLUSTER_NAME",
"plan": {


   ...


   "elasticsearch": {
     "version": "7.*",
     "user_bundles": [
       {
         "name": "role-mappings",
         "url": "https://www.myurl.com/mappings.zip", <a id="CO49-1"></a><i class="conum" data-value="1"></i>
         "elasticsearch_version": "7.*" <a id="CO49-2"></a><i class="conum" data-value="2"></i>
       }
     ]
   }
 }</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO49-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The URL that points to <code class="literal">mappings.zip</code> must be accessible to the cluster.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO49-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The bundle is compatible with any Elasticsearch <code class="literal">7.*</code> version.</p>
</td>
</tr>
</table>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Using a wildcard for the minor version ensures bundles are compatible with the stated Elasticsearch major version to avoid the need to re-upload a new bundle with minor versions upgrades.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Update <a class="xref" href="ece-add-user-settings.html" title="Add Elasticsearch user settings">your user settings</a> for the <code class="literal">ldap</code> realm as follows:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
 security:
   authc:
     realms:
       active_directory:
         my_ad:
           order: 2
           domain_name: ad.example.com
           url: ldaps://ad.example.com:636 <a id="CO50-1"></a><i class="conum" data-value="1"></i>
           bind_dn: es_svc_user@ad.example.com
           ssl:
             certificate_authorities: ["/app/config/cacerts/ca.crt"]
             verification_mode: certificate
           files:
             role_mapping: "/app/config/mappings/role-mappings.yml" <a id="CO50-2"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO50-1"><i class="conum" data-value="1"></i></a><a href="#CO50-2"></a></p>
</td>
<td align="left" valign="top">
<p>The path where our role mappings file is unzipped.</p>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="ece-securing-clusters-ldap.html">« Secure your 7.x clusters with LDAP</a>
</span>
<span class="next">
<a href="ece-securing-clusters-ldap-5x.html">Secure your 5.x and 6.x clusters with LDAP »</a>
</span>
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains('stemblock')) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>
