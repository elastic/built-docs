<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Configuration | Elastic Cloud on Kubernetes [2.11] | Elastic</title>
<meta class="elastic" name="content" content="Configuration | Elastic Cloud on Kubernetes [2.11]">

<link rel="home" href="index.html" title="Elastic Cloud on Kubernetes [2.11]"/>
<link rel="up" href="k8s-logstash.html" title="Run Logstash on ECK"/>
<link rel="prev" href="k8s-logstash-quickstart.html" title="Quickstart"/>
<link rel="next" href="k8s-logstash-configuration-examples.html" title="Configuration examples"/>
<meta class="elastic" name="product_version" content="2.11"/>
<meta class="elastic" name="product_name" content="ECK"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Kubernetes/Reference/2.11"/>
<meta name="DC.subject" content="ECK"/>
<meta name="DC.identifier" content="2.11"/>
</head>
<body>
<div class="page_header">
A newer version is available. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="k8s-logstash-quickstart.html">« Quickstart</a>
</span>
<span class="next">
<a href="k8s-logstash-configuration-examples.html">Configuration examples »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Cloud on Kubernetes [2.11]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="k8s-orchestrating-elastic-stack-applications.html">Orchestrating Elastic Stack applications</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="k8s-logstash.html">Run Logstash on ECK</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Configuration</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/logstash.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="k8s-logstash-configuration"></a>Configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/logstash.asciidoc">edit</a></h2>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s-logstash-upgrade-specification"></a>Upgrade the Logstash specification<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/logstash.asciidoc">edit</a></h3>
</div></div></div>
<p>You can upgrade the Logstash version or change settings by editing the YAML specification. ECK applies the changes by performing a rolling restart of Logstash Pods.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s-logstash-configuring-logstash"></a>Logstash configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/logstash.asciidoc">edit</a></h3>
</div></div></div>
<p>Define the Logstash configuration (the ECK equivalent to <code class="literal">logstash.yml</code>) in the <code class="literal">spec.config</code> section:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: logstash.k8s.elastic.co/v1alpha1
kind: Logstash
metadata:
  name: quickstart
spec:
  version: 8.15.0
  count: 1
  elasticsearchRefs:
  - name: quickstart
    clusterName: qs
  config: <a id="CO23-1"></a><i class="conum" data-value="1"></i>
    pipeline.workers: 4
    log.level: debug</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO23-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Customize Logstash configuration using <code class="literal">logstash.yml</code> settings here</p>
</td>
</tr>
</table>
</div>
<p>Alternatively, you can provide the configuration through a Secret specified in the <code class="literal">spec.configRef</code> section. The Secret must have an <code class="literal">logstash.yml</code> entry with these settings:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: logstash.k8s.elastic.co/v1alpha1
kind: Logstash
metadata:
  name: quickstart
spec:
  version: 8.15.0
  count: 1
  elasticsearchRefs:
  - name: quickstart
    clusterName: qs
  configRef:
    secretName: quickstart-config
---
apiVersion: v1
kind: Secret
metadata:
  name: quickstart-config
stringData:
  logstash.yml: |-
    pipeline.workers: 4
    log.level: debug</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s-logstash-pipelines"></a>Configuring Logstash pipelines<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/logstash.asciidoc">edit</a></h3>
</div></div></div>
<p>Define Logstash pipelines in the <code class="literal">spec.pipelines</code> section (the ECK equivalent to <code class="literal">pipelines.yml</code>):</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: logstash.k8s.elastic.co/v1alpha1
kind: Logstash
metadata:
  name: quickstart
spec:
  version: 8.15.0
  count: 1
  elasticsearchRefs:
    - clusterName: qs
      name: quickstart
  pipelines:
    - pipeline.id: main
      config.string: |
        input {
          beats {
            port =&gt; 5044
          }
        }
        output {
          elasticsearch {
            hosts =&gt; [ "${QS_ES_HOSTS}" ]
            user =&gt; "${QS_ES_USER}"
            password =&gt; "${QS_ES_PASSWORD}"
            ssl_certificate_authorities =&gt; "${QS_ES_SSL_CERTIFICATE_AUTHORITY}"
          }
        }</pre>
</div>
<p>Alternatively, you can provide the pipeline configuration through a Secret specified in the <code class="literal">spec.pipelinesRef</code> element. The Secret must have a <code class="literal">logstash.yml</code> entry with this configuration:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: logstash.k8s.elastic.co/v1alpha1
kind: Logstash
metadata:
  name: quickstart
spec:
  version: 8.15.0
  count: 1
  elasticsearchRefs:
    - clusterName: qs
      name: quickstart
  pipelinesRef:
    secretName: quickstart-pipeline
---
apiVersion: v1
kind: Secret
metadata:
  name: quickstart-pipeline
stringData:
  pipelines.yml: |-
    - pipeline.id: main
      config.string: |
        input {
          beats {
            port =&gt; 5044
          }
        }
        output {
          elasticsearch {
            hosts =&gt; [ "${QS_ES_HOSTS}" ]
            user =&gt; "${QS_ES_USER}"
            password =&gt; "${QS_ES_PASSWORD}"
            ssl_certificate_authorities =&gt; "${QS_ES_SSL_CERTIFICATE_AUTHORITY}"
          }
        }</pre>
</div>
<p>Logstash on ECK supports all options present in <code class="literal">pipelines.yml</code>, including settings to update the number of workers, and
 the size of the batch that the pipeline will process. This also includes using <code class="literal">path.config</code> to point to volumes
 mounted on the Logstash container:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: logstash.k8s.elastic.co/v1alpha1
kind: Logstash
metadata:
  name: quickstart
spec:
  version: 8.15.0
  count: 1
  elasticsearchRefs:
    - clusterName: qs
      name: quickstart
  pipelines:
    - pipeline.id: main
      config.string: |
        input {
          beats {
            port =&gt; 5044
          }
        }
        output {
          elasticsearch {
            hosts =&gt; [ "${QS_ES_HOSTS}" ]
            user =&gt; "${QS_ES_USER}"
            password =&gt; "${QS_ES_PASSWORD}"
            ssl_certificate_authorities =&gt; "${QS_ES_SSL_CERTIFICATE_AUTHORITY}"
          }
        }</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Logstash persistent queues (PQs) and dead letter queues (DLQs) are not currently managed by the Logstash operator, and using them will require you to create and manage your own Volumes and VolumeMounts</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s-logstash-volumes"></a>Defining data volumes for Logstash<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/logstash.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono">2.9.0</span>]
<span class="Admonishment-detail">
Added in 2.9.0.
</span>
</span></p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Volume support for Logstash is a breaking change to earlier versions of ECK and requires you to recreate your Logstash resources.</p>
</div>
</div>
<h3><a id="k8s-volume-claim-settings"></a>Specifying the volume claim settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/logstash.asciidoc">edit</a></h3>
<p>By default, a PersistentVolume called <code class="literal">logstash-data</code> is created, that maps to <code class="literal">/usr/share/logstash/data</code> for persistent storage, typically used for storage from plugins. The <code class="literal">logstash-data</code> volume claim is, by default, a small (1Gi) volume, using the standard StorageClass of your Kubernetes cluster, but can be overridden by adding a <code class="literal">spec.volumeClaimTemplate</code> section named <code class="literal">logstash-data</code>.</p>
<p>For production workloads, you should define your own volume claim template with the desired storage capacity and (optionally) the Kubernetes <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/" class="ulink" target="_top">storage class</a> to associate with the persistent volume. To override this volume claim for <code class="literal">data</code> usages, the name of this volume claim must be <code class="literal">logstash-data</code>.</p>
<p>This example updates the default data template to increase the storage to <code class="literal">2Gi</code> for the logstash data folder:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: logstash.k8s.elastic.co/v1alpha1
kind: Logstash
metadata:
  name: logstash
spec:
  # some configuration attributes omitted for brevity here
  volumeClaimTemplates:
    - metadata:
        name: logstash-data # Do not change this name unless you set up a volume mount for the data path.
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 2Gi</pre>
</div>
<p>Separate storage, for example for Logstash configurations using persistent queues (PQ) and/or dead letter queues (DLQ), can be added by including an additional <code class="literal">spec.volumeClaimTemplate</code> along with a corresponding <code class="literal">spec.podTemplate.spec.containers.volumeMount</code> for each requested volume.</p>
<p>This example shows how to setup separate storage for a PQ:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: logstash.k8s.elastic.co/v1alpha1
kind: Logstash
metadata:
  name: logstash
spec:
  # some configuration attributes omitted for brevity here
  volumeClaimTemplates:
    - metadata:
        name: pq <a id="CO24-1"></a><i class="conum" data-value="1"></i>
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
  podTemplate:
    spec:
      containers:
      - name: logstash
        volumeMounts:
        - mountPath: /usr/share/logstash/pq <a id="CO24-2"></a><i class="conum" data-value="2"></i>
          name: pq  <a id="CO24-3"></a><i class="conum" data-value="1"></i>
          readOnly: false
  config:
    log.level: info
    queue.type: persisted
    path.queue: /usr/share/logstash/pq <a id="CO24-4"></a><i class="conum" data-value="2"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-1"><i class="conum" data-value="1"></i></a><a href="#CO24-3"></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">name</code> values in the <code class="literal">volumeMount</code> for the container in the <code class="literal">podTemplate</code> section and the name of the <code class="literal">volumeClaimTemplate</code> must match.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-2"><i class="conum" data-value="2"></i></a><a href="#CO24-4"></a></p>
</td>
<td align="left" valign="top">
<p>Set the <code class="literal">path.queue</code> setting in the configuration to match the <code class="literal">mountPath</code> in the <code class="literal">volumeMount</code>.</p>
</td>
</tr>
</table>
</div>
<p>This example shows how to configure Logstash with a Dead Letter Queue setup on the main pipeline, and a separate pipeline to read items from the DLQ.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: logstash.k8s.elastic.co/v1alpha1
kind: Logstash
metadata:
  name: logstash
spec:
   # some configuration attributes omitted for brevity here
   podTemplate:
    spec:
      containers:
      - name: logstash
        volumeMounts:
        - mountPath: /usr/share/logstash/dlq <a id="CO25-1"></a><i class="conum" data-value="2"></i>
          name: dlq  <a id="CO25-2"></a><i class="conum" data-value="1"></i>
          readOnly: false
  volumeClaimTemplates:
    - metadata:
      name: dlq <a id="CO25-3"></a><i class="conum" data-value="1"></i>
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
  pipelines:
    - pipeline.id: beats
      dead_letter_queue.enable: true
      path.dead_letter_queue: /usr/share/logstash/dlq <a id="CO25-4"></a><i class="conum" data-value="2"></i>
      config.string: |
        input {
          beats {
            port =&gt; 5044
          }
        }
        output {
          elasticsearch {
            hosts =&gt; [ "${ECK_ES_HOSTS}" ]
            user =&gt; "${ECK_ES_USER}"
            password =&gt; "${ECK_ES_PASSWORD}"
            ssl_certificate_authorities =&gt; "${ECK_ES_SSL_CERTIFICATE_AUTHORITY}"
          }
        }
    - pipeline.id: dlq_read
      dead_letter_queue.enable: false
      config.string: |
        input {
          dead_letter_queue {
            path =&gt; "/usr/share/logstash/dlq" <a id="CO25-5"></a><i class="conum" data-value="2"></i>
            commit_offsets =&gt; true
            pipeline_id =&gt; "beats"
            clean_consumed =&gt; true
          }
        }
        filter {
          mutate {
            remove_field =&gt; "[geoip][location]"
          }
        }
        output {
          elasticsearch {
            hosts =&gt; [ "${ECK_ES_HOSTS}" ]
            user =&gt; "${ECK_ES_USER}"
            password =&gt; "${ECK_ES_PASSWORD}"
            ssl_certificate_authorities =&gt; "${ECK_ES_SSL_CERTIFICATE_AUTHORITY}"
          }
        }</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO25-2"><i class="conum" data-value="1"></i></a><a href="#CO25-3"></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">name</code> values in the <code class="literal">volumeMount</code> for the container in the <code class="literal">podTemplate</code> section and the name of the <code class="literal">volumeClaimTemplate</code> must match.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO25-1"><i class="conum" data-value="2"></i></a><a href="#CO25-4"></a><a href="#CO25-5"></a></p>
</td>
<td align="left" valign="top">
<p>Set the <code class="literal">path.dead_letter_queue</code> setting in the pipeline config to match the <code class="literal">mountPath</code> in the <code class="literal">volumeMount</code> for pipelines that are writing to the Dead Letter Queue, and set the <code class="literal">path</code> setting of the <code class="literal">dead_letter_queue</code> plugin for the pipeline that will read from the Dead Letter Queue.</p>
</td>
</tr>
</table>
</div>
<h3><a id="k8s-volume-claim-settings-updates"></a>Updating the volume claim settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/logstash.asciidoc">edit</a></h3>
<p>Changes, such as storage class or volume size, are currently forbidden in <code class="literal">spec.volumeClaimTemplates</code>.
To make these changes, you have to fully delete the Logstash resource, delete and recreate or resize the volume, and create a new Logstash resource.</p>
<p>Before deleting or resizing a persistent queue (PQ) volume, ensure that the queue is empty.
When using the PQ, we recommend setting <code class="literal">queue.drain: true</code> on the Logstash Pods to ensure that the queue is drained when Pods are shutdown.
Note that you should also increase the <code class="literal">terminationGracePeriodSeconds</code> to a large enough value to allow the queue to drain.</p>
<p>This example shows how to configure a Logstash resource to drain the queue and increase the termination grace period.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: logstash.k8s.elastic.co/v1alpha1
kind: Logstash
metadata:
  name: logstash
spec:
  # some configuration attributes omitted for brevity here
  config:
    queue.drain: true
  podTemplate:
    spec:
      terminationGracePeriodSeconds: 604800</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>A <a href="https://github.com/kubernetes/kubernetes/issues/94435" class="ulink" target="_top">Kubernetes known issue</a>: Kubernetes may not honor <code class="literal">terminationGracePeriodSeconds</code> settings greater than 600.
A queue of a terminated Pod may not be fully drained, even when <code class="literal">queue.drain: true</code> is set and a high <code class="literal">terminationGracePeriodSeconds</code> is configured.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In this technical preview, there is currently no way to drain a dead letter queue (DLQ) automatically before Logstash shuts down.
To manually drain the queue, first stop sending data to it, by either disabling the DLQ feature, or disabling any pipelines that send to a DLQ.
Then wait for events to stop flowing through any pipelines reading from the input.</p>
</div>
</div>
<h3><a id="k8s-emptydir"></a>EmptyDir<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/logstash.asciidoc">edit</a></h3>
<p>If you are not concerned about data loss, you can use an <code class="literal">emptyDir</code> volume for Logstash data.</p>
<div class="caution admon">
<div class="icon"></div>
<div class="admon_content">
<p>The use of <code class="literal">emptyDir</code> in a production environment may cause permanent data loss.
Do not use with persistent queues (PQs), dead letter queues (DLQs), or with any plugin that requires persistent storage to keep track of state between restarts of Logstash.</p>
<p>Plugins that require persistent storage include any plugin that stores state locally.
These plugins typically have a configuration parameter that includes the name <code class="literal">path</code> or <code class="literal">directory</code>, not including paths to static content, such as certificates or keystores.
Examples include the <code class="literal">sincedb_path</code> setting for the <code class="literal">file</code>, <code class="literal">dead_letter_queue</code> and <code class="literal">s3</code> inputs, the <code class="literal">last_run_metadata_path</code> for the <code class="literal">JDBC</code> input, <code class="literal">aggregate_maps_path</code> for the <code class="literal">aggregate</code> filter, and <code class="literal">temporary_directory</code> for the <code class="literal">s3</code> output, used to aggregate content before uploading to s3.</p>
</div>
</div>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">spec:
  count: 5
  podTemplate:
    spec:
      volumeClaimTemplates:
      - name: logstash-data
        emptyDir: {}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s-logstash-pipelines-es"></a>Using Elasticsearch in Logstash pipelines<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/logstash.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">spec.elasticsearchRefs</code> section provides a mechanism to help configure Logstash to establish a secured connection to one or more ECK managed Elasticsearch clusters. By default, each <code class="literal">elasticsearchRef</code> will target all nodes in its referenced Elasticsearch cluster. If you want to direct traffic to specific nodes of your Elasticsearch cluster, refer to <a class="xref" href="k8s-traffic-splitting.html" title="Traffic Splitting"><em>Traffic Splitting</em></a> for more information and examples.</p>
<p>When you use <code class="literal">elasticsearchRefs</code> in a Logstash pipeline, the Logstash operator creates the necessary resources from the associated Elasticsearch cluster, and provides environment variables to allow these resources to be accessed from the pipeline configuration.
Environment variables are replaced at runtime with the appropriate values.
The environment variables have a fixed naming convention:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">NORMALIZED_CLUSTERNAME_ES_HOSTS</code>
</li>
<li class="listitem">
<code class="literal">NORMALIZED_CLUSTERNAME_ES_USER</code>
</li>
<li class="listitem">
<code class="literal">NORMALIZED_CLUSTERNAME_ES_PASSWORD</code>
</li>
<li class="listitem">
<code class="literal">NORMALIZED_CLUSTERNAME_ES_SSL_CERTIFICATE_AUTHORITY</code>
</li>
</ul>
</div>
<p>where NORMALIZED_CLUSTERNAME is the value taken from the <code class="literal">clusterName</code> field of the <code class="literal">elasticsearchRef</code> property, capitalized, and <code class="literal">-</code> transformed to <code class="literal">_</code> - eg, prod-es, would becomed PROD_ES.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <code class="literal">clusterName</code> value should be unique across all referenced Elasticsearches in the same Logstash spec.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The Logstash ECK operator creates a user called <code class="literal">eck_logstash_user_role</code> when an <code class="literal">elasticsearchRef</code> is specified. This user has the following permissions:</p>
<pre class="screen">  "cluster": ["monitor", "manage_ilm", "read_ilm", "manage_logstash_pipelines", "manage_index_templates", "cluster:admin/ingest/pipeline/get",],
  "indices": [
    {
      "names": [ "logstash", "logstash-*", "ecs-logstash", "ecs-logstash-*", "logs-*", "metrics-*", "synthetics-*", "traces-*" ],
      "privileges": ["manage", "write", "create_index", "read", "view_index_metadata"]
    }</pre>
<p>You can <a class="xref" href="k8s-users-and-roles.html" title="Users and roles">update user permissions</a> to include more indices if the Elasticsearch plugin is expected to use indices other than the default. Check out <a class="xref" href="k8s-logstash-configuration-examples.html#k8s-logstash-configuration-custom-index" title="Writing to a custom Elasticsearch index">Logstash configuration with a custom index</a> sample configuration that creates a user that writes to a custom index.</p>
</div>
</div>
<p>This example demonstrates how to create a Logstash deployment that connects to
different Elasticsearch instances, one of which is in a separate namespace:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: logstash.k8s.elastic.co/v1alpha1
kind: Logstash
metadata:
  name: quickstart
spec:
  version: 8.15.0
  count: 1
  elasticsearchRefs:        <a id="CO26-1"></a><i class="conum" data-value="1"></i>
    - clusterName: prod-es  <a id="CO26-2"></a><i class="conum" data-value="2"></i>
      name: prod
    - clusterName: qa-es    <a id="CO26-3"></a><i class="conum" data-value="3"></i>
      name: qa
      namespace: qa
  pipelines:
    - pipeline.id: main
      config.string: |
        input {
          beats {
            port =&gt; 5044
          }
        }
        output {
          elasticsearch {   <a id="CO26-4"></a><i class="conum" data-value="4"></i>
            hosts =&gt; [ "${PROD_ES_ES_HOSTS}" ]
            user =&gt; "${PROD_ES_ES_USER}"
            password =&gt; "${PROD_ES_ES_PASSWORD}"
            ssl_certificate_authorities =&gt; "${PROD_ES_ES_SSL_CERTIFICATE_AUTHORITY}"
          }
          elasticsearch {   <a id="CO26-5"></a><i class="conum" data-value="4"></i>
            hosts =&gt; [ "${QA_ES_ES_HOSTS}" ]
            user =&gt; "${QA_ES_ES_USER}"
            password =&gt; "${QA_ES_ES_PASSWORD}"
            ssl_certificate_authorities =&gt; "${QA_ES_ES_SSL_CERTIFICATE_AUTHORITY}"
          }
        }</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO26-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Define Elasticsearch references in the CRD. This will create the appropriate Secrets to store certificate details and the rest of the connection information, and create environment variables to allow them to be referred to in Logstash pipeline configurations.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO26-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>This refers to an Elasticsearch cluster residing in the same namespace as the Logstash instances.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO26-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>This refers to an Elasticsearch cluster residing in a different namespace to the Logstash instances.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO26-4"><i class="conum" data-value="4"></i></a><a href="#CO26-5"></a></p>
</td>
<td align="left" valign="top">
<p>Elasticsearch output definitions - use the environment variables created by the Logstash operator when specifying an <code class="literal">ElasticsearchRef</code>. Note the use of "normalized" versions of the <code class="literal">clusterName</code> in the environment variables used to populate the relevant fields.</p>
</td>
</tr>
</table>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="k8s-logstash-external-es"></a>Connect to an external Elasticsearch cluster<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/logstash.asciidoc">edit</a></h4>
</div></div></div>
<p>Logstash can connect to external Elasticsearch cluster that is not managed by ECK.
You can reference a Secret instead of an Elasticsearch cluster in the <code class="literal">elasticsearchRefs</code> section through the <code class="literal">secretName</code> attribute:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: v1
kind: Secret
metadata:
  name: external-es-ref
stringData:
  url: https://abcd-42.xyz.elastic-cloud.com:443 <a id="CO27-1"></a><i class="conum" data-value="1"></i>
  username: logstash_user <a id="CO27-2"></a><i class="conum" data-value="2"></i>
  password: REDACTED <a id="CO27-3"></a><i class="conum" data-value="3"></i>
  ca.crt: REDACTED <a id="CO27-4"></a><i class="conum" data-value="4"></i>
---
apiVersion: logstash.k8s.elastic.co/v1alpha1
kind: Logstash
metadata:
  name: quickstart
spec:
  version: 8.15.0
  count: 1
  elasticsearchRefs:
    - clusterName: prod-es
      secretName: external-es-ref <a id="CO27-5"></a><i class="conum" data-value="5"></i>
  monitoring:
    metrics:
      elasticsearchRefs:
      - secretName: external-es-ref <a id="CO27-6"></a><i class="conum" data-value="5"></i>
    logs:
      elasticsearchRefs:
      - secretName: external-es-ref <a id="CO27-7"></a><i class="conum" data-value="5"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO27-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The URL to reach the Elasticsearch cluster.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO27-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The username of the user to be authenticated to the Elasticsearch cluster.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO27-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The password of the user to be authenticated to the Elasticsearch cluster.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO27-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The CA certificate in PEM format to secure communication to the Elasticsearch cluster (optional).</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO27-5"><i class="conum" data-value="5"></i></a><a href="#CO27-6"></a><a href="#CO27-7"></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">secretName</code> and <code class="literal">name</code> attributes are mutually exclusive, you have to choose one or the other.</p>
</td>
</tr>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Please always specify the port in URL when connecting to an external Elasticsearch Cluster.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s-logstash-expose-services"></a>Expose services<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/logstash.asciidoc">edit</a></h3>
</div></div></div>
<p>By default, the Logstash operator creates a headless Service for the metrics endpoint to enable metric collection by the Metricbeat sidecar for Stack Monitoring:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">kubectl get service quickstart-ls-api</pre>
</div>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">NAME                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE
quickstart-ls-api   ClusterIP   None         &lt;none&gt;        9600/TCP   48s</pre>
</div>
<p>Additional services can be added in the <code class="literal">spec.services</code> section of the resource:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">services:
  - name: beats
    service:
      spec:
        ports:
        - port: 5044
          name: "winlogbeat"
          protocol: TCP
        - port: 5045
          name: "filebeat"
          protocol: TCP</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s-logstash-pod-configuration"></a>Pod configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/logstash.asciidoc">edit</a></h3>
</div></div></div>
<p>You can <a class="xref" href="k8s-customize-pods.html" title="Customize Pods">customize the Logstash Pod</a> using a Pod template, defined in the <code class="literal">spec.podTemplate</code> section of the configuration.</p>
<p>This example demonstrates how to create a Logstash deployment with increased heap size and resource limits.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: logstash.k8s.elastic.co/v1alpha1
kind: Logstash
metadata:
  name: logstash-sample
spec:
  version: 8.15.0
  count: 1
  elasticsearchRefs:
    - name: "elasticsearch-sample"
      clusterName: "sample"
  podTemplate:
    spec:
      containers:
      - name: logtash
        env:
        - name: LS_JAVA_OPTS
          value: "-Xmx2g -Xms2g"
        resources:
          requests:
            memory: 1Gi
            cpu: 0.5
          limits:
            memory: 4Gi
            cpu: 2</pre>
</div>
<p>The name of the container in the Pod template must be <code class="literal">logstash</code>.</p>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="k8s-logstash-quickstart.html">« Quickstart</a>
</span>
<span class="next">
<a href="k8s-logstash-configuration-examples.html">Configuration examples »</a>
</span>
</div>
</body>
</html>
