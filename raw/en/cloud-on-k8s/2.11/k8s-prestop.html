<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pod PreStop hook | Elastic Cloud on Kubernetes [2.11] | Elastic</title>
<meta class="elastic" name="content" content="Pod PreStop hook | Elastic Cloud on Kubernetes [2.11]">

<link rel="home" href="index.html" title="Elastic Cloud on Kubernetes [2.11]"/>
<link rel="up" href="k8s-elasticsearch-specification.html" title="Run Elasticsearch on ECK"/>
<link rel="prev" href="k8s-readiness.html" title="Readiness probe"/>
<link rel="next" href="k8s-autoscaling.html" title="Elasticsearch autoscaling"/>
<meta class="elastic" name="product_version" content="2.11"/>
<meta class="elastic" name="product_name" content="ECK"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Kubernetes/Reference/2.11"/>
<meta name="DC.subject" content="ECK"/>
<meta name="DC.identifier" content="2.11"/>
</head>
<body>
<div class="page_header">
A newer version is available. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="k8s-readiness.html">« Readiness probe</a>
</span>
<span class="next">
<a href="k8s-autoscaling.html">Elasticsearch autoscaling »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Cloud on Kubernetes [2.11]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="k8s-orchestrating-elastic-stack-applications.html">Orchestrating Elastic Stack applications</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="k8s-elasticsearch-specification.html">Run Elasticsearch on ECK</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Pod PreStop hook</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/elasticsearch/prestop.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="k8s-prestop"></a>Pod PreStop hook<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.11/docs/orchestrating-elastic-stack-applications/elasticsearch/prestop.asciidoc">edit</a></h2>
</div></div></div>
<p>When an Elasticsearch <code class="literal">Pod</code> is terminated, its <code class="literal">Endpoint</code> is removed from the <code class="literal">Service</code> and the Elasticsearch process is terminated. As these two operations happen in parallel, a race condition exists. If the Elasticsearch process is already shut down, but the <code class="literal">Endpoint</code> is still a part of the <code class="literal">Service</code>, any new connection might fail. For more information, check <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods" class="ulink" target="_top">Termination of pods</a>.</p>
<p>Moreover, kube-proxy resynchronizes its rules <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-proxy/#options" class="ulink" target="_top">every 30 seconds by default</a>. During that time window of 30 seconds, the terminating Pod IP may still be used when targeting the service. Please note the resync operation itself may take some time, especially if kube-proxy is configured to use iptables with a lot of services and rules to apply.</p>
<p>To address this issue and minimize unavailability, ECK relies on a <a href="https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/" class="ulink" target="_top">PreStop lifecycle hook</a>.
It waits for an additional <code class="literal">PRE_STOP_ADDITIONAL_WAIT_SECONDS</code> (defaulting to 50). The additional wait time is used to:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Give time to in-flight requests to be completed.
</li>
<li class="listitem">
Give clients time to use the terminating Pod IP resolved just before DNS record was updated.
</li>
<li class="listitem">
Give kube-proxy time to refresh ipvs or iptables rules on all nodes, depending on its sync period setting.
</li>
</ol>
</div>
<p>The exact behavior is configurable using an environment variable, for example:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">spec:
  version: 8.15.0
  nodeSets:
    - name: default
      count: 1
      podTemplate:
        spec:
          containers:
          - name: elasticsearch
            env:
            - name: PRE_STOP_ADDITIONAL_WAIT_SECONDS
              value: "5"</pre>
</div>
<p>The pre-stop lifecycle hook also tries to gracefully shut down the Elasticsearch node in case of a termination that is not caused by the ECK operator. Examples of such terminations could be Kubernetes node maintenance or a Kubernetes upgrade. In these cases the script will try to interact with the Elasticsearch API to notify Elasticsearch of the impending termination of the node. The intent is to avoid relocation and recovery of shards while the Elasticsearch node is only temporarily unavailable.</p>
<p>This is done on a best effort basis. In particular requests to an Elasticsearch cluster already in the process of shutting down might fail if the Kubernetes service has already been removed.
The script allows for <code class="literal">PRE_STOP_MAX_DNS_ERRORS</code> which default to 2 before giving up.</p>
<p>When using local persistent volumes a different behaviour might be desirable because the Elasticsearch node&#8217;s associated storage will not be available anymore on the new Kubernetes node. <code class="literal">PRE_STOP_SHUTDOWN_TYPE</code> allows to override the default shutdown type to one of the <a href="/guide/en/elasticsearch/reference/current/put-shutdown.html" class="ulink" target="_top">possible values</a>. Please be aware that setting it to anything other than <code class="literal">restart</code> might mean that the pre-stop hook will run longer than <code class="literal">terminationGracePeriodSeconds</code> of the Pod while moving data out of the terminating Pod and will not be able to complete unless you also adjust that value in the <code class="literal">podTemplate</code>.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="k8s-readiness.html">« Readiness probe</a>
</span>
<span class="next">
<a href="k8s-autoscaling.html">Elasticsearch autoscaling »</a>
</span>
</div>
</body>
</html>
