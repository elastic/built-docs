<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Transport settings | Elastic Cloud on Kubernetes [2.9] | Elastic</title>
<meta class="elastic" name="content" content="Transport settings | Elastic Cloud on Kubernetes [2.9]">

<link rel="home" href="index.html" title="Elastic Cloud on Kubernetes [2.9]"/>
<link rel="up" href="k8s-elasticsearch-specification.html" title="Run Elasticsearch on ECK"/>
<link rel="prev" href="k8s-storage-recommendations.html" title="Storage recommendations"/>
<link rel="next" href="k8s-virtual-memory.html" title="Virtual memory"/>
<meta class="elastic" name="product_version" content="2.9"/>
<meta class="elastic" name="product_name" content="ECK"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Kubernetes/Reference/2.9"/>
<meta name="DC.subject" content="ECK"/>
<meta name="DC.identifier" content="2.9"/>
</head>
<body>
<div class="page_header">
A newer version is available. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="k8s-storage-recommendations.html">« Storage recommendations</a>
</span>
<span class="next">
<a href="k8s-virtual-memory.html">Virtual memory »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Cloud on Kubernetes [2.9]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="k8s-orchestrating-elastic-stack-applications.html">Orchestrating Elastic Stack applications</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="k8s-elasticsearch-specification.html">Run Elasticsearch on ECK</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Transport settings</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.9/docs/orchestrating-elastic-stack-applications/elasticsearch/transport-settings.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="k8s-transport-settings"></a>Transport settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.9/docs/orchestrating-elastic-stack-applications/elasticsearch/transport-settings.asciidoc">edit</a></h2>
</div></div></div>
<p>The transport module in Elasticsearch is used for internal communication between nodes within the cluster as well as communication between remote clusters. Check the <a href="/guide/en/elasticsearch/reference/current/modules-transport.html" class="ulink" target="_top">Elasticsearch documentation</a> for details. For customization options of the HTTP layer, check <a class="xref" href="k8s-services.html" title="Services">Services</a> and <a class="xref" href="k8s-tls-certificates.html" title="TLS certificates">TLS certificates</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s_customize_the_transport_service"></a>Customize the Transport Service<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.9/docs/orchestrating-elastic-stack-applications/elasticsearch/transport-settings.asciidoc">edit</a></h3>
</div></div></div>
<p>In the <code class="literal">spec.transport.service.</code> section, you can change the Kubernetes service used to expose the Elasticsearch transport module:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">spec:
  transport:
    service:
      metadata:
        labels:
          my-custom: label
      spec:
        type: LoadBalancer</pre>
</div>
<p>Check the <a href="https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types" class="ulink" target="_top">Kubernetes Publishing Services (ServiceTypes)</a> that are currently available.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When you change the <code class="literal">clusterIP</code> setting of the service, ECK deletes and re-creates the service, as <code class="literal">clusterIP</code> is an immutable field. This will cause a short network disruption, but in most cases it should not affect existing connections as the transport module uses long-lived TCP connections.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s-transport-ca"></a>Configure a custom Certificate Authority<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.9/docs/orchestrating-elastic-stack-applications/elasticsearch/transport-settings.asciidoc">edit</a></h3>
</div></div></div>
<p>Elasticsearch uses X.509 certificates to establish encrypted and authenticated connections across nodes in the cluster. By default, ECK creates a self-signed CA certificate to issue a certificate <a href="/guide/en/elasticsearch/reference/current/configuring-tls.html#node-certificates" class="ulink" target="_top">for each node in the cluster</a>.</p>
<p>You can use a Kubernetes secret to provide your own CA instead of the self-signed certificate that ECK will then use to create node certificates for transport connections.
The CA certificate must be stored in the secret under <code class="literal">ca.crt</code> and the private key must be stored under <code class="literal">ca.key</code>.</p>
<p>You need to reference the name of a secret that contains the TLS private key and the CA certificate, in the <code class="literal">spec.transport.tls.certificate</code> section, as shown in this example:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">spec:
  transport:
    tls:
      certificate:
        secretName: custom-ca</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s_customize_the_node_transport_certificates"></a>Customize the node transport certificates<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.9/docs/orchestrating-elastic-stack-applications/elasticsearch/transport-settings.asciidoc">edit</a></h3>
</div></div></div>
<p>The operator generates a self-signed TLS certificates for each node in the cluster. You can add extra IP addresses or DNS names to the generated certificates as follows:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: quickstart
spec:
  version: 8.15.0
  transport:
    tls:
      subjectAltNames:
      - ip: 1.2.3.4
      - dns: hulk.example.com
  nodeSets:
  - name: default
    count: 3</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="k8s-transport-third-party-tools"></a>Issue node transport certificates with third-party tools<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.9/docs/orchestrating-elastic-stack-applications/elasticsearch/transport-settings.asciidoc">edit</a></h3>
</div></div></div>
<p>When following the instructions in <a class="xref" href="k8s-transport-settings.html#k8s-transport-ca" title="Configure a custom Certificate Authority">Configure a custom Certificate Authority</a> the issuance of certificates is orchestrated by the ECK operator and the operator needs access to the CAs private key.
If this is undesirable it is also possible to configure node transport certificates without involving the ECK operator. The following two pre-requisites apply:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
The tooling used must be able to issue individual certificates for each Elasticsearch node and dynamically add or remove certificates as the cluster scales up and down.
</li>
<li class="listitem">
The ECK operator must be configured to be aware of the CA in use for the <a class="xref" href="k8s-remote-clusters.html#k8s-remote-clusters-connect-external" title="Connect from an Elasticsearch cluster running outside the Kubernetes cluster">remote cluster</a> support to work.
</li>
</ol>
</div>
<p>The following example configuration using <a href="https://cert-manager.io/docs/projects/csi-driver/" class="ulink" target="_top">cert-manager csi-driver</a> and <a href="https://cert-manager.io/docs/projects/trust-manager/" class="ulink" target="_top">trust-manager</a> meets these two requirements:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: es
spec:
  version: 8.15.0
  transport:
    tls:
      certificateAuthorities:
        configMapName: trust
  nodeSets:
  - name: default
    count: 3
    config:
      xpack.security.transport.ssl.key: /usr/share/elasticsearch/config/cert-manager-certs/tls.key
      xpack.security.transport.ssl.certificate: /usr/share/elasticsearch/config/cert-manager-certs/tls.crt
    podTemplate:
      spec:
        containers:
        - name: elasticsearch
          volumeMounts:
          - name: transport-certs
            mountPath: /usr/share/elasticsearch/config/cert-manager-certs
        volumes:
        - name: transport-certs
          csi:
            driver: csi.cert-manager.io
            readOnly: true
            volumeAttributes:
              csi.cert-manager.io/issuer-name: ca-cluster-issuer
              csi.cert-manager.io/issuer-kind: ClusterIssuer
              csi.cert-manager.io/dns-names: "${POD_NAME}.${POD_NAMESPACE}.svc.cluster.local"</pre>
</div>
<p>The example assumes that a <code class="literal">ClusterIssuer</code> by the name of <code class="literal">ca-cluster-issuer</code> exists and a PEM encoded version of the CA certificate is available in a ConfigMap (in the example named <code class="literal">trust</code>).  The CA certificate must be in a file called  <code class="literal">ca.crt</code> inside the ConfigMap in the same namespace as the Elasticsearch resource.</p>
<p>The following manifest is only provided to illustrate how these certificates can be configured in principle, using the trust-manager Bundle resource and cert-manager provisioned certificates:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: trust.cert-manager.io/v1alpha1
kind: Bundle
metadata:
  name: trust
spec:
  sources:
  - secret:
      name: "root-ca-secret"
      key: "tls.crt"
  target:
    configMap:
      key: "ca.crt"
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: selfsigned-ca
  namespace: cert-manager
spec:
  isCA: true
  commonName: selfsigned-ca
  secretName: root-ca-secret
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: selfsigned-issuer
    kind: ClusterIssuer
    group: cert-manager.io
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: ca-cluster-issuer
spec:
  ca:
    secretName: root-ca-secret
...</pre>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="k8s-storage-recommendations.html">« Storage recommendations</a>
</span>
<span class="next">
<a href="k8s-virtual-memory.html">Virtual memory »</a>
</span>
</div>
</body>
</html>
