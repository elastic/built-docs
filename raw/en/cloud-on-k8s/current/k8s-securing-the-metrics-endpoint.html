<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Securing the metrics endpoint | Elastic Cloud on Kubernetes [2.16] | Elastic</title>
<meta class="elastic" name="content" content="Securing the metrics endpoint | Elastic Cloud on Kubernetes [2.16]">

<link rel="home" href="index.html" title="Elastic Cloud on Kubernetes [2.16]"/>
<link rel="up" href="k8s-configure-operator-metrics.html" title="Configure the metrics endpoint"/>
<link rel="prev" href="k8s-enabling-the-metrics-endpoint.html" title="Enabling the metrics endpoint"/>
<link rel="next" href="k8s-prometheus-requirements.html" title="Prometheus requirements"/>
<meta class="elastic" name="product_version" content="2.16"/>
<meta class="elastic" name="product_name" content="ECK"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Kubernetes/Reference/2.16"/>
<meta name="DC.subject" content="ECK"/>
<meta name="DC.identifier" content="2.16"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="k8s-enabling-the-metrics-endpoint.html">« Enabling the metrics endpoint</a>
</span>
<span class="next">
<a href="k8s-prometheus-requirements.html">Prometheus requirements »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Cloud on Kubernetes [2.16]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="k8s-operating-eck.html">Operating ECK</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="k8s-configure-operator-metrics.html">Configure the metrics endpoint</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Securing the metrics endpoint</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.16/docs/operating-eck/configure-operator-metrics.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="k8s-securing-the-metrics-endpoint"></a>Securing the metrics endpoint</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.16/docs/operating-eck/configure-operator-metrics.asciidoc">edit</a></div>
</div></div></div>
<p>The ECK operator provides a metrics endpoint that can be used to monitor the operator&#8217;s performance and health. By default, the metrics endpoint is not enabled and is not secured. To enable the metrics endpoint follow the previous instructions. To enable RBAC and TLS on the metrics endpoint, follow the instructions in the following sections depending on whether you installed ECK through the Helm chart or the manifests.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="k8s_using_the_operator_helm_chart_2"></a>Using the operator Helm chart</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.16/docs/operating-eck/configure-operator-metrics.asciidoc">edit</a></div>
</div></div></div>
<p>If you installed ECK through the Helm chart commands listed in <a class="xref" href="k8s-install-helm.html" title="Install ECK using the Helm chart">Install ECK using the Helm chart</a>, you can now set <code class="literal">config.metrics.secureMode.enabled</code> to <code class="literal">true</code> and both RBAC and TLS/HTTPs will be enabled for the metrics endpoint.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="k8s_using_your_own_tls_certificate_for_the_metrics_endpoint_when_using_the_helm_chart"></a>Using your own TLS certificate for the metrics endpoint when using the Helm chart</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.16/docs/operating-eck/configure-operator-metrics.asciidoc">edit</a></div>
</div></div></div>
<p>By default a self-signed certificate will be generated for use by the metrics endpoint. If you want to use your own TLS certificate for the metrics endpoint you can provide the <code class="literal">config.metrics.secureMode.tls.certificateSecret</code> to the Helm chart. The <code class="literal">certificateSecret</code> should be the name of an existing Kubernetes <code class="literal">Secret</code> that contains both the TLS certificate and the TLS private key. The following keys are supported within the secret:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">tls.crt</code> - The PEM-encoded TLS certificate
</li>
<li class="listitem">
<code class="literal">tls.key</code> - The PEM-encoded TLS private key
</li>
</ul>
</div>
<p>The easiest way to create this secret is to use the <code class="literal">kubectl create secret tls</code> command. For example:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">kubectl create secret tls eck-metrics-tls-certificate -n elastic-system --cert=/path/to/tls.crt --key=/path/to/tls.key</pre>
</div>
<p>Providing this secret is sufficient to use your own certificate if it is from a trusted Certificate Authority. If the certificate is not signed by a trusted CA and you are using Prometheus to scrape the metrics you have 2 options:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Disable TLS verification.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Set <code class="literal">serviceMonitor.insecureSkipVerify</code> to <code class="literal">true</code> to disable TLS validation in the ServiceMonitor generated by the eck-operator Helm chart.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Provide the Certificate Authority to Prometheus.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Set <code class="literal">serviceMonitor.insecureSkipVerify</code> to <code class="literal">false</code> to enable TLS validation.
</li>
<li class="listitem">
Set <code class="literal">serviceMonitor.caSecret</code> to the name of an existing Kubernetes secret within the Prometheus namespace that contains the CA in PEM format in a file called <code class="literal">ca.crt</code>.
</li>
<li class="listitem">
Set the <code class="literal">spec.secrets</code> field of the <code class="literal">Prometheus</code> custom resource, or <code class="literal">prometheus.prometheusSpec.secrets</code> when using the Helm chart such that the CA secret is mounted into the Prometheus pod at <code class="literal">serviceMonitor.caMountDirectory</code> (assuming you are using the Prometheus operator). See the <a href="https://github.com/elastic/cloud-on-k8s/tree/2.16/deploy/eck-operator/values.yaml" class="ulink" target="_top">ECK Helm chart values file</a> for more information.
</li>
</ul>
</div>
</li>
</ul>
</div>
<p>See the <a class="xref" href="k8s-prometheus-requirements.html" title="Prometheus requirements">Prometheus requirements section</a> for more information on creating the CA secret.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="k8s_using_the_operator_manifests_2"></a>Using the operator manifests</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.16/docs/operating-eck/configure-operator-metrics.asciidoc">edit</a></div>
</div></div></div>
<p>If you installed ECK through using the manifests using the commands listed in <a class="xref" href="k8s-deploy-eck.html" title="Deploy ECK in your Kubernetes cluster"><em>Deploy ECK in your Kubernetes cluster</em></a> some additional changes will be required to enable secure metrics.</p>
<p>Enable the metrics port in the <code class="literal">ConfigMap</code> and set the <code class="literal">metrics-secure</code> setting to <code class="literal">true</code>.</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">cat &lt;&lt;EOF | kubectl apply -f -
kind: ConfigMap
apiVersion: v1
metadata:
  name: elastic-operator
  namespace: elastic-system
data:
  eck.yaml: |-
    log-verbosity: 0
    metrics-port: 8081
    metrics-host: 0.0.0.0
    metrics-secure: true
    container-registry: docker.elastic.co
    max-concurrent-reconciles: 3
    ca-cert-validity: 8760h
    ca-cert-rotate-before: 24h
    cert-validity: 8760h
    cert-rotate-before: 24h
    disable-config-watch: false
    exposed-node-labels: [topology.kubernetes.io/.*,failure-domain.beta.kubernetes.io/.*]
    set-default-security-context: auto-detect
    kube-client-timeout: 60s
    elasticsearch-client-timeout: 180s
    disable-telemetry: false
    distribution-channel: all-in-one
    validate-storage-class: true
    enable-webhook: true
    webhook-name: elastic-webhook.k8s.elastic.co
    webhook-port: 9443
    operator-namespace: elastic-system
    enable-leader-election: true
    elasticsearch-observation-interval: 10s
    ubi-only: false
EOF</pre>
</div>
<p>Add an additional <code class="literal">ClusterRole</code> and <code class="literal">ClusterRoleBinding</code> for the ECK operator.</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: elastic-operator-metrics-auth-role
rules:
- apiGroups:
  - authentication.k8s.io
  resources:
  - tokenreviews
  verbs:
  - create
- apiGroups:
  - authorization.k8s.io
  resources:
  - subjectaccessreviews
  verbs:
  - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: elastic-operator-metrics-auth-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: elastic-operator-metrics-auth-role
subjects:
- kind: ServiceAccount
  name: elastic-operator
  namespace: elastic-system
EOF</pre>
</div>
<p>Add a <code class="literal">Service</code> to expose the metrics endpoint.</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  labels:
    control-plane: elastic-operator
    app.kubernetes.io/component: metrics
  name: elastic-operator-metrics
  namespace: elastic-system
spec:
  ports:
  - name: https
    port: 8080
    protocol: TCP
    targetPort: metrics
  selector:
    control-plane: elastic-operator
EOF</pre>
</div>
<p>If using the Prometheus operator, add a <code class="literal">ServiceMonitor</code> to allow scraping of the metrics endpoint by Prometheus.</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: elastic-operator
  namespace: elastic-system
spec:
  namespaceSelector:
    matchNames:
      - elastic-system
  selector:
    matchLabels:
      control-plane: elastic-operator
      app.kubernetes.io/component: metrics
  endpoints:
  - port: https
    path: /metrics
    scheme: https
    interval: 30s
    tlsConfig:
      insecureSkipVerify: true
    bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
EOF</pre>
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="k8s_using_your_own_tls_certificate_for_the_metrics_endpoint_when_using_the_manifests"></a>Using your own TLS certificate for the metrics endpoint when using the manifests</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/cloud-on-k8s/edit/2.16/docs/operating-eck/configure-operator-metrics.asciidoc">edit</a></div>
</div></div></div>
<p>By default a self-signed certificate will be generated for use by the metrics endpoint. If you want to use your own TLS certificate for the metrics endpoint you will need to follow the previous instructions to enable secure metrics as well as the following steps:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Create a <code class="literal">Secret</code> containing the TLS certificate and TLS private key. The following keys are supported within the secret:
</li>
<li class="listitem">
<code class="literal">tls.crt</code> - The PEM-encoded TLS certificate
</li>
<li class="listitem">
<code class="literal">tls.key</code> - The PEM-encoded TLS private key
</li>
</ul>
</div>
<p>The easiest way to create this secret is to use the <code class="literal">kubectl create secret tls</code> command. For example:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">kubectl create secret tls my-tls-secret -n elastic-system --cert=/path/to/tls.crt --key=/path/to/tls.key</pre>
</div>
<p>Patch the <code class="literal">StatefulSet</code> to include the <code class="literal">tls.crt</code> and <code class="literal">tls.key</code> as a volume and mount it into the <code class="literal">manager</code> container.</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">kubectl patch sts -n elastic-system elastic-operator --patch-file=/dev/stdin &lt;&lt;-EOF
spec:
  template:
    spec:
      containers:
        - name: manager
          volumeMounts:
          - mountPath: "/tmp/k8s-metrics-server/serving-certs" <a id="CO1-1"></a><i class="conum" data-value="1"></i>
            name: tls-certificate
            readOnly: true
      volumes:
      - name: conf
        configMap:
          name: elastic-operator
      - name: cert
        secret:
          defaultMode: 420
          secretName: elastic-webhook-server-cert
      - name: tls-certificate
        secret:
          defaultMode: 420
          secretName: eck-metrics-tls-certificate
EOF</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO1-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>If mounting the TLS secret to a different directory the <code class="literal">metrics-cert-dir</code> setting in the operator configuration has to be adjusted accordingly.</p>
</td>
</tr>
</table>
</div>
<p>Potentially patch the <code class="literal">ServiceMonitor</code>. This will only need to be done if you are adjusting the <code class="literal">insecureSkipVerify</code> field to <code class="literal">false</code>.</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">kubectl patch servicemonitor -n elastic-system elastic-operator --patch-file=/dev/stdin &lt;&lt;-EOF
spec:
  endpoints:
  - port: https
    path: /metrics
    scheme: https
    interval: 30s
    tlsConfig:
      insecureSkipVerify: false
      caFile: /etc/prometheus/secrets/{secret-name}/ca.crt <a id="CO2-1"></a><i class="conum" data-value="1"></i>
      serverName: elastic-operator-metrics.elastic-system.svc
    bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
EOF</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO2-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>See the <a class="xref" href="k8s-prometheus-requirements.html" title="Prometheus requirements">Prometheus requirements section</a> for more information on creating the CA secret.</p>
</td>
</tr>
</table>
</div>
</div>

</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="k8s-enabling-the-metrics-endpoint.html">« Enabling the metrics endpoint</a>
</span>
<span class="next">
<a href="k8s-prometheus-requirements.html">Prometheus requirements »</a>
</span>
</div>
</body>
</html>
