<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Encrypt your deployment with a customer-managed encryption key | Elasticsearch Service Documentation | Elastic</title>
<meta class="elastic" name="content" content="Encrypt your deployment with a customer-managed encryption key | Elasticsearch Service Documentation">

<link rel="home" href="index.html" title="Elasticsearch Service Documentation"/>
<link rel="up" href="ec-security.html" title="Securing your deployment"/>
<link rel="prev" href="ec-static-ips.html" title="Elastic Cloud Static IPs"/>
<link rel="next" href="ec-monitoring.html" title="Keeping your deployment healthy"/>
<meta class="elastic" name="product_version" content="latest"/>
<meta class="elastic" name="product_name" content="Elastic Cloud"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Cloud/Reference"/>
<meta name="DC.subject" content="Elastic Cloud"/>
<meta name="DC.identifier" content="latest"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Service Documentation</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="ec-security.html">Securing your deployment</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="ec-static-ips.html">« Elastic Cloud Static IPs</a>
</span>
<span class="next">
<a href="ec-monitoring.html">Keeping your deployment healthy »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="ec-encrypt-with-cmek"></a>Encrypt your deployment with a customer-managed encryption key<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-106/docs/saas/ec-encrypt-with-cmek.asciidoc">edit</a></h2>
</div></div></div>
<p>By default, Elastic already encrypts your deployment data and snapshots at rest. You can reinforce this mechanism by providing your own encryption key. To do that, you need a customer-managed key that you set up and manage in your cloud provider&#8217;s Key Management Service (KMS).</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Encryption at rest using customer-managed keys is only available for the Enterprise subscription level, when creating new deployments on AWS regions using Elastic Cloud APIs. Other cloud providers and the ability to edit encryption settings for existing deployments will be supported at a later date.</p>
</div>
</div>
<p>Using a customer-managed key allows you to strengthen the security of your deployment data and snapshot data at rest. Note that if you use a custom snapshot repository different from the one provided by Elastic Cloud, these snapshots are not encrypted with your customer-managed key.</p>
<h3><a id="ec_how_does_using_a_customer_managed_key_help_improve_the_safety_of_your_data"></a>How does using a customer-managed key help improve the safety of your data?<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-106/docs/saas/ec-encrypt-with-cmek.asciidoc">edit</a></h3>
<p>Using a customer-managed key helps protect against threats related to the management and control of encryption keys. It does not directly protect against any specific types of attacks or threats. However, the ability to keep control over your own keys can help mitigate certain types of threats such as:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Insider threats.</strong></span> By using a customer-managed key, Elastic does not have access to your encryption keys [1]. This can help prevent unauthorized access to data by insiders with malicious intent.
</li>
<li class="listitem">
<span class="strong strong"><strong>Compromised physical infrastructure.</strong></span> If a data center is physically compromised, the hosts are shut off. With customer-managed key encryption, that&#8217;s a second layer of protection that any malicious intruder would have to bypass, in addition to the existing built-in hardware encryption.
</li>
</ul>
</div>
<p>Using a customer-managed key can help comply with regulations or security requirements, but it is not a complete security solution by itself. There are other types of threats that it does not protect against.</p>
<p>[1] You set up your customer-managed keys and their access in your key management service. When you provide a customer-managed key identifier to Elastic Cloud, we do not access or store the cryptographic material associated with that key. Customer-managed keys are not directly used to encrypt deployment or snapshot data. Elastic Cloud accesses your customer-managed keys to encrypt and decrypt data encryption keys, which, in turn, are used to encrypt the data.</p>
<p>When a deployment encrypted with a customer-managed key is deleted or terminated, its data is locked first before being deleted, ensuring a fully secure deletion process.</p>
<h3><a id="ec_prerequisites_3"></a>Prerequisites<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-106/docs/saas/ec-encrypt-with-cmek.asciidoc">edit</a></h3>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="/guide/en/cloud/current/ec-api-authentication.html" class="ulink" target="_top">Have a valid Elastic Cloud API key</a> with the <span class="strong strong"><strong>Organization owner</strong></span> role or the <span class="strong strong"><strong>Admin</strong></span> role on deployments. These roles allow you to create new deployments.
</li>
<li class="listitem">
Have permissions on AWS KMS to <a href="https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#symmetric-cmks" class="ulink" target="_top">create a symmetric AWS KMS key</a> and to configure AWS IAM roles.
</li>
<li class="listitem">
Consider the cloud regions where you need your deployment to live. Refer to the <a class="xref" href="ec-regions-templates-instances.html" title="Available regions, deployment templates and instance configurations">list of available regions, deployment templates, and instance configurations</a> supported by Elastic Cloud.
</li>
</ul>
</div>
<h3><a id="ec_know_before_you_go"></a>Know before you go<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-106/docs/saas/ec-encrypt-with-cmek.asciidoc">edit</a></h3>
<p>At this time, the following features are not supported:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Encrypting existing deployments with a customer-managed key
</li>
<li class="listitem">
Encrypting Azure and GCP deployments with a customer-managed key
</li>
<li class="listitem">
Encrypting deployments using keys from <a href="https://docs.aws.amazon.com/kms/latest/developerguide/keystore-external.html" class="ulink" target="_top">external key stores to AWS KMS</a>
</li>
<li class="listitem">
Disabling encryption on a deployment
</li>
</ul>
</div>
<h3><a id="ec_create_a_deployment_encrypted_with_your_own_key"></a>Create a deployment encrypted with your own key<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-106/docs/saas/ec-encrypt-with-cmek.asciidoc">edit</a></h3>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create a symmetric <a href="https://docs.aws.amazon.com/kms/latest/developerguide/create-keys.html" class="ulink" target="_top">single-region key</a> or <a href="https://docs.aws.amazon.com/kms/latest/developerguide/multi-region-keys-replicate.html" class="ulink" target="_top">multi-region replica key</a>. The key must be available in each region in which you have deployments to encrypt. You can use the same key to encrypt multiple deployments. Later, you will need to provide the Amazon Resource Name (ARN) of that key to Elastic Cloud.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Hardware Security Modules (HSM) and external KMS keys can leverage integration and support provided by AWS KMS, which acts as broker. Elastic Cloud leverages the cloud provider&#8217;s KMS as passthrough connections for supported external key providers, including HSM.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Apply a key policy with the settings required by Elastic Cloud to the key created in the previous step:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "Sid": "ElasticKeyAccess",
  "Effect": "Allow",
  "Principal": {
    "AWS": "*"
  },
  "Action": [
    "kms:Decrypt", <a id="CO43-1"></a><i class="conum" data-value="1"></i>
    "kms:Encrypt", <a id="CO43-2"></a><i class="conum" data-value="2"></i>
    "kms:GetKeyRotationStatus", <a id="CO43-3"></a><i class="conum" data-value="3"></i>
    "kms:GenerateDataKey", <a id="CO43-4"></a><i class="conum" data-value="4"></i>
    "kms:DescribeKey" <a id="CO43-5"></a><i class="conum" data-value="5"></i>
  ],
  "Resource": "*",
  "Condition": { <a id="CO43-6"></a><i class="conum" data-value="6"></i>
    "ForAnyValue:StringEquals": {
      "aws:PrincipalOrgPaths": "o-ygducmlz12/r-e5t3/ou-e5t3-fzpdq76p/ou-e5t3-ysfcmd95/ou-e5t3-hwt05su3/"
   }
 }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html" class="ulink" target="_top">kms:Decrypt</a> -
This operation is used to decrypt data encryption keys stored on the deployment&#8217;s host, as well as decrypting snapshots stored in S3.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p><a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_Encrypt.html" class="ulink" target="_top">kms:Encrypt</a> -
This operation is used to encrypt the data encryption keys generated by the KMS as well as encrypting your snapshots.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p><a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_GetKeyRotationStatus.html" class="ulink" target="_top">kms:GetKeyRotationStatus</a> -
This operation is used to determine whether automatic key rotation is enabled.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p><a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_GenerateDataKey.html" class="ulink" target="_top">kms:GenerateDataKey</a> -
This operation is used to generate a data encryption key along with an encrypted version of it. The system leverages the randomness provided by the KMS to produce the data encryption key and your actual customer-managed key to encrypt the data encryption key.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p><a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_DescribeKey.html" class="ulink" target="_top">kms:DescribeKey</a> -
This operation is used to check whether your key is properly configured for Elastic Cloud. In addition, Elastic Cloud uses this to check if a manual key rotation was performed by comparing underlying key IDs associated with an alias.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-6"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>This condition allows the accounts associated with the Elastic Cloud production infrastructure to access your key. Under typical circumstances, Elastic Cloud will only be accessing your key via two AWS accounts: the account your deployment&#8217;s host is in and the account your S3 bucket containing snapshots is in. However, determining these particular account IDs prior to the deployment creation is not possible at the moment. This encompasses all of the possibilities. For more on this, check the <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-principalorgpaths" class="ulink" target="_top">AWS documentation</a>.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>Create a new deployment:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Choose a <span class="strong strong"><strong>cloud region</strong></span> and a <span class="strong strong"><strong>deployment template</strong></span> (also called hardware profile) for your deployment from the <a class="xref" href="ec-regions-templates-instances.html" title="Available regions, deployment templates and instance configurations">list of available regions, deployment templates, and instance configurations</a>.
</li>
<li class="listitem">
Get your encoded Elastic Cloud API key.
</li>
<li class="listitem">
Get the ARN of the symmetric AWS KMS key or of its alias. Use an alias if you are planning on utilizing manual key rotations as specified in the <a href="https://docs.aws.amazon.com/kms/latest/developerguide/rotate-keys.html" class="ulink" target="_top">AWS documentation</a>.
</li>
<li class="listitem">
<p>Use these parameters to create a new deployment with the <a class="xref" href="Deployment_-_CRUD.html" title="Deployment - CRUD">Elastic Cloud API</a>. For example:</p>
<div class="pre_wrapper lang-curl">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-curl">curl -XPOST \
-H 'Content-Type: application/json' \
-H "Authorization: ApiKey $EC_API_KEY" \
"https://api.elastic-cloud.com/api/v1/deployments?template_id=$TEMPLATE_ID" \
-d '
{
  "name": "my-deployment",
  "version": "8.12.0",
  "region": "us-east-1",
  "settings": {
    "byok": {
      "key_resource_path": "$ARN"
    }
  }
}</pre>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can also create the deployment <a href="/guide/en/cloud/current/definitions.html#RestoreSnapshotConfiguration" class="ulink" target="_top">from a snapshot</a> of a deployment that was initially not encrypted with a customer-managed key. You can use this as a workaround to encrypt existing data under new deployments using your key, until encrypting existing deployments with a customer-managed key is supported.</p>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<p>The deployment is now created and encrypted using the specified key. Future snapshots will also be encrypted using that key.</p>
<h3><a id="ec_rotate_a_customer_managed_key"></a>Rotate a customer-managed key<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-106/docs/saas/ec-encrypt-with-cmek.asciidoc">edit</a></h3>
<p>Elastic Cloud will automatically rotate the keys every 30 days as a security best practice.</p>
<p>You can also trigger a manual rotation <a href="https://docs.aws.amazon.com/kms/latest/developerguide/rotate-keys.html" class="ulink" target="_top">in AWS KMS</a>, which will take effect in Elastic Cloud within 30 minutes. <span class="strong strong"><strong>For manual rotations to work, you must use an alias when creating the deployment.</strong></span></p>
<h3><a id="ec_revoke_a_customer_managed_key"></a>Revoke a customer-managed key<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-106/docs/saas/ec-encrypt-with-cmek.asciidoc">edit</a></h3>
<p>Revoking a customer-managed key in your key management service can be a break-glass procedure in case of a security breach. Elastic Cloud gets an error if an encryption key is disabled, deleted, or if the appropriate role is removed from the IAM policy. If the issue persists for more than 30 minutes, Elastic Cloud locks the directories in which your deployment data live and prompts you to delete your deployment as an increased security measure.</p>
<p>If that happens and this is not intended, you can restore the key in the key management system. Your deployment operations will resume when the key can be reached again. For more details, check <a class="xref" href="ec-encrypt-with-cmek.html#ec-encrypt-with-cmek-troubleshooting" title="Troubleshooting">Troubleshooting</a>.</p>
<p>By revoking the customer-managed key, data stored in Elastic Cloud is effectively crypto-shredded.</p>
<p>In a future release of Elastic Cloud, you will be able to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Remove a customer-managed key and revert your deployment to using an Elastic-managed encryption.
</li>
<li class="listitem">
Edit the customer-managed key in use in a deployment to re-encrypt it with a different key.
</li>
</ul>
</div>
<h3><a id="ec_encrypt_an_existing_deployment_using_a_new_customer_managed_key"></a>Encrypt an existing deployment using a new customer-managed key<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-106/docs/saas/ec-encrypt-with-cmek.asciidoc">edit</a></h3>
<p>Encrypting deployments with a customer-managed key is currently only possible for new deployments.
In a future release of Elastic Cloud, you will be able to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Encrypt an existing Elastic Cloud deployment with a customer-managed key.
</li>
<li class="listitem">
Edit the customer-managed key in use in a deployment to re-encrypt it with a different key.
</li>
</ul>
</div>
<h3><a id="ec-encrypt-with-cmek-troubleshooting"></a>Troubleshooting<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-106/docs/saas/ec-encrypt-with-cmek.asciidoc">edit</a></h3>
<p><span class="strong strong"><strong>My deployment became inaccessible. What&#8217;s causing this?</strong></span></p>
<p>When Elastic Cloud can&#8217;t reach the encryption key, your deployment may become inaccessible. The most common reasons for this issue are:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Connectivity issues between Elastic Cloud and the KMS.<br></p>
<p>When Elastic Cloud is unable to access the customer-managed key, Elastic is alerted and will work to identify the cause. Elastic does not pause or terminate deployment instances when detecting connectivity issues, but your deployment may be inaccessible until issues are fixed.</p>
</li>
<li class="listitem">
<p>The customer-managed key was deleted or revoked on the KMS.<br></p>
<p>Restore or recover your key, and if need be, rotate your key and associate a new key before deleting your old key. Elastic Cloud will send you alerts prompting you to restore the key if it cannot access your key and your deployment is not operational.<br></p>
<p>If access to your key is not restored within 30 minutes, Elastic Cloud locks the directories in which your deployment data live and prompts you to delete your deployment as an increased security measure.<br></p>
<p>While it is locked, the deployment retains all data but is not readable or writable*:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If access to the key is never restored, the deployment data does not become accessible again
</li>
<li class="listitem">
<p>When restoring access to the key, the deployment becomes operational again:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If Elastic didn&#8217;t have to perform any platform operations on your instances during the locked period, operations are restored with minimum downtime.
</li>
<li class="listitem">
If Elastic performed some platform operations on your instances during the locked period, restoring operations can require some downtime. It&#8217;s also possible that some data can&#8217;t be restored** depending on the available snapshots.
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<p><em>*During the locked directory period, Elastic may need to perform platform operations on the machines hosting your instances that result in data loss on the Elasticsearch data nodes but not the deployment snapshots.</em></p>
<p><em>**Elastic recommends that you keep snapshots of your deployment in custom snapshot repositories in your own CSP account for data recovery purposes.</em></p>
</div>
<div class="navfooter">
<span class="prev">
<a href="ec-static-ips.html">« Elastic Cloud Static IPs</a>
</span>
<span class="next">
<a href="ec-monitoring.html">Keeping your deployment healthy »</a>
</span>
</div>
</div>
</body>
</html>
