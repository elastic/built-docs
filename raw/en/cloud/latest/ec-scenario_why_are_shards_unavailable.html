<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Why are my shards unavailable? | Elasticsearch Service Documentation | Elastic</title>
<meta class="elastic" name="content" content="Why are my shards unavailable? | Elasticsearch Service Documentation">

<link rel="home" href="index.html" title="Elasticsearch Service Documentation"/>
<link rel="up" href="ec-monitoring-diagnose-resolve.html" title="Diagnose and resolve issues"/>
<link rel="prev" href="ec-scenario_why_is_my_node_unavailable.html" title="Diagnose unavailable nodes"/>
<link rel="next" href="ec-scenario_why_is_performance_degrading_over_time.html" title="Why is performance degrading over time?"/>
<meta class="elastic" name="product_version" content="latest"/>
<meta class="elastic" name="product_name" content="Elastic Cloud"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Cloud/Reference"/>
<meta name="DC.subject" content="Elastic Cloud"/>
<meta name="DC.identifier" content="latest"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="ec-scenario_why_is_my_node_unavailable.html">« Diagnose unavailable nodes</a>
</span>
<span class="next">
<a href="ec-scenario_why_is_performance_degrading_over_time.html">Why is performance degrading over time? »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Service Documentation</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="ec-monitoring.html">Monitoring your deployment</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="ec-monitoring-diagnose-resolve.html">Diagnose and resolve issues</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Why are my shards unavailable?</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="ec-scenario_why_are_shards_unavailable"></a>Why are my shards unavailable?</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
</div></div></div>
<p>This section describes how to analyze unassigned shards using the Elasticsearch APIs and Kibana.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-analyze_shards_with-api" title="Analyze unassigned shards using the Elasticsearch API">Analyze unassigned shards using the Elasticsearch API</a>
</li>
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-analyze_shards_with-kibana" title="Analyze unassigned shards using the Kibana UI">Analyze unassigned shards using the Kibana UI</a>
</li>
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-remediate-issues-allocation-explain-API" title="Remediate common issues returned by the cluster allocation explain API">Remediate common issues returned by the cluster allocation explain API</a>
</li>
</ul>
</div>
<p>Elasticsearch distributes the documents in an index across multiple shards and distributes copies of those shards across multiple nodes in the cluster. This both increases capacity and makes the cluster more resilient, ensuring your data remains available if a node goes down.</p>
<p>A healthy (green) cluster has a primary copy of each shard and the required number of replicas are assigned to different nodes in the cluster.</p>
<p>If a cluster has unassigned replica shards, it is functional but vulnerable in the event of a failure. The cluster is unhealthy and reports a status of yellow.</p>
<p>If a cluster has unassigned primary shards, some of your data is unavailable. The cluster is unhealthy and reports a status of red.</p>
<p>A formerly-healthy cluster might have unassigned shards because nodes have dropped out or moved, are running out of disk space, or are hitting allocation limits.</p>
<p>If a cluster has unassigned shards, you might see an error message such as this on the Elastic Cloud console:</p>
<div class="imageblock">
<div class="content">
<img src="images/ec-unhealthy-deployment.png" alt="Unhealthy deployment error message">
</div>
</div>
<p>If your issue is not addressed here, then <a class="xref" href="ec-get-help.html" title="Getting help">contact Elastic support for help</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="ec-analyze_shards_with-api"></a>Analyze unassigned shards using the Elasticsearch API</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
</div></div></div>
<p>You can retrieve information about the status of your cluster, indices, and shards using the Elasticsearch API. To access the API you can either use the <a href="/guide/en/kibana/8.15/console-kibana.html" class="ulink" target="_top">Kibana Dev Tools Console</a>, or the <a class="xref" href="ec-api-console.html" title="Access the Elasticsearch API console">Elasticsearch API console</a>.
If you have your own way to run the Elasticsearch API, check <a class="xref" href="ec-api-access.html" title="How to access the API">How to access the API</a>.
This section shows you how to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-check-cluster-health" title="Check cluster health">Check cluster health</a>
</li>
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-check-unhealthy-indices" title="Check unhealthy indices">Check unhealthy indices</a>
</li>
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-check-which-unassigned-shards" title="Check which shards are unassigned">Check which shards are unassigned</a>
</li>
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-check-why-unassigned-shards" title="Check why shards are unassigned">Check why shards are unassigned</a>
</li>
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-check-es-cluster-logs" title="Check Elasticsearch cluster logs">Check Elasticsearch cluster logs</a>
</li>
</ul>
</div>
<div class="position-relative"><h5><a id="ec-check-cluster-health"></a>Check cluster health</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
<p>Use the <a href="/guide/en/elasticsearch/reference/8.15/cluster-health.html" class="ulink" target="_top">Cluster health API</a>:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">GET /_cluster/health/</pre>
</div>
<p>This command returns the cluster status (green, yellow, or red) and shows the number of unassigned shards:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "cluster_name" : "xxx",
  "status" : "red",
  "timed_out" : false,
  "number_of_nodes" : "x",
  "number_of_data_nodes" : "x",
  "active_primary_shards" : 116,
  "active_shards" : 229,
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 1,
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_inflight_fetch" : 0,
  "task_max_waiting_in_queue_millis" : 0,
  "active_shards_percent_as_number" : 98.70689655172413
}</pre>
</div>
<div class="position-relative"><h5><a id="ec-check-unhealthy-indices"></a>Check unhealthy indices</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
<p>Use the <a href="/guide/en/elasticsearch/reference/8.15/cat-indices.html" class="ulink" target="_top">cat indices API</a> to get the status of individual indices.
Specify the <code class="literal">health</code> parameter to limit the results to a particular status, for example <code class="literal">?v&amp;health=red</code> or <code class="literal">?v&amp;health=yellow</code>.</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">GET /_cat/indices?v&amp;health=red</pre>
</div>
<p>This command returns any indices that have unassigned primary shards (red status):</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">red   open    filebeat-7.10.0-2022.01.07-000014 C7N8fxGwRxK0JcwXH18zVg  1 1
red   open    filebeat-7.9.3-2022.01.07-000015  Ib4UIJNVTtOg6ovzs011Lq  1 1</pre>
</div>
<p>For more information, refer to <a href="/guide/en/elasticsearch/reference/8.15/red-yellow-cluster-status.html#fix-red-yellow-cluster-status" class="ulink" target="_top">Fix a red or yellow cluster status</a>.</p>
<div class="position-relative"><h5><a id="ec-check-which-unassigned-shards"></a>Check which shards are unassigned</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
<p>Use the <a href="/guide/en/elasticsearch/reference/8.15/cat-shards.html" class="ulink" target="_top">cat shards API</a>:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">GET /_cat/shards/?v</pre>
</div>
<p>This command returns the index name, followed by the shard type and shard status:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">filebeat-7.10.0-2022.01.07-000014 0   P   UNASSIGNED
filebeat-7.9.3-2022.01.07-000015  1   P   UNASSIGNED
filebeat-7.9.3-2022.01.07-000015  2   r   UNASSIGNED</pre>
</div>
<div class="position-relative"><h5><a id="ec-check-why-unassigned-shards"></a>Check why shards are unassigned</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
<p>To understand why shards are unassigned, run the <a href="/guide/en/elasticsearch/reference/8.15/cluster-allocation-explain.html" class="ulink" target="_top">Cluster allocation explain API</a>.</p>
<p>Running the API call <code class="literal">GET _cluster/allocation/explain</code> retrieves an allocation explanation for unassigned primary shards, or replica shards.</p>
<p>For example, if <code class="literal">_cat/health</code> shows that the primary shard of shard 1 in the <code class="literal">filebeat-7.9.3-2022.01.07-000015</code> index is unassigned, you can get the allocation explanation with the following request:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">GET _cluster/allocation/explain
{
  "index": "filebeat-7.9.3-2022.01.07-000015",
  "shard": 1,
  "primary": true
}</pre>
</div>
<p>The response is as follows:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "index": "filebeat-7.9.3-2022.01.07-000015",
  "shard": 1,
  "primary": true,
  "current_state": "unassigned",
  "unassigned_info": {
    "reason": "CLUSTER_RECOVERED",
    "at": "2022-04-12T13:06:36.125Z",
    "last_allocation_status": "no_valid_shard_copy"
  },
  "can_allocate": "no_valid_shard_copy",
  "allocate_explanation": "cannot allocate because a previous copy of the primary shard existed but can no longer be found on the nodes in the cluster",
  "node_allocation_decisions": [
    {
      "node_id": "xxxx",
      "node_name": "instance-0000000005",
      (... skip ...)
      "node_decision": "no",
      "store": {
        "found": false
      }
    }
  ]
}</pre>
</div>
<div class="position-relative"><h5><a id="ec-check-es-cluster-logs"></a>Check Elasticsearch cluster logs</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
<p>To determine the allocation issue, you can <a class="xref" href="ec-monitoring-setup.html#ec-check-logs" title="Check the logs">check the logs</a>. This is easier if you have set up a dedicated monitoring deployment.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="ec-analyze_shards_with-kibana"></a>Analyze unassigned shards using the Kibana UI</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
</div></div></div>
<p>If you are shipping logs and metrics to a monitoring deployment, go through the following steps.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Select your deployment from the Elasticsearch Service panel and navigate to the <span class="strong strong"><strong>Logs and metrics</strong></span> page.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Enable</strong></span>.
</li>
<li class="listitem">
Choose the deployment where to send your logs and metrics.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Save</strong></span>. It might take a few minutes to apply the configuration changes.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>View</strong></span> to open the Kibana UI and get more details on metrics and logs.
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ec-logs-metrics-page.png" alt="Log and metrics page">
</div>
</div>
<p>The unhealthy indices appear with a red or yellow status.</p>
<div class="imageblock">
<div class="content">
<img src="images/ec-red-yellow-indices.png" alt="Unhealthy indices in red or yellow status">
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="ec-remediate-issues-allocation-explain-API"></a>Remediate common issues returned by the cluster allocation explain API</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
</div></div></div>
<p>Here&#8217;s how to resolve the most common causes of unassigned shards reported by the cluster allocation explain API.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-disk-full" title="Disk is full">Disk is full</a>
</li>
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-node-moved-to-another-host" title="A node containing data has moved to a different host">A node containing data has moved to a different host</a>
</li>
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-cannot-assign-shards-on-allocation-rule" title="Unable to assign shards based on the allocation rule">Unable to assign shards based on the allocation rule</a>
</li>
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-eligible-data-nodes-less-than-replicas" title="The number of eligible data nodes is less than the number of replicas">The number of eligible data nodes is less than the number of replicas</a>
</li>
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-searchable-snapshot-indices-not-allocated" title="A snapshot issue prevents searchable snapshot indices from being allocated">A snapshot issue prevents searchable snapshot indices from being allocated</a>
</li>
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-max-retry-exceeded" title="Maximum retry times exceeded">Maximum retry times exceeded</a>
</li>
<li class="listitem">
<a class="xref" href="ec-scenario_why_are_shards_unavailable.html#ec-max-shard-per-node" title="Max shard per node reached the limit">Max shard per node reached the limit</a>
</li>
</ul>
</div>
<p>If your issue is not addressed here, then <a class="xref" href="ec-get-help.html" title="Getting help">contact Elastic support for help</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="ec-disk-full"></a>Disk is full</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Symptom</strong></span></p>
<p>If the disk usage exceeded the threshold, you may get one or more of the following messages:</p>
<p><code class="literal">the node is above the high watermark cluster setting [cluster.routing.allocation.disk.watermark.high=90%], using more disk space than the maximum allowed [90.0%], actual free: [9.273781776428223%]</code></p>
<p><code class="literal">unable to force allocate shard to [%s] during replacement, as allocating to this node would cause disk usage to exceed 100%% ([%s] bytes above available disk space)</code></p>
<p><code class="literal">the node is above the low watermark cluster setting [cluster.routing.allocation.disk.watermark.low=85%], using more disk space than the maximum allowed [85.0%], actual free: [14.119771122932434%]</code></p>
<p><code class="literal">after allocating [[restored-xxx][0], node[null], [P], recovery_source[snapshot recovery [Om66xSJqTw2raoNyKxsNWg] from xxx/W5Yea4QuR2yyZ4iM44fumg], s[UNASSIGNED], unassigned_info[[reason=NEW_INDEX_RESTORED], at[2022-03-02T10:56:58.210Z], delayed=false, details[restore_source[xxx]], allocation_status[fetching_shard_data]]] node [GTXrECDRRmGkkAnB48hPqw] would have more than the allowed 10% free disk threshold (8.7% free), preventing allocation</code></p>
<p>Check also <a href="/guide/en/elasticsearch/reference/8.15/modules-cluster.html" class="ulink" target="_top">Cluster-level shard allocation and routing settings</a> for more information.</p>
<p><span class="strong strong"><strong>Resolutions</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Increase the disk size.</p>
<p>When the disk usage exceeds the flood-stage watermark and the deployment is already unhealthy, you must free up disk space by  <a href="/guide/en/elasticsearch/reference/8.15/docs-delete.html" class="ulink" target="_top">deleting unused indices</a> before you can increase the disk size. Attempting to make configuration changes while the cluster is unhealthy will fail. For more information, refer to <a class="xref" href="ec-customize-deployment-components.html" title="How can I customize the components of my deployment?">How can I customize the components of my deployment?</a>.</p>
</li>
<li class="listitem">
<p>Enable <a class="xref" href="ec-autoscaling.html" title="Deployment autoscaling">autoscaling</a>.</p>
<p>This helps you manage your deployments more easily by automatically adjusting capacity. You might need to delete unused indices to free up disk space before you can enable the autoscaling feature.</p>
</li>
<li class="listitem">
Configure ILM policies to migrate older data to lower-cost data tiers and use searchable snapshots to provide redundancy for read-only data. You must restore the cluster to a healthy state before you can add data tiers. For more information, see <a href="/guide/en/elasticsearch/reference/8.15/data-tiers.html#configure-data-tiers-cloud" class="ulink" target="_top">data tiers</a> and <a href="/guide/en/elasticsearch/reference/8.15/index-lifecycle-management.html" class="ulink" target="_top">ILM policy</a>.
</li>
</ul>
</div>
<p>If you need assistance restoring your cluster to a healthy state so you can make configuration changes, then <a class="xref" href="ec-get-help.html" title="Getting help">contact Elastic support for help</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="ec-node-moved-to-another-host"></a>A node containing data has moved to a different host</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Symptom</strong></span></p>
<p>During the routine system maintenance performed by Elastic, it might happen that a node moves to a different host. If the indices are not configured with replica shards, the shard data on the Elasticsearch node that is moved will be lost, and you might get one or more of these messages:</p>
<p><code class="literal">cannot allocate because a previous copy of the primary shard existed but can no longer be found on the nodes in the cluster</code></p>
<p><span class="strong strong"><strong>Resolutions</strong></span></p>
<p>Configure an <a class="xref" href="ec-planning.html" title="Plan for production">highly available cluster</a> to keep your service running. Also, consider taking the following actions to bring your deployment back to health and recover your data from the snapshot.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="/guide/en/elasticsearch/reference/8.15/indices-close.html" class="ulink" target="_top">Close the red indices</a>
</li>
<li class="listitem">
<a class="xref" href="ec-restoring-snapshots.html" title="Work with snapshots">Restore the indices</a> from the last successful snapshot
</li>
</ul>
</div>
<p>For more information, check also <a href="/guide/en/elasticsearch/reference/8.15/high-availability-cluster-design.html" class="ulink" target="_top">Designing for resilience</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="ec-cannot-assign-shards-on-allocation-rule"></a>Unable to assign shards based on the allocation rule</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Symptom</strong></span></p>
<p>When shards cannot be assigned, due to <a href="/guide/en/elasticsearch/reference/8.15/data-tiers.html#data-tier-allocation" class="ulink" target="_top">data tier allocation</a> or <a href="/guide/en/elasticsearch/reference/8.15/shard-allocation-filtering.html" class="ulink" target="_top">attribute-based allocation</a>, you might get one or more of these messages:</p>
<p><code class="literal">node does not match index setting [index.routing.allocation.include] filters [node_type:\"cold\"]</code></p>
<p><code class="literal">index has a preference for tiers [data_cold] and node does not meet the required [data_cold] tier</code></p>
<p><code class="literal">index has a preference for tiers [data_cold,data_warm,data_hot] and node does not meet the required [data_cold] tier</code></p>
<p><code class="literal">index has a preference for tiers [data_warm,data_hot] and node does not meet the required [data_warm] tier</code></p>
<p><code class="literal">this node's data roles are exactly [data_frozen] so it may only hold shards from frozen searchable snapshots, but this index is not a frozen searchable snapshot</code></p>
<p><span class="strong strong"><strong>Resolutions</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Make sure nodes are available in each data tier and have sufficient disk space.
</li>
<li class="listitem">
<a href="/guide/en/elasticsearch/reference/8.15/indices.html#index-settings" class="ulink" target="_top">Check the index settings</a> and ensure shards can be allocated to the expected data tier.
</li>
<li class="listitem">
Check the <a href="/guide/en/elasticsearch/reference/8.15/index-lifecycle-management.html" class="ulink" target="_top">ILM policy</a> and check for issues with the <a href="/guide/en/elasticsearch/reference/8.15/ilm-allocate.html" class="ulink" target="_top">allocate action</a>.
</li>
<li class="listitem">
Inspect the <a href="/guide/en/elasticsearch/reference/8.15/index-templates.html" class="ulink" target="_top">index templates</a> and check for issues with the index settings.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="ec-eligible-data-nodes-less-than-replicas"></a>The number of eligible data nodes is less than the number of replicas</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Symptom</strong></span></p>
<p>Unassigned replica shards are often caused by there being fewer eligible data nodes than the configured number_of_replicas.</p>
<p><span class="strong strong"><strong>Resolutions</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add more <a class="xref" href="ec-customize-deployment-components.html" title="How can I customize the components of my deployment?">eligible data nodes or more availability zones</a> to ensure resiliency.
</li>
<li class="listitem">
Adjust the <code class="literal">number_of_replicas</code> <a href="/guide/en/elasticsearch/reference/8.15/indices-update-settings.html" class="ulink" target="_top">setting</a> for your indices to the number of eligible data nodes -1.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="ec-searchable-snapshot-indices-not-allocated"></a>A snapshot issue prevents searchable snapshot indices from being allocated</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Symptom</strong></span></p>
<p>Some snapshots operations might be impacted, as shown in the following example:</p>
<p><code class="literal">failed shard on node [Yc_Jbf73QVSVYSqZT8HPlA]: failed recovery, failure RecoveryFailedException[[restored-my_index-2021.32][1]: … SnapshotMissingException[[found-snapshots:2021.08.25-my_index-2021.32-default_policy-_j2k8it9qnehe1t-2k0u6a/iOAoyjWLTyytKkW3_wF1jw] is missing]; nested: NoSuchFileException[Blob object [snapshots/52bc3ae2030a4df8ab10559d1720a13c/indices/WRlkKDuPSLW__M56E8qbfA/1/snap-iOAoyjWLTyytKkW3_wF1jw.dat] not found: The specified key does not exist. (Service: Amazon S3; Status Code: 404; Error Code: NoSuchKey; Request ID: 4AMTM1XFMTV5F00V; S3 Extended Request ID:</code></p>
<p><span class="strong strong"><strong>Resolutions</strong></span></p>
<p>Upgrade to Elasticsearch version 7.17.0 or later, which resolves bugs that affected  snapshot operations in earlier versions. Check <a class="xref" href="ec-upgrade-deployment.html" title="Upgrade versions">Upgrade versions</a> for more details.</p>
<p>If you can&#8217;t upgrade, you can recreate the snapshot repository as a workaround.</p>
<p>The bugs also affect searchable snapshots. If you still have data in the cluster but cannot restore from the searchable snapshot, you can try reindexing and recreating the searchable snapshot:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Reindex all the affected indices to new regular indices
</li>
<li class="listitem">
Remove the affected frozen indices
</li>
<li class="listitem">
Take the snapshot and mount the indices again
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="ec-max-shard-per-node"></a>Max shard per node reached the limit</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Symptom</strong></span></p>
<p>The parameter <a href="/guide/en/elasticsearch/reference/8.15/misc-cluster-settings.html#cluster-max-shards-per-node" class="ulink" target="_top"><code class="literal">cluster.max_shards_per_node</code></a> limits the total number of primary and replica shards for the cluster. If your cluster has a number of shards beyond this limit, you might get the following message:</p>
<p><code class="literal">Validation Failed: 1: this action would add [2] shards, but this cluster currently has [1000]/[1000] maximum normal shards open</code></p>
<p><span class="strong strong"><strong>Resolutions</strong></span></p>
<p>Delete unnecessary indices, add more data nodes, and <a href="/guide/en/elasticsearch/reference/8.15/size-your-shards.html" class="ulink" target="_top">avoid oversharding</a> as too many shards can overwhelm your cluster.
If you cannot take these actions, and you’re confident your changes won’t destabilize the cluster, you can temporarily increase the limit using the <a href="/guide/en/elasticsearch/reference/8.15/cluster-update-settings.html" class="ulink" target="_top">cluster update settings API</a> and retry the action. For more details, check <a href="/guide/en/elasticsearch/reference/8.15/size-your-shards.html#troubleshoot-shard-related-errors" class="ulink" target="_top">Troubleshoot shard-related errors</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="ec-max-retry-exceeded"></a>Maximum retry times exceeded</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/cloud/edit/ms-111/docs/shared/ec-ce-monitoring-scenarios.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Symptom</strong></span></p>
<p>The cluster will attempt to allocate a shard a few times, before giving up and leaving the shard unallocated. On Elasticsearch Service,  <code class="literal">index.allocation.max_retries</code> defaults to 5. If allocation fails after the maximum number of retries, you might get the following message:</p>
<p><code class="literal">shard has exceeded the maximum number of retries [%d] on failed allocation attempts - manually call [/_cluster/reroute?retry_failed=true] to retry, [%s]</code></p>
<p><span class="strong strong"><strong>Resolutions</strong></span></p>
<p>Run <a href="/guide/en/elasticsearch/reference/8.15/cluster-reroute.html" class="ulink" target="_top"><code class="literal">POST /_cluster/reroute?retry_failed=true</code></a> API to retry. If it still fails, rerun the <a href="/guide/en/elasticsearch/reference/8.15/cluster-allocation-explain.html" class="ulink" target="_top">Cluster allocation explain</a> API to diagnose the problem.</p>
</div>

</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="ec-scenario_why_is_my_node_unavailable.html">« Diagnose unavailable nodes</a>
</span>
<span class="next">
<a href="ec-scenario_why_is_performance_degrading_over_time.html">Why is performance degrading over time? »</a>
</span>
</div>
</body>
</html>
