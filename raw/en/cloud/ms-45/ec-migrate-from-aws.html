<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Migrating from Amazon Elasticsearch Service | Elasticsearch Service Documentation | Elastic</title>
<link rel="home" href="index.html" title="Elasticsearch Service Documentation"/>
<link rel="up" href="ec-migrate-data.html" title="Migrating your Elasticsearch data"/>
<link rel="prev" href="ec-migrate-data.html" title="Migrating your Elasticsearch data"/>
<link rel="next" href="ec-migrate-data-internal.html" title="Migrating internal indices"/>
<meta name="DC.type" content="Learn/Docs/Cloud/Reference"/>
<meta name="DC.subject" content="Elastic Cloud"/>
<meta name="DC.identifier" content="ms-45"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Elasticsearch Service Documentation</a></span>
»
<span class="breadcrumb-link"><a href="ec-getting-started.html">Getting started</a></span>
»
<span class="breadcrumb-link"><a href="ec-migrate-data.html">Migrating your Elasticsearch data</a></span>
»
<span class="breadcrumb-node">Migrating from Amazon Elasticsearch Service</span>
</div>
<div class="navheader">
<span class="prev">
<a href="ec-migrate-data.html">« Migrating your Elasticsearch data</a>
</span>
<span class="next">
<a href="ec-migrate-data-internal.html">Migrating internal indices »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="ec-migrate-from-aws"></a>Migrating from Amazon Elasticsearch Service</h2>
</div></div></div>
<p>This is a fairly technical guide for migrating from Amazon Web Services Elasticsearch (AWS ES) to Elasticsearch Service on Elastic Cloud. These steps may require some programming experience. AWS ES clusters are commonly provisioned into a Virtual Private Cloud (VPC), but they can also be located on a public-facing endpoint. In order to keep this guide universal, we describe how to migrate your data in either scenario.</p>
<h4><a id="ec_before_you_begin_5"></a>Before you begin</h4>
<p>Following are a few things to make note of before you proceed with the steps to migrate your AWS Elasticsearch data.</p>
<p><a id="ec-migrate-from-aws-es-security-steps"></a><span class="strong strong"><strong>Permissions</strong></span></p>
<p>It’s important to understand the IAM security steps in this process. First, in order to snapshot an AWS ES cluster into S3, your AWS ES cluster needs permission to write to a private S3 bucket. This requires an IAM role and policy that have the necessary permissions. Next, you’ll need to attach an IAM policy to an IAM user, creating a new user if necessary. You can use that IAM user to connect to your AWS ES cluster, and later your Elastic-managed deployment can use the same credentials to read the snapshot from your S3 bucket.</p>
<p>To learn more about setting up an IAM role, policy, and user, see <a href="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-managedomains-snapshots.html" class="ulink" target="_top">Working with Amazon Elasticsearch Service Index Snapshots</a> in the AWS documentation.</p>
<p><a id="ec-migrate-from-aws-es-tools"></a><span class="strong strong"><strong>Tools</strong></span></p>
<p>During this procedure, if you don&#8217;t already have a current snapshot of your ES data, you will run a manual snapshot request on your AWS Elasticsearch cluster. If you can access your ES cluster directly, you can use the Postman client to run the request. If your ES cluster is inside a Virtual Private Cloud (VPC), you can use the Python AWS SDK. Details about each tool are provided in <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-part2" title="Part 2 - Take a snapshot of your Elasticsearch data">Part 2</a>.</p>
<p><a id="ec-migrate-from-aws-es-variables-table"></a><span class="strong strong"><strong>AWS variables</strong></span></p>
<p>There are several variables that you&#8217;ll need to make note of along the way. We suggest that you copy and paste the following table to a notes file, where you can reference it as you proceed through this guide. This will make it easy to fill in the values specific for your migration.</p>
<details>
<summary class="title"><span class="strong strong"><strong>Expand to view the variables table</strong></span></summary>
<div class="content">
<div class="table">
<p class="title"><strong>Table 1. Data migration variables</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="Data migration variables">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Description</p></td>
<td align="left" valign="top"><p>Variable</p></td>
<td align="left" valign="top"><p>Value</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>AWS ES Domain ARN</p></td>
<td align="left" valign="top"><p>DOMAIN_ARN</p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>AWS ES Endpoint URL</p></td>
<td align="left" valign="top"><p>ES_ENDPOINT</p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>AWS ES Region</p></td>
<td align="left" valign="top"><p>ES_REGION</p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>AWS S3 Bucket Name</p></td>
<td align="left" valign="top"><p>S3_BUCKET_NAME</p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>AWS S3 Region</p></td>
<td align="left" valign="top"><p>S3_REGION_NAME</p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>AWS IAM Role ARN</p></td>
<td align="left" valign="top"><p>ROLE_ARN</p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>AWS IAM Access Key ID</p></td>
<td align="left" valign="top"><p>ACCESS_KEY</p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>AWS IAM Secret Access Key</p></td>
<td align="left" valign="top"><p>SECRET_KEY</p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>AWS ES Snapshot Repository</p></td>
<td align="left" valign="top"><p>SNAPSHOT_REPO</p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>AWS ES Snapshot Name</p></td>
<td align="left" valign="top"><p>SNAPSHOT_NAME</p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</details>
<p>You can change the values of <code class="literal">SNAPSHOT_REPO</code> and <code class="literal">SNAPSHOT_NAME</code> or use the values provided in these examples, namely <code class="literal">my-snapshot-repo</code> and <code class="literal">my-snapshot</code>.</p>
<h4><a id="ec-migrate-from-aws-es-procedure"></a>Procedure</h4>
<p>Migrating from AWS involves three main tasks.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
Part 1
</span>
</dt>
<dd>
Set up an AWS Identity and Access Management (IAM) user with access to an AWS S3 storage bucket.
</dd>
<dt>
<span class="term">
Part 2
</span>
</dt>
<dd>
Take a snapshot of your existing Elasticsearch data. If you can&#8217;t run commands on your Elasticsearch instance because it&#8217;s within a VPC that you can&#8217;t access, you&#8217;ll need to run a lightweight client on a host within your VPC.
</dd>
<dt>
<span class="term">
Part 3
</span>
</dt>
<dd>
Set up a deployment on Elasticsearch Service and restore the snapshot data to the new Elasticsearch cluster.
</dd>
</dl>
</div>
<p>If you already have your AWS ES cluster manually snapshotted to S3, you can skip ahead to <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-part3" title="Part 3 - Restore your snapshot to a new deployment">Part 3</a> of this guide, to create a new deployment in Elasticsearch Service and populate it with data restored from your snapshot.</p>
<p><span class="strong strong"><strong>Part 1 - Set up an IAM user with access to an S3 bucket</strong></span></p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-1-1">Get your AWS ES details</a>
</li>
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-1-2">Create an AWS S3 bucket</a>
</li>
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-1-3">Create an IAM role</a>
</li>
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-1-4">Create an IAM policy</a>
</li>
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-1-5">Create an IAM user</a>
</li>
</ol>
</div>
<p><span class="strong strong"><strong>Part 2 - Take a snapshot of your Elasticsearch data</strong></span></p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>If you can access your Elasticsearch cluster directly:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-2-1a">Register a snapshot repository using Postman</a>
</li>
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-2-1b">Take a snapshot of your data</a>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>If your Elasticsearch cluster is inside a VPC that you don&#8217;t have access to (such as through a VPN):</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-2-2a">Configure the Python AWS SDK</a>
</li>
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-2-2b">Manually snapshot AWS ES</a>
</li>
</ol>
</div>
</li>
</ol>
</div>
<p><span class="strong strong"><strong>Part 3 - Restore your snapshot to a new deployment</strong></span></p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-3-1">Create a deployment in Elasticsearch Service</a>
</li>
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-3-2">Add your secrets to the keystore</a>
</li>
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-3-3">Register your snapshot repository in your new deployment</a>
</li>
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-3-4">Restore from your new snapshot repository</a>
</li>
<li class="listitem">
<a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-3-5">Explore Elasticsearch Service</a>
</li>
</ol>
</div>
<h4><a id="ec-migrate-from-aws-es-part1"></a>Part 1 - Set up an IAM user with access to an S3 bucket</h4>
<p><a id="ec-migrate-from-aws-es-1-1"></a><span class="strong strong"><strong>1. Get your AWS ES details</strong></span></p>
<p>You will need some basic information about your AWS ES cluster to snapshot it to S3.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In your AWS Console, go to the Elasticsearch Service.
</li>
<li class="listitem">
Click on the domain of the cluster you want to snapshot.
</li>
<li class="listitem">
Copy the <code class="literal">Endpoint</code> URL value to your <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-variables-table">notes file</a> (ES_ENDPOINT).
</li>
<li class="listitem">
Copy the <code class="literal">Domain ARN</code> value to your <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-variables-table">notes file</a> (DOMAIN_ARN).
</li>
<li class="listitem">
Note which AWS region (for example, <em>us-east-1</em>) your AWS ES cluster is located in (ES_REGION).
</li>
</ol>
</div>
<p>This information will be used further in, first in the IAM policy creation and later to issue commands to the Elasticsearch cluster.</p>
<p><a id="ec-migrate-from-aws-es-1-2"></a><span class="strong strong"><strong>2. Create an AWS S3 bucket</strong></span></p>
<p>We&#8217;ll need an S3 bucket to store the snapshot.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Your S3 bucket must be in the same region as your AWS ES cluster. You will be able to restore from there to an Elastic-managed deployment in any region or cloud provider (AWS, GCP, or Azure).</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In your AWS Console, go to the S3 service.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create bucket</strong></span> to create a private S3 bucket.
</li>
<li class="listitem">
Choose your privacy and security settings.
</li>
<li class="listitem">
Copy the name of the bucket to your <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-variables-table">notes file</a> (S3_BUCKET_NAME).
</li>
<li class="listitem">
Copy the region of the bucket to your <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-variables-table">notes file</a> (S3_REGION_NAME).
</li>
</ol>
</div>
<p><a id="ec-migrate-from-aws-es-1-3"></a><span class="strong strong"><strong>3. Create an IAM role</strong></span></p>
<p>Next, we&#8217;ll create a role to delegate permission to Amazon Elasticsearch Service to take a snapshot into S3.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In your AWS Console, go to the IAM service.
</li>
<li class="listitem">
Open the <span class="strong strong"><strong>Roles</strong></span> page.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create role</strong></span>.
</li>
<li class="listitem">
Select <span class="strong strong"><strong>EC2</strong></span> as the service that will use this new role (we will change it later).
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Next: Permissions</strong></span>.
</li>
<li class="listitem">
Leave the policies on the role empty for now.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Next: Tags</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Next: Review</strong></span>.
</li>
<li class="listitem">
Name the role: <code class="literal">TheSnapshotRole</code>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create role</strong></span>.
</li>
<li class="listitem">
From the list of roles, click on the role you just created: <code class="literal">TheSnapshotRole</code>.
</li>
<li class="listitem">
Open the <span class="strong strong"><strong>Trust relationships</strong></span> tab.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Edit trust relationship</strong></span>.
</li>
<li class="listitem">
<p>Copy and paste the following JSON into the Policy Document field, replacing the sample text:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{
 "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": {
      "Service": "es.amazonaws.com"
    },
    "Action": "sts:AssumeRole"
  }]
}</pre>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Update Trust Policy</strong></span>.
</li>
<li class="listitem">
Open the <span class="strong strong"><strong>Permissions</strong></span> tab.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Add inline policy</strong></span>.
</li>
<li class="listitem">
Open the <span class="strong strong"><strong>JSON</strong></span> tab.
</li>
<li class="listitem">
<p>Copy and paste the following JSON, replacing the sample text.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Replace <code class="literal">S3_BUCKET_NAME</code> with the correct value (in two places).</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{
  "Version": "2012-10-17",
  "Statement": [{
      "Action": [
        "s3:ListBucket"
      ],
      "Effect": "Allow",
      "Resource": [
        "arn:aws:s3:::S3_BUCKET_NAME"
      ]
    },
    {
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Effect": "Allow",
      "Resource": [
        "arn:aws:s3:::S3_BUCKET_NAME/*"
      ]
    }
  ]
}</pre>
</div>
</li>
</ul>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Review policy</strong></span>.
</li>
<li class="listitem">
Name the policy: <code class="literal">TheSnapshotS3Policy</code>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create policy</strong></span>.
</li>
<li class="listitem">
Copy the <code class="literal">Role ARN</code> value to your <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-variables-table">notes file</a> (ROLE_ARN).
</li>
</ol>
</div>
<p>You have created an IAM role with an inline policy that can read &amp; write to your S3 bucket.</p>
<p><a id="ec-migrate-from-aws-es-1-4"></a><span class="strong strong"><strong>4. Create an IAM policy</strong></span></p>
<p>We need to create a new IAM policy that has permission to assume the IAM role created in the previous step, in order to register the snapshot repository.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In your AWS Console, go to the IAM service.
</li>
<li class="listitem">
Open the <span class="strong strong"><strong>Policies</strong></span> page.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create policy</strong></span>.
</li>
<li class="listitem">
Open the <span class="strong strong"><strong>JSON</strong></span> tab.
</li>
<li class="listitem">
<p>Copy and paste the following JSON, replacing the sample text.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Replace <code class="literal">ROLE_ARN</code> with the correct value.
</li>
<li class="listitem">
<p>Replace <code class="literal">DOMAIN_ARN</code> with the correct value.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "iam:PassRole",
      "Resource": "ROLE_ARN"
    },
    {
      "Effect": "Allow",
      "Action": "es:ESHttpPut",
      "Resource": "DOMAIN_ARN/*"
    }
  ]
}</pre>
</div>
</li>
</ul>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Review policy</strong></span>.
</li>
<li class="listitem">
Name the policy: <code class="literal">TheSnapshotPolicy</code>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create policy</strong></span>.
</li>
</ol>
</div>
<p>You have created an IAM policy that allows the IAM role to talk to your AWS ES domain.</p>
<p><a id="ec-migrate-from-aws-es-1-5"></a><span class="strong strong"><strong>5. Create an IAM user</strong></span></p>
<p>If you don’t already have an IAM user, we’ll need to create one and give it access to your private S3 bucket. If you do have an IAM user, you can simply attach the following IAM policy to it.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In your AWS Console, go to the IAM service.
</li>
<li class="listitem">
Open the <span class="strong strong"><strong>Users</strong></span> page.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Add user</strong></span>.
</li>
<li class="listitem">
Name the user: <code class="literal">TheSnapshotUser</code>.
</li>
<li class="listitem">
For the access type, select <span class="strong strong"><strong>Programmatic access</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Next: Permissions</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Attach existing policies directly</strong></span>.
</li>
<li class="listitem">
Filter the policies by entering <code class="literal">TheSnapshot</code> in the search field.
</li>
<li class="listitem">
Select the checkbox next to the policy <code class="literal">TheSnapshotPolicy</code>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Next: Tags</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Next: Review</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create user</strong></span>.
</li>
<li class="listitem">
Copy the <span class="strong strong"><strong>Access key ID</strong></span> value to your <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-variables-table">notes file</a> (ACCESS_KEY).
</li>
<li class="listitem">
Under <span class="strong strong"><strong>Secret access key</strong></span> click <span class="strong strong"><strong>Show</strong></span>.
</li>
<li class="listitem">
Copy the <code class="literal">Secret access key</code> value to your <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-variables-table">notes file</a> (SECRET_KEY).
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Close</strong></span>.
</li>
<li class="listitem">
From the list, click the user that you created: <code class="literal">TheSnapshotUser</code>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Add inline policy</strong></span>.
</li>
<li class="listitem">
Open the <span class="strong strong"><strong>JSON</strong></span> tab.
</li>
<li class="listitem">
<p>Copy and paste the following JSON, replacing the sample text.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Replace <code class="literal">S3_BUCKET_NAME</code> with the correct value (in 2 places).</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{
  "Version": "2012-10-17",
  "Statement": [{
      "Action": [
        "s3:ListBucket"
      ],
      "Effect": "Allow",
      "Resource": [
        "arn:aws:s3:::S3_BUCKET_NAME"
      ]
    },
    {
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Effect": "Allow",
      "Resource": [
        "arn:aws:s3:::S3_BUCKET_NAME/*"
      ]
    }
  ]
}</pre>
</div>
<p>Click <span class="strong strong"><strong>Review policy</strong></span>.
Name the policy: <code class="literal">TheSnapshotUserS3Policy</code>.
Click <span class="strong strong"><strong>Create policy</strong></span>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<p>Your AWS S3 bucket is set up, along with an IAM role, policy, and user to access it. The next steps are to take a snapshot of your current ES data.</p>
<h4><a id="ec-migrate-from-aws-es-part2"></a>Part 2 - Take a snapshot of your Elasticsearch data</h4>
<p>In this section we&#8217;ll take a snapshot to record the latest state of your AWS Elasticsearch indices.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Choose the instructions to use depending on your AWS Elasticsearch configuration. If your Elasticsearch cluster is not in a VPC and can be accessed directly, follow steps <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-2-1a">1a</a> and <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-2-1b">1b</a>. If your Elasticsearch cluster is in a VPC that you cannot access directly, follow steps <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-2-2a">2a</a> and <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-2-2b">2b</a></p>
</div>
</div>
<p><a id="ec-migrate-from-aws-es-2-1a"></a><span class="strong strong"><strong>1a. Register a snapshot repository using Postman</strong></span></p>
<p>Before running a manual snapshot, you need to register a snapshot repository with your deployment. This requires sending a signed request to your AWS ES domain.</p>
<p><span class="strong strong"><strong>If your Elasticsearch cluster is not in a VPC and can be accessed directly</strong></span>, you can execute a snapshot request manually by calling the Elasticsearch snapshot API. <a href="https://www.postman.com/" class="ulink" target="_top">Postman</a> is a great tool for managing and running API requests. We will use it here to simplify the signing of our AWS API requests.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Create a new Postman request.
</li>
<li class="listitem">
Under the <span class="strong strong"><strong>Authorization</strong></span> tab, in the <span class="strong strong"><strong>TYPE</strong></span> drop-down box, select <span class="strong strong"><strong>AWS Signature</strong></span>.
</li>
<li class="listitem">
Enter your <code class="literal">ACCESS_KEY</code>, <code class="literal">SECRET_KEY</code>, <code class="literal">AWS_REGION</code>, and <code class="literal">es</code> as the Service Name. Leave the <span class="strong strong"><strong>Session Token</strong></span> field blank.
</li>
<li class="listitem">
<p>Under the <span class="strong strong"><strong>Body</strong></span> tab, select <span class="strong strong"><strong>raw</strong></span> and set the format to <span class="strong strong"><strong>JSON</strong></span>.
Add the following payload, replacing the values for <code class="literal">S3_REGION_NAME</code>, <code class="literal">S3_BUCKET_NAME</code>, <code class="literal">ROLE_ARN</code>, <code class="literal">ES_ENDPOINT</code>, and <code class="literal">SNAPSHOT_REPO</code>:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{
        "type": "s3",
        "settings": {
                "region": S3_REGION_NAME,
                "bucket": S3_BUCKET_NAME,
                "role_arn": ROLE_ARN
        }
}</pre>
</div>
</li>
<li class="listitem">
<p>Set the request type to <code class="literal">PUT</code> and enter:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">https://ES_ENDPOINT/_snapshot/SNAPSHOT_REPO</pre>
</div>
<p>where:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">ES_ENDPOINT</code> is the Elasticsearch endpoint URL
</li>
<li class="listitem">
<code class="literal">SNAPSHOT_REPO</code> is a name of your choosing for the new repository.
</li>
</ul>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Send</strong></span>.
</li>
</ol>
</div>
<p>The snapshot repo for your S3 bucket will now be created.</p>
<p><a id="ec-migrate-from-aws-es-2-1b"></a><span class="strong strong"><strong>1b. Take a snapshot of your data</strong></span></p>
<p>We will take a snapshot of the your current ES data and store it in the newly registered repository.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Using Postman, create a new request.
</li>
<li class="listitem">
Under the <span class="strong strong"><strong>Authorization</strong></span> tab, in the <span class="strong strong"><strong>TYPE</strong></span> drop-down box, select <span class="strong strong"><strong>AWS Signature</strong></span>.
</li>
<li class="listitem">
Enter your <code class="literal">ACCESS_KEY</code>, <code class="literal">SECRET_KEY</code>, <code class="literal">AWS_REGION</code>, and <code class="literal">es</code> as the Service Name. Leave the <span class="strong strong"><strong>Session Token</strong></span> field blank.
</li>
<li class="listitem">
<p>Set the request type to <code class="literal">PUT</code> and enter:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">https://ES_ENDPOINT/_snapshot/SNAPSHOT_REPO/SNAPSHOT_NAME</pre>
</div>
<p>where:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">ES_ENDPOINT</code> is the Elasticsearch endpoint URL.
</li>
<li class="listitem">
<code class="literal">SNAPSHOT_REPO</code> is a name of the repository that you registered.
</li>
<li class="listitem">
<code class="literal">SNAPSHOT_NAME</code> is the name of the snapshot to create. The actual snapshot name must be lower-case.
</li>
</ul>
</div>
</li>
</ol>
</div>
<p>The time required to take a snapshot depends on the size of the AWS ES domain. According to AWS documentation, long-running snapshot operations sometimes show a <code class="literal">504 GATEWAY_TIMEOUT</code>. That documentation suggests that you can ignore this error and just wait for the snapshot to complete successfully.</p>
<p>You can check the status of your snapshot by calling:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">GET https://ES_ENDPOINT/_snapshot/SNAPSHOT_REPO/SNAPSHOT_NAME?pretty</pre>
</div>
<p>Once you&#8217;ve taken a snapshot successfully, you can skip ahead to <a class="xref" href="ec-migrate-from-aws.html#ec-migrate-from-aws-es-part3" title="Part 3 - Restore your snapshot to a new deployment">Part 3</a>.</p>
<p><a id="ec-migrate-from-aws-es-2-2a"></a><span class="strong strong"><strong>2a. Configure the Python AWS SDK</strong></span></p>
<p>Before running a manual snapshot, you need to register a snapshot repository with your deployment. This requires sending a signed request to your AWS ES cluster.</p>
<p><span class="strong strong"><strong>If your Elasticsearch cluster is in a VPC that you cannot access directly</strong></span>, you will need access to a host, such as EC2, that is within your VPC and that can execute the scripts that follow. In these steps and examples we use the Python AWS SDK, but you can use any language that has an AWS SDK (for example, Java, Ruby, Go, or others).</p>
<p>We’ll install the Python AWS SDK using Python’s package installer PIP (<em>pip3</em>). This requires Python version 3 to be installed. If you don’t have Python version 3 installed, you can get it by just installing <em>pip3</em>. Your operating system’s package manager will install Python version 3 automatically, since it’s a dependency to <em>pip3</em>. If you get stuck, refer to the <a href="https://docs.aws.amazon.com/cli/latest/userguide/install-linux-python.html" class="ulink" target="_top">Python installation documentation</a>.</p>
<p><span class="strong strong"><strong>Install pip3</strong></span></p>
<p>To install <code class="literal">pip3</code> on <span class="strong strong"><strong>Red Hat and derivatives</strong></span>, use <code class="literal">yum</code>:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ sudo yum -y install python3-pip</pre>
</div>
<p>Alternatively, some Fedora distributions label the <code class="literal">pip3</code> package differently:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ sudo yum -y install python36-pip</pre>
</div>
<p>In case neither of the previous Python package install commands work, you can search for the correct package name:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">yum search pip</pre>
</div>
<p>On <span class="strong strong"><strong>Debian derivatives such as Ubuntu</strong></span>, use <code class="literal">apt-get</code>:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">sudo apt-get -y install python3-pip</pre>
</div>
<p><span class="strong strong"><strong>Install the Python AWS SDK</strong></span></p>
<p>Once <code class="literal">pip3</code> is installed, you can install the Python AWS SDK, named <code class="literal">boto3</code>:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ pip3 install --user boto3 requests_aws4auth
Collecting boto3
...
Successfully installed boto3-1.9.106 requests-aws4auth-0.9 ...</pre>
</div>
<p>Note that <code class="literal">root</code> access is not needed if you specify the <code class="literal">--user</code> flag.</p>
<p>Create an <code class="literal">~/.aws</code> directory to hold your AWS credentials. Run the following command to create the directory:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ mkdir ~/.aws</pre>
</div>
<p>Create a file called <code class="literal">credentials</code> with your favorite editor. We’ll use <code class="literal">nano</code> for simplicity:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ nano ~/.aws/credentials</pre>
</div>
<p>Copy and paste the following contents into the file, replacing <code class="literal">ACCESS_KEY</code> and <code class="literal">SECRET_KEY</code> with the actual values:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">[default]
aws_access_key_id = ACCESS_KEY
aws_secret_access_key = SECRET_KEY</pre>
</div>
<p>Type <code class="literal">Control</code> + <code class="literal">X</code> to exit nano, and follow the prompts to save the file.</p>
<p>In the next steps, we’ll write a few Python scripts to perform the tasks we need.</p>
<p><a id="ec-migrate-from-aws-es-2-2b"></a><span class="strong strong"><strong>2b. Manually snapshot AWS ES</strong></span></p>
<p>Let’s run a quick test using a Python script to list the indices in our AWS ES cluster. This will ensure that our AWS credentials are working and prove that we can access the cluster.</p>
<p>Create a file called <code class="literal">indices.py</code> with your favorite editor. We’ll use <code class="literal">nano</code> for simplicity:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ nano indices.py</pre>
</div>
<p>Copy and paste the following contents, replacing <code class="literal">ES_ENDPOINT</code> and <code class="literal">ES_REGION</code> with your values:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">import boto3, requests
from requests_aws4auth import AWS4Auth
host = 'ES_ENDPOINT'
region = 'ES_REGION'
creds = boto3.Session().get_credentials()
auth = AWS4Auth(creds.access_key, creds.secret_key, region, 'es', session_token=creds.token)
print("Listing Indices from AWS ES ...")
req = requests.get(host + '/_cat/indices?v', auth=auth)
print("HTTP Response Code: " + str(req.status_code) + '\n' + req.text)</pre>
</div>
<p>Type <code class="literal">Control</code> + <code class="literal">X</code> to exit nano, and follow the prompts to save the file.</p>
<p>Run the Python script.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ python3 indices.py</pre>
</div>
<p>Your output should look similar to the following:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Listing Indices from AWS ES ...
HTTP Response Code: 200
health status index     uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   testindex yME2BphgR3Gt1ln6n03nHQ   5   1          1            0      4.4kb          4.4kb</pre>
</div>
<p>Now create a file called <code class="literal">register.py</code> with your favorite editor.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ nano register.py</pre>
</div>
<p>Copy and paste the following contents, replacing <code class="literal">ES_ENDPOINT</code>, <code class="literal">ES_REGION</code>, <code class="literal">SNAPSHOT_REPO</code>, <code class="literal">SNAPSHOT_NAME</code>, <code class="literal">S3_REGION_NAME</code>, <code class="literal">S3_BUCKET_NAME</code>, and <code class="literal">ROLE_ARN</code> with your values:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">import boto3, requests
from requests_aws4auth import AWS4Auth
host = 'ES_ENDPOINT'
region = 'ES_REGION'
repo_name = 'SNAPSHOT_REPO'
snapshot_name = 'SNAPSHOT_NAME'
s3_region_name = 'S3_REGION_NAME'
s3_bucket_name = 'S3_BUCKET_NAME'
role_arn = 'ROLE_ARN'
creds = boto3.Session().get_credentials()
auth = AWS4Auth(creds.access_key, creds.secret_key, region, 'es', session_token=creds.token)
headers = {"Content-Type": "application/json"}
payload = {
        "type": "s3",
        "settings": {
                "region": s3_region_name,
                "bucket": s3_bucket_name,
                "role_arn": role_arn
        }
}
print("Registering Snapshot with AWS ES ...")
url = host + '/_snapshot/' + repo_name
req = requests.put(url, auth=auth, json=payload, headers=headers)
print("HTTP Response Code: " + str(req.status_code) + '\n' + req.text)</pre>
</div>
<p>Type <code class="literal">Control</code> + <code class="literal">X</code> to exit nano, and follow the prompts to save the file.</p>
<p>Run the Python script.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ python3 register.py</pre>
</div>
<p>Your output should look similar to the following:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Registering Snapshot with AWS ES ...
HTTP Response Code: 200
{"acknowledged":true}</pre>
</div>
<p>Next, create a file called <code class="literal">snapshot.py</code> with your favorite editor.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ nano snapshot.py</pre>
</div>
<p>Copy and paste the following contents, replacing <code class="literal">ES_ENDPOINT</code>, <code class="literal">ES_REGION</code>, <code class="literal">SNAPSHOT_REPO</code>, and <code class="literal">SNAPSHOT_NAME</code> with your values:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">import boto3, requests
from requests_aws4auth import AWS4Auth
host = 'ES_ENDPOINT'
region = 'ES_REGION'
repo_name = 'SNAPSHOT_REPO'
snapshot_name = 'SNAPSHOT_NAME'
creds = boto3.Session().get_credentials()
auth = AWS4Auth(creds.access_key, creds.secret_key, region, 'es', session_token=creds.token)
print("Starting Snapshot with AWS ES ...")
url = host + '/_snapshot/' + repo_name + '/' + snapshot_name
req = requests.put(url, auth=auth)
print("HTTP Response Code: " + str(req.status_code) + '\n' + req.text)</pre>
</div>
<p>Type <code class="literal">Control</code> + <code class="literal">X</code> to exit nano, and follow the prompts to save the file.</p>
<p>Run the Python script.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ python3 snapshot.py</pre>
</div>
<p>Your output should look similar to the following:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Starting Snapshot with AWS ES ...
HTTP Response Code: 200
{"accepted":true}</pre>
</div>
<p>The time required to take a snapshot depends on the size of the AWS ES domain. According to AWS documentation, long-running snapshot operations sometimes show a <code class="literal">504 GATEWAY_TIMEOUT</code>. That documentation suggests that you can ignore this error and just wait for the snapshot to complete successfully.</p>
<p>Finally, let’s check the status of our snapshot. Create a file called <code class="literal">status.py</code>.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ nano status.py</pre>
</div>
<p>Copy and paste the following contents, replacing <code class="literal">ES_ENDPOINT</code>, <code class="literal">ES_REGION</code>, <code class="literal">SNAPSHOT_REPO</code>, and <code class="literal">SNAPSHOT_NAME</code> with your values:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">import boto3, requests
from requests_aws4auth import AWS4Auth
host = 'ES_ENDPOINT'
region = 'ES_REGION'
repo_name = 'SNAPSHOT_REPO'
snapshot_name = 'SNAPSHOT_NAME'
creds = boto3.Session().get_credentials()
auth = AWS4Auth(creds.access_key, creds.secret_key, region, 'es', session_token=creds.token)
print("Getting Status of Snapshot with AWS ES ...")
url = host + '/_snapshot/' + repo_name + '/' + snapshot_name + '?pretty'
req = requests.get(url, auth=auth)
print("HTTP Response Code: " + str(req.status_code) + '\n' + req.text)</pre>
</div>
<p>Type <code class="literal">Control</code> + <code class="literal">X</code> to exit nano, and follow the prompts to save the file.</p>
<p>Run the Python script.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ python3 status.py</pre>
</div>
<p>Your output should look similar to the following:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Getting Status of Snapshot with AWS ES ...
HTTP Response Code: 200
{
  "snapshots" : [ {
    "snapshot" : "my-snapshot",
    "uuid" : "ClYKt5g8QFO6r3kTCEzjqw",
    "version_id" : 6040299,
    "version" : "6.4.2",
    "indices" : [ "testindex" ],
    "include_global_state" : true,
    "state" : "SUCCESS",
    "start_time" : "2019-03-03T14:46:04.094Z",
    "start_time_in_millis" : 1551624364094,
    "end_time" : "2019-03-03T14:46:04.847Z",
    "end_time_in_millis" : 1551624364847,
    "duration_in_millis" : 753,
    "failures" : [ ],
    "shards" : {
      "total" : 5,
      "failed" : 0,
      "successful" : 5
    }
  } ]
}</pre>
</div>
<p>If you see <code class="literal">"state":"SUCCESS"</code> then you have successfully taken a snapshot to S3 and are ready for Part 3!</p>
<h4><a id="ec-migrate-from-aws-es-part3"></a>Part 3 - Restore your snapshot to a new deployment</h4>
<p><a id="ec-migrate-from-aws-es-3-1"></a><span class="strong strong"><strong>1. Create a deployment in Elasticsearch Service</strong></span>
Navigate to <a href="http://cloud.elastic.co" class="ulink" target="_top">Elastic Cloud</a> and register for an account to gain access to the 14-day free trial. Once you’ve logged in, follow the instructions to create a deployment in AWS, Google Cloud, or Microsoft Azure.</p>
<p>For detailed instructions and descriptions of all of the options, see <a class="xref" href="ec-create-deployment.html" title="Create your deployment">Create your deployment</a>.</p>
<p><a id="ec-migrate-from-aws-es-3-2"></a><span class="strong strong"><strong>2. Add your secrets to the keystore</strong></span></p>
<p>Once your deployment is ready, store your <code class="literal">ACCESS_KEY</code> and <code class="literal">SECRET_KEY</code> in the Keystore.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Navigate to the <span class="strong strong"><strong>Security</strong></span> page of your new deployment.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create settings</strong></span>.
</li>
<li class="listitem">
<p>With <span class="strong strong"><strong>Type</strong></span> set to <span class="strong strong"><strong>Single string</strong></span>, add the following keys and their values:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">s3.client.default.access_key</code>
</li>
<li class="listitem">
<code class="literal">s3.client.default.secret_key</code>
</li>
</ul>
</div>
</li>
</ol>
</div>
<p><a id="ec-migrate-from-aws-es-3-3"></a><span class="strong strong"><strong>3. Register your snapshot repository in your new deployment</strong></span></p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>To follow this step your deployment must be at Elastic Stack version 7.2 or higher. If you are using an earlier deployment version, see our more detailed instructions for <a class="xref" href="ec-aws-custom-repository.html#ec-create-aws-repository" title="Create the repository">configuring a snapshot repository using AWS</a>.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In your same deployment in Elasticsearch Service, open Kibana and go to <span class="strong strong"><strong>Management</strong></span> &gt; <span class="strong strong"><strong>Snapshot and Restore</strong></span>.
</li>
<li class="listitem">
On the <span class="strong strong"><strong>Repositories</strong></span> tab, click <span class="strong strong"><strong>Register a repository</strong></span>.
</li>
<li class="listitem">
Provide a name for for your repository and select type <span class="strong strong"><strong>AWS S3</strong></span>.
</li>
<li class="listitem">
<p>Provide the following settings:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Client: <code class="literal">default</code>
</li>
<li class="listitem">
Bucket: <code class="literal">YOUR_S3_BUCKET_NAME</code>
</li>
</ul>
</div>
</li>
<li class="listitem">
Add any other settings that you wish to configure.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Register</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Verify</strong></span> to confirm that your settings are correct and the deployment can connect to your repository.
</li>
</ol>
</div>
<p><a id="ec-migrate-from-aws-es-3-4"></a><span class="strong strong"><strong>4. Restore from your new snapshot repository</strong></span></p>
<p>Still on the <span class="strong strong"><strong>Snapshot and Restore</strong></span> page in Kibana:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click the <span class="strong strong"><strong>Snapshots</strong></span> tab.
</li>
<li class="listitem">
Search for the snapshot that you created earlier.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Restore</strong></span>.
</li>
<li class="listitem">
Select the indices you wish to restore.
</li>
<li class="listitem">
Configure any other relevant settings.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Restore snapshot</strong></span> to begin the process.
</li>
</ol>
</div>
<p>The time required to restore from a snapshot varies based on the size of your data.</p>
<p><a id="ec-migrate-from-aws-es-3-5"></a><span class="strong strong"><strong>5. Explore Elasticsearch Service</strong></span></p>
<p>Now that you are up and running with your own data, explore the power of the latest version of the Elastic Stack by trying: SIEM, Lens, Machine Learning, APM, Maps, Index Lifecycle Management, Snapshot Lifecycle Management, Logs, Metrics, Monitoring, Canvas, Uptime, and more!</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="ec-migrate-data.html">« Migrating your Elasticsearch data</a>
</span>
<span class="next">
<a href="ec-migrate-data-internal.html">Migrating internal indices »</a>
</span>
</div>
</div>
</body>
</html>
