<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Installing in an air-gapped environment | Elastic Installation and Upgrade Guide [8.15] | Elastic</title>
<meta class="elastic" name="content" content="Installing in an air-gapped environment | Elastic Installation and Upgrade Guide [8.15]">

<link rel="home" href="index.html" title="Elastic Installation and Upgrade Guide [8.15]"/>
<link rel="up" href="index.html" title="Elastic Installation and Upgrade Guide [8.15]"/>
<link rel="prev" href="install-stack-demo-secure.html" title="Tutorial 2: Securing a self-managed Elastic Stack"/>
<link rel="next" href="upgrading-elastic-stack.html" title="Upgrade to Elastic 8.15.0"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Elastic Stack"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elastic Stack/Installation and Upgrade/8.15"/>
<meta name="DC.subject" content="Elastic Stack"/>
<meta name="DC.identifier" content="8.15"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="install-stack-demo-secure.html">« Tutorial 2: Securing a self-managed Elastic Stack</a>
</span>
<span class="next">
<a href="upgrading-elastic-stack.html">Upgrade to Elastic 8.15.0 »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Installation and Upgrade Guide [8.15]</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Installing in an air-gapped environment</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="chapter">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="air-gapped-install"></a>Installing in an air-gapped environment</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
</div></div></div>
<p>Some components of the Elastic Stack require additional configuration and local dependencies in order to deploy in environments without internet access. This guide gives an overview of this setup scenario and helps bridge together existing documentation for individual parts of the stack.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p><a class="xref" href="air-gapped-install.html#air-gapped-self-managed-linux" title="1. Self-Managed Install (Linux)">1. Self-Managed Install (Linux)</a></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-elasticsearch" title="1.1. Elasticsearch">1.1. Elasticsearch</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-kibana" title="1.2. Kibana">1.2. Kibana</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-beats" title="1.3. Beats">1.3. Beats</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-logstash" title="1.4. Logstash">1.4. Logstash</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-elastic-agent" title="1.5. Elastic Agent">1.5. Elastic Agent</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-fleet" title="1.6. Fleet Server">1.6. Fleet Server</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-elastic-apm" title="1.7. Elastic APM">1.7. Elastic APM</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-elastic-maps-service" title="1.8. Elastic Maps Service">1.8. Elastic Maps Service</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-enterprise-search" title="1.9. Enterprise Search">1.9. Enterprise Search</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-elastic-package-registry" title="1.10. Elastic Package Registry">1.10. Elastic Package Registry</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-elastic-artifact-registry" title="1.11. Elastic Artifact Registry">1.11. Elastic Artifact Registry</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-elastic-endpoint-artifact-repository" title="1.12. Elastic Endpoint Artifact Repository">1.12. Elastic Endpoint Artifact Repository</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-machine-learning" title="1.13 Machine learning">1.13 Machine learning</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p><a class="xref" href="air-gapped-install.html#air-gapped-kubernetes-and-openshift" title="2. Kubernetes &amp; OpenShift Install">2. Kubernetes &amp; OpenShift Install</a></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-k8s-os-elastic-kubernetes-operator" title="2.1. Elastic Kubernetes Operator (ECK)">2.1. Elastic Kubernetes Operator (ECK)</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-k8s-os-elastic-package-registry" title="2.2. Elastic Package Registry">2.2. Elastic Package Registry</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-k8s-os-elastic-artifact-registry" title="2.3. Elastic Artifact Registry">2.3. Elastic Artifact Registry</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-k8s-os-elastic-endpoint-artifact-repository" title="2.4. Elastic Endpoint Artifact Repository">2.4. Elastic Endpoint Artifact Repository</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-k8s-os-ironbank-secure-images" title="2.5. Ironbank Secure Images for Elastic">2.5. Ironbank Secure Images for Elastic</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-ece" title="3.0 Elastic Cloud Enterprise">3.0 Elastic Cloud Enterprise</a>
</li>
</ul>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-elastic-package-registry-example" title="Appendix A - Elastic Package Registry">Appendix A - Elastic Package Registry</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-elastic-artifact-registry-example" title="Appendix B - Elastic Artifact Registry">Appendix B - Elastic Artifact Registry</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-epr-kubernetes-example" title="Appendix C - EPR Kubernetes Deployment">Appendix C - EPR Kubernetes Deployment</a>
</li>
<li class="listitem">
<p><a class="xref" href="air-gapped-install.html#air-gapped-agent-integration-guide" title="Appendix D - Agent Integration Guide">Appendix D - Agent Integration Guide</a></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-agent-integration-terminology" title="D.1. Terminology">D.1. Terminology</a>
</li>
<li class="listitem">
<p><a class="xref" href="air-gapped-install.html#air-gapped-agent-integration-configure" title="D.2. How to configure">D.2. How to configure</a></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-agent-integration-configure-kibana" title="D.2.1. Using the Kibana UI">D.2.1. Using the Kibana UI</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-agent-integration-configure-yml" title="D.2.2. Using the kibana.yml config file">D.2.2. Using the <code class="literal">kibana.yml</code> config file</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-agent-integration-configure-fleet-api" title="D.2.3. Using the Kibana Fleet API">D.2.3. Using the Kibana Fleet API</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you&#8217;re working in an air-gapped environment and have a subscription level that includes Support coverage, <a href="/contact" class="ulink" target="_top">contact us</a> if you&#8217;d like to request an offline version of the Elastic documentation.</p>
</div>
</div>
<div class="position-relative"><h3><a id="air-gapped-self-managed-linux"></a>1. Self-Managed Install (Linux)</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Refer to the section for each Elastic component for air-gapped installation configuration and dependencies in a self-managed Linux environment.</p>
<div class="position-relative"><h4><a id="air-gapped-elasticsearch"></a>1.1. Elasticsearch</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Air-gapped install of Elasticsearch may require additional steps in order to access some of the features. General install and configuration guides are available in the <a href="/guide/en/elasticsearch/reference/8.15/install-elasticsearch.html" class="ulink" target="_top">Elasticsearch install documentation</a>.</p>
<p>Specifically:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
To be able to use the GeoIP processor, refer to <a href="/guide/en/elasticsearch/reference/8.15/geoip-processor.html#manually-update-geoip-databases" class="ulink" target="_top">the GeoIP processor documentation</a> for instructions on downloading and deploying the required databases.
</li>
<li class="listitem">
Refer to <a class="xref" href="air-gapped-install.html#air-gapped-machine-learning" title="1.13 Machine learning">Machine learning</a> for instructions on deploying the Elastic Learned Sparse EncodeR (ELSER) natural language processing (NLP) model and other trained machine learning models.
</li>
</ul>
</div>
<div class="position-relative"><h4><a id="air-gapped-kibana"></a>1.2. Kibana</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Air-gapped install of Kibana may require a number of additional services in the local network in order to access some of the features. General install and configuration guides are available in the <a href="/guide/en/kibana/8.15/install.html" class="ulink" target="_top">Kibana install documentation</a>.</p>
<p>Specifically:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
To be able to use Kibana mapping visualizations, you need to set up and configure the <a class="xref" href="air-gapped-install.html#air-gapped-elastic-maps-service" title="1.8. Elastic Maps Service">Elastic Maps Service</a>.
</li>
<li class="listitem">
To be able to use Kibana sample data, install or update hundreds of prebuilt alert rules, and explore available data integrations, you need to set up and configure the <a class="xref" href="air-gapped-install.html#air-gapped-elastic-package-registry" title="1.10. Elastic Package Registry">Elastic Package Registry</a>.
</li>
<li class="listitem">
To provide detection rule updates for Endpoint Security agents, you need to set up and configure the <a class="xref" href="air-gapped-install.html#air-gapped-elastic-endpoint-artifact-repository" title="1.12. Elastic Endpoint Artifact Repository">Elastic Endpoint Artifact Repository</a>.
</li>
<li class="listitem">
To access Enterprise Search capabilities (in addition to the general search capabilities of Elasticsearch), you need to set up and configure <a class="xref" href="air-gapped-install.html#air-gapped-enterprise-search" title="1.9. Enterprise Search">Enterprise Search</a>.
</li>
<li class="listitem">
To access the APM integration, you need to set up and configure <a class="xref" href="air-gapped-install.html#air-gapped-elastic-apm" title="1.7. Elastic APM">Elastic APM</a>.
</li>
</ul>
</div>
<div class="position-relative"><h4><a id="air-gapped-beats"></a>1.3. Beats</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Elastic Beats are light-weight data shippers. They do not require any unique setup in the air-gapped scenario. To learn more, refer to the <a href="/guide/en/beats/libbeat/8.15/beats-reference.html" class="ulink" target="_top">Beats documentation</a>.</p>
<div class="position-relative"><h4><a id="air-gapped-logstash"></a>1.4. Logstash</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Logstash is a versatile data shipping and processing application. It does not require any unique setup in the air-gapped scenario. To learn more, refer to the <a href="/guide/en/logstash/8.15/introduction.html" class="ulink" target="_top">Logstash documentation</a>.</p>
<div class="position-relative"><h4><a id="air-gapped-elastic-agent"></a>1.5. Elastic Agent</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Air-gapped install of Elastic Agent depends on the <a class="xref" href="air-gapped-install.html#air-gapped-elastic-package-registry" title="1.10. Elastic Package Registry">Elastic Package Registry</a> and the <a class="xref" href="air-gapped-install.html#air-gapped-elastic-artifact-registry" title="1.11. Elastic Artifact Registry">Elastic Artifact Registry</a> for most use-cases. The agent itself is fairly lightweight and installs dependencies only as required by its configuration. In terms of connections to these dependencies, Elastic Agents need to be able to connect to the Elastic Artifact Registry directly, but Elastic Package Registry connections are handled through <a class="xref" href="air-gapped-install.html#air-gapped-kibana" title="1.2. Kibana">Kibana</a>.</p>
<p>Additionally, if the Elastic Agent Elastic Defend integration is used, then access to the <a class="xref" href="air-gapped-install.html#air-gapped-elastic-endpoint-artifact-repository" title="1.12. Elastic Endpoint Artifact Repository">Elastic Endpoint Artifact Repository</a> is necessary in order to deploy updates for some of the detection and prevention capabilities.</p>
<p>To learn more about install and configuration, refer to the <a href="/guide/en/fleet/8.15/elastic-agent-installation.html" class="ulink" target="_top">Elastic Agent install documentation</a>. Make sure to check the requirements specific to running Elastic Agents in an <a href="/guide/en/fleet/8.15/air-gapped.html" class="ulink" target="_top">air-gapped environment</a>.</p>
<p>To get a better understanding of how to work with Elastic Agent configuration settings and policies, refer to <a class="xref" href="air-gapped-install.html#air-gapped-agent-integration-guide" title="Appendix D - Agent Integration Guide">Appendix D - Agent Integration Guide</a>.</p>
<div class="position-relative"><h4><a id="air-gapped-fleet"></a>1.6. Fleet Server</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Fleet Server is a required middleware component for any scalable deployment of the Elastic Agent. The air-gapped dependencies of Fleet Server are the same as those of the <a class="xref" href="air-gapped-install.html#air-gapped-elastic-agent" title="1.5. Elastic Agent">Elastic Agent</a>.</p>
<p>To learn more about installing Fleet Server, refer to the <a href="/guide/en/fleet/8.15/fleet-server.html" class="ulink" target="_top">Fleet Server set up documentation</a>.</p>
<div class="position-relative"><h4><a id="air-gapped-elastic-apm"></a>1.7. Elastic APM</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Air-gapped setup of the APM server is possible in two ways:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
By setting up one of the Elastic Agent deployments with an APM integration, as described in <a href="/guide/en/apm/guide/8.15/apm-integration-upgrade-steps.html" class="ulink" target="_top">Switch a self-installation to the APM integration</a>.
</li>
<li class="listitem">
Or, by installing a standalone Elastic APM Server, as described in the <a href="/guide/en/apm/guide/8.15/configuring-howto-apm-server.html" class="ulink" target="_top">APM configuration documentation</a>.
</li>
</ul>
</div>
<div class="position-relative"><h4><a id="air-gapped-elastic-maps-service"></a>1.8. Elastic Maps Service</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Refer to <a href="/guide/en/kibana/8.15/maps-connect-to-ems.html" class="ulink" target="_top">Connect to Elastic Maps Service</a> in the Kibana documentation to learn how to configure your firewall to connect to Elastic Maps Service, host it locally, or disable it completely.</p>
<div class="position-relative"><h4><a id="air-gapped-enterprise-search"></a>1.9. Enterprise Search</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Detailed install and configuration instructions are available in the <a href="/guide/en/enterprise-search/8.15/installation.html" class="ulink" target="_top">Enterprise Search install documentation</a>.</p>
<div class="position-relative"><h4><a id="air-gapped-elastic-package-registry"></a>1.10. Elastic Package Registry</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Air-gapped install of the EPR is possible using any OCI-compatible runtime like Podman (a typical choice for RHEL-like Linux systems) or Docker. Links to the official container image and usage guide is available on the <a href="/guide/en/fleet/8.15/air-gapped.html" class="ulink" target="_top">Air-gapped environments</a> page in the Fleet and Elastic Agent Guide.</p>
<p>Refer to <a class="xref" href="air-gapped-install.html#air-gapped-elastic-package-registry-example" title="Appendix A - Elastic Package Registry">Appendix A - Elastic Package Registry</a> for additional setup examples.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Besides setting up the EPR service, you also need to <a class="xref" href="air-gapped-install.html#air-gapped-kibana" title="1.2. Kibana">configure Kibana</a> to use this service. If using TLS with the EPR service, it is also necessary to set up Kibana to trust the certificate presented by the EPR.</p>
</div>
</div>
<div class="position-relative"><h4><a id="air-gapped-elastic-artifact-registry"></a>1.11. Elastic Artifact Registry</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Air-gapped install of the Elastic Artifact Registry is necessary in order to enable Elastic Agent deployments to perform self-upgrades and install certain components which are needed for some of the data integrations (that is, in addition to what is also retrieved from the EPR). To learn more, refer to <a href="/guide/en/fleet/8.15/air-gapped.html#host-artifact-registry" class="ulink" target="_top">Host your own artifact registry for binary downloads</a> in the Fleet and Elastic Agent Guide.</p>
<p>Refer to <a class="xref" href="air-gapped-install.html#air-gapped-elastic-artifact-registry-example" title="Appendix B - Elastic Artifact Registry">Appendix B - Elastic Artifact Registry</a> for additional setup examples.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When setting up own web server, such as NGINX, to function as the Elastic Artifact Registry, it is recommended not to use TLS as there are, currently, no direct ways to establish certificate trust between Elastic Agents and this service.</p>
</div>
</div>
<div class="position-relative"><h4><a id="air-gapped-elastic-endpoint-artifact-repository"></a>1.12. Elastic Endpoint Artifact Repository</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Air-gapped setup of this component is, essentially, identical to the setup of the <a class="xref" href="air-gapped-install.html#air-gapped-elastic-artifact-registry" title="1.11. Elastic Artifact Registry">Elastic Artifact Registry</a> except that different artifacts are served. To learn more, refer to <a href="/guide/en/security/8.15/offline-endpoint.html" class="ulink" target="_top">Configure offline endpoints and air-gapped environments</a> in the Elastic Security guide.</p>
<div class="position-relative"><h4><a id="air-gapped-machine-learning"></a>1.13 Machine learning</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Some machine learning features, like natural language processing (NLP), require you to deploy trained models. To learn about deploying machine learning models in an air-gapped environment, refer to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="/guide/en/machine-learning/8.15/ml-nlp-elser.html#air-gapped-install" class="ulink" target="_top">Deploy ELSER in an air-gapped environment</a>.
</li>
<li class="listitem">
<a href="/guide/en/elasticsearch/client/eland/current/machine-learning.html#ml-nlp-pytorch-air-gapped" class="ulink" target="_top">Install trained models in an air-gapped environment with Eland</a>.
</li>
</ul>
</div>
<div class="position-relative"><h3><a id="air-gapped-kubernetes-and-openshift"></a>2. Kubernetes &amp; OpenShift Install</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Setting up air-gapped Kubernetes or OpenShift installs of the Elastic Stack has some unique concerns, but the general dependencies are the same as in the self-managed install case on a regular Linux machine.</p>
<div class="position-relative"><h4><a id="air-gapped-k8s-os-elastic-kubernetes-operator"></a>2.1. Elastic Kubernetes Operator (ECK)</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>The Elastic Kubernetes operator is an additional component in the Kubernetes OpenShift install that, essentially, does a lot of the work in installing, configuring, and updating deployments of the Elastic Stack. For details, refer to the <a href="/guide/en/cloud-on-k8s/current/k8s-air-gapped.html" class="ulink" target="_top">Elastic Cloud on Kubernetes install instructions</a>.</p>
<p>The main requirements are:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Syncing container images for ECK and all other Elastic Stack components over to a locally-accessible container repository.
</li>
<li class="listitem">
Modifying the ECK helm chart configuration so that ECK is aware that it is supposed to use your offline container repository instead of the public Elastic repository.
</li>
<li class="listitem">
Optionally, disabling ECK telemetry collection in the ECK helm chart. This configuration propagates to all other Elastic components, such as Kibana.
</li>
<li class="listitem">
Building your custom deployment container image for the Elastic Artifact Registry.
</li>
<li class="listitem">
Building your custom deployment container image for the Elastic Endpoint Artifact Repository.
</li>
</ul>
</div>
<div class="position-relative"><h4><a id="air-gapped-k8s-os-elastic-package-registry"></a>2.2. Elastic Package Registry</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>The container image can be downloaded from the official Elastic Docker repository, as described in the Fleet and Elastic Agent <a href="/guide/en/fleet/8.15/air-gapped.html" class="ulink" target="_top">air-gapped environments</a> documentation.</p>
<p>This container would, ideally, run as a Kubernetes deployment. Refer to <a class="xref" href="air-gapped-install.html#air-gapped-epr-kubernetes-example" title="Appendix C - EPR Kubernetes Deployment">Appendix C - EPR Kubernetes Deployment</a> for examples.</p>
<div class="position-relative"><h4><a id="air-gapped-k8s-os-elastic-artifact-registry"></a>2.3. Elastic Artifact Registry</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>A custom container would need to be created following similar instructions to setting up a web server in the <a class="xref" href="air-gapped-install.html#air-gapped-elastic-artifact-registry" title="1.11. Elastic Artifact Registry">self-managed install case</a>. For example, a container file using an NGINX base image could be used to run a build similar to the example described in <a class="xref" href="air-gapped-install.html#air-gapped-elastic-artifact-registry-example" title="Appendix B - Elastic Artifact Registry">Appendix B - Elastic Artifact Registry</a>.</p>
<div class="position-relative"><h4><a id="air-gapped-k8s-os-elastic-endpoint-artifact-repository"></a>2.4. Elastic Endpoint Artifact Repository</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Just like the Elastic Artifact Registry. A custom container needs to be created following similar instructions to setting up a web server for the <a class="xref" href="air-gapped-install.html#air-gapped-elastic-artifact-registry" title="1.11. Elastic Artifact Registry">self-managed install case</a>.</p>
<div class="position-relative"><h4><a id="air-gapped-k8s-os-ironbank-secure-images"></a>2.5. Ironbank Secure Images for Elastic</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Besides the public <a href="https://www.docker.elastic.co" class="ulink" target="_top">Elastic container repository</a>, most Elastic Stack container images are also available in Platform One&#8217;s <a href="https://ironbank.dso.mil/repomap?vendorFilters=Elastic&amp;page=1&amp;sort=1" class="ulink" target="_top">Iron Bank</a>.</p>
<div class="position-relative"><h4><a id="air-gapped-ece"></a>3.0 Elastic Cloud Enterprise</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>To install Elastic Cloud Enterprise in an air-gapped environment you&#8217;ll need to host your own <a class="xref" href="air-gapped-install.html#air-gapped-elastic-package-registry" title="1.10. Elastic Package Registry">1.10. Elastic Package Registry</a>. Refer to the <a href="/guide/en/cloud-enterprise/current/ece-install-offline.html" class="ulink" target="_top">ECE offline install instructions</a> for details.</p>
<div class="position-relative"><h3><a id="air-gapped-elastic-package-registry-example"></a>Appendix A - Elastic Package Registry</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>The following script generates a SystemD service file on a RHEL 8 system in order to run EPR with Podman in a production environment.</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">#!/usr/bin/env bash

EPR_BIND_ADDRESS="0.0.0.0"
EPR_BIND_PORT="8443"
EPR_TLS_CERT="/etc/elastic/epr/epr.pem"
EPR_TLS_KEY="/etc/elastic/epr/epr-key.pem"
EPR_IMAGE="docker.elastic.co/package-registry/distribution:8.15.0"

podman create \
  --name "elastic-epr" \
  -p "$EPR_BIND_ADDRESS:$EPR_BIND_PORT:$EPR_BIND_PORT" \
  -v "$EPR_TLS_CERT:/etc/ssl/epr.crt:ro" \
  -v "$EPR_TLS_KEY:/etc/ssl/epr.key:ro" \
  -e "EPR_ADDRESS=0.0.0.0:$EPR_BIND_PORT" \
  -e "EPR_TLS_CERT=/etc/ssl/epr.crt" \
  -e "EPR_TLS_KEY=/etc/ssl/epr.key" \
  "$EPR_IMAGE"

## creates service file in the root directory
# podman generate systemd --new --files --name elastic-epr --restart-policy always</pre>
</div>
<p>The following is an example of an actual SystemD service file for an EPR, launched as a Podman service.</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell"># container-elastic-epr.service
# autogenerated by Podman 4.1.1
# Wed Oct 19 13:12:33 UTC 2022

[Unit]
Description=Podman container-elastic-epr.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=always
TimeoutStopSec=70
ExecStartPre=/bin/rm -f %t/%n.ctr-id
ExecStart=/usr/bin/podman run \
	--cidfile=%t/%n.ctr-id \
	--cgroups=no-conmon \
	--rm \
	--sdnotify=conmon \
	-d \
	--replace \
	--name elastic-epr \
	-p 0.0.0.0:8443:8443 \
	-v /etc/elastic/epr/epr.pem:/etc/ssl/epr.crt:ro \
	-v /etc/elastic/epr/epr-key.pem:/etc/ssl/epr.key:ro \
	-e EPR_ADDRESS=0.0.0.0:8443 \
	-e EPR_TLS_CERT=/etc/ssl/epr.crt \
	-e EPR_TLS_KEY=/etc/ssl/epr.key docker.elastic.co/package-registry/distribution:8.15.0
ExecStop=/usr/bin/podman stop --ignore --cidfile=%t/%n.ctr-id
ExecStopPost=/usr/bin/podman rm -f --ignore --cidfile=%t/%n.ctr-id
Type=notify
NotifyAccess=all

[Install]
WantedBy=default.target</pre>
</div>
<div class="position-relative"><h3><a id="air-gapped-elastic-artifact-registry-example"></a>Appendix B - Elastic Artifact Registry</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>The following example script downloads artifacts from the internet to be later served as a private Elastic Package Registry.</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">#!/usr/bin/env bash
set -o nounset -o errexit -o pipefail

STACK_VERSION=8.15.0
ARTIFACT_DOWNLOADS_BASE_URL=https://artifacts.elastic.co/downloads

DOWNLOAD_BASE_DIR=${DOWNLOAD_BASE_DIR:?"Make sure to set DOWNLOAD_BASE_DIR when running this script"}

COMMON_PACKAGE_PREFIXES="apm-server/apm-server beats/auditbeat/auditbeat beats/elastic-agent/elastic-agent beats/filebeat/filebeat beats/heartbeat/heartbeat beats/metricbeat/metricbeat beats/osquerybeat/osquerybeat beats/packetbeat/packetbeat cloudbeat/cloudbeat endpoint-dev/endpoint-security fleet-server/fleet-server"

WIN_ONLY_PACKAGE_PREFIXES="beats/winlogbeat/winlogbeat"

RPM_PACKAGES="beats/elastic-agent/elastic-agent"
DEB_PACKAGES="beats/elastic-agent/elastic-agent"

function download_packages() {
  local url_suffix="$1"
  local package_prefixes="$2"

  local _url_suffixes="$url_suffix ${url_suffix}.sha512 ${url_suffix}.asc"
  local _pkg_dir=""
  local _dl_url=""

  for _download_prefix in $package_prefixes; do
    for _pkg_url_suffix in $_url_suffixes; do
          _pkg_dir=$(dirname ${DOWNLOAD_BASE_DIR}/${_download_prefix})
          _dl_url="${ARTIFACT_DOWNLOADS_BASE_URL}/${_download_prefix}-${_pkg_url_suffix}"
          (mkdir -p $_pkg_dir &amp;&amp; cd $_pkg_dir &amp;&amp; curl -O "$_dl_url")
    done
  done
}

# and we download
for _os in linux windows; do
  case "$_os" in
    linux)
      PKG_URL_SUFFIX="${STACK_VERSION}-${_os}-x86_64.tar.gz"
      ;;
    windows)
      PKG_URL_SUFFIX="${STACK_VERSION}-${_os}-x86_64.zip"
      ;;
    *)
      echo "[ERROR] Something happened"
      exit 1
      ;;
  esac

  download_packages "$PKG_URL_SUFFIX" "$COMMON_PACKAGE_PREFIXES"

  if [[ "$_os" = "windows" ]]; then
    download_packages "$PKG_URL_SUFFIX" "$WIN_ONLY_PACKAGE_PREFIXES"
  fi

  if [[ "$_os" = "linux" ]]; then
    download_packages "${STACK_VERSION}-x86_64.rpm" "$RPM_PACKAGES"
    download_packages "${STACK_VERSION}-amd64.deb" "$DEB_PACKAGES"
  fi
done


## selinux tweaks
# semanage fcontext -a -t "httpd_sys_content_t" '/opt/elastic-packages(/.*)?'
# restorecon -Rv /opt/elastic-packages</pre>
</div>
<p>The following is an example NGINX configuration for running a web server for the Elastic Artifact Registry.</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">user  nginx;
worker_processes  2;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log          /var/log/nginx/access.log  main;
    sendfile            on;
    keepalive_timeout   65;

    server {
        listen                  9080 default_server;
        server_name             _;
        root                    /opt/elastic-packages;

        location / {

        }
    }

}</pre>
</div>
<div class="position-relative"><h3><a id="air-gapped-epr-kubernetes-example"></a>Appendix C - EPR Kubernetes Deployment</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>The following is a sample EPR Kubernetes deployment YAML file.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: elastic-package-registry
  namespace: default
  labels:
    app: elastic-package-registry
spec:
  replicas: 1
  selector:
    matchLabels:
      app: elastic-package-registry
  template:
    metadata:
      name: elastic-package-registry
      labels:
        app: elastic-package-registry
    spec:
      containers:
        - name: epr
          image: docker.elastic.co/package-registry/distribution:8.15.0
          ports:
            - containerPort: 8080
              name: http
          livenessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 20
            periodSeconds: 30
          resources:
            requests:
              cpu: 125m
              memory: 128Mi
            limits:
              cpu: 1000m
              memory: 512Mi
          env:
            - name: EPR_ADDRESS
              value: "0.0.0.0:8080"
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: elastic-package-registry
  name: elastic-package-registry
spec:
  ports:
  - port: 80
    name: http
    protocol: TCP
    targetPort: http
  selector:
    app: elastic-package-registry</pre>
</div>
<div class="position-relative"><h3><a id="air-gapped-agent-integration-guide"></a>Appendix D - Agent Integration Guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>When configuring any integration in Elastic Agent, you need to set up integration settings within whatever policy is ultimately assigned to that agent.</p>
<div class="position-relative"><h4><a id="air-gapped-agent-integration-terminology"></a>D.1. Terminology</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>Note the following terms and definitions:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
Integration
</span>
</dt>
<dd>
A variety of optional capabilities that can be deployed on top of the Elastic Stack. Refer to <a href="/integrations/" class="ulink" target="_top">Integrations</a> to learn more.
</dd>
<dt>
<span class="term">
Agent integration
</span>
</dt>
<dd>
The integrations that require Elastic Agent to run. For example, the Sample Data integration requires only Elasticsearch and Kibana and consists of dashboards, data, and related objects, but the APM integration not only has some Elasticsearch objects, but also needs Elastic Agent to run the APM Server.
</dd>
<dt>
<span class="term">
Package
</span>
</dt>
<dd>
A set of dependencies (such as dashboards, scripts, and others) for a given  integration that, typically, needs to be retrieved from the <a class="xref" href="air-gapped-install.html#air-gapped-elastic-package-registry" title="1.10. Elastic Package Registry">Elastic Package Registry</a> before an integration can be correctly installed and configured.
</dd>
<dt>
<span class="term">
Agent policy
</span>
</dt>
<dd>
A configuration for the Elastic Agent that may include one or more Elastic Agent integrations, and configurations for each of those integrations.
</dd>
</dl>
</div>
<div class="position-relative"><h4><a id="air-gapped-agent-integration-configure"></a>D.2. How to configure</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p>There are three ways to configure Elastic Agent integrations:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-agent-integration-configure-kibana" title="D.2.1. Using the Kibana UI">D.2.1. Using the Kibana UI</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-agent-integration-configure-yml" title="D.2.2. Using the kibana.yml config file">D.2.2. Using the <code class="literal">kibana.yml</code> config file</a>
</li>
<li class="listitem">
<a class="xref" href="air-gapped-install.html#air-gapped-agent-integration-configure-fleet-api" title="D.2.3. Using the Kibana Fleet API">D.2.3. Using the Kibana Fleet API</a>
</li>
</ul>
</div>
<div class="position-relative"><h4><a id="air-gapped-agent-integration-configure-kibana"></a>D.2.1. Using the Kibana UI</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p><span class="strong strong"><strong>Best option for:</strong></span> Manual configuration and users who prefer using a UI over scripting.</p>
<p><span class="strong strong"><strong>Example:</strong></span> <a href="/guide/en/observability/8.15/logs-metrics-get-started.html" class="ulink" target="_top">Get started with logs and metrics</a></p>
<p>Agent policies and integration settings can be managed using the Kibana UI. For example, the following shows the configuration of logging for the System integration in an Elastic Agent policy:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/air-gapped-configure-logging.png" alt="Configuration of a logging integration in an agent policy">
</div>
</div>
<div class="position-relative"><h4><a id="air-gapped-agent-integration-configure-yml"></a>D.2.2. Using the <code class="literal">kibana.yml</code> config file</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p><span class="strong strong"><strong>Good option for:</strong></span> Declarative configuration and users who need reproducible and automated deployments.</p>
<p><span class="strong strong"><strong>Example:</strong></span> <a href="/guide/en/kibana/8.15/fleet-settings-kb.html" class="ulink" target="_top">Fleet settings in Kibana</a></p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This documentation is still under development; there may be gaps around building custom agent policies.</p>
</div>
</div>
<p>You can have Kibana create Elastic Agent policies on your behalf by adding appropriate configuration parameters in the <code class="literal">kibana.yml</code> settings file, these include:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">xpack.fleet.packages</code>
</span>
</dt>
<dd>
Takes a list of all integration package names and versions that Kibana should download from the Elastic Package Registry (EPR). This is done because Elastic Agents themselves do not directly fetch packages from the EPR.
</dd>
<dt>
<span class="term">
<code class="literal">xpack.fleet.agentPolicies</code>
</span>
</dt>
<dd>
Takes a list of Elastic Agent policies in the format expected by the <a href="/guide/en/fleet/8.15/fleet-api-docs.html" class="ulink" target="_top">Kibana Fleet HTTP API</a>. Refer to the setting in <a href="/guide/en/kibana/8.15/fleet-settings-kb.html#_preconfiguration_settings_for_advanced_use_cases" class="ulink" target="_top">Preconfiguration settings</a> for the format. See also <a class="xref" href="air-gapped-install.html#air-gapped-agent-integration-configure-fleet-api" title="D.2.3. Using the Kibana Fleet API">D.2.3. Using the Kibana Fleet API</a>.
</dd>
<dt>
<span class="term">
<code class="literal">xpack.fleet.registryUrl</code>
</span>
</dt>
<dd>
Takes a URL of the Elastic Package Registry that can be reached by the Kibana server. Enable this setting only when deploying in an air-gapped environment.
</dd>
<dt>
<span class="term">
Other settings
</span>
</dt>
<dd>
You can add other, more discretionary settings for Fleet, Elastic Agents, &amp; policies. Refer to <a href="/guide/en/kibana/8.15/fleet-settings-kb.html" class="ulink" target="_top">Fleet settings in Kibana</a>.
</dd>
</dl>
</div>
<div class="position-relative"><h4><a id="air-gapped-agent-integration-configure-fleet-api"></a>D.2.3. Using the Kibana Fleet API</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/8.15/docs/en/install-upgrade/air-gapped-install.asciidoc">edit</a></div>
<p><span class="strong strong"><strong>Best option for</strong></span>: Declarative configuration and users who need reproducible and automated deployments in even the trickiest of environments.</p>
<p><span class="strong strong"><strong>Example:</strong></span> See the following.</p>
<p>It is possible to use custom scripts that call the Kibana Fleet API to create or update policies without restarting Kibana, and also allowing for custom error handling and update logic.</p>
<p>At this time, you can refer to the the <a href="/guide/en/fleet/8.15/fleet-api-docs.html" class="ulink" target="_top">Kibana Fleet HTTP API</a> documentation, however additional resources from public code repositories should be consulted to capture the full set of configuration options available for a given integration. Specifically, many integrations have configuration options such as <code class="literal">inputs</code> and <code class="literal">data_streams</code> that are unique.</p>
<p>In particular, the <code class="literal">*.yml.hbs</code> templates should be consulted to determine which <code class="literal">vars</code> are available for configuring a particular integration using the Kibana Fleet API.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
For most Integrations, refer to the README and <code class="literal">*.yml.hbs</code> files in the appropriate directory in the <a href="https://github.com/elastic/integrations/tree/main/packages" class="ulink" target="_top">elastic/integrations repository</a>.
</li>
<li class="listitem">
For the APM integration, refer to the README and <code class="literal">*.yml.hbs</code> files in the <a href="https://github.com/elastic/apm-server/tree/main/apmpackage/apm/agent" class="ulink" target="_top">elastic/apm-server repository</a>.
</li>
</ul>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="install-stack-demo-secure.html">« Tutorial 2: Securing a self-managed Elastic Stack</a>
</span>
<span class="next">
<a href="upgrading-elastic-stack.html">Upgrade to Elastic 8.15.0 »</a>
</span>
</div>
</body>
</html>
