<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Using OpenTelemetry | Elasticsearch Java API Client [master] | Elastic</title>
<meta class="elastic" name="content" content="Using OpenTelemetry | Elasticsearch Java API Client [master]">

<link rel="home" href="index.html" title="Elasticsearch Java API Client [master]"/>
<link rel="up" href="_setup.html" title="Setup"/>
<link rel="prev" href="migrate-hlrc.html" title="Migrating from the High Level Rest Client"/>
<link rel="next" href="api-conventions.html" title="API conventions"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Clients"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Clients/Java/master"/>
<meta name="DC.subject" content="Clients"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="migrate-hlrc.html">« Migrating from the High Level Rest Client</a>
</span>
<span class="next">
<a href="api-conventions.html">API conventions »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Java API Client [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="_setup.html">Setup</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Using OpenTelemetry</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-java/edit/main/docs/setup/open-telemetry.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="opentelemetry"></a>Using OpenTelemetry<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-java/edit/main/docs/setup/open-telemetry.asciidoc">edit</a></h2>
</div></div></div>
<p>You can use <a href="https://opentelemetry.io/" class="ulink" target="_top">OpenTelemetry</a> to monitor the performance and behavior of your Elasticsearch requests through the Java API Client.
The Java API Client comes with built-in OpenTelemetry instrumentation that emits <a href="/guide/en/apm/guide/current/apm-distributed-tracing.html" class="ulink" target="_top">distributed tracing spans</a> by default.
With that, applications <a href="https://opentelemetry.io/docs/instrumentation/java/manual/" class="ulink" target="_top">instrumented with OpenTelemetry</a> or running the <a href="https://opentelemetry.io/docs/instrumentation/java/automatic/" class="ulink" target="_top">OpenTelemetry Java Agent</a> are inherently enriched with additional spans that contain insightful information about the execution of the Elasticsearch requests.</p>
<p>The native instrumentation in the Java API Client follows the <a href="https://opentelemetry.io/docs/specs/semconv/database/elasticsearch/" class="ulink" target="_top">OpenTelemetry Semantic Conventions for Elasticsearch</a>. In particular, the instrumentation in the client covers the logical Elasticsearch request layer, thus, creates a single span per request the service executes against the Java API Client. The following image shows a resulting trace in which three different Elasticsearch requests are executed, i.e. an <code class="literal">index</code>, <code class="literal">get</code> and a search <code class="literal">request</code>:</p>
<div class="imageblock text-center screenshot">
<div class="content">
<img src="images/otel-waterfall-instrumented-without-http.jpg" alt="Distributed trace with Elasticsearch spans">
</div>
</div>
<p>Usually, OpenTelemetry agents and auto-instrumentation modules come with instrumentation support for HTTP-level communication. In this case, in addition to the logical Elasticsearch client requests, spans will be captured for the physical HTTP requests emitted by the client. The following image shows a trace with both, Elasticsearch spans (in blue) and the corresponding HTTP-level spans (in red):</p>
<div class="imageblock text-center screenshot">
<div class="content">
<img src="images/otel-waterfall-instrumented.jpg" alt="Distributed trace with Elasticsearch and HTTP spans">
</div>
</div>
<p>Advanced Java API Client behavior such as nodes round-robin and request retries are revealed through the combination of logical Elasticsearch spans and the physical HTTP spans. The following example shows an <code class="literal">index</code> request in a scenario with two Elasticsearch nodes:</p>
<div class="imageblock text-center screenshot">
<div class="content">
<img src="images/otel-waterfall-retries.jpg" alt="Distributed trace with request retries">
</div>
</div>
<p>The first node is unavailable and results in an HTTP error, while the retry to the second node succeeds. Both HTTP requests are subsumed by the logical Elasticsearch request span (in blue).</p>
<h4><a id="_setup_the_opentelemetry_instrumentation"></a>Setup the OpenTelemetry instrumentation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-java/edit/main/docs/setup/open-telemetry.asciidoc">edit</a></h4>
<p>When using the <a href="https://opentelemetry.io/docs/instrumentation/java/manual" class="ulink" target="_top">OpenTelemetry Java SDK manually</a> or using the <a href="https://opentelemetry.io/docs/instrumentation/java/automatic/" class="ulink" target="_top">OpenTelemetry Java Agent</a>, the Java API Client&#8217;s OpenTelemetry instrumentation is enabled by default and uses the <em>globally</em> registered OpenTelemetry SDK instance (i.e. <code class="literal">GlobalOpenTelemetry</code>). So, if you don&#8217;t use a custom, local OpenTelemetry SDK instance, there is no explicit setup required to use the Java API Client&#8217;s OpenTelemetry instrumentation.</p>
<h5><a id="_using_a_custom_opentelemetry_instance"></a>Using a custom OpenTelemetry instance<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-java/edit/main/docs/setup/open-telemetry.asciidoc">edit</a></h5>
<p>In case you are using <a href="https://opentelemetry.io/docs/instrumentation/java/manual/#example" class="ulink" target="_top">manual OpenTelemetry instrumentation</a> with a custom OpenTelemetry SDK instance that is <em>not registered globally</em>, you can create the Java API Client using a custom OpenTelemetry instance. The following code snippet shows an example of using a custom OpenTelemetry instance.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">// URL and API key
String serverUrl = "https://localhost:9200";
String apiKey = "VnVhQ2ZHY0JDZGJrU...";

// Create the low-level client
RestClient restClient = RestClient
    .builder(HttpHost.create(serverUrl))
    .setDefaultHeaders(new Header[]{
            new BasicHeader("Authorization", "ApiKey " + apiKey)
    })
    .build();
// Create and configure custom OpenTelemetry instance
OpenTelemetry customOtel = OpenTelemetrySdk.builder().build();

// Create Instrumentation instance using the custom OpenTelemetry instance
// Second constructor argument allows to enable/disable search body capturing
OpenTelemetryForElasticsearch esOtelInstrumentation =
    new OpenTelemetryForElasticsearch(customOtel, false);

// Create the transport with the custom Instrumentation instance
ElasticsearchTransport transport = new RestClientTransport(
    restClient, new JacksonJsonpMapper(), null, esOtelInstrumentation
);

// And create the API client
ElasticsearchClient esClient = new ElasticsearchClient(transport);

// Use the client...

// Close the transport, freeing the underlying thread
transport.close();</pre>
</div>
<h4><a id="_configuring_the_opentelemetry_instrumentation"></a>Configuring the OpenTelemetry instrumentation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-java/edit/main/docs/setup/open-telemetry.asciidoc">edit</a></h4>
<p>You can configure the OpenTelemetry instrumentation either through Java System properties or Environment Variables.
The following configuration options are available.</p>
<h5><a id="opentelemetry-config-enable"></a>Enable / Disable the OpenTelemetry instrumentation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-java/edit/main/docs/setup/open-telemetry.asciidoc">edit</a></h5>
<p>With this configuration option you can enable (default) or disable the built-in OpenTelemetry instrumentation.</p>
<p><span class="strong strong"><strong>Default:</strong></span> <code class="literal">true</code></p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Java System Property</p></td>
<td align="left" valign="top"><p><code class="literal">otel.instrumentation.elasticsearch.enabled</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Environment Variable</p></td>
<td align="left" valign="top"><p><code class="literal">OTEL_INSTRUMENTATION_ELASTICSEARCH_ENABLED</code></p></td>
</tr>
</tbody>
</table>
</div>
<h5><a id="_capture_search_request_bodies"></a>Capture search request bodies<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-java/edit/main/docs/setup/open-telemetry.asciidoc">edit</a></h5>
<p>Per default, the built-in OpenTelemetry instrumentation does not capture request bodies because of data privacy reasons. You can use this option to enable capturing of search queries from the the request bodies of Elasticsearch search requests in case you wish to capture this information, regardless.</p>
<p><span class="strong strong"><strong>Default:</strong></span> <code class="literal">false</code></p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Java System Property</p></td>
<td align="left" valign="top"><p><code class="literal">otel.instrumentation.elasticsearch.capture-search-query</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Environment Variable</p></td>
<td align="left" valign="top"><p><code class="literal">OTEL_INSTRUMENTATION_ELASTICSEARCH_CAPTURE_SEARCH_QUERY</code></p></td>
</tr>
</tbody>
</table>
</div>
<h4><a id="_overhead"></a>Overhead<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-java/edit/main/docs/setup/open-telemetry.asciidoc">edit</a></h4>
<p>The OpenTelemetry instrumentation (as any other monitoring approach) may come with a little overhead on CPU, memory and/or latency. The overhead may only occur when the instrumentation is enabled (default) and an OpenTelemetry SDK (or an OpenTelemetry Agent) is active in the target application. In case that either the instrumentation is disabled or no OpenTelemetry SDK (or OpenTelemetry Agent) is active with the target application, there is no monitoring overhead expected when using the client.</p>
<p>Even when the instrumentation is enabled and is being actively used (by an OpenTelemetry SDK), in the vast majority of cases the overhead is very small and negligible. In edge cases in which there is a noticable overhead the <a class="xref" href="opentelemetry.html#opentelemetry-config-enable" title="Enable / Disable the OpenTelemetry instrumentation">instrumentation can be explicitly disabled</a> to eliminate any potential overhead effect of the instrumentation.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="migrate-hlrc.html">« Migrating from the High Level Rest Client</a>
</span>
<span class="next">
<a href="api-conventions.html">API conventions »</a>
</span>
</div>
</body>
</html>
