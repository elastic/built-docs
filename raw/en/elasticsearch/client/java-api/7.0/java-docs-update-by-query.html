<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Update By Query API | Java API [7.0] | Elastic</title>
<link rel="home" href="index.html" title="Java API [7.0]"/>
<link rel="up" href="java-docs.html" title="Document APIs"/>
<link rel="prev" href="java-docs-bulk-processor.html" title="Using Bulk Processor"/>
<link rel="next" href="java-docs-reindex.html" title="Reindex API"/>
<meta name="DC.type" content="Learn/Docs/Clients/Java/7.0"/>
<meta name="DC.subject" content="Clients"/>
<meta name="DC.identifier" content="7.0"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Java API [7.0]</a></span>
»
<span class="breadcrumb-link"><a href="java-docs.html">Document APIs</a></span>
»
<span class="breadcrumb-node">Update By Query API</span>
</div>
<div class="navheader">
<span class="prev">
<a href="java-docs-bulk-processor.html">« Using Bulk Processor</a>
</span>
<span class="next">
<a href="java-docs-reindex.html">Reindex API »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="java-docs-update-by-query"></a>Update By Query API<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/7.0/docs/java-api/docs/update-by-query.asciidoc">edit</a></h2>
</div></div></div>
<p>The simplest usage of <code class="literal">updateByQuery</code> updates each
document in an index without changing the source. This usage enables
picking up a new property or another online mapping change.</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source("source_index").abortOnVersionConflict(false);
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p>Calls to the <code class="literal">updateByQuery</code> API start by getting a snapshot of the index, indexing
any documents found using the <code class="literal">internal</code> versioning.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Version conflicts happen when a document changes between the time of the
snapshot and the time the index request processes.</p>
</div>
</div>
<p>When the versions match, <code class="literal">updateByQuery</code> updates the document
and increments the version number.</p>
<p>All update and query failures cause <code class="literal">updateByQuery</code> to abort. These failures are
available from the <code class="literal">BulkByScrollResponse#getIndexingFailures</code> method. Any
successful updates remain and are not rolled back. While the first failure
causes the abort, the response contains all of the failures generated by the
failed bulk request.</p>
<p>To prevent version conflicts from causing <code class="literal">updateByQuery</code> to abort, set
<code class="literal">abortOnVersionConflict(false)</code>. The first example does this because it is
trying to pick up an online mapping change and a version conflict means that
the conflicting document was updated between the start of the <code class="literal">updateByQuery</code>
and the time when it attempted to update the document. This is fine because
that update will have picked up the online mapping update.</p>
<p>The <code class="literal">UpdateByQueryRequestBuilder</code> API supports filtering the updated documents,
limiting the total number of documents to update, and updating documents
with a script:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source("source_index")
    .filter(QueryBuilders.termQuery("level", "awesome"))
    .size(1000)
    .script(new Script(ScriptType.INLINE,
        "ctx._source.awesome = 'absolutely'",
        "painless",
        Collections.emptyMap()));
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p><code class="literal">UpdateByQueryRequestBuilder</code> also enables direct access to the query used
to select the documents. You can use this access to change the default scroll size or
otherwise modify the request for matching documents.</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source("source_index")
    .source()
    .setSize(500);
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p>You can also combine <code class="literal">size</code> with sorting to limit the documents updated:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
   new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source("source_index")
    .size(100)
    .source()
    .addSort("cat", SortOrder.DESC);
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p>In addition to changing the <code class="literal">_source</code> field for the document, you can use a
script to change the action, similar to the Update API:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source("source_index")
    .script(new Script(
        ScriptType.INLINE,
        "if (ctx._source.awesome == 'absolutely') {"
            + "  ctx.op='noop'"
            + "} else if (ctx._source.awesome == 'lame') {"
            + "  ctx.op='delete'"
            + "} else {"
            + "ctx._source.awesome = 'absolutely'}",
        "painless",
        Collections.emptyMap()));
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p>As in the <a class="xref" href="java-docs-update.html" title="Update API">Update API</a>, you can set the value of <code class="literal">ctx.op</code> to change the
operation that executes:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">noop</code>
</span>
</dt>
<dd>
Set <code class="literal">ctx.op = "noop"</code> if your script doesn&#8217;t make any
changes. The <code class="literal">updateByQuery</code> operation then omits that document from the updates.
This behavior increments the <code class="literal">noop</code> counter in the response body.
</dd>
<dt>
<span class="term">
<code class="literal">delete</code>
</span>
</dt>
<dd>
Set <code class="literal">ctx.op = "delete"</code> if your script decides that the document must be
deleted. The deletion will be reported in the <code class="literal">deleted</code> counter in the
response body.
</dd>
</dl>
</div>
<p>Setting <code class="literal">ctx.op</code> to any other value generates an error. Setting any
other field in <code class="literal">ctx</code> generates an error.</p>
<p>This API doesn&#8217;t allow you to move the documents it touches, just modify their
source. This is intentional! We&#8217;ve made no provisions for removing the document
from its original location.</p>
<p>You can also perform these operations on multiple indices at once, similar to the search API:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source("foo", "bar");
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p>If you provide a <code class="literal">routing</code> value then the process copies the routing value to the scroll query,
limiting the process to the shards that match that routing value:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.source().setRouting("cat");
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<p><code class="literal">updateByQuery</code> can also use the ingest node by
specifying a <code class="literal">pipeline</code> like this:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">UpdateByQueryRequestBuilder updateByQuery =
  new UpdateByQueryRequestBuilder(client, UpdateByQueryAction.INSTANCE);
updateByQuery.setPipeline("hurray");
BulkByScrollResponse response = updateByQuery.get();</pre>
</div>
<h3><a id="java-docs-update-by-query-task-api"></a>Works with the Task API<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/7.0/docs/java-api/docs/update-by-query.asciidoc">edit</a></h3>
<p>You can fetch the status of all running update-by-query requests with the Task API:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">ListTasksResponse tasksList = client.admin().cluster().prepareListTasks()
    .setActions(UpdateByQueryAction.NAME).setDetailed(true).get();
for (TaskInfo info: tasksList.getTasks()) {
    TaskId taskId = info.getTaskId();
    BulkByScrollTask.Status status =
        (BulkByScrollTask.Status) info.getStatus();
    // do stuff
}</pre>
</div>
<p>With the <code class="literal">TaskId</code> shown above you can look up the task directly:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">GetTaskResponse get = client.admin().cluster().prepareGetTask(taskId).get();</pre>
</div>
<h3><a id="java-docs-update-by-query-cancel-task-api"></a>Works with the Cancel Task API<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/7.0/docs/java-api/docs/update-by-query.asciidoc">edit</a></h3>
<p>Any Update By Query can be canceled using the Task Cancel API:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">// Cancel all update-by-query requests
client.admin().cluster().prepareCancelTasks()
    .setActions(UpdateByQueryAction.NAME).get().getTasks();
// Cancel a specific update-by-query request
client.admin().cluster().prepareCancelTasks()
    .setTaskId(taskId).get().getTasks();</pre>
</div>
<p>Use the <code class="literal">list tasks</code> API to find the value of <code class="literal">taskId</code>.</p>
<p>Cancelling a request is typically a very fast process but can take up to a few seconds.
The task status API continues to list the task until the cancellation is complete.</p>
<h3><a id="java-docs-update-by-query-rethrottle"></a>Rethrottling<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/7.0/docs/java-api/docs/update-by-query.asciidoc">edit</a></h3>
<p>Use the <code class="literal">_rethrottle</code> API to change the value of <code class="literal">requests_per_second</code> on a running update:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">new RethrottleRequestBuilder(client, RethrottleAction.INSTANCE)
    .setTaskId(taskId)
    .setRequestsPerSecond(2.0f)
    .get();</pre>
</div>
<p>Use the <code class="literal">list tasks</code> API to find the value of <code class="literal">taskId</code>.</p>
<p>As with the <code class="literal">updateByQuery</code> API, the value of <code class="literal">requests_per_second</code>
can be any positive float value to set the level of the throttle, or <code class="literal">Float.POSITIVE_INFINITY</code> to disable throttling.
A value of <code class="literal">requests_per_second</code> that speeds up the process takes
effect immediately. <code class="literal">requests_per_second</code> values that slow the query take effect
after completing the current batch in order to prevent scroll timeouts.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="java-docs-bulk-processor.html">« Using Bulk Processor</a>
</span>
<span class="next">
<a href="java-docs-reindex.html">Reindex API »</a>
</span>
</div>
</div>
</body>
</html>
