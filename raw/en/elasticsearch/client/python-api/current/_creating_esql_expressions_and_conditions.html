<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Creating ES|QL Expressions and Conditions | Elasticsearch Python Client [8.19] | Elastic</title>
<meta class="elastic" name="content" content="Creating ES|QL Expressions and Conditions | Elasticsearch Python Client [8.19]">

<link rel="home" href="index.html" title="Elasticsearch Python Client [8.19]"/>
<link rel="up" href="esql-query-builder.html" title="ES|QL Query Builder"/>
<link rel="prev" href="_adding_processing_commands.html" title="Adding processing commands"/>
<link rel="next" href="_using_esql_functions.html" title="Using ES|QL functions"/>
<meta class="elastic" name="product_version" content="8.19"/>
<meta class="elastic" name="product_name" content="Clients"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Clients/Python/8.19"/>
<meta name="DC.subject" content="Clients"/>
<meta name="DC.identifier" content="8.19"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="_adding_processing_commands.html">« Adding processing commands</a>
</span>
<span class="next">
<a href="_using_esql_functions.html">Using ES|QL functions »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Python Client [8.19]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="esql-query-builder.html">ES|QL Query Builder</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Creating ES|QL Expressions and Conditions</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-py/edit/8.19/docs/guide/esql-query-builder.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="_creating_esql_expressions_and_conditions"></a>Creating ES|QL Expressions and Conditions</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-py/edit/8.19/docs/guide/esql-query-builder.asciidoc">edit</a></div>
</div></div></div>
<p>The ES|QL query builder for Python provides two ways to create expressions and conditions in ES|QL queries.</p>
<p>The simplest option is to provide all ES|QL expressions and conditionals as strings. The following example uses this approach to add two calculated columns to the results using the <code class="literal">EVAL</code> command:</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">from elasticsearch.esql import ESQL

# FROM employees
# | SORT emp_no
# | KEEP first_name, last_name, height
# | EVAL height_feet = height * 3.281, height_cm = height * 100
query = (
    ESQL.from_("employees")
    .sort("emp_no")
    .keep("first_name", "last_name", "height")
    .eval(height_feet="height * 3.281", height_cm="height * 100")
)</pre>
</div>
<p>A more advanced alternative is to replace the strings with Python expressions, which are automatically translated to ES|QL when the query object is rendered to a string. The following example is functionally equivalent to the one above:</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">from elasticsearch.esql import ESQL, E

# FROM employees
# | SORT emp_no
# | KEEP first_name, last_name, height
# | EVAL height_feet = height * 3.281, height_cm = height * 100
query = (
    ESQL.from_("employees")
    .sort("emp_no")
    .keep("first_name", "last_name", "height")
    .eval(height_feet=E("height") * 3.281, height_cm=E("height") * 100)
)</pre>
</div>
<p>Here the <code class="literal">E()</code> helper function is used as a wrapper to the column name that initiates an ES|QL expression. The <code class="literal">E()</code> function transforms the given column into an ES|QL expression that can be modified with Python operators.</p>
<p>Here is a second example, which uses a conditional expression in the <code class="literal">WHERE</code> command:</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">from elasticsearch.esql import ESQL

# FROM employees
# | KEEP first_name, last_name, height
# | WHERE first_name == "Larry"
query = (
    ESQL.from_("employees")
    .keep("first_name", "last_name", "height")
    .where('first_name == "Larry"')
)</pre>
</div>
<p>Using Python syntax, the condition can be rewritten as follows:</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">from elasticsearch.esql import ESQL, E

# FROM employees
# | KEEP first_name, last_name, height
# | WHERE first_name == "Larry"
query = (
    ESQL.from_("employees")
    .keep("first_name", "last_name", "height")
    .where(E("first_name") == "Larry")
)</pre>
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_preventing_injection_attacks"></a>Preventing injection attacks</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-py/edit/8.19/docs/guide/esql-query-builder.asciidoc">edit</a></div>
</div></div></div>
<p>ES|QL, like most query languages, is vulnerable to <a href="https://en.wikipedia.org/wiki/Code_injection" class="ulink" target="_top">code injection attacks</a> if untrusted data provided by users is added to a query. To eliminate this risk, ES|QL allows untrusted data to be given separately from the query as parameters.</p>
<p>Continuing with the example above, let&#8217;s assume that the application needs a <code class="literal">find_employee_by_name()</code> function that searches for the name given as an argument. If this argument is received by the application from users, then it is considered untrusted and should not be added to the query directly. Here is how to code the function in a secure manner:</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">def find_employee_by_name(name):
    query = (
        ESQL.from_("employees")
        .keep("first_name", "last_name", "height")
        .where(E("first_name") == E("?"))
    )
    return client.esql.query(query=str(query), params=[name])</pre>
</div>
<p>Here the part of the query in which the untrusted data needs to be inserted is replaced with a parameter, which in ES|QL is defined by the question mark. When using Python expressions, the parameter must be given as <code class="literal">E("?")</code> so that it is treated as an expression and not as a literal string.</p>
<p>The list of values given in the <code class="literal">params</code> argument to the query endpoint are assigned in order to the parameters defined in the query.</p>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="_adding_processing_commands.html">« Adding processing commands</a>
</span>
<span class="next">
<a href="_using_esql_functions.html">Using ES|QL functions »</a>
</span>
</div>
</body>
</html>
