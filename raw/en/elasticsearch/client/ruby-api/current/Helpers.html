<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Client Helpers | Elasticsearch Ruby Client [8.13] | Elastic</title>
<meta class="elastic" name="content" content="Client Helpers | Elasticsearch Ruby Client [8.13]">

<link rel="home" href="index.html" title="Elasticsearch Ruby Client [8.13]"/>
<link rel="up" href="index.html" title="Elasticsearch Ruby Client [8.13]"/>
<link rel="prev" href="troubleshooting.html" title="Troubleshooting"/>
<link rel="next" href="release_notes.html" title="Release Notes"/>
<meta class="elastic" name="product_version" content="8.13"/>
<meta class="elastic" name="product_name" content="Clients"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Clients/Ruby/8.13"/>
<meta name="DC.subject" content="Clients"/>
<meta name="DC.identifier" content="8.13"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Ruby Client [8.13]</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="troubleshooting.html">« Troubleshooting</a>
</span>
<span class="next">
<a href="release_notes.html">Release Notes »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="Helpers"></a>Client Helpers<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/8.13/docs/helpers.asciidoc">edit</a></h1>
</div></div></div>
<p>The Elasticsearch Ruby client includes some useful helpers for a more comfortable experience with some APIs.</p>
<h3><a id="_bulk_helper"></a>Bulk Helper<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/8.13/docs/helpers.asciidoc">edit</a></h3>
<p>The Bulk API in Elasticsearch allows you to perform multiple indexing or deletion operations through a single API call, resulting in reduced overhead and improved indexing speed. The actions are specified in the request body using a newline delimited JSON (NDJSON) structure. In the Elasticsearch Ruby client, the <code class="literal">bulk</code> method supports several data structures as a parameter. You can use the Bulk API in an idiomatic way without concerns about payload formatting. Refer to <a class="xref" href="examples.html#ex-bulk" title="Bulk requests">Bulk requests</a> for more information.</p>
<p>The BulkHelper provides a better developer experience when using the Bulk API. At its simplest, you can send it a collection of hashes in an array, and it will bulk ingest them into Elasticsearch.</p>
<p>To use the BulkHelper, require it in your code:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">require 'elasticsearch/helpers/bulk_helper'</pre>
</div>
<p>Instantiate a BulkHelper with a client, and an index:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">client = Elasticsearch::Client.new
bulk_helper = Elasticsearch::Helpers::BulkHelper.new(client, index)</pre>
</div>
<p>This helper works on the index you pass in during initialization, but you can change the index at any time in your code:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">bulk_helper.index = 'new_index'</pre>
</div>
<p>If you want to index a collection of documents, use the <code class="literal">ingest</code> method:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">documents = [
  { name: 'document1', date: '2024-05-16' },
  { name: 'document2', date: '2023-12-19' },
  { name: 'document3', date: '2024-07-07' }
]
bulk_helper.ingest(documents)</pre>
</div>
<p>If you&#8217;re ingesting a large set of data and want to separate the documents into smaller pieces before sending them to Elasticsearch, use the <code class="literal">slice</code> parameter.</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">bulk_helper.ingest(documents, { slice: 2 })</pre>
</div>
<p>This way the data will be sent in two different bulk requests.</p>
<p>You can also include the parameters you would send to the Bulk API either in the query parameters or in the request body. The method signature is <code class="literal">ingest(docs, params = {}, body = {}, &amp;block)</code>. Additionally, the method can be called with a block, that will provide access to the response object received from calling the Bulk API and the documents sent in the request:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">helper.ingest(documents) { |_, docs| puts "Ingested #{docs.count} documents" }</pre>
</div>
<p>You can update and delete documents with the BulkHelper too. To delete a set of documents, you can send an array of document ids:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">ids = ['shm0I4gB6LpJd9ljO9mY', 'sxm0I4gB6LpJd9ljO9mY', 'tBm0I4gB6LpJd9ljO9mY', 'tRm0I4gB6LpJd9ljO9mY', 'thm0I4gB6LpJd9ljO9mY', 'txm0I4gB6LpJd9ljO9mY', 'uBm0I4gB6LpJd9ljO9mY', 'uRm0I4gB6LpJd9ljO9mY', 'uhm0I4gB6LpJd9ljO9mY', 'uxm0I4gB6LpJd9ljO9mY']
helper.delete(ids)</pre>
</div>
<p>To update documents, you can send the array of documents with their respective ids:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">documents = [
  {name: 'updated name 1', id: 'AxkFJYgB6LpJd9ljOtr7'},
  {name: 'updated name 2', id: 'BBkFJYgB6LpJd9ljOtr7'}
]
helper.update(documents)</pre>
</div>
<h4><a id="_ingest_a_json_file"></a>Ingest a JSON file<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/8.13/docs/helpers.asciidoc">edit</a></h4>
<p><code class="literal">BulkHelper</code> also provides a helper to ingest data straight from a JSON file. By giving a file path as an input, the helper will parse and ingest the documents in the file:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">file_path = './data.json'
helper.ingest_json(file_path)</pre>
</div>
<p>In cases where the array of data you want to ingest is not necessarily in the root of the JSON file, you can provide the keys to access the data, for example given the following JSON file:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "field": "value",
  "status": 200,
  "data": {
    "items": [
      {
        "name": "Item 1",
        (...)
      },
      {
      (...)
    ]
  }
}</pre>
</div>
<p>The following is an example of the Ruby code to ingest the documents in the JSON above:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">bulk_helper.ingest_json(file_path, { keys: ['data', 'items'] })</pre>
</div>
<h3><a id="_scroll_helper"></a>Scroll Helper<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/8.13/docs/helpers.asciidoc">edit</a></h3>
<p>This helper provides an easy way to get results from a Scroll.</p>
<p>To use the ScrollHelper, require it in your code:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">require 'elasticsearch/helpers/scroll_helper'</pre>
</div>
<p>Instantiate a ScrollHelper with a client, an index, and a body (with the scroll API parameters) which will be used in every following scroll request:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">client = Elasticsearch::Client.new
scroll_helper = Elasticsearch::Helpers::ScrollHelper.new(client, index, body)</pre>
</div>
<p>There are two ways to get the results from a scroll using the helper.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>You can iterate over a scroll using the methods in <code class="literal">Enumerable</code> such as <code class="literal">each</code> and <code class="literal">map</code>:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">scroll_helper.each do |item|
  puts item
end</pre>
</div>
</li>
<li class="listitem">
<p>You can fetch results by page, with the <code class="literal">results</code> function:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">my_documents = []
while !(documents = scroll_helper.results).empty?
  my_documents &lt;&lt; documents
end
scroll_helper.clear</pre>
</div>
</li>
</ol>
</div>
<h3><a id="esql-helper"></a>ES|QL Helper<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/8.13/docs/helpers.asciidoc">edit</a></h3>
<p>This functionality is Experimental and may be changed or removed completely in a future release. If you have any feedback on this helper, please <a href="https://github.com/elastic/elasticsearch-ruby/issues/new/choose" class="ulink" target="_top">let us know</a>.</p>
<p>The helper provides an object response from the ESQL <code class="literal">query</code> API instead of the default JSON value.</p>
<p>To use the ES|QL helper, require it in your code:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">require 'elasticsearch/helpers/esql_helper'</pre>
</div>
<p>By default, the <code class="literal">query</code> API returns a Hash response with <code class="literal">columns</code> and <code class="literal">values</code> like so:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">query = &lt;&lt;ESQL
        FROM sample_data
        | EVAL duration_ms = ROUND(event.duration / 1000000.0, 1)
ESQL

response = client.esql.query(body: { query: query})
puts response

{"columns"=&gt;[
  {"name"=&gt;"@timestamp", "type"=&gt;"date"},
  {"name"=&gt;"client.ip", "type"=&gt;"ip"},
  {"name"=&gt;"event.duration", "type"=&gt;"long"},
  {"name"=&gt;"message", "type"=&gt;"keyword"},
  {"name"=&gt;"duration_ms", "type"=&gt;"double"}
],
"values"=&gt;[
  ["2023-10-23T12:15:03.360Z", "172.21.2.162", 3450233, "Connected to 10.1.0.3", 3.5],
  ["2023-10-23T12:27:28.948Z", "172.21.2.113", 2764889, "Connected to 10.1.0.2", 2.8],
  ["2023-10-23T13:33:34.937Z", "172.21.0.5", 1232382, "Disconnected", 1.2],
  ["2023-10-23T13:51:54.732Z", "172.21.3.15", 725448, "Connection error", 0.7],
  ["2023-10-23T13:52:55.015Z", "172.21.3.15", 8268153, "Connection error", 8.3],
  ["2023-10-23T13:53:55.832Z", "172.21.3.15", 5033755, "Connection error", 5.0],
  ["2023-10-23T13:55:01.543Z", "172.21.3.15", 1756467, "Connected to 10.1.0.1", 1.8]
]}</pre>
</div>
<p>The helper returns an array of hashes with the columns as keys and the respective values. So for the previous example, it would return the following:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">response = Elasticsearch::Helpers::ESQLHelper.query(client, query)

puts response

{"duration_ms"=&gt;3.5, "message"=&gt;"Connected to 10.1.0.3", "event.duration"=&gt;3450233, "client.ip"=&gt;"172.21.2.162", "@timestamp"=&gt;"2023-10-23T12:15:03.360Z"}
{"duration_ms"=&gt;2.8, "message"=&gt;"Connected to 10.1.0.2", "event.duration"=&gt;2764889, "client.ip"=&gt;"172.21.2.113", "@timestamp"=&gt;"2023-10-23T12:27:28.948Z"}
{"duration_ms"=&gt;1.2, "message"=&gt;"Disconnected", "event.duration"=&gt;1232382, "client.ip"=&gt;"172.21.0.5", "@timestamp"=&gt;"2023-10-23T13:33:34.937Z"}
{"duration_ms"=&gt;0.7, "message"=&gt;"Connection error", "event.duration"=&gt;725448, "client.ip"=&gt;"172.21.3.15", "@timestamp"=&gt;"2023-10-23T13:51:54.732Z"}
{"duration_ms"=&gt;8.3, "message"=&gt;"Connection error", "event.duration"=&gt;8268153, "client.ip"=&gt;"172.21.3.15", "@timestamp"=&gt;"2023-10-23T13:52:55.015Z"}</pre>
</div>
<p>Additionally, you can transform the data in the response by passing in a Hash of <code class="literal">column =&gt; Proc</code> values. You could use this for example to convert <em>@timestamp</em> into a DateTime object. Pass in a Hash to <code class="literal">query</code> as a <code class="literal">parser</code> defining a <code class="literal">Proc</code> for each value you&#8217;d like to parse:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">require 'elasticsearch/helpers/esql_helper'

parser = {
  '@timestamp' =&gt; Proc.new { |t| DateTime.parse(t) }
}
response = Elasticsearch::Helpers::ESQLHelper.query(client, query, parser: parser)
response.first['@timestamp']
# &lt;DateTime: 2023-10-23T12:15:03+00:00 ((2460241j,44103s,360000000n),+0s,2299161j)&gt;</pre>
</div>
<p>You can pass in as many Procs as there are columns in the response. For example:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">parser = {
  '@timestamp' =&gt; Proc.new { |t| DateTime.parse(t) },
  'client.ip' =&gt; Proc.new { |i| IPAddr.new(i) },
  'event.duration' =&gt; Proc.new { |d| d.to_s }
}

response = Elasticsearch::Helpers::ESQLHelper.query(client, query, parser: parser)

puts response

{"duration_ms"=&gt;3.5, "message"=&gt;"Connected to 10.1.0.3", "event.duration"=&gt;"3450233", "client.ip"=&gt;#&lt;IPAddr: IPv4:172.21.2.162/255.255.255.255&gt;, "@timestamp"=&gt;#&lt;DateTime: 2023-10-23T12:15:03+00:00 ((2460241j,44103s,360000000n),+0s,2299161j)&gt;}
{"duration_ms"=&gt;2.8, "message"=&gt;"Connected to 10.1.0.2", "event.duration"=&gt;"2764889", "client.ip"=&gt;#&lt;IPAddr: IPv4:172.21.2.113/255.255.255.255&gt;, "@timestamp"=&gt;#&lt;DateTime: 2023-10-23T12:27:28+00:00 ((2460241j,44848s,948000000n),+0s,2299161j)&gt;}
{"duration_ms"=&gt;1.2, "message"=&gt;"Disconnected", "event.duration"=&gt;"1232382", "client.ip"=&gt;#&lt;IPAddr: IPv4:172.21.0.5/255.255.255.255&gt;, "@timestamp"=&gt;#&lt;DateTime: 2023-10-23T13:33:34+00:00 ((2460241j,48814s,937000000n),+0s,2299161j)&gt;}
{"duration_ms"=&gt;0.7, "message"=&gt;"Connection error", "event.duration"=&gt;"725448", "client.ip"=&gt;#&lt;IPAddr: IPv4:172.21.3.15/255.255.255.255&gt;, "@timestamp"=&gt;#&lt;DateTime: 2023-10-23T13:51:54+00:00 ((2460241j,49914s,732000000n),+0s,2299161j)&gt;}
{"duration_ms"=&gt;8.3, "message"=&gt;"Connection error", "event.duration"=&gt;"8268153", "client.ip"=&gt;#&lt;IPAddr: IPv4:172.21.3.15/255.255.255.255&gt;, "@timestamp"=&gt;#&lt;DateTime: 2023-10-23T13:52:55+00:00 ((2460241j,49975s,15000000n),+0s,2299161j)&gt;}</pre>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="troubleshooting.html">« Troubleshooting</a>
</span>
<span class="next">
<a href="release_notes.html">Release Notes »</a>
</span>
</div>
</div>
</body>
</html>
