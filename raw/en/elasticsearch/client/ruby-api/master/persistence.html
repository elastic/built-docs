<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Persistence | Ruby and Rails Integrations [master] | Elastic</title>
<link rel="home" href="index.html" title="Ruby and Rails Integrations [master]"/>
<link rel="up" href="index.html" title="Ruby and Rails Integrations [master]"/>
<link rel="prev" href="ruby_on_rails.html" title="Ruby On Rails"/>
<link rel="next" href="release_notes.html" title="Release Notes"/>
<meta name="DC.type" content="Learn/Docs/Clients/Ruby/master"/>
<meta name="DC.subject" content="Clients"/>
<meta name="DC.identifier" content="master"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Ruby and Rails Integrations [master]</a></span>
»
<span class="breadcrumb-node">Persistence</span>
</div>
<div class="navheader">
<span class="prev">
<a href="ruby_on_rails.html">« Ruby On Rails</a>
</span>
<span class="next">
<a href="release_notes.html">Release Notes »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="persistence"></a>Persistence<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/persistence.asciidoc">edit</a></h1>
</div></div></div>
<p>The <code class="literal">elasticsearch-persistence</code> <a href="http://rubygems.org/gems/elasticsearch-persistence" class="ulink" target="_top">Rubygem</a>
provides persistence layer for Ruby domain objects.</p>
<p>It supports the repository design patterns. Versions before 6.0 also supported the <em>active record</em> design pattern.</p>
<h3><a id="_repository"></a>Repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/persistence.asciidoc">edit</a></h3>
<p>The <code class="literal">Elasticsearch::Persistence::Repository</code> module provides an implementation of the repository pattern and allows to save, delete, find and search objects stored in Elasticsearch, as well as configure mappings and settings for the index.</p>
<h4><a id="_features_4"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/persistence.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Access to the Elasticsearch client
</li>
<li class="listitem">
Setting the index name, document type, and object class for deserialization
</li>
<li class="listitem">
Composing mappings and settings for the index
</li>
<li class="listitem">
Creating, deleting or refreshing the index
</li>
<li class="listitem">
Finding or searching for documents
</li>
<li class="listitem">
Providing access both to domain objects and hits for search results
</li>
<li class="listitem">
Providing access to the Elasticsearch response for search results (aggregations, total, &#8230;&#8203;)
</li>
<li class="listitem">
Defining the methods for serialization and deserialization
</li>
</ul>
</div>
<h4><a id="_usage_2"></a>Usage<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/persistence.asciidoc">edit</a></h4>
<p>Let&#8217;s have a simple plain old Ruby object (PORO):</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">class Note
  attr_reader :attributes

  def initialize(attributes={})
    @attributes = attributes
  end

  def to_hash
    @attributes
  end
end</pre>
</div>
<p>Let&#8217;s create a default, "dumb" repository, as a first step:</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">require 'elasticsearch/persistence'
class MyRepository; include Elasticsearch::Persistence::Repository; end
repository = MyRepository.new</pre>
</div>
<p>We can save a <code class="literal">Note</code> instance into the repository&#8230;&#8203;</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">note = Note.new id: 1, text: 'Test'

repository.save(note)
# PUT http://localhost:9200/repository/_doc/1 [status:201, request:0.210s, query:n/a]
# &gt; {"id":1,"text":"Test"}
# &lt; {"_index":"repository","_type":"note","_id":"1","_version":1,"created":true}</pre>
</div>
<p>&#8230;&#8203;find it&#8230;&#8203;</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">n = repository.find(1)
# GET http://localhost:9200/repository/_doc/1 [status:200, request:0.003s, query:n/a]
# &lt; {"_index":"repository","_type":"note","_id":"1","_version":2,"found":true, "_source" : {"id":1,"text":"Test"}}
=&gt; &lt;Note:0x007fcbfc0c4980 @attributes={"id"=&gt;1, "text"=&gt;"Test"}&gt;</pre>
</div>
<p>&#8230;&#8203;search for it&#8230;&#8203;</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">repository.search(query: { match: { text: 'test' } }).first
# GET http://localhost:9200/repository/_search [status:200, request:0.005s, query:0.002s]
# &gt; {"query":{"match":{"text":"test"}}}
# &lt; {"took":2, ... "hits":{"total":1, ... "hits":[{ ... "_source" : {"id":1,"text":"Test"}}]}}
=&gt; &lt;Note:0x007fcbfc1c7b70 @attributes={"id"=&gt;1, "text"=&gt;"Test"}&gt;</pre>
</div>
<p>&#8230;&#8203;or delete it:</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">repository.delete(note)
# DELETE http://localhost:9200/repository/_doc/1 [status:200, request:0.014s, query:n/a]
# &lt; {"found":true,"_index":"repository","_type":"note","_id":"1","_version":3}
=&gt; {"found"=&gt;true, "_index"=&gt;"repository", "_type"=&gt;"note", "_id"=&gt;"1", "_version"=&gt;2}</pre>
</div>
<p>The repository module provides a number of features and facilities to configure and customize the behaviour,
as well as support for extending your own, custom repository class.</p>
<p>Please refer to the
<a href="https://github.com/elastic/elasticsearch-rails/tree/master/elasticsearch-persistence#the-repository-pattern" class="ulink" target="_top">documentation</a>
for more information.</p>
<p>Also, check out the
<a href="https://github.com/elastic/elasticsearch-rails/tree/master/elasticsearch-persistence#example-application" class="ulink" target="_top">example application</a> which demonstrates the usage patterns of the <em>repository</em> approach to persistence.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="ruby_on_rails.html">« Ruby On Rails</a>
</span>
<span class="next">
<a href="release_notes.html">Release Notes »</a>
</span>
</div>
</div>
</body>
</html>
