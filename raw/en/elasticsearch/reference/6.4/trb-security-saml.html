<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Common SAML issues | Elasticsearch Reference [6.4] | Elastic</title>
<link rel="home" href="index.html" title="Elasticsearch Reference [6.4]"/>
<link rel="up" href="security-troubleshooting.html" title="Troubleshooting security"/>
<link rel="prev" href="trb-security-kerberos.html" title="Common Kerberos exceptions"/>
<link rel="next" href="trb-security-internalserver.html" title="Internal Server Error in Kibana"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/6.4"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="6.4"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference [6.4]</a></span>
»
<span class="breadcrumb-link"><a href="secure-cluster.html">Secure a cluster</a></span>
»
<span class="breadcrumb-link"><a href="security-troubleshooting.html">Troubleshooting security</a></span>
»
<span class="breadcrumb-node">Common SAML issues</span>
</div>
<div class="navheader">
<span class="prev">
<a href="trb-security-kerberos.html">« Common Kerberos exceptions</a>
</span>
<span class="next">
<a href="trb-security-internalserver.html">Internal Server Error in Kibana »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="trb-security-saml"></a>Common SAML issues<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/6.4/x-pack/docs/en/security/troubleshooting.asciidoc">edit</a></h2>
</div></div></div>
<p>Some of the common SAML problems are shown below with tips on how to resolve
these issues.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Authentication in Kibana fails and the following error is printed in the Elasticsearch
logs:</p>
<pre class="literallayout">Cannot find any matching realm for [SamlPrepareAuthenticationRequest{realmName=null,
assertionConsumerServiceURL=https://my.kibana.url/api/security/v1/saml}]</pre>

<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>Elasticsearch, Kibana and your Identity Provider need all have the same view on what the
Assertion Consumer Service URL of the SAML Service Provider is.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Elasticsearch discovers this via the <code class="literal">sp.acs</code> setting in your Elasticsearch SAML realm configuration
</li>
<li class="listitem">
<p>Kibana constructs this value using the <code class="literal">server.host</code> and <code class="literal">server.port</code> in
<code class="literal">kibana.yml</code>. For instance:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">server.host: kibanaserver.org
server.port: 3456</pre>
</div>
<p>These settings would mean that Kibana would construct the Assertion Consumer
Service URL as <code class="literal">https://kibanaserver.org:3456/api/security/v1/saml</code>. However,
if for example, Kibana is behind a reverse proxy and you have configured the
following  <code class="literal">xpack.security.public.*</code> settings:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">xpack.security.public:
  protocol: https
  hostname: kibana.proxy.com
  port: 8080</pre>
</div>
<p>These settings would instruct Kibana to construct the Assertion Consumer Service
URL as <code class="literal">https://kibana.proxy.com:8080/api/security/v1/saml</code></p>
</li>
<li class="listitem">
The SAML Identity Provider is either explicitly configured by the IdP
administrator or consumes the SAML metadata that are generated by Elasticsearch and as
such contain the same value for the
as the one
that is configured in the the <code class="literal">sp.acs</code> setting in the Elasticsearch SAML realm
configuration.
</li>
</ol>
</div>
<p>The error encountered here indicates that the Assertion Consumer Service URL
that Kibana has constructed via one of the aforementioned ways
(<code class="literal">https://my.kibana.url/api/security/v1/saml</code>) is not the one that Elasticsearch is
configured with. Note that these two URLs are compared as case-sensitive strings
and not as canonicalized URLs.</p>
<p>Often, this can be resolved by changing the <code class="literal">sp.acs</code> URL in <code class="literal">elasticearch.yml</code>
to match the value that Kibana has constructed. Note however, that the SAML IdP
configuration needs to also be adjusted to reflect this change.</p>
<p>Alternatively, if you think Kibana is using the wrong value for the Assertion
Consumer Service URL, you will need to change the configuration in <code class="literal">kibana.yml</code>
by adjusting either the <code class="literal">server.host</code> and <code class="literal">server.port</code> to change the URL Kibana
listens to or the <code class="literal">xpack.security.public.*</code> settings to make Kibana aware about
its correct public URL.</p>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Authentication in Kibana fails and the following error is printed in the
Elasticsearch logs:</p>
<pre class="literallayout">Authentication to realm saml1 failed - Provided SAML response is not valid for realm
saml/saml1 (Caused by ElasticsearchSecurityException[Conditions [https://some-url-here...]
do not match required audience [https://my.kibana.url]])</pre>

<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>We received a SAML response that is addressed to another SAML Service Provider.
This usually means that the configured SAML Service Provider Entity ID in
<code class="literal">elasticsearch.yml</code> (<code class="literal">sp.entity_id</code>) does not match what has been configured as
the SAML Service Provider Entity ID in the SAML Identity Provider documentation.</p>
<p>To resolve this issue, ensure that both the saml realm in Elasticsearch and the IdP are
configured with the same string for the SAML Entity ID of the Service Provider.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>These strings are compared as case-sensitive strings and not as
canonicalized URLs even when the values are URL-like. Be mindful of trailing
slashes, port numbers, etc.</p>
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Authentication in Kibana fails and the following error is printed in the
Elasticsearch logs:</p>
<pre class="literallayout">Cannot find metadata for entity [your:entity.id] in [metadata.xml]</pre>

<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>We could not find the metadata for the SAML Entity ID <code class="literal">your:entity.id</code> in the
configured metadata file (<code class="literal">metadata.xml</code>).</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Ensure that the <code class="literal">metadata.xml</code> file you are using is indeed the one provided
by your SAML Identity Provider.
</li>
<li class="listitem">
Ensure that the <code class="literal">metadata.xml</code> file contains one &lt;EntityDescriptor&gt; element
as follows: <code class="literal">&lt;EntityDescriptor ID="0597c9aa-e69b-46e7-a1c6-636c7b8a8070" entityID="https://saml.example.com/f174199a-a96e-4201-88f1-0d57a610c522/" ...</code>
where the value of the <code class="literal">entityID</code> attribute is the same as the value of the
<code class="literal">idp.entity_id</code> that you have set in your SAML realm configuration in
<code class="literal">elasticsearch.yml</code>.
</li>
<li class="listitem">
Note that these are also compared as case-sensitive strings and not as
canonicalized URLs even when the values are URL-like.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Authentication in Kibana fails and the following error is printed in the Elasticsearch
logs:</p>
<pre class="literallayout">unable to authenticate user [&lt;unauthenticated-saml-user&gt;]
for action [cluster:admin/xpack/security/saml/authenticate]</pre>

<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>This error indicates that Elasticsearch failed to process the incoming SAML
authentication message. Since the message can&#8217;t be processed, Elasticsearch is not aware
of who the to-be authenticated user is and the <code class="literal">&lt;unauthenticated-saml-user&gt;</code>
placeholder is used instead. To diagnose the <em>actual</em> problem, you must check
the Elasticsearch logs for further details.</p>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Authentication in Kibana fails and the following error is printed in the
Elasticsearch logs:</p>
<pre class="literallayout">Authentication to realm my-saml-realm failed -
Provided SAML response is not valid for realm saml/my-saml-realm
(Caused by ElasticsearchSecurityException[SAML Response is not a 'success' response:
Code=urn:oasis:names:tc:SAML:2.0:status:AuthnFailed Message=null Detail=null])</pre>

<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>This means that the SAML Identity Provider failed to authenticate the user and
sent a SAML Response to the Service Provider (Elastic Stack) indicating this failure.
The <code class="literal">Code</code>, <code class="literal">Message</code> and <code class="literal">Detail</code> can convey different error identifiers and
additional information that might offer an indication about the cause of the
failure. In case <code class="literal">Message</code> and <code class="literal">Detail</code> are null, please consult the logs and
documentation of the Identity Provider in order to further diagnose the problem.</p>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Authentication in Kibana fails and the following error is printed in the
Elasticsearch logs:</p>
<pre class="literallayout">The XML Signature of this SAML message cannot be validated. Please verify that the saml
realm uses the correct SAMLmetadata file/URL for this Identity Provider</pre>

<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>This means that Elasticsearch failed to validate the digital signature of the SAML
message that the Identity Provider sent. Elasticsearch uses the public key of the
Identity Provider that is included in the SAML metadata, in order to validate
the signature that the IdP has created using its corresponding private key.
Failure to do so, can have a number of causes:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
As the error message indicates, the most common cause is that the wrong
metadata file is used and as such the public key it contains doesn&#8217;t correspond
to the private key the Identity Provider uses.
</li>
<li class="listitem">
The configuration of the Identity Provider has changed or the key has been
rotated and the metadata file that Elasticsearch is using has not been updated.
</li>
<li class="listitem">
The SAML Response has been altered in transit and the signature cannot be
validated even though the correct key is used.
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The private keys and public keys and self-signed X.509 certificates that
are used in SAML for digital signatures as described above have no relation to
the keys and certificates that are used for TLS either on the transport or the
http layer. A failure such as the one described above has nothing to do with
your <code class="literal">xpack.ssl</code> related configuration.</p>
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<p>Users are unable to login with a local username and password in Kibana because
SAML is enabled.</p>
<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>If you want your users to be able to use local credentials to authenticate to
Kibana in addition to using the SAML realm for Single Sign-On, you must enable
the <code class="literal">basic</code> <code class="literal">authProvider</code> in Kibana. The process is documented in the
<a class="xref" href="saml-kibana.html#saml-kibana-basic" title="Supporting SAML and basic authentication in Kibana">SAML Guide</a></p>
</li>
</ol>
</div>
<p><span class="strong strong"><strong>Logging:</strong></span></p>
<p>Very detailed trace logging can be enabled specifically for the SAML realm by
setting the following transient setting:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">PUT /_cluster/settings
{
  "transient": {
    "logger.org.elasticsearch.xpack.security.authc.saml": "trace"
  }
}</pre>
</div>
<p>Alternatively, you can add the following lines to the end of the
<code class="literal">log4j2.properties</code> configuration file in the <code class="literal">ES_PATH_CONF</code>:</p>
<div class="pre_wrapper lang-properties">
<pre class="programlisting prettyprint lang-properties">logger.saml.name = org.elasticsearch.xpack.security.authc.saml
logger.saml.level = TRACE</pre>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="trb-security-kerberos.html">« Common Kerberos exceptions</a>
</span>
<span class="next">
<a href="trb-security-internalserver.html">Internal Server Error in Kibana »</a>
</span>
</div>
</div>
</body>
</html>
