<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Nested Query | Elasticsearch Reference [6.6] | Elastic</title>
<link rel="home" href="index.html" title="Elasticsearch Reference [6.6]"/>
<link rel="up" href="joining-queries.html" title="Joining queries"/>
<link rel="prev" href="joining-queries.html" title="Joining queries"/>
<link rel="next" href="query-dsl-has-child-query.html" title="Has Child Query"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/6.6"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="6.6"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference [6.6]</a></span>
»
<span class="breadcrumb-link"><a href="query-dsl.html">Query DSL</a></span>
»
<span class="breadcrumb-link"><a href="joining-queries.html">Joining queries</a></span>
»
<span class="breadcrumb-node">Nested Query</span>
</div>
<div class="navheader">
<span class="prev">
<a href="joining-queries.html">« Joining queries</a>
</span>
<span class="next">
<a href="query-dsl-has-child-query.html">Has Child Query »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-nested-query"></a>Nested Query<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/6.6/docs/reference/query-dsl/nested-query.asciidoc">edit</a></h2>
</div></div></div>
<p>Nested query allows to query nested objects / docs (see
<a class="xref" href="nested.html" title="Nested datatype">nested mapping</a>). The
query is executed against the nested objects / docs as if they were
indexed as separate docs (they are, internally) and resulting in the
root parent doc (or parent nested mapping). Here is a sample mapping we
will work with:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /my_index
{
    "mappings": {
        "_doc" : {
            "properties" : {
                "obj1" : {
                    "type" : "nested"
                }
            }
        }
    }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/895.console"></div>
<p>And here is a sample nested query usage:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
    "query": {
        "nested" : {
            "path" : "obj1",
            "score_mode" : "avg",
            "query" : {
                "bool" : {
                    "must" : [
                    { "match" : {"obj1.name" : "blue"} },
                    { "range" : {"obj1.count" : {"gt" : 5}} }
                    ]
                }
            }
        }
    }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/896.console"></div>
<p>The query <code class="literal">path</code> points to the nested object path, and the <code class="literal">query</code>
includes the query that will run on the nested docs matching the
direct path, and joining with the root parent docs. Note that any
fields referenced inside the query must use the complete path (fully
qualified).</p>
<p>The <code class="literal">score_mode</code> allows to set how inner children matching affects
scoring of parent. It defaults to <code class="literal">avg</code>, but can be <code class="literal">sum</code>, <code class="literal">min</code>,
<code class="literal">max</code> and <code class="literal">none</code>.</p>
<p>There is also an <code class="literal">ignore_unmapped</code> option which, when set to <code class="literal">true</code> will
ignore an unmapped <code class="literal">path</code> and will not match any documents for this query.
This can be useful when querying multiple indexes which might have different
mappings. When set to <code class="literal">false</code> (the default value) the query will throw an
exception if the <code class="literal">path</code> is not mapped.</p>
<p>Multi level nesting is automatically supported, and detected, resulting
in an inner nested query to automatically match the relevant nesting
level (and not root) if it exists within another nested query.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="joining-queries.html">« Joining queries</a>
</span>
<span class="next">
<a href="query-dsl-has-child-query.html">Has Child Query »</a>
</span>
</div>
</div>
</body>
</html>
