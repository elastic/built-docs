<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Complex Conditionals | Elasticsearch Reference [7.x] | Elastic</title>
<link rel="home" href="index.html" title="Elasticsearch Reference [7.x]"/>
<link rel="up" href="ingest-conditionals.html" title="Conditional Execution in Pipelines"/>
<link rel="prev" href="ingest-conditional-nullcheck.html" title="Handling Nested Fields in Conditionals"/>
<link rel="next" href="conditionals-with-multiple-pipelines.html" title="Conditionals with the Pipeline Processor"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/7.x"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="7.x"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference [7.x]</a></span>
»
<span class="breadcrumb-link"><a href="ingest.html">Ingest node</a></span>
»
<span class="breadcrumb-link"><a href="ingest-conditionals.html">Conditional Execution in Pipelines</a></span>
»
<span class="breadcrumb-node">Complex Conditionals</span>
</div>
<div class="navheader">
<span class="prev">
<a href="ingest-conditional-nullcheck.html">« Handling Nested Fields in Conditionals</a>
</span>
<span class="next">
<a href="conditionals-with-multiple-pipelines.html">Conditionals with the Pipeline Processor »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="ingest-conditional-complex"></a>Complex Conditionals<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/ingest/ingest-node.asciidoc">edit</a></h2>
</div></div></div>
<p>The <code class="literal">if</code> condition can be more complex than a simple equality check.
The full power of the <a class="xref" href="modules-scripting-painless.html" title="Painless scripting language">Painless Scripting Language</a> is available and
running in the <a href="/guide/en/elasticsearch/painless/7.x/painless-ingest-processor-context.html" class="ulink" target="_top">ingest processor context</a>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>The value of ctx is read-only in <code class="literal">if</code> conditions.</p>
</div>
</div>
<p>A more complex <code class="literal">if</code> condition that drops the document (i.e. not index it)
unless it has a multi-valued tag field with at least one value that contains the characters
<code class="literal">prod</code> (case insensitive).</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ingest/pipeline/not_prod_dropper
{
  "processors": [
    {
      "drop": {
        "if": "Collection tags = ctx.tags;if(tags != null){for (String tag : tags) {if (tag.toLowerCase().contains('prod')) { return false;}}} return true;"
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/589.console"></div>
<p>The conditional needs to be all on one line since JSON does not
support new line characters. However, Kibana&#8217;s console supports
a triple quote syntax to help with writing and debugging
scripts like these.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ingest/pipeline/not_prod_dropper
{
  "processors": [
    {
      "drop": {
        "if": """
            Collection tags = ctx.tags;
            if(tags != null){
              for (String tag : tags) {
                  if (tag.toLowerCase().contains('prod')) {
                      return false;
                  }
              }
            }
            return true;
        """
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/590.console"></div>
<p>or it can be built with a stored script:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _scripts/not_prod
{
  "script": {
    "lang": "painless",
    "source": """
        Collection tags = ctx.tags;
        if(tags != null){
          for (String tag : tags) {
              if (tag.toLowerCase().contains('prod')) {
                  return false;
              }
          }
        }
        return true;
    """
  }
}
PUT _ingest/pipeline/not_prod_dropper
{
  "processors": [
    {
      "drop": {
        "if": { "id": "not_prod" }
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/591.console"></div>
<p>Either way, you can run it with:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST test/_doc/1?pipeline=not_prod_dropper
{
  "tags": ["application:myapp", "env:Stage"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/592.console"></div>
<p>The document is <a class="xref" href="drop-processor.html" title="Drop processor">dropped</a> since <code class="literal">prod</code> (case insensitive)
is not found in the tags.</p>
<p>The following document is indexed (i.e. not dropped) since
<code class="literal">prod</code> (case insensitive) is found in the tags.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST test/_doc/2?pipeline=not_prod_dropper
{
  "tags": ["application:myapp", "env:Production"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/593.console"></div>
<p>The <a class="xref" href="simulate-pipeline-api.html" title="Simulate pipeline API">Simulate pipeline</a> with verbose can be used to help build out
complex conditionals. If the conditional evaluates to false it will be
omitted from the verbose results of the simulation since the document will not change.</p>
<p>Care should be taken to avoid overly complex or expensive conditional checks
since the condition needs to be checked for each and every document.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="ingest-conditional-nullcheck.html">« Handling Nested Fields in Conditionals</a>
</span>
<span class="next">
<a href="conditionals-with-multiple-pipelines.html">Conditionals with the Pipeline Processor »</a>
</span>
</div>
</div>
</body>
</html>
