<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Text expansion query | Elasticsearch Guide [8.11] | Elastic</title>
<meta class="elastic" name="content" content="Text expansion query | Elasticsearch Guide [8.11]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.11]"/>
<link rel="up" href="query-dsl.html" title="Query DSL"/>
<link rel="prev" href="query-dsl-wildcard-query.html" title="Wildcard query"/>
<link rel="next" href="query-dsl-minimum-should-match.html" title="minimum_should_match parameter"/>
<meta class="elastic" name="product_version" content="8.11"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.11"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.11"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="query-dsl-wildcard-query.html">« Wildcard query</a>
</span>
<span class="next">
<a href="query-dsl-minimum-should-match.html"><code class="literal">minimum_should_match</code> parameter »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.11]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="query-dsl.html">Query DSL</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Text expansion query</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.11/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-text-expansion-query"></a>Text expansion query<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.11/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></h2>
</div></div></div>

<p>The text expansion query uses a natural language processing model to convert the query text into a
list of token-weight pairs which are then used in a query against a
<a class="xref" href="sparse-vector.html" title="Sparse vector field type">sparse vector</a> or <a class="xref" href="rank-features.html" title="Rank features field type">rank features</a> field.</p>
<h3><a id="text-expansion-query-ex-request"></a>Example request<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.11/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></h3>
<a id="2155c920d7d860f3ee7542f2211b4fec"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET _search
{
   "query":{
      "text_expansion":{
         "&lt;sparse_vector_field&gt;":{
            "model_id":"the model to produce the token weights",
            "model_text":"the query string"
         }
      }
   }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1249.console"></div>
<h3><a id="text-expansion-query-params"></a>Top level parameters for <code class="literal">text_expansion</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.11/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></h3>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">&lt;sparse_vector_field&gt;</code>
</span>
</dt>
<dd>
(Required, object)
The name of the field that contains the token-weight pairs the NLP model created
based on the input text.
</dd>
</dl>
</div>
<h3><a id="text-expansion-rank-feature-field-params"></a>Top level parameters for <code class="literal">&lt;sparse_vector_field&gt;</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.11/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></h3>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">model_id</code>
</span>
</dt>
<dd>
(Required, string)
The ID of the model to use to convert the query text into token-weight pairs. It
must be the same model ID that was used to create the tokens from the input
text.
</dd>
<dt>
<span class="term">
<code class="literal">model_text</code>
</span>
</dt>
<dd>
(Required, string)
The query text you want to use for search.
</dd>
</dl>
</div>
<h3><a id="text-expansion-query-example"></a>Example<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.11/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></h3>
<p>The following is an example of the <code class="literal">text_expansion</code> query that references the
ELSER model to perform semantic search. For a more detailed description of how
to perform semantic search by using ELSER and the <code class="literal">text_expansion</code> query, refer
to <a class="xref" href="semantic-search-elser.html" title="Tutorial: semantic search with ELSER">this tutorial</a>.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'my-index',
  body: {
    query: {
      text_expansion: {
        'ml.tokens' =&gt; {
          model_id: '.elser_model_1',
          model_text: 'How is the weather in Jamaica?'
        }
      }
    }
  }
)
puts response</pre>
</div>
<a id="f743225f1abcbc341e991a0e79ea89bc"></a>
<div class="pre_wrapper lang-console default has-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby">GET my-index/_search
{
   "query":{
      "text_expansion":{
         "ml.tokens":{
            "model_id":".elser_model_1",
            "model_text":"How is the weather in Jamaica?"
         }
      }
   }
}</pre>
</div>
<div class="console_widget has-ruby" data-snippet="snippets/1250.console"></div>
<h3><a id="optimizing-text-expansion"></a>Optimizing the search performance of the text_expansion query<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.11/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></h3>
<p><a href="/blog/faster-retrieval-of-top-hits-in-elasticsearch-with-block-max-wand" class="ulink" target="_top">Max WAND</a>
is an optimization technique used by Elasticsearch to skip documents that cannot score
competitively against the current best matching documents. However, the tokens
generated by the ELSER model don&#8217;t work well with the Max WAND optimization.
Consequently, enabling Max WAND can actually increase query latency for
<code class="literal">text_expansion</code>. For datasets of a significant size, disabling Max
WAND leads to lower query latencies.</p>
<p>Max WAND is controlled by the
<a class="xref" href="search-your-data.html#track-total-hits" title="Track total hits">track_total_hits</a> query parameter. Setting track_total_hits
to true forces Elasticsearch to consider all documents, resulting in lower query
latencies for the <code class="literal">text_expansion</code> query. However, other Elasticsearch queries run slower
when Max WAND is disabled.</p>
<p>If you are combining the <code class="literal">text_expansion</code> query with standard text queries in a
compound search, it is recommended to measure the query performance before
deciding which setting to use.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <code class="literal">track_total_hits</code> option applies to all queries in the search request
and may be optimal for some queries but not for others. Take into account the
characteristics of all your queries to determine the most suitable
configuration.</p>
</div>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="query-dsl-wildcard-query.html">« Wildcard query</a>
</span>
<span class="next">
<a href="query-dsl-minimum-should-match.html"><code class="literal">minimum_should_match</code> parameter »</a>
</span>
</div>
</body>
</html>
