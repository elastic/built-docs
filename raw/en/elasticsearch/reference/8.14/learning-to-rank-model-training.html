<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Deploy and manage Learning To Rank models | Elasticsearch Guide [8.14] | Elastic</title>
<meta class="elastic" name="content" content="Deploy and manage Learning To Rank models | Elasticsearch Guide [8.14]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.14]"/>
<link rel="up" href="learning-to-rank.html" title="Learning To Rank"/>
<link rel="prev" href="learning-to-rank.html" title="Learning To Rank"/>
<link rel="next" href="learning-to-rank-search-usage.html" title="Search using Learning To Rank"/>
<meta class="elastic" name="product_version" content="8.14"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.14"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.14"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.14]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search-with-elasticsearch.html">Search your data</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="learning-to-rank.html">Learning To Rank</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="learning-to-rank.html">« Learning To Rank</a>
</span>
<span class="next">
<a href="learning-to-rank-search-usage.html">Search using Learning To Rank »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="learning-to-rank-model-training"></a>Deploy and manage Learning To Rank models<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h2>
</div></div></div>

<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>The Learning To Rank feature is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but this feature is not subject to the support SLA of official GA features.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This feature was introduced in version 8.12.0 and is only available to certain subscription levels.
For more information, see <a href="/subscriptions" class="ulink" target="_top">https://www.elastic.co/subscriptions</a>.</p>
</div>
</div>
<h4><a id="learning-to-rank-model-training-workflow"></a>Train and deploy a model using Eland<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h4>
<p>Typically, the <a href="https://xgboost.readthedocs.io/en/stable/" class="ulink" target="_blank" rel="noopener">XGBoost</a> model training process uses standard Python data science tools like Pandas and scikit-learn.</p>
<p>We have developed an
<a href="https://github.com/elastic/elasticsearch-labs/blob/main/notebooks/search/08-learning-to-rank.ipynb" class="ulink" target="_blank" rel="noopener">example
notebook</a> available in the <code class="literal">elasticsearch-labs</code> repo. This interactive Python notebook
details an end-to-end model training and deployment workflow.</p>
<p>We highly recommend using <a href="https://eland.readthedocs.io/" class="ulink" target="_blank" rel="noopener">eland</a> in your workflow, because it provides important functionalities for working with LTR in Elasticsearch. Use eland to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Configure feature extraction
</li>
<li class="listitem">
Extract features for training
</li>
<li class="listitem">
Deploy the model in Elasticsearch
</li>
</ul>
</div>
<h5><a id="learning-to-rank-model-training-feature-definition"></a>Configure feature extraction in Eland<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h5>
<p>Feature extractors are defined using templated queries. <a href="https://eland.readthedocs.io/" class="ulink" target="_blank" rel="noopener">Eland</a> provides the <code class="literal">eland.ml.ltr.QueryFeatureExtractor</code> to define these feature extractors directly in Python:</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">from eland.ml.ltr import QueryFeatureExtractor

feature_extractors=[
    # We want to use the score of the match query for the title field as a feature:
    QueryFeatureExtractor(
        feature_name="title_bm25",
        query={"match": {"title": "{{query}}"}}
    ),
    # We can use a script_score query to get the value
    # of the field rating directly as a feature:
    QueryFeatureExtractor(
        feature_name="popularity",
        query={
            "script_score": {
                "query": {"exists": {"field": "popularity"}},
                "script": {"source": "return doc['popularity'].value;"},
            }
        },
    ),
    # We can execute a script on the value of the query
    # and use the return value as a feature:
    QueryFeatureExtractor(
        feature_name="query_length",
        query={
            "script_score": {
                "query": {"match_all": {}},
                "script": {
                    "source": "return params['query'].splitOnToken(' ').length;",
                    "params": {
                        "query": "{{query}}",
                    }
                },
            }
        },
    ),
]</pre>
</div>
<p>Once the feature extractors have been defined, they are wrapped in an <code class="literal">eland.ml.ltr.LTRModelConfig</code> object for use in later training steps:</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">from eland.ml.ltr import LTRModelConfig

ltr_config = LTRModelConfig(feature_extractors)</pre>
</div>
<h5><a id="learning-to-rank-model-training-feature-extraction"></a>Extracting features for training<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h5>
<p>Building your dataset is a critical step in the training process. This involves
extracting relevant features and adding them to your judgment list. We
recommend using Eland&#8217;s <code class="literal">eland.ml.ltr.FeatureLogger</code> helper class for this
process.</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">from eland.ml.ltr import FeatureLogger

# Create a feature logger that will be used to query {es} to retrieve the features:
feature_logger = FeatureLogger(es_client, MOVIE_INDEX, ltr_config)</pre>
</div>
<p>The FeatureLogger provides an <code class="literal">extract_features</code> method which enables you to extract features for a list of specific documents from your judgment list. At the same time, you can pass query parameters to the feature extractors defined earlier:</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">feature_logger.extract_features(
    query_params={"query": "foo"},
    doc_ids=["doc-1", "doc-2"]
)</pre>
</div>
<p>Our <a href="https://github.com/elastic/elasticsearch-labs/blob/main/notebooks/search/08-learning-to-rank.ipynb" class="ulink" target="_blank" rel="noopener">example notebook</a> explains how to use the <code class="literal">FeatureLogger</code> to build a training dataset, by adding features to a judgment list.</p>
<h6><a id="learning-to-rank-model-training-feature-extraction-notes"></a>Notes on feature extraction<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h6>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
We strongly advise against implementing feature extraction on your own. It&#8217;s crucial to maintain consistency in feature extraction between the training environment and inference in Elasticsearch. By using eland tooling, which is developed and tested in tandem with Elasticsearch, you can ensure that they function together consistently.
</li>
<li class="listitem">
Feature extraction is performed by executing queries on the Elasticsearch server. This could put a lot of stress on your cluster, especially when your judgment list contains a lot of examples or you have many features. Our feature logger implementation is designed to minimize the number of search requests sent to the server and reduce load. However, it might be best to build your training dataset using an Elasticsearch cluster that is isolated from any user-facing, production traffic.
</li>
</ul>
</div>
<h5><a id="learning-to-rank-model-deployment"></a>Deploy your model into Elasticsearch<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h5>
<p>Once your model is trained you will be able to deploy it in your Elasticsearch cluster. You can use Eland&#8217;s <code class="literal">MLModel.import_ltr_model method</code>:</p>
<div class="pre_wrapper lang-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python">from eland.ml import MLModel

LEARNING_TO_RANK_MODEL_ID="ltr-model-xgboost"

MLModel.import_ltr_model(
    es_client=es_client,
    model=ranker,
    model_id=LEARNING_TO_RANK_MODEL_ID,
    ltr_model_config=ltr_config,
    es_if_exists="replace",
)</pre>
</div>
<p>This method will serialize the trained model and the Learning To Rank configuration (including feature extraction) in a format that Elasticsearch can understand. The model is then deployed to Elasticsearch using the <a class="xref" href="put-trained-models.html" title="Create trained models API">Create Trained Models API</a>.</p>
<p>The following types of models are currently supported for LTR with Elasticsearch:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeRegressor.html" class="ulink" target="_blank" rel="noopener"><code class="literal">DecisionTreeRegressor</code></a>
</li>
<li class="listitem">
<a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html" class="ulink" target="_blank" rel="noopener"><code class="literal">RandomForestRegressor</code></a>
</li>
<li class="listitem">
<a href="https://lightgbm.readthedocs.io/en/latest/pythonapi/lightgbm.LGBMRegressor.html" class="ulink" target="_blank" rel="noopener"><code class="literal">LGBMRegressor</code></a>
</li>
<li class="listitem">
<a href="https://xgboost.readthedocs.io/en/stable/python/python_api.html#xgboost.XGBRanker" class="ulink" target="_blank" rel="noopener"><code class="literal">XGBRanker</code></a>
</li>
<li class="listitem">
<a href="https://xgboost.readthedocs.io/en/stable/python/python_api.html#xgboost.XGBRegressor" class="ulink" target="_blank" rel="noopener"><code class="literal">XGBRegressor</code></a>
</li>
</ul>
</div>
<p>More model types will be supported in the future.</p>
<h4><a id="learning-to-rank-model-management"></a>Learning To Rank model management<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/learning-to-rank-model-training.asciidoc">edit</a></h4>
<p>Once your model is deployed in Elasticsearch you can manage it using the <a href="/guide/en/elasticsearch/reference/current/ml-df-trained-models-apis.html" class="ulink" target="_top">trained model APIs</a>.
You&#8217;re now ready to work with your LTR model as a rescorer at <a class="xref" href="learning-to-rank-search-usage.html" title="Search using Learning To Rank">search time</a>.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="learning-to-rank.html">« Learning To Rank</a>
</span>
<span class="next">
<a href="learning-to-rank-search-usage.html">Search using Learning To Rank »</a>
</span>
</div>
</div>
</body>
</html>
