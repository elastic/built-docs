<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Searching with query rules | Elasticsearch Guide [8.14] | Elastic</title>
<meta class="elastic" name="content" content="Searching with query rules | Elasticsearch Guide [8.14]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.14]"/>
<link rel="up" href="search-your-data.html" title="The search API"/>
<link rel="prev" href="search-shard-routing.html" title="Search shard routing"/>
<link rel="next" href="search-template.html" title="Search templates"/>
<meta class="elastic" name="product_version" content="8.14"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.14"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.14"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.14]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search-with-elasticsearch.html">Search your data</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search-your-data.html">The search API</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="search-shard-routing.html">« Search shard routing</a>
</span>
<span class="next">
<a href="search-template.html">Search templates »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-using-query-rules"></a>Searching with query rules<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/search-using-query-rules.asciidoc">edit</a></h2>
</div></div></div>

<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p><em>Query rules</em> allow customization of search results for queries that match specified criteria metadata.
This allows for more control over results, for example ensuring that promoted documents that match defined criteria are returned at the top of the result list.
Metadata is defined in the query rule, and is matched against the query criteria.
Query rules use metadata to match a query.
Metadata is provided as part of the <code class="literal">rule_query</code> as an object and can be anything that helps differentiate the query, for example:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
A user-entered query string
</li>
<li class="listitem">
Personalized metadata about users (e.g. country, language, etc)
</li>
<li class="listitem">
A particular topic
</li>
<li class="listitem">
A referring site
</li>
<li class="listitem">
etc.
</li>
</ul>
</div>
<p>Query rules define a metadata key that will be used to match the metadata provided in the <code class="literal">rule_query</code> with the criteria specified in the rule.</p>
<p>When a query rule matches the <code class="literal">rule_query</code> metadata according to its defined criteria, the query rule action is applied to the underlying <code class="literal">organic_query</code>.</p>
<p>For example, a query rule could be defined to match a user-entered query string of <code class="literal">pugs</code> and a country <code class="literal">us</code> and promote adoptable shelter dogs if the rule query met both criteria.</p>
<p>Rules are defined using the <a class="xref" href="query-rules-apis.html" title="Query rules APIs">query rules API</a> and searched using the <a class="xref" href="query-dsl-rule-query.html" title="Rule query">rule query</a>.</p>
<h4><a id="query-rule-definition"></a>Rule definition<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/search-using-query-rules.asciidoc">edit</a></h4>
<p>When defining a rule, consider the following:</p>
<h5><a id="query-rule-type"></a>Rule type<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/search-using-query-rules.asciidoc">edit</a></h5>
<p>The type of rule we want to apply. For the moment there is a single rule type:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">pinned</code> will re-write the query into a <a class="xref" href="query-dsl-pinned-query.html" title="Pinned Query">pinned query</a>, pinning specified results matching the query rule at the top of the returned result set.
</li>
</ul>
</div>
<h5><a id="query-rule-criteria"></a>Rule criteria<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/search-using-query-rules.asciidoc">edit</a></h5>
<p>The criteria for which this rule will match. Criteria is defined as <code class="literal">type</code>, <code class="literal">metadata</code>, and <code class="literal">values</code>.
Allowed criteria types are:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Type</th>
<th align="left" valign="top">Match Requirements</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">exact</code></p></td>
<td align="left" valign="top"><p>Rule metadata matches the specified value exactly.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">fuzzy</code></p></td>
<td align="left" valign="top"><p>Rule metadata matches the specified value within an allowed <a href="https://en.wikipedia.org/wiki/Levenshtein_distance" class="ulink" target="_top">Levenshtein edit distance</a>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">prefix</code></p></td>
<td align="left" valign="top"><p>Rule metadata starts with the specified value.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">suffix</code></p></td>
<td align="left" valign="top"><p>Rule metadata ends with the specified value.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">contains</code></p></td>
<td align="left" valign="top"><p>Rule metadata contains the specified value.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">lt</code></p></td>
<td align="left" valign="top"><p>Rule metadata is less than the specified value.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">lte</code></p></td>
<td align="left" valign="top"><p>Rule metadata is less than or equal to the specified value.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gt</code></p></td>
<td align="left" valign="top"><p>Rule metadata is greater than the specified value.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gte</code></p></td>
<td align="left" valign="top"><p>Rule metadata is greater than or equal to the specified value.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">always</code></p></td>
<td align="left" valign="top"><p>Always matches for all rule queries.</p></td>
</tr>
</tbody>
</table>
</div>
<h5><a id="query-rule-actions"></a>Rule actions<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/search-using-query-rules.asciidoc">edit</a></h5>
<p>The actions to take when the rule matches a query:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">ids</code> will pin the specified <a class="xref" href="mapping-id-field.html" title="_id field"><code class="literal">_id</code></a>s.
</li>
<li class="listitem">
<code class="literal">docs</code> will pin the specified documents in the specified indices.
</li>
</ul>
</div>
<p>Use <code class="literal">ids</code> when searching over a single index, and <code class="literal">docs</code> when searching over multiple indices.
<code class="literal">ids</code> and <code class="literal">docs</code> cannot be combined in the same query.
See <a class="xref" href="query-dsl-pinned-query.html" title="Pinned Query">pinned query</a> for details.</p>
<h4><a id="add-query-rules"></a>Add query rules<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/search-using-query-rules.asciidoc">edit</a></h4>
<p>You can add query rules using the <a class="xref" href="put-query-ruleset.html" title="Create or update query ruleset">Create or update query ruleset</a> call. This adds a ruleset containing one or more query rules that will be applied to queries that match their specified criteria.</p>
<p>The following command will create a query ruleset called <code class="literal">my-ruleset</code> with two pinned document rules:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The first rule will generate a <a class="xref" href="query-dsl-pinned-query.html" title="Pinned Query">Pinned Query</a> pinning the <a class="xref" href="mapping-id-field.html" title="_id field"><code class="literal">_id</code></a>s <code class="literal">id1</code> and <code class="literal">id2</code> when the <code class="literal">query_string</code> metadata value is a fuzzy match to either <code class="literal">puggles</code> or <code class="literal">pugs</code> <em>and</em> the user&#8217;s location is in the US.
</li>
<li class="listitem">
The second rule will generate a <a class="xref" href="query-dsl-pinned-query.html" title="Pinned Query">Pinned Query</a> pinning the <a class="xref" href="mapping-id-field.html" title="_id field"><code class="literal">_id</code></a> of <code class="literal">id3</code> specifically from the <code class="literal">my-index-000001</code> index and <code class="literal">id4</code> from the <code class="literal">my-index-000002</code> index when the <code class="literal">query_string</code> metadata value contains <code class="literal">beagles</code>.
</li>
</ul>
</div>
<a id="d595b40bf1ea71923f9824d0f9c99c49"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">PUT /_query_rules/my-ruleset
{
  "rules": [
    {
      "rule_id": "rule1",
      "type": "pinned",
      "criteria": [
        {
          "type": "fuzzy",
          "metadata": "query_string",
          "values": [ "puggles", "pugs" ]
        },
        {
          "type": "exact",
          "metadata": "user_country",
          "values": [ "us" ]
        }
      ],
      "actions": {
        "ids": [
          "id1",
          "id2"
        ]
      }
    },
    {
      "rule_id": "rule2",
      "type": "pinned",
      "criteria": [
        {
          "type": "contains",
          "metadata": "query_string",
          "values": [ "beagles" ]
        }
      ],
      "actions": {
        "docs": [
          {
            "_index": "my-index-000001",
            "_id": "id3"
          },
          {
            "_index": "my-index-000002",
            "_id": "id4"
          }
        ]
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/937.console"></div>
<p>The API response returns a results of <code class="literal">created</code> or <code class="literal">updated</code> depending on whether this was a new or edited ruleset.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>There is a limit of 100 rules per ruleset.
This can be increased up to 1000 using the <code class="literal">xpack.applications.rules.max_rules_per_ruleset</code> cluster setting.</p>
</div>
</div>
<a id="3bdcff0ec188e1b176eaa08c49eb5244"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "result": "created"
}</pre>
</div>
<p>You can use the <a class="xref" href="get-query-ruleset.html" title="Get query ruleset">Get query ruleset</a> call to retrieve the ruleset you just created,
the <a class="xref" href="list-query-rulesets.html" title="List query rulesets">List query rulesets</a> call to retrieve a summary of all query rulesets,
and the <a class="xref" href="delete-query-ruleset.html" title="Delete query ruleset">Delete query ruleset</a> call to delete a query ruleset.</p>
<h4><a id="rule-query-search"></a>Perform a rule query<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.14/docs/reference/search/search-your-data/search-using-query-rules.asciidoc">edit</a></h4>
<p>Once you have defined a query ruleset, you can search this ruleset using the <a class="xref" href="query-dsl-rule-query.html" title="Rule query">Rule</a> query.
An example query for the <code class="literal">my-ruleset</code> defined above is:</p>
<a id="c9cba66d8c475fd5499e00968f25097e"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET /my-index-000001/_search
{
  "query": {
    "rule_query": {
      "organic": {
        "query_string": {
          "query": "puggles"
        }
      },
      "match_criteria": {
        "query_string": "puggles",
        "user_country": "us"
      },
      "ruleset_id": "my-ruleset"
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/938.console"></div>
<p>This rule query will match against <code class="literal">rule1</code> in the defined query ruleset, and will convert the organic query into a pinned query with <code class="literal">id1</code> and <code class="literal">id2</code> pinned as the top hits.
Any other matches from the organic query will be returned below the pinned results.</p>
<p>It&#8217;s possible to have multiple rules in a ruleset match a single <code class="literal">rule_query</code>. In this case, the pinned documents are returned in the following order:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Where the matching rule appears in the ruleset
</li>
<li class="listitem">
If multiple documents are specified in a single rule, in the order they are specified
</li>
</ul>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="search-shard-routing.html">« Search shard routing</a>
</span>
<span class="next">
<a href="search-template.html">Search templates »</a>
</span>
</div>
</div>
</body>
</html>
