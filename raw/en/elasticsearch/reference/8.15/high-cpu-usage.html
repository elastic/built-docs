<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="keywords" content="Elasticsearch, high watermark, low watermark, full disk">
<title>High CPU usage | Elasticsearch Guide [8.15] | Elastic</title>
<meta class="elastic" name="content" content="High CPU usage | Elasticsearch Guide [8.15]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.15]"/>
<link rel="up" href="fix-common-cluster-issues.html" title="Fix common cluster issues"/>
<link rel="prev" href="circuit-breaker-errors.html" title="Circuit breaker errors"/>
<link rel="next" href="high-jvm-memory-pressure.html" title="High JVM memory pressure"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.15"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.15"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="circuit-breaker-errors.html">« Circuit breaker errors</a>
</span>
<span class="next">
<a href="high-jvm-memory-pressure.html">High JVM memory pressure »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.15]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="troubleshooting.html">Troubleshooting</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="fix-common-cluster-issues.html">Fix common cluster issues</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>High CPU usage</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/troubleshooting/common-issues/high-cpu-usage.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs/troubleshoot/elasticsearch/high-cpu-usage">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="high-cpu-usage"></a>High CPU usage</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/troubleshooting/common-issues/high-cpu-usage.asciidoc">edit</a></div>
</div></div></div>
<p>Elasticsearch uses <a class="xref" href="modules-threadpool.html" title="Thread pools">thread pools</a> to manage CPU resources for
concurrent operations. High CPU usage typically means one or more thread pools
are running low.</p>
<p>If a thread pool is depleted, Elasticsearch will <a class="xref" href="rejected-requests.html" title="Rejected requests">reject requests</a>
related to the thread pool. For example, if the <code class="literal">search</code> thread pool is
depleted, Elasticsearch will reject search requests until more threads are available.</p>
<p>You might experience high CPU usage if a <a class="xref" href="data-tiers.html" title="Data tiers">data tier</a>, and therefore the nodes assigned to that tier, is experiencing more traffic than other tiers. This imbalance in resource utilization is also known as <a class="xref" href="hotspotting.html" title="Hot spotting">hot spotting</a>.</p>
<div class="position-relative"><h4><a id="diagnose-high-cpu-usage"></a>Diagnose high CPU usage</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/troubleshooting/common-issues/high-cpu-usage.asciidoc">edit</a></div>
<p><span class="strong strong"><strong>Check CPU usage</strong></span></p>
<p>You can check the CPU usage per node using the <a class="xref" href="cat-nodes.html" title="cat nodes API">cat nodes API</a>:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.cat.nodes(
    v=True,
    s="cpu:desc",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cat.nodes(
  v: true,
  s: 'cpu:desc'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cat.nodes({
  v: "true",
  s: "cpu:desc",
});
console.log(response);</pre>
</div>
<a id="1637ef51d673b35cc8894ee80cd61c87"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET _cat/nodes?v=true&amp;s=cpu:desc</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/3291.console"></div>
<p>The response&#8217;s <code class="literal">cpu</code> column contains the current CPU usage as a percentage.
The <code class="literal">name</code> column contains the node&#8217;s name. Elevated but transient CPU usage is
normal. However, if CPU usage is elevated for an extended duration, it should be
investigated.</p>
<p>To track CPU usage over time, we recommend enabling monitoring:</p>
<div class="tabs" data-tab-group="host">
  <div role="tablist" aria-label="Check CPU usage">
    <button role="tab"
            aria-selected="true"
            aria-controls="cloud-tab-cpu"
            id="cloud-cpu">
      Elasticsearch Service
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="self-managed-tab-cpu"
            id="self-managed-cpu"
            tabindex="-1">
      Self-managed
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="cloud-tab-cpu"
       aria-labelledby="cloud-cpu">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>(Recommended) Enable <a href="/guide/en/cloud/current/ec-monitoring-setup.html" class="ulink" target="_top">logs and metrics</a>. When logs and metrics are enabled, monitoring information is visible on Kibana&#8217;s <a href="/guide/en/kibana/8.15/xpack-monitoring.html" class="ulink" target="_top">Stack Monitoring</a> page.</p>
<p>You can also enable the <a href="/guide/en/kibana/8.15/kibana-alerts.html" class="ulink" target="_top">CPU usage threshold alert</a> to be notified about potential issues through email.</p>
</li>
<li class="listitem">
<p>From your deployment menu, view the <a href="/guide/en/cloud/current/ec-saas-metrics-accessing.html" class="ulink" target="_top"><span class="strong strong"><strong>Performance</strong></span></a> page. On this page, you can view two key metrics:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>CPU usage</strong></span>: Your deployment&#8217;s CPU usage, represented as a percentage.
</li>
<li class="listitem">
<span class="strong strong"><strong>CPU credits</strong></span>: Your remaining CPU credits, measured in seconds of CPU time.
</li>
</ul>
</div>
</li>
</ul>
</div>
<p>Elasticsearch Service grants <a href="/guide/en/cloud/current/ec-vcpu-boost-instance.html" class="ulink" target="_top">CPU credits</a> per deployment
to provide smaller clusters with performance boosts when needed. High CPU
usage can deplete these credits, which might lead to <a href="/guide/en/cloud/current/ec-scenario_why_is_performance_degrading_over_time.html" class="ulink" target="_top">performance degradation</a> and <a href="/guide/en/cloud/current/ec-scenario_why_are_my_cluster_response_times_suddenly_so_much_worse.html" class="ulink" target="_top">increased cluster response times</a>.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="self-managed-tab-cpu"
       aria-labelledby="self-managed-cpu"
       hidden="">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Enable <a class="xref" href="monitoring-overview.html" title="Monitoring overview">Elasticsearch monitoring</a>. When logs and metrics are enabled, monitoring information is visible on Kibana&#8217;s <a href="/guide/en/kibana/8.15/xpack-monitoring.html" class="ulink" target="_top">Stack Monitoring</a> page.</p>
<p>You can also enable the <a href="/guide/en/kibana/8.15/kibana-alerts.html" class="ulink" target="_top">CPU usage threshold alert</a> to be notified about potential issues through email.</p>
</li>
</ul>
</div>
  </div>
</div>
<p><span class="strong strong"><strong>Check hot threads</strong></span></p>
<p>If a node has high CPU usage, use the <a class="xref" href="cluster-nodes-hot-threads.html" title="Nodes hot threads API">nodes hot
threads API</a> to check for resource-intensive threads running on the node.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.nodes.hot_threads()
print(resp)</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.nodes.hotThreads();
console.log(response);</pre>
</div>
<a id="3a489743e49902df38e3368cae00717a"></a>
<div class="pre_wrapper lang-console default has-python has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-js">GET _nodes/hot_threads</pre>
</div>
<div class="console_widget has-python has-js" data-snippet="snippets/3292.console"></div>
<p>This API returns a breakdown of any hot threads in plain text. High CPU usage
frequently correlates to <a class="xref" href="task-queue-backlog.html" title="Task queue backlog">a long-running task, or a
backlog of tasks</a>.</p>
<div class="position-relative"><h4><a id="reduce-cpu-usage"></a>Reduce CPU usage</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/troubleshooting/common-issues/high-cpu-usage.asciidoc">edit</a></div>
<p>The following tips outline the most common causes of high CPU usage and their
solutions.</p>
<p><span class="strong strong"><strong>Scale your cluster</strong></span></p>
<p>Heavy indexing and search loads can deplete smaller thread pools. To better
handle heavy workloads, add more nodes to your cluster or upgrade your existing
nodes to increase capacity.</p>
<p><span class="strong strong"><strong>Spread out bulk requests</strong></span></p>
<p>While more efficient than individual requests, large <a class="xref" href="docs-bulk.html" title="Bulk API">bulk indexing</a>
or <a class="xref" href="search-multi-search.html" title="Multi search API">multi-search</a> requests still require CPU resources. If
possible, submit smaller requests and allow more time between them.</p>
<p><span class="strong strong"><strong>Cancel long-running searches</strong></span></p>
<p>Long-running searches can block threads in the <code class="literal">search</code> thread pool. To check
for these searches, use the <a class="xref" href="tasks.html" title="Task management API">task management API</a>.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.tasks.list(
    actions="*search",
    detailed=True,
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.tasks.list(
  actions: '*search',
  detailed: true
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.tasks.list({
  actions: "*search",
  detailed: "true",
});
console.log(response);</pre>
</div>
<a id="8f4a7f68f2ca3698abdf20026a2d8c5f"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET _tasks?actions=*search&amp;detailed</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/3293.console"></div>
<p>The response&#8217;s <code class="literal">description</code> contains the search request and its queries.
<code class="literal">running_time_in_nanos</code> shows how long the search has been running.</p>
<a id="a5a360d0325b5a8d67f2a87cf140dab9"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "nodes" : {
    "oTUltX4IQMOUUVeiohTt8A" : {
      "name" : "my-node",
      "transport_address" : "127.0.0.1:9300",
      "host" : "127.0.0.1",
      "ip" : "127.0.0.1:9300",
      "tasks" : {
        "oTUltX4IQMOUUVeiohTt8A:464" : {
          "node" : "oTUltX4IQMOUUVeiohTt8A",
          "id" : 464,
          "type" : "transport",
          "action" : "indices:data/read/search",
          "description" : "indices[my-index], search_type[QUERY_THEN_FETCH], source[{\"query\":...}]",
          "start_time_in_millis" : 4081771730000,
          "running_time_in_nanos" : 13991383,
          "cancellable" : true
        }
      }
    }
  }
}</pre>
</div>
<p>To cancel a search and free up resources, use the API&#8217;s <code class="literal">_cancel</code> endpoint.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.tasks.cancel(
    task_id="oTUltX4IQMOUUVeiohTt8A:464",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.tasks.cancel(
  task_id: 'oTUltX4IQMOUUVeiohTt8A:464'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.tasks.cancel({
  task_id: "oTUltX4IQMOUUVeiohTt8A:464",
});
console.log(response);</pre>
</div>
<a id="84c69fb07050f0e89720007a6507a221"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">POST _tasks/oTUltX4IQMOUUVeiohTt8A:464/_cancel</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/3294.console"></div>
<p>For additional tips on how to track and avoid resource-intensive searches, see
<a class="xref" href="high-jvm-memory-pressure.html#avoid-expensive-searches">Avoid expensive searches</a>.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="circuit-breaker-errors.html">« Circuit breaker errors</a>
</span>
<span class="next">
<a href="high-jvm-memory-pressure.html">High JVM memory pressure »</a>
</span>
</div>
</body>
</html>
