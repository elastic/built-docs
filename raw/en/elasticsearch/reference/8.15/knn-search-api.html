<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="keywords" content="Elasticsearch diagnostic, diagnostics">
<title>kNN search API | Elasticsearch Guide [8.15] | Elastic</title>
<meta class="elastic" name="content" content="kNN search API | Elasticsearch Guide [8.15]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.15]"/>
<link rel="up" href="search.html" title="Search APIs"/>
<link rel="prev" href="point-in-time-api.html" title="Point in time API"/>
<link rel="next" href="retriever.html" title="Retriever"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.15"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.15"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="point-in-time-api.html">« Point in time API</a>
</span>
<span class="next">
<a href="retriever.html">Retriever »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.15]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="rest-apis.html">REST APIs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search.html">Search APIs</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>kNN search API</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/knn-search.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="knn-search-api"></a>kNN search API<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/knn-search.asciidoc">edit</a></h2>
</div></div></div>

<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<h3>Deprecated in 8.4.0.</h3>
<p>The kNN search API has been replaced by the <a class="xref" href="search-search.html#search-api-knn"><code class="literal">knn</code> option</a> in the search API.</p>
</div>
</div>
<p>Performs a k-nearest neighbor (kNN) search and returns the matching documents.</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.knnSearch({
  index: "my-index",
  knn: {
    field: "image_vector",
    query_vector: [0.3, 0.1, 1.2],
    k: 10,
    num_candidates: 100,
  },
  _source: ["name", "file_type"],
});
console.log(response);</pre>
</div>
<a id="49b31e23f8b9667b6a7b2734d55fb6ed"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">GET my-index/_knn_search
{
  "knn": {
    "field": "image_vector",
    "query_vector": [0.3, 0.1, 1.2],
    "k": 10,
    "num_candidates": 100
  },
  "_source": ["name", "file_type"]
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/3056.console"></div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="knn-search-api-request"></a>Request<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/knn-search.asciidoc">edit</a></h3>
</div></div></div>
<p><code class="literal">GET &lt;target&gt;/_knn_search</code></p>
<p><code class="literal">POST &lt;target&gt;/_knn_search</code></p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="knn-search-api-prereqs"></a>Prerequisites<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/knn-search.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If the Elasticsearch security features are enabled, you must have the <code class="literal">read</code>
<a class="xref" href="security-privileges.html#privileges-list-indices" title="Indices privileges">index privilege</a> for the target data stream, index,
or alias.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="knn-search-api-desc"></a>Description<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/knn-search.asciidoc">edit</a></h3>
</div></div></div>
<p>The kNN search API performs a k-nearest neighbor (kNN) search on a
<a class="xref" href="dense-vector.html" title="Dense vector field type"><code class="literal">dense_vector</code></a> field. Given a query vector, it finds the <em>k</em>
closest vectors and returns those documents as search hits.</p>
<p>Elasticsearch uses the <a href="https://arxiv.org/abs/1603.09320" class="ulink" target="_top">HNSW algorithm</a> to support
efficient kNN search. Like most kNN algorithms, HNSW is an approximate method
that sacrifices result accuracy for improved search speed. This means the
results returned are not always the true <em>k</em> closest neighbors.</p>
<p>The kNN search API supports restricting the search using a filter. The search
will return the top <code class="literal">k</code> documents that also match the filter query.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="knn-search-api-path-params"></a>Path parameters<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/knn-search.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">&lt;target&gt;</code>
</span>
</dt>
<dd>
(Optional, string) Comma-separated list of data streams, indices, and aliases
to search. Supports wildcards (<code class="literal">*</code>). To search all data streams and indices,
use <code class="literal">*</code> or <code class="literal">_all</code>.
</dd>
</dl>
</div>
</div>

<div class="section child_attributes">
<div class="titlepage"><div><div>
<h3 class="title"><a id="knn-search-api-query-params"></a>Query parameters<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/knn-search.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">routing</code>
</span>
</dt>
<dd>
(Optional, string)
Custom value used to route operations to a specific shard.
</dd>
</dl>
</div>
</div>

<div class="section child_attributes">
<div class="titlepage"><div><div>
<h3 class="title"><a id="knn-search-api-request-body"></a>Request body<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/knn-search.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">filter</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="query-dsl.html" title="Query DSL">Query DSL object</a>)
Query to filter the documents that can match. The kNN search will return the top
<code class="literal">k</code> documents that also match this filter. The value can be a single query or a
list of queries. If <code class="literal">filter</code> is not provided, all documents are allowed to
match.
</dd>
<dt>
<span class="term">
<code class="literal">knn</code>
</span>
</dt>
<dd>
<p>
(Required, object)
Defines the <a class="xref" href="knn-search.html#approximate-knn" title="Approximate kNN">kNN</a> query to run.
</p>
<details open>
<summary class="title">Properties of <code class="literal">knn</code> object</summary>
<div class="content">
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">field</code>
</span>
</dt>
<dd>
(Required, string)
The name of the vector field to search against. Must be a
<a class="xref" href="dense-vector.html#index-vectors-knn-search" title="Index vectors for kNN search"><code class="literal">dense_vector</code> field with indexing enabled</a>.
</dd>
<dt>
<span class="term">
<code class="literal">k</code>
</span>
</dt>
<dd>
(Optional, integer)
Number of nearest neighbors to return as top hits. This value must be less than
or equal to <code class="literal">num_candidates</code>. Defaults to <code class="literal">size</code>.
</dd>
<dt>
<span class="term">
<code class="literal">num_candidates</code>
</span>
</dt>
<dd>
(Optional, integer)
The number of nearest neighbor candidates to consider per shard.
Needs to be greater than <code class="literal">k</code>, or <code class="literal">size</code> if <code class="literal">k</code> is omitted, and cannot exceed 10,000.
Elasticsearch collects <code class="literal">num_candidates</code> results from each shard, then merges them
to find the top <code class="literal">k</code> results. Increasing <code class="literal">num_candidates</code> tends to improve the
accuracy of the final <code class="literal">k</code> results. Defaults to <code class="literal">Math.min(1.5 * k, 10_000)</code>.
</dd>
<dt>
<span class="term">
<code class="literal">query_vector</code>
</span>
</dt>
<dd>
(Required, array of floats or string)
Query vector. Must have the same number of dimensions as the vector field you
are searching against. Must be either an array of floats or a hex-encoded byte vector.
</dd>
</dl>
</div>
</div>
</details>
</dd>
<dt>
<span class="term">
<code class="literal">docvalue_fields</code>
</span>
</dt>
<dd>
<p>
(Optional, array of strings and objects)
Array of field patterns. The request returns values for field names matching
these patterns in the <code class="literal">hits.fields</code> property of the response.
</p>
<p>You can specify items in the array as a string or object. See
<a class="xref" href="search-fields.html#docvalue-fields" title="Doc value fields">Doc value fields</a>.</p>
<details open>
<summary class="title">Properties of <code class="literal">docvalue_fields</code> objects</summary>
<div class="content">
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">field</code>
</span>
</dt>
<dd>
(Required, string)
Wildcard pattern. The request returns doc values for field names matching this
pattern.
</dd>
<dt>
<span class="term">
<code class="literal">format</code>
</span>
</dt>
<dd>
<p>
(Optional, string)
Format in which the doc values are returned.
</p>
<p>For <a class="xref" href="date.html" title="Date field type">date fields</a>, you can specify a date <a class="xref" href="mapping-date-format.html" title="format">date
<code class="literal">format</code></a>. For <a class="xref" href="number.html" title="Numeric field types">numeric fields</a> fields, you can specify a
<a href="https://docs.oracle.com/javase/8/docs/api/java/text/DecimalFormat.html" class="ulink" target="_top">DecimalFormat
pattern</a>.</p>
<p>For other field data types, this parameter is not supported.</p>
</dd>
</dl>
</div>
</div>
</details>
</dd>
<dt>
<span class="term">
<code class="literal">fields</code>
</span>
</dt>
<dd>
<p>
(Optional, array of strings and objects)
Array of field patterns. The request returns values for field names matching
these patterns in the <code class="literal">hits.fields</code> property of the response.
</p>
<p>You can specify items in the array as a string or object. See
<a class="xref" href="search-fields.html#search-fields-param" title="The fields option">the <code class="literal">fields</code> option</a>.</p>
<details open>
<summary class="title">Properties of <code class="literal">fields</code> objects</summary>
<div class="content">
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">field</code>
</span>
</dt>
<dd>
(Required, string) Field to return. Supports wildcards (<code class="literal">*</code>).
</dd>
<dt>
<span class="term">
<code class="literal">format</code>
</span>
</dt>
<dd>
<p>
(Optional, string)
Format for date and geospatial fields. Other field data types do not support
this parameter.
</p>
<p><a class="xref" href="date.html" title="Date field type"><code class="literal">date</code></a> and <a class="xref" href="date_nanos.html" title="Date nanoseconds field type"><code class="literal">date_nanos</code></a> fields accept a
<a class="xref" href="mapping-date-format.html" title="format">date format</a>. <a class="xref" href="geo-point.html" title="Geopoint field type"><code class="literal">geo_point</code></a> and
<a class="xref" href="geo-shape.html" title="Geoshape field type"><code class="literal">geo_shape</code></a> fields accept:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">geojson</code> (default)
</span>
</dt>
<dd>
<a href="http://www.geojson.org" class="ulink" target="_top">GeoJSON</a>
</dd>
<dt>
<span class="term">
<code class="literal">wkt</code>
</span>
</dt>
<dd>
<a href="https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry" class="ulink" target="_top">Well Known Text</a>
</dd>
<dt>
<span class="term">
<code class="literal">mvt(&lt;spec&gt;)</code>
</span>
</dt>
<dd>
<p>
Binary
<a href="https://docs.mapbox.com/vector-tiles/specification" class="ulink" target="_top">Mapbox vector tile</a>. The API
returns the tile as a base64-encoded string.
The <code class="literal">&lt;spec&gt;</code> has the format <code class="literal">&lt;zoom&gt;/&lt;x&gt;/&lt;y&gt;</code> with two optional suffixes: <code class="literal">@&lt;extent&gt;</code> and/or <code class="literal">:&lt;buffer&gt;</code>. For example, <code class="literal">2/0/1</code> or <code class="literal">2/0/1@4096:5</code>.
</p>
<details open>
<summary class="title"><code class="literal">mvt</code> parameters</summary>
<div class="content">
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">&lt;zoom&gt;</code>
</span>
</dt>
<dd>
(Required, integer) Zoom level for the tile. Accepts <code class="literal">0</code>-<code class="literal">29</code>.
</dd>
<dt>
<span class="term">
<code class="literal">&lt;x&gt;</code>
</span>
</dt>
<dd>
(Required, integer) X coordinate for the tile.
</dd>
<dt>
<span class="term">
<code class="literal">&lt;y&gt;</code>
</span>
</dt>
<dd>
(Required, integer) Y coordinate for the tile.
</dd>
<dt>
<span class="term">
<code class="literal">&lt;extent&gt;</code>
</span>
</dt>
<dd>
(Optional, integer) Size, in pixels, of a side of the tile. Vector tiles are
square with equal sides. Defaults to <code class="literal">4096</code>.
</dd>
<dt>
<span class="term">
<code class="literal">&lt;buffer&gt;</code>
</span>
</dt>
<dd>
(Optional, integer) Size, in pixels, of a clipping buffer outside the tile.
This allows renderers to avoid outline artifacts from geometries that extend past the extent of the tile. Defaults to <code class="literal">5</code>.
</dd>
</dl>
</div>
</div>
</details>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</div>
</details>
</dd>
<dt>
<span class="term">
<code class="literal">_source</code>
</span>
</dt>
<dd>
<p>
(Optional)
Indicates which <a class="xref" href="mapping-source-field.html" title="_source field">source fields</a> are returned for matching
documents. These fields are returned in the <code class="literal">hits._source</code> property of
the search response. Defaults to <code class="literal">true</code>. See <a class="xref" href="search-fields.html#source-filtering" title="The _source option">source filtering</a>.
</p>
<details open>
<summary class="title">Valid values for <code class="literal">_source</code></summary>
<div class="content">
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">true</code>
</span>
</dt>
<dd>
(Boolean)
The entire document source is returned.
</dd>
<dt>
<span class="term">
<code class="literal">false</code>
</span>
</dt>
<dd>
(Boolean)
The document source is not returned.
</dd>
<dt>
<span class="term">
<code class="literal">&lt;wildcard_pattern&gt;</code>
</span>
</dt>
<dd>
(string or array of strings)
Wildcard (<code class="literal">*</code>) pattern or array of patterns containing source fields to return.
</dd>
<dt>
<span class="term">
<code class="literal">&lt;object&gt;</code>
</span>
</dt>
<dd>
<p>
(object)
Object containing a list of source fields to include or exclude.
</p>
<details open>
<summary class="title">Properties for <code class="literal">&lt;object&gt;</code></summary>
<div class="content">
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">excludes</code>
</span>
</dt>
<dd>
<p>
(string or array of strings)
Wildcard (<code class="literal">*</code>) pattern or array of patterns containing source fields to exclude
from the response.
</p>
<p>You can also use this property to exclude fields from the subset specified in
<code class="literal">includes</code> property.</p>
</dd>
<dt>
<span class="term">
<code class="literal">includes</code>
</span>
</dt>
<dd>
<p>
(string or array of strings)
Wildcard (<code class="literal">*</code>) pattern or array of patterns containing source fields to return.
</p>
<p>If this property is specified, only these source fields are returned. You can
exclude fields from this subset using the <code class="literal">excludes</code> property.</p>
</dd>
</dl>
</div>
</div>
</details>
</dd>
</dl>
</div>
</div>
</details>
</dd>
<dt>
<span class="term">
<code class="literal">stored_fields</code>
</span>
</dt>
<dd>
<p>
(Optional, string) A comma-separated list of stored fields to return as part
of a hit. If no fields are specified, no stored fields are included in the
response. See <a class="xref" href="search-fields.html#stored-fields" title="Stored fields">Stored fields</a>.
</p>
<p>If this option is specified, the <code class="literal">_source</code> parameter defaults to <code class="literal">false</code>. You
can pass <code class="literal">_source: true</code> to return both source fields and stored fields in the
search response.</p>
</dd>
</dl>
</div>
</div>

<div class="section child_attributes">
<div class="titlepage"><div><div>
<h3 class="title"><a id="knn-search-api-response-body"></a>Response body<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/knn-search.asciidoc">edit</a></h3>
</div></div></div>
<p>A kNN search response has the exact same structure as a
<a class="xref" href="search-search.html#search-api-response-body" title="Response body">search API response</a>. However, certain sections
have a meaning specific to kNN search:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The <a class="xref" href="search-search.html#search-api-response-body-score">document <code class="literal">_score</code></a> is determined by
the similarity between the query and document vector. See
<a class="xref" href="dense-vector.html#dense-vector-similarity"><code class="literal">similarity</code></a>.
</li>
<li class="listitem">
The <code class="literal">hits.total</code> object contains the total number of nearest neighbor
candidates considered, which is <code class="literal">num_candidates * num_shards</code>. The
<code class="literal">hits.total.relation</code> will always be <code class="literal">eq</code>, indicating an exact value.
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="point-in-time-api.html">« Point in time API</a>
</span>
<span class="next">
<a href="retriever.html">Retriever »</a>
</span>
</div>
</body>
</html>
