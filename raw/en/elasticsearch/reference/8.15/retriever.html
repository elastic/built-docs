<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="keywords" content="Elasticsearch diagnostic, diagnostics">
<title>Retriever | Elasticsearch Guide [8.15] | Elastic</title>
<meta class="elastic" name="content" content="Retriever | Elasticsearch Guide [8.15]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.15]"/>
<link rel="up" href="search.html" title="Search APIs"/>
<link rel="prev" href="knn-search-api.html" title="kNN search API"/>
<link rel="next" href="rrf.html" title="Reciprocal rank fusion"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.15"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.15"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="knn-search-api.html">« kNN search API</a>
</span>
<span class="next">
<a href="rrf.html">Reciprocal rank fusion »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.15]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="rest-apis.html">REST APIs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search.html">Search APIs</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Retriever</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="retriever"></a>Retriever</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in technical preview and may be changed or removed in a future release. The syntax will likely change before GA. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>A retriever is a specification to describe top documents returned from a
search. A retriever replaces other elements of the <a class="xref" href="search-search.html" title="Search API">search API</a>
that also return top documents such as <a class="xref" href="query-dsl.html" title="Query DSL"><code class="literal">query</code></a> and
<a class="xref" href="search-search.html#search-api-knn"><code class="literal">knn</code></a>. A retriever may have child retrievers where a
retriever with two or more children is considered a compound retriever. This
allows for complex behavior to be depicted in a tree-like structure, called
the retriever tree, to better clarify the order of operations that occur
during a search.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Refer to <a class="xref" href="retrievers-overview.html" title="Retrievers">Retrievers</a> for a high level overview of the retrievers abstraction.</p>
</div>
</div>
<p>The following retrievers are available:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">standard</code>
</span>
</dt>
<dd>
A <a class="xref" href="retriever.html#standard-retriever" title="Standard Retriever">retriever</a> that replaces the functionality of a traditional <a class="xref" href="query-dsl.html" title="Query DSL">query</a>.
</dd>
<dt>
<span class="term">
<code class="literal">knn</code>
</span>
</dt>
<dd>
A <a class="xref" href="retriever.html#knn-retriever" title="kNN Retriever">retriever</a> that replaces the functionality of a <a class="xref" href="search-search.html#search-api-knn">knn search</a>.
</dd>
<dt>
<span class="term">
<code class="literal">rrf</code>
</span>
</dt>
<dd>
A <a class="xref" href="retriever.html#rrf-retriever" title="RRF Retriever">retriever</a> that produces top documents from <a class="xref" href="rrf.html" title="Reciprocal rank fusion">reciprocal rank fusion (RRF)</a>.
</dd>
<dt>
<span class="term">
<code class="literal">text_similarity_reranker</code>
</span>
</dt>
<dd>
A <a class="xref" href="retriever.html#text-similarity-reranker-retriever" title="Text Similarity Re-ranker Retriever">retriever</a> that enhances search results by re-ranking documents based on semantic similarity to a specified inference text, using a machine learning model.
</dd>
</dl>
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="standard-retriever"></a>Standard Retriever</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<p>A standard retriever returns top documents from a traditional <a class="xref" href="query-dsl.html" title="Query DSL">query</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_parameters_4"></a>Parameters:</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">query</code>
</span>
</dt>
<dd>
<p>
(Optional, <a class="xref" href="query-dsl.html" title="Query DSL">query object</a>)
</p>
<p>Defines a query to retrieve a set of top documents.</p>
</dd>
<dt>
<span class="term">
<code class="literal">filter</code>
</span>
</dt>
<dd>
<p>
(Optional, <a class="xref" href="query-dsl.html" title="Query DSL">query object or list of query objects</a>)
</p>
<p>Applies a <a class="xref" href="query-dsl-bool-query.html" title="Boolean query">boolean query filter</a> to this retriever
where all documents must match this query but do not contribute to the score.</p>
</dd>
<dt>
<span class="term">
<code class="literal">search_after</code>
</span>
</dt>
<dd>
<p>
(Optional, <a class="xref" href="paginate-search-results.html#search-after" title="Search after">search after object</a>)
</p>
<p>Defines a search after object parameter used for pagination.</p>
</dd>
<dt>
<span class="term">
<code class="literal">terminate_after</code>
</span>
</dt>
<dd>
<p>
(Optional, integer) Maximum number of documents to collect for each shard. If a
query reaches this limit, Elasticsearch terminates the query early. Elasticsearch collects
documents before sorting.
</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Use with caution. Elasticsearch applies this parameter to each shard handling
the request. When possible, let Elasticsearch perform early termination automatically.
Avoid specifying this parameter for requests that target data streams with
backing indices across multiple data tiers.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">sort</code>
</span>
</dt>
<dd>
<p>(Optional, <a class="xref" href="sort-search-results.html" title="Sort search results">sort object</a>)
A sort object that that specifies the order of matching documents.</p>
</dd>
<dt>
<span class="term">
<code class="literal">min_score</code>
</span>
</dt>
<dd>
<p>
(Optional, <code class="literal">float</code>)
</p>
<p>Minimum <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores"><code class="literal">_score</code></a> for matching documents. Documents with a
lower <code class="literal">_score</code> are not included in the top documents.</p>
</dd>
<dt>
<span class="term">
<code class="literal">collapse</code>
</span>
</dt>
<dd>
<p>
(Optional, <a class="xref" href="collapse-search-results.html" title="Collapse search results">collapse object</a>)
</p>
<p>Collapses the top documents by a specified key into a single top document per key.</p>
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_restrictions"></a>Restrictions</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<p>When a retriever tree contains a compound retriever (a retriever with two or more child
retrievers) <span class="strong strong"><strong>only</strong></span> the query element is allowed.</p>
<div class="position-relative"><h4><a id="standard-retriever-example"></a>Example</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">GET /restaurants/_search
{
  "retriever": { <a id="CO830-1"></a><i class="conum" data-value="1"></i>
    "standard": { <a id="CO830-2"></a><i class="conum" data-value="2"></i>
      "query": { <a id="CO830-3"></a><i class="conum" data-value="3"></i>
        "bool": { <a id="CO830-4"></a><i class="conum" data-value="4"></i>
          "should": [ <a id="CO830-5"></a><i class="conum" data-value="5"></i>
            {
              "match": { <a id="CO830-6"></a><i class="conum" data-value="6"></i>
                "region": "Austria"
              }
            }
          ],
          "filter": [ <a id="CO830-7"></a><i class="conum" data-value="7"></i>
            {
              "term": { <a id="CO830-8"></a><i class="conum" data-value="8"></i>
                "year": "2019" <a id="CO830-9"></a><i class="conum" data-value="9"></i>
              }
            }
          ]
        }
      }
    }
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO830-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Opens the <code class="literal">retriever</code> object.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO830-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">standard</code> retriever is used for definining traditional Elasticsearch queries.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO830-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The entry point for defining the search query.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO830-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">bool</code> object allows for combining multiple query clauses logically.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO830-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">should</code> array indicates conditions under which a document will match. Documents matching these conditions will increase their relevancy score.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO830-6"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">match</code> object finds documents where the <code class="literal">region</code> field contains the word "Austria."</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO830-7"><i class="conum" data-value="7"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">filter</code> array provides filtering conditions that must be met but do not contribute to the relevancy score.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO830-8"><i class="conum" data-value="8"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">term</code> object is used for exact matches, in this case, filtering documents by the <code class="literal">year</code> field.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO830-9"><i class="conum" data-value="9"></i></a></p>
</td>
<td align="left" valign="top">
<p>The exact value to match in the <code class="literal">year</code> field.</p>
</td>
</tr>
</table>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="knn-retriever"></a>kNN Retriever</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<p>A kNN retriever returns top documents from a <a class="xref" href="knn-search.html" title="k-nearest neighbor (kNN) search">k-nearest neighbor search (kNN)</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_parameters_5"></a>Parameters</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">field</code>
</span>
</dt>
<dd>
<p>
(Required, string)
</p>
<p>The name of the vector field to search against. Must be a
<a class="xref" href="dense-vector.html#index-vectors-knn-search" title="Index vectors for kNN search"><code class="literal">dense_vector</code> field with indexing enabled</a>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">query_vector</code>
</span>
</dt>
<dd>
<p>
(Required if <code class="literal">query_vector_builder</code> is not defined, array of <code class="literal">float</code>)
</p>
<p>Query vector. Must have the same number of dimensions as the vector field you
are searching against. Must be either an array of floats or a hex-encoded byte vector.</p>
</dd>
<dt>
<span class="term">
<code class="literal">query_vector_builder</code>
</span>
</dt>
<dd>
<p>
(Required if <code class="literal">query_vector</code> is not defined, query vector builder object)
</p>
<p>Defines a <a class="xref" href="knn-search.html#knn-semantic-search" title="Perform semantic search">model</a> to build a query vector.</p>
</dd>
<dt>
<span class="term">
<code class="literal">k</code>
</span>
</dt>
<dd>
<p>
(Required, integer)
</p>
<p>Number of nearest neighbors to return as top hits. This value must be fewer than
or equal to <code class="literal">num_candidates</code>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">num_candidates</code>
</span>
</dt>
<dd>
<p>
(Required, integer)
</p>
<p>The number of nearest neighbor candidates to consider per shard.
Needs to be greater than <code class="literal">k</code>, or <code class="literal">size</code> if <code class="literal">k</code> is omitted, and cannot exceed 10,000.
Elasticsearch collects <code class="literal">num_candidates</code> results from each shard, then merges them
to find the top <code class="literal">k</code> results. Increasing <code class="literal">num_candidates</code> tends to improve the
accuracy of the final <code class="literal">k</code> results. Defaults to <code class="literal">Math.min(1.5 * k, 10_000)</code>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">filter</code>
</span>
</dt>
<dd>
<p>
(Optional, <a class="xref" href="query-dsl.html" title="Query DSL">query object or list of query objects</a>)
</p>
<p>Query to filter the documents that can match. The kNN search will return the top
<code class="literal">k</code> documents that also match this filter. The value can be a single query or a
list of queries. If <code class="literal">filter</code> is not provided, all documents are allowed to
match.</p>
</dd>
<dt>
<span class="term">
<code class="literal">similarity</code>
</span>
</dt>
<dd>
<p>
(Optional, float)
</p>
<p>The minimum similarity required for a document to be considered a match. The similarity
value calculated relates to the raw <a class="xref" href="dense-vector.html#dense-vector-similarity"><code class="literal">similarity</code></a> used. Not the
document score. The matched documents are then scored according to <a class="xref" href="dense-vector.html#dense-vector-similarity"><code class="literal">similarity</code></a>
and the provided <code class="literal">boost</code> is applied.</p>
<p>The <code class="literal">similarity</code> parameter is the direct vector similarity calculation.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">l2_norm</code>: also known as Euclidean, will include documents where the vector is within
the <code class="literal">dims</code> dimensional hypersphere with radius <code class="literal">similarity</code> with origin at <code class="literal">query_vector</code>.
</li>
<li class="listitem">
<code class="literal">cosine</code>, <code class="literal">dot_product</code>, and <code class="literal">max_inner_product</code>: Only return vectors where the cosine similarity or dot-product are at least the provided
<code class="literal">similarity</code>.
</li>
</ul>
</div>
<p>Read more here: <a class="xref" href="knn-search.html#knn-similarity-search" title="Search kNN with expected similarity">knn similarity search</a></p>
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_restrictions_2"></a>Restrictions</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<p>The parameters <code class="literal">query_vector</code> and <code class="literal">query_vector_builder</code> cannot be used together.</p>
<div class="position-relative"><h4><a id="knn-retriever-example"></a>Example</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">GET my-embeddings/_search
{
  "retriever": {
    "knn": { <a id="CO831-1"></a><i class="conum" data-value="1"></i>
      "field": "vector", <a id="CO831-2"></a><i class="conum" data-value="2"></i>
      "query_vector": [10, 22, 77], <a id="CO831-3"></a><i class="conum" data-value="3"></i>
      "k": 10, <a id="CO831-4"></a><i class="conum" data-value="4"></i>
      "num_candidates": 10 <a id="CO831-5"></a><i class="conum" data-value="5"></i>
    }
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO831-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Configuration for k-nearest neighbor (knn) search, which is based on vector similarity.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO831-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Specifies the field name that contains the vectors.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO831-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The query vector against which document vectors are compared in the <code class="literal">knn</code> search.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO831-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The number of nearest neighbors to return as top hits. This value must be fewer than or equal to <code class="literal">num_candidates</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO831-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>The size of the initial candidate set from which the final <code class="literal">k</code> nearest neighbors are selected.</p>
</td>
</tr>
</table>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="rrf-retriever"></a>RRF Retriever</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<p>An <a class="xref" href="rrf.html" title="Reciprocal rank fusion">RRF</a> retriever returns top documents based on the RRF formula,
equally weighting two or more child retrievers.
Reciprocal rank fusion (RRF) is a method for combining multiple result
sets with different relevance indicators into a single result set.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_parameters_6"></a>Parameters</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">retrievers</code>
</span>
</dt>
<dd>
<p>
(Required, array of retriever objects)
</p>
<p>A list of child retrievers to specify which sets of returned top documents
will have the RRF formula applied to them. Each child retriever carries an
equal weight as part of the RRF formula. Two or more child retrievers are
required.</p>
</dd>
<dt>
<span class="term">
<code class="literal">rank_constant</code>
</span>
</dt>
<dd>
<p>
(Optional, integer)
</p>
<p>This value determines how much influence documents in individual
result sets per query have over the final ranked result set. A higher value indicates
that lower ranked documents have more influence. This value must be greater than or
equal to <code class="literal">1</code>. Defaults to <code class="literal">60</code>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">rank_window_size</code>
</span>
</dt>
<dd>
<p>
(Optional, integer)
</p>
<p>This value determines the size of the individual result sets per
query. A higher value will improve result relevance at the cost of performance. The final
ranked result set is pruned down to the search request&#8217;s <a class="xref" href="search-search.html#search-size-param">size</a>.
<code class="literal">rank_window_size</code> must be greater than or equal to <code class="literal">size</code> and greater than or equal to <code class="literal">1</code>.
Defaults to the <code class="literal">size</code> parameter.</p>
</dd>
<dt>
<span class="term">
<code class="literal">filter</code>
</span>
</dt>
<dd>
<p>
(Optional, <a class="xref" href="query-dsl.html" title="Query DSL">query object or list of query objects</a>)
</p>
<p>Applies the specified <a class="xref" href="query-dsl-bool-query.html" title="Boolean query">boolean query filter</a> to all of the specified sub-retrievers,
according to each retriever&#8217;s specifications.</p>
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_restrictions_3"></a>Restrictions</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<p>An RRF retriever is a compound retriever. Child retrievers may not use
elements that are restricted by having a compound retriever as part of
the retriever tree.</p>
<div class="position-relative"><h4><a id="rrf-retriever-example-hybrid"></a>Example: Hybrid search</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
<p>A simple hybrid search example (lexical search + dense vector search) combining a <code class="literal">standard</code> retriever with a <code class="literal">knn</code> retriever using RRF:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">GET /restaurants/_search
{
  "retriever": {
    "rrf": { <a id="CO832-1"></a><i class="conum" data-value="1"></i>
      "retrievers": [ <a id="CO832-2"></a><i class="conum" data-value="2"></i>
        {
          "standard": { <a id="CO832-3"></a><i class="conum" data-value="3"></i>
            "query": {
              "multi_match": {
                "query": "San Francisco",
                "fields": [
                  "city",
                  "region"
                ]
              }
            }
          }
        },
        {
          "knn": { <a id="CO832-4"></a><i class="conum" data-value="4"></i>
            "field": "vector",
            "query_vector": [10, 22, 77],
            "k": 10,
            "num_candidates": 10
          }
        }
      ],
      "rank_constant": 1, <a id="CO832-5"></a><i class="conum" data-value="5"></i>
      "rank_window_size": 50  <a id="CO832-6"></a><i class="conum" data-value="6"></i>
    }
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO832-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Defines a retriever tree with an RRF retriever.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO832-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The sub-retriever array.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO832-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The first sub-retriever is a <code class="literal">standard</code> retriever.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO832-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The second sub-retriever is a <code class="literal">knn</code> retriever.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO832-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>The rank constant for the RRF retriever.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO832-6"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>The rank window size for the RRF retriever.</p>
</td>
</tr>
</table>
</div>
<div class="position-relative"><h4><a id="rrf-retriever-example-hybrid-sparse"></a>Example: Hybrid search with sparse vectors</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
<p>A more complex hybrid search example (lexical search + ELSER sparse vector search + dense vector search) using RRF:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">GET movies/_search
{
  "retriever": {
    "rrf": {
      "retrievers": [
        {
          "standard": {
            "query": {
              "sparse_vector": {
                "field": "plot_embedding",
                "inference_id": "my-elser-model",
                "query": "films that explore psychological depths"
              }
            }
          }
        },
        {
          "standard": {
            "query": {
              "multi_match": {
                "query": "crime",
                "fields": [
                  "plot",
                  "title"
                ]
              }
            }
          }
        },
        {
          "knn": {
            "field": "vector",
            "query_vector": [10, 22, 77],
            "k": 10,
            "num_candidates": 10
          }
        }
      ]
    }
  }
}</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="text-similarity-reranker-retriever"></a>Text Similarity Re-ranker Retriever</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<p>The <code class="literal">text_similarity_reranker</code> retriever uses an NLP model to improve search results by reordering the top-k documents based on their semantic similarity to the query.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Refer to <a class="xref" href="semantic-reranking.html" title="Semantic reranking">Semantic reranking</a> for a high level overview of semantic reranking.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_prerequisites_16"></a>Prerequisites</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<p>To use <code class="literal">text_similarity_reranker</code> you must first set up a <code class="literal">rerank</code> task using the <a class="xref" href="put-inference-api.html" title="Create inference API">Create inference API</a>.
The <code class="literal">rerank</code> task should be set up with a machine learning model that can compute text similarity. Refer to <a href="/guide/en/machine-learning/8.15/ml-nlp-model-ref.html#ml-nlp-model-ref-text-similarity" class="ulink" target="_top">the Elastic NLP model reference</a> for a list of third-party text similarity models supported by Elasticsearch.</p>
<p>Currently you can:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Integrate directly with the <a class="xref" href="infer-service-cohere.html" title="Cohere inference service">Cohere Rerank inference endpoint</a> using the <code class="literal">rerank</code> task type
</li>
<li class="listitem">
Integrate directly with the <a class="xref" href="infer-service-google-vertex-ai.html" title="Google Vertex AI inference service">Google Vertex AI inference endpoint</a> using the <code class="literal">rerank</code> task type
</li>
<li class="listitem">
<p>Upload a model to Elasticsearch with <a href="/guide/en/elasticsearch/client/eland/current/machine-learning.html#ml-nlp-pytorch" class="ulink" target="_top">Eland</a> using the <code class="literal">text_similarity</code> NLP task type.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Then set up an <a class="xref" href="infer-service-elasticsearch.html#inference-example-eland" title="Models uploaded by Eland via the elasticsearch service">Elasticsearch service inference endpoint</a> with the <code class="literal">rerank</code> task type
</li>
<li class="listitem">
Refer to the <a class="xref" href="retriever.html#text-similarity-reranker-retriever-example-eland" title="Example: Semantic reranking with a Hugging Face model">example</a> on this page for a step-by-step guide.
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_parameters_7"></a>Parameters</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">retriever</code>
</span>
</dt>
<dd>
<p>
(Required, <a class="xref" href="retriever.html" title="Retriever">retriever</a>)
</p>
<p>The child retriever that generates the initial set of top documents to be re-ranked.</p>
</dd>
<dt>
<span class="term">
<code class="literal">field</code>
</span>
</dt>
<dd>
<p>
(Required, <code class="literal">string</code>)
</p>
<p>The document field to be used for text similarity comparisons. This field should contain the text that will be evaluated against the <code class="literal">inferenceText</code>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">inference_id</code>
</span>
</dt>
<dd>
<p>
(Required, <code class="literal">string</code>)
</p>
<p>Unique identifier of the inference endpoint created using the inference API.</p>
</dd>
<dt>
<span class="term">
<code class="literal">inference_text</code>
</span>
</dt>
<dd>
<p>
(Required, <code class="literal">string</code>)
</p>
<p>The text snippet used as the basis for similarity comparison.</p>
</dd>
<dt>
<span class="term">
<code class="literal">rank_window_size</code>
</span>
</dt>
<dd>
<p>
(Optional, <code class="literal">int</code>)
</p>
<p>The number of top documents to consider in the re-ranking process. Defaults to <code class="literal">10</code>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">min_score</code>
</span>
</dt>
<dd>
<p>
(Optional, <code class="literal">float</code>)
</p>
<p>Sets a minimum threshold score for including documents in the re-ranked results. Documents with similarity scores below this threshold will be excluded. Note that score calculations vary depending on the model used.</p>
</dd>
<dt>
<span class="term">
<code class="literal">filter</code>
</span>
</dt>
<dd>
<p>
(Optional, <a class="xref" href="query-dsl.html" title="Query DSL">query object or list of query objects</a>)
</p>
<p>Applies the specified <a class="xref" href="query-dsl-bool-query.html" title="Boolean query">boolean query filter</a> to the child  <a class="xref" href="retriever.html" title="Retriever">retriever</a>.
If the child retriever already specifies any filters, then this top-level filter is applied in conjuction
with the filter defined in the child retriever.</p>
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_restrictions_4"></a>Restrictions</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<p>A text similarity re-ranker retriever is a compound retriever. Child retrievers may not use elements that are restricted by having a compound retriever as part of the retriever tree.</p>
<div class="position-relative"><h4><a id="text-similarity-reranker-retriever-example-cohere"></a>Example: Cohere Rerank</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
<p>This example enables out-of-the-box semantic search by reranking top documents using the Cohere Rerank API. This approach eliminate the need to generate and store embeddings for all indexed documents.
This requires a <a class="xref" href="infer-service-cohere.html" title="Cohere inference service">Cohere Rerank inference endpoint</a> using the <code class="literal">rerank</code> task type.</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">GET /index/_search
{
   "retriever": {
      "text_similarity_reranker": {
         "retriever": {
            "standard": {
               "query": {
                  "match_phrase": {
                     "text": "landmark in Paris"
                  }
               }
            }
         },
         "field": "text",
         "inference_id": "my-cohere-rerank-model",
         "inference_text": "Most famous landmark in Paris",
         "rank_window_size": 100,
         "min_score": 0.5
      }
   }
}</pre>
</div>
<div class="position-relative"><h4><a id="text-similarity-reranker-retriever-example-eland"></a>Example: Semantic reranking with a Hugging Face model</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
<p>The following example uses the <code class="literal">cross-encoder/ms-marco-MiniLM-L-6-v2</code> model from Hugging Face to rerank search results based on semantic similarity.
The model must be uploaded to Elasticsearch using <a href="/guide/en/elasticsearch/client/eland/current/machine-learning.html#ml-nlp-pytorch" class="ulink" target="_top">Eland</a>.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Refer to <a href="/guide/en/machine-learning/8.15/ml-nlp-model-ref.html#ml-nlp-model-ref-text-similarity" class="ulink" target="_top">the Elastic NLP model reference</a> for a list of third party text similarity models supported by Elasticsearch.</p>
</div>
</div>
<p>Follow these steps to load the model and create a semantic reranker.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Install Eland using <code class="literal">pip</code></p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">python -m pip install eland[pytorch]</pre>
</div>
</li>
<li class="listitem">
<p>Upload the model to Elasticsearch using Eland. This example assumes you have an Elastic Cloud deployment and an API key. Refer to the <a href="/guide/en/elasticsearch/client/eland/current/machine-learning.html#ml-nlp-pytorch-auth" class="ulink" target="_top">Eland documentation</a> for more authentication options.</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">eland_import_hub_model \
  --cloud-id $CLOUD_ID \
  --es-api-key $ES_API_KEY \
  --hub-model-id cross-encoder/ms-marco-MiniLM-L-6-v2 \
  --task-type text_similarity \
  --clear-previous \
  --start</pre>
</div>
</li>
<li class="listitem">
<p>Create an inference endpoint for the <code class="literal">rerank</code> task</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">PUT _inference/rerank/my-msmarco-minilm-model
{
  "service": "elasticsearch",
  "service_settings": {
    "num_allocations": 1,
    "num_threads": 1,
    "model_id": "cross-encoder__ms-marco-minilm-l-6-v2"
  }
}</pre>
</div>
</li>
<li class="listitem">
<p>Define a <code class="literal">text_similarity_rerank</code> retriever.</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">POST movies/_search
{
  "retriever": {
    "text_similarity_reranker": {
      "retriever": {
        "standard": {
          "query": {
            "match": {
              "genre": "drama"
            }
          }
        }
      },
      "field": "plot",
      "inference_id": "my-msmarco-minilm-model",
      "inference_text": "films that explore psychological depths"
    }
  }
}</pre>
</div>
<p>This retriever uses a standard <code class="literal">match</code> query to search the <code class="literal">movie</code> index for films tagged with the genre "drama".
It then re-ranks the results based on semantic similarity to the text in the <code class="literal">inference_text</code> parameter, using the model we uploaded to Elasticsearch.</p>
</li>
</ol>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_using_from_and_size_with_a_retriever_tree"></a>Using <code class="literal">from</code> and <code class="literal">size</code> with a retriever tree</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<p>The <a class="xref" href="search-search.html#search-from-param"><code class="literal">from</code></a> and <a class="xref" href="search-search.html#search-size-param"><code class="literal">size</code></a>
parameters are provided globally as part of the general
<a class="xref" href="search-search.html" title="Search API">search API</a>. They are applied to all retrievers in a
retriever tree unless a specific retriever overrides the <code class="literal">size</code> parameter
using a different parameter such as <code class="literal">rank_window_size</code>. Though, the final
search hits are always limited to <code class="literal">size</code>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_using_aggregations_with_a_retriever_tree"></a>Using aggregations with a retriever tree</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<p><a class="xref" href="search-aggregations.html" title="Aggregations">Aggregations</a> are globally specified as part of a search request.
The query used for an aggregation is the combination of all leaf retrievers as <code class="literal">should</code>
clauses in a <a class="xref" href="query-dsl-bool-query.html" title="Boolean query">boolean query</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_restrictions_on_search_parameters_when_specifying_a_retriever"></a>Restrictions on search parameters when specifying a retriever</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.15/docs/reference/search/retriever.asciidoc">edit</a></div>
</div></div></div>
<p>When a retriever is specified as part of a search the following elements are not allowed
at the top-level and instead are only allowed as elements of specific retrievers:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="search-search.html#request-body-search-query"><code class="literal">query</code></a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#search-api-knn"><code class="literal">knn</code></a>
</li>
<li class="listitem">
<a class="xref" href="paginate-search-results.html#search-after" title="Search after"><code class="literal">search_after</code></a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#request-body-search-terminate-after"><code class="literal">terminate_after</code></a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#search-sort-param"><code class="literal">sort</code></a>
</li>
<li class="listitem">
<a class="xref" href="filter-search-results.html#rescore" title="Rescore filtered search results"><code class="literal">rescore</code></a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#search-api-min-score"><code class="literal">min_score</code></a>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="knn-search-api.html">« kNN search API</a>
</span>
<span class="next">
<a href="rrf.html">Reciprocal rank fusion »</a>
</span>
</div>
</body>
</html>
