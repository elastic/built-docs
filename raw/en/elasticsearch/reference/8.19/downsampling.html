<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Downsampling a time series data stream | Elasticsearch Guide [8.19] | Elastic</title>
<meta class="elastic" name="content" content="Downsampling a time series data stream | Elasticsearch Guide [8.19]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.19]"/>
<link rel="up" href="tsds.html" title="Time series data stream (TSDS)"/>
<link rel="prev" href="tsds-index-settings.html" title="Time series index settings"/>
<link rel="next" href="downsampling-ilm.html" title="Run downsampling with ILM"/>
<meta class="elastic" name="product_version" content="8.19"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.19"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.19"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="tsds-index-settings.html">« Time series index settings</a>
</span>
<span class="next">
<a href="downsampling-ilm.html">Run downsampling with ILM »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.19]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="data-streams.html">Data streams</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="tsds.html">Time series data stream (TSDS)</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Downsampling a time series data stream</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/data-streams/downsampling.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs/manage-data/data-store/data-streams/downsampling-time-series-data-stream">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="downsampling"></a>Downsampling a time series data stream</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/data-streams/downsampling.asciidoc">edit</a></div>
</div></div></div>
<p>Downsampling provides a method to reduce the footprint of your <a class="xref" href="tsds.html" title="Time series data stream (TSDS)">time
series data</a> by storing it at reduced granularity.</p>
<p>Metrics solutions collect large amounts of time series data that grow over time.
As that data ages, it becomes less relevant to the current state of the system.
The downsampling process rolls up documents within a fixed time interval into a
single summary document. Each summary document includes statistical
representations of the original data: the <code class="literal">min</code>, <code class="literal">max</code>, <code class="literal">sum</code> and <code class="literal">value_count</code>
for each metric. Data stream <a class="xref" href="tsds.html#time-series-dimension" title="Dimensions">time series dimensions</a>
are stored unchanged.</p>
<p>Downsampling, in effect, lets you to trade data resolution and precision for
storage size. You can include it in an <a class="xref" href="index-lifecycle-management.html" title="ILM: Manage the index lifecycle">index lifecycle management
(ILM)</a> policy to automatically manage the volume and associated cost of
your metrics data at it ages.</p>
<p>Check the following sections to learn more:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="downsampling.html#how-downsampling-works" title="How it works">How it works</a>
</li>
<li class="listitem">
<a class="xref" href="downsampling.html#running-downsampling" title="Running downsampling on time series data">Running downsampling on time series data</a>
</li>
<li class="listitem">
<a class="xref" href="downsampling.html#querying-downsampled-indices" title="Querying downsampled indices">Querying downsampled indices</a>
</li>
<li class="listitem">
<a class="xref" href="downsampling.html#downsampling-restrictions" title="Restrictions and limitations">Restrictions and limitations</a>
</li>
<li class="listitem">
<a class="xref" href="downsampling.html#try-out-downsampling" title="Try it out">Try it out</a>
</li>
</ul>
</div>
<div class="position-relative"><h3><a id="how-downsampling-works"></a>How it works</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/data-streams/downsampling.asciidoc">edit</a></div>
<p>A <a class="xref" href="tsds.html#time-series" title="What is a time series?">time series</a> is a sequence of observations taken over time for
a specific entity. The observed samples can be represented as a continuous
function, where the time series dimensions remain constant and the time series
metrics change over time.</p>
<div class="imageblock text-center">
<div class="content">
<img src="images/data-streams/time-series-function.png" alt="time series function">
</div>
</div>
<p>In an Elasticsearch index, a single document is created for each timestamp,
containing the immutable time series dimensions, together with the metrics names
and the changing metrics values. For a single timestamp, several time series
dimensions and metrics may be stored.</p>
<div class="imageblock text-center">
<div class="content">
<img src="images/data-streams/time-series-metric-anatomy.png" alt="time series metric anatomy">
</div>
</div>
<p>For your most current and relevant data, the metrics series typically has a low
sampling time interval, so it&#8217;s optimized for queries that require a high data
resolution.</p>
<div class="imageblock text-center">
<div class="content">
<img src="images/data-streams/time-series-original.png" alt="time series original">
</div>
<div class="title">Figure 2. Original metrics series</div>
</div>
<p>Downsampling works on older, less frequently accessed data by replacing the
original time series with both a data stream of a higher sampling interval and
statistical representations of that data. Where the original metrics samples may
have been taken, for example, every ten seconds, as the data ages you may choose
to reduce the sample granularity to hourly or daily. You may choose to reduce
the granularity of <code class="literal">cold</code> archival data to monthly or less.</p>
<div class="imageblock text-center">
<div class="content">
<img src="images/data-streams/time-series-downsampled.png" alt="time series downsampled">
</div>
<div class="title">Figure 3. Downsampled metrics series</div>
</div>
<div class="position-relative"><h4><a id="downsample-api-process"></a>The downsampling process</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/data-streams/downsampling.asciidoc">edit</a></div>
<p>The downsampling operation traverses the source TSDS index and performs the
following steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Creates a new document for each value of the <code class="literal">_tsid</code> field and each
<code class="literal">@timestamp</code> value, rounded to the <code class="literal">fixed_interval</code> defined in the downsample
configuration.
</li>
<li class="listitem">
For each new document, copies all <a class="xref" href="tsds.html#time-series-dimension" title="Dimensions">time
series dimensions</a> from the source index to the target index. Dimensions in a
TSDS are constant, so this is done only once per bucket.
</li>
<li class="listitem">
<p>For each <a class="xref" href="tsds.html#time-series-metric" title="Metrics">time series metric</a> field, computes aggregations
for all documents in the bucket. Depending on the metric type of each metric
field a different set of pre-aggregated results is stored:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">gauge</code>: The <code class="literal">min</code>, <code class="literal">max</code>, <code class="literal">sum</code>, and <code class="literal">value_count</code> are stored; <code class="literal">value_count</code>
is stored as type <code class="literal">aggregate_metric_double</code>.
</li>
<li class="listitem">
<code class="literal">counter</code>: The <code class="literal">last_value</code> is stored.
</li>
</ul>
</div>
</li>
<li class="listitem">
For all other fields, the most recent value is copied to the target index.
</li>
</ol>
</div>
<div class="position-relative"><h4><a id="downsample-api-mappings"></a>Source and target index field mappings</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/data-streams/downsampling.asciidoc">edit</a></div>
<p>Fields in the target, downsampled index are created based on fields in the
original source index, as follows:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
All fields mapped with the <code class="literal">time-series-dimension</code> parameter are created in
the target downsample index with the same mapping as in the source index.
</li>
<li class="listitem">
All fields mapped with the <code class="literal">time_series_metric</code> parameter are created
in the target downsample index with the same mapping as in the source
index. An exception is that for fields mapped as <code class="literal">time_series_metric: gauge</code>
the field type is changed to <code class="literal">aggregate_metric_double</code>.
</li>
<li class="listitem">
All other fields that are neither dimensions nor metrics (that is, label
fields), are created in the target downsample index with the same mapping
that they had in the source index.
</li>
</ol>
</div>
<div class="position-relative"><h3><a id="running-downsampling"></a>Running downsampling on time series data</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/data-streams/downsampling.asciidoc">edit</a></div>
<p>To downsample a time series index, use the
<a class="xref" href="indices-downsample-data-stream.html" title="Downsample index API">Downsample API</a> and set <code class="literal">fixed_interval</code> to
the level of granularity that you&#8217;d like:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.downsample(
    index="my-time-series-index",
    target_index="my-downsampled-time-series-index",
    config={
        "fixed_interval": "1d"
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.downsample(
  index: 'my-time-series-index',
  target_index: 'my-downsampled-time-series-index',
  body: {
    fixed_interval: '1d'
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.downsample({
  index: "my-time-series-index",
  target_index: "my-downsampled-time-series-index",
  config: {
    fixed_interval: "1d",
  },
});
console.log(response);</pre>
</div>
<a id="424fbf082cd4affb84439abfc916b597"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">POST /my-time-series-index/_downsample/my-downsampled-time-series-index
{
    "fixed_interval": "1d"
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/729.console"></div>
<p>To downsample time series data as part of ILM, include a
<a class="xref" href="ilm-downsample.html" title="Downsample">Downsample action</a> in your ILM policy and set <code class="literal">fixed_interval</code>
to the level of granularity that you&#8217;d like:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.ilm.put_lifecycle(
    name="my_policy",
    policy={
        "phases": {
            "warm": {
                "actions": {
                    "downsample": {
                        "fixed_interval": "1h"
                    }
                }
            }
        }
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.ilm.put_lifecycle(
  policy: 'my_policy',
  body: {
    policy: {
      phases: {
        warm: {
          actions: {
            downsample: {
              fixed_interval: '1h'
            }
          }
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.ilm.putLifecycle({
  name: "my_policy",
  policy: {
    phases: {
      warm: {
        actions: {
          downsample: {
            fixed_interval: "1h",
          },
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="839a4b2930856790e34cc9dfeb983284"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">PUT _ilm/policy/my_policy
{
  "policy": {
    "phases": {
      "warm": {
        "actions": {
          "downsample" : {
            "fixed_interval": "1h"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/730.console"></div>
<div class="position-relative"><h3><a id="querying-downsampled-indices"></a>Querying downsampled indices</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/data-streams/downsampling.asciidoc">edit</a></div>
<p>You can use the <a class="xref" href="search-search.html" title="Search API"><code class="literal">_search</code></a> and <a class="xref" href="async-search.html" title="Async search"><code class="literal">_async_search</code></a>
endpoints to query a downsampled index. Multiple raw data and downsampled
indices can be queried in a single request, and a single request can include
downsampled indices at different granularities (different bucket timespan). That
is, you can query data streams that contain downsampled indices with multiple
downsampling intervals (for example, <code class="literal">15m</code>, <code class="literal">1h</code>, <code class="literal">1d</code>).</p>
<p>The result of a time based histogram aggregation is in a uniform bucket size and
each downsampled index returns data ignoring the downsampling time interval. For
example, if you run a <code class="literal">date_histogram</code> aggregation with <code class="literal">"fixed_interval": "1m"</code>
on a downsampled index that has been downsampled at an hourly resolution
(<code class="literal">"fixed_interval": "1h"</code>), the query returns one bucket with all of the data at
minute 0, then 59 empty buckets, and then a bucket with data again for the next
hour.</p>
<div class="position-relative"><h4><a id="querying-downsampled-indices-notes"></a>Notes on downsample queries</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/data-streams/downsampling.asciidoc">edit</a></div>
<p>There are a few things to note about querying downsampled indices:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
When you run queries in Kibana and through Elastic solutions, a normal
response is returned without notification that some of the queried indices are
downsampled.
</li>
<li class="listitem">
For
<a class="xref" href="search-aggregations-bucket-datehistogram-aggregation.html" title="Date histogram aggregation">date histogram aggregations</a>,
only <code class="literal">fixed_intervals</code> (and not calendar-aware intervals) are supported.
</li>
<li class="listitem">
<p>Timezone support comes with caveats:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Date histograms at intervals that are multiples of an hour are based on
values generated at UTC. This works well for timezones that are on the hour, e.g.
+5:00 or -3:00, but requires offsetting the reported time buckets, e.g.
<code class="literal">2020-01-01T10:30:00.000</code> instead of <code class="literal">2020-03-07T10:00:00.000</code> for
timezone +5:30 (India), if downsampling aggregates values per hour. In this case,
the results include the field <code class="literal">downsampled_results_offset: true</code>, to indicate that
the time buckets are shifted. This can be avoided if a downsampling interval of 15
minutes is used, as it allows properly calculating hourly values for the shifted
buckets.
</li>
<li class="listitem">
Date histograms at intervals that are multiples of a day are similarly
affected, in case downsampling aggregates values per day. In this case, the
beginning of each day is always calculated at UTC when generated the downsampled
values, so the time buckets need to be shifted, e.g. reported as
<code class="literal">2020-03-07T19:00:00.000</code> instead of <code class="literal">2020-03-07T00:00:00.000</code> for timezone <code class="literal">America/New_York</code>.
The field <code class="literal">downsampled_results_offset: true</code> is added in this case too.
</li>
<li class="listitem">
Daylight savings and similar peculiarities around timezones affect
reported results, as <a class="xref" href="search-aggregations-bucket-datehistogram-aggregation.html#datehistogram-aggregation-time-zone" title="Time zone">documented</a>
for date histogram aggregation. Besides, downsampling at daily interval
hinders tracking any information related to daylight savings changes.
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="position-relative"><h3><a id="downsampling-restrictions"></a>Restrictions and limitations</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/data-streams/downsampling.asciidoc">edit</a></div>
<p>The following restrictions and limitations apply for downsampling:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Only indices in a <a class="xref" href="tsds.html" title="Time series data stream (TSDS)">time series data stream</a> are supported.
</li>
<li class="listitem">
Data is downsampled based on the time dimension only. All other dimensions are
copied to the new index without any modification.
</li>
<li class="listitem">
Within a data stream, a downsampled index replaces the original index and the
original index is deleted. Only one index can exist for a given time period.
</li>
<li class="listitem">
A source index must be in read-only mode for the downsampling process to
succeed. Check the <a class="xref" href="downsampling-manual.html" title="Run downsampling manually">Run downsampling manually</a> example for
details.
</li>
<li class="listitem">
Downsampling data for the same period many times (downsampling of a
downsampled index) is supported. The downsampling interval must be a multiple of
the interval of the downsampled index.
</li>
<li class="listitem">
Downsampling is provided as an ILM action. See <a class="xref" href="ilm-downsample.html" title="Downsample">Downsample</a>.
</li>
<li class="listitem">
The new, downsampled index is created on the data tier of the original index
and it inherits its settings (for example, the number of shards and replicas).
</li>
<li class="listitem">
The numeric <code class="literal">gauge</code> and <code class="literal">counter</code> <a class="xref" href="mapping-field-meta.html" title="meta">metric types</a> are
supported.
</li>
<li class="listitem">
The downsampling configuration is extracted from the time series data stream
<a class="xref" href="set-up-tsds.html#create-tsds-index-template" title="Create an index template">index mapping</a>. The only additional
required setting is the downsampling <code class="literal">fixed_interval</code>.
</li>
</ul>
</div>
<div class="position-relative"><h3><a id="try-out-downsampling"></a>Try it out</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/data-streams/downsampling.asciidoc">edit</a></div>
<p>To take downsampling for a test run, try our example of
<a class="xref" href="downsampling-manual.html" title="Run downsampling manually">running downsampling manually</a>.</p>
<p>Downsampling can easily be added to your ILM policy. To learn how, try our
<a class="xref" href="downsampling-ilm.html" title="Run downsampling with ILM">Run downsampling with ILM</a> example.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="tsds-index-settings.html">« Time series index settings</a>
</span>
<span class="next">
<a href="downsampling-ilm.html">Run downsampling with ILM »</a>
</span>
</div>
</body>
</html>
