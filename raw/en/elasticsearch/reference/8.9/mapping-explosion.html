<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="keywords" content="Elasticsearch, high watermark, low watermark, full disk">
<title>Mapping explosion | Elasticsearch Guide [8.9] | Elastic</title>
<meta class="elastic" name="content" content="Mapping explosion | Elasticsearch Guide [8.9]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.9]"/>
<link rel="up" href="fix-common-cluster-issues.html" title="Fix common cluster issues"/>
<link rel="prev" href="task-queue-backlog.html" title="Task queue backlog"/>
<link rel="next" href="hotspotting.html" title="Hot spotting"/>
<meta class="elastic" name="product_version" content="8.9"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.9"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.9"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.9]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="troubleshooting.html">Troubleshooting</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="fix-common-cluster-issues.html">Fix common cluster issues</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="task-queue-backlog.html">« Task queue backlog</a>
</span>
<span class="next">
<a href="hotspotting.html">Hot spotting »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="mapping-explosion"></a>Mapping explosion<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/troubleshooting/common-issues/mapping-explosion.asciidoc">edit</a></h2>
</div></div></div>
<p>Elasticsearch&#8217;s search and <a href="/guide/en/kibana/8.9/discover.html" class="ulink" target="_top">Kibana&#8217;s discover</a> Javascript rendering are
dependent on the search&#8217;s backing indices total amount of
<a class="xref" href="mapping-types.html" title="Field data types">mapped fields</a>, of all mapping depths. When this total
amount is too high or is exponentially climbing, we refer to it as
experiencing mapping explosion. Field counts going this high are uncommon
and usually suggest an upstream document formatting issue as
<a href="/blog/found-crash-elasticsearch#mapping-explosion" class="ulink" target="_top">shown in this blog</a>.</p>
<p>Mapping explosion may surface as the following performance symptoms:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="cat-nodes.html" title="cat nodes API">CAT nodes</a> reporting high heap or CPU on the main node
and/or nodes hosting the indices shards. This may potentially
escalate to temporary node unresponsiveness and/or main overwhelm.
</li>
<li class="listitem">
<a class="xref" href="cat-tasks.html" title="cat task management API">CAT tasks</a> reporting long search durations only related to
this index or indices, even on simple searches.
</li>
<li class="listitem">
<a class="xref" href="cat-tasks.html" title="cat task management API">CAT tasks</a> reporting long index durations only related to
this index or indices. This usually relates to <a class="xref" href="cluster-pending.html" title="Pending cluster tasks API">pending tasks</a>
reporting that the coordinating node is waiting for all other nodes to
confirm they are on mapping update request.
</li>
<li class="listitem">
Discover&#8217;s <span class="strong strong"><strong>Fields for wildcard</strong></span> page-loading API command or <a href="/guide/en/kibana/8.9/console-kibana.html" class="ulink" target="_top">Dev Tools</a> page-refreshing Autocomplete API commands are taking a long time (more than 10 seconds) or
timing out in the browser&#8217;s Developer Tools Network tab.
</li>
<li class="listitem">
Discover&#8217;s <span class="strong strong"><strong>Available fields</strong></span> taking a long time to compile Javascript in the browser&#8217;s Developer Tools Performance tab. This may potentially escalate to temporary browser page unresponsiveness.
</li>
<li class="listitem">
Kibana&#8217;s <a href="/guide/en/kibana/8.9/alerting-getting-started.html" class="ulink" target="_top">alerting</a> or <a href="/guide/en/security/8.9/detection-engine-overview.html" class="ulink" target="_top">security rules</a> may error <code class="literal">The content length (X) is bigger than the maximum allowed string (Y)</code> where <code class="literal">X</code> is attempted payload and <code class="literal">Y</code> is Kibana&#8217;s <a href="/guide/en/kibana/8.9/settings.html#server-maxPayload" class="ulink" target="_top"><code class="literal">server-maxPayload</code></a>.
</li>
<li class="listitem">
Long Elasticsearch start-up durations.
</li>
</ul>
</div>
<h4><a id="prevent"></a>Prevent or prepare<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/troubleshooting/common-issues/mapping-explosion.asciidoc">edit</a></h4>
<p><a class="xref" href="mapping.html" title="Mapping">Mappings</a> cannot be field-reduced once initialized.
Elasticsearch indices default to <a class="xref" href="dynamic-mapping.html" title="Dynamic mapping">dynamic mappings</a> which
doesn&#8217;t normally cause problems unless it&#8217;s combined with overriding
<a class="xref" href="mapping-settings-limit.html" title="Mapping limit settings"><code class="literal">index.mapping.total_fields.limit</code></a>. The
default <code class="literal">1000</code> limit is considered generous, though overriding to <code class="literal">10000</code>
doesn&#8217;t cause noticable impact depending on use case. However, to give
a bad example, overriding to <code class="literal">100000</code> and this limit being hit
by mapping totals would usually have strong performance implications.</p>
<p>If your index mapped fields expect to contain a large, arbitrary set of
keys, you may instead consider:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Using the <a class="xref" href="flattened.html" title="Flattened field type">flattened</a> data type. Please note,
however, that flattened objects is <a href="https://github.com/elastic/kibana/issues/25820" class="ulink" target="_top">not fully supported in Kibana</a> yet. For example, this could apply to sub-mappings like { <code class="literal">host.name</code> ,
<code class="literal">host.os</code>, <code class="literal">host.version</code> }. Desired fields are still accessed by
<a class="xref" href="runtime-search-request.html" title="Define runtime fields in a search request">runtime fields</a>.
</li>
<li class="listitem">
Using the <a class="xref" href="object.html" title="Object field type">object data type</a>. This is helpful when you&#8217;re
interested in storing but not searching a group of fields. This is commonly
used for unknown upstream scenarios which may induce however many fields.
For example, this is recommended when sub-mappings start showing new,
unexpected fields like { <code class="literal">o365.a01</code>, <code class="literal">o365.a02</code>, <code class="literal">o365.b01</code>, <code class="literal">o365.c99</code>}.
</li>
<li class="listitem">
Setting <a class="xref" href="mapping-index.html" title="index"><code class="literal">index:false</code></a> to disable a particular field&#8217;s
searchability. This cannot effect current index mapping, but can apply
going forward via an <a class="xref" href="index-templates.html" title="Index templates">index template</a>.
</li>
</ul>
</div>
<p>Modifying to the <a class="xref" href="nested.html" title="Nested field type">nested</a> data type would not resolve the core
issue.</p>
<h4><a id="check"></a>Check for issue<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/troubleshooting/common-issues/mapping-explosion.asciidoc">edit</a></h4>
<p>To confirm the field totals of an index to check for mapping explosion:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Check Elasticsearch cluster logs for errors <code class="literal">Limit of total fields [X] in index [Y] has been exceeded</code> where <code class="literal">X</code> is the value of  <code class="literal">index.mapping.total_fields.limit</code> and <code class="literal">Y</code> is your index. The correlated ingesting source log error would be <code class="literal">Limit of total fields [X] has been exceeded while adding new fields [Z]</code> where <code class="literal">Z</code> is attempted new fields.
</li>
<li class="listitem">
For top-level fields, poll <a class="xref" href="search-field-caps.html" title="Field capabilities API">field capabilities</a> for <code class="literal">fields=*</code>.
</li>
<li class="listitem">
Search the output of <a class="xref" href="indices-get-mapping.html" title="Get mapping API">get mapping</a> for <code class="literal">"type"</code>.
</li>
<li class="listitem">
<p>If you&#8217;re inclined to use the <a href="https://stedolan.github.io/jq" class="ulink" target="_top">third-party tool JQ</a>, you can process the <a class="xref" href="indices-get-mapping.html" title="Get mapping API">get mapping</a> <code class="literal">mapping.json</code> output.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ cat mapping.json | jq -c 'to_entries[]| .key as $index| [.value.mappings| to_entries[]|select(.key=="properties") | {(.key):([.value|..|.type?|select(.!=null)]|length)}]| map(to_entries)| flatten| from_entries| ([to_entries[].value]|add)| {index: $index, field_count: .}'</pre>
</div>
</li>
</ul>
</div>
<p>You can use <a class="xref" href="indices-disk-usage.html" title="Analyze index disk usage API">analyze index disk usage</a> to find fields which are never or rarely populated as easy wins.</p>
<h4><a id="complex"></a>Complex explosions<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/troubleshooting/common-issues/mapping-explosion.asciidoc">edit</a></h4>
<p>Mapping explosions also covers when an individual index field totals are within limits but combined indices fields totals are very high. It&#8217;s very common for symptoms to first be noticed on a <a href="/guide/en/kibana/8.9/data-views.html" class="ulink" target="_top">data view</a> and be traced back to an individual index or a subset of indices via the
<a class="xref" href="indices-resolve-index-api.html" title="Resolve index API">resolve index API</a>.</p>
<p>However, though less common, it is possible to only experience mapping explosions on the combination of backing indices. For example, if a <a class="xref" href="data-streams.html" title="Data streams">data stream</a>'s backing indices are all at field total limit but each contain unique fields from one another.</p>
<p>This situation most easily surfaces by adding a <a href="/guide/en/kibana/8.9/data-views.html" class="ulink" target="_top">data view</a> and checking its <span class="strong strong"><strong>Fields</strong></span> tab for its total fields count. This statistic does tells you overall fields and not only where <a class="xref" href="mapping-index.html" title="index"><code class="literal">index:true</code></a>, but serves as a good baseline.</p>
<p>If your issue only surfaces via a <a href="/guide/en/kibana/8.9/data-views.html" class="ulink" target="_top">data view</a>, you may consider this menu&#8217;s <span class="strong strong"><strong>Field filters</strong></span> if you&#8217;re not using <a class="xref" href="mapping-types.html" title="Field data types">multi-fields</a>. Alternatively, you may consider a more targeted index pattern or using a negative pattern to filter-out problematic indices. For example, if <code class="literal">logs-*</code> has too high a field count because of problematic backing indices <code class="literal">logs-lotsOfFields-*</code>, then you could update to either <code class="literal">logs-*,-logs-lotsOfFields-*</code> or <code class="literal">logs-iMeantThisAnyway-*</code>.</p>
<h4><a id="resolve"></a>Resolve<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/troubleshooting/common-issues/mapping-explosion.asciidoc">edit</a></h4>
<p>Mapping explosion is not easily resolved, so it is better prevented via the above. Encountering it usually indicates unexpected upstream data changes or planning failures. If encountered, we recommend reviewing your data architecture. The following options are additional to the ones discussed earlier on this page; they should be applied as best use-case applicable:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Disable <a class="xref" href="dynamic-mapping.html" title="Dynamic mapping">dynamic mappings</a>.
</li>
<li class="listitem">
<a class="xref" href="docs-reindex.html" title="Reindex API">Reindex</a> into an index with a corrected mapping,
either via <a class="xref" href="index-templates.html" title="Index templates">index template</a> or <a class="xref" href="explicit-mapping.html" title="Explicit mapping">explicitly set</a>.
</li>
<li class="listitem">
If index is unneeded and/or historical, consider <a class="xref" href="indices-delete-index.html" title="Delete index API">deleting</a>.
</li>
<li class="listitem">
<a href="/guide/en/logstash/8.9/plugins-inputs-elasticsearch.html" class="ulink" target="_top">Export</a> and <a href="/guide/en/logstash/8.9/plugins-outputs-elasticsearch.html" class="ulink" target="_top">re-import</a> data into a mapping-corrected index after <a href="/guide/en/logstash/8.9/plugins-filters-prune.html" class="ulink" target="_top">pruning</a>
problematic fields via Logstash.
</li>
</ul>
</div>
<p><a class="xref" href="indices-split-index.html" title="Split index API">Splitting index</a> would not resolve the core issue.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="task-queue-backlog.html">« Task queue backlog</a>
</span>
<span class="next">
<a href="hotspotting.html">Hot spotting »</a>
</span>
</div>
</div>
</body>
</html>
