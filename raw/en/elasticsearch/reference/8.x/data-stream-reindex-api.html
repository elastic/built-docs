<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Reindex data stream API | Elasticsearch Guide [8.x] | Elastic</title>
<meta class="elastic" name="content" content="Reindex data stream API | Elasticsearch Guide [8.x]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.x]"/>
<link rel="up" href="migration-api.html" title="Migration APIs"/>
<link rel="prev" href="feature-migration-api.html" title="Feature migration APIs"/>
<link rel="next" href="data-stream-reindex-status-api.html" title="Reindex data stream status API"/>
<meta class="elastic" name="product_version" content="8.x"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.x"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.x"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="feature-migration-api.html">« Feature migration APIs</a>
</span>
<span class="next">
<a href="data-stream-reindex-status-api.html">Reindex data stream status API »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.x]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="rest-apis.html">REST APIs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="migration-api.html">Migration APIs</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Reindex data stream API</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/migration/apis/data-stream-reindex.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section xpack">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="data-stream-reindex-api"></a>Reindex data stream API</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/migration/apis/data-stream-reindex.asciidoc">edit</a></div>
</div></div></div>

<div class="sidebar">
<div class="titlepage"><div><div>
<p class="title"><strong>New API reference</strong></p>
</div></div></div>
<p>For the most up-to-date API details, refer to <a href="/docs/api/doc/elasticsearch/v8/group/endpoint-migration" class="ulink" target="_top">Migration APIs</a>.</p>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>These APIs are designed for indirect use by Kibana&#8217;s <span class="strong strong"><strong>Upgrade Assistant</strong></span>.
We strongly recommend you use the <span class="strong strong"><strong>Upgrade Assistant</strong></span> to upgrade from
7.17 to 8.17.0. For upgrade instructions, refer to
<a href="/guide/en/elastic-stack/8.x/upgrading-elastic-stack.html" class="ulink" target="_top">Upgrading to Elastic 8.17.0</a>.</p>
</div>
</div>
<p>The reindex data stream API is used to upgrade the backing indices of a data stream to the most
recent major version. It works by reindexing each backing index into a new index, then replacing the original
backing index with its replacement and deleting the original backing index. The settings and mappings
from the original backing indices are copied to the resulting backing indices.</p>
<p>This api runs in the background because reindexing all indices in a large data stream
is expected to take a large amount of time and resources. The endpoint will return immediately and a persistent
task will be created to run in the background. The current status of the task can be checked with
the <a class="xref" href="data-stream-reindex-status-api.html" title="Reindex data stream status API">reindex status API</a>. This status will be available for 24 hours after the task completes, whether
it finished successfully or failed. If the status is still available for a task, the task must be cancelled before it can be re-run.
A running or recently completed data stream reindex task can be cancelled using the <a class="xref" href="data-stream-reindex-cancel-api.html" title="Reindex data stream cancel API">reindex cancel API</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="data-stream-reindex-api-request"></a>Request</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/migration/apis/data-stream-reindex.asciidoc">edit</a></div>
</div></div></div>
<p><code class="literal">POST /_migration/reindex</code></p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="data-stream-reindex-api-prereqs"></a>Prerequisites</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/migration/apis/data-stream-reindex.asciidoc">edit</a></div>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If the Elasticsearch security features are enabled, you must have the <code class="literal">manage</code>
<a class="xref" href="security-privileges.html#privileges-list-indices" title="Indices privileges">index privilege</a> for the data stream.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="data-stream-reindex-body"></a>Request body</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/migration/apis/data-stream-reindex.asciidoc">edit</a></div>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">source</code>
</span>
</dt>
<dd>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">index</code>
</span>
</dt>
<dd>
(Required, string) The name of the data stream to upgrade.
</dd>
</dl>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">mode</code>
</span>
</dt>
<dd>
(Required, enum) Set to <code class="literal">upgrade</code> to upgrade the data stream in-place, using the same source and destination
data stream. Each out-of-date backing index will be reindexed. Then the new backing index is swapped into the data stream and the old index is deleted.
Currently, the only allowed value for this parameter is <code class="literal">upgrade</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="reindex-data-stream-api-settings"></a>Settings</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/migration/apis/data-stream-reindex.asciidoc">edit</a></div>
</div></div></div>
<p>You can use the following settings to control the behavior of the reindex data stream API:</p>
<p><a id="migrate_max_concurrent_indices_reindexed_per_data_stream-setting"></a><code class="literal">migrate.max_concurrent_indices_reindexed_per_data_stream</code>
(<a class="xref" href="settings.html#dynamic-cluster-setting">Dynamic</a>)
The number of backing indices within a given data stream which will be reindexed concurrently. Defaults to <code class="literal">1</code>.</p>
<p><a id="migrate_data_stream_reindex_max_request_per_second-setting"></a><code class="literal">migrate.data_stream_reindex_max_request_per_second</code>
(<a class="xref" href="settings.html#dynamic-cluster-setting">Dynamic</a>)
The average maximum number of documents within a given backing index to reindex per second.
Defaults to <code class="literal">1000</code>, though can be any decimal number greater than <code class="literal">0</code>.
To remove throttling, set to <code class="literal">-1</code>.
This setting can be used to throttle the reindex process and manage resource usage.
Consult the <a class="xref" href="docs-reindex.html#docs-reindex-throttle" title="Throttling">reindex throttle docs</a> for more information.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="reindex-data-stream-api-example"></a>Examples</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/migration/apis/data-stream-reindex.asciidoc">edit</a></div>
</div></div></div>
<p>Assume we have a data stream <code class="literal">my-data-stream</code> with the following backing indices, all of which have index major version 7.x.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
.ds-my-data-stream-2025.01.23-000001
</li>
<li class="listitem">
.ds-my-data-stream-2025.01.23-000002
</li>
<li class="listitem">
.ds-my-data-stream-2025.01.23-000003
</li>
</ul>
</div>
<p>Let&#8217;s also assume that <code class="literal">.ds-my-data-stream-2025.01.23-000003</code> is the write index.
If Elasticsearch is version 8.x and we wish to upgrade to major version 9.x, the version 7.x indices must be upgraded in preparation.
We can use this API to reindex a data stream with version 7.x backing indices and make them version 8 backing indices.</p>
<p>Start by calling the API:</p>
<a id="29aeabacb1fdf5b083d5f091b6d1bd44"></a>
<a id="reindex-data-stream-start"></a><div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">POST _migration/reindex
{
    "source": {
        "index": "my-data-stream"
    },
    "mode": "upgrade"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/3112.console"></div>
<p>As this task runs in the background this API will return immediately.
The task will do the following.</p>
<p>First, the data stream is rolled over. So that no documents are lost during the reindex, we add <a class="xref" href="index-modules-blocks.html#index-block-settings" title="Index block settings">write blocks</a>
 to the existing backing indices before reindexing them. Since a data stream&#8217;s write index cannot have a write block,
 the data stream is must be rolled over. This will produce a new write index, <code class="literal">.ds-my-data-stream-2025.01.23-000004</code>; which
  has an 8.x version and thus does not need to be upgraded.</p>
<p>Once the data stream has a write index with an 8.x version we can proceed with reindexing the old indices.
For each of the version 7.x indices, we now do the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add a write block to the source index to guarantee that no writes are lost.
</li>
<li class="listitem">
Open the source index if it is closed.
</li>
<li class="listitem">
Delete the destination index if one exists. This is done in case we are retrying after a failure, so that we start with a fresh index.
</li>
<li class="listitem">
Create the destination index using the <a class="xref" href="indices-create-index-from-source.html" title="Create index from source API">create from source API</a>.
This copies the settings and mappings from the old backing index to the new backing index.
</li>
<li class="listitem">
Use the <a class="xref" href="docs-reindex.html" title="Reindex API">reindex API</a> to copy the contents of the old backing index to the new backing index.
</li>
<li class="listitem">
Close the destination index if the source index was originally closed.
</li>
<li class="listitem">
Replace the old index in the data stream with the new index, using the <a class="xref" href="modify-data-streams-api.html" title="Modify data streams API">modify data streams API</a>.
</li>
<li class="listitem">
Finally, the old backing index is deleted.
</li>
</ul>
</div>
<p>By default only one backing index will be processed at a time.
This can be modified using the <a class="xref" href="data-stream-reindex-api.html#migrate_max_concurrent_indices_reindexed_per_data_stream-setting"><code class="literal">migrate_max_concurrent_indices_reindexed_per_data_stream-setting</code> setting</a>.</p>
<p>While the reindex data stream task is running, we can inspect the current status using the <a class="xref" href="data-stream-reindex-status-api.html" title="Reindex data stream status API">reindex status API</a>:</p>
<a id="46b771a9932c3fa6057a7b2679c72ef0"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET /_migration/reindex/my-data-stream/_status</pre>
</div>
<div class="console_widget" data-snippet="snippets/3113.console"></div>
<p>For the above example, the following would be a possible status:</p>
<a id="505bf5b3f9ced62e9bcbd9129822e099"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "start_time_millis": 1737676174349,
  "complete": false,
  "total_indices_in_data_stream": 4,
  "total_indices_requiring_upgrade": 3,
  "successes": 0,
  "in_progress": [
    {
      "index": ".ds-my-data-stream-2025.01.23-000001",
      "total_doc_count": 10000000,
      "reindexed_doc_count": 999999
    }
  ],
  "pending": 2,
  "errors": []
}</pre>
</div>
<p>This output means that the first backing index, <code class="literal">.ds-my-data-stream-2025.01.23-000001</code>, is currently being processed,
and none of the backing indices have yet completed. Notice that <code class="literal">total_indices_in_data_stream</code> has a value of <code class="literal">4</code>,
because after the rollover, there are 4 indices in the data stream. But the new write index has an 8.x version, and
thus doesn&#8217;t need to be reindexed, so <code class="literal">total_indices_requiring_upgrade</code> is only 3.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="reindex-data-stream-cancel-restart"></a>Cancelling and Restarting</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/migration/apis/data-stream-reindex.asciidoc">edit</a></div>
</div></div></div>
<p>The <a class="xref" href="data-stream-reindex-api.html#reindex-data-stream-api-settings" title="Settings">reindex datastream settings</a> provide a few ways to control the performance and
resource usage of a reindex task. This example shows how we can stop a running reindex task, modify the settings,
and restart the task.</p>
<p>Continuing with the above example, assume the reindexing task has not yet completed, and the <a class="xref" href="data-stream-reindex-status-api.html" title="Reindex data stream status API">reindex status API</a>
returns the following:</p>
<a id="31df20ef9535f05e9c08559a496a5285"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "start_time_millis": 1737676174349,
  "complete": false,
  "total_indices_in_data_stream": 4,
  "total_indices_requiring_upgrade": 3,
  "successes": 1,
  "in_progress": [
    {
      "index": ".ds-my-data-stream-2025.01.23-000002",
      "total_doc_count": 10000000,
      "reindexed_doc_count": 1000
    }
  ],
  "pending": 1,
  "errors": []
}</pre>
</div>
<p>Let&#8217;s assume the task has been running for a long time. By default, we throttle how many requests the reindex operation
can execute per second. This keeps the reindex process from consuming too many resources.
But the default value of <code class="literal">1000</code> request per second will not be correct for all use cases.
The <a class="xref" href="data-stream-reindex-api.html#migrate_data_stream_reindex_max_request_per_second-setting"><code class="literal">migrate.data_stream_reindex_max_request_per_second</code> setting</a>
can be used to increase or decrease the number of requests per second, or to remove the throttle entirely.</p>
<p>Changing this setting won&#8217;t have an effect on the backing index that is currently being reindexed.
For example, changing the setting won&#8217;t have an effect on <code class="literal">.ds-my-data-stream-2025.01.23-000002</code>, but would have an
effect on the next backing index.</p>
<p>But in the above status, <code class="literal">.ds-my-data-stream-2025.01.23-000002</code> has values of 1000 and 10M for the
<code class="literal">reindexed_doc_count</code> and <code class="literal">total_doc_count</code>, respectively. This means it has only reindexed 0.01% of the documents in the index.
It might be a good time to cancel the run and optimize some settings without losing much work.
So we call the <a class="xref" href="data-stream-reindex-cancel-api.html" title="Reindex data stream cancel API">cancel API</a>:</p>
<a id="15ac33d641b376d9494075eb1f0d4066"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">POST /_migration/reindex/my-data-stream/_cancel</pre>
</div>
<div class="console_widget" data-snippet="snippets/3114.console"></div>
<p>Now we can use the <a class="xref" href="cluster-update-settings.html" title="Cluster update settings API">update cluster settings API</a> to increase the throttle:</p>
<a id="537bce129338d9227bccb6a0283dab45"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">PUT /_cluster/settings
{
  "persistent" : {
    "migrate.data_stream_reindex_max_request_per_second" : 10000
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/3115.console"></div>
<p>The <a class="xref" href="data-stream-reindex-api.html#reindex-data-stream-start">original reindex command</a> can now be used to restart reindexing.
Because the first backing index, <code class="literal">.ds-my-data-stream-2025.01.23-000001</code>, has already been reindexed and thus is already version 8.x,
it will be skipped. The task will start by reindexing <code class="literal">.ds-my-data-stream-2025.01.23-000002</code> again from the beginning.</p>
<p>Later, once all the backing indices have finished, the <a class="xref" href="data-stream-reindex-status-api.html" title="Reindex data stream status API">reindex status API</a> will return something like the following:</p>
<a id="92479fb9e59c513da79fdff1e427d7f4"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "start_time_millis": 1737676174349,
  "complete": true,
  "total_indices_in_data_stream": 4,
  "total_indices_requiring_upgrade": 2,
  "successes": 2,
  "in_progress": [],
  "pending": 0,
  "errors": []
}</pre>
</div>
<p>Notice that the value of <code class="literal">total_indices_requiring_upgrade</code> is <code class="literal">2</code>, unlike the previous status, which had a value of <code class="literal">3</code>.
This is because <code class="literal">.ds-my-data-stream-2025.01.23-000001</code> was upgraded before the task cancellation.
After the restart, the API sees that it does not need to be upgraded, thus does not include it in <code class="literal">total_indices_requiring_upgrade</code> or <code class="literal">successes</code>,
despite the fact that it upgraded successfully.</p>
<p>The completed status will be accessible from the status API for 24 hours after completion of the task.</p>
<p>We can now check the data stream to verify that indices were upgraded:</p>
<a id="00ad41bde67beac991534ae0e04b1296"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET _data_stream/my-data-stream?filter_path=data_streams.indices.index_name</pre>
</div>
<div class="console_widget" data-snippet="snippets/3116.console"></div>
<p>which returns:</p>
<a id="bd7689022b16f7ebbf95d58c44aa055e"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "data_streams": [
    {
      "indices": [
        {
          "index_name": ".migrated-ds-my-data-stream-2025.01.23-000003"
        },
        {
          "index_name": ".migrated-ds-my-data-stream-2025.01.23-000002"
        },
        {
          "index_name": ".migrated-ds-my-data-stream-2025.01.23-000001"
        },
        {
          "index_name": ".ds-my-data-stream-2025.01.23-000004"
        }
      ]
    }
  ]
}</pre>
</div>
<p>Index <code class="literal">.ds-my-data-stream-2025.01.23-000004</code> is the write index and didn&#8217;t need to be upgraded because it was created with version 8.x.
The other three backing indices are now prefixed with <code class="literal">.migrated</code> because they have been upgraded.</p>
<p>We can now check the indices and verify that they have version 8.x:</p>
<a id="a675fafa7c688cb3ea1be09bf887ebf0"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET .migrated-ds-my-data-stream-2025.01.23-000001?human&amp;filter_path=*.settings.index.version.created_string</pre>
</div>
<div class="console_widget" data-snippet="snippets/3117.console"></div>
<p>which returns:</p>
<a id="f94c445fb1b98e187c0b737ade6dcf1c"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  ".migrated-ds-my-data-stream-2025.01.23-000001": {
    "settings": {
      "index": {
        "version": {
          "created_string": "8.18.0"
        }
      }
    }
  }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="reindex-data-stream-handling-failure"></a>Handling Failures</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/migration/apis/data-stream-reindex.asciidoc">edit</a></div>
</div></div></div>
<p>Since the reindex data stream API runs in the background, failure information can be obtained through the <a class="xref" href="data-stream-reindex-status-api.html" title="Reindex data stream status API">reindex status API</a>.
For example, if the backing index <code class="literal">.ds-my-data-stream-2025.01.23-000002</code> was accidentally deleted by a user, we would see a status like the following:</p>
<a id="3e7392751e7f290a658d7162592ca8f5"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "start_time_millis": 1737676174349,
  "complete": false,
  "total_indices_in_data_stream": 4,
  "total_indices_requiring_upgrade": 3,
  "successes": 1,
  "in_progress": [],
  "pending": 1,
  "errors": [
    {
      "index": ".ds-my-data-stream-2025.01.23-000002",
      "message": "index [.ds-my-data-stream-2025.01.23-000002] does not exist"
    }
  ]
}</pre>
</div>
<p>Once the issue has been fixed, the failed reindex task can be re-run. First, the failed run&#8217;s status must be cleared
using the <a class="xref" href="data-stream-reindex-cancel-api.html" title="Reindex data stream cancel API">reindex cancel API</a>. Then the
<a class="xref" href="data-stream-reindex-api.html#reindex-data-stream-start">original reindex command</a> can be called to pick up where it left off.</p>
</div>

</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="feature-migration-api.html">« Feature migration APIs</a>
</span>
<span class="next">
<a href="data-stream-reindex-status-api.html">Reindex data stream status API »</a>
</span>
</div>
</body>
</html>
