<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Script score query | Elasticsearch Guide [8.x] | Elastic</title>
<meta class="elastic" name="content" content="Script score query | Elasticsearch Guide [8.x]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.x]"/>
<link rel="up" href="specialized-queries.html" title="Specialized queries"/>
<link rel="prev" href="query-dsl-script-query.html" title="Script query"/>
<link rel="next" href="query-dsl-wrapper-query.html" title="Wrapper query"/>
<meta class="elastic" name="product_version" content="8.x"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.x"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.x"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="query-dsl-script-query.html">« Script query</a>
</span>
<span class="next">
<a href="query-dsl-wrapper-query.html">Wrapper query »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.x]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="query-dsl.html">Query DSL</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="specialized-queries.html">Specialized queries</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Script score query</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="query-dsl-script-score-query"></a>Script score query</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>

<p>Uses a <a class="xref" href="modules-scripting.html" title="Scripting">script</a> to provide a custom score for returned
documents.</p>
<p>The <code class="literal">script_score</code> query is useful if, for example, a scoring function is expensive and you only need to calculate the score of a filtered set of documents.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="script-score-query-ex-request"></a>Example request</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p>The following <code class="literal">script_score</code> query assigns each returned document a score equal to the <code class="literal">my-int</code> field value divided by <code class="literal">10</code>.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.search(
    query={
        "script_score": {
            "query": {
                "match": {
                    "message": "elasticsearch"
                }
            },
            "script": {
                "source": "doc['my-int'].value / 10 "
            }
        }
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  body: {
    query: {
      script_score: {
        query: {
          match: {
            message: 'elasticsearch'
          }
        },
        script: {
          source: "doc['my-int'].value / 10 "
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  query: {
    script_score: {
      query: {
        match: {
          message: "elasticsearch",
        },
      },
      script: {
        source: "doc['my-int'].value / 10 ",
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="ada2675a9c631da2bfe627fc2618f5ed"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET /_search
{
  "query": {
    "script_score": {
      "query": {
        "match": { "message": "elasticsearch" }
      },
      "script": {
        "source": "doc['my-int'].value / 10 "
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/1378.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="script-score-top-level-params"></a>Top-level parameters for <code class="literal">script_score</code></h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">query</code>
</span>
</dt>
<dd>
(Required, query object) Query used to return documents.
</dd>
<dt>
<span class="term">
<code class="literal">script</code>
</span>
</dt>
<dd>
<p>(Required, <a class="xref" href="modules-scripting-using.html" title="How to write scripts">script object</a>) Script used to compute the score of documents returned by the <code class="literal">query</code>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Final relevance scores from the <code class="literal">script_score</code> query cannot be
negative. To support certain search optimizations, Lucene requires
scores be positive or <code class="literal">0</code>.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">min_score</code>
</span>
</dt>
<dd>
(Optional, float) Documents with a score lower
than this floating point number are excluded from the search results.
</dd>
<dt>
<span class="term">
<code class="literal">boost</code>
</span>
</dt>
<dd>
(Optional, float) Documents' scores produced by <code class="literal">script</code> are
multiplied by <code class="literal">boost</code> to produce final documents' scores. Defaults to <code class="literal">1.0</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="script-score-query-notes"></a>Notes</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="script-score-access-scores"></a>Use relevance scores in a script</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p>Within a script, you can
<a href="/guide/en/elasticsearch/reference/8.x/modules-scripting-fields.html#scripting-score" class="ulink" target="_top">access</a>
the <code class="literal">_score</code> variable which represents the current relevance score of a
document.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="script-score-access-term-statistics"></a>Use term statistics in a script</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p>Within a script, you can
<a href="/guide/en/elasticsearch/reference/8.x/modules-scripting-fields.html#scripting-term-statistics" class="ulink" target="_top">access</a>
the <code class="literal">_termStats</code> variable which provides statistical information about the terms used in the child query of the <code class="literal">script_score</code> query.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="script-score-predefined-functions"></a>Predefined functions</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p>You can use any of the available <a href="/guide/en/elasticsearch/painless/8.x/painless-contexts.html" class="ulink" target="_top">painless
functions</a> in your <code class="literal">script</code>. You can also use the following predefined functions
to customize scoring:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#script-score-saturation" title="Saturation">Saturation</a>
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#script-score-sigmoid" title="Sigmoid">Sigmoid</a>
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#random-score-function" title="Random score function">Random score function</a>
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#decay-functions-numeric-fields" title="Decay functions for numeric fields">Decay functions for numeric fields</a>
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#decay-functions-geo-fields" title="Decay functions for geo fields">Decay functions for geo fields</a>
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#decay-functions-date-fields" title="Decay functions for date fields">Decay functions for date fields</a>
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#script-score-functions-vector-fields" title="Functions for vector fields">Functions for vector fields</a>
</li>
</ul>
</div>
<p>We suggest using these predefined functions instead of writing your own.
These functions take advantage of efficiencies from Elasticsearch' internal mechanisms.</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="script-score-saturation"></a>Saturation</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p><code class="literal">saturation(value,k) = value/(k + value)</code></p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "saturation(doc['my-int'].value, 1)"
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="script-score-sigmoid"></a>Sigmoid</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p><code class="literal">sigmoid(value, k, a) = value^a/ (k^a + value^a)</code></p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "sigmoid(doc['my-int'].value, 2, 1)"
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="random-score-function"></a>Random score function</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p><code class="literal">random_score</code> function generates scores that are uniformly distributed
from 0 up to but not including 1.</p>
<p><code class="literal">randomScore</code> function has the following syntax:
<code class="literal">randomScore(&lt;seed&gt;, &lt;fieldName&gt;)</code>.
It has a required parameter - <code class="literal">seed</code> as an integer value,
and an optional parameter - <code class="literal">fieldName</code> as a string value.</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "randomScore(100, '_seq_no')"
}</pre>
</div>
<p>If the <code class="literal">fieldName</code> parameter is omitted, the internal Lucene
document ids will be used as a source of randomness. This is very efficient,
but unfortunately not reproducible since documents might be renumbered
by merges.</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "randomScore(100)"
}</pre>
</div>
<p>Note that documents that are within the same shard and have the
same value for field will get the same score, so it is usually desirable
to use a field that has unique values for all documents across a shard.
A good default choice might be to use the <code class="literal">_seq_no</code>
field, whose only drawback is that scores will change if the document is
updated since update operations also update the value of the <code class="literal">_seq_no</code> field.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="decay-functions-numeric-fields"></a>Decay functions for numeric fields</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p>You can read more about decay functions
<a href="/guide/en/elasticsearch/reference/8.x/query-dsl-function-score-query.html#function-decay" class="ulink" target="_top">here</a>.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">double decayNumericLinear(double origin, double scale, double offset, double decay, double docValue)</code>
</li>
<li class="listitem">
<code class="literal">double decayNumericExp(double origin, double scale, double offset, double decay, double docValue)</code>
</li>
<li class="listitem">
<code class="literal">double decayNumericGauss(double origin, double scale, double offset, double decay, double docValue)</code>
</li>
</ul>
</div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "decayNumericLinear(params.origin, params.scale, params.offset, params.decay, doc['dval'].value)",
    "params": { <a id="CO353-1"></a><i class="conum" data-value="1"></i>
        "origin": 20,
        "scale": 10,
        "decay" : 0.5,
        "offset" : 0
    }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO353-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Using <code class="literal">params</code> allows to compile the script only once, even if params change.</p>
</td>
</tr>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="decay-functions-geo-fields"></a>Decay functions for geo fields</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">double decayGeoLinear(String originStr, String scaleStr, String offsetStr, double decay, GeoPoint docValue)</code>
</li>
<li class="listitem">
<code class="literal">double decayGeoExp(String originStr, String scaleStr, String offsetStr, double decay, GeoPoint docValue)</code>
</li>
<li class="listitem">
<code class="literal">double decayGeoGauss(String originStr, String scaleStr, String offsetStr, double decay, GeoPoint docValue)</code>
</li>
</ul>
</div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "decayGeoExp(params.origin, params.scale, params.offset, params.decay, doc['location'].value)",
    "params": {
        "origin": "40, -70.12",
        "scale": "200km",
        "offset": "0km",
        "decay" : 0.2
    }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="decay-functions-date-fields"></a>Decay functions for date fields</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">double decayDateLinear(String originStr, String scaleStr, String offsetStr, double decay, JodaCompatibleZonedDateTime docValueDate)</code>
</li>
<li class="listitem">
<code class="literal">double decayDateExp(String originStr, String scaleStr, String offsetStr, double decay, JodaCompatibleZonedDateTime docValueDate)</code>
</li>
<li class="listitem">
<code class="literal">double decayDateGauss(String originStr, String scaleStr, String offsetStr, double decay, JodaCompatibleZonedDateTime docValueDate)</code>
</li>
</ul>
</div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "decayDateGauss(params.origin, params.scale, params.offset, params.decay, doc['date'].value)",
    "params": {
        "origin": "2008-01-01T01:00:00Z",
        "scale": "1h",
        "offset" : "0",
        "decay" : 0.5
    }
}</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Decay functions on dates are limited to dates in the default format
and default time zone. Also calculations with <code class="literal">now</code> are not supported.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="script-score-functions-vector-fields"></a>Functions for vector fields</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p><a class="xref" href="query-dsl-script-score-query.html#vector-functions" title="Functions for vector fields">Functions for vector fields</a> are accessible through
<code class="literal">script_score</code> query.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="_allow_expensive_queries_5"></a>Allow expensive queries</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p>Script score queries will not be executed if <a class="xref" href="query-dsl.html#query-dsl-allow-expensive-queries"><code class="literal">search.allow_expensive_queries</code></a>
is set to false.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="script-score-faster-alt"></a>Faster alternatives</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p>The <code class="literal">script_score</code> query calculates the score for
every matching document, or hit. There are faster alternative query types that
can efficiently skip non-competitive hits:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If you want to boost documents on some static fields, use the
<a class="xref" href="query-dsl-rank-feature-query.html" title="Rank feature query"><code class="literal">rank_feature</code></a> query.
</li>
<li class="listitem">
If you want to boost documents closer to a date or geographic point, use the
<a class="xref" href="query-dsl-distance-feature-query.html" title="Distance feature query"><code class="literal">distance_feature</code></a> query.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="script-score-function-score-transition"></a>Transition from the function score query</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p>We recommend using the <code class="literal">script_score</code> query instead of
<a class="xref" href="query-dsl-function-score-query.html" title="Function score query"><code class="literal">function_score</code></a> query for the simplicity
of the <code class="literal">script_score</code> query.</p>
<p>You can implement the following functions of the <code class="literal">function_score</code> query using
the <code class="literal">script_score</code> query:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#script-score" title="script_score"><code class="literal">script_score</code></a>
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#weight" title="weight"><code class="literal">weight</code></a>
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#random-score" title="random_score"><code class="literal">random_score</code></a>
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#field-value-factor" title="field_value_factor"><code class="literal">field_value_factor</code></a>
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#decay-functions" title="decay functions"><code class="literal">decay</code> functions</a>
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="script-score"></a><code class="literal">script_score</code></h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p>What you used in <code class="literal">script_score</code> of the Function Score query, you
can copy into the Script Score query. No changes here.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="weight"></a><code class="literal">weight</code></h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p><code class="literal">weight</code> function can be implemented in the Script Score query through
the following script:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "params.weight * _score",
    "params": {
        "weight": 2
    }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="random-score"></a><code class="literal">random_score</code></h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p>Use <code class="literal">randomScore</code> function
as described in <a class="xref" href="query-dsl-script-score-query.html#random-score-function" title="Random score function">random score function</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="field-value-factor"></a><code class="literal">field_value_factor</code></h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p><code class="literal">field_value_factor</code> function can be easily implemented through script:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "Math.log10(doc['field'].value * params.factor)",
    "params" : {
        "factor" : 5
    }
}</pre>
</div>
<p>For checking if a document has a missing value, you can use
<code class="literal">doc['field'].size() == 0</code>. For example, this script will use
a value <code class="literal">1</code> if a document doesn&#8217;t have a field <code class="literal">field</code>:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "Math.log10((doc['field'].size() == 0 ? 1 : doc['field'].value()) * params.factor)",
    "params" : {
        "factor" : 5
    }
}</pre>
</div>
<p>This table lists how <code class="literal">field_value_factor</code> modifiers can be implemented
through a script:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Modifier</th>
<th align="left" valign="top">Implementation in Script Score</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">none</code></p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">log</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.log10(doc['f'].value)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">log1p</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.log10(doc['f'].value + 1)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">log2p</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.log10(doc['f'].value + 2)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ln</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.log(doc['f'].value)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ln1p</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.log(doc['f'].value + 1)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ln2p</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.log(doc['f'].value + 2)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">square</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.pow(doc['f'].value, 2)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">sqrt</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.sqrt(doc['f'].value)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">reciprocal</code></p></td>
<td align="left" valign="top"><p><code class="literal">1.0 / doc['f'].value</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="decay-functions"></a><code class="literal">decay</code> functions</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p>The <code class="literal">script_score</code> query has equivalent <a class="xref" href="query-dsl-script-score-query.html#decay-functions-numeric-fields" title="Decay functions for numeric fields">decay
functions</a> that can be used in scripts.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="vector-functions"></a>Functions for vector fields</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/vectors/vector-functions.asciidoc">edit</a></div>
</div></div></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>During vector functions' calculation, all matched documents are
linearly scanned. Thus, expect the query time grow linearly
with the number of matched documents. For this reason, we recommend
to limit the number of matched documents with a <code class="literal">query</code> parameter.</p>
</div>
</div>
<p>This is the list of available vector functions and vector access methods:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#vector-functions-cosine" title="Cosine similarity"><code class="literal">cosineSimilarity</code></a> – calculates cosine similarity
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#vector-functions-dot-product" title="Dot product"><code class="literal">dotProduct</code></a> – calculates dot product
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#vector-functions-l1" title="L1 distance (Manhattan distance)"><code class="literal">l1norm</code></a> – calculates L<sup>1</sup> distance
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#vector-functions-hamming" title="Hamming distance"><code class="literal">hamming</code></a> – calculates Hamming distance
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#vector-functions-l2" title="L2 distance (Euclidean distance)"><code class="literal">l2norm</code></a> - calculates L<sup>2</sup> distance
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#vector-functions-accessing-vectors" title="Accessing vectors directly"><code class="literal">doc[&lt;field&gt;].vectorValue</code></a> – returns a vector&#8217;s value as an array of floats
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#vector-functions-accessing-vectors" title="Accessing vectors directly"><code class="literal">doc[&lt;field&gt;].magnitude</code></a> – returns a vector&#8217;s magnitude
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <code class="literal">cosineSimilarity</code> function is not supported for <code class="literal">bit</code> vectors.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The recommended way to access dense vectors is through the
<code class="literal">cosineSimilarity</code>, <code class="literal">dotProduct</code>, <code class="literal">l1norm</code> or <code class="literal">l2norm</code> functions. Please note
however, that you should call these functions only once per script. For example,
don’t use these functions in a loop to calculate the similarity between a
document vector and multiple other vectors. If you need that functionality,
reimplement these functions yourself by
<a class="xref" href="query-dsl-script-score-query.html#vector-functions-accessing-vectors" title="Accessing vectors directly">accessing vector values directly</a>.</p>
</div>
</div>
<p>Let&#8217;s create an index with a <code class="literal">dense_vector</code> mapping and index a couple
of documents into it.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.create(
    index="my-index-000001",
    mappings={
        "properties": {
            "my_dense_vector": {
                "type": "dense_vector",
                "index": False,
                "dims": 3
            },
            "my_byte_dense_vector": {
                "type": "dense_vector",
                "index": False,
                "dims": 3,
                "element_type": "byte"
            },
            "status": {
                "type": "keyword"
            }
        }
    },
)
print(resp)

resp1 = client.index(
    index="my-index-000001",
    id="1",
    document={
        "my_dense_vector": [
            0.5,
            10,
            6
        ],
        "my_byte_dense_vector": [
            0,
            10,
            6
        ],
        "status": "published"
    },
)
print(resp1)

resp2 = client.index(
    index="my-index-000001",
    id="2",
    document={
        "my_dense_vector": [
            -0.5,
            10,
            10
        ],
        "my_byte_dense_vector": [
            0,
            10,
            10
        ],
        "status": "published"
    },
)
print(resp2)

resp3 = client.indices.refresh(
    index="my-index-000001",
)
print(resp3)</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.create({
  index: "my-index-000001",
  mappings: {
    properties: {
      my_dense_vector: {
        type: "dense_vector",
        index: false,
        dims: 3,
      },
      my_byte_dense_vector: {
        type: "dense_vector",
        index: false,
        dims: 3,
        element_type: "byte",
      },
      status: {
        type: "keyword",
      },
    },
  },
});
console.log(response);

const response1 = await client.index({
  index: "my-index-000001",
  id: 1,
  document: {
    my_dense_vector: [0.5, 10, 6],
    my_byte_dense_vector: [0, 10, 6],
    status: "published",
  },
});
console.log(response1);

const response2 = await client.index({
  index: "my-index-000001",
  id: 2,
  document: {
    my_dense_vector: [-0.5, 10, 10],
    my_byte_dense_vector: [0, 10, 10],
    status: "published",
  },
});
console.log(response2);

const response3 = await client.indices.refresh({
  index: "my-index-000001",
});
console.log(response3);</pre>
</div>
<a id="276e5b71ff5c6879a9b819076ad82301"></a>
<div class="pre_wrapper lang-console default has-python has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-js">PUT my-index-000001
{
  "mappings": {
    "properties": {
      "my_dense_vector": {
        "type": "dense_vector",
        "index": false,
        "dims": 3
      },
      "my_byte_dense_vector": {
        "type": "dense_vector",
        "index": false,
        "dims": 3,
        "element_type": "byte"
      },
      "status" : {
        "type" : "keyword"
      }
    }
  }
}

PUT my-index-000001/_doc/1
{
  "my_dense_vector": [0.5, 10, 6],
  "my_byte_dense_vector": [0, 10, 6],
  "status" : "published"
}

PUT my-index-000001/_doc/2
{
  "my_dense_vector": [-0.5, 10, 10],
  "my_byte_dense_vector": [0, 10, 10],
  "status" : "published"
}

POST my-index-000001/_refresh</pre>
</div>
<div class="console_widget has-python has-js" data-snippet="snippets/1379.console"></div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="vector-functions-cosine"></a>Cosine similarity</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/vectors/vector-functions.asciidoc">edit</a></div>
</div></div></div>
<p>The <code class="literal">cosineSimilarity</code> function calculates the measure of
cosine similarity between a given query vector and document vectors.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.search(
    index="my-index-000001",
    query={
        "script_score": {
            "query": {
                "bool": {
                    "filter": {
                        "term": {
                            "status": "published"
                        }
                    }
                }
            },
            "script": {
                "source": "cosineSimilarity(params.query_vector, 'my_dense_vector') + 1.0",
                "params": {
                    "query_vector": [
                        4,
                        3.4,
                        -0.2
                    ]
                }
            }
        }
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'my-index-000001',
  body: {
    query: {
      script_score: {
        query: {
          bool: {
            filter: {
              term: {
                status: 'published'
              }
            }
          }
        },
        script: {
          source: "cosineSimilarity(params.query_vector, 'my_dense_vector') + 1.0",
          params: {
            query_vector: [
              4,
              3.4,
              -0.2
            ]
          }
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index-000001",
  query: {
    script_score: {
      query: {
        bool: {
          filter: {
            term: {
              status: "published",
            },
          },
        },
      },
      script: {
        source:
          "cosineSimilarity(params.query_vector, 'my_dense_vector') + 1.0",
        params: {
          query_vector: [4, 3.4, -0.2],
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="1eea46b08610972b79fdc4649748455d"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET my-index-000001/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published" <a id="CO354-1"></a><i class="conum" data-value="1"></i>
            }
          }
        }
      },
      "script": {
        "source": "cosineSimilarity(params.query_vector, 'my_dense_vector') + 1.0", <a id="CO354-2"></a><i class="conum" data-value="2"></i>
        "params": {
          "query_vector": [4, 3.4, -0.2]  <a id="CO354-3"></a><i class="conum" data-value="3"></i>
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/1380.console"></div>
<div class="calloutlist default has-python has-ruby has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO354-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>To restrict the number of documents on which script score calculation is applied, provide a filter.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO354-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The script adds 1.0 to the cosine similarity to prevent the score from being negative.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO354-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>To take advantage of the script optimizations, provide a query vector as a script parameter.</p>
</td>
</tr>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If a document&#8217;s dense vector field has a number of dimensions
different from the query&#8217;s vector, an error will be thrown.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="vector-functions-dot-product"></a>Dot product</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/vectors/vector-functions.asciidoc">edit</a></div>
</div></div></div>
<p>The <code class="literal">dotProduct</code> function calculates the measure of
dot product between a given query vector and document vectors.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.search(
    index="my-index-000001",
    query={
        "script_score": {
            "query": {
                "bool": {
                    "filter": {
                        "term": {
                            "status": "published"
                        }
                    }
                }
            },
            "script": {
                "source": "\n          double value = dotProduct(params.query_vector, 'my_dense_vector');\n          return sigmoid(1, Math.E, -value); \n        ",
                "params": {
                    "query_vector": [
                        4,
                        3.4,
                        -0.2
                    ]
                }
            }
        }
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'my-index-000001',
  body: {
    query: {
      script_score: {
        query: {
          bool: {
            filter: {
              term: {
                status: 'published'
              }
            }
          }
        },
        script: {
          source: "\n          double value = dotProduct(params.query_vector, 'my_dense_vector');\n          return sigmoid(1, Math.E, -value); \n        ",
          params: {
            query_vector: [
              4,
              3.4,
              -0.2
            ]
          }
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index-000001",
  query: {
    script_score: {
      query: {
        bool: {
          filter: {
            term: {
              status: "published",
            },
          },
        },
      },
      script: {
        source:
          "\n          double value = dotProduct(params.query_vector, 'my_dense_vector');\n          return sigmoid(1, Math.E, -value); \n        ",
        params: {
          query_vector: [4, 3.4, -0.2],
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="fce7a35a737fc9e54ac1225e310dd561"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET my-index-000001/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published"
            }
          }
        }
      },
      "script": {
        "source": """
          double value = dotProduct(params.query_vector, 'my_dense_vector');
          return sigmoid(1, Math.E, -value); <a id="CO355-1"></a><i class="conum" data-value="1"></i>
        """,
        "params": {
          "query_vector": [4, 3.4, -0.2]
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/1381.console"></div>
<div class="calloutlist default has-python has-ruby has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO355-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Using the standard sigmoid function prevents scores from being negative.</p>
</td>
</tr>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="vector-functions-l1"></a>L<sup>1</sup> distance (Manhattan distance)</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/vectors/vector-functions.asciidoc">edit</a></div>
</div></div></div>
<p>The <code class="literal">l1norm</code> function calculates L<sup>1</sup> distance
(Manhattan distance) between a given query vector and
document vectors.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.search(
    index="my-index-000001",
    query={
        "script_score": {
            "query": {
                "bool": {
                    "filter": {
                        "term": {
                            "status": "published"
                        }
                    }
                }
            },
            "script": {
                "source": "1 / (1 + l1norm(params.queryVector, 'my_dense_vector'))",
                "params": {
                    "queryVector": [
                        4,
                        3.4,
                        -0.2
                    ]
                }
            }
        }
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'my-index-000001',
  body: {
    query: {
      script_score: {
        query: {
          bool: {
            filter: {
              term: {
                status: 'published'
              }
            }
          }
        },
        script: {
          source: "1 / (1 + l1norm(params.queryVector, 'my_dense_vector'))",
          params: {
            "queryVector": [
              4,
              3.4,
              -0.2
            ]
          }
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index-000001",
  query: {
    script_score: {
      query: {
        bool: {
          filter: {
            term: {
              status: "published",
            },
          },
        },
      },
      script: {
        source: "1 / (1 + l1norm(params.queryVector, 'my_dense_vector'))",
        params: {
          queryVector: [4, 3.4, -0.2],
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="2ac7efe3919ee0c7971f5d502f482662"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET my-index-000001/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published"
            }
          }
        }
      },
      "script": {
        "source": "1 / (1 + l1norm(params.queryVector, 'my_dense_vector'))", <a id="CO356-1"></a><i class="conum" data-value="1"></i>
        "params": {
          "queryVector": [4, 3.4, -0.2]
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/1382.console"></div>
<div class="calloutlist default has-python has-ruby has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO356-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Unlike <code class="literal">cosineSimilarity</code> that represent similarity, <code class="literal">l1norm</code> and
<code class="literal">l2norm</code> shown below represent distances or differences. This means, that
the more similar the vectors are, the lower the scores will be that are
produced by the <code class="literal">l1norm</code> and <code class="literal">l2norm</code> functions.
Thus, as we need more similar vectors to score higher,
we reversed the output from <code class="literal">l1norm</code> and <code class="literal">l2norm</code>. Also, to avoid
division by 0 when a document vector matches the query exactly,
we added <code class="literal">1</code> in the denominator.</p>
</td>
</tr>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="vector-functions-hamming"></a>Hamming distance</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/vectors/vector-functions.asciidoc">edit</a></div>
</div></div></div>
<p>The <code class="literal">hamming</code> function calculates <a href="https://en.wikipedia.org/wiki/Hamming_distance" class="ulink" target="_top">Hamming distance</a> between a given query vector and
document vectors. It is only available for byte and bit vectors.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.search(
    index="my-index-000001",
    query={
        "script_score": {
            "query": {
                "bool": {
                    "filter": {
                        "term": {
                            "status": "published"
                        }
                    }
                }
            },
            "script": {
                "source": "(24 - hamming(params.queryVector, 'my_byte_dense_vector')) / 24",
                "params": {
                    "queryVector": [
                        4,
                        3,
                        0
                    ]
                }
            }
        }
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index-000001",
  query: {
    script_score: {
      query: {
        bool: {
          filter: {
            term: {
              status: "published",
            },
          },
        },
      },
      script: {
        source:
          "(24 - hamming(params.queryVector, 'my_byte_dense_vector')) / 24",
        params: {
          queryVector: [4, 3, 0],
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="c1a39c2628ada04c3ddd61a303b65d44"></a>
<div class="pre_wrapper lang-console default has-python has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-js">GET my-index-000001/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published"
            }
          }
        }
      },
      "script": {
        "source": "(24 - hamming(params.queryVector, 'my_byte_dense_vector')) / 24", <a id="CO357-1"></a><i class="conum" data-value="1"></i>
        "params": {
          "queryVector": [4, 3, 0]
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-js" data-snippet="snippets/1383.console"></div>
<div class="calloutlist default has-python has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO357-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Calculate the Hamming distance and normalize it by the bits to get a score between 0 and 1.</p>
</td>
</tr>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="vector-functions-l2"></a>L<sup>2</sup> distance (Euclidean distance)</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/vectors/vector-functions.asciidoc">edit</a></div>
</div></div></div>
<p>The <code class="literal">l2norm</code> function calculates L<sup>2</sup> distance
(Euclidean distance) between a given query vector and
document vectors.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.search(
    index="my-index-000001",
    query={
        "script_score": {
            "query": {
                "bool": {
                    "filter": {
                        "term": {
                            "status": "published"
                        }
                    }
                }
            },
            "script": {
                "source": "1 / (1 + l2norm(params.queryVector, 'my_dense_vector'))",
                "params": {
                    "queryVector": [
                        4,
                        3.4,
                        -0.2
                    ]
                }
            }
        }
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'my-index-000001',
  body: {
    query: {
      script_score: {
        query: {
          bool: {
            filter: {
              term: {
                status: 'published'
              }
            }
          }
        },
        script: {
          source: "1 / (1 + l2norm(params.queryVector, 'my_dense_vector'))",
          params: {
            "queryVector": [
              4,
              3.4,
              -0.2
            ]
          }
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index-000001",
  query: {
    script_score: {
      query: {
        bool: {
          filter: {
            term: {
              status: "published",
            },
          },
        },
      },
      script: {
        source: "1 / (1 + l2norm(params.queryVector, 'my_dense_vector'))",
        params: {
          queryVector: [4, 3.4, -0.2],
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="f3e1dfe1c440e3590be26f265e19425d"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET my-index-000001/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published"
            }
          }
        }
      },
      "script": {
        "source": "1 / (1 + l2norm(params.queryVector, 'my_dense_vector'))",
        "params": {
          "queryVector": [4, 3.4, -0.2]
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/1384.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="vector-functions-missing-values"></a>Checking for missing values</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/vectors/vector-functions.asciidoc">edit</a></div>
</div></div></div>
<p>If a document doesn&#8217;t have a value for a vector field on which a vector function
is executed, an error will be thrown.</p>
<p>You can check if a document has a value for the field <code class="literal">my_vector</code> with
<code class="literal">doc['my_vector'].size() == 0</code>. Your overall script can look like this:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">"source": "doc['my_vector'].size() == 0 ? 0 : cosineSimilarity(params.queryVector, 'my_vector')"</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="vector-functions-accessing-vectors"></a>Accessing vectors directly</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/vectors/vector-functions.asciidoc">edit</a></div>
</div></div></div>
<p>You can access vector values directly through the following functions:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">doc[&lt;field&gt;].vectorValue</code> – returns a vector&#8217;s value as an array of floats
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For <code class="literal">bit</code> vectors, it does return a <code class="literal">float[]</code>, where each element represents 8 bits.</p>
</div>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">doc[&lt;field&gt;].magnitude</code> – returns a vector&#8217;s magnitude as a float
(for vectors created prior to version 7.5 the magnitude is not stored.
So this function calculates it anew every time it is called).
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For <code class="literal">bit</code> vectors, this is just the square root of the sum of <code class="literal">1</code> bits.</p>
</div>
</div>
<p>For example, the script below implements a cosine similarity using these
two functions:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.search(
    index="my-index-000001",
    query={
        "script_score": {
            "query": {
                "bool": {
                    "filter": {
                        "term": {
                            "status": "published"
                        }
                    }
                }
            },
            "script": {
                "source": "\n          float[] v = doc['my_dense_vector'].vectorValue;\n          float vm = doc['my_dense_vector'].magnitude;\n          float dotProduct = 0;\n          for (int i = 0; i &lt; v.length; i++) {\n            dotProduct += v[i] * params.queryVector[i];\n          }\n          return dotProduct / (vm * (float) params.queryVectorMag);\n        ",
                "params": {
                    "queryVector": [
                        4,
                        3.4,
                        -0.2
                    ],
                    "queryVectorMag": 5.25357
                }
            }
        }
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'my-index-000001',
  body: {
    query: {
      script_score: {
        query: {
          bool: {
            filter: {
              term: {
                status: 'published'
              }
            }
          }
        },
        script: {
          source: "\n          float[] v = doc['my_dense_vector'].vectorValue;\n          float vm = doc['my_dense_vector'].magnitude;\n          float dotProduct = 0;\n          for (int i = 0; i &lt; v.length; i++) {\n            dotProduct += v[i] * params.queryVector[i];\n          }\n          return dotProduct / (vm * (float) params.queryVectorMag);\n        ",
          params: {
            "queryVector": [
              4,
              3.4,
              -0.2
            ],
            "queryVectorMag": 5.25357
          }
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index-000001",
  query: {
    script_score: {
      query: {
        bool: {
          filter: {
            term: {
              status: "published",
            },
          },
        },
      },
      script: {
        source:
          "\n          float[] v = doc['my_dense_vector'].vectorValue;\n          float vm = doc['my_dense_vector'].magnitude;\n          float dotProduct = 0;\n          for (int i = 0; i &lt; v.length; i++) {\n            dotProduct += v[i] * params.queryVector[i];\n          }\n          return dotProduct / (vm * (float) params.queryVectorMag);\n        ",
        params: {
          queryVector: [4, 3.4, -0.2],
          queryVectorMag: 5.25357,
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="ffe45a7c70071730c2078cabb8cbdf95"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET my-index-000001/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published"
            }
          }
        }
      },
      "script": {
        "source": """
          float[] v = doc['my_dense_vector'].vectorValue;
          float vm = doc['my_dense_vector'].magnitude;
          float dotProduct = 0;
          for (int i = 0; i &lt; v.length; i++) {
            dotProduct += v[i] * params.queryVector[i];
          }
          return dotProduct / (vm * (float) params.queryVectorMag);
        """,
        "params": {
          "queryVector": [4, 3.4, -0.2],
          "queryVectorMag": 5.25357
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/1385.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="vector-functions-bit-vectors"></a>Bit vectors and vector functions</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/vectors/vector-functions.asciidoc">edit</a></div>
</div></div></div>
<p>When using <code class="literal">bit</code> vectors, not all the vector functions are available. The supported functions are:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#vector-functions-hamming" title="Hamming distance"><code class="literal">hamming</code></a> – calculates Hamming distance, the sum of the bitwise XOR of the two vectors
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#vector-functions-l1" title="L1 distance (Manhattan distance)"><code class="literal">l1norm</code></a> – calculates L<sup>1</sup> distance, this is simply the <code class="literal">hamming</code> distance
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#vector-functions-l2" title="L2 distance (Euclidean distance)"><code class="literal">l2norm</code></a> - calculates L<sup>2</sup> distance, this is the square root of the <code class="literal">hamming</code> distance
</li>
<li class="listitem">
<a class="xref" href="query-dsl-script-score-query.html#vector-functions-dot-product" title="Dot product"><code class="literal">dotProduct</code></a> – calculates dot product. When comparing two <code class="literal">bit</code> vectors,
this is the sum of the bitwise AND of the two vectors. If providing <code class="literal">float[]</code> or <code class="literal">byte[]</code>, who has <code class="literal">dims</code> number of elements, as a query vector, the <code class="literal">dotProduct</code> is
the sum of the floating point values using the stored <code class="literal">bit</code> vector as a mask.
</li>
</ul>
</div>
<p>Here is an example of using dot-product with bit vectors.</p>
<a id="339c4e5af9f9069ad9912aa574488b59"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">PUT my-index-bit-vectors
{
  "mappings": {
    "properties": {
      "my_dense_vector": {
        "type": "dense_vector",
        "index": false,
        "element_type": "bit",
        "dims": 40 <a id="CO358-1"></a><i class="conum" data-value="1"></i>
      }
    }
  }
}

PUT my-index-bit-vectors/_doc/1
{
  "my_dense_vector": [8, 5, -15, 1, -7] <a id="CO358-2"></a><i class="conum" data-value="2"></i>
}

PUT my-index-bit-vectors/_doc/2
{
  "my_dense_vector": [-1, 115, -3, 4, -128]
}

PUT my-index-bit-vectors/_doc/3
{
  "my_dense_vector": [2, 18, -5, 0, -124]
}

POST my-index-bit-vectors/_refresh</pre>
</div>
<div class="console_widget" data-snippet="snippets/1386.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO358-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The number of dimensions or bits for the <code class="literal">bit</code> vector.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO358-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>This vector represents 5 bytes, or <code class="literal">5 * 8 = 40</code> bits, which equals the configured dimensions</p>
</td>
</tr>
</table>
</div>
<a id="44198781d164a15be633d4469485a544"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET my-index-bit-vectors/_search
{
  "query": {
    "script_score": {
      "query" : {
        "match_all": {}
      },
      "script": {
        "source": "dotProduct(params.query_vector, 'my_dense_vector')",
        "params": {
          "query_vector": [8, 5, -15, 1, -7] <a id="CO359-1"></a><i class="conum" data-value="1"></i>
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1387.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO359-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This vector is 40 bits, and thus will compute a bitwise <code class="literal">&amp;</code> operation with the stored vectors.</p>
</td>
</tr>
</table>
</div>
<a id="15f769bbd7b5fddeb3353ae726b71b14"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET my-index-bit-vectors/_search
{
  "query": {
    "script_score": {
      "query" : {
        "match_all": {}
      },
      "script": {
        "source": "dotProduct(params.query_vector, 'my_dense_vector')",
        "params": {
          "query_vector": [0.23, 1.45, 3.67, 4.89, -0.56, 2.34, 3.21, 1.78, -2.45, 0.98, -0.12, 3.45, 4.56, 2.78, 1.23, 0.67, 3.89, 4.12, -2.34, 1.56, 0.78, 3.21, 4.12, 2.45, -1.67, 0.34, -3.45, 4.56, -2.78, 1.23, -0.67, 3.89, -4.34, 2.12, -1.56, 0.78, -3.21, 4.45, 2.12, 1.67] <a id="CO360-1"></a><i class="conum" data-value="1"></i>
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1388.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO360-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This vector is 40 individual dimensions, and thus will sum the floating point values using the stored <code class="literal">bit</code> vector as a mask.</p>
</td>
</tr>
</table>
</div>
<p>Currently, the <code class="literal">cosineSimilarity</code> function is not supported for <code class="literal">bit</code> vectors.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="score-explanation"></a>Explain request</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></div>
</div></div></div>
<p>Using an <a class="xref" href="search-explain.html" title="Explain API">explain request</a> provides an explanation of how the parts of a score were computed. The <code class="literal">script_score</code> query can add its own explanation by setting the <code class="literal">explanation</code> parameter:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.explain(
    index="my-index-000001",
    id="0",
    query={
        "script_score": {
            "query": {
                "match": {
                    "message": "elasticsearch"
                }
            },
            "script": {
                "source": "\n          long count = doc['count'].value;\n          double normalizedCount = count / 10;\n          if (explanation != null) {\n            explanation.set('normalized count = count / 10 = ' + count + ' / 10 = ' + normalizedCount);\n          }\n          return normalizedCount;\n        "
            }
        }
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.explain(
  index: 'my-index-000001',
  id: 0,
  body: {
    query: {
      script_score: {
        query: {
          match: {
            message: 'elasticsearch'
          }
        },
        script: {
          source: "\n          long count = doc['count'].value;\n          double normalizedCount = count / 10;\n          if (explanation != nil) {\n            explanation.set('normalized count = count / 10 = ' + count + ' / 10 = ' + normalizedCount);\n          }\n          return normalizedCount;\n        "
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.explain({
  index: "my-index-000001",
  id: 0,
  query: {
    script_score: {
      query: {
        match: {
          message: "elasticsearch",
        },
      },
      script: {
        source:
          "\n          long count = doc['count'].value;\n          double normalizedCount = count / 10;\n          if (explanation != null) {\n            explanation.set('normalized count = count / 10 = ' + count + ' / 10 = ' + normalizedCount);\n          }\n          return normalizedCount;\n        ",
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="44bca3f17d403517af3616754dc795bb"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET /my-index-000001/_explain/0
{
  "query": {
    "script_score": {
      "query": {
        "match": { "message": "elasticsearch" }
      },
      "script": {
        "source": """
          long count = doc['count'].value;
          double normalizedCount = count / 10;
          if (explanation != null) {
            explanation.set('normalized count = count / 10 = ' + count + ' / 10 = ' + normalizedCount);
          }
          return normalizedCount;
        """
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/1389.console"></div>
<p>Note that the <code class="literal">explanation</code> will be null when using in a normal <code class="literal">_search</code> request, so having a conditional guard is best practice.</p>
</div>

</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="query-dsl-script-query.html">« Script query</a>
</span>
<span class="next">
<a href="query-dsl-wrapper-query.html">Wrapper query »</a>
</span>
</div>
</body>
</html>
