<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Shard allocation awareness | Elasticsearch Guide [8.x] | Elastic</title>
<meta class="elastic" name="content" content="Shard allocation awareness | Elasticsearch Guide [8.x]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.x]"/>
<link rel="up" href="shard-allocation-relocation-recovery.html" title="Shard allocation, relocation, and recovery"/>
<link rel="prev" href="shard-allocation-relocation-recovery.html" title="Shard allocation, relocation, and recovery"/>
<link rel="next" href="shard-request-cache.html" title="The shard request cache"/>
<meta class="elastic" name="product_version" content="8.x"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.x"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.x"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="shard-allocation-relocation-recovery.html">« Shard allocation, relocation, and recovery</a>
</span>
<span class="next">
<a href="shard-request-cache.html">The shard request cache »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.x]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="_data_store_architecture.html">Data store architecture</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="shard-allocation-relocation-recovery.html">Shard allocation, relocation, and recovery</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Shard allocation awareness</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/modules/cluster/allocation_awareness.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="shard-allocation-awareness"></a>Shard allocation awareness</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/modules/cluster/allocation_awareness.asciidoc">edit</a></div>
</div></div></div>
<p>You can use custom node attributes as <em>awareness attributes</em> to enable Elasticsearch
to take your physical hardware configuration into account when allocating shards.
If Elasticsearch knows which nodes are on the same physical server, in the same rack, or
in the same zone, it can distribute the primary shard and its replica shards to
minimize the risk of losing all shard copies in the event of a failure.</p>
<p>When shard allocation awareness is enabled with the <code class="literal">cluster.routing.allocation.awareness.attributes</code> setting, shards are only allocated to nodes that have values set for the specified awareness attributes. If you use multiple awareness attributes, Elasticsearch considers each attribute separately when allocating shards.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The number of attribute values determines how many shard copies are
allocated in each location. If the number of nodes in each location is
unbalanced and there are a lot of replicas, replica shards might be left
unassigned.</p>
</div>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Learn more about <a class="xref" href="high-availability-cluster-design-large-clusters.html" title="Resilience in larger clusters">designing resilient clusters</a>.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="enabling-awareness"></a>Enabling shard allocation awareness</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/modules/cluster/allocation_awareness.asciidoc">edit</a></div>
</div></div></div>
<p>To enable shard allocation awareness:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Specify the location of each node with a <a class="xref" href="modules-node.html#custom-node-attributes" title="Custom node attributes">custom node attribute</a>. For example,
if you want Elasticsearch to distribute shards across different racks, you might
use an awareness attribute called <code class="literal">rack_id</code>.</p>
<p>You can set custom attributes in two ways:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>By editing the <code class="literal">elasticsearch.yml</code> config file:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">node.attr.rack_id: rack_one</pre>
</div>
</li>
<li class="listitem">
<p>Using the <code class="literal">-E</code> command line argument when you start a node:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">./bin/elasticsearch -Enode.attr.rack_id=rack_one</pre>
</div>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tell Elasticsearch to take one or more awareness attributes into account when
allocating shards by setting
<code class="literal">cluster.routing.allocation.awareness.attributes</code> in <span class="strong strong"><strong>every</strong></span> master-eligible
node&#8217;s <code class="literal">elasticsearch.yml</code> config file.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">cluster.routing.allocation.awareness.attributes: rack_id <a id="CO768-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO768-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Specify multiple attributes as a comma-separated list.</p>
</td>
</tr>
</table>
</div>
<p>You can also use the
<a class="xref" href="cluster-update-settings.html" title="Cluster update settings API">cluster-update-settings</a> API to set or update
a cluster&#8217;s awareness attributes:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.cluster.put_settings(
    persistent={
        "cluster.routing.allocation.awareness.attributes": "rack_id"
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cluster.put_settings(
  body: {
    persistent: {
      'cluster.routing.allocation.awareness.attributes' =&gt; 'rack_id'
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cluster.putSettings({
  persistent: {
    "cluster.routing.allocation.awareness.attributes": "rack_id",
  },
});
console.log(response);</pre>
</div>
<a id="4479e8c63a04fa22207a6a8803eadcad"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">PUT /_cluster/settings
{
  "persistent" : {
    "cluster.routing.allocation.awareness.attributes" : "rack_id"
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/2363.console"></div>
</li>
</ol>
</div>
<p>With this example configuration, if you start two nodes with
<code class="literal">node.attr.rack_id</code> set to <code class="literal">rack_one</code> and create an index with 5 primary
shards and 1 replica of each primary, all primaries and replicas are
allocated across the two node.</p>
<div class="imageblock">
<div class="content">
<img src="images/shard-allocation/shard-allocation-awareness-one-rack.png" alt="All primaries and replicas are allocated across two nodes in the same rack">
</div>
<div class="title">Figure 14. All primaries and replicas allocated across two nodes in the same rack</div>
</div>
<p>If you add two nodes with <code class="literal">node.attr.rack_id</code> set to <code class="literal">rack_two</code>,
Elasticsearch moves shards to the new nodes, ensuring (if possible)
that no two copies of the same shard are in the same rack.</p>
<div class="imageblock">
<div class="content">
<img src="images/shard-allocation/shard-allocation-awareness-two-racks.png" alt="Primaries and replicas are allocated across four nodes in two racks with no two copies of the same shard in the same rack">
</div>
<div class="title">Figure 15. Primaries and replicas allocated across four nodes in two racks, with no two copies of the same shard in the same rack</div>
</div>
<p>If <code class="literal">rack_two</code> fails and takes down both its nodes, by default Elasticsearch
allocates the lost shard copies to nodes in <code class="literal">rack_one</code>. To prevent multiple
copies of a particular shard from being allocated in the same location, you can
enable forced awareness.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="forced-awareness"></a>Forced awareness</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/modules/cluster/allocation_awareness.asciidoc">edit</a></div>
</div></div></div>
<p>By default, if one location fails, Elasticsearch spreads its shards across the remaining
locations. This might be undesirable if the cluster does not have sufficient
resources to host all its shards when one location is missing.</p>
<p>To prevent the remaining locations from being overloaded in the event of a
whole-location failure, specify the attribute values that should exist with the
<code class="literal">cluster.routing.allocation.awareness.force.*</code> settings. This will mean that
Elasticsearch will prefer to leave some replicas unassigned in the event of a
whole-location failure instead of overloading the nodes in the remaining
locations.</p>
<p>For example, if you have an awareness attribute called <code class="literal">zone</code> and configure
nodes in <code class="literal">zone1</code> and <code class="literal">zone2</code>, you can use forced awareness to make Elasticsearch leave
half of your shard copies unassigned if only one zone is available:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">cluster.routing.allocation.awareness.attributes: zone
cluster.routing.allocation.awareness.force.zone.values: zone1,zone2 <a id="CO769-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO769-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Specify all possible <code class="literal">zone</code> attribute values.</p>
</td>
</tr>
</table>
</div>
<p>With this example configuration, if you have two nodes with <code class="literal">node.attr.zone</code>
set to <code class="literal">zone1</code> and an index with <code class="literal">number_of_replicas</code> set to <code class="literal">1</code>, Elasticsearch
allocates all the primary shards but none of the replicas. It will assign the
replica shards once nodes with a different value for <code class="literal">node.attr.zone</code> join the
cluster. In contrast, if you do not configure forced awareness, Elasticsearch will
allocate all primaries and replicas to the two nodes even though they are in
the same zone.</p>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="shard-allocation-relocation-recovery.html">« Shard allocation, relocation, and recovery</a>
</span>
<span class="next">
<a href="shard-request-cache.html">The shard request cache »</a>
</span>
</div>
</body>
</html>
