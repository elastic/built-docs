<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tutorial: Migrate ILM managed data stream to data stream lifecycle | Elasticsearch Guide [8.x] | Elastic</title>
<meta class="elastic" name="content" content="Tutorial: Migrate ILM managed data stream to data stream lifecycle | Elasticsearch Guide [8.x]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.x]"/>
<link rel="up" href="data-stream-lifecycle.html" title="Data stream lifecycle"/>
<link rel="prev" href="tutorial-manage-data-stream-retention.html" title="Tutorial: Data stream retention"/>
<link rel="next" href="ingest.html" title="Ingest pipelines"/>
<meta class="elastic" name="product_version" content="8.x"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.x"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.x"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="tutorial-manage-data-stream-retention.html">« Tutorial: Data stream retention</a>
</span>
<span class="next">
<a href="ingest.html">Ingest pipelines »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.x]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="data-streams.html">Data streams</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="data-stream-lifecycle.html">Data stream lifecycle</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Tutorial: Migrate ILM managed data stream to data stream lifecycle</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/data-streams/lifecycle/tutorial-migrate-data-stream-from-ilm-to-dsl.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section xpack">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="tutorial-migrate-data-stream-from-ilm-to-dsl"></a>Tutorial: Migrate ILM managed data stream to data stream lifecycle</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/data-streams/lifecycle/tutorial-migrate-data-stream-from-ilm-to-dsl.asciidoc">edit</a></div>
</div></div></div>
<p>In this tutorial we&#8217;ll look at migrating an existing data stream from <a class="xref" href="index-lifecycle-management.html" title="ILM: Manage the index lifecycle">Index Lifecycle Management (ILM)</a> to
<a class="xref" href="data-stream-lifecycle.html" title="Data stream lifecycle">data stream lifecycle</a>. The existing ILM managed backing indices will continue
to be managed by ILM until they age out and get deleted by ILM; however,
the new backing indices will be managed by data stream lifecycle.
This way, a data stream is gradually migrated away from being managed by ILM to
being managed by data stream lifecycle. As we&#8217;ll see, ILM and data stream lifecycle
can co-manage a data stream; however, an index can only be managed by one system at
a time.</p>
<div class="position-relative"><h4><a id="migrate-dsl-ilm-tldr"></a>TL;DR</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/data-streams/lifecycle/tutorial-migrate-data-stream-from-ilm-to-dsl.asciidoc">edit</a></div>
<p>To migrate a data stream from ILM to data stream lifecycle we&#8217;ll have to execute
two steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Update the index template that&#8217;s backing the data stream to set <a class="xref" href="data-stream-lifecycle-settings.html#index-lifecycle-prefer-ilm">prefer_ilm</a>
to <code class="literal">false</code>, and to configure data stream lifecycle.
</li>
<li class="listitem">
Configure the data stream lifecycle for the <em>existing</em> data stream using
the <a class="xref" href="data-streams-put-lifecycle.html" title="Set the lifecycle of a data stream">lifecycle API</a>.
</li>
</ol>
</div>
<p>For more details see the <a class="xref" href="tutorial-migrate-data-stream-from-ilm-to-dsl.html#migrate-from-ilm-to-dsl" title="Migrate data stream to data stream lifecycle">migrate to data stream lifecycle</a> section.</p>
<div class="position-relative"><h4><a id="setup-test-data"></a>Setup ILM managed data stream</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/data-streams/lifecycle/tutorial-migrate-data-stream-from-ilm-to-dsl.asciidoc">edit</a></div>
<p>Let&#8217;s first create a data stream with two backing indices managed by ILM.
We first create an ILM policy:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.ilm.put_lifecycle(
    name="pre-dsl-ilm-policy",
    policy={
        "phases": {
            "hot": {
                "actions": {
                    "rollover": {
                        "max_primary_shard_size": "50gb"
                    }
                }
            },
            "delete": {
                "min_age": "7d",
                "actions": {
                    "delete": {}
                }
            }
        }
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.ilm.put_lifecycle(
  policy: 'pre-dsl-ilm-policy',
  body: {
    policy: {
      phases: {
        hot: {
          actions: {
            rollover: {
              max_primary_shard_size: '50gb'
            }
          }
        },
        delete: {
          min_age: '7d',
          actions: {
            delete: {}
          }
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.ilm.putLifecycle({
  name: "pre-dsl-ilm-policy",
  policy: {
    phases: {
      hot: {
        actions: {
          rollover: {
            max_primary_shard_size: "50gb",
          },
        },
      },
      delete: {
        min_age: "7d",
        actions: {
          delete: {},
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="1d9b695a17cffd910c496c9b03c75d6f"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">PUT _ilm/policy/pre-dsl-ilm-policy
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_primary_shard_size": "50gb"
          }
        }
      },
      "delete": {
        "min_age": "7d",
        "actions": {
          "delete": {}
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/781.console"></div>
<p>And let&#8217;s create an index template that&#8217;ll back the data stream and configures ILM:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.put_index_template(
    name="dsl-data-stream-template",
    index_patterns=[
        "dsl-data-stream*"
    ],
    data_stream={},
    priority=500,
    template={
        "settings": {
            "index.lifecycle.name": "pre-dsl-ilm-policy"
        }
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.put_index_template(
  name: 'dsl-data-stream-template',
  body: {
    index_patterns: [
      'dsl-data-stream*'
    ],
    data_stream: {},
    priority: 500,
    template: {
      settings: {
        'index.lifecycle.name' =&gt; 'pre-dsl-ilm-policy'
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.putIndexTemplate({
  name: "dsl-data-stream-template",
  index_patterns: ["dsl-data-stream*"],
  data_stream: {},
  priority: 500,
  template: {
    settings: {
      "index.lifecycle.name": "pre-dsl-ilm-policy",
    },
  },
});
console.log(response);</pre>
</div>
<a id="d7a55a7c491e97079e429483085f1d58"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">PUT _index_template/dsl-data-stream-template
{
  "index_patterns": ["dsl-data-stream*"],
  "data_stream": { },
  "priority": 500,
  "template": {
    "settings": {
      "index.lifecycle.name": "pre-dsl-ilm-policy"
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/782.console"></div>
<p>We&#8217;ll now index a document targetting <code class="literal">dsl-data-stream</code> to create the data stream
and we&#8217;ll also manually rollover the data stream to have another generation index created:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.index(
    index="dsl-data-stream",
    document={
        "@timestamp": "2023-10-18T16:21:15.000Z",
        "message": "192.0.2.42 - - [06/May/2099:16:21:15 +0000] \"GET /images/bg.jpg HTTP/1.0\" 200 24736"
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.index(
  index: 'dsl-data-stream',
  body: {
    "@timestamp": '2023-10-18T16:21:15.000Z',
    message: '192.0.2.42 - - [06/May/2099:16:21:15 +0000] "GET /images/bg.jpg HTTP/1.0" 200 24736'
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.index({
  index: "dsl-data-stream",
  document: {
    "@timestamp": "2023-10-18T16:21:15.000Z",
    message:
      '192.0.2.42 - - [06/May/2099:16:21:15 +0000] "GET /images/bg.jpg HTTP/1.0" 200 24736',
  },
});
console.log(response);</pre>
</div>
<a id="8fec06a98d0151c1d717a01491d0b8f0"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">POST dsl-data-stream/_doc?
{
  "@timestamp": "2023-10-18T16:21:15.000Z",
  "message": "192.0.2.42 - - [06/May/2099:16:21:15 +0000] \"GET /images/bg.jpg HTTP/1.0\" 200 24736"
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/783.console"></div>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.rollover(
    alias="dsl-data-stream",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.rollover(
  alias: 'dsl-data-stream'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.rollover({
  alias: "dsl-data-stream",
});
console.log(response);</pre>
</div>
<a id="10f0c8fed98455c460c374b50ffbb204"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">POST dsl-data-stream/_rollover</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/784.console"></div>
<p>We&#8217;ll use the <a class="xref" href="indices-get-data-stream.html" title="Get data stream API">GET _data_stream</a> API to inspect the state of
the data stream:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.get_data_stream(
    name="dsl-data-stream",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.get_data_stream(
  name: 'dsl-data-stream'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.getDataStream({
  name: "dsl-data-stream",
});
console.log(response);</pre>
</div>
<a id="a6ccac9f80c5e5efdaab992f3a32d919"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET _data_stream/dsl-data-stream</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/785.console"></div>
<p>Inspecting the response we&#8217;ll see that both backing indices are managed by ILM
and that the next generation index will also be managed by ILM:</p>
<a id="e14c92349f033a6a34f0b967e9d27dad"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "data_streams": [
    {
      "name": "dsl-data-stream",
      "timestamp_field": {
        "name": "@timestamp"
      },
      "indices": [
        {
          "index_name": ".ds-dsl-data-stream-2023.10.19-000001",    <a id="CO238-1"></a><i class="conum" data-value="1"></i>
          "index_uuid": "xCEhwsp8Tey0-FLNFYVwSg",
          "prefer_ilm": true,                                       <a id="CO238-2"></a><i class="conum" data-value="2"></i>
          "ilm_policy": "pre-dsl-ilm-policy",                       <a id="CO238-3"></a><i class="conum" data-value="3"></i>
          "managed_by": "Index Lifecycle Management"                <a id="CO238-4"></a><i class="conum" data-value="4"></i>
        },
        {
          "index_name": ".ds-dsl-data-stream-2023.10.19-000002",
          "index_uuid": "PA_JquKGSiKcAKBA8DJ5gw",
          "prefer_ilm": true,
          "ilm_policy": "pre-dsl-ilm-policy",
          "managed_by": "Index Lifecycle Management"
        }
      ],
      "generation": 2,
      "status": "GREEN",
      "template": "dsl-data-stream-template",
      "next_generation_managed_by": "Index Lifecycle Management",   <a id="CO238-5"></a><i class="conum" data-value="5"></i>
      "prefer_ilm": true,                                           <a id="CO238-6"></a><i class="conum" data-value="6"></i>
      "ilm_policy": "pre-dsl-ilm-policy",                           <a id="CO238-7"></a><i class="conum" data-value="7"></i>
      "hidden": false,
      "system": false,
      "allow_custom_routing": false,
      "replicated": false,
      "rollover_on_write": false
    }
  ]
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO238-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the backing index.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO238-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>For each backing index we display the value of the <a class="xref" href="data-stream-lifecycle-settings.html#index-lifecycle-prefer-ilm">prefer_ilm</a>
configuration which will indicate if ILM takes precedence over data stream lifecycle in case
both systems are configured for an index.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO238-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The ILM policy configured for this index.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO238-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The system that manages this index (possible values are "Index Lifecycle Management",
"Data stream lifecycle", or "Unmanaged")</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO238-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>The system that will manage the next generation index (the new write index of this
data stream, once the data stream is rolled over). The possible values are
"Index Lifecycle Management", "Data stream lifecycle", or "Unmanaged".</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO238-6"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <a class="xref" href="data-stream-lifecycle-settings.html#index-lifecycle-prefer-ilm">prefer_ilm</a> value configured in the index template
that&#8217;s backing the data stream. This value will be configured for all the new backing indices.
If it&#8217;s not configured in the index template the backing indices will receive the <code class="literal">true</code>
default value (ILM takes precedence over data stream lifecycle by default as it&#8217;s
currently richer in features).</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO238-7"><i class="conum" data-value="7"></i></a></p>
</td>
<td align="left" valign="top">
<p>The ILM policy configured in the index template that&#8217;s backing this data
stream (which will be configured on all the new backing indices, as long as it exists
in the index template).</p>
</td>
</tr>
</table>
</div>
<div class="position-relative"><h4><a id="migrate-from-ilm-to-dsl"></a>Migrate data stream to data stream lifecycle</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/data-streams/lifecycle/tutorial-migrate-data-stream-from-ilm-to-dsl.asciidoc">edit</a></div>
<p>To migrate the <code class="literal">dsl-data-stream</code> to data stream lifecycle we&#8217;ll have to execute
two steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Update the index template that&#8217;s backing the data stream to set <a class="xref" href="data-stream-lifecycle-settings.html#index-lifecycle-prefer-ilm">prefer_ilm</a>
to <code class="literal">false</code>, and to configure data stream lifecycle.
</li>
<li class="listitem">
Configure the data stream lifecycle for the <em>existing</em> <code class="literal">dsl-data-stream</code> using
the <a class="xref" href="data-streams-put-lifecycle.html" title="Set the lifecycle of a data stream">lifecycle API</a>.
</li>
</ol>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>The data stream lifecycle configuration that&#8217;s added to the index template,
being a data stream configuration, will only apply to <span class="strong strong"><strong>new</strong></span> data streams.
Our data stream exists already, so even though we added a data stream lifecycle
configuration in the index template it will not be applied to <code class="literal">dsl-data-stream</code>.</p>
</div>
</div>
<p><a id="update-index-template-for-dsl"></a>Let&#8217;s update the index template:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.put_index_template(
    name="dsl-data-stream-template",
    index_patterns=[
        "dsl-data-stream*"
    ],
    data_stream={},
    priority=500,
    template={
        "settings": {
            "index.lifecycle.name": "pre-dsl-ilm-policy",
            "index.lifecycle.prefer_ilm": False
        },
        "lifecycle": {
            "data_retention": "7d"
        }
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.put_index_template(
  name: 'dsl-data-stream-template',
  body: {
    index_patterns: [
      'dsl-data-stream*'
    ],
    data_stream: {},
    priority: 500,
    template: {
      settings: {
        'index.lifecycle.name' =&gt; 'pre-dsl-ilm-policy',
        'index.lifecycle.prefer_ilm' =&gt; false
      },
      lifecycle: {
        data_retention: '7d'
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.putIndexTemplate({
  name: "dsl-data-stream-template",
  index_patterns: ["dsl-data-stream*"],
  data_stream: {},
  priority: 500,
  template: {
    settings: {
      "index.lifecycle.name": "pre-dsl-ilm-policy",
      "index.lifecycle.prefer_ilm": false,
    },
    lifecycle: {
      data_retention: "7d",
    },
  },
});
console.log(response);</pre>
</div>
<a id="e95e61988dc3073a007f7b7445dd233b"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">PUT _index_template/dsl-data-stream-template
{
  "index_patterns": ["dsl-data-stream*"],
  "data_stream": { },
  "priority": 500,
  "template": {
    "settings": {
      "index.lifecycle.name": "pre-dsl-ilm-policy",
      "index.lifecycle.prefer_ilm": false             <a id="CO239-1"></a><i class="conum" data-value="1"></i>
    },
    "lifecycle": {
      "data_retention": "7d"                          <a id="CO239-2"></a><i class="conum" data-value="2"></i>
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/786.console"></div>
<div class="calloutlist default has-python has-ruby has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO239-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">prefer_ilm</code> setting will now be configured on the <span class="strong strong"><strong>new</strong></span> backing indices
(created by rolling over the data stream) such that ILM does <em>not</em> take
precedence over data stream lifecycle.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO239-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>We&#8217;re configuring the data stream lifecycle so <em>new</em> data streams will be
managed by data stream lifecycle.</p>
</td>
</tr>
</table>
</div>
<p>We&#8217;ve now made sure that new data streams will be managed by data stream lifecycle.</p>
<p>Let&#8217;s update our existing <code class="literal">dsl-data-stream</code> and configure data stream lifecycle:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.put_data_lifecycle(
    name="dsl-data-stream",
    data_retention="7d",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.put_data_lifecycle(
  name: 'dsl-data-stream',
  body: {
    data_retention: '7d'
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.putDataLifecycle({
  name: "dsl-data-stream",
  data_retention: "7d",
});
console.log(response);</pre>
</div>
<a id="2dad2b0c8ba503228f4b11cecca0b348"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">PUT _data_stream/dsl-data-stream/_lifecycle
{
    "data_retention": "7d"
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/787.console"></div>
<p>We can inspect the data stream to check that the next generation will indeed be
managed by data stream lifecycle:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.get_data_stream(
    name="dsl-data-stream",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.get_data_stream(
  name: 'dsl-data-stream'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.getDataStream({
  name: "dsl-data-stream",
});
console.log(response);</pre>
</div>
<a id="a6ccac9f80c5e5efdaab992f3a32d919"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET _data_stream/dsl-data-stream</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/788.console"></div>
<a id="2edcecaf1c56e5b4d7d28c3918de9f2d"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "data_streams": [
    {
      "name": "dsl-data-stream",
      "timestamp_field": {
        "name": "@timestamp"
      },
      "indices": [
        {
          "index_name": ".ds-dsl-data-stream-2023.10.19-000001",
          "index_uuid": "xCEhwsp8Tey0-FLNFYVwSg",
          "prefer_ilm": true,
          "ilm_policy": "pre-dsl-ilm-policy",
          "managed_by": "Index Lifecycle Management"                <a id="CO240-1"></a><i class="conum" data-value="1"></i>
        },
        {
          "index_name": ".ds-dsl-data-stream-2023.10.19-000002",
          "index_uuid": "PA_JquKGSiKcAKBA8DJ5gw",
          "prefer_ilm": true,
          "ilm_policy": "pre-dsl-ilm-policy",
          "managed_by": "Index Lifecycle Management"                <a id="CO240-2"></a><i class="conum" data-value="2"></i>
        }
      ],
      "generation": 2,
      "status": "GREEN",
      "template": "dsl-data-stream-template",
      "lifecycle": {
        "enabled": true,
        "data_retention": "7d",
        "effective_retention": "7d",
        "retention_determined_by": "data_stream_configuration"
      },
      "ilm_policy": "pre-dsl-ilm-policy",
      "next_generation_managed_by": "Data stream lifecycle",         <a id="CO240-3"></a><i class="conum" data-value="3"></i>
      "prefer_ilm": false,                                           <a id="CO240-4"></a><i class="conum" data-value="4"></i>
      "hidden": false,
      "system": false,
      "allow_custom_routing": false,
      "replicated": false,
      "rollover_on_write": false
    }
  ]
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO240-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The existing backing index will continue to be managed by ILM</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO240-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The existing backing index will continue to be managed by ILM</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO240-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The next generation index will be managed by Data stream lifecycle</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO240-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">prefer_ilm</code> setting value we configured in the index template is reflected
and will be configured accordingly for new backing indices.</p>
</td>
</tr>
</table>
</div>
<p>We&#8217;ll now rollover the data stream to see the new generation index being managed by
data stream lifecycle:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.rollover(
    alias="dsl-data-stream",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.rollover(
  alias: 'dsl-data-stream'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.rollover({
  alias: "dsl-data-stream",
});
console.log(response);</pre>
</div>
<a id="10f0c8fed98455c460c374b50ffbb204"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">POST dsl-data-stream/_rollover</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/789.console"></div>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.get_data_stream(
    name="dsl-data-stream",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.get_data_stream(
  name: 'dsl-data-stream'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.getDataStream({
  name: "dsl-data-stream",
});
console.log(response);</pre>
</div>
<a id="a6ccac9f80c5e5efdaab992f3a32d919"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET _data_stream/dsl-data-stream</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/790.console"></div>
<a id="e3e07b2dd632e301df6b9f4eded57fd9"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "data_streams": [
    {
      "name": "dsl-data-stream",
      "timestamp_field": {
        "name": "@timestamp"
      },
      "indices": [
        {
          "index_name": ".ds-dsl-data-stream-2023.10.19-000001",
          "index_uuid": "xCEhwsp8Tey0-FLNFYVwSg",
          "prefer_ilm": true,
          "ilm_policy": "pre-dsl-ilm-policy",
          "managed_by": "Index Lifecycle Management"                <a id="CO241-1"></a><i class="conum" data-value="1"></i>
        },
        {
          "index_name": ".ds-dsl-data-stream-2023.10.19-000002",
          "index_uuid": "PA_JquKGSiKcAKBA8DJ5gw",
          "prefer_ilm": true,
          "ilm_policy": "pre-dsl-ilm-policy",
          "managed_by": "Index Lifecycle Management"                <a id="CO241-2"></a><i class="conum" data-value="2"></i>
        },
        {
          "index_name": ".ds-dsl-data-stream-2023.10.19-000003",
          "index_uuid": "PA_JquKGSiKcAKBA8abcd1",
          "prefer_ilm": false,                                      <a id="CO241-3"></a><i class="conum" data-value="3"></i>
          "ilm_policy": "pre-dsl-ilm-policy",
          "managed_by": "Data stream lifecycle"                     <a id="CO241-4"></a><i class="conum" data-value="4"></i>
        }
      ],
      "generation": 3,
      "status": "GREEN",
      "template": "dsl-data-stream-template",
      "lifecycle": {
        "enabled": true,
        "data_retention": "7d",
        "effective_retention": "7d",
        "retention_determined_by": "data_stream_configuration"
      },
      "ilm_policy": "pre-dsl-ilm-policy",
      "next_generation_managed_by": "Data stream lifecycle",
      "prefer_ilm": false,
      "hidden": false,
      "system": false,
      "allow_custom_routing": false,
      "replicated": false,
      "rollover_on_write": false
    }
  ]
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO241-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The backing indices that existed before rollover will continue to be managed by ILM</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO241-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The backing indices that existed before rollover will continue to be managed by ILM</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO241-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The new write index received the <code class="literal">false</code> value for the <code class="literal">prefer_ilm</code> setting, as we configured
in the index template</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO241-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The new write index is managed by <code class="literal">Data stream lifecycle</code></p>
</td>
</tr>
</table>
</div>
<div class="position-relative"><h4><a id="migrate-from-dsl-to-ilm"></a>Migrate data stream back to ILM</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/elasticsearch/edit/8.x/docs/reference/data-streams/lifecycle/tutorial-migrate-data-stream-from-ilm-to-dsl.asciidoc">edit</a></div>
<p>We can easily change this data stream to be managed by ILM because we didn&#8217;t remove
the ILM policy when we <a class="xref" href="tutorial-migrate-data-stream-from-ilm-to-dsl.html#update-index-template-for-dsl">updated
the index template</a>.</p>
<p>We can achieve this in two ways:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="data-streams-delete-lifecycle.html" title="Delete the lifecycle of a data stream">Delete the lifecycle</a> from the data streams
</li>
<li class="listitem">
Disable data stream lifecycle by configuring the <code class="literal">enabled</code> flag to <code class="literal">false</code>.
</li>
</ol>
</div>
<p>Let&#8217;s implement option 2 and disable the data stream lifecycle:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.put_data_lifecycle(
    name="dsl-data-stream",
    data_retention="7d",
    enabled=False,
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.put_data_lifecycle(
  name: 'dsl-data-stream',
  body: {
    data_retention: '7d',
    enabled: false
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.putDataLifecycle({
  name: "dsl-data-stream",
  data_retention: "7d",
  enabled: false,
});
console.log(response);</pre>
</div>
<a id="96ea0e80323d6d2d99964625c004a44d"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">PUT _data_stream/dsl-data-stream/_lifecycle
{
    "data_retention": "7d",
    "enabled": false <a id="CO242-1"></a><i class="conum" data-value="1"></i>
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/791.console"></div>
<div class="calloutlist default has-python has-ruby has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO242-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">enabled</code> flag can be ommitted and defaults to <code class="literal">true</code> however, here we
explicitly configure it to <code class="literal">false</code>
Let&#8217;s check the state of the data stream:</p>
</td>
</tr>
</table>
</div>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.get_data_stream(
    name="dsl-data-stream",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.get_data_stream(
  name: 'dsl-data-stream'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.getDataStream({
  name: "dsl-data-stream",
});
console.log(response);</pre>
</div>
<a id="a6ccac9f80c5e5efdaab992f3a32d919"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET _data_stream/dsl-data-stream</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/792.console"></div>
<a id="2ae487e3f60fe80f65dd9daff02059ee"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "data_streams": [
    {
      "name": "dsl-data-stream",
      "timestamp_field": {
        "name": "@timestamp"
      },
      "indices": [
        {
          "index_name": ".ds-dsl-data-stream-2023.10.19-000001",
          "index_uuid": "xCEhwsp8Tey0-FLNFYVwSg",
          "prefer_ilm": true,
          "ilm_policy": "pre-dsl-ilm-policy",
          "managed_by": "Index Lifecycle Management"
        },
        {
          "index_name": ".ds-dsl-data-stream-2023.10.19-000002",
          "index_uuid": "PA_JquKGSiKcAKBA8DJ5gw",
          "prefer_ilm": true,
          "ilm_policy": "pre-dsl-ilm-policy",
          "managed_by": "Index Lifecycle Management"
        },
        {
          "index_name": ".ds-dsl-data-stream-2023.10.19-000003",
          "index_uuid": "PA_JquKGSiKcAKBA8abcd1",
          "prefer_ilm": false,
          "ilm_policy": "pre-dsl-ilm-policy",
          "managed_by": "Index Lifecycle Management"                <a id="CO243-1"></a><i class="conum" data-value="1"></i>
        }
      ],
      "generation": 3,
      "status": "GREEN",
      "template": "dsl-data-stream-template",
      "lifecycle": {
        "enabled": false,                                          <a id="CO243-2"></a><i class="conum" data-value="2"></i>
        "data_retention": "7d"
      },
      "ilm_policy": "pre-dsl-ilm-policy",
      "next_generation_managed_by": "Index Lifecycle Management",  <a id="CO243-3"></a><i class="conum" data-value="3"></i>
      "prefer_ilm": false,
      "hidden": false,
      "system": false,
      "allow_custom_routing": false,
      "replicated": false,
      "rollover_on_write": false
    }
  ]
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO243-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The write index is now managed by ILM</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO243-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">lifecycle</code> configured on the data stream is now disabled.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO243-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The next write index will be managed by ILM</p>
</td>
</tr>
</table>
</div>
<p>Had we removed the ILM policy from the index template when we <a class="xref" href="tutorial-migrate-data-stream-from-ilm-to-dsl.html#update-index-template-for-dsl">updated</a>
it, the write index of the data stream will now be <code class="literal">Unmanaged</code> because the index
wouldn&#8217;t have the ILM policy configured to fallback onto.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="tutorial-manage-data-stream-retention.html">« Tutorial: Data stream retention</a>
</span>
<span class="next">
<a href="ingest.html">Ingest pipelines »</a>
</span>
</div>
</body>
</html>
