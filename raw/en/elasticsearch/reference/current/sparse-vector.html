<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sparse vector field type | Elasticsearch Guide [8.19] | Elastic</title>
<meta class="elastic" name="content" content="Sparse vector field type | Elasticsearch Guide [8.19]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.19]"/>
<link rel="up" href="mapping-types.html" title="Field data types"/>
<link rel="prev" href="shape.html" title="Shape field type"/>
<link rel="next" href="text.html" title="Text type family"/>
<meta class="elastic" name="product_version" content="8.19"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.19"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.19"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="shape.html">« Shape field type</a>
</span>
<span class="next">
<a href="text.html">Text type family »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.19]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="mapping.html">Mapping</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="mapping-types.html">Field data types</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Sparse vector field type</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/mapping/types/sparse-vector.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/sparse-vector">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="sparse-vector"></a>Sparse vector field type</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/mapping/types/sparse-vector.asciidoc">edit</a></div>
</div></div></div>

<p>A <code class="literal">sparse_vector</code> field can index features and weights so that they can later be used to query documents in queries with a <a class="xref" href="query-dsl-sparse-vector-query.html" title="Sparse vector query"><code class="literal">sparse_vector</code></a>.
This field can also be used with a legacy <a class="xref" href="query-dsl-text-expansion-query.html" title="Text expansion query"><code class="literal">text_expansion</code></a> query.</p>
<p><code class="literal">sparse_vector</code> is the field type that should be used with <a class="xref" href="semantic-search-elser.html#elser-mappings" title="Create the index mapping">ELSER mappings</a>.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.create(
    index="my-index",
    mappings={
        "properties": {
            "text.tokens": {
                "type": "sparse_vector"
            }
        }
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.create(
  index: 'my-index',
  body: {
    mappings: {
      properties: {
        'text.tokens' =&gt; {
          type: 'sparse_vector'
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.create({
  index: "my-index",
  mappings: {
    properties: {
      "text.tokens": {
        type: "sparse_vector",
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="7011fcdd231804f9c3894154ae2c3fbc"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">PUT my-index
{
  "mappings": {
    "properties": {
      "text.tokens": {
        "type": "sparse_vector"
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/361.console"></div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="sparse-vector-token-pruning"></a>Token pruning</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/mapping/types/sparse-vector.asciidoc">edit</a></div>
</div></div></div>
<p>With any new indices created, token pruning will be turned on by default with appropriate defaults. You can control this behaviour using the optional <code class="literal">index_options</code> parameters for the field:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.create(
    index="my-index",
    mappings={
        "properties": {
            "text.tokens": {
                "type": "sparse_vector",
                "index_options": {
                    "prune": True,
                    "pruning_config": {
                        "tokens_freq_ratio_threshold": 5,
                        "tokens_weight_threshold": 0.4
                    }
                }
            }
        }
    },
)
print(resp)</pre>
</div>
<a id="c49ce88ff64cdeadb7029959e80c8f84"></a>
<div class="pre_wrapper lang-console default has-python">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python">PUT my-index
{
  "mappings": {
    "properties": {
      "text.tokens": {
        "type": "sparse_vector",
        "index_options": {
          "prune": true,
          "pruning_config": {
            "tokens_freq_ratio_threshold": 5,
            "tokens_weight_threshold": 0.4
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-python" data-snippet="snippets/362.console"></div>
<p>See <a class="xref" href="semantic-search-elser.html" title="Tutorial: semantic search with ELSER">semantic search with ELSER</a> for a complete example on adding documents to a <code class="literal">sparse_vector</code> mapped field using ELSER.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="sparse-vectors-params"></a>Parameters for <code class="literal">sparse_vector</code> fields</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/mapping/types/sparse-vector.asciidoc">edit</a></div>
</div></div></div>
<p>The following parameters are accepted by <code class="literal">sparse_vector</code> fields:</p>
<div class="informaltable">
<table border="0" cellpadding="4px">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody valign="top">
<tr>
<td valign="top">
<p>
<a class="xref" href="mapping-store.html" title="store">store</a>
</p>
</td>
<td valign="top">
<p>
<p>
Indicates whether the field value should be stored and retrievable independently of the <a class="xref" href="mapping-source-field.html" title="_source field">_source</a> field.
Accepted values: true or false (default).
The field&#8217;s data is stored using term vectors, a disk-efficient structure compared to the original JSON input.
The input map can be retrieved during a search request via the <a class="xref" href="search-fields.html#search-fields-param" title="The fields option"><code class="literal">fields</code> parameter</a>.
To benefit from reduced disk usage, you must either:
</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Exclude the field from <a class="xref" href="search-fields.html#source-filtering" title="The _source option">_source</a>.
</li>
<li class="listitem">
Use <a class="xref" href="mapping-source-field.html#synthetic-source" title="Synthetic _source">synthetic <code class="literal">_source</code></a>.
</li>
</ul>
</div>
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">index_options</code>
</p>
</td>
<td valign="top">
<p>
(Optional, object) You can set index options for your  <code class="literal">sparse_vector</code> field to determine if you should prune tokens, and the parameter configurations for the token pruning. If pruning options are not set in your <a class="xref" href="query-dsl-sparse-vector-query.html" title="Sparse vector query"><code class="literal">sparse_vector query</code></a>, Elasticsearch will use the default options configured for the field, if any.
</p>
</td>
</tr>
</tbody>
</table>
</div>
<p>Parameters for <code class="literal">index_options</code> are:</p>
<div class="informaltable">
<table border="0" cellpadding="4px">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody valign="top">
<tr>
<td valign="top">
<p>
<code class="literal">prune</code>
</p>
</td>
<td valign="top">
<p>
(Optional, boolean) Whether to perform pruning, omitting the non-significant tokens from the query to improve query performance. If <code class="literal">prune</code> is true but the <code class="literal">pruning_config</code> is not specified, pruning will occur but default values will be used. Default: true.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">pruning_config</code>
</p>
</td>
<td valign="top">
<p>
(Optional, object) Optional pruning configuration. If enabled, this will omit non-significant tokens from the query in order to improve query performance. This is only used if <code class="literal">prune</code> is set to <code class="literal">true</code>. If <code class="literal">prune</code> is set to <code class="literal">true</code> but <code class="literal">pruning_config</code> is not specified, default values will be used. If <code class="literal">prune</code> is set to false but <code class="literal">pruning_config</code> is specified, an exception will occur.
</p>
</td>
</tr>
</tbody>
</table>
</div>
<p>Parameters for <code class="literal">pruning_config</code> include:</p>
<div class="informaltable">
<table border="0" cellpadding="4px">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody valign="top">
<tr>
<td valign="top">
<p>
<code class="literal">tokens_freq_ratio_threshold</code>
</p>
</td>
<td valign="top">
<p>
(Optional, integer) Tokens whose frequency is more than <code class="literal">tokens_freq_ratio_threshold</code> times the average frequency of all tokens in the specified field are considered outliers and pruned. This value must between 1 and 100. Default: <code class="literal">5</code>.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">tokens_weight_threshold</code>
</p>
</td>
<td valign="top">
<p>
(Optional, float) Tokens whose weight is less than <code class="literal">tokens_weight_threshold</code> are considered insignificant and pruned. This value must be between 0 and 1. Default: <code class="literal">0.4</code>.
</p>
</td>
</tr>
</tbody>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The default values for <code class="literal">tokens_freq_ratio_threshold</code> and <code class="literal">tokens_weight_threshold</code> were chosen based on tests using ELSERv2 that provided the most optimal results.</p>
</div>
</div>
<p>When token pruning is applied, non-significant tokens will be pruned from the query.
Non-significant tokens can be defined as tokens that meet both of the following criteria:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The token appears much more frequently than most tokens, indicating that it is a very common word and may not benefit the overall search results much.
</li>
<li class="listitem">
The weight/score is so low that the token is likely not very relevant to the original term
</li>
</ul>
</div>
<p>Both the token frequency threshold and weight threshold must show the token is non-significant in order for the token to be pruned.
This ensures that:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The tokens that are kept are frequent enough and have significant scoring.
</li>
<li class="listitem">
Very infrequent tokens that may not have as high of a score are removed.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="index-multi-value-sparse-vectors"></a>Multi-value sparse vectors</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.19/docs/reference/mapping/types/sparse-vector.asciidoc">edit</a></div>
</div></div></div>
<p>When passing in arrays of values for sparse vectors the max value for similarly named features is selected.</p>
<p>The paper Adapting Learned Sparse Retrieval for Long Documents (<a href="https://arxiv.org/pdf/2305.18494.pdf" class="ulink" target="_top">https://arxiv.org/pdf/2305.18494.pdf</a>) discusses this in more detail.
In summary, research findings support representation aggregation typically outperforming score aggregation.</p>
<p>For instances where you want to have overlapping feature names use should store them separately or use nested fields.</p>
<p>Below is an example of passing in a document with overlapping feature names.
Consider that in this example two categories exist for positive sentiment and negative sentiment.
However, for the purposes of retrieval we also want the overall impact rather than specific sentiment.
In the example <code class="literal">impact</code> is stored as a multi-value sparse vector and only the max values of overlapping names are stored.
More specifically the final <code class="literal">GET</code> query here returns a <code class="literal">_score</code> of ~1.2 (which is the <code class="literal">max(impact.delicious[0], impact.delicious[1])</code> and is approximate because we have a relative error of 0.4% as explained below)</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.create(
    index="my-index-000001",
    mappings={
        "properties": {
            "text": {
                "type": "text",
                "analyzer": "standard"
            },
            "impact": {
                "type": "sparse_vector"
            },
            "positive": {
                "type": "sparse_vector"
            },
            "negative": {
                "type": "sparse_vector"
            }
        }
    },
)
print(resp)

resp1 = client.index(
    index="my-index-000001",
    document={
        "text": "I had some terribly delicious carrots.",
        "impact": [
            {
                "I": 0.55,
                "had": 0.4,
                "some": 0.28,
                "terribly": 0.01,
                "delicious": 1.2,
                "carrots": 0.8
            },
            {
                "I": 0.54,
                "had": 0.4,
                "some": 0.28,
                "terribly": 2.01,
                "delicious": 0.02,
                "carrots": 0.4
            }
        ],
        "positive": {
            "I": 0.55,
            "had": 0.4,
            "some": 0.28,
            "terribly": 0.01,
            "delicious": 1.2,
            "carrots": 0.8
        },
        "negative": {
            "I": 0.54,
            "had": 0.4,
            "some": 0.28,
            "terribly": 2.01,
            "delicious": 0.02,
            "carrots": 0.4
        }
    },
)
print(resp1)

resp2 = client.search(
    index="my-index-000001",
    query={
        "term": {
            "impact": {
                "value": "delicious"
            }
        }
    },
)
print(resp2)</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.create({
  index: "my-index-000001",
  mappings: {
    properties: {
      text: {
        type: "text",
        analyzer: "standard",
      },
      impact: {
        type: "sparse_vector",
      },
      positive: {
        type: "sparse_vector",
      },
      negative: {
        type: "sparse_vector",
      },
    },
  },
});
console.log(response);

const response1 = await client.index({
  index: "my-index-000001",
  document: {
    text: "I had some terribly delicious carrots.",
    impact: [
      {
        I: 0.55,
        had: 0.4,
        some: 0.28,
        terribly: 0.01,
        delicious: 1.2,
        carrots: 0.8,
      },
      {
        I: 0.54,
        had: 0.4,
        some: 0.28,
        terribly: 2.01,
        delicious: 0.02,
        carrots: 0.4,
      },
    ],
    positive: {
      I: 0.55,
      had: 0.4,
      some: 0.28,
      terribly: 0.01,
      delicious: 1.2,
      carrots: 0.8,
    },
    negative: {
      I: 0.54,
      had: 0.4,
      some: 0.28,
      terribly: 2.01,
      delicious: 0.02,
      carrots: 0.4,
    },
  },
});
console.log(response1);

const response2 = await client.search({
  index: "my-index-000001",
  query: {
    term: {
      impact: {
        value: "delicious",
      },
    },
  },
});
console.log(response2);</pre>
</div>
<a id="63ecdab34940af053acc409164914c32"></a>
<div class="pre_wrapper lang-console default has-python has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-js">PUT my-index-000001
{
  "mappings": {
    "properties": {
      "text": {
        "type": "text",
        "analyzer": "standard"
      },
      "impact": {
        "type": "sparse_vector"
      },
      "positive": {
        "type": "sparse_vector"
      },
      "negative": {
        "type": "sparse_vector"
      }
    }
  }
}

POST my-index-000001/_doc
{
    "text": "I had some terribly delicious carrots.",
    "impact": [{"I": 0.55, "had": 0.4, "some": 0.28, "terribly": 0.01, "delicious": 1.2, "carrots": 0.8},
               {"I": 0.54, "had": 0.4, "some": 0.28, "terribly": 2.01, "delicious": 0.02, "carrots": 0.4}],
    "positive": {"I": 0.55, "had": 0.4, "some": 0.28, "terribly": 0.01, "delicious": 1.2, "carrots": 0.8},
    "negative": {"I": 0.54, "had": 0.4, "some": 0.28, "terribly": 2.01, "delicious": 0.02, "carrots": 0.4}
}

GET my-index-000001/_search
{
  "query": {
    "term": {
      "impact": {
         "value": "delicious"
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-python has-js" data-snippet="snippets/363.console"></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p><code class="literal">sparse_vector</code> fields can not be included in indices that were <span class="strong strong"><strong>created</strong></span> on Elasticsearch versions between 8.0 and 8.10</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p><code class="literal">sparse_vector</code> fields only support strictly positive values.
Negative values will be rejected.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p><code class="literal">sparse_vector</code> fields do not support <a class="xref" href="analysis.html" title="Text analysis">analyzers</a>, querying, sorting or aggregating.
They may only be used within specialized queries.
The recommended query to use on these fields are <a class="xref" href="query-dsl-sparse-vector-query.html" title="Sparse vector query"><code class="literal">sparse_vector</code></a> queries.
They may also be used within legacy <a class="xref" href="query-dsl-text-expansion-query.html" title="Text expansion query"><code class="literal">text_expansion</code></a> queries.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p><code class="literal">sparse_vector</code> fields only preserve 9 significant bits for the precision, which translates to a relative error of about 0.4%.</p>
</div>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="shape.html">« Shape field type</a>
</span>
<span class="next">
<a href="text.html">Text type family »</a>
</span>
</div>
</body>
</html>
