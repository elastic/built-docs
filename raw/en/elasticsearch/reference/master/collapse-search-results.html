<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Collapse search results | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Collapse search results | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="search-your-data.html" title="The search API"/>
<link rel="prev" href="search-multiple-indices.html" title="Search multiple data streams and indices"/>
<link rel="next" href="filter-search-results.html" title="Filter search results"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="search-multiple-indices.html">« Search multiple data streams and indices</a>
</span>
<span class="next">
<a href="filter-search-results.html">Filter search results »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search-with-elasticsearch.html">Search your data</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search-your-data.html">The search API</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Collapse search results</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/collapse-search-results.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="collapse-search-results"></a>Collapse search results<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/collapse-search-results.asciidoc">edit</a></h2>
</div></div></div>
<p>You can use the <code class="literal">collapse</code> parameter to collapse search results based
on field values. The collapsing is done by selecting only the top sorted
document per collapse key.</p>
<p>For example, the following search collapses results by <code class="literal">user.id</code> and sorts them
by <code class="literal">http.response.bytes</code>.</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index-000001",
  query: {
    match: {
      message: "GET /search",
    },
  },
  collapse: {
    field: "user.id",
  },
  sort: [
    {
      "http.response.bytes": {
        order: "desc",
      },
    },
  ],
  from: 0,
});
console.log(response);</pre>
</div>
<a id="75e13a00f0909c955031ff62acc14a79"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">GET my-index-000001/_search
{
  "query": {
    "match": {
      "message": "GET /search"
    }
  },
  "collapse": {
    "field": "user.id"         <a id="CO222-1"></a><i class="conum" data-value="1"></i>
  },
  "sort": [
    {
      "http.response.bytes": { <a id="CO222-2"></a><i class="conum" data-value="2"></i>
        "order": "desc"
      }
    }
  ],
  "from": 0                    <a id="CO222-3"></a><i class="conum" data-value="3"></i>
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/910.console"></div>
<div class="calloutlist default has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO222-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Collapse the result set using the <code class="literal">user.id</code> field</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO222-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Sort the results by <code class="literal">http.response.bytes</code></p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO222-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Define the offset of the first collapsed result</p>
</td>
</tr>
</table>
</div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>The total number of hits in the response indicates the number of matching documents without collapsing.
The total number of distinct group is unknown.</p>
</div>
</div>
<p>The field used for collapsing must be a single valued <a class="xref" href="keyword.html" title="Keyword type family"><code class="literal">keyword</code></a> or <a class="xref" href="number.html" title="Numeric field types"><code class="literal">numeric</code></a> field with <a class="xref" href="doc-values.html" title="doc_values"><code class="literal">doc_values</code></a> activated.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Collapsing is applied to the top hits only and does not affect aggregations.</p>
</div>
</div>
<h4><a id="expand-collapse-results"></a>Expand collapse results<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/collapse-search-results.asciidoc">edit</a></h4>
<p>It is also possible to expand each collapsed top hits with the <a class="xref" href="inner-hits.html" title="Retrieve inner hits"><code class="literal">inner hits</code></a> option.</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index-000001",
  query: {
    match: {
      message: "GET /search",
    },
  },
  collapse: {
    field: "user.id",
    inner_hits: {
      name: "most_recent",
      size: 5,
      sort: [
        {
          "@timestamp": "desc",
        },
      ],
    },
    max_concurrent_group_searches: 4,
  },
  sort: [
    {
      "http.response.bytes": {
        order: "desc",
      },
    },
  ],
});
console.log(response);</pre>
</div>
<a id="2898cf033b5bdefdbe3723af850b25c5"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">GET /my-index-000001/_search
{
  "query": {
    "match": {
      "message": "GET /search"
    }
  },
  "collapse": {
    "field": "user.id",                       <a id="CO223-1"></a><i class="conum" data-value="1"></i>
    "inner_hits": {
      "name": "most_recent",                  <a id="CO223-2"></a><i class="conum" data-value="2"></i>
      "size": 5,                              <a id="CO223-3"></a><i class="conum" data-value="3"></i>
      "sort": [ { "@timestamp": "desc" } ]    <a id="CO223-4"></a><i class="conum" data-value="4"></i>
    },
    "max_concurrent_group_searches": 4        <a id="CO223-5"></a><i class="conum" data-value="5"></i>
  },
  "sort": [
    {
      "http.response.bytes": {
        "order": "desc"
      }
    }
  ]
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/911.console"></div>
<div class="calloutlist default has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO223-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Collapse the result set using the <code class="literal">user.id</code> field</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO223-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name used for the inner hit section in the response</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO223-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The number of <code class="literal">inner_hits</code> to retrieve per collapse key</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO223-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>How to sort the document inside each group</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO223-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>The number of concurrent requests allowed to retrieve the <code class="literal">inner_hits</code> per group</p>
</td>
</tr>
</table>
</div>
<p>See <a class="xref" href="inner-hits.html" title="Retrieve inner hits">inner hits</a> for the complete list of supported options and the format of the response.</p>
<p>It is also possible to request multiple <a class="xref" href="inner-hits.html" title="Retrieve inner hits"><code class="literal">inner hits</code></a> for each collapsed hit. This can be useful when you want to get
multiple representations of the collapsed hits.</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index-000001",
  query: {
    match: {
      message: "GET /search",
    },
  },
  collapse: {
    field: "user.id",
    inner_hits: [
      {
        name: "largest_responses",
        size: 3,
        sort: [
          {
            "http.response.bytes": {
              order: "desc",
            },
          },
        ],
      },
      {
        name: "most_recent",
        size: 3,
        sort: [
          {
            "@timestamp": {
              order: "desc",
            },
          },
        ],
      },
    ],
  },
  sort: ["http.response.bytes"],
});
console.log(response);</pre>
</div>
<a id="24275847128b68da6e14233aa1259fb9"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">GET /my-index-000001/_search
{
  "query": {
    "match": {
      "message": "GET /search"
    }
  },
  "collapse": {
    "field": "user.id",                   <a id="CO224-1"></a><i class="conum" data-value="1"></i>
    "inner_hits": [
      {
        "name": "largest_responses",      <a id="CO224-2"></a><i class="conum" data-value="2"></i>
        "size": 3,
        "sort": [
          {
            "http.response.bytes": {
              "order": "desc"
            }
          }
        ]
      },
      {
        "name": "most_recent",             <a id="CO224-3"></a><i class="conum" data-value="3"></i>
        "size": 3,
        "sort": [
          {
            "@timestamp": {
              "order": "desc"
            }
          }
        ]
      }
    ]
  },
  "sort": [
    "http.response.bytes"
  ]
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/912.console"></div>
<div class="calloutlist default has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO224-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Collapse the result set using the <code class="literal">user.id</code> field</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO224-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Return the three largest HTTP responses for the user</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO224-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Return the three most recent HTTP responses for the user</p>
</td>
</tr>
</table>
</div>
<p>The expansion of the group is done by sending an additional query for each
<code class="literal">inner_hit</code> request for each collapsed hit returned in the response. This can
significantly slow your search if you have too many groups or <code class="literal">inner_hit</code>
requests.</p>
<p>The <code class="literal">max_concurrent_group_searches</code> request parameter can be used to control
the maximum number of concurrent searches allowed in this phase.
The default is based on the number of data nodes and the default search thread pool size.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p><code class="literal">collapse</code> cannot be used in conjunction with <a class="xref" href="paginate-search-results.html#scroll-search-results" title="Scroll search results">scroll</a>.</p>
</div>
</div>
<h4><a id="collapsing-with-search-after"></a>Collapsing with <code class="literal">search_after</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/collapse-search-results.asciidoc">edit</a></h4>
<p>Field collapsing can be used with the <a class="xref" href="paginate-search-results.html#search-after" title="Search after"><code class="literal">search_after</code></a>
parameter. Using <code class="literal">search_after</code> is only supported when sorting and collapsing
on the same field. Secondary sorts are also not allowed. For example, we can
collapse and sort on <code class="literal">user.id</code>, while paging through the results using
<code class="literal">search_after</code>:</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index-000001",
  query: {
    match: {
      message: "GET /search",
    },
  },
  collapse: {
    field: "user.id",
  },
  sort: ["user.id"],
  search_after: ["dd5ce1ad"],
});
console.log(response);</pre>
</div>
<a id="35c664285f2e8b7d5d50ca37ae3ba794"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">GET /my-index-000001/_search
{
  "query": {
    "match": {
      "message": "GET /search"
    }
  },
  "collapse": {
    "field": "user.id"
  },
  "sort": [ "user.id" ],
  "search_after": ["dd5ce1ad"]
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/913.console"></div>
<h4><a id="rescore-collapse-results"></a>Rescore collapse results<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/collapse-search-results.asciidoc">edit</a></h4>
<p>You can use field collapsing alongside the <a class="xref" href="filter-search-results.html#rescore" title="Rescore filtered search results"><code class="literal">rescore</code></a> search parameter.
Rescorers run on every shard for the top-ranked document per collapsed field.
To maintain a reliable order, it is recommended to cluster documents sharing the same collapse
field value on one shard.
This is achieved by assigning the collapse field value as the <a class="xref" href="search-shard-routing.html#search-routing" title="Use a routing value">routing key</a>
during indexing:</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.index({
  index: "my-index-000001",
  routing: "xyz",
  document: {
    "@timestamp": "2099-11-15T13:12:00",
    message: "You know for search!",
    "user.id": "xyz",
  },
});
console.log(response);</pre>
</div>
<a id="29e002ab596bae58712eb048ac1768d1"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">POST /my-index-000001/_doc?routing=xyz      <a id="CO225-1"></a><i class="conum" data-value="1"></i>
{
  "@timestamp": "2099-11-15T13:12:00",
  "message": "You know for search!",
  "user.id": "xyz"
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/914.console"></div>
<div class="calloutlist default has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO225-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Assign routing with the collapse field value (<code class="literal">user.id</code>).</p>
</td>
</tr>
</table>
</div>
<p>By doing this, you guarantee that only one top document per
collapse key gets rescored globally.</p>
<p>The following request utilizes field collapsing on the <code class="literal">user.id</code>
field and then rescores the top groups with a <a class="xref" href="filter-search-results.html#query-rescorer" title="Query rescorer">query rescorer</a>:</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index-000001",
  query: {
    match: {
      message: "you know for search",
    },
  },
  collapse: {
    field: "user.id",
  },
  rescore: {
    window_size: 50,
    query: {
      rescore_query: {
        match_phrase: {
          message: "you know for search",
        },
      },
      query_weight: 0.3,
      rescore_query_weight: 1.4,
    },
  },
});
console.log(response);</pre>
</div>
<a id="3a3e6e2627cafa08e4402a0de95785cc"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">GET /my-index-000001/_search
{
  "query": {
    "match": {
      "message": "you know for search"
    }
  },
  "collapse": {
    "field": "user.id"
  },
  "rescore" : {
      "window_size" : 50,
      "query" : {
         "rescore_query" : {
            "match_phrase": {
                "message": "you know for search"
            }
         },
         "query_weight" : 0.3,
         "rescore_query_weight" : 1.4
      }
   }
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/915.console"></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Rescorers are not applied to <a class="xref" href="inner-hits.html" title="Retrieve inner hits"><code class="literal">inner hits</code></a>.</p>
</div>
</div>
<h4><a id="second-level-of-collapsing"></a>Second level of collapsing<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/collapse-search-results.asciidoc">edit</a></h4>
<p>A second level of collapsing is also supported and is applied to <code class="literal">inner_hits</code>.</p>
<p>For example, the following search collapses results by <code class="literal">geo.country_name</code>.
Within each <code class="literal">geo.country_name</code>, inner hits are collapsed by <code class="literal">user.id</code>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Second level of collapsing doesn&#8217;t allow <code class="literal">inner_hits</code>.</p>
</div>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index-000001",
  query: {
    match: {
      message: "GET /search",
    },
  },
  collapse: {
    field: "geo.country_name",
    inner_hits: {
      name: "by_location",
      collapse: {
        field: "user.id",
      },
      size: 3,
    },
  },
});
console.log(response);</pre>
</div>
<a id="8743887d9b89ea1a2d5e780c349972cf"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">GET /my-index-000001/_search
{
  "query": {
    "match": {
      "message": "GET /search"
    }
  },
  "collapse": {
    "field": "geo.country_name",
    "inner_hits": {
      "name": "by_location",
      "collapse": { "field": "user.id" },
      "size": 3
    }
  }
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/916.console"></div>
<a id="b5e7ec8c762197206f806ad625fc42b9"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "hits" : {
    "hits" : [
      {
        "_index" : "my-index-000001",
        "_id" : "oX9uXXoB0da05OCR3adK",
        "_score" : 0.5753642,
        "_source" : {
          "@timestamp" : "2099-11-15T14:12:12",
          "geo" : {
            "country_name" : "Amsterdam"
          },
          "http" : {
            "request" : {
              "method" : "get"
            },
            "response" : {
              "bytes" : 1070000,
              "status_code" : 200
            },
            "version" : "1.1"
          },
          "message" : "GET /search HTTP/1.1 200 1070000",
          "source" : {
            "ip" : "127.0.0.1"
          },
          "user" : {
            "id" : "kimchy"
          }
        },
        "fields" : {
          "geo.country_name" : [
            "Amsterdam"
          ]
        },
        "inner_hits" : {
          "by_location" : {
            "hits" : {
              "total" : {
                "value" : 1,
                "relation" : "eq"
              },
              "max_score" : 0.5753642,
              "hits" : [
                {
                  "_index" : "my-index-000001",
                  "_id" : "oX9uXXoB0da05OCR3adK",
                  "_score" : 0.5753642,
                  "_source" : {
                    "@timestamp" : "2099-11-15T14:12:12",
                    "geo" : {
                      "country_name" : "Amsterdam"
                    },
                    "http" : {
                      "request" : {
                        "method" : "get"
                      },
                      "response" : {
                        "bytes" : 1070000,
                        "status_code" : 200
                      },
                      "version" : "1.1"
                    },
                    "message" : "GET /search HTTP/1.1 200 1070000",
                    "source" : {
                      "ip" : "127.0.0.1"
                    },
                    "user" : {
                      "id" : "kimchy"
                    }
                  },
                  "fields" : {
                    "user.id" : [
                      "kimchy"
                    ]
                  }
                }
              ]
            }
          }
        }
      }
    ]
  }
}</pre>
</div>
<h4><a id="_track_scores_2"></a>Track Scores<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/collapse-search-results.asciidoc">edit</a></h4>
<p>When <code class="literal">collapse</code> is used with <code class="literal">sort</code> on a field, scores are not computed.
Setting <code class="literal">track_scores</code> to true instructs Elasticsearch to compute and track scores.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="search-multiple-indices.html">« Search multiple data streams and indices</a>
</span>
<span class="next">
<a href="filter-search-results.html">Filter search results »</a>
</span>
</div>
</body>
</html>
