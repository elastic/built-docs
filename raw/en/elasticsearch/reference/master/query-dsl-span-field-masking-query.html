<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Span field masking query | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Span field masking query | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="span-queries.html" title="Span queries"/>
<link rel="prev" href="query-dsl-span-containing-query.html" title="Span containing query"/>
<link rel="next" href="query-dsl-span-first-query.html" title="Span first query"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="query-dsl-span-containing-query.html">« Span containing query</a>
</span>
<span class="next">
<a href="query-dsl-span-first-query.html">Span first query »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="query-dsl.html">Query DSL</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="span-queries.html">Span queries</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Span field masking query</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/query-dsl/span-field-masking-query.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-span-field-masking-query"></a>Span field masking query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/query-dsl/span-field-masking-query.asciidoc">edit</a></h2>
</div></div></div>

<p>Wrapper to allow span queries to participate in composite single-field span queries by <em>lying</em> about their search field.</p>
<p>This can be used to support queries like <code class="literal">span-near</code> or <code class="literal">span-or</code> across different fields, which is not ordinarily permitted.</p>
<p>Span field masking query is invaluable in conjunction with <span class="strong strong"><strong>multi-fields</strong></span> when same content is indexed with multiple analyzers. For instance, we could index a field with the standard analyzer which breaks text up into words, and again with the english analyzer which stems words into their root form.</p>
<p>Example:</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  body: {
    query: {
      span_near: {
        clauses: [
          {
            span_term: {
              text: 'quick brown'
            }
          },
          {
            span_field_masking: {
              query: {
                span_term: {
                  'text.stems' =&gt; 'fox'
                }
              },
              field: 'text'
            }
          }
        ],
        slop: 5,
        in_order: false
      }
    },
    highlight: {
      require_field_match: false,
      fields: {
        "*": {}
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  query: {
    span_near: {
      clauses: [
        {
          span_term: {
            text: "quick brown",
          },
        },
        {
          span_field_masking: {
            query: {
              span_term: {
                "text.stems": "fox",
              },
            },
            field: "text",
          },
        },
      ],
      slop: 5,
      in_order: false,
    },
  },
  highlight: {
    require_field_match: false,
    fields: {
      "*": {},
    },
  },
});
console.log(response);</pre>
</div>
<a id="388ec2b038d3ad69378f4c2e5bc36dce"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET /_search
{
  "query": {
    "span_near": {
      "clauses": [
        {
          "span_term": {
            "text": "quick brown"
          }
        },
        {
          "span_field_masking": {
            "query": {
              "span_term": {
                "text.stems": "fox" <a id="CO306-1"></a><i class="conum" data-value="1"></i>
              }
            },
            "field": "text" <a id="CO306-2"></a><i class="conum" data-value="2"></i>
          }
        }
      ],
      "slop": 5,
      "in_order": false
    }
  },
  "highlight": {
    "require_field_match" : false, <a id="CO306-3"></a><i class="conum" data-value="3"></i>
    "fields": {
      "*": {}
    }
  }
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/1256.console"></div>
<div class="calloutlist default has-ruby has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO306-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Original field on which we do the search</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO306-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Masked field, which we are masking with the original field</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO306-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Use "require_field_match" : false to highlight the masked field</p>
</td>
</tr>
</table>
</div>
<p>Note: <code class="literal">span_field_masking</code> query may have unexpected scoring and highlighting
behaviour. This is because the query returns and highlights the masked field,
but scoring and highlighting are done using the terms statistics and offsets
of the original field.</p>
<p>Note: For highlighting to work the parameter: <code class="literal">require_field_match</code> should
be set to <code class="literal">false</code> on the highlighter.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="query-dsl-span-containing-query.html">« Span containing query</a>
</span>
<span class="next">
<a href="query-dsl-span-first-query.html">Span first query »</a>
</span>
</div>
</body>
</html>
