<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Text expansion query | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Text expansion query | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="vector-queries.html" title="Vector queries"/>
<link rel="prev" href="query-dsl-semantic-query.html" title="Semantic query"/>
<link rel="next" href="query-dsl-weighted-tokens-query.html" title="Weighted tokens query"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="query-dsl-semantic-query.html">« Semantic query</a>
</span>
<span class="next">
<a href="query-dsl-weighted-tokens-query.html">Weighted tokens query »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="query-dsl.html">Query DSL</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="vector-queries.html">Vector queries</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Text expansion query</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-text-expansion-query"></a>Text expansion query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></h2>
</div></div></div>

<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<h3>Deprecated in 8.15.0.</h3>
<p>This query has been replaced by <a class="xref" href="query-dsl-sparse-vector-query.html" title="Sparse vector query">Sparse vector</a>.</p>
</div>
</div>
<p>The text expansion query uses a natural language processing model to convert the query text into a list of token-weight pairs which are then used in a query against a
<a class="xref" href="sparse-vector.html" title="Sparse vector field type">sparse vector</a> or <a class="xref" href="rank-features.html" title="Rank features field type">rank features</a> field.</p>
<h4><a id="text-expansion-query-ex-request"></a>Example request<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></h4>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  body: {
    query: {
      text_expansion: {
        "&lt;sparse_vector_field&gt;": {
          model_id: 'the model to produce the token weights',
          model_text: 'the query string'
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  query: {
    text_expansion: {
      "&lt;sparse_vector_field&gt;": {
        model_id: "the model to produce the token weights",
        model_text: "the query string",
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="2155c920d7d860f3ee7542f2211b4fec"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET _search
{
   "query":{
      "text_expansion":{
         "&lt;sparse_vector_field&gt;":{
            "model_id":"the model to produce the token weights",
            "model_text":"the query string"
         }
      }
   }
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/1278.console"></div>
<h4><a id="text-expansion-query-params"></a>Top level parameters for <code class="literal">text_expansion</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></h4>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">&lt;sparse_vector_field&gt;</code>
</span>
</dt>
<dd>
(Required, object) The name of the field that contains the token-weight pairs the NLP model created based on the input text.
</dd>
</dl>
</div>
<h4><a id="text-expansion-rank-feature-field-params"></a>Top level parameters for <code class="literal">&lt;sparse_vector_field&gt;</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></h4>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">model_id</code>
</span>
</dt>
<dd>
(Required, string) The ID of the model to use to convert the query text into token-weight pairs.
It must be the same model ID that was used to create the tokens from the input text.
</dd>
<dt>
<span class="term">
<code class="literal">model_text</code>
</span>
</dt>
<dd>
(Required, string) The query text you want to use for search.
</dd>
<dt>
<span class="term">
<code class="literal">pruning_config</code>
</span>
</dt>
<dd>
<p>
(Optional, object)
<span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span>
Optional pruning configuration.
If enabled, this will omit non-significant tokens from the query in order to improve query performance.
Default: Disabled.
</p>
<p>Parameters for <code class="literal">&lt;pruning_config&gt;</code> are:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">tokens_freq_ratio_threshold</code>
</span>
</dt>
<dd>
(Optional, integer)
<span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span>
Tokens whose frequency is more than <code class="literal">tokens_freq_ratio_threshold</code> times the average frequency of all tokens in the specified field are considered outliers and pruned.
This value must between 1 and 100.
Default: <code class="literal">5</code>.
</dd>
<dt>
<span class="term">
<code class="literal">tokens_weight_threshold</code>
</span>
</dt>
<dd>
(Optional, float)
<span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span>
Tokens whose weight is less than <code class="literal">tokens_weight_threshold</code> are considered nonsignificant and pruned.
This value must be between 0 and 1.
Default: <code class="literal">0.4</code>.
</dd>
<dt>
<span class="term">
<code class="literal">only_score_pruned_tokens</code>
</span>
</dt>
<dd>
(Optional, boolean)
<span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span>
If <code class="literal">true</code> we only input pruned tokens into scoring, and discard non-pruned tokens.
It is strongly recommended to set this to <code class="literal">false</code> for the main query, but this can be set to <code class="literal">true</code> for a rescore query to get more relevant results.
Default: <code class="literal">false</code>.
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The default values for <code class="literal">tokens_freq_ratio_threshold</code> and <code class="literal">tokens_weight_threshold</code> were chosen based on tests using ELSER that provided the most optimal results.</p>
</div>
</div>
</dd>
</dl>
</div>
<h4><a id="text-expansion-query-example"></a>Example ELSER query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></h4>
<p>The following is an example of the <code class="literal">text_expansion</code> query that references the ELSER model to perform semantic search.
For a more detailed description of how to perform semantic search by using ELSER and the <code class="literal">text_expansion</code> query, refer to <a class="xref" href="semantic-search-elser.html" title="Tutorial: semantic search with ELSER">this tutorial</a>.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'my-index',
  body: {
    query: {
      text_expansion: {
        'ml.tokens' =&gt; {
          model_id: '.elser_model_2',
          model_text: 'How is the weather in Jamaica?'
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index",
  query: {
    text_expansion: {
      "ml.tokens": {
        model_id: ".elser_model_2",
        model_text: "How is the weather in Jamaica?",
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="2310d84ebf113f2a3ed14cc53172ae4a"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET my-index/_search
{
   "query":{
      "text_expansion":{
         "ml.tokens":{
            "model_id":".elser_model_2",
            "model_text":"How is the weather in Jamaica?"
         }
      }
   }
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/1279.console"></div>
<p>Multiple <code class="literal">text_expansion</code> queries can be combined with each other or other query types.
This can be achieved by wrapping them in <a class="xref" href="query-dsl-bool-query.html" title="Boolean query">boolean query clauses</a> and using linear boosting:</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'my-index',
  body: {
    query: {
      bool: {
        should: [
          {
            text_expansion: {
              'ml.inference.title_expanded.predicted_value' =&gt; {
                model_id: '.elser_model_2',
                model_text: 'How is the weather in Jamaica?',
                boost: 1
              }
            }
          },
          {
            text_expansion: {
              'ml.inference.description_expanded.predicted_value' =&gt; {
                model_id: '.elser_model_2',
                model_text: 'How is the weather in Jamaica?',
                boost: 1
              }
            }
          },
          {
            multi_match: {
              query: 'How is the weather in Jamaica?',
              fields: [
                'title',
                'description'
              ],
              boost: 4
            }
          }
        ]
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index",
  query: {
    bool: {
      should: [
        {
          text_expansion: {
            "ml.inference.title_expanded.predicted_value": {
              model_id: ".elser_model_2",
              model_text: "How is the weather in Jamaica?",
              boost: 1,
            },
          },
        },
        {
          text_expansion: {
            "ml.inference.description_expanded.predicted_value": {
              model_id: ".elser_model_2",
              model_text: "How is the weather in Jamaica?",
              boost: 1,
            },
          },
        },
        {
          multi_match: {
            query: "How is the weather in Jamaica?",
            fields: ["title", "description"],
            boost: 4,
          },
        },
      ],
    },
  },
});
console.log(response);</pre>
</div>
<a id="4fcca1687d7b2cf08de526539fea5a76"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET my-index/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "text_expansion": {
            "ml.inference.title_expanded.predicted_value": {
              "model_id": ".elser_model_2",
              "model_text": "How is the weather in Jamaica?",
              "boost": 1
            }
          }
        },
        {
          "text_expansion": {
            "ml.inference.description_expanded.predicted_value": {
              "model_id": ".elser_model_2",
              "model_text": "How is the weather in Jamaica?",
              "boost": 1
            }
          }
        },
        {
          "multi_match": {
            "query": "How is the weather in Jamaica?",
            "fields": [
              "title",
              "description"
            ],
            "boost": 4
          }
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/1280.console"></div>
<p>This can also be achieved using <a class="xref" href="rrf.html" title="Reciprocal rank fusion">reciprocal rank fusion (RRF)</a>, through an <a class="xref" href="retriever.html#rrf-retriever" title="RRF Retriever"><code class="literal">rrf</code> retriever</a> with multiple
<a class="xref" href="retriever.html#standard-retriever" title="Standard Retriever"><code class="literal">standard</code> retrievers</a>.</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index",
  retriever: {
    rrf: {
      retrievers: [
        {
          standard: {
            query: {
              multi_match: {
                query: "How is the weather in Jamaica?",
                fields: ["title", "description"],
              },
            },
          },
        },
        {
          standard: {
            query: {
              text_expansion: {
                "ml.inference.title_expanded.predicted_value": {
                  model_id: ".elser_model_2",
                  model_text: "How is the weather in Jamaica?",
                },
              },
            },
          },
        },
        {
          standard: {
            query: {
              text_expansion: {
                "ml.inference.description_expanded.predicted_value": {
                  model_id: ".elser_model_2",
                  model_text: "How is the weather in Jamaica?",
                },
              },
            },
          },
        },
      ],
      window_size: 10,
      rank_constant: 20,
    },
  },
});
console.log(response);</pre>
</div>
<a id="046b2249bbc49e77848c114cee940f17"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">GET my-index/_search
{
  "retriever": {
    "rrf": {
      "retrievers": [
        {
          "standard": {
            "query": {
              "multi_match": {
                "query": "How is the weather in Jamaica?",
                "fields": [
                  "title",
                  "description"
                ]
              }
            }
          }
        },
        {
          "standard": {
            "query": {
              "text_expansion": {
                "ml.inference.title_expanded.predicted_value": {
                  "model_id": ".elser_model_2",
                  "model_text": "How is the weather in Jamaica?"
                }
              }
            }
          }
        },
        {
          "standard": {
            "query": {
              "text_expansion": {
                "ml.inference.description_expanded.predicted_value": {
                  "model_id": ".elser_model_2",
                  "model_text": "How is the weather in Jamaica?"
                }
              }
            }
          }
        }
      ],
      "window_size": 10,
      "rank_constant": 20
    }
  }
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/1281.console"></div>
<h4><a id="text-expansion-query-with-pruning-config-and-rescore-example"></a>Example ELSER query with pruning configuration and rescore<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/query-dsl/text-expansion-query.asciidoc">edit</a></h4>
<p>The following is an extension to the above example that adds a <span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> pruning configuration to the <code class="literal">text_expansion</code> query.
The pruning configuration identifies non-significant tokens to prune from the query in order to improve query performance.</p>
<p>Token pruning happens at the shard level.
While this should result in the same tokens being labeled as insignificant across shards, this is not guaranteed based on the composition of each shard.
Therefore, if you are running <code class="literal">text_expansion</code> with a <code class="literal">pruning_config</code> on a multi-shard index, we strongly recommend adding a <a class="xref" href="filter-search-results.html#rescore" title="Rescore filtered search results">Rescore filtered search results</a> function with the tokens that were originally pruned from the query.
This will help mitigate any shard-level inconsistency with pruned tokens and provide better relevance overall.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'my-index',
  body: {
    query: {
      text_expansion: {
        'ml.tokens' =&gt; {
          model_id: '.elser_model_2',
          model_text: 'How is the weather in Jamaica?',
          pruning_config: {
            tokens_freq_ratio_threshold: 5,
            tokens_weight_threshold: 0.4,
            only_score_pruned_tokens: false
          }
        }
      }
    },
    rescore: {
      window_size: 100,
      query: {
        rescore_query: {
          text_expansion: {
            'ml.tokens' =&gt; {
              model_id: '.elser_model_2',
              model_text: 'How is the weather in Jamaica?',
              pruning_config: {
                tokens_freq_ratio_threshold: 5,
                tokens_weight_threshold: 0.4,
                only_score_pruned_tokens: true
              }
            }
          }
        }
      }
    }
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.search({
  index: "my-index",
  query: {
    text_expansion: {
      "ml.tokens": {
        model_id: ".elser_model_2",
        model_text: "How is the weather in Jamaica?",
        pruning_config: {
          tokens_freq_ratio_threshold: 5,
          tokens_weight_threshold: 0.4,
          only_score_pruned_tokens: false,
        },
      },
    },
  },
  rescore: {
    window_size: 100,
    query: {
      rescore_query: {
        text_expansion: {
          "ml.tokens": {
            model_id: ".elser_model_2",
            model_text: "How is the weather in Jamaica?",
            pruning_config: {
              tokens_freq_ratio_threshold: 5,
              tokens_weight_threshold: 0.4,
              only_score_pruned_tokens: true,
            },
          },
        },
      },
    },
  },
});
console.log(response);</pre>
</div>
<a id="e9a0b450af6219772631703d602c7092"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET my-index/_search
{
   "query":{
      "text_expansion":{
         "ml.tokens":{
            "model_id":".elser_model_2",
            "model_text":"How is the weather in Jamaica?",
            "pruning_config": {
               "tokens_freq_ratio_threshold": 5,
               "tokens_weight_threshold": 0.4,
               "only_score_pruned_tokens": false
           }
         }
      }
   },
   "rescore": {
      "window_size": 100,
      "query": {
         "rescore_query": {
            "text_expansion": {
               "ml.tokens": {
                  "model_id": ".elser_model_2",
                  "model_text": "How is the weather in Jamaica?",
                  "pruning_config": {
                     "tokens_freq_ratio_threshold": 5,
                     "tokens_weight_threshold": 0.4,
                     "only_score_pruned_tokens": true
                  }
               }
            }
         }
      }
   }
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/1282.console"></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Depending on your data, the text expansion query may be faster with <code class="literal">track_total_hits: false</code>.</p>
</div>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="query-dsl-semantic-query.html">« Semantic query</a>
</span>
<span class="next">
<a href="query-dsl-weighted-tokens-query.html">Weighted tokens query »</a>
</span>
</div>
</body>
</html>
