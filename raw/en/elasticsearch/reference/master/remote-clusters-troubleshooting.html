<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Troubleshooting remote clusters | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Troubleshooting remote clusters | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="remote-clusters.html" title="Remote clusters"/>
<link rel="prev" href="remote-clusters-settings.html" title="Remote cluster settings"/>
<link rel="next" href="modules-plugins.html" title="Plugins"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="setup.html">Set up Elasticsearch</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="remote-clusters.html">Remote clusters</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="remote-clusters-settings.html">« Remote cluster settings</a>
</span>
<span class="next">
<a href="modules-plugins.html">Plugins »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="remote-clusters-troubleshooting"></a>Troubleshooting remote clusters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h2>
</div></div></div>

<p>You may encounter several issues when setting up a remote cluster for cross-cluster replication or
cross-cluster search.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="remote-clusters-troubleshooting-general"></a>General troubleshooting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h3>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="remote-clusters-troubleshooting-check-connection"></a>Checking whether a remote cluster has connected successfully<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>A successful call to the cluster settings update API for adding or updating
remote clusters does not necessarily mean the configuration is successful.
Use the <a class="xref" href="cluster-remote-info.html" title="Remote cluster info API">remote cluster info API</a> to verify that a local
cluster is successfully connected to a remote cluster.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.cluster.remote_info()
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cluster.remote_info
puts response</pre>
</div>
<a id="cc0cca5556ec6224c7134c233734beed"></a>
<div class="pre_wrapper lang-console default has-python has-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby">GET /_remote/info</pre>
</div>
<div class="console_widget has-python has-ruby" data-snippet="snippets/76.console"></div>
<p>The API should return <code class="literal">"connected" : true</code>. When using
<a class="xref" href="remote-clusters-api-key.html" title="Add remote clusters using API key authentication">API key authentication</a>, it should also return
<code class="literal">"cluster_credentials": "::es_redacted::"</code>.</p>
<a id="d185e42af3c4ed91649e255f803cda8c"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "cluster_one" : {
    "seeds" : [
      "127.0.0.1:9443"
    ],
    "connected" : true, <a id="CO29-1"></a><i class="conum" data-value="1"></i>
    "num_nodes_connected" : 1,
    "max_connections_per_cluster" : 3,
    "initial_connect_timeout" : "30s",
    "skip_unavailable" : false,
    "cluster_credentials": "::es_redacted::", <a id="CO29-2"></a><i class="conum" data-value="2"></i>
    "mode" : "sniff"
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO29-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The remote cluster has connected successfully.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO29-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>If present, indicates the remote cluster has connected using
<a class="xref" href="remote-clusters-api-key.html" title="Add remote clusters using API key authentication">API key authentication</a> instead of
<a class="xref" href="remote-clusters-cert.html" title="Add remote clusters using TLS certificate authentication">certificate based authentication</a>.</p>
</td>
</tr>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="remote-clusters-troubleshooting-enable-server"></a>Enabling the remote cluster server<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>When using API key authentication, cross-cluster traffic happens on the remote
cluster interface, instead of the transport interface. The remote cluster
interface is not enabled by default. This means a node is not ready to accept
incoming cross-cluster requests by default, while it is ready to send outgoing
cross-cluster requests. Ensure you&#8217;ve enabled the remote cluster server on every
node of the remote cluster. In <code class="literal">elasticsearch.yml</code>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Set <a class="xref" href="modules-network.html#remote-cluster-network-settings" title="Advanced remote cluster (API key based model) settings"><code class="literal">remote_cluster_server.enabled</code></a> to
<code class="literal">true</code>.
</li>
<li class="listitem">
Configure the bind and publish address for remote cluster server traffic, for
example using <a class="xref" href="modules-network.html#remote-cluster-network-settings" title="Advanced remote cluster (API key based model) settings"><code class="literal">remote_cluster.host</code></a>. Without
configuring the address, remote cluster traffic may be bound to the local
interface, and remote clusters running on other machines can&#8217;t connect.
</li>
<li class="listitem">
Optionally, configure the remote server port using
<a class="xref" href="modules-network.html#remote_cluster.port"><code class="literal">remote_cluster.port</code></a> (defaults to <code class="literal">9443</code>).
</li>
</ul>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="remote-clusters-troubleshooting-common-issues"></a>Common issues<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h3>
</div></div></div>
<p>The following issues are listed in the order they may occur while setting up a
remote cluster.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="remote-clusters-not-reachable"></a>Remote cluster not reachable<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_symptom"></a>Symptom<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>A local cluster may not be able to reach a remote cluster for many reasons. For
example, the remote cluster server may not be enabled, an incorrect host or port
may be configured, or a firewall may be blocking traffic. When a remote cluster
is not reachable, check the logs of the local cluster for a <code class="literal">connect_exception</code>.</p>
<p>When the remote cluster is configured using proxy mode:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T16:36:47,264][WARN ][o.e.t.ProxyConnectionStrategy] [local-node] failed to open any proxy connections to cluster [my]
org.elasticsearch.transport.ConnectTransportException: [][192.168.0.42:9443] <span class="strong strong"><strong>connect_exception</strong></span></pre>
</div>
<p>When the remote cluster is configured using sniff mode:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T16:38:37,731][WARN ][o.e.t.SniffConnectionStrategy] [local-node] fetching nodes from external cluster [my] failed
org.elasticsearch.transport.ConnectTransportException: [][192.168.0.42:9443] <span class="strong strong"><strong>connect_exception</strong></span></pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_resolution"></a>Resolution<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Check the host and port for the remote cluster are correct.
</li>
<li class="listitem">
Ensure the <a class="xref" href="remote-clusters-troubleshooting.html#remote-clusters-troubleshooting-enable-server" title="Enabling the remote cluster server">remote cluster
server is enabled</a> on the remote cluster.
</li>
<li class="listitem">
Ensure no firewall is blocking the communication.
</li>
</ul>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="remote-clusters-unreliable-network"></a>Remote cluster connection is unreliable<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_symptom_2"></a>Symptom<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>The local cluster can connect to the remote cluster, but the connection does
not work reliably. For example, some cross-cluster requests may succeed while
others report connection errors, time out, or appear to be stuck waiting for
the remote cluster to respond.</p>
<p>When Elasticsearch detects that the remote cluster connection is not working, it will
report the following message in its logs:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T16:36:47,264][INFO ][o.e.t.ClusterConnectionManager] [local-node] transport connection to [{my-remote#192.168.0.42:9443}{...}] closed by remote</pre>
</div>
<p>This message will also be logged if the node of the remote cluster to which
Elasticsearch is connected is shut down or restarted.</p>
<p>Note that with some network configurations it could take minutes or hours for
the operating system to detect that a connection has stopped working. Until the
failure is detected and reported to Elasticsearch, requests involving the remote cluster
may time out or may appear to be stuck.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_resolution_2"></a>Resolution<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Ensure that the network between the clusters is as reliable as possible.
</li>
<li class="listitem">
Ensure that the network is configured to permit <a class="xref" href="modules-network.html#long-lived-connections" title="Long-lived idle connections">Long-lived idle connections</a>.
</li>
<li class="listitem">
Ensure that the network is configured to detect faulty connections quickly.
In particular, you must enable and fully support TCP keepalives, and set a
short <a class="xref" href="system-config-tcpretries.html" title="TCP retransmission timeout">retransmission timeout</a>.
</li>
<li class="listitem">
On Linux systems, execute <code class="literal">ss -tonie</code> to verify the details of the
configuration of each network connection between the clusters.
</li>
<li class="listitem">
If the problems persist, capture network packets at both ends of the
connection and analyse the traffic to look for delays and lost messages.
</li>
</ul>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="remote-clusters-troubleshooting-tls-trust"></a>TLS trust not established<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>TLS can be misconfigured on the local or the remote cluster. The result is that
the local cluster does not trust the certificate presented by the remote
cluster.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_symptom_3"></a>Symptom<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>The local cluster logs <code class="literal">failed to establish trust with server</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-29T09:40:55,465][WARN ][o.e.c.s.DiagnosticTrustManager] [local-node] <span class="strong strong"><strong>failed to establish trust with server</strong></span> at [192.168.0.42]; the server provided a certificate with subject name [CN=remote_cluster], fingerprint [529de35e15666ffaa26afa50876a2a48119db03a], no keyUsage and no extendedKeyUsage; the certificate is valid between [2023-01-29T12:08:37Z] and [2032-08-29T12:08:37Z] (current time is [2023-08-16T23:40:55.464275Z], certificate dates are valid); the session uses cipher suite [TLS_AES_256_GCM_SHA384] and protocol [TLSv1.3]; the certificate has subject alternative names [DNS:localhost,DNS:localhost6.localdomain6,IP:127.0.0.1,IP:0:0:0:0:0:0:0:1,DNS:localhost4,DNS:localhost6,DNS:localhost.localdomain,DNS:localhost4.localdomain4,IP:192.168.0.42]; the certificate is issued by [CN=Elastic Auto RemoteCluster CA] but the server did not provide a copy of the issuing certificate in the certificate chain; this ssl context ([(shared) (with trust configuration: JDK-trusted-certs)]) is not configured to trust that issuer but trusts [97] other issuers
sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target</pre>
</div>
<p>The remote cluster logs <code class="literal">client did not trust this server's certificate</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-29T09:40:55,478][WARN ][o.e.x.c.s.t.n.SecurityNetty4Transport] [remote-node] <span class="strong strong"><strong>client did not trust this server's certificate</strong></span>, closing connection Netty4TcpChannel{localAddress=/192.168.0.42:9443, remoteAddress=/192.168.0.84:57305, profile=_remote_cluster}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_resolution_3"></a>Resolution<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>Read the warn log message on the local cluster carefully to determine the exact
cause of the failure. For example:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Is the remote cluster certificate not signed by a trusted CA? This is the most
likely cause.
</li>
<li class="listitem">
Is hostname verification failing?
</li>
<li class="listitem">
Is the certificate expired?
</li>
</ul>
</div>
<p>Once you know the cause, you should be able to fix it by adjusting the remote
cluster related SSL settings on either the local cluster or the remote cluster.</p>
<p>Often, the issue is on the local cluster. For example, fix it by configuring necessary
trusted CAs (<code class="literal">xpack.security.remote_cluster_client.ssl.certificate_authorities</code>).</p>
<p>If you change the <code class="literal">elasticsearch.yml</code> file, the associated cluster needs to be
restarted for the changes to take effect.</p>
</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="remote-clusters-troubleshooting-api-key"></a>API key authentication issues<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h3>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="remote-clusters-troubleshooting-transport-port-api-key"></a>Connecting to transport port when using API key authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>When using API key authentication, a local cluster should connect to a remote
cluster&#8217;s remote cluster server port (defaults to <code class="literal">9443</code>) instead of the
transport port (defaults to <code class="literal">9300</code>). A misconfiguration can lead to a number of
symptoms:</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_symptom_1"></a>Symptom 1<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>It&#8217;s recommended to use different CAs and certificates for the transport
interface and the remote cluster server interface. If this recommendation is
followed, a remote cluster client node does not trust the server certificate
presented by a remote cluster on the transport interface.</p>
<p>The local cluster logs <code class="literal">failed to establish trust with server</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T12:48:46,575][WARN ][o.e.c.s.DiagnosticTrustManager] [local-node] <span class="strong strong"><strong>failed to establish trust with server</strong></span> at [1192.168.0.42]; the server provided a certificate with subject name [CN=transport], fingerprint [c43e628be2a8aaaa4092b82d78f2bc206c492322], no keyUsage and no extendedKeyUsage; the certificate is valid between [2023-01-29T12:05:53Z] and [2032-08-29T12:05:53Z] (current time is [2023-06-28T02:48:46.574738Z], certificate dates are valid); the session uses cipher suite [TLS_AES_256_GCM_SHA384] and protocol [TLSv1.3]; the certificate has subject alternative names [DNS:localhost,DNS:localhost6.localdomain6,IP:127.0.0.1,IP:0:0:0:0:0:0:0:1,DNS:localhost4,DNS:localhost6,DNS:localhost.localdomain,DNS:localhost4.localdomain4,IP:192.168.0.42]; the certificate is issued by [CN=Elastic Auto Transport CA] but the server did not provide a copy of the issuing certificate in the certificate chain; this ssl context ([xpack.security.remote_cluster_client.ssl (with trust configuration: PEM-trust{/rcs2/ssl/remote-cluster-ca.crt})]) is not configured to trust that issuer, it only trusts the issuer [CN=Elastic Auto RemoteCluster CA] with fingerprint [ba2350661f66e46c746c1629f0c4b645a2587ff4]
sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target</pre>
</div>
<p>The remote cluster logs <code class="literal">client did not trust this server's certificate</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T12:48:46,584][WARN ][o.e.x.c.s.t.n.SecurityNetty4Transport] [remote-node] <span class="strong strong"><strong>client did not trust this server's certificate</strong></span>, closing connection Netty4TcpChannel{localAddress=/192.168.0.42:9309, remoteAddress=/192.168.0.84:60810, profile=default}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_symptom_2_2"></a>Symptom 2<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>The CA and certificate can be shared between the transport and remote cluster
server interface. Since a remote cluster client does not have a client
certificate by default, the server will fail to verify the client certificate.</p>
<p>The local cluster logs <code class="literal">Received fatal alert: bad_certificate</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T12:43:30,705][WARN ][o.e.t.TcpTransport       ] [local-node] exception caught on transport layer [Netty4TcpChannel{localAddress=/192.168.0.84:60738, remoteAddress=/192.168.0.42:9309, profile=_remote_cluster}], closing connection
io.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: <span class="strong strong"><strong>Received fatal alert: bad_certificate</strong></span></pre>
</div>
<p>The remote cluster logs <code class="literal">Empty client certificate chain</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T12:43:30,772][WARN ][o.e.t.TcpTransport       ] [remote-node] exception caught on transport layer [Netty4TcpChannel{localAddress=/192.168.0.42:9309, remoteAddress=/192.168.0.84:60783, profile=default}], closing connection
io.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: <span class="strong strong"><strong>Empty client certificate chain</strong></span></pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_symptom_3_2"></a>Symptom 3<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>If the remote cluster client is configured for mTLS and provides a valid client
certificate, the connection fails because the client does not send the expected
authentication header.</p>
<p>The local cluster logs <code class="literal">missing authentication</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T13:04:52,710][WARN ][o.e.t.ProxyConnectionStrategy] [local-node] failed to open any proxy connections to cluster [my]
org.elasticsearch.transport.RemoteTransportException: [remote-node][192.168.0.42:9309][cluster:internal/remote_cluster/handshake]
Caused by: org.elasticsearch.ElasticsearchSecurityException: <span class="strong strong"><strong>missing authentication</strong></span> credentials for action [cluster:internal/remote_cluster/handshake]</pre>
</div>
<p>This does not show up in the logs of the remote cluster.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_symptom_4"></a>Symptom 4<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>If anonymous access is enabled on the remote cluster and it does not require
authentication, depending on the privileges of the anonymous user, the local
cluster may log the following.</p>
<p>If the anonymous user does not the have necessary privileges to make a
connection, the local cluster logs <code class="literal">unauthorized</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">org.elasticsearch.transport.RemoteTransportException: [remote-node][192.168.0.42:9309][cluster:internal/remote_cluster/handshake]
Caused by: org.elasticsearch.ElasticsearchSecurityException: action [cluster:internal/remote_cluster/handshake] is <span class="strong strong"><strong>unauthorized</strong></span> for user [anonymous_foo] with effective roles [reporting_user], this action is granted by the cluster privileges [cross_cluster_search,cross_cluster_replication,manage,all]</pre>
</div>
<p>If the anonymous user has necessary privileges, for example it is a superuser,
the local cluster logs <code class="literal">requires channel profile to be [_remote_cluster],
but got [default]</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T13:09:52,031][WARN ][o.e.t.ProxyConnectionStrategy] [local-node] failed to open any proxy connections to cluster [my]
org.elasticsearch.transport.RemoteTransportException: [remote-node][192.168.0.42:9309][cluster:internal/remote_cluster/handshake]
Caused by: java.lang.IllegalArgumentException: remote cluster handshake action <span class="strong strong"><strong>requires channel profile to be [_remote_cluster], but got [default]</strong></span></pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_resolution_4"></a>Resolution<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>Check the port number and ensure you are indeed connecting to the remote cluster
server instead of the transport interface.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="remote-clusters-troubleshooting-no-api-key"></a>Connecting without a cross-cluster API key<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>A local cluster uses the presence of a cross-cluster API key to determine the
model with which it connects to a remote cluster. If a cross-cluster API key is
present, it uses API key based authentication. Otherwise, it uses certificate
based authentication. You can check what model is being used with the <a class="xref" href="cluster-remote-info.html" title="Remote cluster info API">remote cluster info API</a> on the local cluster:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.cluster.remote_info()
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cluster.remote_info
puts response</pre>
</div>
<a id="cc0cca5556ec6224c7134c233734beed"></a>
<div class="pre_wrapper lang-console default has-python has-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby">GET /_remote/info</pre>
</div>
<div class="console_widget has-python has-ruby" data-snippet="snippets/77.console"></div>
<p>The API should return <code class="literal">"connected" : true</code>. When using
<a class="xref" href="remote-clusters-api-key.html" title="Add remote clusters using API key authentication">API key authentication</a>, it should also return
<code class="literal">"cluster_credentials": "::es_redacted::"</code>.</p>
<a id="d185e42af3c4ed91649e255f803cda8c"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "cluster_one" : {
    "seeds" : [
      "127.0.0.1:9443"
    ],
    "connected" : true, <a id="CO30-1"></a><i class="conum" data-value="1"></i>
    "num_nodes_connected" : 1,
    "max_connections_per_cluster" : 3,
    "initial_connect_timeout" : "30s",
    "skip_unavailable" : false,
    "cluster_credentials": "::es_redacted::", <a id="CO30-2"></a><i class="conum" data-value="2"></i>
    "mode" : "sniff"
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO30-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The remote cluster has connected successfully.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO30-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>If present, indicates the remote cluster has connected using
<a class="xref" href="remote-clusters-api-key.html" title="Add remote clusters using API key authentication">API key authentication</a> instead of
<a class="xref" href="remote-clusters-cert.html" title="Add remote clusters using TLS certificate authentication">certificate based authentication</a>.</p>
</td>
</tr>
</table>
</div>
<p>Besides checking the response of the remote cluster info API, you can also check
the logs.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_symptom_1_2"></a>Symptom 1<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>If no cross-cluster API key is used, the local cluster uses the certificate
based authentication method, and connects to the remote cluster using the TLS
configuration of the transport interface. If the remote cluster has different
TLS CA and certificate for transport and remote cluster server interfaces (which
is the recommendation), TLS verification will fail.</p>
<p>The local cluster logs <code class="literal">failed to establish trust with server</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T12:51:06,452][WARN ][o.e.c.s.DiagnosticTrustManager] [local-node] <span class="strong strong"><strong>failed to establish trust with server</strong></span> at [&lt;unknown host&gt;]; the server provided a certificate with subject name [CN=remote_cluster], fingerprint [529de35e15666ffaa26afa50876a2a48119db03a], no keyUsage and no extendedKeyUsage; the certificate is valid between [2023-01-29T12:08:37Z] and [2032-08-29T12:08:37Z] (current time is [2023-06-28T02:51:06.451581Z], certificate dates are valid); the session uses cipher suite [TLS_AES_256_GCM_SHA384] and protocol [TLSv1.3]; the certificate has subject alternative names [DNS:localhost,DNS:localhost6.localdomain6,IP:127.0.0.1,IP:0:0:0:0:0:0:0:1,DNS:localhost4,DNS:localhost6,DNS:localhost.localdomain,DNS:localhost4.localdomain4,IP:192.168.0.42]; the certificate is issued by [CN=Elastic Auto RemoteCluster CA] but the server did not provide a copy of the issuing certificate in the certificate chain; this ssl context ([xpack.security.transport.ssl (with trust configuration: PEM-trust{/rcs2/ssl/transport-ca.crt})]) is not configured to trust that issuer, it only trusts the issuer [CN=Elastic Auto Transport CA] with fingerprint [bbe49e3f986506008a70ab651b188c70df104812]
sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target</pre>
</div>
<p>The remote cluster logs <code class="literal">client did not trust this server's certificate</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T12:52:16,914][WARN ][o.e.x.c.s.t.n.SecurityNetty4Transport] [remote-node] <span class="strong strong"><strong>client did not trust this server's certificate</strong></span>, closing connection Netty4TcpChannel{localAddress=/192.168.0.42:9443, remoteAddress=/192.168.0.84:60981, profile=_remote_cluster}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_symptom_2_3"></a>Symptom 2<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>Even if TLS verification is not an issue, the connection fails due to missing
credentials.</p>
<p>The local cluster logs <code class="literal">Please ensure you have configured remote cluster credentials</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">Caused by: java.lang.IllegalArgumentException: Cross cluster requests through the dedicated remote cluster server port require transport header [_cross_cluster_access_credentials] but none found. <span class="strong strong"><strong>Please ensure you have configured remote cluster credentials</strong></span> on the cluster originating the request.</pre>
</div>
<p>This does not show up in the logs of the remote cluster.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_resolution_5"></a>Resolution<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>Add the cross-cluster API key to Elasticsearch keystore on every node of the local
cluster. Use the <a class="xref" href="cluster-nodes-reload-secure-settings.html" title="Nodes reload secure settings API">Nodes reload secure settings</a> API to reload the keystore.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="remote-clusters-troubleshooting-wrong-api-key-type"></a>Using the wrong API key type<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>API key based authentication requires
<a class="xref" href="security-api-create-cross-cluster-api-key.html" title="Create Cross-Cluster API key API">cross-cluster API keys</a>. It does
not work with <a class="xref" href="security-api-create-api-key.html" title="Create API key API">REST API keys</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_symptom_5"></a>Symptom<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>The local cluster logs <code class="literal">authentication expected API key type of [cross_cluster]</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T13:26:53,962][WARN ][o.e.t.ProxyConnectionStrategy] [local-node] failed to open any proxy connections to cluster [my]
org.elasticsearch.transport.RemoteTransportException: [remote-node][192.168.0.42:9443][cluster:internal/remote_cluster/handshake]
Caused by: org.elasticsearch.ElasticsearchSecurityException: <span class="strong strong"><strong>authentication expected API key type of [cross_cluster]</strong></span>, but API key [agZXJocBmA2beJfq2yKu] has type [rest]</pre>
</div>
<p>This does not show up in the logs of the remote cluster.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_resolution_6"></a>Resolution<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>Ask the remote cluster administrator to create and distribute a
<a class="xref" href="security-api-create-cross-cluster-api-key.html" title="Create Cross-Cluster API key API">cross-cluster API key</a>. Replace the
existing API key in the Elasticsearch keystore with this cross-cluster API key on every
node of the local cluster. Use the <a class="xref" href="cluster-nodes-reload-secure-settings.html" title="Nodes reload secure settings API">Nodes reload secure settings</a> API to reload the keystore.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="remote-clusters-troubleshooting-non-valid-api-key"></a>Invalid API key<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>A cross-cluster API can fail to authenticate. For example, when its credentials
are incorrect, or if it&#8217;s invalidated or expired.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_symptom_6"></a>Symptom<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>The local cluster logs <code class="literal">unable to authenticate</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T13:22:58,264][WARN ][o.e.t.ProxyConnectionStrategy] [local-node] failed to open any proxy connections to cluster [my]
org.elasticsearch.transport.RemoteTransportException: [remote-node][192.168.0.42:9443][cluster:internal/remote_cluster/handshake]
Caused by: org.elasticsearch.ElasticsearchSecurityException: <span class="strong strong"><strong>unable to authenticate</strong></span> user [agZXJocBmA2beJfq2yKu] for action [cluster:internal/remote_cluster/handshake]</pre>
</div>
<p>The remote cluster logs <code class="literal">Authentication using apikey failed</code>:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">[2023-06-28T13:24:38,744][WARN ][o.e.x.s.a.ApiKeyAuthenticator] [remote-node] <span class="strong strong"><strong>Authentication using apikey failed</strong></span> - invalid credentials for API key [agZXJocBmA2beJfq2yKu]</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_resolution_7"></a>Resolution<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>Ask the remote cluster administrator to create and distribute a
<a class="xref" href="security-api-create-cross-cluster-api-key.html" title="Create Cross-Cluster API key API">cross-cluster API key</a>. Replace the
existing API key in the Elasticsearch keystore with this cross-cluster API key on every
node of the local cluster. Use the <a class="xref" href="cluster-nodes-reload-secure-settings.html" title="Nodes reload secure settings API">Nodes reload secure settings</a> API to reload the keystore.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="remote-clusters-troubleshooting-insufficient-privileges"></a>API key or local user has insufficient privileges<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>The effective permission for a local user running requests on a remote cluster
is determined by the intersection of the cross-cluster API key&#8217;s privileges and
the local user&#8217;s <code class="literal">remote_indices</code> privileges.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_symptom_7"></a>Symptom<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>Request failures due to insufficient privileges result in API responses like:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">{
    "type": "security_exception",
    "reason": "action [indices:data/read/search] towards remote cluster is <span class="strong strong"><strong>unauthorized for user</strong></span> [foo] with assigned roles [foo-role] authenticated by API key id [agZXJocBmA2beJfq2yKu] of user [elastic-admin] on indices [cd], this action is granted by the index privileges [read,all]"
}</pre>
</div>
<p>This does not show up in any logs.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_resolution_8"></a>Resolution<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Check that the local user has the necessary <code class="literal">remote_indices</code> privileges. Grant sufficient <code class="literal">remote_indices</code> privileges if necessary.
</li>
<li class="listitem">
If permission is not an issue locally, ask the remote cluster administrator to
create and distribute a
<a class="xref" href="security-api-create-cross-cluster-api-key.html" title="Create Cross-Cluster API key API">cross-cluster API key</a>. Replace the
existing API key in the Elasticsearch keystore with this cross-cluster API key on every
node of the local cluster. Use the <a class="xref" href="cluster-nodes-reload-secure-settings.html" title="Nodes reload secure settings API">Nodes reload secure settings</a> API to reload the keystore.
</li>
</ol>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="remote-clusters-troubleshooting-no-remote_indices-privileges"></a>Local user has no <code class="literal">remote_indices</code> privileges<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>This is a special case of insufficient privileges. In this case, the local user
has no <code class="literal">remote_indices</code> privileges at all for the target remote cluster. Elasticsearch
can detect that and issue a more explicit error response.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_symptom_8"></a>Symptom<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>This results in API responses like:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">{
    "type": "security_exception",
    "reason": "action [indices:data/read/search] towards remote cluster [my] is unauthorized for user [foo] with effective roles [] (assigned roles [foo-role] were not found) because <span class="strong strong"><strong>no remote indices privileges apply for the target cluster</strong></span>"
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_resolution_9"></a>Resolution<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/modules/cluster/remote-clusters-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>Grant sufficient <code class="literal">remote_indices</code> privileges to the local user.</p>
</div>

</div>

</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="remote-clusters-settings.html">« Remote cluster settings</a>
</span>
<span class="next">
<a href="modules-plugins.html">Plugins »</a>
</span>
</div>
</div>
</body>
</html>
