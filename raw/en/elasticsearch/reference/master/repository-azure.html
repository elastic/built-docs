<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Azure repository | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Azure repository | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="snapshots-register-repository.html" title="Register a snapshot repository"/>
<link rel="prev" href="snapshots-register-repository.html" title="Register a snapshot repository"/>
<link rel="next" href="repository-gcs.html" title="Google Cloud Storage repository"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="snapshots-register-repository.html">« Register a snapshot repository</a>
</span>
<span class="next">
<a href="repository-gcs.html">Google Cloud Storage repository »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="snapshot-restore.html">Snapshot and restore</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="snapshots-register-repository.html">Register a snapshot repository</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Azure repository</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-azure.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="repository-azure"></a>Azure repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-azure.asciidoc">edit</a></h2>
</div></div></div>
<p>You can use
<a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction" class="ulink" target="_top">Azure
Blob storage</a> as a repository for <a class="xref" href="snapshot-restore.html" title="Snapshot and restore">Snapshot and restore</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-azure-usage"></a>Setup<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-azure.asciidoc">edit</a></h3>
</div></div></div>
<p>To enable Azure repositories, first configure an Azure repository client by
specifying one or more settings of the form
<code class="literal">azure.client.CLIENT_NAME.SETTING_NAME</code>. By default, <code class="literal">azure</code> repositories use a
client named <code class="literal">default</code>, but you may specify a different client name when
registering each repository.</p>
<p>The only mandatory Azure repository client setting is <code class="literal">account</code>, which is a
<a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">secure setting</a> defined in the <a class="xref" href="secure-settings.html" title="Secure settings">Elasticsearch
keystore</a>. To provide this setting, use the <code class="literal">elasticsearch-keystore</code> tool on
each node:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-keystore add azure.client.default.account</pre>
</div>
<p>If you adjust this setting after a node has started, call the
<a class="xref" href="cluster-nodes-reload-secure-settings.html" title="Nodes reload secure settings API">Nodes reload secure settings API</a> to
reload the new value.</p>
<p>You may define more than one client by setting their <code class="literal">account</code> values. For
instance, to set the <code class="literal">default</code> client and another client called <code class="literal">secondary</code>, run
the following commands on each node:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-keystore add azure.client.default.account
bin/elasticsearch-keystore add azure.client.secondary.account</pre>
</div>
<p>The <code class="literal">key</code> and <code class="literal">sas_token</code> settings are also secure settings and can be set using
commands like the following:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-keystore add azure.client.default.key
bin/elasticsearch-keystore add azure.client.secondary.sas_token</pre>
</div>
<p>Other Azure repository client settings must be set in <code class="literal">elasticsearch.yml</code> before
the node starts. For example:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">azure.client.default.timeout: 10s
azure.client.default.max_retries: 7
azure.client.default.endpoint_suffix: core.chinacloudapi.cn
azure.client.secondary.timeout: 30s</pre>
</div>
<p>In this example, the client side timeout is <code class="literal">10s</code> per try for repositories which
use the <code class="literal">default</code> client, with <code class="literal">7</code> retries before failing and an endpoint
suffix of <code class="literal">core.chinacloudapi.cn</code>. Repositories which use the <code class="literal">secondary</code> client
will have a timeout of <code class="literal">30s</code> per try, but will use the default endpoint and will
fail after the default number of retries.</p>
<p>Once an Azure repository client is configured correctly, register an Azure
repository as follows, providing the client name using the <code class="literal">client</code>
<a class="xref" href="repository-azure.html#repository-azure-repository-settings" title="Repository settings">repository setting</a>:</p>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.snapshot.createRepository({
  name: "my_backup",
  repository: {
    type: "azure",
    settings: {
      client: "secondary",
    },
  },
});
console.log(response);</pre>
</div>
<a id="9de4704d2f047dae1259249112488697"></a>
<div class="pre_wrapper lang-console default has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-js">PUT _snapshot/my_backup
{
  "type": "azure",
  "settings": {
    "client": "secondary"
  }
}</pre>
</div>
<div class="console_widget has-js" data-snippet="snippets/1934.console"></div>
<p>If you are using the <code class="literal">default</code> client, you may omit the <code class="literal">client</code> repository
setting:</p>
<a id="d27591881da6f5767523b1beb233adc7"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_backup
{
  "type": "azure"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1935.console"></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In progress snapshot or restore jobs will not be preempted by a <span class="strong strong"><strong>reload</strong></span>
of the storage secure settings. They will complete using the client as it was
built when the operation started.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-azure-client-settings"></a>Client settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-azure.asciidoc">edit</a></h3>
</div></div></div>
<p>The following list describes the available client settings. Those that must be
stored in the keystore are marked as (<a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">Secure</a>,
<a href="/guide/en/elasticsearch/reference/master/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>); the other
settings must be stored in the <code class="literal">elasticsearch.yml</code> file. The default
<code class="literal">CLIENT_NAME</code> is <code class="literal">default</code> but you may configure a client with a different name
and specify that client by name when registering a repository.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">azure.client.CLIENT_NAME.account</code> (<a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="/guide/en/elasticsearch/reference/master/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
The Azure account name, which is used by the repository&#8217;s internal Azure
client. This setting is required for all clients.
</dd>
<dt>
<span class="term">
<code class="literal">azure.client.CLIENT_NAME.endpoint_suffix</code>
</span>
</dt>
<dd>
The Azure endpoint suffix to connect to. The default value is
<code class="literal">core.windows.net</code>.
</dd>
<dt>
<span class="term">
<code class="literal">azure.client.CLIENT_NAME.key</code> (<a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="/guide/en/elasticsearch/reference/master/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
The Azure secret key, which is used by the repository&#8217;s internal Azure client.
Alternatively, use <code class="literal">sas_token</code>.
</dd>
<dt>
<span class="term">
<code class="literal">azure.client.CLIENT_NAME.max_retries</code>
</span>
</dt>
<dd>
The number of retries to use when an Azure request fails. This setting helps
control the exponential backoff policy. It specifies the number of retries
that must occur before the snapshot fails. The default value is <code class="literal">3</code>. The
initial backoff period is defined by Azure SDK as <code class="literal">30s</code>. Thus there is <code class="literal">30s</code>
of wait time before retrying after a first timeout or failure. The maximum
backoff period is defined by Azure SDK as <code class="literal">90s</code>.
</dd>
<dt>
<span class="term">
<code class="literal">azure.client.CLIENT_NAME.proxy.host</code>
</span>
</dt>
<dd>
The host name of a proxy to connect to Azure through. By default, no proxy is
used.
</dd>
<dt>
<span class="term">
<code class="literal">azure.client.CLIENT_NAME.proxy.port</code>
</span>
</dt>
<dd>
The port of a proxy to connect to Azure through. By default, no proxy is used.
</dd>
<dt>
<span class="term">
<code class="literal">azure.client.CLIENT_NAME.proxy.type</code>
</span>
</dt>
<dd>
Register a proxy type for the client. Supported values are <code class="literal">direct</code>, <code class="literal">http</code>,
and <code class="literal">socks</code>. For example: <code class="literal">azure.client.default.proxy.type: http</code>. When
<code class="literal">proxy.type</code> is set to <code class="literal">http</code> or <code class="literal">socks</code>, <code class="literal">proxy.host</code> and <code class="literal">proxy.port</code> must
also be provided. The default value is <code class="literal">direct</code>.
</dd>
<dt>
<span class="term">
<code class="literal">azure.client.CLIENT_NAME.sas_token</code> (<a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="/guide/en/elasticsearch/reference/master/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
A shared access signatures (SAS) token, which the repository&#8217;s internal Azure
client uses for authentication. The SAS token must have read (r), write (w),
list (l), and delete (d) permissions for the repository base path and all its
contents. These permissions must be granted for the blob service (b) and apply
to resource types service (s), container (c), and object (o). Alternatively,
use <code class="literal">key</code>.
</dd>
<dt>
<span class="term">
<code class="literal">azure.client.CLIENT_NAME.timeout</code>
</span>
</dt>
<dd>
The client side timeout for any single request to Azure, as a
<a class="xref" href="api-conventions.html#time-units" title="Time units">time unit</a>. For example, a value of <code class="literal">5s</code> specifies a 5 second
timeout. There is no default value, which means that Elasticsearch uses the
<a href="https://azure.github.io/azure-storage-java/com/microsoft/azure/storage/RequestOptions.html#setTimeoutIntervalInMs(java.lang.Integer)" class="ulink" target="_top">default
value</a> set by the Azure client.
</dd>
<dt>
<span class="term">
<code class="literal">azure.client.CLIENT_NAME.endpoint</code>
</span>
</dt>
<dd>
The Azure endpoint to connect to. It must include the protocol used to connect
to Azure.
</dd>
<dt>
<span class="term">
<code class="literal">azure.client.CLIENT_NAME.secondary_endpoint</code>
</span>
</dt>
<dd>
The Azure secondary endpoint to connect to. It must include the protocol used
to connect to Azure.
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<h3>Obtaining credentials from the environment<a id="repository-azure-default-credentials"></a></h3>
<p>If you specify neither the <code class="literal">key</code> nor the <code class="literal">sas_token</code> settings for a client then
Elasticsearch will attempt to automatically obtain credentials from the environment in
which it is running using mechanisms built into the Azure SDK. This is ideal
for when running Elasticsearch on the Azure platform.</p>
<p>When running Elasticsearch on an
<a href="https://azure.microsoft.com/en-gb/products/virtual-machines" class="ulink" target="_top">Azure Virtual
Machine</a>, you should use
<a href="https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/overview" class="ulink" target="_top">Azure
Managed Identity</a> to provide credentials to Elasticsearch. To use Azure Managed Identity,
assign a suitably authorized identity to the Azure Virtual Machine on which Elasticsearch
is running.</p>
<p>When running Elasticsearch in
<a href="https://azure.microsoft.com/en-gb/products/kubernetes-service" class="ulink" target="_top">Azure Kubernetes
Service</a>, for instance using <a href="/guide/en/cloud-on-k8s/current" class="ulink" target="_top">Elastic Cloud on Kubernetes</a>, you should use
<a href="https://azure.github.io/azure-workload-identity/docs/introduction.html" class="ulink" target="_top">Azure
Workload Identity</a> to provide credentials to Elasticsearch. To use Azure Workload
Identity, mount the <code class="literal">azure-identity-token</code> volume as a subdirectory of the
<a class="xref" href="settings.html#config-files-location" title="Config files location">Elasticsearch config directory</a> and set the
<code class="literal">AZURE_FEDERATED_TOKEN_FILE</code> environment variable to point to a file called
<code class="literal">azure-identity-token</code> within the mounted volume.</p>
<p>The Azure SDK has several other mechanisms to automatically obtain credentials
from its environment, but the two methods described above are the only ones
that are tested and supported for use in Elasticsearch.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-azure-repository-settings"></a>Repository settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-azure.asciidoc">edit</a></h3>
</div></div></div>
<p>The Azure repository supports the following settings, which may be specified
when registering an Azure repository as follows:</p>
<a id="aebf9cc593fcf0d4ca08f8b61b67bf17"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_backup
{
  "type": "azure",
  "settings": {
    "client": "secondary",
    "container": "my_container",
    "base_path": "snapshots_prefix"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1936.console"></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">client</code>
</span>
</dt>
<dd>
The name of the Azure repository client to use. Defaults to <code class="literal">default</code>.
</dd>
<dt>
<span class="term">
<code class="literal">container</code>
</span>
</dt>
<dd>
Container name. You must create the azure container before creating the repository.
Defaults to <code class="literal">elasticsearch-snapshots</code>.
</dd>
<dt>
<span class="term">
<code class="literal">base_path</code>
</span>
</dt>
<dd>
<p>
Specifies the path within container to repository data. Defaults to empty
(root directory).
</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Don&#8217;t set <code class="literal">base_path</code> when configuring a snapshot repository for Elastic Cloud Enterprise.
Elastic Cloud Enterprise automatically generates the <code class="literal">base_path</code> for each deployment so that
multiple deployments may share the same bucket.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">chunk_size</code>
</span>
</dt>
<dd>
Big files can be broken down into multiple smaller blobs in the blob store
during snapshotting. It is not recommended to change this value from its
default unless there is an explicit reason for limiting the size of blobs in
the repository. Setting a value lower than the default can result in an
increased number of API calls to the Azure blob store during snapshot create
as well as restore operations compared to using the default value and thus
make both operations slower as well as more costly. Specify the chunk size
as a <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte unit</a>, for example: <code class="literal">10MB</code>, <code class="literal">5KB</code>, <code class="literal">500B</code>. Defaults
to the maximum size of a blob in the Azure blob store which is <code class="literal">5TB</code>.
</dd>
<dt>
<span class="term">
<code class="literal">compress</code>
</span>
</dt>
<dd>
When set to <code class="literal">true</code> metadata files are stored in compressed format. This
setting doesn&#8217;t affect index files that are already compressed by default.
Defaults to <code class="literal">true</code>.
</dd>
<dt>
<span class="term">
<code class="literal">max_restore_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot restore rate per node. Defaults to unlimited. Note
that restores are also throttled through <a class="xref" href="recovery.html" title="Index recovery settings">recovery settings</a>.
</dd>
<dt>
<span class="term">
<code class="literal">max_snapshot_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot creation rate per node. Defaults to <code class="literal">40mb</code> per second.
Note that if the <a class="xref" href="recovery.html#recovery-settings-for-managed-services" title="Recovery settings for managed services">recovery settings for managed services</a>
are set, then it defaults to unlimited, and the rate is additionally
throttled through <a class="xref" href="recovery.html" title="Index recovery settings">recovery settings</a>.
</dd>
</dl>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">readonly</code>
</span>
</dt>
<dd>
<p>
(Optional, Boolean)
If <code class="literal">true</code>, the repository is read-only. The cluster can retrieve and restore
snapshots from the repository but not write to the repository or create
snapshots in it.
</p>
<p>Only a cluster with write access can create snapshots in the repository. All
other clusters connected to the repository should have the <code class="literal">readonly</code> parameter
set to <code class="literal">true</code>.</p>
<p>If <code class="literal">false</code>, the cluster can write to the repository and create snapshots in it.
Defaults to <code class="literal">false</code>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you register the same snapshot repository with multiple clusters, only
one cluster should have write access to the repository. Having multiple clusters
write to the repository at the same time risks corrupting the contents of the
repository.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">location_mode</code>
</span>
</dt>
<dd>
<code class="literal">primary_only</code> or <code class="literal">secondary_only</code>. Defaults to <code class="literal">primary_only</code>. Note that if you set it
to <code class="literal">secondary_only</code>, it will force <code class="literal">readonly</code> to true.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-azure-validation"></a>Repository validation rules<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-azure.asciidoc">edit</a></h3>
</div></div></div>
<p>According to the
<a href="https://docs.microsoft.com/en-us/rest/api/storageservices/Naming-and-Referencing-Containers&#8212;&#8203;Blobs&#8212;&#8203;and-Metadata" class="ulink" target="_top">containers
naming guide</a>, a container name must be a valid DNS name, conforming to the
following naming rules:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Container names must start with a letter or number, and can contain only letters, numbers, and the dash (-) character.
</li>
<li class="listitem">
Every dash (-) character must be immediately preceded and followed by a letter or number; consecutive dashes are not
permitted in container names.
</li>
<li class="listitem">
All letters in a container name must be lowercase.
</li>
<li class="listitem">
Container names must be from 3 through 63 characters long.
</li>
</ul>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<h3>Supported Azure Storage Account types</h3>
<p>The Azure repository type works with all Standard storage accounts</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Standard Locally Redundant Storage - <code class="literal">Standard_LRS</code>
</li>
<li class="listitem">
Standard Zone-Redundant Storage - <code class="literal">Standard_ZRS</code>
</li>
<li class="listitem">
Standard Geo-Redundant Storage - <code class="literal">Standard_GRS</code>
</li>
<li class="listitem">
Standard Read Access Geo-Redundant Storage - <code class="literal">Standard_RAGRS</code>
</li>
</ul>
</div>
<p><a href="https://azure.microsoft.com/en-gb/documentation/articles/storage-premium-storage" class="ulink" target="_top">Premium Locally Redundant Storage</a> (<code class="literal">Premium_LRS</code>) is <span class="strong strong"><strong>not supported</strong></span> as it is only usable as VM disk storage, not as general storage.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-azure-linearizable-registers"></a>Linearizable register implementation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-azure.asciidoc">edit</a></h3>
</div></div></div>
<p>The linearizable register implementation for Azure repositories is based on
Azure&#8217;s support for strongly consistent leases. Each lease may only be held by
a single node at any time. The node presents its lease when performing a read
or write operation on a protected blob. Lease-protected operations fail if the
lease is invalid or expired. To perform a compare-and-exchange operation on a
register, Elasticsearch first obtains a lease on the blob, then reads the blob contents
under the lease, and finally uploads the updated blob under the same lease.
This process ensures that the read and write operations happen atomically.</p>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="snapshots-register-repository.html">« Register a snapshot repository</a>
</span>
<span class="next">
<a href="repository-gcs.html">Google Cloud Storage repository »</a>
</span>
</div>
</body>
</html>
