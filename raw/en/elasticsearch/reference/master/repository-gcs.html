<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Google Cloud Storage repository | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Google Cloud Storage repository | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="snapshots-register-repository.html" title="Register a snapshot repository"/>
<link rel="prev" href="repository-azure.html" title="Azure repository"/>
<link rel="next" href="repository-s3.html" title="S3 repository"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="repository-azure.html">« Azure repository</a>
</span>
<span class="next">
<a href="repository-s3.html">S3 repository »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="snapshot-restore.html">Snapshot and restore</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="snapshots-register-repository.html">Register a snapshot repository</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Google Cloud Storage repository</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="repository-gcs"></a>Google Cloud Storage repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h2>
</div></div></div>
<p>You can use the <a href="https://cloud.google.com/storage/" class="ulink" target="_top">Google Cloud Storage</a>
service as a repository for <a href="/guide/en/elasticsearch/reference/master/snapshot-restore.html" class="ulink" target="_top">Snapshot/Restore</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-gcs-usage"></a>Getting started<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h3>
</div></div></div>
<p>This repository type uses the <a href="https://github.com/GoogleCloudPlatform/google-cloud-java/tree/master/google-cloud-clients/google-cloud-storage" class="ulink" target="_top">Google Cloud Java Client for Storage</a>
to connect to the Storage service. If you are using
<a href="https://cloud.google.com/storage/" class="ulink" target="_top">Google Cloud Storage</a> for the first time, you
must connect to the <a href="https://console.cloud.google.com/" class="ulink" target="_top">Google Cloud Platform Console</a>
and create a new project. After your project is created, you must enable the
Cloud Storage Service for your project.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="repository-gcs-creating-bucket"></a>Creating a bucket<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h4>
</div></div></div>
<p>The Google Cloud Storage service uses the concept of a
<a href="https://cloud.google.com/storage/docs/key-terms" class="ulink" target="_top">bucket</a> as a container for all
the data. Buckets are usually created using the
<a href="https://console.cloud.google.com/" class="ulink" target="_top">Google Cloud Platform Console</a>. This
repository type does not automatically create buckets.</p>
<p>To create a new bucket:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Connect to the <a href="https://console.cloud.google.com/" class="ulink" target="_top">Google Cloud Platform Console</a>.
</li>
<li class="listitem">
Select your project.
</li>
<li class="listitem">
Go to the <a href="https://console.cloud.google.com/storage/browser" class="ulink" target="_top">Storage Browser</a>.
</li>
<li class="listitem">
Click the <span class="strong strong"><strong>Create Bucket</strong></span> button.
</li>
<li class="listitem">
Enter the name of the new bucket.
</li>
<li class="listitem">
Select a storage class.
</li>
<li class="listitem">
Select a location.
</li>
<li class="listitem">
Click the <span class="strong strong"><strong>Create</strong></span> button.
</li>
</ol>
</div>
<p>For more detailed instructions, see the
<a href="https://cloud.google.com/storage/docs/quickstart-console#create_a_bucket" class="ulink" target="_top">Google Cloud documentation</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="repository-gcs-service-authentication"></a>Service authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h4>
</div></div></div>
<p>The repository must authenticate the requests it makes to the Google Cloud Storage
service. It is common for Google client libraries to employ a strategy named <a href="https://cloud.google.com/docs/authentication/production#providing_credentials_to_your_application" class="ulink" target="_top">application default credentials</a>.
However, that strategy is only <span class="strong strong"><strong>partially supported</strong></span> by Elasticsearch. The
repository operates under the Elasticsearch process, which runs with the security
manager enabled. The security manager obstructs the "automatic" credential discovery
when the environment variable <code class="literal">GOOGLE_APPLICATION_CREDENTIALS</code> is used to point to a
local file on disk. It can, however, retrieve the service account that is attached to
the resource that is running Elasticsearch, or fall back to the default service
account that Compute Engine, Kubernetes Engine or App Engine provide.
Alternatively, you must configure <a class="xref" href="repository-gcs.html#repository-gcs-using-service-account" title="Using a service account">service account</a>
credentials if you are using an environment that does not support automatic
credential discovery.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="repository-gcs-using-service-account"></a>Using a service account<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h4>
</div></div></div>
<p>You have to obtain and provide <a href="https://cloud.google.com/iam/docs/overview#service_account" class="ulink" target="_top">service account credentials</a>
manually.</p>
<p>For detailed information about generating JSON service account files, see the <a href="https://cloud.google.com/storage/docs/authentication?hl=en#service_accounts" class="ulink" target="_top">Google Cloud documentation</a>.
Note that the PKCS12 format is not supported by this repository type.</p>
<p>Here is a summary of the steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Connect to the <a href="https://console.cloud.google.com/" class="ulink" target="_top">Google Cloud Platform Console</a>.
</li>
<li class="listitem">
Select your project.
</li>
<li class="listitem">
Select the <a href="https://console.cloud.google.com/iam-admin/serviceaccounts" class="ulink" target="_top">Service Accounts</a> tab.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create service account</strong></span>.
</li>
<li class="listitem">
After the account is created, select it and go to <span class="strong strong"><strong>Keys</strong></span>.
</li>
<li class="listitem">
Select <span class="strong strong"><strong>Add Key</strong></span> and then <span class="strong strong"><strong>Create new key</strong></span>.
</li>
<li class="listitem">
Select Key Type <span class="strong strong"><strong>JSON</strong></span> as P12 is unsupported.
</li>
</ol>
</div>
<p>A JSON service account file looks like this:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">{
  "type": "service_account",
  "project_id": "your-project-id",
  "private_key_id": "...",
  "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
  "client_email": "service-account-for-your-repository@your-project-id.iam.gserviceaccount.com",
  "client_id": "...",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://accounts.google.com/o/oauth2/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/your-bucket@your-project-id.iam.gserviceaccount.com"
}</pre>
</div>
<p>To provide this file to the repository, it must be stored in the <a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">Elasticsearch keystore</a>. You must
add a <code class="literal">file</code> setting with the name <code class="literal">gcs.client.NAME.credentials_file</code> using the <code class="literal">add-file</code> subcommand.
 <code class="literal">NAME</code> is the name of the client configuration for the repository. The implicit client
name is <code class="literal">default</code>, but a different client name can be specified in the
repository settings with the <code class="literal">client</code> key.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Passing the file path via the GOOGLE_APPLICATION_CREDENTIALS environment
variable is <span class="strong strong"><strong>not</strong></span> supported.</p>
</div>
</div>
<p>For example, if you added a <code class="literal">gcs.client.my_alternate_client.credentials_file</code>
setting in the keystore, you can configure a repository to use those credentials
like this:</p>
<a id="ed01b542bb56b1521ea8d5a3c67aa891"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_gcs_repository
{
  "type": "gcs",
  "settings": {
    "bucket": "my_bucket",
    "client": "my_alternate_client"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1925.console"></div>
<p>The <code class="literal">credentials_file</code> settings are <a href="/guide/en/elasticsearch/reference/master/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>.
You can define these settings before the node is started,
or call the <a class="xref" href="cluster-nodes-reload-secure-settings.html" title="Nodes reload secure settings API">Nodes reload secure settings API</a>
after the settings are defined to apply them to a running node.</p>
<p>After you reload the settings, the internal <code class="literal">gcs</code> clients, which are used to
transfer the snapshot contents, utilize the latest settings from the keystore.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Snapshot or restore jobs that are in progress are not preempted by a <span class="strong strong"><strong>reload</strong></span>
of the client&#8217;s <code class="literal">credentials_file</code> settings. They complete using the client as
it was built when the operation started.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-gcs-client"></a>Client settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h3>
</div></div></div>
<p>The client used to connect to Google Cloud Storage has a number of settings available.
Client setting names are of the form <code class="literal">gcs.client.CLIENT_NAME.SETTING_NAME</code> and are specified
inside <code class="literal">elasticsearch.yml</code>. The default client name looked up by a <code class="literal">gcs</code> repository is
called <code class="literal">default</code>, but can be customized with the repository setting <code class="literal">client</code>.</p>
<p>For example:</p>
<a id="ed01b542bb56b1521ea8d5a3c67aa891"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_gcs_repository
{
  "type": "gcs",
  "settings": {
    "bucket": "my_bucket",
    "client": "my_alternate_client"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1926.console"></div>
<p>Some settings are sensitive and must be stored in the
<a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">Elasticsearch keystore</a>. This is the case for the service account file:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-keystore add-file gcs.client.default.credentials_file /path/service-account.json</pre>
</div>
<p>The following are the available client settings. Those that must be stored in the keystore
are marked as <code class="literal">Secure</code>.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">credentials_file</code> (<a href="/guide/en/elasticsearch/reference/master/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="/guide/en/elasticsearch/reference/master/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
The service account file that is used to authenticate to the Google Cloud Storage service.
</dd>
<dt>
<span class="term">
<code class="literal">endpoint</code>
</span>
</dt>
<dd>
The Google Cloud Storage service endpoint to connect to. This will be automatically
determined by the Google Cloud Storage client but can be specified explicitly.
</dd>
<dt>
<span class="term">
<code class="literal">connect_timeout</code>
</span>
</dt>
<dd>
The timeout to establish a connection to the Google Cloud Storage service. The value should
specify the unit. For example, a value of <code class="literal">5s</code> specifies a 5 second timeout. The value of <code class="literal">-1</code>
corresponds to an infinite timeout. The default value is 20 seconds.
</dd>
<dt>
<span class="term">
<code class="literal">read_timeout</code>
</span>
</dt>
<dd>
The timeout to read data from an established connection. The value should
specify the unit. For example, a value of <code class="literal">5s</code> specifies a 5 second timeout. The value of <code class="literal">-1</code>
corresponds to an infinite timeout. The default value is 20 seconds.
</dd>
<dt>
<span class="term">
<code class="literal">application_name</code>
</span>
</dt>
<dd>
Name used by the client when it uses the Google Cloud Storage service. Setting
a custom name can be useful to authenticate your cluster when requests
statistics are logged in the Google Cloud Platform. Default to <code class="literal">repository-gcs</code>
</dd>
<dt>
<span class="term">
<code class="literal">project_id</code>
</span>
</dt>
<dd>
The Google Cloud project id. This will be automatically inferred from the credentials file but
can be specified explicitly. For example, it can be used to switch between projects when the
same credentials are usable for both the production and the development projects.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.host</code>
</span>
</dt>
<dd>
Host name of a proxy to connect to the Google Cloud Storage through.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.port</code>
</span>
</dt>
<dd>
Port of a proxy to connect to the Google Cloud Storage through.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.type</code>
</span>
</dt>
<dd>
Proxy type for the client. Supported values are <code class="literal">direct</code> (no proxy),
<code class="literal">http</code>, and <code class="literal">socks</code>. Defaults to <code class="literal">direct</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-gcs-repository"></a>Repository settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">gcs</code> repository type supports a number of settings to customize how data
is stored in Google Cloud Storage.</p>
<p>These can be specified when creating the repository. For example:</p>
<a id="262196e4323dfc1f8e6daf77d7ba3b6a"></a>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_gcs_repository
{
  "type": "gcs",
  "settings": {
    "bucket": "my_other_bucket",
    "base_path": "dev"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1927.console"></div>
<p>The following settings are supported:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">bucket</code>
</span>
</dt>
<dd>
The name of the bucket to be used for snapshots. (Mandatory)
</dd>
<dt>
<span class="term">
<code class="literal">client</code>
</span>
</dt>
<dd>
The name of the client to use to connect to Google Cloud Storage.
Defaults to <code class="literal">default</code>.
</dd>
<dt>
<span class="term">
<code class="literal">base_path</code>
</span>
</dt>
<dd>
<p>
Specifies the path within bucket to repository data. Defaults to
the root of the bucket.
</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Don&#8217;t set <code class="literal">base_path</code> when configuring a snapshot repository for Elastic Cloud Enterprise.
Elastic Cloud Enterprise automatically generates the <code class="literal">base_path</code> for each deployment so that
multiple deployments may share the same bucket.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">chunk_size</code>
</span>
</dt>
<dd>
Big files can be broken down into multiple smaller blobs in the blob store during snapshotting.
It is not recommended to change this value from its default unless there is an explicit reason for limiting the
size of blobs in the repository. Setting a value lower than the default can result in an increased number of API
calls to the Google Cloud Storage Service during snapshot create as well as restore operations compared to using
the default value and thus make both operations slower as well as more costly.
Specify the chunk size as a value and unit, for example:
<code class="literal">10MB</code>, <code class="literal">5KB</code>, <code class="literal">500B</code>. Defaults to the maximum size of a blob in the Google Cloud Storage Service which is <code class="literal">5TB</code>.
</dd>
<dt>
<span class="term">
<code class="literal">compress</code>
</span>
</dt>
<dd>
When set to <code class="literal">true</code> metadata files are stored in compressed format. This
setting doesn&#8217;t affect index files that are already compressed by default.
Defaults to <code class="literal">true</code>.
</dd>
<dt>
<span class="term">
<code class="literal">max_restore_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot restore rate per node. Defaults to unlimited. Note
that restores are also throttled through <a class="xref" href="recovery.html" title="Index recovery settings">recovery settings</a>.
</dd>
<dt>
<span class="term">
<code class="literal">max_snapshot_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot creation rate per node. Defaults to <code class="literal">40mb</code> per second.
Note that if the <a class="xref" href="recovery.html#recovery-settings-for-managed-services" title="Recovery settings for managed services">recovery settings for managed services</a>
are set, then it defaults to unlimited, and the rate is additionally
throttled through <a class="xref" href="recovery.html" title="Index recovery settings">recovery settings</a>.
</dd>
</dl>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">readonly</code>
</span>
</dt>
<dd>
<p>
(Optional, Boolean)
If <code class="literal">true</code>, the repository is read-only. The cluster can retrieve and restore
snapshots from the repository but not write to the repository or create
snapshots in it.
</p>
<p>Only a cluster with write access can create snapshots in the repository. All
other clusters connected to the repository should have the <code class="literal">readonly</code> parameter
set to <code class="literal">true</code>.</p>
<p>If <code class="literal">false</code>, the cluster can write to the repository and create snapshots in it.
Defaults to <code class="literal">false</code>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you register the same snapshot repository with multiple clusters, only
one cluster should have write access to the repository. Having multiple clusters
write to the repository at the same time risks corrupting the contents of the
repository.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">application_name</code>
</span>
</dt>
<dd>
<span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono u-strikethrough">6.3.0</span>]
<span class="Admonishment-detail">
Deprecated in 6.3.0. This setting is now defined in the <a class="xref" href="repository-gcs.html#repository-gcs-client" title="Client settings">client settings</a>.
</span>
</span>
Name used by the client when it uses the Google Cloud Storage service.
</dd>
</dl>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="repository-gcs-bucket-permission"></a>Recommended bucket permission<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h4>
</div></div></div>
<p>The service account used to access the bucket must have the "Writer" access to the bucket:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Connect to the <a href="https://console.cloud.google.com/" class="ulink" target="_top">Google Cloud Platform Console</a>.
</li>
<li class="listitem">
Select your project.
</li>
<li class="listitem">
Go to the <a href="https://console.cloud.google.com/storage/browser" class="ulink" target="_top">Storage Browser</a>.
</li>
<li class="listitem">
Select the bucket and "Edit bucket permission".
</li>
<li class="listitem">
The service account must be configured as a "User" with "Writer" access.
</li>
</ol>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-gcs-linearizable-registers"></a>Linearizable register implementation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h3>
</div></div></div>
<p>The linearizable register implementation for GCS repositories is based on GCS&#8217;s
support for strongly consistent preconditions on put-blob operations. To
perform a compare-and-exchange operation on a register, Elasticsearch retrieves the
register blob and its current generation, and then uploads the updated blob
using the observed generation as its precondition. The precondition ensures
that the generation has not changed in the meantime.</p>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="repository-azure.html">« Azure repository</a>
</span>
<span class="next">
<a href="repository-s3.html">S3 repository »</a>
</span>
</div>
</body>
</html>
