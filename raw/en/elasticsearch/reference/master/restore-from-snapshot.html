<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="keywords" content="hot-spotting, hotspot, hot-spot, hot spot, hotspots, hotspotting">
<title>Restore from snapshot | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Restore from snapshot | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="troubleshooting.html" title="Troubleshooting"/>
<link rel="prev" href="start-slm.html" title="Start Snapshot Lifecycle Management"/>
<link rel="next" href="add-repository.html" title="Troubleshooting broken repositories"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="start-slm.html">« Start Snapshot Lifecycle Management</a>
</span>
<span class="next">
<a href="add-repository.html">Troubleshooting broken repositories »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="troubleshooting.html">Troubleshooting</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Restore from snapshot</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/troubleshooting/data/restore-from-snapshot.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="restore-from-snapshot"></a>Restore from snapshot<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/troubleshooting/data/restore-from-snapshot.asciidoc">edit</a></h2>
</div></div></div>
<p>Elasticsearch is using snapshots to store a copy of your data outside a cluster. You can restore a snapshot to recover
indices and data streams for which there are no copies of the shards in the cluster. This can happen if the data
(indices or data streams) was deleted or if the cluster membership changed and the current nodes in the system do not
contain a copy of the data anymore.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Restoring the missing data requires you to have a backup of the affected indices and data streams that is
up-to-date enough for your use case. Please do not proceed without confirming this.</p>
</div>
</div>
<div class="tabs" data-tab-group="host">
  <div role="tablist" aria-label="Restore from snapshot">
    <button role="tab"
            aria-selected="true"
            aria-controls="cloud-tab-restore-from-snapshot"
            id="cloud-restore-from-snapshot">
      Elasticsearch Service
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="self-managed-tab-restore-from-snapshot"
            id="self-managed-restore-from-snapshot"
            tabindex="-1">
      Self-managed
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="cloud-tab-restore-from-snapshot"
       aria-labelledby="cloud-restore-from-snapshot">
<p>In order to restore the indices and data streams that are missing data:</p>
<p><span class="strong strong"><strong>Use Kibana</strong></span></p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Log in to the <a href="https://cloud.elastic.co?page=docs&amp;placement=docs-body" class="ulink" target="_top">Elastic Cloud console</a>.
</li>
<li class="listitem">
<p>On the <span class="strong strong"><strong>Elasticsearch Service</strong></span> panel, click the name of your deployment.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If the name of your deployment is disabled your Kibana instances might be
unhealthy, in which case please contact <a href="https://support.elastic.co" class="ulink" target="_top">Elastic Support</a>.
If your deployment doesn&#8217;t include Kibana, all you need to do is
<a href="/guide/en/cloud/current/ec-access-kibana.html" class="ulink" target="_top">enable it first</a>.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Open your deployment&#8217;s side navigation menu (placed under the Elastic logo in the upper left corner)
and go to <span class="strong strong"><strong>Dev Tools &gt; Console</strong></span>.</p>
<div class="imageblock text-center screenshot">
<div class="content">
<img src="images/kibana-console.png" alt="Kibana Console">
</div>
</div>
</li>
<li class="listitem">
<p>To view the affected indices using the <a class="xref" href="cat-indices.html" title="cat indices API">cat indices API</a>.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cat.indices(
  v: true,
  health: 'red',
  h: 'index,status,health'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cat.indices({
  v: "true",
  health: "red",
  h: "index,status,health",
});
console.log(response);</pre>
</div>
<a id="2ceded6ee764adf1aaaac0a1cd25ed5f"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET _cat/indices?v&amp;health=red&amp;h=index,status,health</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2236.console"></div>
<p>The response will look like this:</p>
<a id="bfa0028824c6ad79f78cd0fd7a143a35"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">index                                status health
.ds-my-data-stream-2022.06.17-000001 open   red
kibana_sample_data_flights           open   red</pre>
</div>
<p>The <code class="literal">red</code> health of the indices above indicates that these indices are missing primary shards,
meaning they are missing data.</p>
</li>
<li class="listitem">
<p>In order to restore the data we need to find a snapshot that contains these two indices. To find
such a snapshot use the
<a class="xref" href="get-snapshot-api.html" title="Get snapshot API">get snapshot API</a>.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.snapshot.get(
  repository: 'my_repository',
  snapshot: '*',
  verbose: false
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.snapshot.get({
  repository: "my_repository",
  snapshot: "*",
  verbose: "false",
});
console.log(response);</pre>
</div>
<a id="4e926063a9494b563387617b08c4f232"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET _snapshot/my_repository/*?verbose=false</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2237.console"></div>
<p>The response will look like this:</p>
<a id="ef9cd9e56719b7eccf056308dac6a792"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "snapshots" : [
    {
      "snapshot" : "snapshot-20200617",                                     <a id="CO733-1"></a><i class="conum" data-value="1"></i>
      "uuid" : "dZyPs1HyTwS-cnKdH08EPg",
      "repository" : "my_repository",                                       <a id="CO733-2"></a><i class="conum" data-value="2"></i>
      "indices" : [                                                         <a id="CO733-3"></a><i class="conum" data-value="3"></i>
        ".apm-agent-configuration",
        ".apm-custom-link",
        ".ds-ilm-history-5-2022.06.17-000001",
        ".ds-my-data-stream-2022.06.17-000001",
        ".geoip_databases",
        ".kibana-event-log-8.2.2-000001",
        ".kibana_8.2.2_001",
        ".kibana_task_manager_8.2.2_001",
        "kibana_sample_data_ecommerce",
        "kibana_sample_data_flights",
        "kibana_sample_data_logs"
      ],
      "data_streams" : [ ],
      "state" : "SUCCESS"                                                     <a id="CO733-4"></a><i class="conum" data-value="4"></i>
    }
  ],
  "total" : 1,
  "remaining" : 0
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO733-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the snapshot.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO733-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The repository of the snapshot.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO733-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The indices backed up in the snapshot.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO733-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>If the snapshot was successful.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
The snapshot <code class="literal">snapshot-20200617</code> contains the two indices we want to restore.
You might have multiple snapshots from which you could restore the target indices. Choose the latest snapshot.
</li>
<li class="listitem">
<p>Now that we found a snapshot, we will proceed with the data stream preparation for restoring the lost data. We will
check the index metadata to see if any index is part of a data stream:</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.get(
  index: 'kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001',
  features: 'settings',
  flat_settings: true
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.get({
  index: "kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001",
  features: "settings",
  flat_settings: "true",
});
console.log(response);</pre>
</div>
<a id="719141517d83b7e8e929b347a8d67c9f"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001?features=settings&amp;flat_settings</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2238.console"></div>
<p>The response will look like this:</p>
<a id="228e6c95dda29cbdeb456a9725e1ebf3"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  ".ds-my-data-stream-2022.06.17-000001" : {                                <a id="CO734-1"></a><i class="conum" data-value="1"></i>
    "aliases" : { },
    "mappings" : { },
    "settings" : {                                                          <a id="CO734-2"></a><i class="conum" data-value="2"></i>
      "index.creation_date" : "1658406121699",
      "index.hidden" : "true",
      "index.lifecycle.name" : "my-lifecycle-policy",
      "index.number_of_replicas" : "1",
      "index.number_of_shards" : "1",
      "index.provided_name" : ".ds-my-data-stream-2022.06.17-000001",
      "index.routing.allocation.include._tier_preference" : "data_hot",
      "index.uuid" : "HmlFXp6VSu2XbQ-O3hVrwQ",
      "index.version.created" : "8020299"
    },
    "data_stream" : "my-data-stream"                                        <a id="CO734-3"></a><i class="conum" data-value="3"></i>
  },
  "kibana_sample_data_flights" : {                                          <a id="CO734-4"></a><i class="conum" data-value="4"></i>
    "aliases" : { },
    "mappings" : { },
    "settings" : {
      "index.creation_date" : "1655121541454",
      "index.number_of_replicas" : "0",
      "index.number_of_shards" : "1",
      "index.provided_name" : "kibana_sample_data_flights",
      "index.routing.allocation.include._tier_preference" : "data_content",
      "index.uuid" : "jMOlwKPPSzSraeeBWyuoDA",
      "index.version.created" : "8020299"
    }
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO734-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of an index.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO734-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The settings of this index that contains the metadata we are looking for.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO734-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>This indicates that this index is part of a data stream and displays the data stream name.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO734-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the other index we requested.</p>
</td>
</tr>
</table>
</div>
<p>The response above shows that <code class="literal">kibana_sample_data_flights</code> is not part of a data stream because it doesn&#8217;t have a
field called <code class="literal">data_stream</code> in the settings.</p>
<p>On the contrary, <code class="literal">.ds-my-data-stream-2022.06.17-000001</code> is part of the data stream called <code class="literal">my-data-stream</code>. When you
find an index like this, which belongs to a data stream, you need to check if data are still being indexed.
You can see that by checking the <code class="literal">settings</code>, if you can find this property: <code class="literal">"index.lifecycle.indexing_complete" : "true"</code>,
it means that indexing is completed in this index and you can continue to the next step.</p>
<p>If <code class="literal">index.lifecycle.indexing_complete</code> is not there or is configured to <code class="literal">false</code> you need to rollover the data stream so you can restore the missing data without blocking
the ingestion of new data. The following command will achieve that.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.rollover(
  alias: 'my-data-stream'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.rollover({
  alias: "my-data-stream",
});
console.log(response);</pre>
</div>
<a id="1e547696f54582840040b1aa6661760c"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">POST my-data-stream/_rollover</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2239.console"></div>
</li>
<li class="listitem">
<p>Now that the data stream preparation is done, we will close the target indices by using the
<a class="xref" href="indices-close.html" title="Close index API">close indices API</a>.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.close(
  index: 'kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.close({
  index: "kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001",
});
console.log(response);</pre>
</div>
<a id="c28f0b0dd3246cb91d6facb3295a61d7"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">POST kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001/_close</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2240.console"></div>
<p>You can confirm that they are closed with
the <a class="xref" href="cat-indices.html" title="cat indices API">cat indices API</a>.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cat.indices(
  v: true,
  health: 'red',
  h: 'index,status,health'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cat.indices({
  v: "true",
  health: "red",
  h: "index,status,health",
});
console.log(response);</pre>
</div>
<a id="2ceded6ee764adf1aaaac0a1cd25ed5f"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET _cat/indices?v&amp;health=red&amp;h=index,status,health</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2241.console"></div>
<p>The response will look like this:</p>
<a id="cbe594afe7bcef64510d78ff02934450"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">index                                status health
.ds-my-data-stream-2022.06.17-000001 close   red
kibana_sample_data_flights           close   red</pre>
</div>
</li>
<li class="listitem">
<p>The indices are closed, now we can restore them from snapshots without causing
any complications using the <a class="xref" href="restore-snapshot-api.html" title="Restore snapshot API">restore snapshot API</a>:</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.snapshot.restore(
  repository: 'my_repository',
  snapshot: 'snapshot-20200617',
  body: {
    indices: 'kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001',
    include_aliases: true
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.snapshot.restore({
  repository: "my_repository",
  snapshot: "snapshot-20200617",
  indices: "kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001",
  include_aliases: true,
});
console.log(response);</pre>
</div>
<a id="a699189c8d1a7573beeaea768f2fc618"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">POST _snapshot/my_repository/snapshot-20200617/_restore
{
  "indices": "kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001", <a id="CO735-1"></a><i class="conum" data-value="1"></i>
  "include_aliases": true                                                       <a id="CO735-2"></a><i class="conum" data-value="2"></i>
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2242.console"></div>
<div class="calloutlist default has-ruby has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO735-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The indices to restore.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO735-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>We also want to restore the aliases.</p>
</td>
</tr>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If any <a class="xref" href="snapshot-restore.html#feature-state" title="Feature states">feature states</a> need to be restored we&#8217;ll need to specify them using the
<code class="literal">feature_states</code> field and the indices that belong to the feature states we restore must not be specified under <code class="literal">indices</code>.
The <a class="xref" href="health-api.html" title="Health API">Health API</a> returns both the <code class="literal">indices</code> and <code class="literal">feature_states</code> that need to be restored for the restore from snapshot diagnosis. e.g.:</p>
</div>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.snapshot.restore(
  repository: 'my_repository',
  snapshot: 'snapshot-20200617',
  body: {
    feature_states: [
      'geoip'
    ],
    indices: 'kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001',
    include_aliases: true
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.snapshot.restore({
  repository: "my_repository",
  snapshot: "snapshot-20200617",
  feature_states: ["geoip"],
  indices: "kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001",
  include_aliases: true,
});
console.log(response);</pre>
</div>
<a id="fd6fdc8fa994dd02cf1177077325304f"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">POST _snapshot/my_repository/snapshot-20200617/_restore
{
  "feature_states": [ "geoip" ],
  "indices": "kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001",
  "include_aliases": true
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2243.console"></div>
</li>
<li class="listitem">
<p>Finally we can verify that the indices health is now <code class="literal">green</code> via the <a class="xref" href="cat-indices.html" title="cat indices API">cat indices API</a>.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cat.indices(
  v: true,
  index: '.ds-my-data-stream-2022.06.17-000001,kibana_sample_data_flightsh=index,status,health'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cat.indices({
  v: "true",
  index:
    ".ds-my-data-stream-2022.06.17-000001,kibana_sample_data_flightsh=index,status,health",
});
console.log(response);</pre>
</div>
<a id="734e2b1d1ca84a305240a449738f0eba"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET _cat/indices?v&amp;index=.ds-my-data-stream-2022.06.17-000001,kibana_sample_data_flightsh=index,status,health</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2244.console"></div>
<p>The response will look like this:</p>
<a id="3d6986d5be947ec06c5c49287edf9ce5"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">index                                status health
.ds-my-data-stream-2022.06.17-000001 open   green
kibana_sample_data_flights           open   green</pre>
</div>
<p>As we can see above the indices are <code class="literal">green</code> and open. The issue is resolved.</p>
</li>
</ol>
</div>
<p>For more guidance on creating and restoring snapshots see
<a class="xref" href="snapshot-restore.html" title="Snapshot and restore">this guide</a>.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="self-managed-tab-restore-from-snapshot"
       aria-labelledby="self-managed-restore-from-snapshot"
       hidden="">
<p>In order to restore the indices that are missing shards:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>View the affected indices using the <a class="xref" href="cat-indices.html" title="cat indices API">cat indices API</a>.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cat.indices(
  v: true,
  health: 'red',
  h: 'index,status,health'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cat.indices({
  v: "true",
  health: "red",
  h: "index,status,health",
});
console.log(response);</pre>
</div>
<a id="2ceded6ee764adf1aaaac0a1cd25ed5f"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET _cat/indices?v&amp;health=red&amp;h=index,status,health</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2245.console"></div>
<p>The response will look like this:</p>
<a id="bfa0028824c6ad79f78cd0fd7a143a35"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">index                                status health
.ds-my-data-stream-2022.06.17-000001 open   red
kibana_sample_data_flights           open   red</pre>
</div>
<p>The <code class="literal">red</code> health of the indices above indicates that these indices are missing primary shards,
meaning they are missing data.</p>
</li>
<li class="listitem">
<p>In order to restore the data we need to find a snapshot that contains these two indices. To find
such a snapshot use the
<a class="xref" href="get-snapshot-api.html" title="Get snapshot API">get snapshot API</a>.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.snapshot.get(
  repository: 'my_repository',
  snapshot: '*',
  verbose: false
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.snapshot.get({
  repository: "my_repository",
  snapshot: "*",
  verbose: "false",
});
console.log(response);</pre>
</div>
<a id="4e926063a9494b563387617b08c4f232"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET _snapshot/my_repository/*?verbose=false</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2246.console"></div>
<p>The response will look like this:</p>
<a id="ef9cd9e56719b7eccf056308dac6a792"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "snapshots" : [
    {
      "snapshot" : "snapshot-20200617",                                     <a id="CO736-1"></a><i class="conum" data-value="1"></i>
      "uuid" : "dZyPs1HyTwS-cnKdH08EPg",
      "repository" : "my_repository",                                       <a id="CO736-2"></a><i class="conum" data-value="2"></i>
      "indices" : [                                                         <a id="CO736-3"></a><i class="conum" data-value="3"></i>
        ".apm-agent-configuration",
        ".apm-custom-link",
        ".ds-ilm-history-5-2022.06.17-000001",
        ".ds-my-data-stream-2022.06.17-000001",
        ".geoip_databases",
        ".kibana-event-log-8.2.2-000001",
        ".kibana_8.2.2_001",
        ".kibana_task_manager_8.2.2_001",
        "kibana_sample_data_ecommerce",
        "kibana_sample_data_flights",
        "kibana_sample_data_logs"
      ],
      "data_streams" : [ ],
      "state" : "SUCCESS"                                                     <a id="CO736-4"></a><i class="conum" data-value="4"></i>
    }
  ],
  "total" : 1,
  "remaining" : 0
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO736-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the snapshot.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO736-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The repository of the snapshot.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO736-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The indices backed up in the snapshot.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO736-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>If the snapshot was successful.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
The snapshot <code class="literal">snapshot-20200617</code> contains the two indices we want to restore.
You might have multiple snapshots from which you could restore the target indices. Choose the latest snapshot.
</li>
<li class="listitem">
<p>Now that we found a snapshot, we will proceed with the data stream preparation for restoring the lost data. We will
check the index metadata to see if any index is part of a data stream:</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.get(
  index: 'kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001',
  features: 'settings',
  flat_settings: true
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.get({
  index: "kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001",
  features: "settings",
  flat_settings: "true",
});
console.log(response);</pre>
</div>
<a id="719141517d83b7e8e929b347a8d67c9f"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001?features=settings&amp;flat_settings</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2247.console"></div>
<p>The response will look like this:</p>
<a id="228e6c95dda29cbdeb456a9725e1ebf3"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  ".ds-my-data-stream-2022.06.17-000001" : {                                <a id="CO737-1"></a><i class="conum" data-value="1"></i>
    "aliases" : { },
    "mappings" : { },
    "settings" : {                                                          <a id="CO737-2"></a><i class="conum" data-value="2"></i>
      "index.creation_date" : "1658406121699",
      "index.hidden" : "true",
      "index.lifecycle.name" : "my-lifecycle-policy",
      "index.number_of_replicas" : "1",
      "index.number_of_shards" : "1",
      "index.provided_name" : ".ds-my-data-stream-2022.06.17-000001",
      "index.routing.allocation.include._tier_preference" : "data_hot",
      "index.uuid" : "HmlFXp6VSu2XbQ-O3hVrwQ",
      "index.version.created" : "8020299"
    },
    "data_stream" : "my-data-stream"                                        <a id="CO737-3"></a><i class="conum" data-value="3"></i>
  },
  "kibana_sample_data_flights" : {                                          <a id="CO737-4"></a><i class="conum" data-value="4"></i>
    "aliases" : { },
    "mappings" : { },
    "settings" : {
      "index.creation_date" : "1655121541454",
      "index.number_of_replicas" : "0",
      "index.number_of_shards" : "1",
      "index.provided_name" : "kibana_sample_data_flights",
      "index.routing.allocation.include._tier_preference" : "data_content",
      "index.uuid" : "jMOlwKPPSzSraeeBWyuoDA",
      "index.version.created" : "8020299"
    }
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO737-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of an index.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO737-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The settings of this index that contains the metadata we are looking for.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO737-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>This indicates that this index is part of a data stream and displays the data stream name.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO737-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the other index we requested.</p>
</td>
</tr>
</table>
</div>
<p>The response above shows that <code class="literal">kibana_sample_data_flights</code> is not part of a data stream because it doesn&#8217;t have a
field called <code class="literal">data_stream</code> in the settings.</p>
<p>On the contrary, <code class="literal">.ds-my-data-stream-2022.06.17-000001</code> is part of the data stream called <code class="literal">my-data-stream</code>. When you
find an index like this, which belongs to a data stream, you need to check if data are still being indexed.
You can see that by checking the <code class="literal">settings</code>, if you can find this property: <code class="literal">"index.lifecycle.indexing_complete" : "true"</code>,
it means that indexing is completed in this index and you can continue to the next step.</p>
<p>If <code class="literal">index.lifecycle.indexing_complete</code> is not there or is configured to <code class="literal">false</code> you need to rollover the data stream so you can restore the missing data without blocking
the ingestion of new data. The following command will achieve that.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.rollover(
  alias: 'my-data-stream'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.rollover({
  alias: "my-data-stream",
});
console.log(response);</pre>
</div>
<a id="1e547696f54582840040b1aa6661760c"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">POST my-data-stream/_rollover</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2248.console"></div>
</li>
<li class="listitem">
<p>Now that the data stream preparation is done, we will close the target indices by using the
<a class="xref" href="indices-close.html" title="Close index API">close indices API</a>.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.close(
  index: 'kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.close({
  index: "kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001",
});
console.log(response);</pre>
</div>
<a id="c28f0b0dd3246cb91d6facb3295a61d7"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">POST kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001/_close</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2249.console"></div>
<p>You can confirm that they are closed with
the <a class="xref" href="cat-indices.html" title="cat indices API">cat indices API</a>.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cat.indices(
  v: true,
  health: 'red',
  h: 'index,status,health'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cat.indices({
  v: "true",
  health: "red",
  h: "index,status,health",
});
console.log(response);</pre>
</div>
<a id="2ceded6ee764adf1aaaac0a1cd25ed5f"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET _cat/indices?v&amp;health=red&amp;h=index,status,health</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2250.console"></div>
<p>The response will look like this:</p>
<a id="cbe594afe7bcef64510d78ff02934450"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">index                                status health
.ds-my-data-stream-2022.06.17-000001 close   red
kibana_sample_data_flights           close   red</pre>
</div>
</li>
<li class="listitem">
<p>The indices are closed, now we can restore them from snapshots without causing
any complications using the <a class="xref" href="restore-snapshot-api.html" title="Restore snapshot API">restore snapshot API</a>:</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.snapshot.restore(
  repository: 'my_repository',
  snapshot: 'snapshot-20200617',
  body: {
    indices: 'kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001',
    include_aliases: true
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.snapshot.restore({
  repository: "my_repository",
  snapshot: "snapshot-20200617",
  indices: "kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001",
  include_aliases: true,
});
console.log(response);</pre>
</div>
<a id="a699189c8d1a7573beeaea768f2fc618"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">POST _snapshot/my_repository/snapshot-20200617/_restore
{
  "indices": "kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001", <a id="CO738-1"></a><i class="conum" data-value="1"></i>
  "include_aliases": true                                                       <a id="CO738-2"></a><i class="conum" data-value="2"></i>
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2251.console"></div>
<div class="calloutlist default has-ruby has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO738-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The indices to restore.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO738-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>We also want to restore the aliases.</p>
</td>
</tr>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If any <a class="xref" href="snapshot-restore.html#feature-state" title="Feature states">feature states</a> need to be restored we&#8217;ll need to specify them using the
<code class="literal">feature_states</code> field and the indices that belong to the feature states we restore must not be specified under <code class="literal">indices</code>.
The <a class="xref" href="health-api.html" title="Health API">Health API</a> returns both the <code class="literal">indices</code> and <code class="literal">feature_states</code> that need to be restored for the restore from snapshot diagnosis. e.g.:</p>
</div>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.snapshot.restore(
  repository: 'my_repository',
  snapshot: 'snapshot-20200617',
  body: {
    feature_states: [
      'geoip'
    ],
    indices: 'kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001',
    include_aliases: true
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.snapshot.restore({
  repository: "my_repository",
  snapshot: "snapshot-20200617",
  feature_states: ["geoip"],
  indices: "kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001",
  include_aliases: true,
});
console.log(response);</pre>
</div>
<a id="fd6fdc8fa994dd02cf1177077325304f"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">POST _snapshot/my_repository/snapshot-20200617/_restore
{
  "feature_states": [ "geoip" ],
  "indices": "kibana_sample_data_flights,.ds-my-data-stream-2022.06.17-000001",
  "include_aliases": true
}</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2252.console"></div>
</li>
<li class="listitem">
<p>Finally we can verify that the indices health is now <code class="literal">green</code> via the <a class="xref" href="cat-indices.html" title="cat indices API">cat indices API</a>.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.cat.indices(
  v: true,
  index: '.ds-my-data-stream-2022.06.17-000001,kibana_sample_data_flightsh=index,status,health'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cat.indices({
  v: "true",
  index:
    ".ds-my-data-stream-2022.06.17-000001,kibana_sample_data_flightsh=index,status,health",
});
console.log(response);</pre>
</div>
<a id="734e2b1d1ca84a305240a449738f0eba"></a>
<div class="pre_wrapper lang-console default has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby has-js">GET _cat/indices?v&amp;index=.ds-my-data-stream-2022.06.17-000001,kibana_sample_data_flightsh=index,status,health</pre>
</div>
<div class="console_widget has-ruby has-js" data-snippet="snippets/2253.console"></div>
<p>The response will look like this:</p>
<a id="3d6986d5be947ec06c5c49287edf9ce5"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">index                                status health
.ds-my-data-stream-2022.06.17-000001 open   green
kibana_sample_data_flights           open   green</pre>
</div>
<p>As we can see above the indices are <code class="literal">green</code> and open. The issue is resolved.</p>
</li>
</ol>
</div>
<p>For more guidance on creating and restoring snapshots see
<a class="xref" href="snapshot-restore.html" title="Snapshot and restore">this guide</a>.</p>
  </div>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="start-slm.html">« Start Snapshot Lifecycle Management</a>
</span>
<span class="next">
<a href="add-repository.html">Troubleshooting broken repositories »</a>
</span>
</div>
</body>
</html>
