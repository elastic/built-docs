<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="keywords" content="Elasticsearch diagnostic, diagnostics">
<title>Retriever | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Retriever | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="search.html" title="Search APIs"/>
<link rel="prev" href="knn-search-api.html" title="kNN search API"/>
<link rel="next" href="rrf.html" title="Reciprocal rank fusion"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="knn-search-api.html">« kNN search API</a>
</span>
<span class="next">
<a href="rrf.html">Reciprocal rank fusion »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="rest-apis.html">REST APIs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search.html">Search APIs</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Retriever</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="retriever"></a>Retriever<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h2>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in technical preview and may be changed or removed in a future release. The syntax will likely change before GA. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>A retriever is a specification to describe top documents returned from a
search. A retriever replaces other elements of the <a class="xref" href="search-search.html" title="Search API">search API</a>
that also return top documents such as <a class="xref" href="query-dsl.html" title="Query DSL"><code class="literal">query</code></a> and
<a class="xref" href="search-search.html#search-api-knn"><code class="literal">knn</code></a>. A retriever may have child retrievers where a
retriever with two or more children is considered a compound retriever. This
allows for complex behavior to be depicted in a tree-like structure, called
the retriever tree, to better clarify the order of operations that occur
during a search.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Refer to <a class="xref" href="retrievers-overview.html" title="Retrievers"><em>Retrievers</em></a> for a high level overview of the retrievers abstraction.</p>
</div>
</div>
<p>The following retrievers are available:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">standard</code>
</span>
</dt>
<dd>
A <a class="xref" href="retriever.html#standard-retriever" title="Standard Retriever">retriever</a> that replaces the functionality of a traditional <a class="xref" href="query-dsl.html" title="Query DSL">query</a>.
</dd>
<dt>
<span class="term">
<code class="literal">knn</code>
</span>
</dt>
<dd>
A <a class="xref" href="retriever.html#knn-retriever" title="kNN Retriever">retriever</a> that replaces the functionality of a <a class="xref" href="search-search.html#search-api-knn">knn search</a>.
</dd>
<dt>
<span class="term">
<code class="literal">rrf</code>
</span>
</dt>
<dd>
A <a class="xref" href="retriever.html#rrf-retriever" title="RRF Retriever">retriever</a> that produces top documents from <a class="xref" href="rrf.html" title="Reciprocal rank fusion">reciprocal rank fusion (RRF)</a>.
</dd>
</dl>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="standard-retriever"></a>Standard Retriever<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h3>
</div></div></div>
<p>A standard retriever returns top documents from a traditional <a class="xref" href="query-dsl.html" title="Query DSL">query</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_parameters_4"></a>Parameters:<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h4>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">query</code>
</span>
</dt>
<dd>
<p>
(Optional, <a class="xref" href="query-dsl.html" title="Query DSL">query object</a>)
</p>
<p>Defines a query to retrieve a set of top documents.</p>
</dd>
<dt>
<span class="term">
<code class="literal">filter</code>
</span>
</dt>
<dd>
<p>
(Optional, <a class="xref" href="query-dsl.html" title="Query DSL">query object or list of query objects</a>)
</p>
<p>Applies a <a class="xref" href="query-dsl-bool-query.html" title="Boolean query">boolean query filter</a> to this retriever
where all documents must match this query but do not contribute to the score.</p>
</dd>
<dt>
<span class="term">
<code class="literal">search_after</code>
</span>
</dt>
<dd>
<p>
(Optional, <a class="xref" href="paginate-search-results.html#search-after" title="Search after">search after object</a>)
</p>
<p>Defines a search after object parameter used for pagination.</p>
</dd>
<dt>
<span class="term">
<code class="literal">terminate_after</code>
</span>
</dt>
<dd>
<p>
(Optional, integer) Maximum number of documents to collect for each shard. If a
query reaches this limit, Elasticsearch terminates the query early. Elasticsearch collects
documents before sorting.
</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Use with caution. Elasticsearch applies this parameter to each shard handling
the request. When possible, let Elasticsearch perform early termination automatically.
Avoid specifying this parameter for requests that target data streams with
backing indices across multiple data tiers.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">sort</code>
</span>
</dt>
<dd>
<p>(Optional, <a class="xref" href="sort-search-results.html" title="Sort search results">sort object</a>)
A sort object that that specifies the order of matching documents.</p>
</dd>
<dt>
<span class="term">
<code class="literal">min_score</code>
</span>
</dt>
<dd>
<p>
(Optional, <code class="literal">float</code>)
</p>
<p>Minimum <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores"><code class="literal">_score</code></a> for matching documents. Documents with a
lower <code class="literal">_score</code> are not included in the top documents.</p>
</dd>
<dt>
<span class="term">
<code class="literal">collapse</code>
</span>
</dt>
<dd>
<p>
(Optional, <a class="xref" href="collapse-search-results.html" title="Collapse search results">collapse object</a>)
</p>
<p>Collapses the top documents by a specified key into a single top document per key.</p>
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_restrictions"></a>Restrictions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h4>
</div></div></div>
<p>When a retriever tree contains a compound retriever (a retriever with two or more child
retrievers) <span class="strong strong"><strong>only</strong></span> the query element is allowed.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_example_12"></a>Example<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h4>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">GET /index/_search
{
    "retriever": {
        "standard": {
            "query" { ... },
            "filter" { ... },
            "min_score": ...
        }
    },
    "size": ...
}</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="knn-retriever"></a>kNN Retriever<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h3>
</div></div></div>
<p>A kNN retriever returns top documents from a <a class="xref" href="knn-search.html" title="k-nearest neighbor (kNN) search">k-nearest neighbor search (kNN)</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_parameters_5"></a>Parameters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h4>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">field</code>
</span>
</dt>
<dd>
<p>
(Required, string)
</p>
<p>The name of the vector field to search against. Must be a
<a class="xref" href="dense-vector.html#index-vectors-knn-search" title="Index vectors for kNN search"><code class="literal">dense_vector</code> field with indexing enabled</a>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">query_vector</code>
</span>
</dt>
<dd>
<p>
(Required if <code class="literal">query_vector_builder</code> is not defined, array of <code class="literal">float</code>)
</p>
<p>Query vector. Must have the same number of dimensions as the vector field you
are searching against. Must be either an array of floats or a hex-encoded byte vector.</p>
</dd>
<dt>
<span class="term">
<code class="literal">query_vector_builder</code>
</span>
</dt>
<dd>
<p>
(Required if <code class="literal">query_vector</code> is not defined, query vector builder object)
</p>
<p>Defines a <a class="xref" href="knn-search.html#knn-semantic-search" title="Perform semantic search">model</a> to build a query vector.</p>
</dd>
<dt>
<span class="term">
<code class="literal">k</code>
</span>
</dt>
<dd>
<p>
(Required, integer)
</p>
<p>Number of nearest neighbors to return as top hits. This value must be fewer than
or equal to <code class="literal">num_candidates</code>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">num_candidates</code>
</span>
</dt>
<dd>
<p>
(Required, integer)
</p>
<p>The number of nearest neighbor candidates to consider per shard.
Needs to be greater than <code class="literal">k</code>, or <code class="literal">size</code> if <code class="literal">k</code> is omitted, and cannot exceed 10,000.
Elasticsearch collects <code class="literal">num_candidates</code> results from each shard, then merges them
to find the top <code class="literal">k</code> results. Increasing <code class="literal">num_candidates</code> tends to improve the
accuracy of the final <code class="literal">k</code> results. Defaults to <code class="literal">Math.min(1.5 * k, 10_000)</code>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">filter</code>
</span>
</dt>
<dd>
<p>
(Optional, <a class="xref" href="query-dsl.html" title="Query DSL">query object or list of query objects</a>)
</p>
<p>Query to filter the documents that can match. The kNN search will return the top
<code class="literal">k</code> documents that also match this filter. The value can be a single query or a
list of queries. If <code class="literal">filter</code> is not provided, all documents are allowed to
match.</p>
</dd>
<dt>
<span class="term">
<code class="literal">similarity</code>
</span>
</dt>
<dd>
<p>
(Optional, float)
</p>
<p>The minimum similarity required for a document to be considered a match. The similarity
value calculated relates to the raw <a class="xref" href="dense-vector.html#dense-vector-similarity"><code class="literal">similarity</code></a> used. Not the
document score. The matched documents are then scored according to <a class="xref" href="dense-vector.html#dense-vector-similarity"><code class="literal">similarity</code></a>
and the provided <code class="literal">boost</code> is applied.</p>
<p>The <code class="literal">similarity</code> parameter is the direct vector similarity calculation.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">l2_norm</code>: also known as Euclidean, will include documents where the vector is within
the <code class="literal">dims</code> dimensional hypersphere with radius <code class="literal">similarity</code> with origin at <code class="literal">query_vector</code>.
</li>
<li class="listitem">
<code class="literal">cosine</code>, <code class="literal">dot_product</code>, and <code class="literal">max_inner_product</code>: Only return vectors where the cosine similarity or dot-product are at least the provided
<code class="literal">similarity</code>.
</li>
</ul>
</div>
<p>Read more here: <a class="xref" href="knn-search.html#knn-similarity-search" title="Search kNN with expected similarity">knn similarity search</a></p>
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_restrictions_2"></a>Restrictions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h4>
</div></div></div>
<p>The parameters <code class="literal">query_vector</code> and <code class="literal">query_vector_builder</code> cannot be used together.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_example_13"></a>Example:<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h4>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">GET /index/_search
{
    "retriever": {
        "knn": {
            "field": ...,
            "query_vector": ...,
            "k": ...,
            "num_candidates": ...
        }
    }
}</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="rrf-retriever"></a>RRF Retriever<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h3>
</div></div></div>
<p>An <a class="xref" href="rrf.html" title="Reciprocal rank fusion">RRF</a> retriever returns top documents based on the RRF formula
equally weighting two or more child retrievers.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_parameters_6"></a>Parameters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h4>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">retrievers</code>
</span>
</dt>
<dd>
<p>
(Required, array of retriever objects)
</p>
<p>A list of child retrievers to specify which sets of returned top documents
will have the RRF formula applied to them. Each child retriever carries an
equal weight as part of the RRF formula. Two or more child retrievers are
required.</p>
</dd>
<dt>
<span class="term">
<code class="literal">rank_constant</code>
</span>
</dt>
<dd>
<p>
(Optional, integer)
</p>
<p>This value determines how much influence documents in individual
result sets per query have over the final ranked result set. A higher value indicates
that lower ranked documents have more influence. This value must be greater than or
equal to <code class="literal">1</code>. Defaults to <code class="literal">60</code>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">window_size</code>
</span>
</dt>
<dd>
<p>
(Optional, integer)
</p>
<p>This value determines the size of the individual result sets per
query. A higher value will improve result relevance at the cost of performance. The final
ranked result set is pruned down to the search request&#8217;s <a class="xref" href="search-search.html#search-size-param">size</a>.
<code class="literal">window_size</code> must be greater than or equal to <code class="literal">size</code> and greater than or equal to <code class="literal">1</code>.
Defaults to the <code class="literal">size</code> parameter.</p>
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_restrictions_3"></a>Restrictions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h4>
</div></div></div>
<p>An RRF retriever is a compound retriever. Child retrievers may not use
elements that are restricted by having a compound retriever as part of
the retriever tree.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_example_14"></a>Example<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h4>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">GET /index/_search
{
    "retriever": {
        "rrf": {
            "retrievers": [
                {
                    "standard" { ... }
                },
                {
                    "knn": { ... }
                }
            ],
            "rank_constant": ...
            "rank_window_size": ...
        }
    }
}</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_using_from_and_size_with_a_retriever_tree"></a>Using <code class="literal">from</code> and <code class="literal">size</code> with a retriever tree<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h3>
</div></div></div>
<p>The <a class="xref" href="search-search.html#search-from-param"><code class="literal">from</code></a> and <a class="xref" href="search-search.html#search-size-param"><code class="literal">size</code></a>
parameters are provided globally as part of the general
<a class="xref" href="search-search.html" title="Search API">search API</a>. They are applied to all retrievers in a
retriever tree unless a specific retriever overrides the <code class="literal">size</code> parameter
using a different parameter such as <code class="literal">rank_window_size</code>. Though, the final
search hits are always limited to <code class="literal">size</code>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_using_aggregations_with_a_retriever_tree"></a>Using aggregations with a retriever tree<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h3>
</div></div></div>
<p><a class="xref" href="search-aggregations.html" title="Aggregations">Aggregations</a> are globally specified as part of a search request.
The query used for an aggregation is the combination of all leaf retrievers as <code class="literal">should</code>
clauses in a <a class="xref" href="query-dsl-bool-query.html" title="Boolean query">boolean query</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_restrictions_on_search_parameters_when_specifying_a_retriever"></a>Restrictions on search parameters when specifying a retriever<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/retriever.asciidoc">edit</a></h3>
</div></div></div>
<p>When a retriever is specified as part of a search the following elements are not allowed
at the top-level and instead are only allowed as elements of specific retrievers:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="search-search.html#request-body-search-query"><code class="literal">query</code></a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#search-api-knn"><code class="literal">knn</code></a>
</li>
<li class="listitem">
<a class="xref" href="paginate-search-results.html#search-after" title="Search after"><code class="literal">search_after</code></a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#request-body-search-terminate-after"><code class="literal">terminate_after</code></a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#search-sort-param"><code class="literal">sort</code></a>
</li>
<li class="listitem">
<a class="xref" href="filter-search-results.html#rescore" title="Rescore filtered search results"><code class="literal">rescore</code></a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#search-api-min-score"><code class="literal">min_score</code></a>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="knn-search-api.html">« kNN search API</a>
</span>
<span class="next">
<a href="rrf.html">Reciprocal rank fusion »</a>
</span>
</div>
</body>
</html>
