<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="keywords" content="hot-spotting, hotspot, hot-spot, hot spot, hotspots, hotspotting">
<title>Reciprocal rank fusion | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Reciprocal rank fusion | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="search.html" title="Search APIs"/>
<link rel="prev" href="knn-search-api.html" title="kNN search API"/>
<link rel="next" href="scroll-api.html" title="Scroll API"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="rest-apis.html">REST APIs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search.html">Search APIs</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="knn-search-api.html">« kNN search API</a>
</span>
<span class="next">
<a href="scroll-api.html">Scroll API »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="rrf"></a>Reciprocal rank fusion<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/rrf.asciidoc">edit</a></h2>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in technical preview and may be changed or removed in a future release. The syntax will likely change before GA. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p><a href="https://plg.uwaterloo.ca/~gvcormac/cormacksigir09-rrf.pdf" class="ulink" target="_top">Reciprocal rank fusion (RRF)</a>
is a method for combining multiple result sets with different relevance
indicators into a single result set. RRF requires no tuning, and the different
relevance indicators do not have to be related to each other to achieve high-quality
results.</p>
<p>RRF uses the following formula to determine the score for ranking each document:</p>
<div class="pre_wrapper lang-python">
<pre class="programlisting prettyprint lang-python">score = 0.0
for q in queries:
    if d in result(q):
        score += 1.0 / ( k + rank( result(q), d ) )
return score

# where
# k is a ranking constant
# q is a query in the set of queries
# d is a document in the result set of q
# result(q) is the result set of q
# rank( result(q), d ) is d's rank within the result(q) starting from 1</pre>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="rrf-api"></a>Reciprocal rank fusion API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/rrf.asciidoc">edit</a></h3>
</div></div></div>
<p>You can use RRF as part of a <a class="xref" href="search-search.html" title="Search API">search</a> to combine and rank
documents using result sets from a combination of
<a class="xref" href="search-search.html#request-body-search-query">query</a>,
<a class="xref" href="search-search.html#request-body-sub-searches">sub searches</a>, and/or
<a class="xref" href="search-search.html#search-api-knn">knn searches</a>. A minimum of 2 results sets
is required for ranking from the specified sources.</p>
<p>The <code class="literal">rrf</code> parameter is an optional object defined as part of a search request&#8217;s
<a class="xref" href="search-search.html#request-body-rank">rank parameter</a>. The <code class="literal">rrf</code> object contains the following
parameters:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">rank_constant</code>
</span>
</dt>
<dd>
(Optional, integer) This value determines how much influence documents in individual
result sets per query have over the final ranked result set. A higher value indicates
that lower ranked documents have more influence. This value must be greater than or
equal to <code class="literal">1</code>. Defaults to <code class="literal">60</code>.
</dd>
<dt>
<span class="term">
<code class="literal">window_size</code>
</span>
</dt>
<dd>
(Optional, integer) This value determines the size of the individual result sets per
query. A higher value will improve result relevance at the cost of performance. The final
ranked result set is pruned down to the search request&#8217;s <a class="xref" href="search-search.html#search-size-param">size</a>.
<code class="literal">window_size</code> must be greater than or equal to <code class="literal">size</code> and greater than or equal to <code class="literal">1</code>.
Defaults to <code class="literal">100</code>.
</dd>
</dl>
</div>
<p>An example request using RRF:</p>
<a id="716c063ceaf8d2a88cf8c7d42a0061fb"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET example-index/_search
{
    "query": {
        "term": {
            "text": "shoes"
        }
    },
    "knn": {
        "field": "vector",
        "query_vector": [1.25, 2, 3.5],
        "k": 50,
        "num_candidates": 100
    },
    "rank": {
        "rrf": {
            "window_size": 50,
            "rank_constant": 20
        }
    }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/2909.console"></div>
<p>In the above example, we first execute the kNN search to get its global top 50 results.
Then we execute the query to get its global top 50 results. Afterwards, on a coordinating
node, we combine the knn search results with the query results and rank them based on the
RRF method to get the final top 10 results.</p>
<p>Note that if <code class="literal">k</code> from a knn search is larger than <code class="literal">window_size</code>, the results are
truncated to <code class="literal">window_size</code>. If <code class="literal">k</code> is smaller than <code class="literal">window_size</code>, the results are
<code class="literal">k</code> size.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="rrf-supported-features"></a>Reciprocal rank fusion supported features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/rrf.asciidoc">edit</a></h3>
</div></div></div>
<p>RRF does support:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="search-search.html#request-body-sub-searches">sub searches</a>
</li>
<li class="listitem">
<a class="xref" href="search-aggregations.html" title="Aggregations">aggregations</a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#search-from-param">from</a>
</li>
</ul>
</div>
<p>RRF does not currently support:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="search-search.html#search-api-scroll-query-param">scroll</a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#search-api-pit">point in time</a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#search-sort-param">sort</a>
</li>
<li class="listitem">
<a class="xref" href="filter-search-results.html#rescore" title="Rescore filtered search results">rescore</a>
</li>
<li class="listitem">
<a class="xref" href="search-suggesters.html" title="Suggesters">suggesters</a>
</li>
<li class="listitem">
<a class="xref" href="highlighting.html" title="Highlighting">highlighting</a>
</li>
<li class="listitem">
<a class="xref" href="collapse-search-results.html" title="Collapse search results">collapse</a>
</li>
<li class="listitem">
<a class="xref" href="search-search.html#request-body-search-explain">explain</a>
</li>
<li class="listitem">
<a class="xref" href="search-profile.html#profiling-queries" title="Profiling Queries">profiling</a>
</li>
</ul>
</div>
<p>Using unsupported features as part of a search with RRF results
in an exception.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="rrf-using-sub-searches"></a>Reciprocal rank fusion using sub searches<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/rrf.asciidoc">edit</a></h3>
</div></div></div>
<p><a class="xref" href="search-search.html#request-body-sub-searches">Sub searches</a> provides a way to
combine and rank multiple searches using RRF.</p>
<p>An example request using RRF with sub searches:</p>
<a id="3fdc1269aaedea61248e39c70997fed8"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET example-index/_search
{
    "sub_searches": [
        {
            "query": {
                "term": {
                    "text": "blue shoes sale"
                }
            }
        },
        {
            "query": {
                "text_expansion":{
                    "ml.tokens":{
                        "model_id":"my_elser_model",
                        "model_text":"What blue shoes are on sale?"
                     }
                }
            }
        }
    ],
    "rank": {
        "rrf": {
            "window_size": 50,
            "rank_constant": 20
        }
    }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/2910.console"></div>
<p>In the above example, we execute each of the two sub searches
independently of each other. First we run the term query for
<code class="literal">blue shoes sales</code> using the standard BM25 scoring algorithm. Then
we run the text expansion query for <code class="literal">What blue shoes are on sale?</code>
using our <a class="xref" href="semantic-search-elser.html" title="Tutorial: semantic search with ELSER">ELSER</a> scoring algorithm.
RRF allows us to combine the two results sets generated by completely
independent scoring algorithms with equal weighting. Not only does this
remove the need to figure out what the appropriate weighting would be
using linear combination, but RRF is also shown to give improved
relevance over either query individually.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="rrf-full-example"></a>Reciprocal rank fusion full example<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/rrf.asciidoc">edit</a></h3>
</div></div></div>
<p>We begin by creating a mapping for an index with a text field, a vector field,
and an integer field along with indexing several documents. For this example we
are going to use a vector with only a single dimension to make the ranking easier
to explain.</p>
<div class="pre_wrapper lang-ruby alternative">
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.create(
  index: 'example-index',
  body: {
    mappings: {
      properties: {
        text: {
          type: 'text'
        },
        vector: {
          type: 'dense_vector',
          dims: 1,
          index: true,
          similarity: 'l2_norm'
        },
        integer: {
          type: 'integer'
        }
      }
    }
  }
)
puts response

response = client.index(
  index: 'example-index',
  id: 1,
  body: {
    text: 'rrf',
    vector: [
      5
    ],
    integer: 1
  }
)
puts response

response = client.index(
  index: 'example-index',
  id: 2,
  body: {
    text: 'rrf rrf',
    vector: [
      4
    ],
    integer: 2
  }
)
puts response

response = client.index(
  index: 'example-index',
  id: 3,
  body: {
    text: 'rrf rrf rrf',
    vector: [
      3
    ],
    integer: 1
  }
)
puts response

response = client.index(
  index: 'example-index',
  id: 4,
  body: {
    text: 'rrf rrf rrf rrf',
    integer: 2
  }
)
puts response

response = client.index(
  index: 'example-index',
  id: 5,
  body: {
    vector: [
      0
    ],
    integer: 1
  }
)
puts response

response = client.indices.refresh(
  index: 'example-index'
)
puts response</pre>
</div>
<a id="2cafbc456bed3b7c8780e5557aab1d6b"></a>
<div class="pre_wrapper lang-console default has-ruby">
<pre class="programlisting prettyprint lang-console default has-ruby">PUT example-index
{
  "mappings": {
        "properties": {
            "text" : {
                "type" : "text"
            },
            "vector": {
                "type": "dense_vector",
                "dims": 1,
                "index": true,
                "similarity": "l2_norm"
            },
            "integer" : {
                "type" : "integer"
            }
        }
    }
}

PUT example-index/_doc/1
{
    "text" : "rrf",
    "vector" : [5],
    "integer": 1
}

PUT example-index/_doc/2
{
    "text" : "rrf rrf",
    "vector" : [4],
    "integer": 2
}

PUT example-index/_doc/3
{
    "text" : "rrf rrf rrf",
    "vector" : [3],
    "integer": 1
}

PUT example-index/_doc/4
{
    "text" : "rrf rrf rrf rrf",
    "integer": 2
}

PUT example-index/_doc/5
{
    "vector" : [0],
    "integer": 1
}

POST example-index/_refresh</pre>
</div>
<div class="console_widget has-ruby" data-snippet="snippets/2911.console"></div>
<p>We now execute a search using RRF with a query, a kNN search, and
a terms aggregation.</p>
<a id="c9cef51e8e0015ee7549ad4da31c2fe9"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET example-index/_search
{
    "query": {
        "term": {
            "text": "rrf"
        }
    },
    "knn": {
        "field": "vector",
        "query_vector": [3],
        "k": 5,
        "num_candidates": 5
    },
    "rank": {
        "rrf": {
            "window_size": 5,
            "rank_constant": 1
        }
    },
    "size": 3,
    "aggs": {
        "int_count": {
            "terms": {
                "field": "integer"
            }
        }
    }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/2912.console"></div>
<p>And we receive the response with ranked <code class="literal">hits</code> and the terms
aggregation result. Note that <code class="literal">_score</code> is <code class="literal">null</code>, and we instead
use <code class="literal">_rank</code> to show our top-ranked documents.</p>
<div class="pre_wrapper lang-console-response">
<pre class="programlisting prettyprint lang-console-response">{
    "took": ...,
    "timed_out" : false,
    "_shards" : {
        "total" : 1,
        "successful" : 1,
        "skipped" : 0,
        "failed" : 0
    },
    "hits" : {
        "total" : {
            "value" : 5,
            "relation" : "eq"
        },
        "max_score" : null,
        "hits" : [
            {
                "_index" : "example-index",
                "_id" : "3",
                "_score" : null,
                "_rank" : 1,
                "_source" : {
                    "integer" : 1,
                    "vector" : [
                        3
                    ],
                    "text" : "rrf rrf rrf"
                }
            },
            {
                "_index" : "example-index",
                "_id" : "2",
                "_score" : null,
                "_rank" : 2,
                "_source" : {
                    "integer" : 2,
                    "vector" : [
                        4
                    ],
                    "text" : "rrf rrf"
                }
            },
            {
                "_index" : "example-index",
                "_id" : "4",
                "_score" : null,
                "_rank" : 3,
                "_source" : {
                    "integer" : 2,
                    "text" : "rrf rrf rrf rrf"
                }
            }
        ]
    },
    "aggregations" : {
        "int_count" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
                {
                    "key" : 1,
                    "doc_count" : 3
                },
                {
                    "key" : 2,
                    "doc_count" : 2
                }
            ]
        }
    }
}</pre>
</div>
<p>Let&#8217;s break down how these hits were ranked. We
start by running the query and the kNN search
separately to collect what their individual hits are.</p>
<p>First, we look at the hits for the query.</p>
<a id="464ec738d00e84f49c6c769b48bc049f"></a>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">"hits" : [
    {
        "_index" : "example-index",
        "_id" : "4",
        "_score" : 0.16152832,              <a id="CO783-1"></a><i class="conum" data-value="1"></i>
        "_source" : {
            "integer" : 2,
            "text" : "rrf rrf rrf rrf"
        }
    },
    {
        "_index" : "example-index",
        "_id" : "3",                        <a id="CO783-2"></a><i class="conum" data-value="2"></i>
        "_score" : 0.15876243,
        "_source" : {
            "integer" : 1,
            "vector" : [3],
            "text" : "rrf rrf rrf"
        }
    },
    {
        "_index" : "example-index",
        "_id" : "2",                        <a id="CO783-3"></a><i class="conum" data-value="3"></i>
        "_score" : 0.15350538,
        "_source" : {
            "integer" : 2,
            "vector" : [4],
            "text" : "rrf rrf"
        }
    },
    {
        "_index" : "example-index",
        "_id" : "1",                        <a id="CO783-4"></a><i class="conum" data-value="4"></i>
        "_score" : 0.13963442,
        "_source" : {
            "integer" : 1,
            "vector" : [5],
            "text" : "rrf"
        }
    }
]</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO783-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>rank 1, <code class="literal">_id</code> 4</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO783-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>rank 2, <code class="literal">_id</code> 3</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO783-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>rank 3, <code class="literal">_id</code> 2</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO783-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>rank 4, <code class="literal">_id</code> 1</p>
</td>
</tr>
</table>
</div>
<p>Note that our first hit doesn&#8217;t have a value for the <code class="literal">vector</code> field. Now,
we look at the results for the kNN search.</p>
<a id="18f499a1ac0619546f0e8834b77e559a"></a>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">"hits" : [
    {
        "_index" : "example-index",
        "_id" : "3",                   <a id="CO784-1"></a><i class="conum" data-value="1"></i>
        "_score" : 1.0,
        "_source" : {
            "integer" : 1,
            "vector" : [3],
            "text" : "rrf rrf rrf"
        }
    },
    {
        "_index" : "example-index",
        "_id" : "2",                   <a id="CO784-2"></a><i class="conum" data-value="2"></i>
        "_score" : 0.5,
        "_source" : {
            "integer" : 2,
            "vector" : [4],
            "text" : "rrf rrf"
        }
    },
    {
        "_index" : "example-index",
        "_id" : "1",                   <a id="CO784-3"></a><i class="conum" data-value="3"></i>
        "_score" : 0.2,
        "_source" : {
            "integer" : 1,
            "vector" : [5],
            "text" : "rrf"
        }
    },
    {
        "_index" : "example-index",
        "_id" : "5",                   <a id="CO784-4"></a><i class="conum" data-value="4"></i>
        "_score" : 0.1,
        "_source" : {
            "integer" : 1,
            "vector" : [0]
        }
    }
]</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO784-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>rank 1, <code class="literal">_id</code> 3</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO784-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>rank 2, <code class="literal">_id</code> 2</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO784-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>rank 3, <code class="literal">_id</code> 1</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO784-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>rank 4, <code class="literal">_id</code> 5</p>
</td>
</tr>
</table>
</div>
<p>We can now take the two individually ranked result sets and apply the
RRF formula to them to get our final ranking.</p>
<div class="pre_wrapper lang-python">
<pre class="programlisting prettyprint lang-python"># doc  | query     | knn       | score
_id: 1 = 1.0/(1+4) + 1.0/(1+3) = 0.4500
_id: 2 = 1.0/(1+3) + 1.0/(1+2) = 0.5833
_id: 3 = 1.0/(1+2) + 1.0/(1+1) = 0.8333
_id: 4 = 1.0/(1+1)             = 0.5000
_id: 5 =             1.0/(1+4) = 0.2000</pre>
</div>
<p>We rank the documents based on the RRF formula with a <code class="literal">window_size</code> of <code class="literal">5</code>
truncating the bottom <code class="literal">2</code> docs in our RRF result set with a <code class="literal">size</code> of <code class="literal">3</code>.
We end with <code class="literal">_id: 3</code> as <code class="literal">_rank: 1</code>, <code class="literal">_id: 2</code> as <code class="literal">_rank: 2</code>, and
<code class="literal">_id: 4</code> as <code class="literal">_rank: 3</code>. This ranking matches the result set from the
original RRF search as expected.</p>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="knn-search-api.html">« kNN search API</a>
</span>
<span class="next">
<a href="scroll-api.html">Scroll API »</a>
</span>
</div>
</div>
</body>
</html>
