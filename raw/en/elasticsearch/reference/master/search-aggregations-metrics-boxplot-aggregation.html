<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Boxplot aggregation | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Boxplot aggregation | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="search-aggregations-metrics.html" title="Metrics aggregations"/>
<link rel="prev" href="search-aggregations-metrics-avg-aggregation.html" title="Avg aggregation"/>
<link rel="next" href="search-aggregations-metrics-cardinality-aggregation.html" title="Cardinality aggregation"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="search-aggregations-metrics-avg-aggregation.html">« Avg aggregation</a>
</span>
<span class="next">
<a href="search-aggregations-metrics-cardinality-aggregation.html">Cardinality aggregation »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search-aggregations.html">Aggregations</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search-aggregations-metrics.html">Metrics aggregations</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Boxplot aggregation</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/boxplot-aggregation.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-metrics-boxplot-aggregation"></a>Boxplot aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/boxplot-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A <code class="literal">boxplot</code> metrics aggregation that computes boxplot of numeric values extracted from the aggregated documents.
These values can be generated from specific numeric or <a class="xref" href="histogram.html" title="Histogram field type">histogram fields</a> in the documents.</p>
<p>The <code class="literal">boxplot</code> aggregation returns essential information for making a <a href="https://en.wikipedia.org/wiki/Box_plot" class="ulink" target="_top">box plot</a>: minimum, maximum,
median, first quartile (25th percentile)  and third quartile (75th percentile) values.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_3"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/boxplot-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">boxplot</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">{
  "boxplot": {
    "field": "load_time"
  }
}</pre>
</div>
<p>Let&#8217;s look at a boxplot representing load time:</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'latency',
  body: {
    size: 0,
    aggregations: {
      load_time_boxplot: {
        boxplot: {
          field: 'load_time'
        }
      }
    }
  }
)
puts response</pre>
</div>
<a id="2a287d213a812b98d8353c563a058cfc"></a>
<div class="pre_wrapper lang-console default has-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby">GET latency/_search
{
  "size": 0,
  "aggs": {
    "load_time_boxplot": {
      "boxplot": {
        "field": "load_time" <a id="CO363-5"></a><i class="conum" data-value="1"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-ruby" data-snippet="snippets/1537.console"></div>
<div class="calloutlist default has-ruby lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO363-1"><i class="conum" data-value="1"></i></a><a href="#CO363-3"></a><a href="#CO363-5"></a></p>
</td>
<td align="left" valign="top">
<p>The field <code class="literal">load_time</code> must be a numeric field</p>
</td>
</tr>
</table>
</div>
<p>The response will look like this:</p>
<a id="e98619ded45bbd6448eedf4d0ff9aaac"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  ...

 "aggregations": {
    "load_time_boxplot": {
      "min": 0.0,
      "max": 990.0,
      "q1": 167.5,
      "q2": 445.0,
      "q3": 722.5,
      "lower": 0.0,
      "upper": 990.0
    }
  }
}</pre>
</div>
<p>In this case, the lower and upper whisker values are equal to the min and max. In general, these values are the 1.5 *
IQR range, which is to say the nearest values to <code class="literal">q1 - (1.5 * IQR)</code> and <code class="literal">q3 + (1.5 * IQR)</code>. Since this is an approximation, the given values
may not actually be observed values from the data, but should be within a reasonable error bound of them. While the Boxplot aggregation
doesn&#8217;t directly return outlier points, you can check if <code class="literal">lower &gt; min</code> or <code class="literal">upper &lt; max</code> to see if outliers exist on either side, and then
query for them directly.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_script_3"></a>Script<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/boxplot-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>If you need to create a boxplot for values that aren&#8217;t indexed exactly you
should create a <a class="xref" href="runtime.html" title="Runtime fields">runtime field</a> and get the boxplot of that. For
example, if your load times are in milliseconds but you want values calculated
in seconds, use a runtime field to convert them:</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'latency',
  body: {
    size: 0,
    runtime_mappings: {
      'load_time.seconds' =&gt; {
        type: 'long',
        script: {
          source: "emit(doc['load_time'].value / params.timeUnit)",
          params: {
            "timeUnit": 1000
          }
        }
      }
    },
    aggregations: {
      load_time_boxplot: {
        boxplot: {
          field: 'load_time.seconds'
        }
      }
    }
  }
)
puts response</pre>
</div>
<a id="f0bfc8d7ab4eb94ea5fdf2e087d8cf5b"></a>
<div class="pre_wrapper lang-console default has-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby">GET latency/_search
{
  "size": 0,
  "runtime_mappings": {
    "load_time.seconds": {
      "type": "long",
      "script": {
        "source": "emit(doc['load_time'].value / params.timeUnit)",
        "params": {
          "timeUnit": 1000
        }
      }
    }
  },
  "aggs": {
    "load_time_boxplot": {
      "boxplot": { "field": "load_time.seconds" }
    }
  }
}</pre>
</div>
<div class="console_widget has-ruby" data-snippet="snippets/1538.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="search-aggregations-metrics-boxplot-aggregation-approximation"></a>Boxplot values are (usually) approximate<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/boxplot-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The algorithm used by the <code class="literal">boxplot</code> metric is called TDigest (introduced by
Ted Dunning in
<a href="https://github.com/tdunning/t-digest/blob/master/docs/t-digest-paper/histo.pdf" class="ulink" target="_top">Computing Accurate Quantiles using T-Digests</a>).</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Boxplot as other percentile aggregations are also
<a href="https://en.wikipedia.org/wiki/Nondeterministic_algorithm" class="ulink" target="_top">non-deterministic</a>.
This means you can get slightly different results using the same data.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="search-aggregations-metrics-boxplot-aggregation-compression"></a>Compression<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/boxplot-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>Approximate algorithms must balance memory utilization with estimation accuracy.
This balance can be controlled using a <code class="literal">compression</code> parameter:</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'latency',
  body: {
    size: 0,
    aggregations: {
      load_time_boxplot: {
        boxplot: {
          field: 'load_time',
          compression: 200
        }
      }
    }
  }
)
puts response</pre>
</div>
<a id="08a76b3f5a8394d8f9084113334a260a"></a>
<div class="pre_wrapper lang-console default has-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby">GET latency/_search
{
  "size": 0,
  "aggs": {
    "load_time_boxplot": {
      "boxplot": {
        "field": "load_time",
        "compression": 200    <a id="CO364-1"></a><i class="conum" data-value="1"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-ruby" data-snippet="snippets/1539.console"></div>
<div class="calloutlist default has-ruby lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO364-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Compression controls memory usage and approximation error</p>
</td>
</tr>
</table>
</div>
<p>The TDigest algorithm uses a number of "nodes" to approximate percentiles&#8201;&#8212;&#8201;the
more nodes available, the higher the accuracy (and large memory footprint) proportional
to the volume of data. The <code class="literal">compression</code> parameter limits the maximum number of
nodes to <code class="literal">20 * compression</code>.</p>
<p>Therefore, by increasing the compression value, you can increase the accuracy of
your percentiles at the cost of more memory. Larger compression values also
make the algorithm slower since the underlying tree data structure grows in size,
resulting in more expensive operations. The default compression value is
<code class="literal">100</code>.</p>
<p>A "node" uses roughly 32 bytes of memory, so under worst-case scenarios (large amount
of data which arrives sorted and in-order) the default settings will produce a
TDigest roughly 64KB in size. In practice data tends to be more random and
the TDigest will use less memory.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_execution_hint_3"></a>Execution hint<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/boxplot-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The default implementation of TDigest is optimized for performance, scaling to millions or even
billions of sample values while maintaining acceptable accuracy levels (close to 1% relative error
for millions of samples in some cases). There&#8217;s an option to use an implementation optimized
for accuracy by setting parameter <code class="literal">execution_hint</code> to value <code class="literal">high_accuracy</code>:</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'latency',
  body: {
    size: 0,
    aggregations: {
      load_time_boxplot: {
        boxplot: {
          field: 'load_time',
          execution_hint: 'high_accuracy'
        }
      }
    }
  }
)
puts response</pre>
</div>
<a id="2bc1d52efec2076dc9fc2a3a2d90e8ab"></a>
<div class="pre_wrapper lang-console default has-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby">GET latency/_search
{
  "size": 0,
  "aggs": {
    "load_time_boxplot": {
      "boxplot": {
        "field": "load_time",
        "execution_hint": "high_accuracy"    <a id="CO365-1"></a><i class="conum" data-value="1"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-ruby" data-snippet="snippets/1540.console"></div>
<div class="calloutlist default has-ruby lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO365-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Optimize TDigest for accuracy, at the expense of performance</p>
</td>
</tr>
</table>
</div>
<p>This option can lead to improved accuracy (relative error close to 0.01% for millions of samples in some
cases) but then percentile queries take 2x-10x longer to complete.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_missing_value_7"></a>Missing value<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/aggregations/metrics/boxplot-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">missing</code> parameter defines how documents that are missing a value should be treated.
By default they will be ignored but it is also possible to treat them as if they
had a value.</p>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'latency',
  body: {
    size: 0,
    aggregations: {
      grade_boxplot: {
        boxplot: {
          field: 'grade',
          missing: 10
        }
      }
    }
  }
)
puts response</pre>
</div>
<a id="8696ba08ca6cc4992110c331732e5f47"></a>
<div class="pre_wrapper lang-console default has-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-ruby">GET latency/_search
{
  "size": 0,
  "aggs": {
    "grade_boxplot": {
      "boxplot": {
        "field": "grade",
        "missing": 10     <a id="CO366-1"></a><i class="conum" data-value="1"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget has-ruby" data-snippet="snippets/1541.console"></div>
<div class="calloutlist default has-ruby lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO366-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Documents without a value in the <code class="literal">grade</code> field will fall into the same bucket as documents that have the value <code class="literal">10</code>.</p>
</td>
</tr>
</table>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="search-aggregations-metrics-avg-aggregation.html">« Avg aggregation</a>
</span>
<span class="next">
<a href="search-aggregations-metrics-cardinality-aggregation.html">Cardinality aggregation »</a>
</span>
</div>
</body>
</html>
