<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tutorial: semantic search with the inference API | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Tutorial: semantic search with the inference API | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="semantic-search.html" title="Semantic search"/>
<link rel="prev" href="semantic-search-elser.html" title="Tutorial: semantic search with ELSER"/>
<link rel="next" href="modules-cross-cluster-search.html" title="Search across clusters"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search-with-elasticsearch.html">Search your data</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="semantic-search.html">Semantic search</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="semantic-search-elser.html">« Tutorial: semantic search with ELSER</a>
</span>
<span class="next">
<a href="modules-cross-cluster-search.html">Search across clusters »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="semantic-search-inference"></a>Tutorial: semantic search with the inference API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/semantic-search-inference.asciidoc">edit</a></h2>
</div></div></div>

<p>The instructions in this tutorial shows you how to use the inference API with
various services to perform semantic search on your data. The following examples
use Cohere&#8217;s <code class="literal">embed-english-light-v3.0</code> model and OpenAI&#8217;s
<code class="literal">text-embedding-ada-002</code> second generation embedding model. You can use any
Cohere and OpenAI models, they are all supported by the inference API.</p>
<p>Click the name of the service you want to use on any of the widgets below to
review the corresponding instructions.</p>
<h4><a id="infer-service-requirements"></a>Requirements<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/semantic-search-inference.asciidoc">edit</a></h4>
<div class="tabs" data-tab-group="model">
  <div role="tablist" aria-label="model">
    <button role="tab"
            aria-selected="true"
            aria-controls="infer-api-requirements-cohere-tab"
            id="infer-api-requirements-cohere">
      Cohere
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="infer-api-requirements-openai-tab"
            id="infer-api-requirements-openai">
      OpenAI
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="infer-api-requirements-cohere-tab"
       aria-labelledby="infer-api-requirements-cohere">
<p>A <a href="https://cohere.com/" class="ulink" target="_top">Cohere account</a> is required to use the inference API with
the Cohere service.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="infer-api-requirements-openai-tab"
       aria-labelledby="infer-api-requirements-openai"
       hidden="">
<p>An <a href="https://openai.com/" class="ulink" target="_top">OpenAI account</a> is required to use the inference API with
the OpenAI service.</p>
  </div>
</div>
<h4><a id="infer-text-embedding-task"></a>Create the inference task<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/semantic-search-inference.asciidoc">edit</a></h4>
<p>Create the inference task by using the <a class="xref" href="put-inference-api.html" title="Create inference API">Create inference API</a>:</p>
<div class="tabs" data-tab-group="model">
  <div role="tablist" aria-label="model">
    <button role="tab"
            aria-selected="true"
            aria-controls="infer-api-task-cohere-tab"
            id="infer-api-task-cohere">
      Cohere
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="infer-api-task-openai-tab"
            id="infer-api-task-openai">
      OpenAI
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="infer-api-task-cohere-tab"
       aria-labelledby="infer-api-task-cohere">
<a id="4bcbc31c935179c148e9b7fdd0258c88"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _inference/text_embedding/cohere_embeddings <a id="CO236-1"></a><i class="conum" data-value="1"></i>
{
    "service": "cohere",
    "service_settings": {
        "api_key": "&lt;api_key&gt;", <a id="CO236-2"></a><i class="conum" data-value="2"></i>
        "model_id": "embed-english-light-v3.0", <a id="CO236-3"></a><i class="conum" data-value="3"></i>
        "embedding_type": "int8"
    },
    "task_settings": {
    }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1029.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO236-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The task type is <code class="literal">text_embedding</code> in the path.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO236-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The API key of your Cohere account. You can find your API keys in your
Cohere dashboard under the
<a href="https://dashboard.cohere.com/api-keys" class="ulink" target="_top">API keys section</a>. You need to provide
your API key only once. The <a class="xref" href="get-inference-api.html" title="Get inference API">Get inference API</a> does not return your API
key.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO236-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the embedding model to use. You can find the list of Cohere
embedding models <a href="https://docs.cohere.com/reference/embed" class="ulink" target="_top">here</a>.</p>
</td>
</tr>
</table>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="infer-api-task-openai-tab"
       aria-labelledby="infer-api-task-openai"
       hidden="">
<a id="4e864ffe4525e5f656924bab76fc20b6"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _inference/text_embedding/openai_embeddings <a id="CO237-1"></a><i class="conum" data-value="1"></i>
{
    "service": "openai",
    "service_settings": {
        "api_key": "&lt;api_key&gt;", <a id="CO237-2"></a><i class="conum" data-value="2"></i>
        "model_id": "text-embedding-ada-002" <a id="CO237-3"></a><i class="conum" data-value="3"></i>
    },
    "task_settings": {
    }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1030.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO237-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The task type is <code class="literal">text_embedding</code> in the path.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO237-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The API key of your OpenAI account. You can find your OpenAI API keys in
your OpenAI account under the
<a href="https://platform.openai.com/api-keys" class="ulink" target="_top">API keys section</a>. You need to provide
your API key only once. The <a class="xref" href="get-inference-api.html" title="Get inference API">Get inference API</a> does not return your API
key.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO237-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the embedding model to use. You can find the list of OpenAI
embedding models
<a href="https://platform.openai.com/docs/guides/embeddings/embedding-models" class="ulink" target="_top">here</a>.</p>
</td>
</tr>
</table>
</div>
  </div>
</div>
<h4><a id="infer-service-mappings"></a>Create the index mapping<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/semantic-search-inference.asciidoc">edit</a></h4>
<p>The mapping of the destination index - the index that contains the embeddings
that the model will create based on your input text - must be created. The
destination index must have a field with the <a class="xref" href="dense-vector.html" title="Dense vector field type"><code class="literal">dense_vector</code></a>
field type to index the output of the used model.</p>
<div class="tabs" data-tab-group="model">
  <div role="tablist" aria-label="model">
    <button role="tab"
            aria-selected="true"
            aria-controls="infer-api-mapping-cohere-tab"
            id="infer-api-mapping-cohere">
      Cohere
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="infer-api-mapping-openai-tab"
            id="infer-api-mapping-openai">
      OpenAI
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="infer-api-mapping-cohere-tab"
       aria-labelledby="infer-api-mapping-cohere">
<a id="40535aff22539501afa90ba1785082ad"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT cohere-embeddings
{
  "mappings": {
    "properties": {
      "content_embedding": { <a id="CO238-1"></a><i class="conum" data-value="1"></i>
        "type": "dense_vector", <a id="CO238-2"></a><i class="conum" data-value="2"></i>
        "dims": 384, <a id="CO238-3"></a><i class="conum" data-value="3"></i>
        "element_type": "float"
      },
      "content": { <a id="CO238-4"></a><i class="conum" data-value="4"></i>
        "type": "text" <a id="CO238-5"></a><i class="conum" data-value="5"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1031.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO238-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the field to contain the generated tokens. It must be refrenced
in the inference pipeline configuration in the next step.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO238-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The field to contain the tokens is a <code class="literal">dense_vector</code> field.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO238-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The output dimensions of the model. Find this value in the
<a href="https://docs.cohere.com/reference/embed" class="ulink" target="_top">Cohere documentation</a> of the model you
use.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO238-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the field from which to create the dense vector representation.
In this example, the name of the field is <code class="literal">content</code>. It must be referenced in
the inference pipeline configuration in the next step.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO238-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>The field type which is text in this example.</p>
</td>
</tr>
</table>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="infer-api-mapping-openai-tab"
       aria-labelledby="infer-api-mapping-openai"
       hidden="">
<a id="e930a572e8ddfdecc13498c04007b9e3"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT openai-embeddings
{
  "mappings": {
    "properties": {
      "content_embedding": { <a id="CO239-1"></a><i class="conum" data-value="1"></i>
        "type": "dense_vector", <a id="CO239-2"></a><i class="conum" data-value="2"></i>
        "dims": 1536, <a id="CO239-3"></a><i class="conum" data-value="3"></i>
        "element_type": "float",
        "similarity": "dot_product" <a id="CO239-4"></a><i class="conum" data-value="4"></i>
      },
      "content": { <a id="CO239-5"></a><i class="conum" data-value="5"></i>
        "type": "text" <a id="CO239-6"></a><i class="conum" data-value="6"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1032.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO239-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the field to contain the generated tokens. It must be refrenced
in the inference pipeline configuration in the next step.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO239-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The field to contain the tokens is a <code class="literal">dense_vector</code> field.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO239-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The output dimensions of the model. Find this value in the
<a href="https://platform.openai.com/docs/guides/embeddings/embedding-models" class="ulink" target="_top">OpenAI documentation</a>
of the model you use.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO239-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The faster` dot_product` function can be used to calculate similarity
because OpenAI embeddings are normalised to unit length. You can check the
<a href="https://platform.openai.com/docs/guides/embeddings/which-distance-function-should-i-use" class="ulink" target="_top">OpenAI docs</a>
about which similarity function to use.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO239-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the field from which to create the dense vector representation.
In this example, the name of the field is <code class="literal">content</code>. It must be referenced in
the inference pipeline configuration in the next step.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO239-6"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>The field type which is text in this example.</p>
</td>
</tr>
</table>
</div>
  </div>
</div>
<h4><a id="infer-service-inference-ingest-pipeline"></a>Create an ingest pipeline with an inference processor<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/semantic-search-inference.asciidoc">edit</a></h4>
<p>Create an <a class="xref" href="ingest.html" title="Ingest pipelines">ingest pipeline</a> with an
<a class="xref" href="inference-processor.html" title="Inference processor">inference processor</a> and use the model you created above to
infer against the data that is being ingested in the pipeline.</p>
<div class="tabs" data-tab-group="model">
  <div role="tablist" aria-label="model">
    <button role="tab"
            aria-selected="true"
            aria-controls="infer-api-ingest-cohere-tab"
            id="infer-api-ingest-cohere">
      Cohere
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="infer-api-ingest-openai-tab"
            id="infer-api-ingest-openai">
      OpenAI
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="infer-api-ingest-cohere-tab"
       aria-labelledby="infer-api-ingest-cohere">
<a id="3a7a6ab88a49b484fafb10c8eb09b562"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ingest/pipeline/cohere_embeddings
{
  "processors": [
    {
      "inference": {
        "model_id": "cohere_embeddings", <a id="CO240-1"></a><i class="conum" data-value="1"></i>
        "input_output": { <a id="CO240-2"></a><i class="conum" data-value="2"></i>
          "input_field": "content",
          "output_field": "content_embedding"
        }
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1033.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO240-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the inference configuration you created by using the
<a class="xref" href="put-inference-api.html" title="Create inference API">Create inference API</a>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO240-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Configuration object that defines the <code class="literal">input_field</code> for the inference process
and the <code class="literal">output_field</code> that will contain the inference results.</p>
</td>
</tr>
</table>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="infer-api-ingest-openai-tab"
       aria-labelledby="infer-api-ingest-openai"
       hidden="">
<div class="pre_wrapper lang-ruby alternative">
<pre class="programlisting prettyprint lang-ruby alternative">response = client.ingest.put_pipeline(
  id: 'openai_embeddings',
  body: {
    processors: [
      {
        inference: {
          model_id: 'openai_embeddings',
          input_output: {
            input_field: 'content',
            output_field: 'content_embedding'
          }
        }
      }
    ]
  }
)
puts response</pre>
</div>
<a id="a53ff77d83222c0e76453e630d64787e"></a>
<div class="pre_wrapper lang-console default has-ruby">
<pre class="programlisting prettyprint lang-console default has-ruby">PUT _ingest/pipeline/openai_embeddings
{
  "processors": [
    {
      "inference": {
        "model_id": "openai_embeddings", <a id="CO241-1"></a><i class="conum" data-value="1"></i>
        "input_output": { <a id="CO241-2"></a><i class="conum" data-value="2"></i>
          "input_field": "content",
          "output_field": "content_embedding"
        }
      }
    }
  ]
}</pre>
</div>
<div class="console_widget has-ruby" data-snippet="snippets/1034.console"></div>
<div class="calloutlist default has-ruby lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO241-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the inference configuration you created by using the
<a class="xref" href="put-inference-api.html" title="Create inference API">Create inference API</a>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO241-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Configuration object that defines the <code class="literal">input_field</code> for the inference process
and the <code class="literal">output_field</code> that will contain the inference results.</p>
</td>
</tr>
</table>
</div>
  </div>
</div>
<h4><a id="infer-load-data"></a>Load data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/semantic-search-inference.asciidoc">edit</a></h4>
<p>In this step, you load the data that you later use in the inference ingest
pipeline to create embeddings from it.</p>
<p>Use the <code class="literal">msmarco-passagetest2019-top1000</code> data set, which is a subset of the MS
MARCO Passage Ranking data set. It consists of 200 queries, each accompanied by
a list of relevant text passages. All unique passages, along with their IDs,
have been extracted from that data set and compiled into a
<a href="https://github.com/elastic/stack-docs/blob/main/docs/en/stack/ml/nlp/data/msmarco-passagetest2019-unique.tsv" class="ulink" target="_top">tsv file</a>.</p>
<p>Download the file and upload it to your cluster using the
<a href="/guide/en/kibana/master/connect-to-elasticsearch.html#upload-data-kibana" class="ulink" target="_top">Data Visualizer</a>
in the Machine Learning UI. Assign the name <code class="literal">id</code> to the first column and <code class="literal">content</code> to
the second column. The index name is <code class="literal">test-data</code>. Once the upload is complete,
you can see an index named <code class="literal">test-data</code> with 182469 documents.</p>
<h4><a id="reindexing-data-infer"></a>Ingest the data through the inference ingest pipeline<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/semantic-search-inference.asciidoc">edit</a></h4>
<p>Create the embeddings from the text by reindexing the data through the inference
pipeline that uses the chosen model as the inference model.</p>
<div class="tabs" data-tab-group="model">
  <div role="tablist" aria-label="model">
    <button role="tab"
            aria-selected="true"
            aria-controls="infer-api-reindex-cohere-tab"
            id="infer-api-reindex-cohere">
      Cohere
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="infer-api-reindex-openai-tab"
            id="infer-api-reindex-openai">
      OpenAI
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="infer-api-reindex-cohere-tab"
       aria-labelledby="infer-api-reindex-cohere">
<a id="84490ee2c6c07dbd2101ce2e3751e1aa"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _reindex?wait_for_completion=false
{
  "source": {
    "index": "test-data",
    "size": 50 <a id="CO242-1"></a><i class="conum" data-value="1"></i>
  },
  "dest": {
    "index": "cohere-embeddings",
    "pipeline": "cohere_embeddings"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1035.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO242-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The default batch size for reindexing is 1000. Reducing <code class="literal">size</code> to a smaller
number makes the update of the reindexing process quicker which enables you to
follow the progress closely and detect errors early.</p>
</td>
</tr>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The
<a href="https://dashboard.cohere.com/billing" class="ulink" target="_top">rate limit of your Cohere account</a>
may affect the throughput of the reindexing process.</p>
</div>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="infer-api-reindex-openai-tab"
       aria-labelledby="infer-api-reindex-openai"
       hidden="">
<div class="pre_wrapper lang-ruby alternative">
<pre class="programlisting prettyprint lang-ruby alternative">response = client.reindex(
  wait_for_completion: false,
  body: {
    source: {
      index: 'test-data',
      size: 50
    },
    dest: {
      index: 'openai-embeddings',
      pipeline: 'openai_embeddings'
    }
  }
)
puts response</pre>
</div>
<a id="65e892a362d940e4a74965f21c15ca09"></a>
<div class="pre_wrapper lang-console default has-ruby">
<pre class="programlisting prettyprint lang-console default has-ruby">POST _reindex?wait_for_completion=false
{
  "source": {
    "index": "test-data",
    "size": 50 <a id="CO243-1"></a><i class="conum" data-value="1"></i>
  },
  "dest": {
    "index": "openai-embeddings",
    "pipeline": "openai_embeddings"
  }
}</pre>
</div>
<div class="console_widget has-ruby" data-snippet="snippets/1036.console"></div>
<div class="calloutlist default has-ruby lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO243-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The default batch size for reindexing is 1000. Reducing <code class="literal">size</code> to a smaller
number makes the update of the reindexing process quicker which enables you to
follow the progress closely and detect errors early.</p>
</td>
</tr>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The
<a href="https://platform.openai.com/account/limits" class="ulink" target="_top">rate limit of your OpenAI account</a>
may affect the throughput of the reindexing process. If this happens, change
<code class="literal">size</code> to <code class="literal">3</code> or a similar value in magnitude.</p>
</div>
</div>
  </div>
</div>
<p>The call returns a task ID to monitor the progress:</p>
<a id="8a1b6eae4893c5dd27b3d81fd8d70f5b"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET _tasks/&lt;task_id&gt;</pre>
</div>
<div class="console_widget" data-snippet="snippets/1037.console"></div>
<p>You can also cancel the reindexing process if you don&#8217;t want to wait until the
reindexing process is fully complete which might take hours:</p>
<a id="b0fe9a7c8e519995258786be4bef36c4"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _tasks/&lt;task_id&gt;/_cancel</pre>
</div>
<div class="console_widget" data-snippet="snippets/1038.console"></div>
<h4><a id="infer-semantic-search"></a>Semantic search<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/search/search-your-data/semantic-search-inference.asciidoc">edit</a></h4>
<p>After the dataset has been enriched with the embeddings, you can query the data
using <a href="/guide/en/elasticsearch/reference/master/knn-search.html#knn-semantic-search" class="ulink" target="_top">semantic search</a>. Pass a
<code class="literal">query_vector_builder</code> to the k-nearest neighbor (kNN) vector search API, and
provide the query text and the model you have used to create the embeddings.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you cancelled the reindexing process, you run the query only a part of
the data which affects the quality of your results.</p>
</div>
</div>
<div class="tabs" data-tab-group="model">
  <div role="tablist" aria-label="model">
    <button role="tab"
            aria-selected="true"
            aria-controls="infer-api-search-cohere-tab"
            id="infer-api-search-cohere">
      Cohere
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="infer-api-search-openai-tab"
            id="infer-api-search-openai">
      OpenAI
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="infer-api-search-cohere-tab"
       aria-labelledby="infer-api-search-cohere">
<a id="0bafbe0db5df8b32f45d674ed7f73afe"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET cohere-embeddings/_search
{
  "knn": {
    "field": "content_embedding",
    "query_vector_builder": {
      "text_embedding": {
        "model_id": "cohere_embeddings",
        "model_text": "Calculate fuel cost"
      }
    },
    "k": 10,
    "num_candidates": 100
  },
  "_source": [
    "id",
    "content"
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1039.console"></div>
<p>As a result, you receive the top 10 documents that are closest in meaning to the
query from the <code class="literal">cohere-embeddings</code> index sorted by their proximity to the query:</p>
<div class="pre_wrapper lang-consol-result">
<pre class="programlisting prettyprint lang-consol-result">"hits": [
      {
        "_index": "cohere-embeddings",
        "_id": "-eFWCY4BECzWLnMZuI78",
        "_score": 0.737484,
        "_source": {
          "id": 1690948,
          "content": "Oxygen is supplied to the muscles via red blood cells. Red blood cells carry hemoglobin which oxygen bonds with as the hemoglobin rich blood cells pass through the blood vessels of the lungs.The now oxygen rich blood cells carry that oxygen to the cells that are demanding it, in this case skeletal muscle cells.ther ways in which muscles are supplied with oxygen include: 1  Blood flow from the heart is increased. 2  Blood flow to your muscles in increased. 3  Blood flow from nonessential organs is transported to working muscles."
        }
      },
      {
        "_index": "cohere-embeddings",
        "_id": "HuFWCY4BECzWLnMZuI_8",
        "_score": 0.7176013,
        "_source": {
          "id": 1692482,
          "content": "The thoracic cavity is separated from the abdominal cavity by the  diaphragm. This is a broad flat muscle.    (muscular) diaphragm The diaphragm is a muscle that separat…e the thoracic from the abdominal cavity. The pelvis is the lowest part of the abdominal cavity and it has no physical separation from it    Diaphragm."
        }
      },
      {
        "_index": "cohere-embeddings",
        "_id": "IOFWCY4BECzWLnMZuI_8",
        "_score": 0.7154432,
        "_source": {
          "id": 1692489,
          "content": "Muscular Wall Separating the Abdominal and Thoracic Cavities; Thoracic Cavity of a Fetal Pig; In Mammals the Diaphragm Separates the Abdominal Cavity from the"
        }
      },
      {
        "_index": "cohere-embeddings",
        "_id": "C-FWCY4BECzWLnMZuI_8",
        "_score": 0.695313,
        "_source": {
          "id": 1691493,
          "content": "Burning, aching, tenderness and stiffness are just some descriptors of the discomfort you may feel in the muscles you exercised one to two days ago.For the most part, these sensations you experience after exercise are collectively known as delayed onset muscle soreness.urning, aching, tenderness and stiffness are just some descriptors of the discomfort you may feel in the muscles you exercised one to two days ago."
        }
      },
      (...)
    ]</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="infer-api-search-openai-tab"
       aria-labelledby="infer-api-search-openai"
       hidden="">
<div class="pre_wrapper lang-ruby alternative">
<pre class="programlisting prettyprint lang-ruby alternative">response = client.search(
  index: 'openai-embeddings',
  body: {
    knn: {
      field: 'content_embedding',
      query_vector_builder: {
        text_embedding: {
          model_id: 'openai_embeddings',
          model_text: 'Calculate fuel cost'
        }
      },
      k: 10,
      num_candidates: 100
    },
    _source: [
      'id',
      'content'
    ]
  }
)
puts response</pre>
</div>
<a id="34d63740b58209a3d031212909743925"></a>
<div class="pre_wrapper lang-console default has-ruby">
<pre class="programlisting prettyprint lang-console default has-ruby">GET openai-embeddings/_search
{
  "knn": {
    "field": "content_embedding",
    "query_vector_builder": {
      "text_embedding": {
        "model_id": "openai_embeddings",
        "model_text": "Calculate fuel cost"
      }
    },
    "k": 10,
    "num_candidates": 100
  },
  "_source": [
    "id",
    "content"
  ]
}</pre>
</div>
<div class="console_widget has-ruby" data-snippet="snippets/1040.console"></div>
<p>As a result, you receive the top 10 documents that are closest in meaning to the
query from the <code class="literal">openai-embeddings</code> index sorted by their proximity to the query:</p>
<div class="pre_wrapper lang-consol-result">
<pre class="programlisting prettyprint lang-consol-result">"hits": [
      {
        "_index": "openai-embeddings",
        "_id": "DDd5OowBHxQKHyc3TDSC",
        "_score": 0.83704096,
        "_source": {
          "id": 862114,
          "body": "How to calculate fuel cost for a road trip. By Tara Baukus Mello • Bankrate.com. Dear Driving for Dollars, My family is considering taking a long road trip to finish off the end of the summer, but I'm a little worried about gas prices and our overall fuel cost.It doesn't seem easy to calculate since we'll be traveling through many states and we are considering several routes.y family is considering taking a long road trip to finish off the end of the summer, but I'm a little worried about gas prices and our overall fuel cost. It doesn't seem easy to calculate since we'll be traveling through many states and we are considering several routes."
        }
      },
      {
        "_index": "openai-embeddings",
        "_id": "ajd5OowBHxQKHyc3TDSC",
        "_score": 0.8345704,
        "_source": {
          "id": 820622,
          "body": "Home Heating Calculator. Typically, approximately 50% of the energy consumed in a home annually is for space heating. When deciding on a heating system, many factors will come into play: cost of fuel, installation cost, convenience and life style are all important.This calculator can help you estimate the cost of fuel for different heating appliances.hen deciding on a heating system, many factors will come into play: cost of fuel, installation cost, convenience and life style are all important. This calculator can help you estimate the cost of fuel for different heating appliances."
        }
      },
      {
        "_index": "openai-embeddings",
        "_id": "Djd5OowBHxQKHyc3TDSC",
        "_score": 0.8327426,
        "_source": {
          "id": 8202683,
          "body": "Fuel is another important cost. This cost will depend on your boat, how far you travel, and how fast you travel. A 33-foot sailboat traveling at 7 knots should be able to travel 300 miles on 50 gallons of diesel fuel.If you are paying $4 per gallon, the trip would cost you $200.Most boats have much larger gas tanks than cars.uel is another important cost. This cost will depend on your boat, how far you travel, and how fast you travel. A 33-foot sailboat traveling at 7 knots should be able to travel 300 miles on 50 gallons of diesel fuel."
        }
      },
      (...)
    ]</pre>
</div>
  </div>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="semantic-search-elser.html">« Tutorial: semantic search with ELSER</a>
</span>
<span class="next">
<a href="modules-cross-cluster-search.html">Search across clusters »</a>
</span>
</div>
</div>
</body>
</html>
