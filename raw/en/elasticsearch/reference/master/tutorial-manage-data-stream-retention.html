<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tutorial: Data stream retention | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Tutorial: Data stream retention | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="data-stream-lifecycle.html" title="Data stream lifecycle"/>
<link rel="prev" href="tutorial-manage-existing-data-stream.html" title="Tutorial: Update existing data stream"/>
<link rel="next" href="tutorial-migrate-data-stream-from-ilm-to-dsl.html" title="Tutorial: Migrate ILM managed data stream to data stream lifecycle"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="tutorial-manage-existing-data-stream.html">« Tutorial: Update existing data stream</a>
</span>
<span class="next">
<a href="tutorial-migrate-data-stream-from-ilm-to-dsl.html">Tutorial: Migrate ILM managed data stream to data stream lifecycle »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="data-streams.html">Data streams</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="data-stream-lifecycle.html">Data stream lifecycle</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Tutorial: Data stream retention</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/data-streams/lifecycle/tutorial-manage-data-stream-retention.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="tutorial-manage-data-stream-retention"></a>Tutorial: Data stream retention<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/data-streams/lifecycle/tutorial-manage-data-stream-retention.asciidoc">edit</a></h2>
</div></div></div>
<p>In this tutorial, we are going to go over the data stream lifecycle retention; we will define it, go over how it can be configured
and how it can gets applied. Keep in mind, the following options apply only to data streams that are managed by the data stream lifecycle.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="tutorial-manage-data-stream-retention.html#what-is-retention" title="What is data stream retention?">What is data stream retention?</a>
</li>
<li class="listitem">
<a class="xref" href="tutorial-manage-data-stream-retention.html#retention-configuration" title="How to configure retention?">How to configure retention?</a>
</li>
<li class="listitem">
<a class="xref" href="tutorial-manage-data-stream-retention.html#effective-retention-calculation" title="How is the effective retention calculated?">How is the effective retention calculated?</a>
</li>
<li class="listitem">
<a class="xref" href="tutorial-manage-data-stream-retention.html#effective-retention-application" title="How is the effective retention applied?">How is the effective retention applied?</a>
</li>
</ol>
</div>
<p>You can verify if a data steam is managed by the data stream lifecycle via the <a class="xref" href="data-streams-get-lifecycle.html" title="Get the lifecycle of a data stream">get data stream lifecycle API</a>:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.get_data_lifecycle(
    name="my-data-stream",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.get_data_lifecycle(
  name: 'my-data-stream'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.getDataLifecycle({
  name: "my-data-stream",
});
console.log(response);</pre>
</div>
<a id="990c0d794ed6f05d1620b5d49f7aff6e"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET _data_stream/my-data-stream/_lifecycle</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/726.console"></div>
<p>The result should look like this:</p>
<a id="0de32538f0899d3352f942cb4efba245"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "data_streams": [
    {
      "name": "my-data-stream",                                   <a id="CO200-1"></a><i class="conum" data-value="1"></i>
      "lifecycle": {
        "enabled": true                                           <a id="CO200-2"></a><i class="conum" data-value="2"></i>
      }
    }
  ]
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO200-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of your data stream.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO200-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Ensure that the lifecycle is enabled, meaning this should be <code class="literal">true</code>.</p>
</td>
</tr>
</table>
</div>
<h4><a id="what-is-retention"></a>What is data stream retention?<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/data-streams/lifecycle/tutorial-manage-data-stream-retention.asciidoc">edit</a></h4>
<p>We define retention as the least amount of time the data of a data stream are going to be kept in Elasticsearch. After this time period
has passed, Elasticsearch is allowed to remove these data to free up space and/or manage costs.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Retention does not define the period that the data will be removed, but the minimum time period they will be kept.</p>
</div>
</div>
<p>We define 4 different types of retention:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The data stream retention, or <code class="literal">data_retention</code>, which is the retention configured on the data stream level. It can be
set via an <a class="xref" href="index-templates.html" title="Index templates">index template</a> for future data streams or via the <a class="xref" href="data-streams-put-lifecycle.html" title="Set the lifecycle of a data stream">PUT data
stream lifecycle API</a> for an existing data stream. When the data stream retention is not set, it implies that the data
need to be kept forever.
</li>
<li class="listitem">
The global default retention, let&#8217;s call it <code class="literal">default_retention</code>, which is a retention configured via the cluster setting
<a class="xref" href="data-stream-lifecycle-settings.html#data-streams-lifecycle-retention-default"><code class="literal">data_streams.lifecycle.retention.default</code></a> and will be
applied to all data streams managed by data stream lifecycle that do not have <code class="literal">data_retention</code> configured. Effectively,
it ensures that there will be no data streams keeping their data forever. This can be set via the
<a class="xref" href="cluster-update-settings.html" title="Cluster update settings API">update cluster settings API</a>.
</li>
<li class="listitem">
The global max retention, let&#8217;s call it <code class="literal">max_retention</code>, which is a retention configured via the cluster setting
<a class="xref" href="data-stream-lifecycle-settings.html#data-streams-lifecycle-retention-max"><code class="literal">data_streams.lifecycle.retention.max</code></a> and will be applied to
all data streams managed by data stream lifecycle. Effectively, it ensures that there will be no data streams whose retention
will exceed this time period. This can be set via the <a class="xref" href="cluster-update-settings.html" title="Cluster update settings API">update cluster settings API</a>.
</li>
<li class="listitem">
The effective retention, or <code class="literal">effective_retention</code>, which is the retention applied at a data stream on a given moment.
Effective retention cannot be set, it is derived by taking into account all the configured retention listed above and is
calculated as it is described <a class="xref" href="tutorial-manage-data-stream-retention.html#effective-retention-calculation" title="How is the effective retention calculated?">here</a>.
</li>
</ul>
</div>
<h4><a id="retention-configuration"></a>How to configure retention?<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/data-streams/lifecycle/tutorial-manage-data-stream-retention.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>By setting the <code class="literal">data_retention</code> on the data stream level. This retention can be configured in two ways:</p>
<p>&#8201;&#8212;&#8201;For new data streams, it can be defined in the index template that would be applied during the data stream&#8217;s creation.
You can use the <a class="xref" href="indices-put-template.html" title="Create or update index template API">create index template API</a>, for example:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.put_index_template(
    name="template",
    index_patterns=[
        "my-data-stream*"
    ],
    data_stream={},
    priority=500,
    template={
        "lifecycle": {
            "data_retention": "7d"
        }
    },
    meta={
        "description": "Template with data stream lifecycle"
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.putIndexTemplate({
  name: "template",
  index_patterns: ["my-data-stream*"],
  data_stream: {},
  priority: 500,
  template: {
    lifecycle: {
      data_retention: "7d",
    },
  },
  _meta: {
    description: "Template with data stream lifecycle",
  },
});
console.log(response);</pre>
</div>
<a id="8f2875d976332cf5da8fb7764097a307"></a>
<div class="pre_wrapper lang-console default has-python has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-js">PUT _index_template/template
{
  "index_patterns": ["my-data-stream*"],
  "data_stream": { },
  "priority": 500,
  "template": {
    "lifecycle": {
      "data_retention": "7d"
    }
  },
  "_meta": {
    "description": "Template with data stream lifecycle"
  }
}</pre>
</div>
<div class="console_widget has-python has-js" data-snippet="snippets/727.console"></div>
<p>&#8201;&#8212;&#8201;For an existing data stream, it can be set via the <a class="xref" href="data-streams-put-lifecycle.html" title="Set the lifecycle of a data stream">PUT lifecycle API</a>.</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.put_data_lifecycle(
    name="my-data-stream",
    data_retention="30d",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.put_data_lifecycle(
  name: 'my-data-stream',
  body: {
    data_retention: '30d'
  }
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.putDataLifecycle({
  name: "my-data-stream",
  data_retention: "30d",
});
console.log(response);</pre>
</div>
<a id="1736545c8b5674f6d311f3277eb387f1"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">PUT _data_stream/my-data-stream/_lifecycle
{
  "data_retention": "30d" <a id="CO201-1"></a><i class="conum" data-value="1"></i>
}</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/728.console"></div>
<div class="calloutlist default has-python has-ruby has-js lang-console">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO201-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The retention period of this data stream is set to 30 days.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>By setting the global retention via the <code class="literal">data_streams.lifecycle.retention.default</code> and/or <code class="literal">data_streams.lifecycle.retention.max</code>
that are set on a cluster level. You can be set via the <a class="xref" href="cluster-update-settings.html" title="Cluster update settings API">update cluster settings API</a>. For example:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.cluster.put_settings(
    persistent={
        "data_streams.lifecycle.retention.default": "7d",
        "data_streams.lifecycle.retention.max": "90d"
    },
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.cluster.putSettings({
  persistent: {
    "data_streams.lifecycle.retention.default": "7d",
    "data_streams.lifecycle.retention.max": "90d",
  },
});
console.log(response);</pre>
</div>
<a id="e7cfe670b4177d1011076f845ec2916c"></a>
<div class="pre_wrapper lang-console default has-python has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-js">PUT /_cluster/settings
{
  "persistent" : {
    "data_streams.lifecycle.retention.default" : "7d",
    "data_streams.lifecycle.retention.max" : "90d"
  }
}</pre>
</div>
<div class="console_widget has-python has-js" data-snippet="snippets/729.console"></div>
</li>
</ul>
</div>
<h4><a id="effective-retention-calculation"></a>How is the effective retention calculated?<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/data-streams/lifecycle/tutorial-manage-data-stream-retention.asciidoc">edit</a></h4>
<p>The effective is calculated in the following way:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The <code class="literal">effective_retention</code> is the <code class="literal">default_retention</code>, when <code class="literal">default_retention</code> is defined and the data stream does not
have <code class="literal">data_retention</code>.
</li>
<li class="listitem">
The <code class="literal">effective_retention</code> is the <code class="literal">data_retention</code>, when <code class="literal">data_retention</code> is defined and if <code class="literal">max_retention</code> is defined,
it is less than the <code class="literal">max_retention</code>.
</li>
<li class="listitem">
The <code class="literal">effective_retention</code> is the <code class="literal">max_retention</code>, when <code class="literal">max_retention</code> is defined, and the data stream has either no
<code class="literal">data_retention</code> or its <code class="literal">data_retention</code> is greater than the <code class="literal">max_retention</code>.
</li>
</ul>
</div>
<p>The above is demonstrated in the examples below:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
<col class="col_5"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top"><code class="literal">default_retention</code></th>
<th align="left" valign="top"><code class="literal">max_retention</code></th>
<th align="left" valign="top"><code class="literal">data_retention</code></th>
<th align="left" valign="top"><code class="literal">effective_retention</code></th>
<th align="left" valign="top">Retention determined by</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>Not set</p></td>
<td align="left" valign="top"><p>Not set</p></td>
<td align="left" valign="top"><p>Not set</p></td>
<td align="left" valign="top"><p>Infinite</p></td>
<td align="left" valign="top"><p>N/A</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Not relevant</p></td>
<td align="left" valign="top"><p>12 months</p></td>
<td align="left" valign="top"><p><span class="strong strong"><strong>30 days</strong></span></p></td>
<td align="left" valign="top"><p>30 days</p></td>
<td align="left" valign="top"><p><code class="literal">data_retention</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Not relevant</p></td>
<td align="left" valign="top"><p>Not set</p></td>
<td align="left" valign="top"><p><span class="strong strong"><strong>30 days</strong></span></p></td>
<td align="left" valign="top"><p>30 days</p></td>
<td align="left" valign="top"><p><code class="literal">data_retention</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>30 days</strong></span></p></td>
<td align="left" valign="top"><p>12 months</p></td>
<td align="left" valign="top"><p>Not set</p></td>
<td align="left" valign="top"><p>30 days</p></td>
<td align="left" valign="top"><p><code class="literal">default_retention</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>30 days</strong></span></p></td>
<td align="left" valign="top"><p>30 days</p></td>
<td align="left" valign="top"><p>Not set</p></td>
<td align="left" valign="top"><p>30 days</p></td>
<td align="left" valign="top"><p><code class="literal">default_retention</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Not relevant</p></td>
<td align="left" valign="top"><p><span class="strong strong"><strong>30 days</strong></span></p></td>
<td align="left" valign="top"><p>12 months</p></td>
<td align="left" valign="top"><p>30 days</p></td>
<td align="left" valign="top"><p><code class="literal">max_retention</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Not set</p></td>
<td align="left" valign="top"><p><span class="strong strong"><strong>30 days</strong></span></p></td>
<td align="left" valign="top"><p>Not set</p></td>
<td align="left" valign="top"><p>30 days</p></td>
<td align="left" valign="top"><p><code class="literal">max_retention</code></p></td>
</tr>
</tbody>
</table>
</div>
<p>Considering our example, if we retrieve the lifecycle of <code class="literal">my-data-stream</code>:</p>
<div class="pre_wrapper lang-python alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-python alternative">resp = client.indices.get_data_lifecycle(
    name="my-data-stream",
)
print(resp)</pre>
</div>
<div class="pre_wrapper lang-ruby alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby alternative">response = client.indices.get_data_lifecycle(
  name: 'my-data-stream'
)
puts response</pre>
</div>
<div class="pre_wrapper lang-js alternative">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js alternative">const response = await client.indices.getDataLifecycle({
  name: "my-data-stream",
});
console.log(response);</pre>
</div>
<a id="990c0d794ed6f05d1620b5d49f7aff6e"></a>
<div class="pre_wrapper lang-console default has-python has-ruby has-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console default has-python has-ruby has-js">GET _data_stream/my-data-stream/_lifecycle</pre>
</div>
<div class="console_widget has-python has-ruby has-js" data-snippet="snippets/730.console"></div>
<p>We see that it will remain the same with what the user configured:</p>
<a id="56780149f01a73a29f3f66ef23ea72f8"></a>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "data_streams": [
    {
      "name": "my-data-stream",
      "lifecycle": {
        "enabled": true,
        "data_retention": "30d",
        "effective_retention": "30d",
        "retention_determined_by": "data_stream_configuration"
      }
    }
  ]
}</pre>
</div>
<h4><a id="effective-retention-application"></a>How is the effective retention applied?<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/data-streams/lifecycle/tutorial-manage-data-stream-retention.asciidoc">edit</a></h4>
<p>Retention is applied to the remaining backing indices of a data stream as the last step of
<a class="xref" href="data-stream-lifecycle.html#data-streams-lifecycle-how-it-works" title="How does it work?">a data stream lifecycle run</a>. Data stream lifecycle will retrieve the backing indices
whose <code class="literal">generation_time</code> is longer than the effective retention period and delete them. The <code class="literal">generation_time</code> is only
applicable to rolled over backing indices and it is either the time since the backing index got rolled over, or the time
optionally configured in the <a class="xref" href="data-stream-lifecycle-settings.html#index-data-stream-lifecycle-origination-date"><code class="literal">index.lifecycle.origination_date</code></a> setting.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>We use the <code class="literal">generation_time</code> instead of the creation time because this ensures that all data in the backing
index have passed the retention period. As a result, the retention period is not the exact time data get deleted, but
the minimum time data will be stored.</p>
</div>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="tutorial-manage-existing-data-stream.html">« Tutorial: Update existing data stream</a>
</span>
<span class="next">
<a href="tutorial-migrate-data-stream-from-ilm-to-dsl.html">Tutorial: Migrate ILM managed data stream to data stream lifecycle »</a>
</span>
</div>
</body>
</html>
