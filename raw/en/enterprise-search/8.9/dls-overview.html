<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>How DLS works | Enterprise Search documentation [8.9] | Elastic</title>
<meta class="elastic" name="content" content="How DLS works | Enterprise Search documentation [8.9]">

<link rel="home" href="index.html" title="Enterprise Search documentation [8.9]"/>
<link rel="up" href="dls.html" title="Document level security"/>
<link rel="prev" href="dls.html" title="Document level security"/>
<link rel="next" href="dls-e2e-guide.html" title="Leverage document-level security from connectors in Search Applications"/>
<meta class="elastic" name="product_version" content="8.9"/>
<meta class="elastic" name="product_name" content="Enterprise Search"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Enterprise Search/Guide/8.9"/>
<meta name="DC.subject" content="Enterprise Search"/>
<meta name="DC.identifier" content="8.9"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link">
<div id="related-products" class="dropdown">
<div class="related-products-title"></div>
<div class="dropdown-anchor" tabindex="0">Enterprise Search<span class="dropdown-icon"></span></div>
<div class="dropdown-content">
<ul>
<li class="dropdown-category">Enterprise Search guides</li>
<ul>
<li><a href="/guide/en/enterprise-search/current/index.html" target="_blank">Enterprise Search</a></li>
<li><a href="/guide/en/app-search/current/index.html" target="_blank">App Search</a></li>
<li><a href="/guide/en/workplace-search/current/index.html" target="_blank">Workplace Search</a></li>
</ul>
<li class="dropdown-category">Programming language clients</li>
<ul>
<li><a href="https://www.elastic.co/guide/en/enterprise-search-clients/enterprise-search-node/current/index.html" target="_blank">Node.js client</a></li>
<li><a href="https://www.elastic.co/guide/en/enterprise-search-clients/php/current/index.html" target="_blank">PHP client</a></li>
<li><a href="https://www.elastic.co/guide/en/enterprise-search-clients/python/current/index.html" target="_blank">Python client</a></li>
<li><a href="https://www.elastic.co/guide/en/enterprise-search-clients/ruby/current/index.html" target="_blank">Ruby client</a></li>
</ul>
</ul>
</div>
</div>
</span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="dls.html">Document level security</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="dls.html">« Document level security</a>
</span>
<span class="next">
<a href="dls-e2e-guide.html">Leverage document-level security from connectors in Search Applications »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="dls-overview"></a>How DLS works<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/8.9/enterprise-search-docs/dls-overview.asciidoc">edit</a></h2>
</div></div></div>
<p>Document level security (DLS) enables you to control access to content at the document level.
Access to each document in an index can be managed independently, based on the identities (such as usernames, emails, groups etc.) that are allowed to view it.
The DLS feature works with the help of special access control documents that are indexed by a connector into an index prefixed with <code class="literal">.search-acl-filter-</code>.
Simultaneously, content documents are ingested in another, content-specific, index prefixed simply with <code class="literal">search-</code>.</p>
<h3><a id="dls-overview-index"></a>DLS at index time<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/8.9/enterprise-search-docs/dls-overview.asciidoc">edit</a></h3>
<h4><a id="dls-overview-access-control-documents"></a>Access control documents<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/8.9/enterprise-search-docs/dls-overview.asciidoc">edit</a></h4>
<p>These documents define the access control policy for the data indexed into Elasticsearch.
An example of an access control document is as follows:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "_id": "example.user@example.com",
  "identity": {
      "username": "example username",
      "email": "example.user@example.com"
   },
   "query": {
        "template": {
            "params": {
                "access_control": [
                    "example.user@example.com",
                    "example group",
                    "example username"]
            }
        },
        "source": "..."
    }
}</pre>
</div>
<p>In this example, the identity object specifies the identity of the user that this document pertains to.
The <code class="literal">query</code> object then uses a template to list the parameters that form the access control policy for this identity.
It also contains the query <code class="literal">source</code>, which will specify a query to fetch all content documents the identity has access to.
The <code class="literal">_id</code> could be, for example, the email address or the username of a user.
The exact content and structure of <code class="literal">identity</code> depends on the corresponding implementation.</p>
<h4><a id="dls-overview-content-documents"></a>Content documents<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/8.9/enterprise-search-docs/dls-overview.asciidoc">edit</a></h4>
<p>Content documents contain the actual data from your 3rd party source.
A specific field (or fields) within these documents correlates with the query parameters in the access control documents enabling document-level security (DLS).
Please note, the field names used to implement DLS may vary across different connectors.
In the following example we&#8217;ll use the field <code class="literal">_allow_access_control</code> for specifying the access control for a user identity.</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "_id": "some-unique-id",
  "key-1": "value-1",
  "key-2": "value-2",
  "key-3": "value-3",
  "_allow_access_control": [
    "example.user@example.com",
    "example group",
    "example username"
  ]
}</pre>
</div>
<h4><a id="dls-overview-sync-type-comparison"></a>Access control sync vs content sync<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/8.9/enterprise-search-docs/dls-overview.asciidoc">edit</a></h4>
<p>The ingestion of documents into an Elasticsearch index is known as a sync.
DLS is managed using two types of syncs:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Content sync</strong></span>: Ingests content into an index that starts with <code class="literal">search-</code>.
</li>
<li class="listitem">
<span class="strong strong"><strong>Access control sync</strong></span>: Separate, additional sync which ingests access control documents into index that starts with <code class="literal">.search-acl-filter-</code>.
</li>
</ul>
</div>
<p>During a sync, the connector ingests the documents into the relevant index based on their type (content or access control).
The access control documents determine the access control policy for the content documents.</p>
<p>By leveraging DLS, you can ensure that your Elasticsearch data is securely accessible to the right users or groups, based on the permissions defined in the access control documents.</p>
<h3><a id="dls-overview-search-time"></a>DLS at search time<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/8.9/enterprise-search-docs/dls-overview.asciidoc">edit</a></h3>
<h4><a id="dls-overview-search-time-identity-allowed"></a>When is an identity allowed to see a content document<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/8.9/enterprise-search-docs/dls-overview.asciidoc">edit</a></h4>
<p>A user can view a document if at least one access control element in their access control document matches an item within the document&#8217;s <code class="literal">_allow_access_control</code> field.</p>
<h5><a id="dls-overview-search-time-example"></a>Example<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/8.9/enterprise-search-docs/dls-overview.asciidoc">edit</a></h5>
<p>This section illustrates when a user has access to certain documents depending on the access control.</p>
<p>One access control document:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "_id": "example.user@example.com",
  "identity": {
      "username": "example username",
      "email": "example.user@example.com"
   },
   "query": {
        "template": {
            "params": {
                "access_control": [
                    "example.user@example.com",
                    "example group",
                    "example username"]
            }
        },
        "source": "..."
    }
}</pre>
</div>
<p>Let&#8217;s see which of the following example documents these permissions can access, and why.</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "_id": "some-unique-id-1",
  "_allow_access_control": [
    "example.user@example.com",
    "example group",
    "example username"
  ]
}</pre>
</div>
<p>The user <code class="literal">example username</code> will have access to this document as he&#8217;s part of the corresponding group and his username and email address are also explicitly part of <code class="literal">_allow_access_control</code>.</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "_id": "some-unique-id-2",
  "_allow_access_control": [
    "example group"
  ]
}</pre>
</div>
<p>The user <code class="literal">example username</code> will also have access to this document as they are part of the <code class="literal">example group</code>.</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "_id": "some-unique-id-3",
  "_allow_access_control": [
    "another.user@example.com"
  ]
}</pre>
</div>
<p>The user <code class="literal">example username</code> won&#8217;t have access to this document because their email does not match <code class="literal">another.user@example.com</code>.</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "_id": "some-unique-id-4",
  "_allow_access_control": []
}</pre>
</div>
<p>No one will have access to this document as the <code class="literal">_allow_access_control</code> field is empty.</p>
<h4><a id="dls-overview-multiple-connectors"></a>Querying multiple indices<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/8.9/enterprise-search-docs/dls-overview.asciidoc">edit</a></h4>
<p>This section illustrates how to define an Elasticsearch API key that has restricted read access to multiple indices that have DLS enabled.</p>
<p>A user might have multiple identities that define which documents they are allowed to read.
We can define an Elasticsearch API key with a role descriptor for each index the user has access to.</p>
<h5><a id="dls-overview-multiple-connectors-example"></a>Example<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/8.9/enterprise-search-docs/dls-overview.asciidoc">edit</a></h5>
<p>Let&#8217;s assume we want to create an API key that combines the following user identities:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">GET .search-acl-filter-source1
{
  "_id": "example.user@example.com",
  "identity": {
      "username": "example username",
      "email": "example.user@example.com"
   },
   "query": {
        "template": {
            "params": {
                "access_control": [
                    "example.user@example.com",
                    "source1-user-group"]
            }
        },
        "source": "..."
    }
}</pre>
</div>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">GET .search-acl-filter-source2
{
  "_id": "example.user@example.com",
  "identity": {
      "username": "example username",
      "email": "example.user@example.com"
   },
   "query": {
        "template": {
            "params": {
                "access_control": [
                    "example.user@example.com",
                    "source2-user-group"]
            }
        },
        "source": "..."
    }
}</pre>
</div>
<p><code class="literal">.search-acl-filter-source1</code> and <code class="literal">.search-acl-filter-source2</code> define the access control identities for <code class="literal">search-source1</code> and <code class="literal">search-source2</code>.</p>
<p>You can create an Elasticsearch API key using an API call like this:</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">POST /_security/api_key
{
  "name": "my-api-key",
  "role_descriptors": {
    "role-source1": {
      "indices": [
        {
          "names": ["search-source1"],
          "privileges": ["read"],
          "query": {
            "template": {
                "params": {
                    "access_control": [
                        "example.user@example.com",
                        "source1-user-group"]
                }
            },
            "source": "..."
          }
        }
      ]
    },
    "role-source2": {
      "indices": [
        {
          "names": ["search-source2"],
          "privileges": ["read"],
          "query": {
            "template": {
                "params": {
                    "access_control": [
                        "example.user@example.com",
                        "source2-user-group"]
                }
            },
            "source": "..."
          }
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1.console"></div>
<h5><a id="dls-overview-multiple-connectors-workflow-guidance"></a>Workflow guidance<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/8.9/enterprise-search-docs/dls-overview.asciidoc">edit</a></h5>
<p>We recommend relying on the connector access control sync to automate and keep documents in sync with changes to the original content source&#8217;s user permissions.</p>
<p>Consider setting an <code class="literal">expiration</code> time when creating an Elasticsearch API key. When <code class="literal">expiration</code> is not set, the Elasticsearch API will never expire.</p>
<p>The API key can be invalidated using the <a href="/guide/en/elasticsearch/reference/8.9/security-api-invalidate-api-key.html" class="ulink" target="_top">Invalidate API Key API</a>.
Additionally, if the user&#8217;s permission changes, you&#8217;ll need to update or recreate the Elasticsearch API key.</p>
<h4><a id="dls-overview-search-time-learn-more"></a>Learn more<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/8.9/enterprise-search-docs/dls-overview.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="dls-connectors-app-search.html" title="Leverage DLS from connectors in App Search"><em>Leverage DLS from connectors in App Search</em></a>
</li>
<li class="listitem">
<a class="xref" href="dls-e2e-guide.html" title="Leverage document-level security from connectors in Search Applications"><em>DLS in Search Applications</em></a>
</li>
<li class="listitem">
<a href="/guide/en/elasticsearch/reference/8.9/document-level-security.html" class="ulink" target="_blank" rel="noopener">Elasticsearch Document Level Security</a>
</li>
</ul>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="dls.html">« Document level security</a>
</span>
<span class="next">
<a href="dls-e2e-guide.html">Leverage document-level security from connectors in Search Applications »</a>
</span>
</div>
</div>
</body>
</html>
