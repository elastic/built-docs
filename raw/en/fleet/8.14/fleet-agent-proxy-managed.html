<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Fleet managed Elastic Agent connectivity using a proxy server | Fleet and Elastic Agent Guide [8.14] | Elastic</title>
<meta class="elastic" name="content" content="Fleet managed Elastic Agent connectivity using a proxy server | Fleet and Elastic Agent Guide [8.14]">

<link rel="home" href="index.html" title="Fleet and Elastic Agent Guide [8.14]"/>
<link rel="up" href="fleet-agent-proxy-support.html" title="Using a proxy server with Elastic Agent and Fleet"/>
<link rel="prev" href="host-proxy-env-vars.html" title="Proxy Server connectivity using default host variables"/>
<link rel="next" href="fleet-agent-proxy-standalone.html" title="Standalone Elastic Agent connectivity using a proxy server"/>
<meta class="elastic" name="product_version" content="8.14"/>
<meta class="elastic" name="product_name" content="Fleet and Elastic Agent"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Fleet/Guide/Elastic Agent/8.14"/>
<meta name="DC.subject" content="Fleet and Elastic Agent"/>
<meta name="DC.identifier" content="8.14"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="host-proxy-env-vars.html">« Proxy Server connectivity using default host variables</a>
</span>
<span class="next">
<a href="fleet-agent-proxy-standalone.html">Standalone Elastic Agent connectivity using a proxy server »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Fleet and Elastic Agent Guide [8.14]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="elastic-agent-installation.html">Install Elastic Agents</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="fleet-agent-proxy-support.html">Using a proxy server with Elastic Agent and Fleet</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Fleet managed Elastic Agent connectivity using a proxy server</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet-agent-proxy-managed.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="fleet-agent-proxy-managed"></a>Fleet managed Elastic Agent connectivity using a proxy server<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet-agent-proxy-managed.asciidoc">edit</a></h3>
</div></div></div>
<p>Proxy settings in the Elastic Agent policy override proxy settings specified by environment variables. This means you can specify proxy settings for Elastic Agent that are different from host or system-level environment settings.</p>
<p>This page describes where a proxy server is allowed in your deployment and how to configure proxy settings for Elastic Agent and Fleet. The steps for deploying the proxy server itself are beyond the scope of this article.</p>
<p>Elastic Agents generally egress two sets of connections, one for Control plane traffic to the Fleet Server, the other Data plane traffic to an output such as Elasticsearch. In a similar fashion operators would place Elastic Agent behind a proxy server, and proxy the control and data plane traffic to their final destinations.</p>
<p>Fleet central management enables you to define your proxy servers and then configure an output or the Fleet Server to be reachable through any of these proxies. This also enables you to modify the proxy server details if needed without having to re-install Elastic Agents.</p>
<div class="imageblock">
<div class="content">
<img src="images/agent-proxy-server-managed-deployment.png" alt="Image showing connections between Fleet managed Elastic Agent" width="Fleet Server" height="and Elasticsearch">
</div>
</div>
<p>In this scenario Fleet Server and Elasticsearch are deployed in Elastic Cloud and reachable on port 443.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="fleet-agent-proxy-server-managed-agents"></a>Configuring proxy servers in Fleet for managed agents<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet-agent-proxy-managed.asciidoc">edit</a></h4>
</div></div></div>
<p>These steps describe how to set up Fleet components to use a proxy.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p><span class="strong strong"><strong>Globally add proxy server details to Fleet.</strong></span></p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Fleet, open the <span class="strong strong"><strong>Settings</strong></span> tab.
</li>
<li class="listitem">
<p>Select <span class="strong strong"><strong>Add proxy</strong></span>. The <span class="strong strong"><strong>Add proxy</strong></span> or <span class="strong strong"><strong>Edit proxy</strong></span> flyout opens.</p>
<div class="imageblock">
<div class="content">
<img src="images/elastic-agent-proxy-edit-proxy.png" alt="Screen capture of the Edit Proxy UI in Fleet">
</div>
</div>
</li>
<li class="listitem">
Add a name for the proxy (in this example <code class="literal">Proxy-A</code>) and specify the Proxy URL.
</li>
<li class="listitem">
Add any other optional settings.
</li>
<li class="listitem">
Select <span class="strong strong"><strong>Save and apply settings</strong></span>. The proxy information is saved and that proxy is ready for other components in Fleet to reference.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Attach the proxy to a Fleet Server.</strong></span></p>
<p>If the control plane traffic to/from the Fleet Server needs to also go through the proxy server, the proxy created needs to also be added to the definition of that Fleet Server.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Fleet, open the <span class="strong strong"><strong>Settings</strong></span> tab.
</li>
<li class="listitem">
In the list of <span class="strong strong"><strong>Fleet Server Hosts</strong></span>, choose a host and select the edit button to configure it.
</li>
<li class="listitem">
<p>In the <span class="strong strong"><strong>Proxy</strong></span> section dropdown list, select the proxy that you configured.</p>
<div class="imageblock">
<div class="content">
<img src="images/elastic-agent-proxy-edit-fleet-server.png" alt="Screen capture of the Edit Fleet Server UI">
</div>
</div>
<p>In this example, All the Elastic Agents in a policy that uses this {fleets-server} will now connect to the Fleet Server through the proxy server defined in <code class="literal">Proxy-A</code>.</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Any invalid changes to the Fleet Server definition that may cause connectivity issues between the Elastic Agents and the Fleet Server will cause them to disconnect. The only remedy would be to re-install the affected agents. This is because the connectivity to the Fleet Server ensures policy updates reach the agents. If a policy with an invalid host address reaches the agent it will no longer be able to connect and therefore won&#8217;t receive any other updates from the Fleet Server (including the corrected setting). In this regard, adding a proxy server that is not reachable by the agents will break connectivity to the Fleet Server.</p>
</div>
</div>
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Attach the proxy to the output</strong></span></p>
<p>Similarly, if the data plane traffic to an output is to traverse via a proxy, that proxy definition would need to be added to the output defined in the Fleet.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Fleet, open the <span class="strong strong"><strong>Settings</strong></span> tab.
</li>
<li class="listitem">
In the list of <span class="strong strong"><strong>Outputs</strong></span>, choose an output and select the edit button to configure it.
</li>
<li class="listitem">
<p>In the <span class="strong strong"><strong>Proxy</strong></span> section dropdown list, select the proxy that you configured.</p>
<div class="imageblock">
<div class="content">
<img src="images/elastic-agent-proxy-edit-output.png" alt="Screen capture of the Edit output UI in Fleet">
</div>
</div>
<p>In this example, All the Elastic Agents in a policy that is configured to write to the chosen output will now write to that output through the proxy server defined in <code class="literal">Proxy-A</code>.</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>If agents are unable to reach the configured proxy server, they will not be able to write data to the output that has the proxy server configured. When changing the proxy of an output, please ensure that the affected agents all have connectivity to the proxy itself.</p>
</div>
</div>
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Attach the proxy to the agent download source</strong></span></p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in beta and is subject to change. The design and code is less mature than official GA features and is being provided as-is with no warranties. Beta features are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>Likewise, if the download traffic to or from the artifact registry needs to go through the proxy server, that proxy definition also needs to be added to the agent binary source defined in Fleet.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Fleet, open the <span class="strong strong"><strong>Settings</strong></span> tab.
</li>
<li class="listitem">
In the <span class="strong strong"><strong>Agent Binary Download</strong></span> list, choose an agent binary source and select the edit button to configure it.
</li>
<li class="listitem">
<p>In the <span class="strong strong"><strong>Proxy</strong></span> section dropdown list, select the proxy that you configured.</p>
<div class="imageblock">
<div class="content">
<img src="images/elastic-agent-proxy-edit-agent-binary-source.png" alt="Screen capture of the Edit agent binary source UI in Fleet">
</div>
</div>
<p>In this example, all of the Elastic Agents enrolled in a policy that is configured to download from the chosen agent download source will now download from that agent download source through the proxy server defined in <code class="literal">Proxy-A</code>.</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>If agents are unable to reach the configured proxy server, they will not be able to download binaries from the agent download source that has the proxy server configured. When changing the proxy of an agent binary source, please ensure that the affected agents all have connectivity to the proxy itself.</p>
</div>
</div>
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Configure the Elastic Agent policy</strong></span></p>
<p>You can now configure the Elastic Agent policy to use the Fleet Server and the outputs that are reachable through a proxy server.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If the policy is configured with a Fleet Server that has a proxy attached to it, all the control plane traffic from the agents in that policy will reach the Fleet Server through that proxy.
</li>
<li class="listitem">
Similarly, if the output definition has a proxy attached to it, all the agents in that policy will write (data plane) to the output through the proxy.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Enroll the Elastic Agents</strong></span></p>
<p>Now that Fleet is configured, all policy downloads will update the agent with the latest configured proxies. When the agent is first installed it needs to communicate with Fleet (through Fleet Server) in order to download its first policy configuration.</p>
</li>
</ol>
</div>
<h5><a id="cli-proxy-settings"></a>Set the proxy for retrieving agent policies from Fleet<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet-agent-proxy-managed.asciidoc">edit</a></h5>
<p>If there is a proxy between Elastic Agent and Fleet, specify proxy settings on the
command line when you install Elastic Agent and enroll in Fleet. The settings you
specify at the command line are added to the <code class="literal">fleet.yml</code> file installed on the
system where the Elastic Agent is running.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If the initial agent communication with Fleet (i.e control plane) needs to traverse the proxy server, then the agent needs to be configured to do so using the <code class="literal">–proxy-url</code> command line flag which is applied during the agent installation. Once connectivity to Fleet is established, proxy server details can be managed through the UI.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If Kibana is behind a proxy server, you&#8217;ll still need to
<a class="xref" href="epr-proxy-setting.html" title="Set the proxy URL of the Elastic Package Registry">configure Kibana settings</a> to access the package registry.</p>
</div>
</div>
<p>The <code class="literal">enroll</code> and <code class="literal">install</code> commands accept the following flags:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">CLI flag</th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">--proxy-url &lt;url&gt;</code></p></td>
<td align="left" valign="top"><p>URL of the proxy server. The value may be either a complete URL or a
<code class="literal">host[:port]</code>, in which case the <code class="literal">http</code> scheme is assumed.  The URL accepts optional
username and password settings for authenticating with the proxy. For example:
<code class="literal">http://&lt;username&gt;:&lt;password&gt;@&lt;proxy host&gt;/</code>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">--proxy-disabled</code></p></td>
<td align="left" valign="top"><p>If specified, all proxy settings, including the <code class="literal">HTTP_PROXY</code> and <code class="literal">HTTPS_PROXY</code>
environment variables, are ignored.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">--proxy-header &lt;header name&gt;=&lt;value&gt;</code></p></td>
<td align="left" valign="top"><p>Additional header to send to the proxy during CONNECT requests. Use the
<code class="literal">--proxy-header</code> flag multiple times to add additional headers. You can use
this setting to pass keys/tokens required for authenticating with the proxy.</p></td>
</tr>
</tbody>
</table>
</div>
<p>For example:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">elastic-agent install --url="https://10.0.1.6:8220" --enrollment-token=TOKEN --proxy-url="http://10.0.1.7:3128" --fleet-server-es-ca="/usr/local/share/ca-certificates/es-ca.crt" --certificate-authorities="/usr/local/share/ca-certificates/fleet-ca.crt"</pre>
</div>
<p>The command in the previous example adds the following settings to the
<code class="literal">fleet.yml</code> policy on the host where Elastic Agent is installed:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">fleet:
  enabled: true
  access_api_key: API-KEY
  hosts:
  - https://10.0.1.6:8220
  ssl:
    verification_mode: ""
    certificate_authorities:
    - /usr/local/share/ca-certificates/es-ca.crt
    renegotiation: never
  timeout: 10m0s
  proxy_url: http://10.0.1.7:3128
  reporting:
    threshold: 10000
    check_frequency_sec: 30
  agent:
    id: ""</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When Elastic Agent runs, the <code class="literal">fleet.yml</code> file gets encrypted and renamed to <code class="literal">fleet.enc</code>.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="fleet-agent-proxy-server-secure-gateway"></a>Elastic Agent connectivity using a secure proxy gateway<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet-agent-proxy-managed.asciidoc">edit</a></h4>
</div></div></div>
<p>Many secure proxy gateways are configured to perform mutual TLS and expect all connections to present their certificate. In these instances the Client (in this case the Elastic Agent) would need to present a certificate and key to the Server (the secure proxy). In return the client expects to see a certificate authority chain from the server to ensure it is also communicating to a trusted entity.</p>
<div class="imageblock">
<div class="content">
<img src="images/elastic-agent-proxy-gateway-secure.png" alt="Image showing data flow between the proxy server and the Certificate Authority">
</div>
</div>
<p>If mTLs is a requirement when connecting to your proxy server, then you have the option to add the Client certificate and Client certificate key to the proxy. Once configured, all the Elastic Agents in a policy that connect to this secure proxy (via an output or fleet server), will use the nominated certificates to establish connections to the proxy server.</p>
<p>It should be noted that the user can define a local path to the certificate and key as in many common scenarios the certificate and key will be unique for each Elastic Agent.</p>
<p>Equally important is the Certificate Authority that the agents need to use to validate the certificate they are receiving from the secure proxy server. This can also be added when creating the proxy definition in the Fleet settings.</p>
<div class="imageblock">
<div class="content">
<img src="images/elastic-agent-edit-proxy-secure-settings.png" alt="Screen capture of the Edit Proxy UI" width="highlighting the Certificate and Certificate key settings">
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Currently Elastic Agents will not present a certificate for Control Plane traffic to the Fleet Server. Some proxy servers are setup to mandate that the client setting up a connection presents a certificate to them before allowing that client to connect. This issue will be resolved by <a href="https://github.com/elastic/elastic-agent/issues/2248" class="ulink" target="_top">issue #2248</a>. Our recommendation is to avoid adding a secure proxy as such in a Fleet Server configuration flyout.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In case Kibana is behind a proxy server or is otherwise unable to access the Elastic Package Registry to download package metadata and content, refer to <a class="xref" href="epr-proxy-setting.html" title="Set the proxy URL of the Elastic Package Registry">Set the proxy URL of the Elastic Package Registry</a>.</p>
</div>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="host-proxy-env-vars.html">« Proxy Server connectivity using default host variables</a>
</span>
<span class="next">
<a href="fleet-agent-proxy-standalone.html">Standalone Elastic Agent connectivity using a proxy server »</a>
</span>
</div>
</body>
</html>
