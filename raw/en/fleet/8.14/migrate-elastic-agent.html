<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Migrate Fleet-managed Elastic Agents from one cluster to another | Fleet and Elastic Agent Guide [8.14] | Elastic</title>
<meta class="elastic" name="content" content="Migrate Fleet-managed Elastic Agents from one cluster to another | Fleet and Elastic Agent Guide [8.14]">

<link rel="home" href="index.html" title="Fleet and Elastic Agent Guide [8.14]"/>
<link rel="up" href="manage-agents.html" title="Elastic Agents"/>
<link rel="prev" href="upgrade-elastic-agent.html" title="Upgrade Fleet-managed Elastic Agents"/>
<link rel="next" href="monitor-elastic-agent.html" title="Monitor Elastic Agents"/>
<meta class="elastic" name="product_version" content="8.14"/>
<meta class="elastic" name="product_name" content="Fleet and Elastic Agent"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Fleet/Guide/Elastic Agent/8.14"/>
<meta name="DC.subject" content="Fleet and Elastic Agent"/>
<meta name="DC.identifier" content="8.14"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="upgrade-elastic-agent.html">« Upgrade Fleet-managed Elastic Agents</a>
</span>
<span class="next">
<a href="monitor-elastic-agent.html">Monitor Elastic Agents »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Fleet and Elastic Agent Guide [8.14]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="manage-agents-in-fleet.html">Centrally manage Elastic Agents in Fleet</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="manage-agents.html">Elastic Agents</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Migrate Fleet-managed Elastic Agents from one cluster to another</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet/migrate-elastic-agent.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="migrate-elastic-agent"></a>Migrate Fleet-managed Elastic Agents from one cluster to another<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet/migrate-elastic-agent.asciidoc">edit</a></h3>
</div></div></div>

<p>There are situations where you may need to move your installed Elastic Agents from being managed in one cluster to being managed in another cluster.</p>
<p>For a seamless migration, we advise that you create an identical agent policy in the new cluster that is configured in the same manner as the original cluster. There are a few methods to do this.</p>
<p>This guide takes you through the steps to migrate your Elastic Agents by snapshotting a source cluster and restoring it on a target cluster. These instructions assume that you have an Elastic Cloud deployment, but they can be applied to on-premise clusters as well.</p>
<h5><a id="migrate-elastic-agent-take-snapshot"></a>Take a snapshot of the source cluster<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet/migrate-elastic-agent.asciidoc">edit</a></h5>
<p>Refer to the full <a href="/guide/en/elasticsearch/reference/8.14/snapshot-restore.html" class="ulink" target="_top">Snapshot and restore</a> documentation for full details. In short, to create a new snapshot in an Elastic Cloud deployment:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Kibana, open the main menu, then click <span class="strong strong"><strong>Manage this deployment</strong></span>.
</li>
<li class="listitem">
In the deployment menu, select <span class="strong strong"><strong>Snapshots</strong></span>.
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Take snapshot now</strong></span>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/migrate-agent-take-snapshot.png" alt="Deployments Snapshots page">
</div>
</div>
</li>
</ol>
</div>
<h5><a id="migrate-elastic-agent-create-target"></a>Create a new target cluster from the snapshot<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet/migrate-elastic-agent.asciidoc">edit</a></h5>
<p>You can create a new cluster based on the snapshot taken in the previous step, and then migrate your Elastic Agents and Fleet to the new cluster. For best results, it&#8217;s recommended that the new target cluster be at the same version as the cluster that the agents are migrating from.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Open the Elastic Cloud console and select <span class="strong strong"><strong>Create deployment</strong></span>.
</li>
<li class="listitem">
Select <span class="strong strong"><strong>Restore snapshot data</strong></span>.
</li>
<li class="listitem">
In the <span class="strong strong"><strong>Restore from</strong></span> field, select your source deployment.
</li>
<li class="listitem">
Choose your deployment settings, and, optimally, choose the same Elastic Stack version as the source cluster.
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Create deployment</strong></span>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/migrate-agent-new-deployment.png" alt="Create a deployment page">
</div>
</div>
</li>
</ol>
</div>
<h5><a id="migrate-elastic-agent-target-settings"></a>Update settings in the target cluster<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet/migrate-elastic-agent.asciidoc">edit</a></h5>
<p>when the target cluster is available you&#8217;ll need to adjust a few settings. Take some time to examine the Fleet setup in the new cluster.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Open the Kibana menu and select <span class="strong strong"><strong>Fleet</strong></span>.
</li>
<li class="listitem">
<p>On the <span class="strong strong"><strong>Agents</strong></span> tab, your agents should visible, however they&#8217;ll appear as <code class="literal">Offline</code>. This is because these agents have not yet enrolled in the new, target cluster, and are still enrolled in the original, source cluster.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/migrate-agent-agents-offline.png" alt="Agents tab in Fleet showing offline agents">
</div>
</div>
</li>
<li class="listitem">
Open the Fleet <span class="strong strong"><strong>Settings</strong></span> tab.
</li>
<li class="listitem">
<p>Examine the configurations captured there for Fleet. Note that these settings are scopied from the snapshot of the source cluster and may not have a meaning in the target cluster, so they need to be modified accordingly.</p>
<p>In the following example, both the <span class="strong strong"><strong>Fleet Server hosts</strong></span> and the <span class="strong strong"><strong>Outputs</strong></span> settings are copied over from the source cluster:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/migrate-agent-host-output-settings.png" alt="Settings tab in Fleet showing source deployment host and output settings">
</div>
</div>
<p>The next steps explain how to obtain the relevant Fleet Server host and Elasticsearch output details applicable to the new target cluster in Elastic Cloud.</p>
</li>
</ol>
</div>
<h6><a id="migrate-elastic-agent-elasticsearch-output"></a>Modify the Elasticsearch output<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet/migrate-elastic-agent.asciidoc">edit</a></h6>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>In the new target cluster on Elastic Cloud, in the <span class="strong strong"><strong>Outputs</strong></span> section, on the Fleet <span class="strong strong"><strong>Settings</strong></span> tab, you will find an internal output named <code class="literal">Elastic Cloud internal output</code>. The host address is in the form:</p>
<p><code class="literal">https://&lt;cluster-id-target&gt;.containerhost:9244</code></p>
<p>Record this <code class="literal">&lt;cluster-id-target&gt;</code> from the target cluster. In the example shown, the ID is <code class="literal">fcccb85b651e452aa28703a59aea9b00</code>.</p>
</li>
<li class="listitem">
<p>Also in the <span class="strong strong"><strong>Outputs</strong></span> section, notice that the default Elasticsearch output (that was copied over from the source cluster) is also in the form:</p>
<p><code class="literal">https://&lt;cluster-id-source&gt;.&lt;cloud endpoint address&gt;:443</code>.</p>
<p>Modify the Elasticsearch output so that the cluster ID is the same as that for <code class="literal">Elastic Cloud internal output</code>. In this example we also rename the output to <code class="literal">New Elasticsearch</code>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/migrate-agent-elasticsearch-output.png" alt="Outputs section showing the new Elasticsearch host setting">
</div>
</div>
<p>In this example, the <code class="literal">New Elasticsearch</code> output and the <code class="literal">Elastic Cloud internal output</code> now have the same cluster ID, namely <code class="literal">fcccb85b651e452aa28703a59aea9b00</code>.</p>
</li>
</ol>
</div>
<p>You have now created an Elasticsearch output that agents can use to write data to the new, target cluster. For on-premise environments not using Elastic Cloud, you should similarly be able to use the host address of the new cluster.</p>
<h6><a id="migrate-elastic-agent-fleet-host"></a>Modify the Fleet Server host<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet/migrate-elastic-agent.asciidoc">edit</a></h6>
<p>Like the Elasticsearch host, the Fleet Server host has also changed with the new target cluster. Note that if you&#8217;re deploying Fleet Server on premise, the host has probably not changed address and this setting does not need to be modified. We still recommend that you ensure the agents are able to reach the the on-premise Fleet Server host (which they should be able to as they were able to connect to it prior to the migration).</p>
<p>The Elastic Cloud Fleet Server host has a similar format to the Elasticsearch output:</p>
<p><code class="literal">https://&lt;deployment-id&gt;.fleet.&lt;domain&gt;.io</code></p>
<p>To configure the correct Elastic Cloud Fleet Server host you will need to find the target cluster&#8217;s full <code class="literal">deployment-id</code>, and use it to replace the original <code class="literal">deployment-id</code> that was copied over from the source cluster.</p>
<p>The easiest way to find the <code class="literal">deployment-id</code> is from the deployment URL:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
From the Kibana menu select <span class="strong strong"><strong>Manage this deployment</strong></span>.
</li>
<li class="listitem">
<p>Copy the deployment ID from the URL in your browser&#8217;s address bar.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/migrate-agent-deployment-id.png" alt="Deployment management page" width="showing the browser URL">
</div>
</div>
<p>In this example, the new deployment ID is <code class="literal">eed4ae8e2b604fae8f8d515479a16b7b</code>.</p>
<p>Using that value for <code class="literal">deployment-id</code>, the new Fleet Server host URL is:</p>
<p><code class="literal">https://eed4ae8e2b604fae8f8d515479a16b7b.fleet.us-central1.gcp.cloud.es.io:443</code></p>
</li>
<li class="listitem">
<p>In the target cluster, under <span class="strong strong"><strong>Fleet server hosts</strong></span>, replace the original host URL with the new value.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/migrate-agent-fleet-server-host.png" alt="Fleet server hosts showing the new host URL">
</div>
</div>
</li>
</ol>
</div>
<h6><a id="migrate-elastic-agent-reset-policy"></a>Reset the Elastic Cloud policy<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet/migrate-elastic-agent.asciidoc">edit</a></h6>
<p>On your target cluster, certain settings from the original Elastic Cloud Elastic Agent policiy may still be retained, and need to be updated to reference the new cluster. For example, in the APM policy installed to the Elastic Cloud Elastic Agent policy, the original and outdated APM URL is preserved. This can be fixed by running the <code class="literal">reset_preconfigured_agent_policies</code> API request. Note that when you reset the policy, all APM Integration settings are reset, including the secret key or any tail-based sampling.</p>
<p>To reset the Elastic Cloud Elastic Agent policy:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Choose one of the API requests below and submit it through a terminal window.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>If you&#8217;re using Kibana version 8.11 or higher, run:</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">curl --request POST \
--url https://{KIBANA_HOST:PORT}/internal/fleet/reset_preconfigured_agent_policies/policy-elastic-agent-on-cloud \
-u username:password \
--header 'Content-Type: application/json' \
--header 'kbn-xsrf: as' \
--header 'elastic-api-version: 1'</pre>
</div>
</li>
<li class="listitem">
<p>If you&#8217;re using a Kibana version below 8.11, run:</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">curl --request POST \
--url https://{KIBANA_HOST:PORT}/internal/fleet/reset_preconfigured_agent_policies/policy-elastic-agent-on-cloud \
-u username:password \
--header 'Content-Type: application/json' \
--header 'kbn-xsrf: as'</pre>
</div>
<p>After running the command, your Elastic Cloud agent policy settings should all be updated appropriately.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>After running the command, a warning message may appear in Fleet indicating that Fleet Server is not healthy. As well, the Elastic Agent associated with the Elastic Cloud agent policy may disappear from the list of agents. To remedy this, you can restart Integrations Server:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
From the Kibana menu, select <span class="strong strong"><strong>Manage this deployment</strong></span>.
</li>
<li class="listitem">
In the deployment menu, select <span class="strong strong"><strong>Integrations Server</strong></span>.
</li>
<li class="listitem">
On the <span class="strong strong"><strong>Integrations Server</strong></span> page, select <span class="strong strong"><strong>Force Restart</strong></span>.
</li>
</ol>
</div>
<p>After the restart, Integrations Server will enroll a new Elastic Agent for the Elastic Cloud agent policy and Fleet Server should return to a healthy state.</p>
</div>
</div>
<h6><a id="migrate-elastic-agent-confirm-policy"></a>Confirm your policy settings<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet/migrate-elastic-agent.asciidoc">edit</a></h6>
<p>Now that the Fleet settings are correctly set up, it pays to ensure that the Elastic Agent policy is also correctly pointing to the correct entities.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In the target cluster, go to <span class="strong strong"><strong>Fleet &#8594; Agent policies</strong></span>.
</li>
<li class="listitem">
Select a policy to verify.
</li>
<li class="listitem">
Open the <span class="strong strong"><strong>Settings</strong></span> tab.
</li>
<li class="listitem">
<p>Ensure that <span class="strong strong"><strong>Fleet Server</strong></span>, <span class="strong strong"><strong>Output for integrations</strong></span>, and <span class="strong strong"><strong>Output for agent monitoring</strong></span> are all set to the newly created entities.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/migrate-agent-policy-settings.png" alt="An agent policy&#8217;s settings showing the newly created entities">
</div>
</div>
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you modified the Fleet Server and the output in place these would have been updated accordingly. However if new entities are created, then ensure that the correct ones are referenced here.</p>
</div>
</div>
<h5><a id="migrate-elastic-agent-migrated-policies"></a>Agent policies in the new target cluster<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet/migrate-elastic-agent.asciidoc">edit</a></h5>
<p>By creating the new target cluster from a snapshot, all of your policies should have been created along with all of the agents. These agents will be offline due to the fact that the actual agents are not checking in with the new, target cluster (yet) and are still communicating with the source cluster.</p>
<p>The agents can now be re-enrolled into these policies and migrated over to the new, target cluster.</p>
<h5><a id="migrate-elastic-agent-migrated-agents"></a>Migrate Elastic Agents to the new target cluster<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.14/docs/en/ingest-management/fleet/migrate-elastic-agent.asciidoc">edit</a></h5>
<p>In order to ensure that all required API keys are correctly created, the agents in your current cluster need to be re-enrolled into the new, target cluster.</p>
<p>This is best performed one policy at a time. For a given policy, you need to capture the enrollment token and the URL for the agent to connect to. You can find these by running the in-product steps to add a new agent.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
On the target cluster, open <span class="strong strong"><strong>Fleet</strong></span> and select <span class="strong strong"><strong>Add agent</strong></span>.
</li>
<li class="listitem">
Select your newly created policy.
</li>
<li class="listitem">
In the section <span class="strong strong"><strong>Install Elastic Agent on your host</strong></span>, find the sample install command. This contains the details you&#8217;ll need to enroll the agents, namely the enrollment token and the Fleet Server URL.
</li>
<li class="listitem">
<p>Copy the portion of the install command containing these values. That is, <code class="literal">–url=&lt;path&gt; –enrollment-token=&lt;token for the new policy&gt;</code>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/migrate-agent-install-command.png" alt="Install command from the Add Agent UI">
</div>
</div>
</li>
<li class="listitem">
<p>On the host machines where the current agents are installed, enroll the agents again using this copied URL and the enrollment token:</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">sudo elastic-agent enroll --url=&lt;fleet server url&gt; --enrollment-token=&lt;token for the new policy&gt;</pre>
</div>
<p>The command output should be like the following:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/migrate-agent-install-command-output.png" alt="Install command output">
</div>
</div>
</li>
<li class="listitem">
<p>The agent on each host will now check into the new Fleet Server and appear in the new target cluster. In the source cluster, the agents will go offline as they won&#8217;t be sending any check-ins.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/migrate-agent-newly-enrolled-agents.png" alt="Newly enrolled agents in the target cluster">
</div>
</div>
</li>
<li class="listitem">
Repeat this procedure for each Elastic Agent policy.
</li>
</ol>
</div>
<p>If all has gone well, you&#8217;ve successfully migrated your Fleet-managed Elastic Agents to a new cluster.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="upgrade-elastic-agent.html">« Upgrade Fleet-managed Elastic Agents</a>
</span>
<span class="next">
<a href="monitor-elastic-agent.html">Monitor Elastic Agents »</a>
</span>
</div>
</body>
</html>
