<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Configuring Kubernetes metadata enrichment on Elastic Agent | Fleet and Elastic Agent Guide [8.15] | Elastic</title>
<meta class="elastic" name="content" content="Configuring Kubernetes metadata enrichment on Elastic Agent | Fleet and Elastic Agent Guide [8.15]">

<link rel="home" href="index.html" title="Fleet and Elastic Agent Guide [8.15]"/>
<link rel="up" href="install-elastic-agents-in-containers.html" title="Install Elastic Agents in a containerized environment"/>
<link rel="prev" href="advanced-kubernetes-managed-by-fleet.html" title="Advanced Elastic Agent configuration managed by Fleet"/>
<link rel="next" href="running-on-gke-managed-by-fleet.html" title="Run Elastic Agent on GKE managed by Fleet"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Fleet and Elastic Agent"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Fleet/Guide/Elastic Agent/8.15"/>
<meta name="DC.subject" content="Fleet and Elastic Agent"/>
<meta name="DC.identifier" content="8.15"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="advanced-kubernetes-managed-by-fleet.html">« Advanced Elastic Agent configuration managed by Fleet</a>
</span>
<span class="next">
<a href="running-on-gke-managed-by-fleet.html">Run Elastic Agent on GKE managed by Fleet »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Fleet and Elastic Agent Guide [8.15]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="elastic-agent-installation.html">Install Elastic Agents</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="install-elastic-agents-in-containers.html">Install Elastic Agents in a containerized environment</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Configuring Kubernetes metadata enrichment on Elastic Agent</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/elastic-agent/configuring-kubernetes-metadata.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="configuring-kubernetes-metadata"></a>Configuring Kubernetes metadata enrichment on Elastic Agent</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/elastic-agent/configuring-kubernetes-metadata.asciidoc">edit</a></div>
</div></div></div>
<p>Kubernetes <a href="/guide/en/observability/current/monitor-kubernetes.html#beats-metadata" class="ulink" target="_top">metadata</a> refer to contextual information extracted from Kubernetes resources. Metadata information enrich metrics and logs
collected from a Kubernetes cluster, enabling deeper insights into Kubernetes environments.</p>
<p>When the Elastic Agent&#8217;s policy includes the <a href="https://docs.elastic.co/en/integrations/kubernetes" class="ulink" target="_top">Kubernetes Integration</a> which configures the collection of Kubernetes related metrics and container logs, the mechanisms used for the metadata enrichment are:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="kubernetes-provider.html" title="Kubernetes Provider">Kubernetes Provider</a> for log collection
</li>
<li class="listitem">
Kubernetes metadata enrichers for metrics
</li>
</ul>
</div>
<p>In case the Elastic Agent&#8217;s policy does not include the Kubernetes integration, but Elastic Agent runs inside a Kubernetes
environment, the Kubernetes metadata are collected by the <a class="xref" href="add_kubernetes_metadata-processor.html" title="Add Kubernetes metadata">add_kubernetes_metadata</a>. The processor is configurable when Elastic Agent is managed by Fleet.</p>
<div class="position-relative"><h5><a id="_kubernetes_logs"></a>Kubernetes Logs</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/elastic-agent/configuring-kubernetes-metadata.asciidoc">edit</a></div>
<p>When it comes to container logs collection, the <a class="xref" href="kubernetes-provider.html" title="Kubernetes Provider">Kubernetes Provider</a> is used. It monitors for pod resources
in the cluster and associates each container log file with a corresponding pod&#8217;s container object.
That way, when a log file is parsed and an event is ready to be published to Elasticsearch, the internal mechanism knows to which actual
container this log file belongs. The linkage is established by the container&#8217;s ID, which forms an integral part of the filename for the log.
The Kubernetes autodiscover provider has already collected all the metadata for that container, leveraging pod, namespace and node watchers. Thus, the events are enriched with the relevant metadata.</p>
<p>In order to configure the metadata collection, the Kubernetes provider needs to be configured.
All the available configuration options of the <span class="strong strong"><strong>Kubernetes provider</strong></span> can be found in the <a href="/guide/en/fleet/current/kubernetes-provider.html" class="ulink" target="_top">Kubernetes Provider</a> documentation.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
For <span class="strong strong"><strong>Standalone Elastic Agent configuration:</strong></span>
</li>
</ul>
</div>
<p>Follow information of <code class="literal">add_resource_metadata</code> parameter of <a class="xref" href="kubernetes-provider.html" title="Kubernetes Provider">Kubernetes Provider</a></p>
<p><strong>Example of how to configure kubernetes metadata enrichment.</strong></p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: agent-node-datastreams
  namespace: kube-system
  labels:
    k8s-app: elastic-agent
data:
  agent.yml: |-
    kubernetes.provider
      add_resource_metadata:
        namespace:
          #use_regex_include: false
          include_labels: ["namespacelabel1"]
          #use_regex_exclude: false
          #exclude_labels: ["namespacelabel2"]
        node:
          #use_regex_include: false
          include_labels: ["nodelabel2"]
          include_annotations: ["nodeannotation1"]
          #use_regex_exclude: false
          #exclude_labels: ["nodelabel3"]
        #deployment: false
        #cronjob: false</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Managed Elastic Agent configuration</strong></span>:
</li>
</ul>
</div>
<p>The Kubernetes provider can be configured following the steps in <a class="xref" href="advanced-kubernetes-managed-by-fleet.html" title="Advanced Elastic Agent configuration managed by Fleet">Advanced Elastic Agent configuration managed by Fleet</a>.</p>
<div class="position-relative"><h5><a id="_kubernetes_metrics"></a>Kubernetes metrics</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/elastic-agent/configuring-kubernetes-metadata.asciidoc">edit</a></div>
<p>The Elastic Agent metrics collection implements metadata enrichment based on watchers, a mechanism used to continuously monitor Kubernetes resources for changes and updates.
Specifically, the different datasets share a set of resource watchers. Those watchers (pod, node, namespace, deployment, daemonset etc.) are responsible for watching for all different resource events (creation, update and deletion) by subscribing to the Kubernetes watch API. This enables real-time synchronization of application state with the state of the Kubernetes cluster.
So, they keep an up-to-date shared cache store of all the resources' information and metadata. Whenever metrics are collected by the different sources (kubelet, kube-state-metrics), before they get published to Elasticsearch as events, they are enriched with needed metadata.</p>
<p>The metadata enrichment can be configured by editing the Kubernetes integration.
<span class="strong strong"><strong>Only in metrics collection</strong></span>, metadata enrichment can be disabled by switching off the <code class="literal">Add Metadata</code> toggle in every dataset. Extra resource metadata such as
node, namespace labels and annotations, as well as deployment and cronjob information can be configured per dataset.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Managed Elastic Agent configuration</strong></span>:
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/kubernetes_metadata.png" alt="metadata configuration">
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>add_resource_metadata block needs to be configured to all datasets that are enabled</p>
</div>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
For <span class="strong strong"><strong>Standalone Elastic Agent configuration</strong></span>:
</li>
</ul>
</div>
<p><strong>Elastic Agent Standalone manifest sample.</strong></p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">[output trunctated ...]
- data_stream:
       dataset: kubernetes.state_pod
        type: metrics
            metricsets:
        - state_pod
           add_metadata: true
            hosts:
              - 'kube-state-metrics:8080'
            period: 10s
            add_resource_metadata:
                  namespace:
                    enabled: true
                    #use_regex_include: false
                    include_labels: ["namespacelabel1"]
                    #use_regex_exclude: false
                    #exclude_labels: ["namespacelabel2"]
                 node:
                    enabled: true
                    #use_regex_include: false
                    include_labels: ["nodelabel2"]
                    include_annotations: ["nodeannotation1"]
                    #use_regex_exclude: false
                   #exclude_labels: ["nodelabel3"]
                #deployment: false
                #cronjob: false</pre>
</div>
<p>The <code class="literal">add_resource_metadata</code> block configures the watcher&#8217;s enrichment functionality. See <a class="xref" href="kubernetes-provider.html" title="Kubernetes Provider">Kubernetes Provider</a> for full description of add_resource_metadata. Same configuration parameters apply.</p>
<div class="position-relative"><h5><a id="_note"></a>Note</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/elastic-agent/configuring-kubernetes-metadata.asciidoc">edit</a></div>
<p>Although the <code class="literal">add_kubernetes_metadata</code> processor is by default enabled when using elastic-agent, it is skipped whenever Kubernetes integration is detected.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="advanced-kubernetes-managed-by-fleet.html">« Advanced Elastic Agent configuration managed by Fleet</a>
</span>
<span class="next">
<a href="running-on-gke-managed-by-fleet.html">Run Elastic Agent on GKE managed by Fleet »</a>
</span>
</div>
</body>
</html>
