<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Run Elastic Agent without administrative privileges | Fleet and Elastic Agent Guide [8.15] | Elastic</title>
<meta class="elastic" name="content" content="Run Elastic Agent without administrative privileges | Fleet and Elastic Agent Guide [8.15]">

<link rel="home" href="index.html" title="Fleet and Elastic Agent Guide [8.15]"/>
<link rel="up" href="elastic-agent-installation.html" title="Install Elastic Agents"/>
<link rel="prev" href="agent-environment-variables.html" title="Elastic Agent environment variables"/>
<link rel="next" href="install-agent-msi.html" title="Install Elastic Agent from an MSI package"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Fleet and Elastic Agent"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Fleet/Guide/Elastic Agent/8.15"/>
<meta name="DC.subject" content="Fleet and Elastic Agent"/>
<meta name="DC.identifier" content="8.15"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="agent-environment-variables.html">« Elastic Agent environment variables</a>
</span>
<span class="next">
<a href="install-agent-msi.html">Install Elastic Agent from an MSI package »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Fleet and Elastic Agent Guide [8.15]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="elastic-agent-installation.html">Install Elastic Agents</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Run Elastic Agent without administrative privileges</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/elastic-agent/elastic-agent-unprivileged-mode.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="elastic-agent-unprivileged"></a>Run Elastic Agent without administrative privileges<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/elastic-agent/elastic-agent-unprivileged-mode.asciidoc">edit</a></h2>
</div></div></div>
<p>Beginning with Elastic Stack version 8.15, Elastic Agent is no longer required to be run by a user with superuser privileges. You can now run agents in an <code class="literal">unprivileged</code> mode that does not require <code class="literal">root</code> access on Linux or macOS, or <code class="literal">admin</code> access on Windows. Being able to run agents without full administrative privileges is often a requirement in organizations where this kind of access is often very limited.</p>
<p>In general, agents running without full administrative privileges will perform and behave exactly as those run by a superuser. There are certain integrations and datastreams that are not available, however. If an integration requires root access, this is <a class="xref" href="elastic-agent-unprivileged.html#unprivileged-integrations" title="Using Elastic integrations">indicated on the integration main page</a>.</p>
<p>You can also <a class="xref" href="elastic-agent-unprivileged.html#unprivileged-change-mode" title="Changing an Elastic Agent&#8217;s privilege mode">change the privilege mode</a> of an Elastic Agent after it has been installed.</p>
<p>Refer to <a class="xref" href="elastic-agent-unprivileged.html#unprivileged-command-behaviors" title="Agent and dashboard behaviors in unprivileged mode">Agent and dashboard behaviors in unprivileged mode</a> and <a class="xref" href="elastic-agent-unprivileged.html#unprivileged-running" title="Run Elastic Agent in unprivileged mode">Run Elastic Agent in <code class="literal">unprivileged</code> mode</a> for the requirements and steps associated with running an agent without full <code class="literal">root</code> or <code class="literal">admin</code> superuser privileges.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="elastic-agent-unprivileged.html#unprivileged-running" title="Run Elastic Agent in unprivileged mode">Run Elastic Agent in <code class="literal">unprivileged</code> mode</a>
</li>
<li class="listitem">
<a class="xref" href="elastic-agent-unprivileged.html#unprivileged-command-behaviors" title="Agent and dashboard behaviors in unprivileged mode">Agent and dashboard behaviors in unprivileged mode</a>
</li>
<li class="listitem">
<a class="xref" href="elastic-agent-unprivileged.html#unprivileged-integrations" title="Using Elastic integrations">Using Elastic integrations</a>
</li>
<li class="listitem">
<a class="xref" href="elastic-agent-unprivileged.html#unprivileged-view-mode" title="Viewing an Elastic Agent privilege mode">Viewing an Elastic Agent privilege mode</a>
</li>
<li class="listitem">
<a class="xref" href="elastic-agent-unprivileged.html#unprivileged-change-mode" title="Changing an Elastic Agent&#8217;s privilege mode">Changing an Elastic Agent&#8217;s privilege mode</a>
</li>
</ul>
</div>
<h4><a id="unprivileged-running"></a>Run Elastic Agent in <code class="literal">unprivileged</code> mode<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/elastic-agent/elastic-agent-unprivileged-mode.asciidoc">edit</a></h4>
<p>To run Elastic Agent without administrative privileges you use exactly the same commands that you use for Elastic Agent otherwise, with one exception. When you run the <a class="xref" href="elastic-agent-cmd-options.html#elastic-agent-install-command" title="elastic-agent install"><code class="literal">elastic-agent install</code></a> command, add the <code class="literal">--unprivileged</code> flag. For example:</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">elastic-agent install \
  --url=https://cedd4e0e21e240b4s2bbbebdf1d6d52f.fleet.eu-west-1.aws.cld.elstc.co:443 \
  --enrollment-token=NEFmVllaa0JLRXhKebVKVTR5TTI6N2JaVlJpSGpScmV0ZUVnZVlRUExFQQ== \
  --unprivileged</pre>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>On Linux systems, when you install Elastic Agent using the <code class="literal">--unprivileged</code> flag, Elastic Agent commands should not be run with <code class="literal">sudo</code>.
Doing so may result in <a class="xref" href="fleet-troubleshooting.html#agent-sudo-error" title="Error when running Elastic Agent commands with sudo">an error</a> due to the agent not having the required privileges.</p>
</div>
</div>
<h4><a id="unprivileged-command-behaviors"></a>Agent and dashboard behaviors in unprivileged mode<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/elastic-agent/elastic-agent-unprivileged-mode.asciidoc">edit</a></h4>
<p>In addition to the <a class="xref" href="elastic-agent-unprivileged.html#unprivileged-integrations" title="Using Elastic integrations">integrations that are not available</a> when Elastic Agent is run in unpriviledged mode, certain data streams are also not available. The following tables show, for different operating systems, the impact when the agent does not have full administrative privileges. In most cases the limitations can be mediated by granting permissions for a user or group to the files indicated.</p>
<div class="table">
<p class="title"><strong>Table 1. macOS</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="macOS">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Action</th>
<th align="left" valign="top">Behavior in unprivileged mode</th>
<th align="left" valign="top">Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent with the System integration</p></td>
<td align="left" valign="top"><p>Log file error: <code class="literal">Unexpected file opening error: Failed opening /var/log/system.log: open /var/log/system.log: permission denied</code>.</p></td>
<td align="left" valign="top"><p>Give read permission to the <code class="literal">elastic-agent</code> group for the <code class="literal">/var/log/system.log</code> file to fix this error.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent with the System integration</p></td>
<td align="left" valign="top"><p>On the <code class="literal">[Logs System] Syslog</code> dashboard, the <code class="literal">Syslog events by hostname</code>, <code class="literal">Syslog hostnames and processes</code> and <code class="literal">Syslog logs</code> visualizations are are missing data.</p></td>
<td align="left" valign="top"><p>Give read permission to the <code class="literal">elastic-agent</code> group for the <code class="literal">/var/log/system.log</code> file to fix the missing visualizations.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent with the System integration</p></td>
<td align="left" valign="top"><p>On the <code class="literal">[Metrics System] Host overview</code> dashboard, only the processes run by the <code class="literal">elastic-agent-user</code> user are shown in the CPU and memory usage lists.</p></td>
<td align="left" valign="top"><p>To fix the missing processes in the visualization lists you can add add the <code class="literal">elastic-agent-user</code> user to the system <code class="literal">admin</code> group. Note that while this mitigates the issue, it also grants <code class="literal">elastic-agent user</code> with more permissions than may be desired.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent and access the Elastic Agent dashboards</p></td>
<td align="left" valign="top"><p>On the <code class="literal">[Elastic Agent] Agents info</code> dashboard, visualizations including <code class="literal">Most Active Agents</code> and <code class="literal">Integrations per Agent</code> are missing data.</p></td>
<td align="left" valign="top"><p>To fix the missing data in the visualizations you can add add the <code class="literal">elastic-agent-user</code> user to the system <code class="literal">admin</code> group. Note that while this mitigates the issue it also grants <code class="literal">elastic-agent user</code> with more permissions than may be desired.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent and access the Elastic Agent dashboards</p></td>
<td align="left" valign="top"><p>On the <code class="literal">[Elastic Agent] Integrations</code> dashboard, visualizations including <code class="literal">Integration Errors Table</code>, <code class="literal">Events per integration</code> and <code class="literal">Integration Errors</code> are missing data.</p></td>
<td align="left" valign="top"><p>To fix the missing data in the visualizations you can add add the <code class="literal">elastic-agent-user</code> user to the system <code class="literal">admin</code> group. Note that while this mitigates the issue it also grants <code class="literal">elastic-agent user</code> with more permissions than may be desired.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="table">
<p class="title"><strong>Table 2. Linux</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="Linux">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Action</th>
<th align="left" valign="top">Behavior in unprivileged mode</th>
<th align="left" valign="top">Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent with the System integration</p></td>
<td align="left" valign="top"><p>Log file error: <code class="literal">[elastic_agent.filebeat][error] Harvester could not be started on new file: /var/log/auth.log.1, Err: error setting up harvester: Harvester setup failed. Unexpected file opening error: Failed opening /var/log/auth.log.1: open /var/log/auth.log.1: permission denied</code></p></td>
<td align="left" valign="top"><p>To avoid the error you can add add the <code class="literal">elastic-agent-user</code> user to the <code class="literal">adm</code> group. Note that while this mitigates the issue it also grants <code class="literal">elastic-agent user</code> with more permissions than may be desired.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent with the System integration</p></td>
<td align="left" valign="top"><p>Log file error: <code class="literal">[elastic_agent.metricbeat][error] error getting filesystem usage for /run/user/1000/gvfs: error in Statfs syscall: permission denied</code></p></td>
<td align="left" valign="top"><p>To avoid the error you can add add the <code class="literal">elastic-agent-user</code> user to the <code class="literal">adm</code> group. Note that while this mitigates the issue it also grants <code class="literal">elastic-agent user</code> with more permissions than may be desired.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent with the System integration</p></td>
<td align="left" valign="top"><p>On the <code class="literal">[Logs System] Syslog</code> dashboard, the <code class="literal">Syslog events by hostname</code>, <code class="literal">Syslog hostnames and processes</code> and <code class="literal">Syslog logs</code> visualizations are are missing data.</p></td>
<td align="left" valign="top"><p>To fix the missing data in the visualizations you can add add the <code class="literal">elastic-agent-user</code> user to the <code class="literal">adm</code> group. Note that while this mitigates the issue it also grants <code class="literal">elastic-agent user</code> with more permissions than may be desired.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent and access the Elastic Agent dashboards</p></td>
<td align="left" valign="top"><p>On the <code class="literal">[Elastic Agent] Agents info</code> dashboard, visualizations including <code class="literal">Most Active Agents</code> and <code class="literal">Integrations per Agent</code> are missing data.</p></td>
<td align="left" valign="top"><p>Giving read permission to the <code class="literal">elastic-agent</code> group for the <code class="literal">/var/log/system.log</code> file will partially fix the visualizations, but errors may still occur because the <code class="literal">elastic-agent-user</code> does not have read access to files in the <code class="literal">/run/user/1000/</code> directory.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent and access the Elastic Agent dashboards</p></td>
<td align="left" valign="top"><p>On the <code class="literal">[Elastic Agent] Integrations</code> dashboard, visualizations including <code class="literal">Integration Errors Table</code>, <code class="literal">Events per integration</code> and <code class="literal">Integration Errors</code> are missing data.</p></td>
<td align="left" valign="top"><p>Give read permission to the <code class="literal">elastic-agent</code> group for the <code class="literal">/var/log/system.log</code> file to fix the missing visualizations.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="table">
<p class="title"><strong>Table 3. Windows</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="Windows">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Action</th>
<th align="left" valign="top">Behavior in unprivileged mode</th>
<th align="left" valign="top">Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent with the System integration</p></td>
<td align="left" valign="top"><p>Log file error: <code class="literal">failed to open Windows Event Log channel "Security": Access is denied</code></p></td>
<td align="left" valign="top"><p>Add the <code class="literal">elastic-agent-user</code> user to the <code class="literal">Event Log Users</code> group to fix this error.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent with the System integration</p></td>
<td align="left" valign="top"><p>Log file error: <code class="literal">cannot open new key in the registry in order to enable the performance counters: Access is denied</code></p></td>
<td align="left" valign="top"><p>Update the permissions for the <code class="literal">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\PartMgr</code> registry to fix this error.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent with the System integration</p></td>
<td align="left" valign="top"><p>Most of the System and Elastic Agent dashboard visualizations are missing all data.</p></td>
<td align="left" valign="top"><p>Add the <code class="literal">elastic-agent-user</code> user to the <code class="literal">Event Log Users</code> group and update the permissions for the <code class="literal">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\PartMgr</code> registry to fix the missing visualizations.</p>
<p>Note that the <code class="literal">elastic-agent-user</code> user may still not have access to all processes, so the lists in the <code class="literal">Top processes by CPU usage</code> and <code class="literal">Top processes by memory usage</code> visualizations may be incomplete.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Run Elastic Agent with the System integration</p></td>
<td align="left" valign="top"><p>On the <code class="literal">[Metrics System] Host overview</code> dashboard, the <code class="literal">Disk usage</code> visualizations are missing data.</p></td>
<td align="left" valign="top"><p>This occurs because direct access to the disk or a volume is restricted and not available to users without administrative privileges. Refer to <a href="https://learn.microsoft.com/en-us/windows/win32/secbp/running-with-special-privileges" class="ulink" target="_top">Running with Special Privileges</a> in the Microsoft documentation for details.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<h4><a id="unprivileged-integrations"></a>Using Elastic integrations<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/elastic-agent/elastic-agent-unprivileged-mode.asciidoc">edit</a></h4>
<p>Most Elastic integrations support running Elastic Agent in unprivileged mode. For the exceptions, any integration that requires Elastic Agent to have root privileges has the requirement indicated at the top of the integration page in Kibana:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/integration-root-requirement.png" alt="Elastic Defend integration page showing root requirement">
</div>
</div>
<p>As well, a warning is displayed in Kibana if you try to add an integration that requires root privileges to an Elastic Agent policy that has agents enrolled in unprivileged mode.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/unprivileged-agent-warning.png" alt="Warning indicating that root privileged agent is required for an integration">
</div>
</div>
<p>Examples of integrations that require Elastic Agent to have administrative privileges are:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://docs.elastic.co/en/integrations/endpoint" class="ulink" target="_top">Elastic Defend</a>
</li>
<li class="listitem">
<a href="https://docs.elastic.co/integrations/auditd_manager" class="ulink" target="_top">Auditd Manager</a>
</li>
<li class="listitem">
<a href="https://docs.elastic.co/integrations/fim" class="ulink" target="_top">File Integrity Monitoring</a>
</li>
<li class="listitem">
<a href="https://docs.elastic.co/integrations/network_traffic" class="ulink" target="_top">Network Packet Capture</a>
</li>
<li class="listitem">
<a href="https://docs.elastic.co/integrations/system_audit" class="ulink" target="_top">System Audit</a>
</li>
<li class="listitem">
<a href="https://docs.elastic.co/integrations/profiler_agent" class="ulink" target="_top">Universal Profiling Agent</a>
</li>
</ul>
</div>
<h4><a id="unprivileged-view-mode"></a>Viewing an Elastic Agent privilege mode<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/elastic-agent/elastic-agent-unprivileged-mode.asciidoc">edit</a></h4>
<p>For any Elastic Agent policy you can view the number of agents that are currently running in privileged or unprivileged mode:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Fleet, open the <span class="strong strong"><strong>Agent policies</strong></span> tab.
</li>
<li class="listitem">
Click the agent policy to view the policy details.
</li>
</ol>
</div>
<p>The number of agents enrolled with the policy is shown. Hover over the link to view the number of privileged and unpriviled agents.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/privileged-and-unprivileged-agents.png" alt="Agent policy tab showing 1 unprivileged agent and 0 privileged enrolled agents">
</div>
</div>
<p>In the event that the Elastic Agent policy has integrations installed that require root privileges, but there are agents running without root privileges, this is shown in the tooltip.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/root-integration-and-unprivileged-agents.png" alt="Agent policy tab showing 1 unprivileged agent and 0 privileged enrolled agents">
</div>
</div>
<h4><a id="unprivileged-change-mode"></a>Changing an Elastic Agent&#8217;s privilege mode<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/elastic-agent/elastic-agent-unprivileged-mode.asciidoc">edit</a></h4>
<p>If an agent doesn&#8217;t have the right level of privilege to read a data source, you can adjust the agent&#8217;s privileges by adding <code class="literal">elastic-agent-user</code> to the user group that has privileges to read the data source.</p>
<p>As background, when you run Elastic Agent in <code class="literal">unprivileged</code> mode, one user and one group are created on the host. The same names are used for all operating systems:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">elastic-agent-user</code>: The user that is created and that the Elastic Agent service runs as.
</li>
<li class="listitem">
<code class="literal">elastic-agent</code>: The group that is created. Any user in this group has access to control and communicate over the control protocol to the Elastic Agent daemon.
</li>
</ul>
</div>
<p>For example:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
When you install Elastic Agent with the <code class="literal">--unprivileged</code> setting, the <code class="literal">elastic-agent-user</code> user and the <code class="literal">elastic-agent</code> group are created automatically.
</li>
<li class="listitem">
If you then want your user <code class="literal">myuser</code> to be able to run an Elastic Agent command such as <code class="literal">elastic-agent status</code>, add the <code class="literal">myuser</code> user to the <code class="literal">elastic-agent</code> group.
</li>
<li class="listitem">
Then, once added to the group, the <code class="literal">elastic-agent status</code> command will work. Prior to that, the user <code class="literal">myuser</code> running the command will result in a permission error that indicates a problem communicating with the control socket.
</li>
</ol>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="agent-environment-variables.html">« Elastic Agent environment variables</a>
</span>
<span class="next">
<a href="install-agent-msi.html">Install Elastic Agent from an MSI package »</a>
</span>
</div>
</body>
</html>
