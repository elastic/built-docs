<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Secret files guide | Fleet and Elastic Agent Guide [8.15] | Elastic</title>
<meta class="elastic" name="content" content="Secret files guide | Fleet and Elastic Agent Guide [8.15]">

<link rel="home" href="index.html" title="Fleet and Elastic Agent Guide [8.15]"/>
<link rel="up" href="fleet-server-secrets.html" title="Fleet Server Secrets"/>
<link rel="prev" href="fleet-server-secrets.html" title="Fleet Server Secrets"/>
<link rel="next" href="fleet-server-monitoring.html" title="Monitor a self-managed Fleet Server"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Fleet and Elastic Agent"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Fleet/Guide/Elastic Agent/8.15"/>
<meta name="DC.subject" content="Fleet and Elastic Agent"/>
<meta name="DC.identifier" content="8.15"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="fleet-server-secrets.html">« Fleet Server Secrets</a>
</span>
<span class="next">
<a href="fleet-server-monitoring.html">Monitor a self-managed Fleet Server »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Fleet and Elastic Agent Guide [8.15]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="fleet-deployment-models.html">Deployment models</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="fleet-server-secrets.html">Fleet Server Secrets</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Secret files guide</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/fleet/fleet-server-secrets.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="secret-files-guide"></a>Secret files guide<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/fleet/fleet-server-secrets.asciidoc">edit</a></h3>
</div></div></div>
<p>This guide provides step-by-step examples with best practices on how to deploy secret files directly on a host or through the Kubernetes secrets engine.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="secret-filesystem"></a>Secrets on filesystem<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/fleet/fleet-server-secrets.asciidoc">edit</a></h4>
</div></div></div>
<p>Secret files can be provisioned as plain text files directly on filesystems and referenced or passed through Elastic Agent.</p>
<p>We recommend these steps to improve security.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_file_permissions"></a>File permissions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/fleet/fleet-server-secrets.asciidoc">edit</a></h5>
</div></div></div>
<p>File permissions should not allow for global read permissions.</p>
<p>On MacOS and Linux, you can set file ownership and file permissions with the <code class="literal">chown</code> and <code class="literal">chmod</code> commands, respectively.
Fleet Server runs as the <code class="literal">root</code> user on MacOS and Linux, so given a file named <code class="literal">mySecret</code>, you can alter it with:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo chown root:root mySecret # set the user:group to root
sudo chmod 0600 mySecret      # set only the read/write permission flags for the user, clear group and global permissions.</pre>
</div>
<p>On Windows, you can use <code class="literal">icacls</code> to alter the ACL list associated with the file:</p>
<div class="pre_wrapper lang-powershell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-powershell">Write-Output -NoNewline SECRET &gt; mySecret          # Create the file mySecret with the contents SECRET
icacls .\mySecret /inheritance:d                   # Remove inherited permissions from file
icacls .\mySecret /remove:g BUILTIN\Administrators # Remove Administrators group permissions
icacls .\mySecret /remove:g $env:UserName          # Remove current user's permissions</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_temporary_filesystem"></a>Temporary filesystem<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/fleet/fleet-server-secrets.asciidoc">edit</a></h5>
</div></div></div>
<p>You can use a temporary filesystem (in RAM) to hold secret files in order to improve security.
These types of filesystems are normally not included in backups and are cleared if the host is reset.
If used, the filesystem and secret files need to be reprovisioned with every reset.</p>
<p>On Linux you can use <code class="literal">mount</code> with the <code class="literal">tmpfs</code> filesystem to create a temporary filesystem in RAM:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">mount -o size=1G -t tmpfs none /mnt/fleet-server-secrets</pre>
</div>
<p>On MacOS you can use a combination of <code class="literal">diskutil</code> and <code class="literal">hdiutil</code> to create a RAM disk:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">diskutil erasevolume HFS+ 'RAM Disk' `hdiutil attach -nobrowse -nomount ram://2097152`</pre>
</div>
<p>Windows systems do not offer built-in options to create a RAM disk, but several third party programs are available.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_example"></a>Example<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/fleet/fleet-server-secrets.asciidoc">edit</a></h5>
</div></div></div>
<p>Here is a step by step guide for provisioning a service token on a Linux system:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo mkdir -p /mnt/fleet-server-secrets
sudo mount -o size=1G -t tmpfs none /mnt/fleet-server-secrets
echo -n MY-SERVICE-TOKEN &gt; /mnt/fleet-server-secrets/service-token
sudo chown root:root /mnt/fleet-server-secrets/service-token
sudo chmod 0600 /mnt/fleet-server-secrets/service-token</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <code class="literal">-n</code> flag is used with <code class="literal">echo</code> to prevent a newline character from being appended at the end of the secret. Be sure that the secret file does not contain the trailing newline character.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_secrets_in_containers"></a>Secrets in containers<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/fleet/fleet-server-secrets.asciidoc">edit</a></h4>
</div></div></div>
<p>When you are using secret files directly in containers without using Kubernetes or another secrets management solution, you can pass the files into containers by mounting the file or directory.
Provision the file in the same manner as it is in <a class="xref" href="secret-files-guide.html#secret-filesystem" title="Secrets on filesystem">Secrets on filesystem</a> and mount it in read-only mode. For example, when using Docker.</p>
<p>If you are using Elastic Agent image:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">docker run \
	-v /path/to/creds:/creds:ro \
        -e FLEET_SERVER_CERT_KEY_PASSPHRASE=/creds/passphrase \
        -e FLEET_SERVER_SERVICE_TOKEN_PATH=/creds/service-token \
        --rm docker.elastic.co/beats/elastic-agent</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_secrets_in_kubernetes"></a>Secrets in Kubernetes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/fleet/fleet-server-secrets.asciidoc">edit</a></h4>
</div></div></div>
<p>Kubernetes has a <a href="https://kubernetes.io/docs/concepts/configuration/secret/" class="ulink" target="_top">secrets management engine</a> that can be used to provision secret files to pods.</p>
<p>For example, you can create the passphrase secret with:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">kubectl create secret generic fleet-server-key-passphrase \
  --from-literal=value=PASSPHRASE</pre>
</div>
<p>And create the service token secret with:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">kubectl create secret generic fleet-server-service-token \
  --from-literal=value=SERVICE-TOKEN</pre>
</div>
<p>Then include it in the pod specification, for example, when you are running Fleet Server under Elastic Agent:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">spec:
  volumes:
  - name: key-passphrase
    secret:
      secretName: fleet-server-key-passphrase
  - name: service-token
    secret:
      secretName: fleet-server-service-token
  containers:
  - name: fleet-server
    image: docker.elastic.co/beats/elastic-agent
    volumeMounts:
    - name: key-passphrase
      mountPath: /var/secrets/passphrase
    - name: service-token
      mountPath: /var/secrets/service-token
    env:
    - name: FLEET_SERVER_CERT_KEY_PASSPHRASE
      value: /var/secrets/passphrase/value
    - name: FLEET_SERVER_SERVICE_TOKEN_PATH
      value: /var/secrets/service-token/value</pre>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_elastic_agent_kubernetes_secrets_provider"></a>Elastic Agent Kubernetes secrets provider<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/8.15/docs/en/ingest-management/fleet/fleet-server-secrets.asciidoc">edit</a></h5>
</div></div></div>
<p>When you are running Fleet Server under Elastic Agent in Kubernetes, you can use Elastic Agent&#8217;s <a class="xref" href="kubernetes_secrets-provider.html" title="Kubernetes Secrets Provider">Kubernetes Secrets Provider</a> to insert a Kubernetes secret directly into Fleet Server&#8217;s configuration.
Note that due to how Fleet Server is bootstrapped only the APM secrets (API key or secret token) can be specified with this provider.</p>
</div>

</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="fleet-server-secrets.html">« Fleet Server Secrets</a>
</span>
<span class="next">
<a href="fleet-server-monitoring.html">Monitor a self-managed Fleet Server »</a>
</span>
</div>
</body>
</html>
