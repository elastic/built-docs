<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Using a custom ingest pipeline with the Kubernetes Integration | Fleet and Elastic Agent Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Using a custom ingest pipeline with the Kubernetes Integration | Fleet and Elastic Agent Guide [master]">

<link rel="home" href="index.html" title="Fleet and Elastic Agent Guide [master]"/>
<link rel="up" href="install-elastic-agents-in-containers.html" title="Install Elastic Agents in a containerized environment"/>
<link rel="prev" href="scaling-on-kubernetes.html" title="Scaling Elastic Agent on Kubernetes"/>
<link rel="next" href="agent-environment-variables.html" title="Elastic Agent environment variables"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Fleet and Elastic Agent"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Fleet/Guide/Elastic Agent/master"/>
<meta name="DC.subject" content="Fleet and Elastic Agent"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="scaling-on-kubernetes.html">« Scaling Elastic Agent on Kubernetes</a>
</span>
<span class="next">
<a href="agent-environment-variables.html">Elastic Agent environment variables »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Fleet and Elastic Agent Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="elastic-agent-installation.html">Install Elastic Agents</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="install-elastic-agents-in-containers.html">Install Elastic Agents in a containerized environment</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Using a custom ingest pipeline with the Kubernetes Integration</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/main/docs/en/ingest-management/elastic-agent/ingest-pipeline-kubernetes.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="ingest-pipeline-kubernetes"></a>Using a custom ingest pipeline with the Kubernetes Integration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/main/docs/en/ingest-management/elastic-agent/ingest-pipeline-kubernetes.asciidoc">edit</a></h3>
</div></div></div>
<p>This tutorial explains how to add a custom ingest pipeline to a Kubernetes Integration in order to add specific metadata fields for deployments and cronjobs of pods.</p>
<p>Custom pipelines can be used to add custom data processing, like adding fields, obfuscating sensitive information, and more. Find more information in our tutorial about <a class="xref" href="ingest-pipeline-kubernetes.html" title="Using a custom ingest pipeline with the Kubernetes Integration">transforming data with custom ingest pipelines</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_metadata_enrichment_for_kubernetes"></a>Metadata enrichment for Kubernetes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/main/docs/en/ingest-management/elastic-agent/ingest-pipeline-kubernetes.asciidoc">edit</a></h4>
</div></div></div>
<p>The <a href="https://docs.elastic.co/en/integrations/kubernetes" class="ulink" target="_top">Kubernetes Integration</a> is used to collect logs and metrics from Kubernetes clusters with Elastic Agent. During the collection, the integration enhances the collected information with extra useful information that users can correlate with different Kubernetes assets. This additional information added on top of collected data, such as labels, annotations, ancestor names of Kubernetes assets, and others, are called metadata.</p>
<p>The <a href="/guide/en/fleet/current/kubernetes-provider.html" class="ulink" target="_top">Kubernetes Provider</a> offers the <code class="literal">add_resource_metadata</code> option to configure the metadata enrichment options.</p>
<p>For Elastic Agent versions &gt;[8.10.4], the default configuration for metadata enrichment is <code class="literal">add_resource_metadata.deployment=false</code> and <code class="literal">add_resource_metadata.cronjob=false</code>. This means that pods that are created from replicasets that belong to specific deployments would not be enriched with <code class="literal">kubernetes.deployment.name</code>. Additionally, pods that are created from jobs that belong to specific cronjobs, would not be enriched with <code class="literal">kubernetes.cronjob.name</code>.</p>
<p><span class="strong strong"><strong>Kubernetes Integration Policy &gt; Collect Kubernetes metrics from Kube-state-metrics &gt; Kubernetes Pod Metrics</strong></span></p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/add_resource_metadata.png" alt="Configure add_resource_metadata">
</div>
</div>
<p>Example: Enabling the enrichment through <code class="literal">add_resource_metadata</code> in a Managed Elastic Agent Policy</p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Note:</strong></span> Enabling deployment and cronjob metadata enrichment leads to an increase of Elastic Agent&#8217;s memory consumption. Elastic Agent uses a local cache in order to keep records of the Kubernetes assets from being discovered.</p>
</blockquote>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_add_deployment_and_cronjob_for_kubernetes_pods_through_ingest_pipelines"></a>Add deployment and cronjob for Kubernetes pods through ingest pipelines<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/main/docs/en/ingest-management/elastic-agent/ingest-pipeline-kubernetes.asciidoc">edit</a></h4>
</div></div></div>
<p>As an alternative to keeping the feature enabled and using more memory resources for Elastic Agent, users can make use of ingest pipelines to add the missing fields of <code class="literal">kubernetes.deployment.name</code> and <code class="literal">kubernetes.cronjob.name</code>.</p>
<p>Following the <a class="xref" href="ingest-pipeline-kubernetes.html" title="Using a custom ingest pipeline with the Kubernetes Integration">transforming data with custom ingest pipelines</a> tutorial, navigate to <code class="literal">state_pod</code> datastream under: <span class="strong strong"><strong>Kubernetes Integration Policy &gt; Collect Kubernetes metrics from Kube-state-metrics &gt; Kubernetes Pod Metrics</strong></span>.</p>
<p>Create the following custom ingest pipeline with two processors:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/ingest_pipeline_custom_k8s.png" alt="Custom ingest pipeline">
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_processor_for_deployment"></a>Processor for deployment<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/main/docs/en/ingest-management/elastic-agent/ingest-pipeline-kubernetes.asciidoc">edit</a></h5>
</div></div></div>
<div class="imageblock screenshot">
<div class="content">
<img src="images/gsub_deployment.png" alt="Gsub Processor for deployment">
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_processor_for_cronjob"></a>Processor for cronjob<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/ingest-docs/edit/main/docs/en/ingest-management/elastic-agent/ingest-pipeline-kubernetes.asciidoc">edit</a></h5>
</div></div></div>
<div class="imageblock screenshot">
<div class="content">
<img src="images/gsub_cronjob.png" alt="Gsub Processor for cronjob">
</div>
</div>
<p>The final <code class="literal">metrics-kubernetes.state_pod@custom</code> ingest pipeline:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">[
  {
    "gsub": {
      "field": "kubernetes.replicaset.name",
      "pattern": "(?:.(?!-))+$",
      "replacement": "",
      "target_field": "kubernetes.deployment.name",
      "ignore_missing": true,
      "ignore_failure": true
    }
  },
  {
    "gsub": {
      "field": "kubernetes.job.name",
      "pattern": "(?:.(?!-))+$",
      "replacement": "",
      "target_field": "kubernetes.cronjob.name",
      "ignore_missing": true,
      "ignore_failure": true
    }
  }
]</pre>
</div>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Note</strong></span>: The ingest pipeline does not check for the actual existence of a deployment and cronjob ancestor, it only adds the specific values.</p>
</blockquote>
</div>
</div>

</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="scaling-on-kubernetes.html">« Scaling Elastic Agent on Kubernetes</a>
</span>
<span class="next">
<a href="agent-environment-variables.html">Elastic Agent environment variables »</a>
</span>
</div>
</body>
</html>
