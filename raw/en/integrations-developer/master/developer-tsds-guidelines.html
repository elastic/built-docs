<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TSDS guidelines | Integrations Developer Guide | Elastic</title>
<meta class="elastic" name="content" content="TSDS guidelines | Integrations Developer Guide">

<link rel="home" href="index.html" title="Integrations Developer Guide"/>
<link rel="up" href="integrations-tsds-synthetic-source.html" title="Working with new indexing features"/>
<link rel="prev" href="integrations-tsds-synthetic-source.html" title="Working with new indexing features"/>
<link rel="next" href="testing-new-indexing-features.html" title="How to test new indexing features"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Integrations"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Integrations/Developer"/>
<meta name="DC.subject" content="Integrations"/>
<meta name="DC.identifier" content="master"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Integrations Developer Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="integrations-tsds-synthetic-source.html">Working with new indexing features</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="integrations-tsds-synthetic-source.html">« Working with new indexing features</a>
</span>
<span class="next">
<a href="testing-new-indexing-features.html">How to test new indexing features »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="developer-tsds-guidelines"></a>TSDS guidelines<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h2>
</div></div></div>
<p>This page describes how to enable TSDS functionality in your integration packages. Full details about TSDS can be found in <a href="/guide/en/elasticsearch/reference/master/tsds.html" class="ulink" target="_top">Time series data stream</a> in the Elasticsearch documentation.</p>
<p>In this document you can find:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="developer-tsds-guidelines.html#integrations-dev-tsds-background" title="Background">Background</a>
</li>
<li class="listitem">
<a class="xref" href="developer-tsds-guidelines.html#integrations-dev-tsds-migrating" title="Steps for enabling TSDS for a metrics dataset">Steps for enabling TSDS for a metrics dataset</a>
</li>
<li class="listitem">
<a class="xref" href="developer-tsds-guidelines.html#integrations-dev-tsds-testing" title="Testing">Testing</a>
</li>
<li class="listitem">
<a class="xref" href="developer-tsds-guidelines.html#integrations-dev-tsds-best-practices" title="Best practices">Best practices</a>
</li>
<li class="listitem">
<a class="xref" href="developer-tsds-guidelines.html#integrations-dev-tsds-troubleshooting" title="Troubleshooting">Troubleshooting</a>
</li>
</ul>
</div>
<h4><a id="integrations-dev-tsds-background"></a>Background<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h4>
<p>A time series is a sequence of observations for a specific entity. TSDS enables the column-oriented functionality in elasticsearch by co-locating the data and optimizing the storage and aggregations to take advantage of such co-allocation.</p>
<p>Integrations are one of the biggest sources of input data to Elasticsearch. Enabling TSDS on integration packages can be achieved by minimal changes made in the <code class="literal">fields.yml</code> and <code class="literal">manifest.yml</code> files of a package.</p>
<h4><a id="integrations-dev-tsds-migrating"></a>Steps for enabling TSDS for a metrics dataset<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h4>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Datastreams having type <code class="literal">logs</code> are excluded from TSDS migration.</p>
</div>
</div>
<h4><a id="_step_1_set_the_dimension_fields"></a>Step 1: Set the dimension fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h4>
<p>Each field belonging to the set of fields that uniquely identify a document is a dimension. For more details, refer to <a href="/guide/en/elasticsearch/reference/master/tsds.html#time-series-dimension" class="ulink" target="_top">Dimensions</a>.</p>
<p>To set a field as a dimension simply add <code class="literal">dimension: true</code> to its mapping:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">- name: ApiId
  type: keyword
  dimension: true</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>A field having type <a href="/guide/en/elasticsearch/reference/master/flattened.html" class="ulink" target="_top">flattened</a> cannot be selected as a dimension field. If the field that you are choosing as a dimension is too long or is of type flattened, consider hashing the value of this field and using the result as a dimension. <a href="/guide/en/elasticsearch/reference/master/fingerprint-processor.html" class="ulink" target="_top">Fingerprint processor</a> can be used for this purpose.</p>
<p>You can find an example in <a href="https://github.com/elastic/integrations/blob/8a57d6ba96d391afc33da20c80ec51280d22f009/packages/oracle/data_stream/performance/elasticsearch/ingest_pipeline/default.yml#LL127C4-L131C29" class="ulink" target="_top">Oracle Integration TSDS Enablement Example</a></p>
</div>
</div>
<p>Important considerations:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>There is a limit on how many dimension fields a datastream can have. By default, this value is <code class="literal">21</code>. You can adjust this restriction by altering the <code class="literal">index.mapping.dimension_fields.limit</code>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">elasticsearch:
  index_template:
    settings:
      index.mapping.dimension_fields.limit: 32 # Defaults to 21</pre>
</div>
</li>
<li class="listitem">
Dimension keys have a hard limit of 512b. Documents are rejected if this limit is reached.
</li>
<li class="listitem">
Dimension values have a hard limit of 1024b. Documents are rejected if this limit is reached.
</li>
</ul>
</div>
<h5><a id="_ecs_fields"></a>ECS fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h5>
<p>There are fields that are part of every package, and they are potential candidates for becoming dimension fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">host.name</code>
</li>
<li class="listitem">
<code class="literal">service.address</code>
</li>
<li class="listitem">
<code class="literal">agent.id</code>
</li>
<li class="listitem">
<code class="literal">container.id</code>
</li>
</ul>
</div>
<p>For products that are capable of running both on-premise and in a public cloud environment (by being deployed on public cloud virtual machines), it is recommended to annotate the ECS fields listed below as dimension fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">host.name</code>
</li>
<li class="listitem">
<code class="literal">service.address</code>
</li>
<li class="listitem">
<code class="literal">container.id</code>
</li>
<li class="listitem">
<code class="literal">cloud.account.id</code>
</li>
<li class="listitem">
<code class="literal">cloud.provider</code>
</li>
<li class="listitem">
<code class="literal">cloud.region</code>
</li>
<li class="listitem">
<code class="literal">cloud.availability_zone</code>
</li>
<li class="listitem">
<code class="literal">agent.id</code>
</li>
<li class="listitem">
<code class="literal">cloud.instance.id</code>
</li>
</ul>
</div>
<p>For products operating as managed services within cloud providers like AWS, Azure, and GCP, it is advised to label the fields listed below as dimension fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">cloud.account.id</code>
</li>
<li class="listitem">
<code class="literal">cloud.region</code>
</li>
<li class="listitem">
<code class="literal">cloud.availability_zone</code>
</li>
<li class="listitem">
<code class="literal">cloud.provider</code>
</li>
<li class="listitem">
<code class="literal">agent.id</code>
</li>
</ul>
</div>
<p>Note that for some packages some of these fields do not hold any value, so make sure to only use the needed ones.</p>
<h5><a id="_integration_specific_fields"></a>Integration specific fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h5>
<p>The <code class="literal">files.yml</code> file has the field mappings specific to a datastream of an integration. Some of these fields might need to be set as a dimension if the set of dimension fields in ECS is not enough to create a unique <a href="/guide/en/elasticsearch/reference/master/tsds.html#tsid" class="ulink" target="_top"><code class="literal">_tsid</code></a>.</p>
<p>Adding an inline comment prior to the dimension annotation is advised, detailing the rationale behind the choice of a particular field as a dimension field:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">```
- name: wait_class
  type: keyword
  # Multiple events are generated based on the values of wait_class. Hence, it is a dimension
  dimension: true
  description: Every wait event belongs to a class of wait events.
```</pre>
</div>
<h4><a id="_step_2_set_type_for_metric_fields"></a>Step 2: Set type for metric fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h4>
<p>Metrics are fields that contain numeric measurements, as well as aggregations and/or down sampling values based off of those measurements. Annotate each metric with the correct metric type. The <a href="/guide/en/elasticsearch/reference/master/tsds.html#time-series-metric" class="ulink" target="_top">currently supported values</a> are <code class="literal">gauge</code>, <code class="literal">counter</code>, and <code class="literal">null</code>.</p>
<p>Example of adding a metric type to a field:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">- name: compactions_failed
  type: double
  metric_type: counter
  description: |
    Counter of TSM compactions by level that have failed due to error.</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Some of the aggregation functions are not supported for certain <code class="literal">metric_type</code> values. In such a scenario, please revisit to see if the selection of <code class="literal">metric_type</code> you made is indeed correct for that field. If valid, please create an issue in <a href="https://github.com/elastic/elasticsearch" class="ulink" target="_top">elastic/elasticsearch</a> explaining the use case.</p>
</div>
</div>
<h4><a id="_step_3_update_kibana_version"></a>Step 3: Update Kibana version<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h4>
<p>Modify the <code class="literal">kibana.version</code> to at least <code class="literal">8.8.0</code> in the <code class="literal">manifest.yml</code> file of the package:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">conditions:
 kibana.version: "^8.8.0"</pre>
</div>
<h4><a id="_step_4_enable_time_series_index_mode"></a>Step 4: Enable <code class="literal">time_series</code> index mode<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h4>
<p>Add the changes to the <code class="literal">manifest.yml</code> file of the datastream as shown to enable the timeseries index mode:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">elasticsearch:
  index_mode: "time_series"</pre>
</div>
<h4><a id="integrations-dev-tsds-testing"></a>Testing<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If the number of dimensions is insufficient, we will have loss of data. Consider testing this using the <a href="https://github.com/elastic/TSDB-migration-test-kit" class="ulink" target="_top">TSDS migration test kit</a>.
</li>
<li class="listitem">
Verify the dashboard is rendering the data properly. If certain visualisation do not work, consider migrating to <a href="/guide/en/kibana/master/lens.html" class="ulink" target="_top">Lens</a>. Remember that certain aggregation functions are not supported when a field has metric type <code class="literal">counter</code>, for example, <code class="literal">avg()</code>. Replace such aggregation functions with a supported aggregation type such as <code class="literal">max()</code> or <code class="literal">min()</code>.
</li>
</ul>
</div>
<h4><a id="integrations-dev-tsds-best-practices"></a>Best practices<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Use <a href="/guide/en/kibana/master/lens.html" class="ulink" target="_top">Lens</a> as the preferred visualisation type.
</li>
<li class="listitem">
Always assess the number of unique values the field that is selected to be a dimension would hold, especially if it is a numeric field. A field that holds millions of unique values may not be an ideal candidate for becoming a dimension field.
</li>
<li class="listitem">
If the dimension field value length is very long (max limit is 1024B), consider transforming the value to hash value representation. <a href="/guide/en/elasticsearch/reference/master/fingerprint-processor.html" class="ulink" target="_top">Fingerprint processor</a> can be used for this purpose.
</li>
<li class="listitem">
In the field mapping files above each dimension field, add in-line comments stating the reason for selecting the field as a dimension field.
</li>
<li class="listitem">
As part of TSDS migration testing, you may discover other errors which may be unrelated to TSDS migration. Keep the pull request for TSDS migration free from such changes. This helps in obtaining quick PR approval.
</li>
</ul>
</div>
<h4><a id="integrations-dev-tsds-troubleshooting"></a>Troubleshooting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h4>
<h5><a id="_dropped_documents"></a>Dropped documents<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h5>
<p>In the event that after enabling TSDS you notice that metrics data is being dropped from an index, the <a href="https://github.com/elastic/TSDB-migration-test-kit" class="ulink" target="_top">TSDS test migration kit</a> can be used as a helpful debugging tool.</p>
<h5><a id="_conflicting_field_type"></a>Conflicting field type<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h5>
<p>Fields having conflicting field type will not be considered as dimension. Resolve the field type ambiguity before defining a field as dimension field.</p>
<h5><a id="_identification_of_write_index"></a>Identification of write index<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/integrations/integrations-tsds-synthetic-source.asciidoc">edit</a></h5>
<p>When mappings are modified for a datastream, index rollover happens and a new index is created under the datastream. Even if there exists a new index, the data continues to go to the old index until the timestamp matches <code class="literal">index.time_series.start_time</code> of the newly created index.</p>
<p>An <a href="https://github.com/elastic/kibana/issues/150549" class="ulink" target="_top">enhancement request</a> for Kibana is created to indicate the write index. Until then, refer to the index.time_series.start_time of indices and compare with the current time to identify the write index.</p>
<p>If you find this error (for reference, see <a href="https://github.com/elastic/integrations/issues/7345" class="ulink" target="_top">integrations issue #7345</a> and <a href="https://github.com/elastic/elasticsearch/pull/98518" class="ulink" target="_top">elasticsearch PR #98518</a>):</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">... (status=400): {"type":"illegal_argument_exception","reason":"the document timestamp [2023-08-07T00:00:00.000Z] is outside of ranges of currently writable indices [[2023-08-07T08:55:38.000Z,2023-08-07T12:55:38.000Z]]"}, dropping event!</pre>
</div>
<div class="console_widget" data-snippet="snippets/24.console"></div>
<p>Consider:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Defining the <code class="literal">look_ahead</code> or <code class="literal">look_back_time</code> for each data stream. For example:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">elasticsearch:
  index_mode: "time_series"
  index_template:
    settings:
      index.look_ahead_time: "10h"</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Updating the package with this does not cause an automatic rollover on the data stream. You have to do that manually.</p>
</div>
</div>
</li>
<li class="listitem">
Updating the <code class="literal">timestamp</code> of the document being rejected.
</li>
<li class="listitem">
Finding a fix to receive the document without a delay.
</li>
</ol>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="integrations-tsds-synthetic-source.html">« Working with new indexing features</a>
</span>
<span class="next">
<a href="testing-new-indexing-features.html">How to test new indexing features »</a>
</span>
</div>
</div>
</body>
</html>
