<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Custom Azure Logs | Elastic integrations | Elastic</title>
<meta class="elastic" name="content" content="Custom Azure Logs | Elastic integrations">

<link rel="home" href="index.html" title="Elastic integrations"/>
<link rel="up" href="azure.html" title="Azure Logs Integration"/>
<link rel="prev" href="azure_metrics-container_service.html" title="Azure Container Service Integration"/>
<link rel="next" href="azure_blob_storage.html" title="Custom Azure Blob Storage Input"/>
<meta class="elastic" name="product_version" content="main"/>
<meta class="elastic" name="product_name" content="Integrations"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Integrations/Reference"/>
<meta name="DC.subject" content="Integrations"/>
<meta name="DC.identifier" content="main"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="azure_metrics-container_service.html">« Azure Container Service Integration</a>
</span>
<span class="next">
<a href="azure_blob_storage.html">Custom Azure Blob Storage Input »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic integrations</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="azure.html">Azure Logs Integration</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Custom Azure Logs</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="azure_logs"></a>Custom Azure Logs</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
</div></div></div>

<div class="condensed-table">
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>Version</strong></span></p></td>
<td align="left" valign="top"><p>0.1.0 <span class="Admonishment Admonishment--beta">
[<span class="Admonishment-title u-mono">beta</span>]
<span class="Admonishment-detail">
This functionality is in beta and is subject to change. The design and code is less mature than official GA features and is being provided as-is with no warranties. Beta features are not subject to the support SLA of official GA features.
</span>
</span> (<a class="xref" href="azure_logs.html#azure_logs-changelog" title="Changelog">View all</a>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>Compatible Kibana version(s)</strong></span></p></td>
<td align="left" valign="top"><p>8.13.0 or higher</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>Supported Serverless project types</strong></span><br>
 <a class="xref" href="serverless-support.html" title="Supported Serverless project types"><span class="small">What&#8217;s this?</span></a></p></td>
<td align="left" valign="top"><p>Security<br>
Observability</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>Subscription level</strong></span><br>
<a href="/subscriptions" class="ulink" target="_top"><span class="small">What&#8217;s this?</span></a></p></td>
<td align="left" valign="top"><p>Basic</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>Level of support</strong></span><br>
<a class="xref" href="support.html" title="Level of support"><span class="small">What&#8217;s this?</span></a></p></td>
<td align="left" valign="top"><p>Elastic</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The Custom Azure Logs integration collects logs from Azure Event Hubs.</p>
<p>Use the integration to collect logs from:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Azure services that support exporting logs to Event Hubs
</li>
<li class="listitem">
Any other source that can send logs to an Event Hubs
</li>
</ul>
</div>
<div class="position-relative"><h4><a id="azure_logs-data-streams"></a>Data streams</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>The Custom Azure Logs integration only supports logs data streams.</p>
<p>This custom integration does not use a predefined Elastic data stream like standard integrations do (for example, <code class="literal">logs-azure.activitylogs-default</code> for Activity logs). You can take control and build your own data stream by selecting your dataset and namespace of choice when configuring the integration.</p>
<p>For example, if you select <code class="literal">mydataset</code> as your dataset, and <code class="literal">default</code> as your namespace, the integration will send the data to the <code class="literal">logs-mydataset-default</code> data stream.</p>
<p>The integration sets up a dedicated index template named <code class="literal">logs-mydataset</code> with the <code class="literal">logs-mydataset-*</code> index pattern. You can then customize it using a custom pipeline and custom mappings.</p>
<p>Custom Logs integrations give you all the flexibility you need to configure the integration to your needs.</p>
<div class="position-relative"><h4><a id="azure_logs-requirements"></a>Requirements</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>You need Elasticsearch to store and search for your data and Kibana to visualize and manage it.
You can use our recommended hosted Elasticsearch Service on Elastic Cloud or self-manage the Elastic Stack on your own hardware.</p>
<p>Before using the Custom Azure Logs, you will need:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
One <span class="strong strong"><strong>event hub</strong></span> to store in-flight logs exported by Azure services (or other sources) and make them available to Elastic Agent.
</li>
<li class="listitem">
A <span class="strong strong"><strong>Storage Account</strong></span> to store checkpoint information about logs the Elastic Agent consumes.
</li>
</ul>
</div>
<div class="position-relative"><h5><a id="azure_logs-event-hub"></a>Event hub</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p><a href="https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-about" class="ulink" target="_top">Azure Event Hubs</a> is a data streaming platform and event ingestion service that can receive and temporarily store millions of events.</p>
<p>Elastic Agent with the Custom Azure Logs integration will consume logs from the Event Hubs service.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">  ┌────────────────┐      ┌───────────┐
  │   myeventhub   │      │  Elastic  │
  │ &lt;&lt;Event Hub&gt;&gt;  │─────▶│   Agent   │
  └────────────────┘      └───────────┘</pre>
</div>
<p>To learn more about Event Hubs, refer to <a href="https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-features" class="ulink" target="_top">Features and terminology in Azure Event Hubs</a>.</p>
<div class="position-relative"><h5><a id="azure_logs-storage-account-container"></a>Storage Account Container</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>The <a href="https://learn.microsoft.com/en-us/azure/storage/common/storage-account-overview" class="ulink" target="_top">Storage Account</a> is a versatile Azure service that allows you to store data in various storage types, including blobs, file shares, queues, tables, and disks.</p>
<p>The Custom Azure Logs integration requires a Storage Account container to work.</p>
<p>The integration uses the Storage Account container for checkpointing. It stores data about the Consumer Group (state, position, or offset) and shares it among the Elastic Agents. Sharing such information allows multiple Elastic Agents assigned to the same agent policy to work together, enabling horizontal scaling of the logs processing when required.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">  ┌────────────────┐                     ┌───────────┐
  │   myeventhub   │        logs         │  Elastic  │
  │ &lt;&lt;event hub&gt;&gt;  │────────────────────▶│   Agent   │
  └────────────────┘                     └───────────┘
                                                │
                       consumer group info      │
  ┌────────────────┐   (state, position, or     │
  │ log-myeventhub │         offset)            │
  │ &lt;&lt;container&gt;&gt;  │◀───────────────────────────┘
  └────────────────┘</pre>
</div>
<p>The Elastic Agent automatically creates one container for the Custom Azure Logs integration and one blob for each partition on the event hub.</p>
<p>For example, if the integration is configured to fetch data from an event hub with four partitions, the Agent will create the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
One Storage Account container.
</li>
<li class="listitem">
Four blobs in that container.
</li>
</ul>
</div>
<p>The information stored in the blobs is small (usually &lt; 500 bytes per blob) and accessed frequently. Elastic recommends using the Hot storage tier.</p>
<p>You need to keep the Storage Account container as long as you need to run the integration with the Elastic Agent. If you delete a Storage Account container, the Elastic Agent will stop working and create a new one the next time it starts.</p>
<p>By deleting a Storage Account container, the Elastic Agent will lose track of the last message processed and start processing messages from the beginning of the event hub retention period.</p>
<div class="position-relative"><h4><a id="azure_logs-setup"></a>Setup</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>Before adding the integration, complete the following tasks.</p>
<div class="position-relative"><h5><a id="azure_logs-create-an-event-hub"></a>Create an event hub</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>The event hub receives the logs exported from the Azure service and makes them available for the Elastic Agent to read.</p>
<p>Here&#8217;s a high-level overview of the required steps:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Create a resource group, or select an existing one.
</li>
<li class="listitem">
Create an Event Hubs namespace.
</li>
<li class="listitem">
Create an event hub.
</li>
</ul>
</div>
<p>For a step-by-step guide, check the quickstart <a href="https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-create" class="ulink" target="_top">Create an event hub using Azure portal</a>.</p>
<p>Take note of the event hub <span class="strong strong"><strong>Name</strong></span>, which you will use later when specifying an <span class="strong strong"><strong>eventhub</strong></span> in the integration settings.</p>
<div class="position-relative"><h6><a id="azure_logs-event-hubs-namespace-vs-event-hub"></a>Event Hubs namespace vs event hub</h6><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>In the integration settings, you should use the event hub name (not the Event Hubs namespace name) as the value for the  <span class="strong strong"><strong>event hub</strong></span> option.</p>
<p>If you are new to Event Hubs, think of the Event Hubs namespace as the cluster and the event hub as the topic. You will typically have one cluster and multiple topics.</p>
<p>If you are familiar with Kafka, here&#8217;s a conceptual mapping between the two:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Kafka Concept</th>
<th align="left" valign="top">Event Hubs Concept</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>Cluster</p></td>
<td align="left" valign="top"><p>Namespace</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Topic</p></td>
<td align="left" valign="top"><p>Event hub</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Partition</p></td>
<td align="left" valign="top"><p>Partition</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Consumer Group</p></td>
<td align="left" valign="top"><p>Consumer group</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Offset</p></td>
<td align="left" valign="top"><p>Offset</p></td>
</tr>
</tbody>
</table>
</div>
<div class="position-relative"><h6><a id="azure_logs-how-many-partitions"></a>How many partitions?</h6><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>The number of partitions is essential to balance the event hub cost and performance.</p>
<p>Here are a few examples with one or multiple agents, with recommendations on picking the correct number of partitions for your use case.</p>
<div class="position-relative"><h7><a id="azure_logs-single-agent"></a>Single Agent</h7><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>With a single Agent deployment, increasing the number of partitions on the event hub is the primary driver in scale-up performances. The Agent creates one worker for each partition.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐    ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐

│                         │    │                         │

│   ┌─────────────────┐   │    │   ┌─────────────────┐   │
    │   partition 0   │◀───────────│     worker      │
│   └─────────────────┘   │    │   └─────────────────┘   │
    ┌─────────────────┐            ┌─────────────────┐
│   │   partition 1   │◀──┼────┼───│     worker      │   │
    └─────────────────┘            └─────────────────┘
│   ┌─────────────────┐   │    │   ┌─────────────────┐   │
    │   partition 2   │◀────────── │     worker      │
│   └─────────────────┘   │    │   └─────────────────┘   │
    ┌─────────────────┐            ┌─────────────────┐
│   │   partition 3   │◀──┼────┼───│     worker      │   │
    └─────────────────┘            └─────────────────┘
│                         │    │                         │

│                         │    │                         │

└ Event hub ─ ─ ─ ─ ─ ─ ─ ┘    └ Elastic Agent ─ ─ ─ ─ ─ ┘</pre>
</div>
<div class="position-relative"><h7><a id="azure_logs-two-or-more-elastic-agents"></a>Two or more Elastic Agents</h7><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>With more than one Elastic Agent, setting the number of partitions is crucial. The agents share the existing partitions to scale out performance and improve availability.</p>
<p>The number of partitions must be at least the number of agents.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐    ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐

│                         │    │   ┌─────────────────┐   │
                            ┌──────│     worker      │
│   ┌─────────────────┐   │ │  │   └─────────────────┘   │
    │   partition 0   │◀────┘      ┌─────────────────┐
│   └─────────────────┘   │ ┌──┼───│     worker      │   │
    ┌─────────────────┐     │      └─────────────────┘
│   │   partition 1   │◀──┼─┘  │                         │
    └─────────────────┘         ─Agent─ ─ ─ ─ ─ ─ ─ ─ ─ ─
│   ┌─────────────────┐   │    ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
    │   partition 2   │◀────┐
│   └─────────────────┘   │ │  │  ┌─────────────────┐    │
    ┌─────────────────┐     └─────│     worker      │
│   │   partition 3   │◀──┼─┐  │  └─────────────────┘    │
    └─────────────────┘     │     ┌─────────────────┐
│                         │ └──┼──│     worker      │    │
                                  └─────────────────┘
│                         │    │                         │

└ Event hub ─ ─ ─ ─ ─ ─ ─ ┘    └ Elastic Agent ─ ─ ─ ─ ─ ┘</pre>
</div>
<div class="position-relative"><h7><a id="azure_logs-recommendations"></a>Recommendations</h7><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>Create an event hub with at least two partitions. Two partitions allow low-volume deployment to support high availability with two agents. Consider creating four partitions or more to handle medium-volume deployments with availability.</p>
<p>To learn more about event hub partitions, check this guide from Microsoft at <a href="https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-create" class="ulink" target="_top">https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-create</a>.</p>
<p>To learn more about event hub partition from the performance perspective, check the scalability-focused document at <a href="https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-scalability#partitions" class="ulink" target="_top">https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-scalability#partitions</a>.</p>
<div class="position-relative"><h6><a id="azure_logs-consumer-group"></a>Consumer group</h6><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>Like all other event hub clients, Elastic Agent needs a consumer group name to access the event hub.</p>
<p>A Consumer Group is a view (state, position, or offset) of an entire event hub. Consumer groups enable multiple agents to have a separate view of the event stream and to read the logs independently at their own pace and with their offsets.</p>
<p>Consumer groups allow multiple Elastic Agents assigned to the same agent policy to work together, enabling horizontal scaling of log processing when required.</p>
<p>In most cases, you can use the default consumer group named <code class="literal">$Default</code>. If <code class="literal">$Default</code> is already used by other applications, you can create a consumer group dedicated to the Azure Logs integration.</p>
<div class="position-relative"><h6><a id="azure_logs-connection-string"></a>Connection string</h6><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>The Elastic Agent requires a connection string to access the event hub and fetch the exported logs. The connection string contains details about the event hub used and the credentials required to access it.</p>
<p>To get the connection string for your Event Hubs namespace:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Visit the <span class="strong strong"><strong>Event Hubs namespace</strong></span> you created in a previous step.
</li>
<li class="listitem">
Select <span class="strong strong"><strong>Settings</strong></span> &gt; <span class="strong strong"><strong>Shared access policies</strong></span>.
</li>
</ol>
</div>
<p>Create a new Shared Access Policy (SAS):</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Select <span class="strong strong"><strong>Add</strong></span> to open the creation panel.
</li>
<li class="listitem">
Add a <span class="strong strong"><strong>Policy name</strong></span> (for example, "ElasticAgent").
</li>
<li class="listitem">
Select the <span class="strong strong"><strong>Listen</strong></span> claim.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create</strong></span>.
</li>
</ol>
</div>
<p>When the SAS Policy is ready, select it to display the information panel.</p>
<p>Take note of the <span class="strong strong"><strong>Connection string–primary key</strong></span>, which you will use later when specifying a <span class="strong strong"><strong>connection_string</strong></span> in the integration settings.</p>
<div class="position-relative"><h5><a id="azure_logs-create-a-diagnostic-settings"></a>Create a diagnostic settings</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>The diagnostic settings export the logs from Azure services to a destination, and to use Azure Logs integration, it must be an event hub.</p>
<p>To create a diagnostic settings to export logs:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Locate the diagnostic settings for the service (for example, Microsoft Entra ID).
</li>
<li class="listitem">
Select diagnostic settings in the <span class="strong strong"><strong>Monitoring</strong></span> section of the service. Note that different services might place the diagnostic settings in various positions.
</li>
<li class="listitem">
Select <span class="strong strong"><strong>Add diagnostic settings</strong></span>.
</li>
</ol>
</div>
<p>In the diagnostic settings page, you must select the source log categories you want to export and then select their destination.</p>
<div class="position-relative"><h6><a id="azure_logs-select-log-categories"></a>Select log categories</h6><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>Each Azure service exports a well-defined list of log categories. Check the individual integration documentation to check the supported log categories.</p>
<div class="position-relative"><h6><a id="azure_logs-select-the-destination"></a>Select the destination</h6><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>Select the <span class="strong strong"><strong>subscription</strong></span> and the <span class="strong strong"><strong>Event Hubs namespace</strong></span> you previously created. Select the event hub dedicated to this integration.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">  ┌───────────────┐   ┌──────────────┐   ┌───────────────┐      ┌───────────┐
  │  MS Entra ID  │   │  Diagnostic  │   │     adlogs    │      │  Elastic  │
  │  &lt;&lt;service&gt;&gt;  ├──▶│   Settings   │──▶│ &lt;&lt;event hub&gt;&gt; │─────▶│   Agent   │
  └───────────────┘   └──────────────┘   └───────────────┘      └───────────┘</pre>
</div>
<div class="position-relative"><h5><a id="azure_logs-create-a-storage-account-container"></a>Create a Storage Account Container</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>The Elastic Agent stores the consumer group information (state, position, or offset) in a Storage Account container. Making this information available to all agents allows them to share the logs processing and resume from the last processed logs after a restart.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Use the Storage Account as a checkpoint store only.</p>
</div>
</div>
<p>To create the Storage Account:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Sign in to the <a href="https://portal.azure.com/" class="ulink" target="_top">Azure Portal</a> and create your Storage Account.
</li>
<li class="listitem">
<p>While configuring your project details, make sure you select the following recommended default settings:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Hierarchical namespace: disabled
</li>
<li class="listitem">
Minimum TLS version: Version 1.2
</li>
<li class="listitem">
Access tier: Hot
</li>
<li class="listitem">
Enable soft delete for blobs: disabled
</li>
<li class="listitem">
Enable soft delete for containers: disabled
</li>
</ul>
</div>
</li>
<li class="listitem">
When the new Storage Account is ready, take note of the Storage Account name and access keys, as you will use them later to authenticate your Elastic application&#8217;s requests to this Storage Account.
</li>
</ol>
</div>
<p>This is the final diagram of the setup for collecting Activity logs from the Azure Monitor service.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text"> ┌───────────────┐   ┌──────────────┐   ┌────────────────┐         ┌───────────┐
 │  MS Entra ID  │   │  Diagnostic  │   │     adlogs     │  logs   │  Elastic  │
 │  &lt;&lt;service&gt;&gt;  ├──▶│   Settings   │──▶│ &lt;&lt;event hub&gt;&gt;  │────────▶│   Agent   │
 └───────────────┘   └──────────────┘   └────────────────┘         └───────────┘
                                                                          │
                     ┌──────────────┐          consumer group info        │
                     │  azurelogs   │          (state, position, or       │
                     │&lt;&lt;container&gt;&gt; │◀───────────────offset)──────────────┘
                     └──────────────┘</pre>
</div>
<div class="position-relative"><h6><a id="azure_logs-storage-account-containers"></a>Storage Account containers?</h6><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>The Elastic Agent can use one Storage Account (SA) for multiple integrations.</p>
<p>The Agent creates one SA container for the integration. The SA container name combines the event hub name and a prefix (<code class="literal">azure-eventhub-input-[eventhub]</code>).</p>
<div class="position-relative"><h5><a id="azure_logs-running-the-integration-behind-a-firewall"></a>Running the integration behind a firewall</h5><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>When you run the Elastic Agent behind a firewall, you must allow traffic on ports <code class="literal">5671</code> and <code class="literal">5672</code> for the event hub and port <code class="literal">443</code> for the Storage Account container to ensure proper communication with the necessary components.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">┌────────────────────────────────┐  ┌───────────────────┐  ┌───────────────────┐
│                                │  │                   │  │                   │
│ ┌────────────┐   ┌───────────┐ │  │  ┌──────────────┐ │  │ ┌───────────────┐ │
│ │ diagnostic │   │ event hub │ │  │  │azure-eventhub│ │  │ │ activity logs │ │
│ │  setting   │──▶│           │◀┼AMQP─│  &lt;&lt;input&gt;&gt;   │─┼──┼▶│&lt;&lt;data stream&gt;&gt;│ │
│ └────────────┘   └───────────┘ │  │  └──────────────┘ │  │ └───────────────┘ │
│                                │  │          │        │  │                   │
│                                │  │          │        │  │                   │
│                                │  │          │        │  │                   │
│         ┌─────────────┬─────HTTPS─┼──────────┘        │  │                   │
│ ┌───────┼─────────────┼──────┐ │  │                   │  │                   │
│ │       │             │      │ │  │                   │  │                   │
│ │       ▼             ▼      │ │  └─Agent─────────────┘  └─Elastic Cloud─────┘
│ │ ┌──────────┐  ┌──────────┐ │ │
│ │ │    0     │  │    1     │ │ │
│ │ │ &lt;&lt;blob&gt;&gt; │  │ &lt;&lt;blob&gt;&gt; │ │ │
│ │ └──────────┘  └──────────┘ │ │
│ │                            │ │
│ │                            │ │
│ └─Storage Account Container──┘ │
│                                │
│                                │
└─Azure──────────────────────────┘</pre>
</div>
<div class="position-relative"><h6><a id="_event_hub_3"></a>Event hub</h6><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>Port <code class="literal">5671</code> and <code class="literal">5672</code> are commonly used for secure communication with the event hub. These ports are used to receive events. The Elastic Agent can establish a secure connection with the event hub by allowing traffic on these ports.</p>
<p>For more information, check the following documents:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-faq#what-ports-do-i-need-to-open-on-the-firewall" class="ulink" target="_top">What ports do I need to open on the firewall?</a> from the <a href="https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-faq#what-ports-do-i-need-to-open-on-the-firewall" class="ulink" target="_top">Event Hubs frequently asked questions</a>.
</li>
<li class="listitem">
<a href="https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-amqp-protocol-guide#amqp-outbound-port-requirements" class="ulink" target="_top">AMQP outbound port requirements</a>
</li>
</ul>
</div>
<div class="position-relative"><h6><a id="_storage_account_container_3"></a>Storage Account container</h6><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>Port <code class="literal">443</code> is used for secure communication with the Storage Account container. This port is commonly used for HTTPS traffic. By allowing traffic on port 443, the Elastic Agent can securely access and interact with the Storage Account container, essential for storing and retrieving checkpoint data for each event hub partition.</p>
<div class="position-relative"><h6><a id="azure_logs-dns"></a>DNS</h6><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>Optionally, you can restrict the traffic to the following domain names:</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">*.servicebus.windows.net
*.blob.core.windows.net
*.cloudapp.net</pre>
</div>
<div class="position-relative"><h4><a id="azure_logs-settings"></a>Settings</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>Use the following settings to configure the Azure Logs integration when you add it to Fleet.</p>
<p><code class="literal">eventhub</code> :
<em>string</em>
A fully managed, real-time data ingestion service. Elastic recommends using only letters, numbers, and the hyphen (-) character for event hub names to maximize compatibility. You can use existing event hubs having underscores (_) in the event hub name; in this case, the integration will replace underscores with hyphens (-) when it uses the event hub name to create dependent Azure resources behind the scenes (e.g., the Storage Account container to store event hub consumer offsets). Elastic also recommends using a separate event hub for each log type as the field mappings of each log type differ.
Default value <code class="literal">insights-operational-logs</code>.</p>
<p><code class="literal">consumer_group</code> :
<em>string</em>
Enable the publish/subscribe mechanism of Event Hubs with consumer groups. A consumer group is a view (state, position, or offset) of an entire event hub. Consumer groups enable multiple consuming applications to each have a separate view of the event stream, and to read the stream independently at their own pace and with their own offsets.
Default value: <code class="literal">$Default</code></p>
<p><code class="literal">connection_string</code> :
<em>string</em></p>
<p>The connection string is required to communicate with Event Hubs. Check <a href="https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-get-connection-string" class="ulink" target="_top">Get an Event Hubs connection string</a> for more information.</p>
<p>A Blob Storage Account is required to store/retrieve/update the checkpoint information of the event hub messages. This allows the integration to resume processing messages left when the user stops it.</p>
<p><code class="literal">storage_account</code> :
<em>string</em>
The name of the Storage Account that stores the checkpoint information.
<code class="literal">storage_account_key</code> :
<em>string</em>
The Storage Account key. Key to authorize access to data in your Storage Account.</p>
<p><code class="literal">storage_account_container</code> :
<em>string</em>
The Storage Account container is where the integration stores the checkpoint data for the consumer group. It is an advanced option to use with extreme care. You MUST use a dedicated Storage Account container for each Azure log type (activity, sign-in, audit logs, and others). DO NOT REUSE the same container name for more than one Azure log type. Check <a href="https://docs.microsoft.com/en-us/rest/api/storageservices/naming-and-referencing-containers&#8212;&#8203;blobs&#8212;&#8203;and-metadata#container-names" class="ulink" target="_top">Container Names</a> for details on naming rules from Microsoft. The integration generates a default container name if not specified.</p>
<p><code class="literal">pipeline</code> :
<em>string</em>
Optional. Overrides the default ingest pipeline for this integration.</p>
<p><code class="literal">resource_manager_endpoint</code> :
<em>string</em>
Optional. By default, the integration uses the Azure public environment. To override this and use a different Azure environment, users can provide a specific resource manager endpoint.</p>
<p>Examples:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Azure ChinaCloud: <code class="literal">https://management.chinacloudapi.cn/</code>
</li>
<li class="listitem">
Azure GermanCloud: <code class="literal">https://management.microsoftazure.de/</code>
</li>
<li class="listitem">
Azure PublicCloud: <code class="literal">https://management.azure.com/</code>
</li>
<li class="listitem">
Azure USGovernmentCloud: <code class="literal">https://management.usgovcloudapi.net/</code>
</li>
</ul>
</div>
<p>This setting can also define your endpoints, like for hybrid cloud models.</p>
<div class="position-relative"><h4><a id="azure_logs-handling-malformed-json-in-azure-logs"></a>Handling Malformed JSON in Azure Logs</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<p>Azure services have been observed occasionally sending <a href="https://learn.microsoft.com/en-us/answers/questions/1001797/invalid-json-logs-produced-for-function-apps" class="ulink" target="_top">malformed JSON</a> documents. These logs can disrupt the expected JSON formatting and lead to parsing issues during processing.</p>
<p>To address this issue, the advanced settings section of each data stream offers two sanitization options:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Sanitizes New Lines: removes new lines in logs.
</li>
<li class="listitem">
Sanitizes Single Quotes: Replace single quotes with double quotes in logs, excluding single quotes occurring within double quotes.
</li>
</ul>
</div>
<p>Malformed logs can be identified by:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The presence of a <code class="literal">records</code> array in the message field indicates a failure to unmarshal the byte slice.
</li>
<li class="listitem">
Existence of an <code class="literal">error.message</code> field containing the text "Received invalid JSON from the Azure Cloud platform. Unable to parse the source log message."
</li>
</ul>
</div>
<p>Known data streams that might produce malformed logs:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Platform Logs
</li>
<li class="listitem">
Spring Apps Logs
</li>
<li class="listitem">
PostgreSQL Flexible Servers Logs
</li>
</ul>
</div>
<div class="position-relative"><h4><a id="azure_logs-changelog"></a>Changelog</h4><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/integration-docs/edit/main/dist/azure_logs/index.asciidoc">edit</a></div>
<details>
<summary class="title"><span class="strong strong"><strong>Changelog</strong></span></summary>
<div class="content">
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Version</th>
<th align="left" valign="top">Details</th>
<th align="left" valign="top">Kibana version(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>0.1.0</strong></span></p></td>
<td align="left" valign="top">
<p><span class="eui-icon icon-checkInCircleFilled"></span> <span class="strong strong"><strong>Enhancement</strong></span> (<a href="https://github.com/elastic/integrations/pull/11552" class="ulink" target="_top">View pull request</a>)<br>
Add Custom Azure Logs to collect log events from Azure Event Hubs</p>
</td>
<td align="left" valign="top"><p>&mdash;</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</details>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="azure_metrics-container_service.html">« Azure Container Service Integration</a>
</span>
<span class="next">
<a href="azure_blob_storage.html">Custom Azure Blob Storage Input »</a>
</span>
</div>
</body>
</html>
