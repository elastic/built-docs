<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="description" content="Kibana provides you with several options to share *Discover* saved searches, dashboards, *Visualize Library* visualizations, and *Canvas* workpads with others, or on a website.">
<meta name="keywords" content="analyst, concept, task, reporting">
<title>Osquery | Kibana Guide [7.16] | Elastic</title>
<meta class="elastic" name="content" content="Osquery | Kibana Guide [7.16]">

<link rel="home" href="index.html" title="Kibana Guide [7.16]"/>
<link rel="up" href="index.html" title="Kibana Guide [7.16]"/>
<link rel="prev" href="fleet.html" title="Fleet"/>
<link rel="next" href="xpack-monitoring.html" title="Stack Monitoring"/>
<meta class="elastic" name="product_version" content="7.16"/>
<meta class="elastic" name="product_name" content="Kibana"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Kibana/Reference/7.16"/>
<meta name="DC.subject" content="Kibana"/>
<meta name="DC.identifier" content="7.16"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Kibana Guide [7.16]</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="fleet.html">« Fleet</a>
</span>
<span class="next">
<a href="xpack-monitoring.html">Stack Monitoring »</a>
</span>
</div>
<div class="chapter xpack">
<div class="titlepage"><div><div>
<h1 class="title"><a id="osquery"></a>Osquery<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h1>
</div></div></div>
<p><a href="https://osquery.io" class="ulink" target="_top">Osquery</a> is an open source tool that lets you query operating systems like a database, providing you with visibility into your infrastructure and operating systems.
Using basic SQL commands, you can ask questions about devices, such as servers,
Docker containers, and computers running Linux, macOS, or Windows.
The <a href="https://osquery.io/schema" class="ulink" target="_top">extensive schema</a> helps with a variety of use cases,
including vulnerability detection, compliance monitoring, incident investigations, and more.</p>
<p>With Osquery in Kibana, you can:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Run live queries for one or more agents
</li>
<li class="listitem">
Schedule query packs to capture changes to OS state over time
</li>
<li class="listitem">
View a history of past queries and their results
</li>
<li class="listitem">
Save queries and build a library of queries for specific use cases
</li>
</ul>
</div>
<p>Osquery is powered by the <span class="strong strong"><strong>Osquery Manager</strong></span> integration.
For information on how to set up <span class="strong strong"><strong>Osquery Manager</strong></span>, refer to <a class="xref" href="osquery.html#manage-osquery-integration" title="Manage the integration">Manage the integration</a>.</p>
<h2><a id="_required_privileges_2"></a>Required privileges<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h2>
<p>To use <span class="strong strong"><strong>Osquery Manager</strong></span>, you must be assigned to a role with the following privileges:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">Read</code> privileges for the <code class="literal">logs-osquery_manager.result*</code> index.
</li>
<li class="listitem">
Kibana privileges for <span class="strong strong"><strong>Osquery Manager</strong></span>. The <code class="literal">All</code> privilege
enables you to run, schedule, and save queries. <code class="literal">Read</code> enables you to
view live and scheduled query results, but you cannot run live queries or edit.
</li>
</ul>
</div>
<h2><a id="osquery-run-query"></a>Run live queries<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h2>
<p>To inspect hosts, run a query against one or more agents or policies,
then view the results.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Open the main menu, and then click <span class="strong strong"><strong>Osquery</strong></span>.
</li>
<li class="listitem">
In the <span class="strong strong"><strong>Live queries</strong></span> view, click <span class="strong strong"><strong>New live query</strong></span>.
</li>
<li class="listitem">
Select one or more agents or groups to query. Start typing in the search field,
and you&#8217;ll get suggestions for agents by name, ID, platform, and policy.
</li>
<li class="listitem">
<p>Enter a query or select a query from your saved queries.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/enter-query.png" alt="Select saved query dropdown name showing query name and description">
</div>
</div>
</li>
<li class="listitem">
(Optional) Expand the <span class="strong strong"><strong>Advanced</strong></span> section to view or set <a class="xref" href="osquery.html#osquery-map-fields" title="Map result fields to ECS">mapped ECS fields</a> included in the results from the live query.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Submit</strong></span>.
</li>
<li class="listitem">
Review the results in a table, or navigate to <span class="strong strong"><strong>Discover</strong></span> to dive deeper into the response,
or to the drag-and-drop <span class="strong strong"><strong>Lens</strong></span> editor to create visualizations.
</li>
<li class="listitem">
To view more information about the request, such as failures, open the <span class="strong strong"><strong>Status</strong></span> tab.
</li>
<li class="listitem">
To save the query for future use, click <span class="strong strong"><strong>Save for later</strong></span> and define the ID,
description, and other <a class="xref" href="osquery.html#osquery-manage-query" title="Save queries">details</a>.
</li>
</ol>
</div>
<h3><a id="osquery-view-history"></a>View or rerun previous live queries<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h3>
<p>From the <span class="strong strong"><strong>Live queries history</strong></span> section on the <span class="strong strong"><strong>Live queries</strong></span> tab:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Click <span class="image"><img src="images/play-icon.png" alt="Right-pointing triangle"></span> to replay a query.
</li>
<li class="listitem">
<p>Click <span class="image"><img src="images/table-icon.png" alt="Table icon"></span> to view the query <a class="xref" href="osquery.html#osquery-results" title="Osquery results">results</a> and <a class="xref" href="osquery.html#osquery-status" title="Osquery status">status</a>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/live-query-check-results.png" alt="Results of OSquery">
</div>
</div>
</li>
</ul>
</div>
<h2><a id="osquery-schedule-query"></a>Schedule queries with packs<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h2>
<p>Create packs to organize sets of queries. For example, you might create one pack that checks
for IT compliance-type issues, and another pack that monitors for evidence of malware.
You can schedule packs to run for one or more agent policies. When scheduled, queries in the pack are run at the set intervals for all agents in those policies. Scheduling packs is optional.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Open the <span class="strong strong"><strong>Packs</strong></span> tab.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Add pack</strong></span> to create a new pack, or click the name of an existing pack, then <span class="strong strong"><strong>Edit</strong></span> to add queries to an existing pack.
</li>
<li class="listitem">
<p>Provide the following fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The name of the pack.
</li>
<li class="listitem">
A short description of the pack.
</li>
<li class="listitem">
The agent policies where this pack should run. If no agent policies are set, then the pack is not scheduled.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Add queries to schedule:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
To add a query to the pack, click <span class="strong strong"><strong>Add query</strong></span>, and then either add a saved query or enter a new query.
Each query must include a unique query ID and the interval at which it should run.
Optionally, set the minimum Osquery version and platform,
or <a class="xref" href="osquery.html#osquery-map-fields" title="Map result fields to ECS">map ECS fields</a>. When you add a saved query to a pack, this adds a copy of the query. A connection is not maintained between saved queries and packs.
</li>
<li class="listitem">
To upload queries from a <code class="literal">.conf</code> query pack, drag the pack to the drop zone under the query table. To explore the community packs that Osquery publishes, click <span class="strong strong"><strong>Example packs</strong></span>.
</li>
</ul>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Save pack</strong></span>. The queries run when the policy receives the update.
</li>
</ol>
</div>
<h3><a id="osquery-schedule-status"></a>View status of scheduled packs<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h3>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Open the <span class="strong strong"><strong>Packs</strong></span> tab.
</li>
<li class="listitem">
<p>Click a pack name to view the status.</p>
<p>Details include the last time each query ran, how many results were returned, and the number of agents the query ran against.
If there are errors, expand the row to view the details.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/scheduled-pack.png" alt="Shows queries in the pack and details about each query" width="including the last time it ran" height="how many results were returned">
</div>
</div>
</li>
<li class="listitem">
View scheduled query results in <a class="xref" href="discover.html" title="Discover"><span class="strong strong"><strong>Discover</strong></span></a> or the drag-and-drop <a class="xref" href="lens.html" title="Create visualizations with Lens"><span class="strong strong"><strong>Lens</strong></span></a> editor.
</li>
</ol>
</div>
<h2><a id="osquery-manage-query"></a>Save queries<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h2>
<p>You can save queries in two ways:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
After running a live query, click the <span class="strong strong"><strong>Save for later</strong></span> link.
</li>
<li class="listitem">
From the <span class="strong strong"><strong>Saved queries</strong></span> tab, click the <span class="strong strong"><strong>Add saved query</strong></span> button.
</li>
</ul>
</div>
<p>Once you save a query, you can only edit it from the <span class="strong strong"><strong>Saved queries</strong></span> tab.</p>
<p>To add or edit saved queries from the <span class="strong strong"><strong>Saved queries</strong></span> tab:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to <span class="strong strong"><strong>Saved queries</strong></span>, and then click <span class="strong strong"><strong>Add saved query</strong></span> or the edit icon.
</li>
<li class="listitem">
<p>Provide the following fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The unique identifier.
</li>
<li class="listitem">
A brief description.
</li>
<li class="listitem">
The SQL query.
</li>
<li class="listitem">
The <a class="xref" href="osquery.html#osquery-map-fields" title="Map result fields to ECS">ECS fields</a> to populate when the query is run. These fields are also copied in when you add this query to a pack.
</li>
<li class="listitem">
<p>The defaults to set when you add the query to a pack.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The frequency to run the query.
</li>
<li class="listitem">
The minimum <a href="https://github.com/osquery/osquery/releases)" class="ulink" target="_top">version of Osquery</a> required to run the query.
</li>
<li class="listitem">
The operating system required to run the query. For information about supported platforms per table, refer to the <a href="https://osquery.io/schema" class="ulink" target="_top">Osquery schema</a>.
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Test configuration</strong></span> to test the query and any mapped fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
From the <span class="strong strong"><strong>Test query</strong></span> panel, select agents or groups to test the query, then click <span class="strong strong"><strong>Submit</strong></span> to run a live query. Result columns with the <span class="image"><img src="images/mapped-icon.png" alt="mapping"></span> icon are mapped. Hover over the icon to see the mapped ECS field.
</li>
</ul>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Save</strong></span> or <span class="strong strong"><strong>Update</strong></span>.
</li>
</ol>
</div>
<h2><a id="osquery-map-fields"></a>Map result fields to ECS<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h2>
<p>When you save queries or add queries to a pack, you can optionally map Osquery results or static values to fields in
the <a href="/guide/en/ecs/1.12/ecs-reference.html" class="ulink" target="_top">Elastic Common Schema</a> (ECS).
This standardizes your Osquery data for use across detections, machine learning,
and any other areas that rely on ECS-compliant data.
When the query is run, the results include the original <code class="literal">osquery.&lt;fields&gt;</code>
and the mapped ECS fields. For example, if you update a query to map <code class="literal">osquery.name</code> to <code class="literal">user.name</code>, the query results include both fields.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Edit saved queries or queries in a pack to map fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
For <span class="strong strong"><strong>Saved queries</strong></span>: Open the <span class="strong strong"><strong>Saved queries</strong></span> tab, and then click the edit icon for the query that you want to map.
</li>
<li class="listitem">
For <span class="strong strong"><strong>packs</strong></span>: Open the <span class="strong strong"><strong>Packs</strong></span> tab, edit a pack, and then click the edit icon for the query that you want to map.
</li>
</ul>
</div>
</li>
<li class="listitem">
In the <span class="strong strong"><strong>ECS mapping</strong></span> section, select an <span class="strong strong"><strong>ECS field</strong></span> to map.
</li>
<li class="listitem">
<p>In the <span class="strong strong"><strong>Value</strong></span> column, use the dropdown on the left to choose what type of value to map to the ECS field:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Osquery value</strong></span>: Select an Osquery field. The fields available are based on the SQL query entered, and only include fields that the query returns. When the query runs, the ECS field is set dynamically to the value of the Osquery field selected.
</li>
<li class="listitem">
<span class="strong strong"><strong>Static value</strong></span>: Enter a static value. When the query runs, the ECS field is set to the value entered. For example, static fields can be used to apply <code class="literal">tags</code> or your preferred <code class="literal">event.category</code> to the query results.
</li>
</ul>
</div>
</li>
<li class="listitem">
Map more fields, as needed. To remove any mapped rows, click the delete icon.
</li>
<li class="listitem">
Save your changes.
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Some ECS fields are restricted and cannot be mapped. These are not available in the ECS dropdown.
</li>
<li class="listitem">
Some ECS fields are restricted to a set of allowed values, like <a href="/guide/en/ecs/1.12/ecs-event.html#field-event-category" class="ulink" target="_top">event.category</a>. Use the <a href="/guide/en/ecs/1.12/ecs-field-reference.html" class="ulink" target="_top">ECS Field Reference</a> for help when mapping fields.
</li>
<li class="listitem">
Osquery date fields have a variety of data types (including integer, text, or bigint). When mapping an Osquery date field to an ECS date field, you might need to use SQL operators in the query to get an Elasticsearch-compatible
<a href="/guide/en/elasticsearch/reference/7.16/date.html" class="ulink" target="_top">date</a> type.
</li>
</ul>
</div>
</div>
</div>
<h2><a id="osquery-extended-tables"></a>Extended tables for Kubernetes queries<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h2>
<p>In addition to the Osquery schema, the Elastic-provided version of Osquery also includes the following tables to support Kubernetes containers. These can be queried with live or scheduled queries.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">host_users</code>
</li>
<li class="listitem">
<code class="literal">host_groups</code>
</li>
<li class="listitem">
<code class="literal">host_processes</code>
</li>
</ul>
</div>
<p>When querying these tables, the expectation is that the <code class="literal">/etc/passwd</code>, <code class="literal">/etc/group</code>, and <code class="literal">/proc</code> are available in the container under <code class="literal">/hostfs</code> as:
<code class="literal">/hostfs/etc/passwd</code>, <code class="literal">/hostfs/etc/group</code>, and <code class="literal">/hostfs/proc</code>. For information about the fields available in these tables, see the
<a href="https://docs.elastic.co/en/integrations/osquery_manager#exported-fields" class="ulink" target="_top">exported fields</a> reference.</p>
<h2><a id="osquery-status"></a>Osquery status<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h2>
<p>A query can have the following status:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Successful</p></td>
<td align="left" valign="top"><p>The query successfully completed.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Failed</p></td>
<td align="left" valign="top"><p>The query encountered a problem, such as an issue with the query or the agent was disconnected, and might have failed.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Not yet responded</p></td>
<td align="left" valign="top"><p>The query has not been sent to the agent.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Expired</p></td>
<td align="left" valign="top"><p>The action request timed out. The agent may be offline.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If an agent is offline, the request status remains <span class="strong strong"><strong>pending</strong></span> as Kibana retries the request.
By default, a query request times out after five minutes. The time out applies to the time it takes
to deliver the action request to an agent to run a query. If the action completes after the timeout period,
the results are still returned.</p>
</div>
</div>
<h2><a id="osquery-results"></a>Osquery results<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h2>
<p>When you run live or scheduled queries, the results are automatically
stored in an Elasticsearch index, so that you can search, analyze, and visualize this data in Kibana.
For a list of the Osquery fields that can be returned in query results,
refer to <a href="https://docs.elastic.co/en/integrations/osquery_manager#exported-fields" class="ulink" target="_top">exported fields</a>.
Query results can also include ECS fields, if the query has a defined ECS mapping.</p>
<p>Osquery responses include the following information:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Everything prefaced with <code class="literal">osquery.</code> is part of the query response. These fields are not mapped to ECS by default.
</li>
<li class="listitem">
Results include some ECS fields by default, such as <code class="literal">host.*</code> and <code class="literal">agent.*</code>, which provide information about the host that was queried.
</li>
<li class="listitem">
For live queries, the <code class="literal">action_data.query</code> is the query that was sent.
</li>
<li class="listitem">
For scheduled queries in a pack, the <code class="literal">action_id</code> has the format <code class="literal">pack_&lt;pack-name&gt;_&lt;query-ID&gt;</code>. You can use this information to look up the query that was run.
</li>
<li class="listitem">
By default, all query results are <a href="https://osquery.readthedocs.io/en/stable/deployment/logging/#snapshot-logs" class="ulink" target="_top">snapshot logs</a>
that represent a point in time with a set of results, with no
<a href="https://osquery.readthedocs.io/en/stable/deployment/logging/#differential-logs" class="ulink" target="_top">differentials</a>.
</li>
<li class="listitem">
Osquery data is stored in the <code class="literal">logs-osquery_manager.result-&lt;namespace&gt;</code> datastream, and the result row data is under the <code class="literal">osquery</code> property in the document.
</li>
</ul>
</div>
<h2><a id="manage-osquery-integration"></a>Manage the integration<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h2>
<h3><a id="_system_requirements"></a>System requirements<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h3>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="/guide/en/fleet/7.16/fleet-overview.html" class="ulink" target="_top">Fleet</a> is enabled on your cluster, and
one or more <a href="/guide/en/fleet/7.16/elastic-agent-installation.html" class="ulink" target="_top">Elastic Agents</a> is enrolled.
</li>
<li class="listitem">
The <a href="https://docs.elastic.co/en/integrations/osquery_manager" class="ulink" target="_top"><span class="strong strong"><strong>Osquery Manager</strong></span></a> integration
has been added and configured
for an agent policy through Fleet.
This integration supports x64 architecture on Windows, MacOS, and Linux platforms,
and ARM64 architecture on Linux.
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The original <a href="/guide/en/beats/filebeat/7.16/filebeat-module-osquery.html" class="ulink" target="_top">Filebeat Osquery module</a>
and the <a href="https://docs.elastic.co/en/integrations/osquery" class="ulink" target="_top">Osquery</a>
integration collect logs from self-managed Osquery deployments.
The <span class="strong strong"><strong>Osquery Manager</strong></span> integration manages Osquery deployments
and supports running and scheduling queries from Kibana.</p>
</div>
</div>
<h3><a id="_customize_osquery_sub_feature_privileges"></a>Customize Osquery sub-feature privileges<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h3>
<p>Depending on your <a href="/subscriptions" class="ulink" target="_top">subscription level</a>,
you can further customize the sub-feature privileges
for <span class="strong strong"><strong>Osquery Manager</strong></span>. These include options to grant specific access for running live queries,
running saved queries, saving queries, and scheduling packs. For example,
you can create roles for users who can only run live or saved queries, but who cannot save or schedule queries.
This is useful for teams who need in-depth and detailed control.</p>
<h3><a id="_customize_osquery_configuration"></a>Customize Osquery configuration<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h3>
<p><span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will apply best effort to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> By default, all Osquery Manager integrations share the same osquery configuration. However, you can customize how Osquery is configured by editing the Osquery Manager integration for each agent policy
you want to adjust. The custom configuration is then applied to all agents in the policy.
This powerful feature allows you to configure
<a href="https://osquery.readthedocs.io/en/stable/deployment/file-integrity-monitoring" class="ulink" target="_top">File Integrity Monitoring</a>, <a href="https://osquery.readthedocs.io/en/stable/deployment/process-auditing" class="ulink" target="_top">Process auditing</a>,
and <a href="https://osquery.readthedocs.io/en/stable/deployment/configuration/#configuration-specification" class="ulink" target="_top">others</a>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Take caution when editing this configuration. The changes you make are distributed to all agents in the policy.
</li>
<li class="listitem">
Take caution when editing <code class="literal">packs</code> using the Advanced <span class="strong strong"><strong>Osquery config</strong></span> field.
Any changes you make to <code class="literal">packs</code> from this field are not reflected in the UI on the Osquery <span class="strong strong"><strong>Packs</strong></span> page in Kibana, however, these changes are deployed to agents in the policy.
While this allows you to use advanced Osquery functionality like pack discovery queries, you do lose the ability to manage packs defined this way from the Osquery <span class="strong strong"><strong>Packs</strong></span> page.
</li>
</ul>
</div>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
From the Kibana main menu, click <span class="strong strong"><strong>Fleet</strong></span>, then the <span class="strong strong"><strong>Agent policies</strong></span> tab.
</li>
<li class="listitem">
Click the name of the agent policy where you want to adjust the Osquery configuration. The configuration changes you make only apply to the policy you select.
</li>
<li class="listitem">
Click the name of the <span class="strong strong"><strong>Osquery Manager</strong></span> integration, or add the integration first if the agent policy does not yet have it.
</li>
<li class="listitem">
From the <span class="strong strong"><strong>Edit Osquery Manager integration</strong></span> page, expand the <span class="strong strong"><strong>Advanced</strong></span> section.
</li>
<li class="listitem">
<p>Edit the <span class="strong strong"><strong>Osquery config</strong></span> JSON field to apply your preferred Osquery configuration. Note the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The field may already have content if you have scheduled packs for this agent policy. To keep these packs scheduled, do not remove the <code class="literal">packs</code> section.
</li>
<li class="listitem">
Refer to the <a href="https://osquery.readthedocs.io/en/stable/" class="ulink" target="_top">Osquery documentation</a> for configuration options.
</li>
<li class="listitem">
Some fields are protected and cannot be set. A warning is displayed with details about which fields should be removed.
</li>
<li class="listitem">
(Optional) To load a full configuration file, drag and drop an Osquery <code class="literal">.conf</code> file into the area at the bottom of the page.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Save integration</strong></span> to apply the custom configuration to all agents in the policy.</p>
<p>As an example, the following configuration disables two tables.</p>
<div class="pre_wrapper lang-ts">
<pre class="programlisting prettyprint lang-ts">{
   "options":{
      "disable_tables":"curl,process_envs"
   }
}</pre>
</div>
</li>
</ol>
</div>
<h3><a id="_upgrade_osquery_versions"></a>Upgrade Osquery versions<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h3>
<p>The <a href="https://github.com/osquery/osquery/releases" class="ulink" target="_top">Osquery version</a> available on an Elastic Agent
is associated to the version of Osquery Beat on the Agent.
To get the latest version of Osquery Beat,
<a href="/guide/en/fleet/master/upgrade-elastic-agent.html" class="ulink" target="_top">upgrade your Elastic Agent</a>.</p>
<h3><a id="_debug_issues"></a>Debug issues<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/kibana/edit/7.16/docs/osquery/osquery.asciidoc">edit</a></h3>
<p>If you encounter issues with <span class="strong strong"><strong>Osquery Manager</strong></span>, find the relevant logs for Elastic Agent
and Osquerybeat in the agent directory. Refer to the <a href="/guide/en/fleet/7.16/installation-layout.html" class="ulink" target="_top">Fleet Installation layout</a> to find the log file location for your OS.</p>
<div class="pre_wrapper lang-ts">
<pre class="programlisting prettyprint lang-ts">../data/elastic-agent-*/logs/elastic-agent-json.log-*
../data/elastic-agent-*/logs/default/osquerybeat-json.log</pre>
</div>
<p>To get more details in the logs, change the agent logging level to debug:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Open the main menu, and then select <span class="strong strong"><strong>Fleet</strong></span>.
</li>
<li class="listitem">
Select the agent that you want to debug.
</li>
<li class="listitem">
<p>On the <span class="strong strong"><strong>Logs</strong></span> tab, change the <span class="strong strong"><strong>Agent logging level</strong></span> to <span class="strong strong"><strong>debug</strong></span>, and then click <span class="strong strong"><strong>Apply changes</strong></span>.</p>
<p><code class="literal">agent.logging.level</code> is updated in <code class="literal">fleet.yml</code>, and the logging level is changed to <code class="literal">debug</code>.</p>
</li>
</ol>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="fleet.html">« Fleet</a>
</span>
<span class="next">
<a href="xpack-monitoring.html">Stack Monitoring »</a>
</span>
</div>
</div>
</body>
</html>
