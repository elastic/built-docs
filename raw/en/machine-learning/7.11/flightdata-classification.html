<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Predicting delayed flights with classification analysis | Machine Learning in the Elastic Stack [7.11] | Elastic</title>
<link rel="home" href="index.html" title="Machine Learning in the Elastic Stack [7.11]"/>
<link rel="up" href="dfanalytics-examples.html" title="Data frame analytics examples"/>
<link rel="prev" href="flightdata-regression.html" title="Predicting flight delays with regression analysis"/>
<link rel="next" href="ml-lang-ident.html" title="Language identification"/>
<meta name="DC.type" content="Learn/Docs/Elastic Stack/Machine learning/7.11"/>
<meta name="DC.subject" content="Machine learning"/>
<meta name="DC.identifier" content="7.11"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Machine Learning in the Elastic Stack [7.11]</a></span>
»
<span class="breadcrumb-link"><a href="ml-dfanalytics.html">Data frame analytics</a></span>
»
<span class="breadcrumb-link"><a href="dfanalytics-examples.html">Data frame analytics examples</a></span>
»
<span class="breadcrumb-node">Predicting delayed flights with classification analysis</span>
</div>
<div class="navheader">
<span class="prev">
<a href="flightdata-regression.html">« Predicting flight delays with regression analysis</a>
</span>
<span class="next">
<a href="ml-lang-ident.html">Language identification »</a>
</span>
</div>
<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="flightdata-classification"></a>Predicting delayed flights with classification analysis<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/7.11/docs/en/stack/ml/df-analytics/flightdata-classification.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in beta and is subject to change. The design and code is less mature than official GA features and is being provided as-is with no warranties. Beta features are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>Let&#8217;s try to predict whether a flight will be delayed or not by using the
<a href="/guide/en/kibana/7.11/add-sample-data.html" class="ulink" target="_top">sample flight data</a>. The data set contains
information such as weather conditions, carrier, flight distance, origin,
destination, and whether or not the flight was delayed. When you create a
data frame analytics job for classification analysis, it learns the relationships between the
fields in your data in order to predict the value of the <em>dependent variable</em>,
which in this case is the boolean <code class="literal">FlightDelay</code> field. For an overview of these
concepts, see <a class="xref" href="dfa-classification.html" title="Classification">Classification</a> and <a class="xref" href="ml-supervised-workflow.html" title="Introduction to supervised learning">Introduction to supervised learning</a>.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you want to view this example in a Jupyter notebook,
<a href="https://github.com/elastic/examples/tree/master/Machine%20Learning/Analytics%20Jupyter%20Notebooks" class="ulink" target="_top">click here</a>.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="flightdata-classification-data"></a>Preparing your data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/7.11/docs/en/stack/ml/df-analytics/flightdata-classification.asciidoc">edit</a></h3>
</div></div></div>
<p>Each document in the sample flight data set contains details for a single flight,
so this data is ready for analysis; it is already in a two-dimensional
entity-based data structure. In general, you often need to
<a href="/guide/en/elasticsearch/reference/7.11/transforms.html" class="ulink" target="_top">transform</a> the data into an entity-centric index before
you can analyze the data.</p>
<p>In order to be analyzed, a document must contain at least one field with a
supported data type (<code class="literal">numeric</code>, <code class="literal">boolean</code>, <code class="literal">text</code>, <code class="literal">keyword</code> or <code class="literal">ip</code>) and must
not contain arrays with more than one item. If your source data consists of some
documents that contain the dependent variable and some that do not, the model is
trained on the subset of documents that contain it.</p>
<details>
<summary class="title">Example source document</summary>
<div class="content">
<pre class="screen">{
  "_index": "kibana_sample_data_flights",
  "_type": "_doc",
  "_id": "S-JS1W0BJ7wufFIaPAHe",
  "_version": 1,
  "_seq_no": 3356,
  "_primary_term": 1,
  "found": true,
  "_source": {
    "FlightNum": "N32FE9T",
    "DestCountry": "JP",
    "OriginWeather": "Thunder &amp; Lightning",
    "OriginCityName": "Adelaide",
    "AvgTicketPrice": 499.08518599798685,
    "DistanceMiles": 4802.864932998549,
    "FlightDelay": false,
    "DestWeather": "Sunny",
    "Dest": "Chubu Centrair International Airport",
    "FlightDelayType": "No Delay",
    "OriginCountry": "AU",
    "dayOfWeek": 3,
    "DistanceKilometers": 7729.461862731618,
    "timestamp": "2019-10-17T11:12:29",
    "DestLocation": {
      "lat": "34.85839844",
      "lon": "136.8049927"
    },
    "DestAirportID": "NGO",
    "Carrier": "ES-Air",
    "Cancelled": false,
    "FlightTimeMin": 454.6742272195069,
    "Origin": "Adelaide International Airport",
    "OriginLocation": {
      "lat": "-34.945",
      "lon": "138.531006"
    },
    "DestRegion": "SE-BD",
    "OriginAirportID": "ADL",
    "OriginRegion": "SE-BD",
    "DestCityName": "Tokoname",
    "FlightTimeHour": 7.577903786991782,
    "FlightDelayMin": 0
  }
}</pre>
</div>
</details>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>The sample flight data set is used in this example because it is easily
accessible. However, the data has been manually created and contains some
inconsistencies. For example, a flight can be both delayed and canceled. This is
a good reminder that the quality of your input data affects the quality of your
results.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="flightdata-classification-model"></a>Creating a classification model<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/7.11/docs/en/stack/ml/df-analytics/flightdata-classification.asciidoc">edit</a></h3>
</div></div></div>
<p>To predict whether a specific flight is delayed:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create a data frame analytics job.</p>
<p>You can use the wizard on the <span class="strong strong"><strong>Machine Learning</strong></span> &gt; <span class="strong strong"><strong>Data Frame Analytics</strong></span> tab
in Kibana or the <a href="/guide/en/elasticsearch/reference/7.11/put-dfanalytics.html" class="ulink" target="_top">create data frame analytics jobs</a> API.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-job-1.jpg" alt="Creating a data frame analytics job in Kibana">
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Choose <code class="literal">kibana_sample_data_flights</code> as the source index.
</li>
<li class="listitem">
Choose <code class="literal">classification</code> as the job type.
</li>
<li class="listitem">
Choose <code class="literal">FlightDelay</code> as the dependent variable, which is the field that we
want to predict with the classification analysis.
</li>
<li class="listitem">
<p>Add <code class="literal">Cancelled</code>, <code class="literal">FlightDelayMin</code>, and <code class="literal">FlightDelayType</code> to the list of
excluded fields. These fields will be excluded from the analysis. It is
recommended to exclude fields that either contain erroneous data or describe the
<code class="literal">dependent_variable</code>.</p>
<p>The wizard includes a scatterplot matrix, which enables you to explore the
relationships between the numeric fields. The color of each point is affected by
the value of the dependent variable for that document, as shown in the legend.
You can use this matrix to help you decide which fields to include or exclude
from the analysis.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-scatterplot.png" alt="A scatterplot matrix for three fields in Kibana">
</div>
</div>
<p>If you want these charts to represent data from a larger sample size or from a
randomized selection of documents, you can change the default behavior. However,
a larger sample size might slow down the performance of the matrix and a
randomized selection might put more load on the cluster due to the more
intensive query.</p>
</li>
<li class="listitem">
Choose a training percent of <code class="literal">10</code> which means it randomly selects 10% of the
source data for training. While that value is low for this example, for many
large data sets using a small training sample greatly reduces runtime without
impacting accuracy.
</li>
<li class="listitem">
If you want to experiment with <a class="xref" href="ml-feature-importance.html" title="Feature importance">feature importance</a>, specify
a value in the advanced configuration options. In this example, we choose to
return a maximum of 10 feature importance values per document. This option
affects the speed of the analysis, so by default it is disabled.
</li>
<li class="listitem">
Use the default memory limit for the job. If the job requires more than this
amount of memory, it fails to start. If the available memory on the node is
limited, this setting makes it possible to prevent job execution.
</li>
<li class="listitem">
Add a job ID (such as <code class="literal">model-flight-delay-classification</code>) and optionally a
job description.
</li>
<li class="listitem">
Add the name of the destination index that will contain the results of the
analysis. In Kibana, the index name matches the job ID by default. It will
contain a copy of the source index data where each document is annotated with
the results. If the index does not exist, it will be created automatically.
</li>
<li class="listitem">
<p>Use default values for all other options.</p>
<details>
<summary class="title">API example</summary>
<div class="content">
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ml/data_frame/analytics/model-flight-delay-classification
{
  "source": {
    "index": [
      "kibana_sample_data_flights"
    ]
  },
  "dest": {
    "index": "model-flight-delay-classification",
    "results_field": "ml" <a id="CO17-1"></a><i class="conum" data-value="1"></i>
  },
  "analysis": {
    "classification": {
      "dependent_variable": "FlightDelay",
      "training_percent": 10,
      "num_top_feature_importance_values": 10 <a id="CO17-2"></a><i class="conum" data-value="2"></i>
    }
  },
  "analyzed_fields": {
    "includes": [],
    "excludes": [
      "Cancelled",
      "FlightDelayMin",
      "FlightDelayType"
    ]
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/65.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO17-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The field name in the <code class="literal">dest</code> index that contains the analysis results.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO17-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>To disable feature importance calculations, omit this option.</p>
</td>
</tr>
</table>
</div>
</div>
</details>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>Start the job in Kibana or use the
<a href="/guide/en/elasticsearch/reference/7.11/start-dfanalytics.html" class="ulink" target="_top">start data frame analytics jobs</a> API.</p>
<p>The job takes a few minutes to run. Runtime depends on the local hardware and
also on the number of documents and fields that are analyzed. The more fields
and documents, the longer the job runs. It stops automatically when the analysis is complete.</p>
<details>
<summary class="title">API example</summary>
<div class="content">
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _ml/data_frame/analytics/model-flight-delay-classification/_start</pre>
</div>
<div class="console_widget" data-snippet="snippets/66.console"></div>
</div>
</details>
</li>
<li class="listitem">
<p>Check the job stats to follow the progress in Kibana or use the
<a href="/guide/en/elasticsearch/reference/7.11/get-dfanalytics-stats.html" class="ulink" target="_top">get data frame analytics jobs statistics API</a>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-details.png" alt="Statistics for a data frame analytics job in Kibana">
</div>
</div>
<p>When the job stops, the results are ready to view and evaluate. To learn more
about the job phases, see <a class="xref" href="ml-dfa-phases.html" title="How a data frame analytics job works">How it works</a>.</p>
<details>
<summary class="title">API example</summary>
<div class="content">
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET _ml/data_frame/analytics/model-flight-delay-classification/_stats</pre>
</div>
<div class="console_widget" data-snippet="snippets/67.console"></div>
<p>The API call returns the following response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "count" : 1,
  "data_frame_analytics" : [
    {
      "id" : "model-flight-delay-classification",
      "state" : "stopped",
      "progress" : [
        {
          "phase" : "reindexing",
          "progress_percent" : 100
        },
        {
          "phase" : "loading_data",
          "progress_percent" : 100
        },
        {
          "phase" : "feature_selection",
          "progress_percent" : 100
        },
        {
          "phase" : "coarse_parameter_search",
          "progress_percent" : 100
        },
        {
          "phase" : "fine_tuning_parameters",
          "progress_percent" : 100
        },
        {
          "phase" : "final_training",
          "progress_percent" : 100
        },
        {
          "phase" : "writing_results",
          "progress_percent" : 100
        },
        {
          "phase" : "inference",
          "progress_percent" : 100
        }
      ],
      "data_counts" : {
        "training_docs_count" : 1305,
        "test_docs_count" : 11754,
        "skipped_docs_count" : 0
      },
      "memory_usage" : {
        "timestamp" : 1597182490577,
        "peak_usage_bytes" : 316613,
        "status" : "ok"
      },
      "analysis_stats" : {
        "classification_stats" : {
          "timestamp" : 1601405047110,
          "iteration" : 18,
          "hyperparameters" : {
            "class_assignment_objective" : "maximize_minimum_recall",
            "alpha" : 0.7633136599817167,
            "downsample_factor" : 0.9473152348018332,
            "eta" : 0.02331774683318904,
            "eta_growth_rate_per_tree" : 1.0143154178910303,
            "feature_bag_fraction" : 0.5504020748926737,
            "gamma" : 0.26389161802240446,
            "lambda" : 0.6309726978583623,
            "max_attempts_to_add_tree" : 3,
            "max_optimization_rounds_per_hyperparameter" : 2,
            "max_trees" : 894,
            "num_folds" : 5,
            "num_splits_per_feature" : 75,
            "soft_tree_depth_limit" : 4.672705943455812,
            "soft_tree_depth_tolerance" : 0.13448633124842999
            },
            "timing_stats" : {
              "elapsed_time" : 76459,
              "iteration_time" : 1861
            },
            "validation_loss" : {
              "loss_type" : "binomial_logistic"
            }
          }
      }
    }
  ]
}</pre>
</div>
</div>
</details>
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="flightdata-classification-results"></a>Viewing classification results<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/7.11/docs/en/stack/ml/df-analytics/flightdata-classification.asciidoc">edit</a></h3>
</div></div></div>
<p>Now you have a new index that contains a copy of your source data with
predictions for your dependent variable.</p>
<p>When you view the classification results in Kibana, it shows the contents of
the destination index in a tabular format. It also provides information about
the analysis details, total feature importance values, and model evaluation
metrics. Let&#8217;s start by looking at the results table:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-results.jpg" alt="Destination index table for a classification job in Kibana">
</div>
</div>
<p>In this example, the table shows a column for the dependent variable
(<code class="literal">FlightDelay</code>), which contains the ground truth values that you are trying to
predict. It also shows a column for the predicted values
(<code class="literal">ml.FlightDelay_prediction</code>), which were generated by the classification analysis. The
<code class="literal">ml.is_training</code> column indicates whether the document was used in the training
or testing data set. You can use the <span class="strong strong"><strong>Training</strong></span> and <span class="strong strong"><strong>Testing</strong></span> filter options to
refine the contents of the results table. You can also enable histogram charts
to get a better understanding of the distribution of values in your data.</p>
<p>If you want to understand how certain the model is about each prediction, you
can examine its probability and score (<code class="literal">ml.prediction_probability</code> and
<code class="literal">ml.prediction_score</code>). The higher these values are, the more confident the
model is that the data point belongs to the named class. If you examine the
destination index more closely in the <span class="strong strong"><strong>Discover</strong></span> app in Kibana or use the
standard Elasticsearch search command, you can see that the analysis predicts the
probability of all possible classes for the dependent variable. The
<code class="literal">top_classes</code> object contains the predicted classes with the highest scores.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you have a large number of classes, your destination index contains a
large number of predicted probabilities for each document. When you create the
classification job, you can use the <code class="literal">num_top_classes</code> option to modify this
behavior.</p>
</div>
</div>
<details>
<summary class="title">API example</summary>
<div class="content">
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET model-flight-delay-classification/_search</pre>
</div>
<div class="console_widget" data-snippet="snippets/68.console"></div>
<p>The snippet below shows the probability and score details for a document in the
destination index:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">          ...
          "FlightDelay" : false,
          ...
          "ml" : {
            "FlightDelay_prediction" : false,
            "top_classes" : [ <a id="CO18-1"></a><i class="conum" data-value="1"></i>
              {
                "class_name" : false,
                "class_probability" : 0.9427605087816684,
                "class_score" : 0.3462468700158476
              },
              {
                "class_name" : true,
                "class_probability" : 0.057239491218331606,
                "class_score" : 0.057239491218331606
              }
            ],
            "prediction_probability" : 0.9427605087816684,
            "prediction_score" : 0.3462468700158476,
            ...</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO18-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>An array of values specifying the probability of the prediction and the
score for each class.</p>
</td>
</tr>
</table>
</div>
<p>The class with the highest score is the prediction. In this example, <code class="literal">false</code> has
a <code class="literal">class_score</code> of 0.35 while <code class="literal">true</code> has only 0.06, so the prediction will be
<code class="literal">false</code>. For more details about these values, see
<a class="xref" href="dfa-classification.html#dfa-classification-interpret" title="Interpreting classification results">Interpreting classification results</a>.</p>
</div>
</details>
<p>If you chose to calculate feature importance, the destination index also contains
<code class="literal">ml.feature_importance</code> objects. Every field that is included in the
classification analysis (known as a <em>feature</em> of the data point) is assigned a feature importance
value. This value has both a magnitude and a direction (positive or negative),
which indicates how each field affects a particular prediction. Only the most
significant values (in this case, the top 10) are stored in the index. However,
the trained model metadata also contains the average magnitude of the feature importance
values for each field across all the training data. You can view this
summarized information in Kibana:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-total-importance.jpg" alt="Total feature importance values in Kibana">
</div>
</div>
<p>You can also see the feature importance values for each individual prediction in the
form of a decision plot:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-importance.png" alt="A decision plot for feature importance values in Kibana">
</div>
</div>
<p>In Kibana, the decision path shows the relative impact of each feature on the
probability of the prediction. The features with the most significant positive
or negative impact appear at the top of the decision plot. Thus in this example,
the features related to flight time and distance had the most significant
influence on the probability value for this prediction. This type of information
can help you to understand how models arrive at their predictions. It can also
indicate which aspects of your data set are most influential or least useful
when you are training and tuning your model.</p>
<p>If you do not use Kibana, you can see the summarized feature importance values by using
the <a href="/guide/en/elasticsearch/reference/7.11/get-inference.html" class="ulink" target="_top">get trained model API</a> and the individual values by
searching the destination index.</p>
<details>
<summary class="title">API example</summary>
<div class="content">
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET _ml/trained_models/model-flight-delay-classification*?include=total_feature_importance</pre>
</div>
<div class="console_widget" data-snippet="snippets/69.console"></div>
<p>The snippet below shows an example of the total feature importance and the corresponding baseline
in the trained model metadata:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "count" : 1,
  "trained_model_configs" : [
    {
      "model_id" : "model-flight-delay-classification-1601405047985",
      ...
      "metadata" : {
        ...
        "feature_importance_baseline" : { <a id="CO19-1"></a><i class="conum" data-value="1"></i>
          "classes" : [
            {
              "class_name" : true,
              "baseline" : -1.5869016940485443
            },
            {
              "class_name" : false,
              "baseline" : 1.5869016940485443
            }
          ]
        },
        "total_feature_importance" : [
          {
            "feature_name" : "dayOfWeek",
            "classes" : [
              {
                "class_name" : false,
                "importance" : {
                  "mean_magnitude" : 0.037513174351966404, <a id="CO19-2"></a><i class="conum" data-value="2"></i>
                  "min" : -0.20132653028125566, <a id="CO19-3"></a><i class="conum" data-value="3"></i>
                  "max" : 0.20132653028125566 <a id="CO19-4"></a><i class="conum" data-value="4"></i>
                }
              },
              {
                "class_name" : true,
                "importance" : {
                  "mean_magnitude" : 0.037513174351966404,
                  "min" : -0.20132653028125566,
                  "max" : 0.20132653028125566
                }
              }
            ]
          },
          {
            "feature_name" : "OriginWeather",
            "classes" : [
              {
                "class_name" : false,
                "importance" : {
                  "mean_magnitude" : 0.05486662317369895,
                  "min" : -0.3337477336556598,
                  "max" : 0.3337477336556598
                }
              },
              {
                "class_name" : true,
                "importance" : {
                  "mean_magnitude" : 0.05486662317369895,
                  "min" : -0.3337477336556598,
                  "max" : 0.3337477336556598
                }
              }
            ]
          },
          ...</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO19-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This object contains the baselines that are used to calculate the feature importance
decision paths in Kibana.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO19-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>This value is the average of the absolute feature importance values for the
<code class="literal">dayOfWeek</code> field across all the training data when the predicted class is
<code class="literal">false</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO19-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>This value is the minimum feature importance value across all the training data for
this field when the predicted class is <code class="literal">false</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO19-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>This value is the maximum feature importance value across all the training data for
this field when the predicted class is <code class="literal">false</code>.</p>
</td>
</tr>
</table>
</div>
<p>To see the top feature importance values for each prediction, search the destination
index. For example:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET model-flight-delay-classification/_search</pre>
</div>
<div class="console_widget" data-snippet="snippets/70.console"></div>
<p>The snippet below shows an example of the feature importance details for a document in
the search results:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">          ...
          "FlightDelay" : false,
          ...
          "ml" : {
            "FlightDelay_prediction" : false,
            ...
            "prediction_probability" : 0.9427605087816684,
            "prediction_score" : 0.3462468700158476,
            "feature_importance" : [
              {
                "feature_name" : "DistanceMiles",
                "classes" : [
                  {
                    "class_name" : false,
                    "importance" : -1.4766536146534828
                  },
                  {
                    "class_name" : true,
                    "importance" : 1.4766536146534828
                  }
                ]
              },
              {
                "feature_name" : "FlightTimeMin",
                "classes" : [
                  {
                    "class_name" : false,
                    "importance" : 1.0919201754729184
                  },
                  {
                    "class_name" : true,
                    "importance" : -1.0919201754729184
                  }
                ]
              },
              ...</pre>
</div>
<p>The sum of the feature importance values for each class in this data point approximates
the logarithm of its odds.</p>
</div>
</details>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="flightdata-classification-evaluate"></a>Evaluating classification results<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/7.11/docs/en/stack/ml/df-analytics/flightdata-classification.asciidoc">edit</a></h3>
</div></div></div>
<p>Though you can look at individual results and compare the predicted value
(<code class="literal">ml.FlightDelay_prediction</code>) to the actual value (<code class="literal">FlightDelay</code>), you
typically need to evaluate the success of your classification model as a
whole.</p>
<p>Kibana provides a <em>normalized confusion matrix</em> that contains the percentage of
occurrences where the analysis classified data points correctly with their
actual class and the percentage of occurrences where it misclassified them.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-evaluation.png" alt="Evaluation of a classification job in Kibana">
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>As the sample data may change when it is loaded into Kibana, the results of
the classification analysis can vary even if you use the same configuration as the
example. Therefore, use this information as a guideline for interpreting your
own results.</p>
</div>
</div>
<p>If you want to see the exact number of occurrences, select a quadrant in the
matrix. You can also use the <span class="strong strong"><strong>Training</strong></span> and <span class="strong strong"><strong>Testing</strong></span> filter options to refine
the contents of the matrix. Thus you can see how well the model performs on
previously unseen data. In this example, there are 2952 documents in the testing
data that have the <code class="literal">true</code> class. 794 of them are
predicted as <code class="literal">false</code>; this is called a <em>false negative</em>. 2158 are predicted
correctly as <code class="literal">true</code>; this is called a <em>true positive</em>. The confusion matrix
therefore shows us that 27% of the actual <code class="literal">true</code> values were correctly
predicted and 73% were incorrectly predicted in the test data set.</p>
<p>Likewise if you select other quadrants in the matrix, it shows the number of
documents that have the <code class="literal">false</code> class as their actual value in the testing data
set. In this example, the model labeled 7262 documents out of 8802 correctly as
<code class="literal">false</code>; this is called a <em>true negative</em>. 1540 documents are predicted
incorrectly as <code class="literal">true</code>; this is called a <em>false positive</em>. Thus 83% of the actual
<code class="literal">false</code> values were correctly predicted and 17% were incorrectly predicted in
the test data set. When you perform classification analysis on your own data, it might
take multiple iterations before you are satisfied with the results and ready to
deploy the model.</p>
<p>You can also generate these metrics with the
<a href="/guide/en/elasticsearch/reference/7.11/evaluate-dfanalytics.html" class="ulink" target="_top">data frame analytics evaluate API</a>. For more
information about interpreting the evaluation metrics, see
<a class="xref" href="ml-dfanalytics-evaluate.html#ml-dfanalytics-classification" title="Classification evaluation">Classification evaluation</a>.</p>
<details>
<summary class="title">API example</summary>
<div class="content">
<p>First, we want to know the training error that represents how well the model
performed on the training data set.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _ml/data_frame/_evaluate
{
 "index": "model-flight-delay-classification",
   "query": {
    "term": {
      "ml.is_training": {
        "value": true  <a id="CO20-1"></a><i class="conum" data-value="1"></i>
      }
    }
  },
 "evaluation": {
   "classification": {
     "actual_field": "FlightDelay",
     "predicted_field": "ml.FlightDelay_prediction",
     "metrics": {
       "multiclass_confusion_matrix" : {}
     }
   }
 }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/71.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO20-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>We calculate the training error by evaluating only the training data.</p>
</td>
</tr>
</table>
</div>
<p>Next, we calculate the generalization error that represents how well the model
performed on previously unseen data:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _ml/data_frame/_evaluate
{
 "index": "model-flight-delay-classification",
   "query": {
    "term": {
      "ml.is_training": {
        "value": false  <a id="CO21-1"></a><i class="conum" data-value="1"></i>
      }
    }
  },
 "evaluation": {
   "classification": {
     "actual_field": "FlightDelay",
     "predicted_field": "ml.FlightDelay_prediction",
     "metrics": {
       "multiclass_confusion_matrix" : {}
     }
   }
 }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/72.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>We evaluate only the documents that are not part of the training data.</p>
</td>
</tr>
</table>
</div>
<p>The returned confusion matrix shows us how many data points were classified
correctly (where the <code class="literal">actual_class</code> matches the <code class="literal">predicted_class</code>) and how many
were misclassified (<code class="literal">actual_class</code> does not match <code class="literal">predicted_class</code>):</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "classification" : {
    "multiclass_confusion_matrix" : {
      "confusion_matrix" : [
        {
          "actual_class" : "false", <a id="CO22-1"></a><i class="conum" data-value="1"></i>
          "actual_class_doc_count" : 8802, <a id="CO22-2"></a><i class="conum" data-value="2"></i>
          "predicted_classes" : [
            {
              "predicted_class" : "false", <a id="CO22-3"></a><i class="conum" data-value="3"></i>
              "count" : 7262 <a id="CO22-4"></a><i class="conum" data-value="4"></i>
            },
            {
              "predicted_class" : "true",
              "count" : 1540
            }
          ],
          "other_predicted_class_doc_count" : 0
        },
        {
          "actual_class" : "true",
          "actual_class_doc_count" : 2952,
          "predicted_classes" : [
            {
              "predicted_class" : "false",
              "count" : 794
            },
            {
              "predicted_class" : "true",
              "count" : 2158
            }
          ],
          "other_predicted_class_doc_count" : 0
        }
      ],
      "other_actual_class_count" : 0
    }
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO22-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the actual class. In this example, there are two actual classes:
<code class="literal">true</code> and <code class="literal">false</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO22-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The number of documents in the data set that belong to the actual class.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO22-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the predicted class.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO22-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The number of documents that belong to the actual class and are labeled as
the predicted class.</p>
</td>
</tr>
</table>
</div>
</div>
</details>
<p>When you have trained a satisfactory model, you can deploy it to make predictions
about new data. Those steps are not covered in this example. See
<a class="xref" href="ml-inference.html" title="Inference">Inference</a>.</p>
<p>If you don&#8217;t want to keep the data frame analytics job, you can delete it in Kibana or
by using the <a href="/guide/en/elasticsearch/reference/7.11/delete-dfanalytics.html" class="ulink" target="_top">delete data frame analytics job API</a>. When
you delete data frame analytics jobs in Kibana, you have the option to also remove the
destination indices and index patterns.</p>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="flightdata-regression.html">« Predicting flight delays with regression analysis</a>
</span>
<span class="next">
<a href="ml-lang-ident.html">Language identification »</a>
</span>
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains('stemblock')) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>
