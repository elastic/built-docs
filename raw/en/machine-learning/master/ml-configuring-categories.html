<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="keywords" content="ML, Elastic Stack, anomaly detection">
<title>Detecting anomalous categories of data | Machine Learning in the Elastic Stack [master] | Elastic</title>
<meta class="elastic" name="content" content="Detecting anomalous categories of data | Machine Learning in the Elastic Stack [master]">

<link rel="home" href="index.html" title="Machine Learning in the Elastic Stack [master]"/>
<link rel="up" href="anomaly-how-tos.html" title="How-to guides"/>
<link rel="prev" href="ml-configuring-detector-custom-rules.html" title="Customizing detectors with custom rules"/>
<link rel="next" href="ml-configuring-populations.html" title="Performing population analysis"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Machine Learning"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elastic Stack/Machine Learning/master"/>
<meta name="DC.subject" content="Machine Learning"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="ml-configuring-detector-custom-rules.html">« Customizing detectors with custom rules</a>
</span>
<span class="next">
<a href="ml-configuring-populations.html">Performing population analysis »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Machine Learning in the Elastic Stack [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="ml-ad-overview.html">Anomaly detection</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="anomaly-how-tos.html">How-to guides</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Detecting anomalous categories of data</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/anomaly-detection/ml-detect-categories.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="ml-configuring-categories"></a>Detecting anomalous categories of data</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/anomaly-detection/ml-detect-categories.asciidoc">edit</a></div>
</div></div></div>
<p>Categorization is a machine learning process that tokenizes a text field, clusters similar data together, and classifies it into categories.
It works best on machine-written messages and application output that typically consist of repeated elements.
<a class="xref" href="ml-anomaly-detection-job-types.html#categorization-jobs" title="Categorization jobs">Categorization jobs</a> enable you to find anomalous behavior in your categorized data.
Categorization is not natural language processing (NLP).
When you create a categorization anomaly detection job, the machine learning model learns what volume and pattern is normal for each category over time.
You can then detect anomalies and surface rare events or unusual types of messages by using <a class="xref" href="ml-count-functions.html" title="Count functions">count</a> or <a class="xref" href="ml-rare-functions.html" title="Rare functions">rare</a> functions.
Categorization works well on finite set of possible messages, for example:</p>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">{"@timestamp":1549596476000,
"message":"org.jdbi.v2.exceptions.UnableToExecuteStatementException: com.mysql.jdbc.exceptions.MySQLTimeoutException: Statement cancelled due to timeout or client request [statement:\"SELECT id, customer_id, name, force_disabled, enabled FROM customers\"]",
"type":"logs"}</pre>
</div>
<div class="position-relative"><h4><a id="categ-recommendations"></a>Recommendations</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/anomaly-detection/ml-detect-categories.asciidoc">edit</a></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Categorization is tuned to work best on data like log messages by taking token order into account, including stop words, and not considering synonyms in its analysis.
Use machine-written messages for categorization analysis.
</li>
<li class="listitem">
Complete sentences in human communication or literary text (for example email, wiki pages, prose, or other human-generated content) can be extremely diverse in structure.
Since categorization is tuned for machine data, it gives poor results for human-generated data.
It would create so many categories that they couldn’t be handled effectively.
Avoid using human-generated data for categorization analysis.
</li>
</ul>
</div>
<div class="position-relative"><h4><a id="creating-categorization-jobs"></a>Creating categorization jobs</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/anomaly-detection/ml-detect-categories.asciidoc">edit</a></div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Kibana, navigate to <span class="strong strong"><strong>Machine Learning &gt; Anomaly Detection &gt; Jobs</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create job</strong></span>, select the {data-view} you want to analyze.
</li>
<li class="listitem">
Select the <span class="strong strong"><strong>Categorization</strong></span> wizard from the list.
</li>
<li class="listitem">
<p>Choose a categorization detector - it&#8217;s the <code class="literal">count</code> function in this example - and the field you want to categorize - the <code class="literal">message</code> field in this example.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/categorization-wizard.png" alt="Creating a categorization job in Kibana">
</div>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Next</strong></span>.
</li>
<li class="listitem">
Provide a job ID and click <span class="strong strong"><strong>Next</strong></span>.
</li>
<li class="listitem">
If the validation is successful, click <span class="strong strong"><strong>Next</strong></span> to review the summary of the job creation.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create job</strong></span>.
</li>
</ol>
</div>
<p>This example job generates categories from the contents of the <code class="literal">message</code> field and uses the <code class="literal">count</code> function to determine when certain categories are occurring at anomalous rates.</p>
<details>
<summary class="title">API example</summary>
<div class="content">
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">PUT _ml/anomaly_detectors/it_ops_app_logs
{
  "description" : "IT ops application logs",
  "analysis_config" : {
    "categorization_field_name": "message",<a id="CO12-1"></a><i class="conum" data-value="1"></i>
    "bucket_span":"30m",
    "detectors" :[{
      "function":"count",
      "by_field_name": "mlcategory"<a id="CO12-2"></a><i class="conum" data-value="2"></i>
    }]
  },
  "data_description" : {
    "time_field":"@timestamp"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/23.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO12-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This field is used to derive categories.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO12-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The categories are used in a detector by setting <code class="literal">by_field_name</code>, <code class="literal">over_field_name</code>, or <code class="literal">partition_field_name</code> to the keyword <code class="literal">mlcategory</code>.
If you do not specify this keyword in one of those properties, the API request fails.</p>
</td>
</tr>
</table>
</div>
</div>
</details>
<div class="position-relative"><h5><a id="categorization-job-results"></a>Viewing the job results</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/anomaly-detection/ml-detect-categories.asciidoc">edit</a></div>
<p>Use the <span class="strong strong"><strong>Anomaly Explorer</strong></span> in Kibana to view the analysis results:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/ml-category-anomalies.png" alt="Categorization results in the Anomaly Explorer">
</div>
</div>
<p>For this type of job, the results contain extra information for each anomaly: the name of the category (for example, <code class="literal">mlcategory 2</code>) and examples of the messages in that category.
You can use these details to investigate occurrences of unusually high message counts.</p>
<div class="position-relative"><h5><a id="advanced-categorization-options"></a>Advanced configuration options</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/anomaly-detection/ml-detect-categories.asciidoc">edit</a></div>
<p>If you use the advanced anomaly detection job wizard in Kibana or the <a href="/guide/en/elasticsearch/reference/master/ml-put-job.html" class="ulink" target="_top">create anomaly detection jobs API</a>, there are additional configuration options.
For example, the optional <code class="literal">categorization_examples_limit</code> property specifies the maximum number of examples that are stored in memory and in the results data store for each category.
The default value is <code class="literal">4</code>.
Note that this setting does not affect the categorization; it just affects the list of visible examples.
If you increase this value, more examples are available, but you must have more storage available.
If you set this value to <code class="literal">0</code>, no examples are stored.</p>
<p>Another advanced option is the <code class="literal">categorization_filters</code> property, which can contain an array of regular expressions.
If a categorization field value matches the regular expression, the portion of the field that is matched is not taken into consideration when defining categories.
The categorization filters are applied in the order they are listed in the job configuration, which enables you to disregard multiple sections of the categorization field value.
In this example, you might create a filter like <code class="literal">[ "\\[statement:.*\\]"]</code> to remove the SQL statement from the categorization algorithm.</p>
<div class="position-relative"><h4><a id="ml-per-partition-categorization"></a>Per-partition categorization</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/anomaly-detection/ml-detect-categories.asciidoc">edit</a></div>
<p>If you enable per-partition categorization, categories are determined independently for each partition.
For example, if your data includes messages from multiple types of logs from different applications, you can use a field like the ECS <a href="/guide/en/ecs/8.11/ecs-event.html" class="ulink" target="_top"><code class="literal">event.dataset</code> field</a> as the <code class="literal">partition_field_name</code> and categorize the messages for each type of log separately.</p>
<p>If your job has multiple detectors, every detector that uses the <code class="literal">mlcategory</code> keyword must also define a <code class="literal">partition_field_name</code>.
You must use the same <code class="literal">partition_field_name</code> value in all of these detectors.
Otherwise, when you create or update a job and enable per-partition categorization, it fails.</p>
<p>When per-partition categorization is enabled, you can also take advantage of a <code class="literal">stop_on_warn</code> configuration option.
If the categorization status for a partition changes to <code class="literal">warn</code>, it doesn&#8217;t categorize well and can cause unnecessary resource usage.
When you set <code class="literal">stop_on_warn</code> to <code class="literal">true</code>, the job stops analyzing these problematic partitions.
You can thus avoid an ongoing performance cost for partitions that are unsuitable for categorization.</p>
<div class="position-relative"><h4><a id="ml-configuring-analyzer"></a>Customizing the categorization analyzer</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/anomaly-detection/ml-detect-categories.asciidoc">edit</a></div>
<p>Categorization uses English dictionary words to identify log message categories.
By default, it also uses English tokenization rules.
For this reason, if you use the default categorization analyzer, only English language log messages are supported, as described in the <a class="xref" href="ml-limitations.html" title="Machine learning anomaly detection limitations">Limitations</a>.</p>
<p>If you use the categorization wizard in Kibana, you can see which categorization analyzer it uses and highlighted examples of the tokens that it identifies.
You can also change the tokenization rules by customizing the way the categorization field values are interpreted:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/ml-category-analyzer.png" alt="Editing the categorization analyzer in Kibana">
</div>
</div>
<p>The categorization analyzer can refer to a built-in Elasticsearch analyzer or a combination of zero or more character filters, a tokenizer, and zero or more token filters.
In this example, adding a <a href="/guide/en/elasticsearch/reference/master/analysis-pattern-replace-charfilter.html" class="ulink" target="_top"><code class="literal">pattern_replace</code> character filter</a> achieves the same behavior as the <code class="literal">categorization_filters</code> job configuration option described earlier.
For more details about these properties, refer to the <a href="/guide/en/elasticsearch/reference/master/ml-put-job.html#ml-put-job-request-body" class="ulink" target="_top"><code class="literal">categorization_analyzer</code> API object</a>.</p>
<p>If you use the default categorization analyzer in Kibana or omit the <code class="literal">categorization_analyzer</code> property from the API, the following default values are used:</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">POST _ml/anomaly_detectors/_validate
{
  "analysis_config" : {
    "categorization_analyzer" : {
      "char_filter" : [
        "first_line_with_letters"
      ],
      "tokenizer" : "ml_standard",
      "filter" : [
        { "type" : "stop", "stopwords": [
          "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday",
          "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun",
          "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December",
          "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec",
          "GMT", "UTC"
        ] }
      ]
    },
    "categorization_field_name": "message",
    "detectors" :[{
      "function":"count",
      "by_field_name": "mlcategory"
    }]
  },
  "data_description" : {
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/24.console"></div>
<p>If you specify any part of the <code class="literal">categorization_analyzer</code>, however, any omitted sub-properties are <em>not</em> set to default values.</p>
<p>The <code class="literal">ml_standard</code> tokenizer and the day and month stopword filter are almost equivalent to the following analyzer, which is defined using only built-in Elasticsearch <a href="/guide/en/elasticsearch/reference/master/analysis-tokenizers.html" class="ulink" target="_top">tokenizers</a> and <a href="/guide/en/elasticsearch/reference/master/analysis-tokenfilters.html" class="ulink" target="_top">token filters</a>:</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">PUT _ml/anomaly_detectors/it_ops_new_logs
{
  "description" : "IT Ops Application Logs",
  "analysis_config" : {
    "categorization_field_name": "message",
    "bucket_span":"30m",
    "detectors" :[{
      "function":"count",
      "by_field_name": "mlcategory",
      "detector_description": "Unusual message counts"
    }],
    "categorization_analyzer":{
      "char_filter" : [
        "first_line_with_letters" <a id="CO13-1"></a><i class="conum" data-value="1"></i>
      ],
      "tokenizer": {
        "type" : "simple_pattern_split",
        "pattern" : "[^-0-9A-Za-z_./]+" <a id="CO13-2"></a><i class="conum" data-value="2"></i>
      },
      "filter": [
        { "type" : "pattern_replace", "pattern": "^[0-9].*" }, <a id="CO13-3"></a><i class="conum" data-value="3"></i>
        { "type" : "pattern_replace", "pattern": "^[-0-9A-Fa-f.]+$" }, <a id="CO13-4"></a><i class="conum" data-value="4"></i>
        { "type" : "pattern_replace", "pattern": "^[^0-9A-Za-z]+" }, <a id="CO13-5"></a><i class="conum" data-value="5"></i>
        { "type" : "pattern_replace", "pattern": "[^0-9A-Za-z]+$" }, <a id="CO13-6"></a><i class="conum" data-value="6"></i>
        { "type" : "stop", "stopwords": [
          "",
          "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday",
          "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun",
          "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December",
          "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec",
          "GMT", "UTC"
        ] }
      ]
    }
  },
  "analysis_limits":{
    "categorization_examples_limit": 5
  },
  "data_description" : {
    "time_field":"time",
    "time_format": "epoch_ms"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/25.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO13-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Only consider the first line of the message with letters for categorization purposes.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO13-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Tokens consist of hyphens, digits, letters, underscores, dots and slashes.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO13-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>By default, categorization ignores tokens that begin with a digit.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO13-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>By default, categorization ignores tokens that are hexadecimal numbers.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO13-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>Underscores, hyphens, and dots are removed from the beginning of tokens.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO13-6"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>Underscores, hyphens, and dots are also removed from the end of tokens.</p>
</td>
</tr>
</table>
</div>
<p>The key difference between the default <code class="literal">categorization_analyzer</code> and this example analyzer is that using the <code class="literal">ml_standard</code> tokenizer is several times faster.
The <code class="literal">ml_standard</code> tokenizer also tries to preserve URLs, Windows paths and email addresses as single tokens.
Another difference in behavior is that the custom analyzer does not include accented letters in tokens whereas the <code class="literal">ml_standard</code> tokenizer does.
This could be fixed by using more complex regular expressions.</p>
<p>If you are categorizing non-English messages in a language where words are separated by spaces, you might get better results if you change the day or month words in the stop token filter to the appropriate words in your language.
If you are categorizing messages in a language where words are not separated by spaces, you must use a different tokenizer as well in order to get sensible categorization results.</p>
<p>It is important to be aware that analyzing for categorization of machine generated log messages is a little different from tokenizing for search.
Features that work well for search, such as stemming, synonym substitution, and lowercasing are likely to make the results of categorization worse.
However, to drill down from machine learning results to work correctly, the tokens the categorization analyzer produces must be similar to those produced by the search analyzer.
If they are sufficiently similar, when you search for the tokens that the categorization analyzer produces then you find the original document that the categorization field value came from.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="ml-configuring-detector-custom-rules.html">« Customizing detectors with custom rules</a>
</span>
<span class="next">
<a href="ml-configuring-populations.html">Performing population analysis »</a>
</span>
</div>
</body>
</html>
