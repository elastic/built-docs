<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="keywords" content="ML, Elastic Stack, anomaly detection, data frame analytics">
<title>Predicting classes with classification | Machine Learning in the Elastic Stack [master] | Elastic</title>
<meta class="elastic" name="content" content="Predicting classes with classification | Machine Learning in the Elastic Stack [master]">

<link rel="home" href="index.html" title="Machine Learning in the Elastic Stack [master]"/>
<link rel="up" href="ml-dfanalytics.html" title="Data frame analytics"/>
<link rel="prev" href="ml-dfa-regression.html" title="Predicting numerical values with regression"/>
<link rel="next" href="ml-dfa-concepts.html" title="Advanced concepts"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Machine Learning"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elastic Stack/Machine Learning/master"/>
<meta name="DC.subject" content="Machine Learning"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="ml-dfa-regression.html">« Predicting numerical values with regression</a>
</span>
<span class="next">
<a href="ml-dfa-concepts.html">Advanced concepts »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Machine Learning in the Elastic Stack [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="ml-dfanalytics.html">Data frame analytics</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Predicting classes with classification</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="ml-dfa-classification"></a>Predicting classes with classification<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h2>
</div></div></div>
<p>Classification is a machine learning process that predicts the class or category of a
data point in a data set. For a simple example, consider how the shapes in the
following graph can be differentiated and classified as "circles" and
"triangles":</p>
<div class="imageblock text-center">
<div class="content">
<img src="images/classification-vis.png" alt="Classification process">
</div>
</div>
<p>In reality, classification problems are more complex, such as classifying
malicious and benign domains to detect DGA activities for security reasons or
predicting customer churn based on customer calling data. Classification
is for predicting discrete, categorical values.</p>
<p>When you create a classification job, you must specify which field contains
the classes that you want to predict. This field is known as the <em>dependent variable</em>. It
can contain maximum 100 classes. By default, all other
<a href="/guide/en/elasticsearch/reference/master/put-dfanalytics.html#dfa-supported-fields" class="ulink" target="_top">supported fields</a> are included
in the analysis and are known as <em>feature variables</em>. You can optionally include or
exclude fields. For more information about field selection, refer to the
<a href="/guide/en/elasticsearch/reference/master/explain-dfanalytics.html" class="ulink" target="_top">explain data frame analytics API</a>.</p>
<h3><a id="dfa-classification-algorithm"></a>Classification algorithms<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h3>
<p>Classification analysis uses an ensemble algorithm that is similar to extreme
gradient boosting (XGBoost) which combines multiple weak models into a composite
one. It uses decision trees to learn to predict the probability that a data
point belongs to a certain class. XGBoost trains a sequence of decision
trees and every decision tree learns from the mistakes of the forest so far.
In each iteration, the trees added to the forest improve the decision quality of
the combined decision forest. The classification algorithm optimizes for a loss
function called cross-entropy loss.</p>
<h3><a id="dfa-classification-problem"></a>1. Define the problem<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h3>
<p>Classification can be useful in cases where discrete, categorical values
needs to be predicted. If your use case requires predicting such values, then
classification might be the suitable choice for you.</p>
<h3><a id="dfa-classification-environment"></a>2. Set up the environment<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h3>
<p>Before you can use the Elastic Stack machine learning features, there are some configuration
requirements (such as security privileges) that must be addressed. Refer to
<a class="xref" href="setup.html" title="Set up machine learning features"><em>Setup and security</em></a>.</p>
<h3><a id="dfa-classification-prepare-data"></a>3. Prepare and transform data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h3>
<p>Classification is a supervised machine learning method, which means you need to supply
a labeled training data set. This data set must have values for the
feature variables and the dependent variable which are used to train the model. The training
process uses this information to learn the relationships between the classes
and the feature variables. This labeled data set also plays a critical role in
model evaluation.</p>
<p>If possible, prepare your input data such that it has less classes. A
classification analysis with many classes takes more time to run than a binary
classification job. The relationship between the number of classes and the
runtime is roughly linear.</p>
<p>You might also need to <a href="/guide/en/elasticsearch/reference/master/transforms.html" class="ulink" target="_top">transform</a> your data to create a
data frame which can be used as the source for classification.</p>
<p>To learn more about how to prepare your data, refer to
<a class="xref" href="ml-dfa-overview.html#prepare-transform-data" title="Prepare and transform data">the relevant section</a> of the supervised learning
overview.</p>
<h3><a id="dfa-classification-create-job"></a>4. Create a job<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h3>
<p>Data frame analytics jobs contain the configuration information and metadata
necessary to perform an analytics task. You can create data frame analytics jobs via
Kibana or using the <a href="/guide/en/elasticsearch/reference/master/put-dfanalytics.html" class="ulink" target="_top">create data frame analytics jobs API</a>.</p>
<p>Select classification as the analytics type, then select the field that you
want to predict (the dependent variable). You can also include and exclude fields.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can view the statistics of the selectable fields in the data frame analytics
wizard. The field statistics displayed in a flyout provide more meaningful
context to help you select relevant fields.</p>
</div>
</div>
<p>To improve performance, consider using a small <code class="literal">training_percent</code> value to train
the model more quickly. It is a good strategy to make progress iteratively: run
the analysis with a small training percentage, then evaluate the performance.
Based on the results, you can decide if it is necessary to increase the
<code class="literal">training_percent</code> value.</p>
<h3><a id="dfa-classification-start"></a>5. Start the job<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h3>
<p>You can start the job via Kibana or using the
<a href="/guide/en/elasticsearch/reference/master/start-dfanalytics.html" class="ulink" target="_top">start data frame analytics jobs</a> API. A classification
job has the following phases:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">reindexing</code>: Documents are copied from the source index to the destination
index.
</li>
<li class="listitem">
<code class="literal">loading_data</code>: The job fetches the necessary data from the destination index.
</li>
<li class="listitem">
<code class="literal">feature_selection</code>: The process identifies the most relevant analyzed fields
for predicting the dependent variable.
</li>
<li class="listitem">
<code class="literal">coarse_parameter_search</code>: The process identifies initial values for undefined
hyperparameters.
</li>
<li class="listitem">
<code class="literal">fine_tuning_parameters</code>: The process identifies final values for undefined
hyperparameters. Refer to <a class="xref" href="hyperparameters.html" title="Hyperparameter optimization">hyperparameter optimization</a>.
</li>
<li class="listitem">
<code class="literal">final_training</code>: The model training occurs.
</li>
<li class="listitem">
<code class="literal">writing_results</code>: The job matches the results with the data rows in the
destination index, merges them, and indexes them back to the destination
index.
</li>
<li class="listitem">
<code class="literal">inference</code>: The job validates the trained model against the test split of the
data set.
</li>
</ul>
</div>
<p>After the last phase is finished, the job stops and the results are ready for
evaluation.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When you create a data frame analytics job, the inference step of the process
might fail if the model is too large to fit into JVM. For a workaround, refer
to <a href="https://github.com/elastic/elasticsearch/issues/76093" class="ulink" target="_top">this GitHub issue</a>.</p>
</div>
</div>
<h3><a id="ml-dfanalytics-classification-evaluation"></a>6. Evaluate and interpret the result<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h3>
<p>Using the data frame analytics features to gain insights from a data set is an
iterative process. After you defined the problem you want to solve, and chose
the analytics type that can help you to do so, you need to produce a
high-quality data set and create the appropriate data frame analytics job. You might
need to experiment with different configurations, parameters, and ways to
transform data before you arrive at a result that satisfies your use case. A
valuable companion to this process is the
<a href="/guide/en/elasticsearch/reference/master/evaluate-dfanalytics.html" class="ulink" target="_top">evaluate data frame analytics API</a>, which enables you to evaluate
the data frame analytics performance. It helps you understand error distributions and
identifies the points where the data frame analytics model performs well or less
trustworthily.</p>
<p>To evaluate the analysis with this API, you need to annotate your index that
contains the results of the analysis with a field that marks each document with
the ground truth. The evaluate data frame analytics API evaluates the performance of the
data frame analytics against this manually provided ground truth.</p>
<p>You can measure how well the model has performed on your training data set by
using the <code class="literal">classification</code> evaluation type of the
<a href="/guide/en/elasticsearch/reference/master/evaluate-dfanalytics.html" class="ulink" target="_top">evaluate data frame analytics API</a> or by viewing the
job results in Kibana. The classification evaluation offers the following
metrics to evaluate the model performance:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Multiclass confusion matrix
</li>
<li class="listitem">
Area under the curve of receiver operating characteristic (AUC ROC)
</li>
</ul>
</div>
<p>The following metrics helps you interpret the analysis results:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feature importance
</li>
<li class="listitem">
<code class="literal">class_probability</code>
</li>
<li class="listitem">
<code class="literal">class_score</code>
</li>
</ul>
</div>
<h4><a id="ml-dfanalytics-mccm"></a>Multiclass confusion matrix<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h4>
<p>The multiclass confusion matrix provides a summary of the performance of the
classification analysis. It contains the number of occurrences where the analysis
classified data points correctly with their actual class as well as the number
of occurrences where it misclassified them.</p>
<p>This is an example of a confusion matrix for a binary problem:</p>
<div class="imageblock text-center">
<div class="content">
<img src="images/confusion-matrix-binary.jpg" alt="Confusion matrix of a binary problem" width="75%">
</div>
</div>
<p>It is a two by two matrix because there are only two classes (<code class="literal">true</code> and
<code class="literal">false</code>). It shows the proportion of data points that is correctly identified as
members of a each class and the proportion that is misidentified.</p>
<p>As the number of classes increases, the confusion matrix becomes more complex:</p>
<div class="imageblock text-center">
<div class="content">
<img src="images/confusion-matrix-multiclass.jpg" alt="Confusion matrix of a multiclass problem" width="100%">
</div>
</div>
<p>This matrix contains the actual labels on the left side while the predicted
labels are on the top. The proportion of correct and incorrect predictions is
broken down for each class. This enables you to examine how the classification analysis
confused the different classes while it made its predictions.</p>
<h4><a id="ml-dfanalytics-class-aucroc"></a>Area under the curve of receiver operating characteristic (AUC ROC)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h4>
<p>The receiver operating characteristic (ROC) curve is a plot that represents the
performance of the classification process at different predicted probability
thresholds. It compares the true positive rate for a specific class against the
rate of all the other classes combined ("one versus all" strategy) at the
different threshold levels to create the curve.</p>
<p>For example, there are three classes: <code class="literal">A</code>, <code class="literal">B</code>, and <code class="literal">C</code>, and AUC ROC is
calculated for <code class="literal">A</code>. In this case, the number of correctly classified <code class="literal">A</code>s
(true positives) are compared to the number of <code class="literal">B</code>s and <code class="literal">C</code>s that are
misclassified as <code class="literal">A</code>s (false positives).</p>
<p>From this plot, you can compute the area under the curve (AUC) value, which is a
number between 0 and 1. The higher the AUC, the better the model is at
predicting <code class="literal">A</code>s as <code class="literal">A</code>s, in this case.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>To use this evaluation method, you must set <code class="literal">num_top_classes</code> to <code class="literal">-1</code>
or a value greater than or equal to the total number of classes when you create
the data frame analytics job.</p>
</div>
</div>
<h4><a id="dfa-classification-feature-importance"></a>Feature importance<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h4>
<p>Feature importance provides further information about the results of an analysis and
helps to interpret the results in a more subtle way. If you want to learn more
about feature importance, refer to <a class="xref" href="ml-feature-importance.html" title="Feature importance">Feature importance</a>.</p>
<h4><a id="dfa-classification-class-probability"></a><code class="literal">class_probability</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h4>
<p>The <code class="literal">class_probability</code> is a value between 0 and 1, which indicates how likely
it is that a given data point belongs to a certain class. The higher the number,
the higher the probability that the data point belongs to the named class. This
information is stored in the <code class="literal">top_classes</code> array for each document in the
destination index.</p>
<h4><a id="dfa-classification-class-score"></a><code class="literal">class_score</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h4>
<p>The <code class="literal">class_score</code> is a function of the <code class="literal">class_probability</code> and has a value that
is greater than or equal to zero. It takes into consideration your objective (as
defined in the <code class="literal">class_assignment_objective</code> job configuration option):
<em>accuracy</em> or <em>recall</em>.</p>
<p>If your objective is to maximize accuracy, the scores are weighted to maximize
the proportion of correct predictions in the training data set.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/confusion-matrix-binary-accuracy.jpg" alt="A confusion matrix with the correct predictions highlighted" width="75%">
</div>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If there is an imbalanced class distribution in your training data,
focusing on accuracy can decrease your model&#8217;s sensitivity to incorrect
predictions in the under-represented classes.</p>
</div>
</div>
<p>By default, classification analysis jobs accept a slight degradation of the overall
accuracy in return for greater sensitivity to classes that are predicted
incorrectly. That is to say, their objective is to maximize the minimum recall.
For example, in the context of a multi-class confusion matrix, the predictions
of interest are in each row:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/confusion-matrix-multiclass-recall.jpg" alt="A confusion matrix with a row highlighted">
</div>
</div>
<p>For each class, the recall is calculated as the number of correct predictions
divided by the sum of all the other predicted labels in that row. This value is
represented as a percentage in each cell of the confusion matrix. The class
scores are then weighted to favor predictions that result in the highest recall
values across the training data. This objective typically performs better than
accuracy when you have highly imbalanced data.</p>
<p>To learn more about choosing the class assignment objective that fits your goal,
refer to this
<a href="https://github.com/elastic/examples/blob/master/Machine%20Learning/Class%20Assigment%20Objectives/classification-class-assignment-objective.ipynb" class="ulink" target="_top">Jupyter notebook</a>.</p>
<h3><a id="dfa-classification-deploy"></a>7. Deploy the model<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h3>
<p>The model that you created is stored as Elasticsearch documents in internal indices. In
other words, the characteristics of your trained model are saved and ready to be
deployed and used as functions.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
To deploy data frame analytics model in a pipeline, navigate to  <span class="strong strong"><strong>Machine Learning</strong></span> &gt;
<span class="strong strong"><strong>Model Management</strong></span> &gt; <span class="strong strong"><strong>Trained models</strong></span> in Kibana.
</li>
<li class="listitem">
<p>Find the model you want to deploy in the list and click <span class="strong strong"><strong>Deploy model</strong></span> in
the <span class="strong strong"><strong>Actions</strong></span> menu.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/ml-dfa-trained-models-ui.png" alt="The trained models UI in Kibana">
</div>
</div>
</li>
<li class="listitem">
<p>Create an inference pipeline to be able to use the model against new data
through the pipeline. Add a name and a description or use the default values.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/ml-dfa-inference-pipeline.png" alt="Creating an inference pipeline">
</div>
</div>
</li>
<li class="listitem">
<p>Configure the pipeline processors or use the default settings.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/ml-dfa-inference-processor.png" alt="Configuring an inference processor">
</div>
</div>
</li>
<li class="listitem">
Configure to handle ingest failures or use the default settings.
</li>
<li class="listitem">
(Optional) Test your pipeline by running a simulation of the pipeline to
confirm it produces the anticipated results.
</li>
<li class="listitem">
Review the settings and click <span class="strong strong"><strong>Create pipeline</strong></span>.
</li>
</ol>
</div>
<p>The model is deployed and ready to use through the inference pipeline.</p>
<h4><a id="ml-inference-class"></a>Inference<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h4>
<p>Inference enables you to use <a class="xref" href="ml-trained-models.html" title="Trained models">trained machine learning models</a> against
incoming data in a continuous fashion.</p>
<p>For instance, suppose you have an online service and you would like to predict
whether a customer is likely to churn. You have an index with historical data –
information on the customer behavior throughout the years in your business – and
a classification model that is trained on this data. The new information comes
into a destination index of a continuous transform. With inference, you can perform the
classification analysis against the new data with the same input fields that you&#8217;ve
trained the model on, and get a prediction.</p>
<h5><a id="ml-inference-processor-class"></a>Inference processor<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h5>
<p>Inference can be used as a processor specified in an
<a href="/guide/en/elasticsearch/reference/master/ingest.html" class="ulink" target="_top">ingest pipeline</a>. It uses a trained model to infer against
the data that is being ingested in the pipeline. The model is used on the ingest
node. Inference pre-processes the data by using the model and provides a
prediction. After the process, the pipeline continues executing (if there is any
other processor in the pipeline), finally the new data together with the results
are indexed into the destination index.</p>
<p>Check the <a href="/guide/en/elasticsearch/reference/master/inference-processor.html" class="ulink" target="_top">inference processor</a> and
<a href="/guide/en/elasticsearch/reference/master/ml-df-analytics-apis.html" class="ulink" target="_top">the machine learning data frame analytics API documentation</a> to
learn more.</p>
<h5><a id="ml-inference-aggregation-class"></a>Inference aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h5>
<p>Inference can also be used as a pipeline aggregation. You can reference a
trained model in the aggregation to infer on the result field of the parent
bucket aggregation. The inference aggregation uses the model on the results to
provide a prediction. This aggregation enables you to run classification or
regression analysis at search time. If you want to perform the analysis on a small set
of data, this aggregation enables you to generate predictions without the need
to set up a processor in the ingest pipeline.</p>
<p>Check the
<a href="/guide/en/elasticsearch/reference/master/search-aggregations-pipeline-inference-bucket-aggregation.html" class="ulink" target="_top">inference bucket aggregation</a>
and <a href="/guide/en/elasticsearch/reference/master/ml-df-analytics-apis.html" class="ulink" target="_top">the machine learning data frame analytics API documentation</a> to
learn more.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you use trained model aliases to reference your trained model in an
inference processor or inference aggregation, you can replace your trained model
with a new one without the need of updating the processor or the aggregation.
Reassign the alias you used to a new trained model ID by using the
<a href="/guide/en/elasticsearch/reference/master/put-trained-models-aliases.html" class="ulink" target="_top">Create or update trained model aliases API</a>.
The new trained model needs to use the same type of data frame analytics as the old
one.</p>
</div>
</div>
<h3><a id="performing-classification"></a>Performing classification analysis in the sample flight data set<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h3>
<p>Let&#8217;s try to predict whether a flight will be delayed or not by using the
<a href="/guide/en/kibana/master/get-started.html#gs-get-data-into-kibana" class="ulink" target="_top">sample flight data</a>. The
data set contains information such as weather conditions, carrier, flight
distance, origin, destination, and whether or not the flight was delayed. The
classification model learns the relationships between the fields in your data
to predict the value of the <em>dependent variable</em>, which in this case is the
boolean <code class="literal">FlightDelay</code> field.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you want to view this example in a Jupyter notebook,
<a href="https://github.com/elastic/examples/tree/master/Machine%20Learning/Analytics%20Jupyter%20Notebooks" class="ulink" target="_top">click here</a>.</p>
</div>
</div>
<h4><a id="flightdata-classification-data"></a>Preparing your data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h4>
<p>Each document in the sample flight data set contains details for a single
flight, so the data is ready for analysis; it is already in a two-dimensional
entity-based data structure. In general, you often need to
<a href="/guide/en/elasticsearch/reference/master/transforms.html" class="ulink" target="_top">transform</a> the data into an entity-centric index before
you can analyze it.</p>
<p>In order to be analyzed, a document must contain at least one field with a
supported data type (<code class="literal">numeric</code>, <code class="literal">boolean</code>, <code class="literal">text</code>, <code class="literal">keyword</code> or <code class="literal">ip</code>) and must
not contain arrays with more than one item. If your source data consists of some
documents that contain the dependent variable and some that do not, the model is
trained on the subset of documents that contain it.</p>
<details>
<summary class="title">Example source document</summary>
<div class="content">
<pre class="screen">{
  "_index": "kibana_sample_data_flights",
  "_type": "_doc",
  "_id": "S-JS1W0BJ7wufFIaPAHe",
  "_version": 1,
  "_seq_no": 3356,
  "_primary_term": 1,
  "found": true,
  "_source": {
    "FlightNum": "N32FE9T",
    "DestCountry": "JP",
    "OriginWeather": "Thunder &amp; Lightning",
    "OriginCityName": "Adelaide",
    "AvgTicketPrice": 499.08518599798685,
    "DistanceMiles": 4802.864932998549,
    "FlightDelay": false,
    "DestWeather": "Sunny",
    "Dest": "Chubu Centrair International Airport",
    "FlightDelayType": "No Delay",
    "OriginCountry": "AU",
    "dayOfWeek": 3,
    "DistanceKilometers": 7729.461862731618,
    "timestamp": "2019-10-17T11:12:29",
    "DestLocation": {
      "lat": "34.85839844",
      "lon": "136.8049927"
    },
    "DestAirportID": "NGO",
    "Carrier": "ES-Air",
    "Cancelled": false,
    "FlightTimeMin": 454.6742272195069,
    "Origin": "Adelaide International Airport",
    "OriginLocation": {
      "lat": "-34.945",
      "lon": "138.531006"
    },
    "DestRegion": "SE-BD",
    "OriginAirportID": "ADL",
    "OriginRegion": "SE-BD",
    "DestCityName": "Tokoname",
    "FlightTimeHour": 7.577903786991782,
    "FlightDelayMin": 0
  }
}</pre>
</div>
</details>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>The sample flight data set is used in this example because it is easily
accessible. However, the data has been manually created and contains some
inconsistencies. For example, a flight can be both delayed and canceled. This is
a good reminder that the quality of your input data affects the quality of your
results.</p>
</div>
</div>
<h4><a id="flightdata-classification-model"></a>Creating a classification model<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h4>
<p>To predict whether a specific flight is delayed:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create a data frame analytics job.</p>
<p>You can use the wizard on the <span class="strong strong"><strong>Machine Learning</strong></span> &gt; <span class="strong strong"><strong>Data Frame Analytics</strong></span> tab
in Kibana or the <a href="/guide/en/elasticsearch/reference/master/put-dfanalytics.html" class="ulink" target="_top">create data frame analytics jobs</a> API.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-job-1.jpg" alt="Creating a data frame analytics job in Kibana">
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Choose <code class="literal">kibana_sample_data_flights</code> as the source index.
</li>
<li class="listitem">
Choose <code class="literal">classification</code> as the job type.
</li>
<li class="listitem">
Choose <code class="literal">FlightDelay</code> as the dependent variable, which is the field that we
want to predict with the classification analysis.
</li>
<li class="listitem">
<p>Add <code class="literal">Cancelled</code>, <code class="literal">FlightDelayMin</code>, and <code class="literal">FlightDelayType</code> to the list of
excluded fields. It is recommended to exclude fields that either contain
erroneous data or describe the <code class="literal">dependent_variable</code>.</p>
<p>The wizard includes a scatterplot matrix, which enables you to explore the
relationships between the numeric fields. The color of each point is affected by
the value of the dependent variable for that document, as shown in the legend. You can
highlight an area in one of the charts and the corresponding area is also
highlighted in the rest of the charts. You can use this matrix to help you
decide which fields to include or exclude.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-scatterplot.png" alt="A scatterplot matrix for three fields in Kibana">
</div>
</div>
<p>If you want these charts to represent data from a larger sample size or from a
randomized selection of documents, you can change the default behavior. However,
a larger sample size might slow down the performance of the matrix and a
randomized selection might put more load on the cluster due to the more
intensive query.</p>
</li>
<li class="listitem">
Choose a training percent of <code class="literal">10</code> which means it randomly selects 10% of the
source data for training. While that value is low for this example, for many
large data sets using a small training sample greatly reduces runtime without
impacting accuracy.
</li>
<li class="listitem">
If you want to experiment with <a class="xref" href="ml-feature-importance.html" title="Feature importance">feature importance</a>, specify
a value in the advanced configuration options. In this example, a maximum of 10
feature importance values per document will return. This option affects the speed of the
analysis, so by default it is disabled.
</li>
<li class="listitem">
Use the default memory limit for the job. If the job requires more than this
amount of memory, it fails to start. If the available memory on the node is
limited, this setting makes it possible to prevent job execution.
</li>
<li class="listitem">
Add a job ID (such as <code class="literal">model-flight-delays-classification</code>) and optionally a
job description.
</li>
<li class="listitem">
Add the name of the destination index that will contain the results. In
Kibana, the index name matches the job ID by default. It will contain a copy of
the source index data where each document is annotated with the results. If the
index does not exist, it will be created automatically.
</li>
<li class="listitem">
<p>Use default values for all other options.</p>
<details>
<summary class="title">API example</summary>
<div class="content">
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">PUT _ml/data_frame/analytics/model-flight-delays-classification
{
  "source": {
    "index": [
      "kibana_sample_data_flights"
    ]
  },
  "dest": {
    "index": "model-flight-delays-classification",
    "results_field": "ml" <a id="CO18-1"></a><i class="conum" data-value="1"></i>
  },
  "analysis": {
    "classification": {
      "dependent_variable": "FlightDelay",
      "training_percent": 10,
      "num_top_feature_importance_values": 10 <a id="CO18-2"></a><i class="conum" data-value="2"></i>
    }
  },
  "analyzed_fields": {
    "includes": [],
    "excludes": [
      "Cancelled",
      "FlightDelayMin",
      "FlightDelayType"
    ]
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/49.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO18-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The field name in the <code class="literal">dest</code> index that contains the analysis results.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO18-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>To disable feature importance calculations, omit this option.</p>
</td>
</tr>
</table>
</div>
</div>
</details>
<p>After you configured your job, the configuration details are automatically
validated. If the checks are successful, you can start the job. A warning
message is shown if the configuration is invalid. The message contains a
suggestion to improve the configuration to be validated.</p>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>Start the job in Kibana or use the
<a href="/guide/en/elasticsearch/reference/master/start-dfanalytics.html" class="ulink" target="_top">start data frame analytics jobs</a> API.</p>
<p>The job takes a few minutes to run. Runtime depends on the local hardware and
also on the number of documents and fields that are analyzed. The more fields
and documents, the longer the job runs. It stops automatically when the analysis
is complete.</p>
<details>
<summary class="title">API example</summary>
<div class="content">
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">POST _ml/data_frame/analytics/model-flight-delays-classification/_start</pre>
</div>
<div class="console_widget" data-snippet="snippets/50.console"></div>
</div>
</details>
</li>
<li class="listitem">
<p>Check the job stats to follow the progress in Kibana or use the
<a href="/guide/en/elasticsearch/reference/master/get-dfanalytics-stats.html" class="ulink" target="_top">get data frame analytics jobs statistics API</a>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-details.jpg" alt="Statistics for a data frame analytics job in Kibana">
</div>
</div>
<p>When the job stops, the results are ready to view and evaluate. To learn more
about the job phases, see <a class="xref" href="ml-dfa-phases.html" title="How a data frame analytics job works">How data frame analytics jobs work</a>.</p>
<details>
<summary class="title">API example</summary>
<div class="content">
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET _ml/data_frame/analytics/model-flight-delays-classification/_stats</pre>
</div>
<div class="console_widget" data-snippet="snippets/51.console"></div>
<p>The API call returns the following response:</p>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "count" : 1,
  "data_frame_analytics" : [
    {
      "id" : "model-flight-delays-classification",
      "state" : "stopped",
      "progress" : [
        {
          "phase" : "reindexing",
          "progress_percent" : 100
        },
        {
          "phase" : "loading_data",
          "progress_percent" : 100
        },
        {
          "phase" : "feature_selection",
          "progress_percent" : 100
        },
        {
          "phase" : "coarse_parameter_search",
          "progress_percent" : 100
        },
        {
          "phase" : "fine_tuning_parameters",
          "progress_percent" : 100
        },
        {
          "phase" : "final_training",
          "progress_percent" : 100
        },
        {
          "phase" : "writing_results",
          "progress_percent" : 100
        },
        {
          "phase" : "inference",
          "progress_percent" : 100
        }
      ],
      "data_counts" : {
        "training_docs_count" : 1305,
        "test_docs_count" : 11754,
        "skipped_docs_count" : 0
      },
      "memory_usage" : {
        "timestamp" : 1597182490577,
        "peak_usage_bytes" : 316613,
        "status" : "ok"
      },
      "analysis_stats" : {
        "classification_stats" : {
          "timestamp" : 1601405047110,
          "iteration" : 18,
          "hyperparameters" : {
            "class_assignment_objective" : "maximize_minimum_recall",
            "alpha" : 0.7633136599817167,
            "downsample_factor" : 0.9473152348018332,
            "eta" : 0.02331774683318904,
            "eta_growth_rate_per_tree" : 1.0143154178910303,
            "feature_bag_fraction" : 0.5504020748926737,
            "gamma" : 0.26389161802240446,
            "lambda" : 0.6309726978583623,
            "max_attempts_to_add_tree" : 3,
            "max_optimization_rounds_per_hyperparameter" : 2,
            "max_trees" : 894,
            "num_folds" : 5,
            "num_splits_per_feature" : 75,
            "soft_tree_depth_limit" : 4.672705943455812,
            "soft_tree_depth_tolerance" : 0.13448633124842999
            },
            "timing_stats" : {
              "elapsed_time" : 76459,
              "iteration_time" : 1861
            },
            "validation_loss" : {
              "loss_type" : "binomial_logistic"
            }
          }
      }
    }
  ]
}</pre>
</div>
</div>
</details>
</li>
</ol>
</div>
<h4><a id="flightdata-classification-results"></a>Viewing classification results<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h4>
<p>Now you have a new index that contains a copy of your source data with
predictions for your dependent variable.</p>
<p>When you view the classification results in Kibana, it shows the contents of
the destination index in a tabular format. It also provides information about
the analysis details, model evaluation metrics, total feature importance values, and a
scatterplot matrix.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-results.jpg" alt="Destination index table for a classification job in Kibana">
</div>
</div>
<p>The table shows a column for the dependent variable (<code class="literal">FlightDelay</code>), which contains the
ground truth values that you are trying to predict. It also shows a column for
the predicted values (<code class="literal">ml.FlightDelay_prediction</code>), which were generated by the
classification analysis. The <code class="literal">ml.is_training</code> column indicates whether the document was
used in the training or testing data set. You can use the <span class="strong strong"><strong>Training</strong></span> and
<span class="strong strong"><strong>Testing</strong></span> filter options to refine the contents of the results table. You can
also enable histogram charts to get a better understanding of the distribution
of values.</p>
<p>If you want to understand how certain the model is about each prediction, you
can examine its probability and score (<code class="literal">ml.prediction_probability</code> and
<code class="literal">ml.prediction_score</code>). The higher these values are, the more confident the
model is that the data point belongs to the named class. If you examine the
destination index more closely in the <span class="strong strong"><strong>Discover</strong></span> app in Kibana or use the
standard Elasticsearch search command, you can see that the analysis predicts the
probability of all possible classes for the dependent variable. The <code class="literal">top_classes</code> object
contains the predicted classes with the highest scores.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you have a large number of classes, your destination index contains a
large number of predicted probabilities for each document. When you create the
classification job, you can use the <code class="literal">num_top_classes</code> option to modify this
behavior.</p>
</div>
</div>
<details>
<summary class="title">API example</summary>
<div class="content">
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET model-flight-delays-classification/_search</pre>
</div>
<div class="console_widget" data-snippet="snippets/52.console"></div>
<p>The snippet below shows the probability and score details for a document in the
destination index:</p>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">          ...
          "FlightDelay" : false,
          ...
          "ml" : {
            "FlightDelay_prediction" : false,
            "top_classes" : [ <a id="CO19-1"></a><i class="conum" data-value="1"></i>
              {
                "class_name" : false,
                "class_probability" : 0.9427605087816684,
                "class_score" : 0.3462468700158476
              },
              {
                "class_name" : true,
                "class_probability" : 0.057239491218331606,
                "class_score" : 0.057239491218331606
              }
            ],
            "prediction_probability" : 0.9427605087816684,
            "prediction_score" : 0.3462468700158476,
            ...</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO19-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>An array of values specifying the probability of the prediction and the
score for each class.</p>
</td>
</tr>
</table>
</div>
<p>The class with the highest score is the prediction. In this example, <code class="literal">false</code> has
a <code class="literal">class_score</code> of 0.35 while <code class="literal">true</code> has only 0.06, so the prediction will be
<code class="literal">false</code>. For more details about these values, see
<a class="xref" href="ml-dfa-classification.html#dfa-classification-class-score" title="class_score"><code class="literal">class_score</code></a>.</p>
</div>
</details>
<p>If you chose to calculate feature importance, the destination index also contains
<code class="literal">ml.feature_importance</code> objects. Every field that is included in the
analysis (known as a <em>feature</em> of the data point) is assigned a feature importance
value. It has both a magnitude and a direction (positive or negative), which
indicates how each field affects a particular prediction. Only the most
significant values (in this case, the top 10) are stored in the index. However,
the trained model metadata also contains the average magnitude of the feature importance
values for each field across all the training data. You can view this
summarized information in Kibana:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-total-importance.jpg" alt="Total feature importance values in Kibana">
</div>
</div>
<p>You can also see the feature importance values for each individual prediction in the
form of a decision plot:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-importance.png" alt="A decision plot for feature importance values in Kibana">
</div>
</div>
<p>In Kibana, the decision path shows the relative impact of each feature on the
probability of the prediction. The features with the most significant positive
or negative impact appear at the top of the decision plot. Thus in this example,
the features related to flight time and distance had the most significant
influence on the probability value for this prediction. This type of information
can help you to understand how models arrive at their predictions. It can also
indicate which aspects of your data set are most influential or least useful
when you are training and tuning your model.</p>
<p>If you do not use Kibana, you can see the summarized feature importance values by using
the <a href="/guide/en/elasticsearch/reference/master/get-inference.html" class="ulink" target="_top">get trained model API</a> and the individual values by
searching the destination index.</p>
<details>
<summary class="title">API example</summary>
<div class="content">
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET _ml/trained_models/model-flight-delays-classification*?include=total_feature_importance</pre>
</div>
<div class="console_widget" data-snippet="snippets/53.console"></div>
<p>The snippet below shows an example of the total feature importance and the corresponding
baseline in the trained model metadata:</p>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "count" : 1,
  "trained_model_configs" : [
    {
      "model_id" : "model-flight-delays-classification-1601405047985",
      ...
      "metadata" : {
        ...
        "feature_importance_baseline" : { <a id="CO20-1"></a><i class="conum" data-value="1"></i>
          "classes" : [
            {
              "class_name" : true,
              "baseline" : -1.5869016940485443
            },
            {
              "class_name" : false,
              "baseline" : 1.5869016940485443
            }
          ]
        },
        "total_feature_importance" : [
          {
            "feature_name" : "dayOfWeek",
            "classes" : [
              {
                "class_name" : false,
                "importance" : {
                  "mean_magnitude" : 0.037513174351966404, <a id="CO20-2"></a><i class="conum" data-value="2"></i>
                  "min" : -0.20132653028125566, <a id="CO20-3"></a><i class="conum" data-value="3"></i>
                  "max" : 0.20132653028125566 <a id="CO20-4"></a><i class="conum" data-value="4"></i>
                }
              },
              {
                "class_name" : true,
                "importance" : {
                  "mean_magnitude" : 0.037513174351966404,
                  "min" : -0.20132653028125566,
                  "max" : 0.20132653028125566
                }
              }
            ]
          },
          {
            "feature_name" : "OriginWeather",
            "classes" : [
              {
                "class_name" : false,
                "importance" : {
                  "mean_magnitude" : 0.05486662317369895,
                  "min" : -0.3337477336556598,
                  "max" : 0.3337477336556598
                }
              },
              {
                "class_name" : true,
                "importance" : {
                  "mean_magnitude" : 0.05486662317369895,
                  "min" : -0.3337477336556598,
                  "max" : 0.3337477336556598
                }
              }
            ]
          },
          ...</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO20-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This object contains the baselines that are used to calculate the feature importance
decision paths in Kibana.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO20-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>This value is the average of the absolute feature importance values for the
<code class="literal">dayOfWeek</code> field across all the training data when the predicted class is
<code class="literal">false</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO20-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>This value is the minimum feature importance value across all the training data for
this field when the predicted class is <code class="literal">false</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO20-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>This value is the maximum feature importance value across all the training data for
this field when the predicted class is <code class="literal">false</code>.</p>
</td>
</tr>
</table>
</div>
<p>To see the top feature importance values for each prediction, search the destination
index. For example:</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET model-flight-delays-classification/_search</pre>
</div>
<div class="console_widget" data-snippet="snippets/54.console"></div>
<p>The snippet below shows an example of the feature importance details for a document in
the search results:</p>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">          ...
          "FlightDelay" : false,
          ...
          "ml" : {
            "FlightDelay_prediction" : false,
            ...
            "prediction_probability" : 0.9427605087816684,
            "prediction_score" : 0.3462468700158476,
            "feature_importance" : [
              {
                "feature_name" : "DistanceMiles",
                "classes" : [
                  {
                    "class_name" : false,
                    "importance" : -1.4766536146534828
                  },
                  {
                    "class_name" : true,
                    "importance" : 1.4766536146534828
                  }
                ]
              },
              {
                "feature_name" : "FlightTimeMin",
                "classes" : [
                  {
                    "class_name" : false,
                    "importance" : 1.0919201754729184
                  },
                  {
                    "class_name" : true,
                    "importance" : -1.0919201754729184
                  }
                ]
              },
              ...</pre>
</div>
<p>The sum of the feature importance values for each class in this data point approximates
the logarithm of its odds.</p>
</div>
</details>
<p>Lastly, Kibana provides a scatterplot matrix in the results. It has the same
functionality as the matrix that you saw in the job wizard. Its purpose is to
help you visualize and explore the relationships between the numeric fields and
the dependent variable.</p>
<h4><a id="flightdata-classification-evaluate"></a>Evaluating classification results<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h4>
<p>Though you can look at individual results and compare the predicted value
(<code class="literal">ml.FlightDelay_prediction</code>) to the actual value (<code class="literal">FlightDelay</code>), you
typically need to evaluate the success of your classification model as a
whole.</p>
<p>Kibana provides a <em>normalized confusion matrix</em> that contains the percentage of
occurrences where the analysis classified data points correctly with their
actual class and the percentage of occurrences where it misclassified them.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-evaluation.png" alt="Evaluation of a classification job in Kibana">
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>As the sample data may change when it is loaded into Kibana, the results of
the analysis can vary even if you use the same configuration as the example.
Therefore, use this information as a guideline for interpreting your own
results.</p>
</div>
</div>
<p>If you want to see the exact number of occurrences, select a quadrant in the
matrix. You can also use the <span class="strong strong"><strong>Training</strong></span> and <span class="strong strong"><strong>Testing</strong></span> filter options to refine
the contents of the matrix. Thus you can see how well the model performs on
previously unseen data. You can check how many documents are <code class="literal">true</code> in the
testing data, how many of them are identified correctly (<em>true positives</em>) and
how many of them are identified incorrectly as <code class="literal">false</code> (<em>false negatives</em>).</p>
<p>Likewise if you select other quadrants in the matrix, it shows the number of
documents that have the <code class="literal">false</code> class as their actual value in the testing data. The matrix shows the number of documents that are correctly identified as
<code class="literal">false</code> (<em>true negatives</em>) and the number of documents that are incorrectly
predicted as <code class="literal">true</code> (<em>false positives</em>). When you perform classification analysis on
your own data, it might take multiple iterations before you are satisfied with
the results and ready to deploy the model.</p>
<p>Kibana also provides the <em>receiver operating characteristic (ROC) curve</em> as part
of the model evaluation. The plot compares the true positive rate (y-axis) to
the false positive rate (x-axis) for each class; in this example, <code class="literal">true</code> and
<code class="literal">false</code>. From this plot, the area under the curve (AUC) value is computed. It
is a number between 0 and 1. The higher the AUC, the better the model is at
predicting the classes correctly.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/flights-classification-roc-curve.jpg" alt="Evaluation of a classification job in Kibana – ROC curve">
</div>
</div>
<p>You can also generate these metrics with the
<a href="/guide/en/elasticsearch/reference/master/evaluate-dfanalytics.html" class="ulink" target="_top">data frame analytics evaluate API</a>. For more
information about interpreting the evaluation metrics, see
<a class="xref" href="ml-dfa-classification.html#ml-dfanalytics-classification-evaluation" title="6. Evaluate and interpret the result">6. Evaluate and interpret the result</a>.</p>
<details>
<summary class="title">API example</summary>
<div class="content">
<p>First, we want to know the training error that represents how well the model
performed on the training data set.</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">POST _ml/data_frame/_evaluate
{
 "index": "model-flight-delays-classification",
   "query": {
    "term": {
      "ml.is_training": {
        "value": true  <a id="CO21-1"></a><i class="conum" data-value="1"></i>
      }
    }
  },
 "evaluation": {
   "classification": {
     "actual_field": "FlightDelay",
     "predicted_field": "ml.FlightDelay_prediction",
     "metrics": {
       "multiclass_confusion_matrix" : {}
     }
   }
 }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/55.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>We calculate the training error by evaluating only the training data.</p>
</td>
</tr>
</table>
</div>
<p>Next, we calculate the generalization error that represents how well the model
performed on previously unseen data:</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">POST _ml/data_frame/_evaluate
{
 "index": "model-flight-delays-classification",
   "query": {
    "term": {
      "ml.is_training": {
        "value": false  <a id="CO22-1"></a><i class="conum" data-value="1"></i>
      }
    }
  },
 "evaluation": {
   "classification": {
     "actual_field": "FlightDelay",
     "predicted_field": "ml.FlightDelay_prediction",
     "metrics": {
       "multiclass_confusion_matrix" : {}
     }
   }
 }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/56.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO22-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>We evaluate only the documents that are not part of the training data.</p>
</td>
</tr>
</table>
</div>
<p>The returned confusion matrix shows us how many data points were classified
correctly (where the <code class="literal">actual_class</code> matches the <code class="literal">predicted_class</code>) and how many
were misclassified (<code class="literal">actual_class</code> does not match <code class="literal">predicted_class</code>):</p>
<div class="pre_wrapper lang-console-result">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-result">{
  "classification" : {
    "multiclass_confusion_matrix" : {
      "confusion_matrix" : [
        {
          "actual_class" : "false", <a id="CO23-1"></a><i class="conum" data-value="1"></i>
          "actual_class_doc_count" : 8802, <a id="CO23-2"></a><i class="conum" data-value="2"></i>
          "predicted_classes" : [
            {
              "predicted_class" : "false", <a id="CO23-3"></a><i class="conum" data-value="3"></i>
              "count" : 7262 <a id="CO23-4"></a><i class="conum" data-value="4"></i>
            },
            {
              "predicted_class" : "true",
              "count" : 1540
            }
          ],
          "other_predicted_class_doc_count" : 0
        },
        {
          "actual_class" : "true",
          "actual_class_doc_count" : 2952,
          "predicted_classes" : [
            {
              "predicted_class" : "false",
              "count" : 794
            },
            {
              "predicted_class" : "true",
              "count" : 2158
            }
          ],
          "other_predicted_class_doc_count" : 0
        }
      ],
      "other_actual_class_count" : 0
    }
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO23-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the actual class. In this example, there are two actual classes:
<code class="literal">true</code> and <code class="literal">false</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO23-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The number of documents in the data set that belong to the actual class.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO23-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the predicted class.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO23-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The number of documents that belong to the actual class and are labeled as
the predicted class.</p>
</td>
</tr>
</table>
</div>
</div>
</details>
<p>If you don&#8217;t want to keep the data frame analytics job, you can delete it in Kibana or
by using the <a href="/guide/en/elasticsearch/reference/master/delete-dfanalytics.html" class="ulink" target="_top">delete data frame analytics job API</a>. When
you delete data frame analytics jobs in Kibana, you have the option to also remove the
destination indices and data views.</p>
<h4><a id="dfa-classification-readings"></a>Further readings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/stack-docs/edit/main/docs/en/stack/ml/df-analytics/ml-dfa-classification.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://github.com/elastic/examples/tree/master/Machine%20Learning/Analytics%20Jupyter%20Notebooks" class="ulink" target="_top">Classification analysis example (Jupyter notebook)</a>
</li>
<li class="listitem">
<a href="/blog/benchmarking-binary-classification-results-in-elastic-machine-learning" class="ulink" target="_top">Benchmarking binary classification results in Elastic machine learning</a>
</li>
<li class="listitem">
<a href="/blog/using-elastic-supervised-machine-learning-for-binary-classification" class="ulink" target="_top">Using Elastic supervised machine learning for binary classification</a>
</li>
<li class="listitem">
<a href="/blog/machine-learning-in-cybersecurity-training-supervised-models-to-detect-dga-activity" class="ulink" target="_top">Machine learning in cybersecurity – part 1: Training supervised models to detect DGA activity</a>
</li>
<li class="listitem">
<a href="/blog/machine-learning-in-cybersecurity-detecting-dga-activity-in-network-data" class="ulink" target="_top">Machine learning in cybersecurity – part 2: Detecting DGA activity in network data</a>
</li>
<li class="listitem">
<a href="/blog/supervised-and-unsupervised-machine-learning-for-dga-detection" class="ulink" target="_top">Combining supervised and unsupervised machine learning for DGA detection</a>
</li>
</ul>
</div>
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains('stemblock')) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</div><div class="navfooter">
<span class="prev">
<a href="ml-dfa-regression.html">« Predicting numerical values with regression</a>
</span>
<span class="next">
<a href="ml-dfa-concepts.html">Advanced concepts »</a>
</span>
</div>
</body>
</html>
