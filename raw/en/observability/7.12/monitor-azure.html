<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Monitor Microsoft Azure | Observability Guide [7.12] | Elastic</title>
<link rel="home" href="index.html" title="Observability Guide [7.12]"/>
<link rel="up" href="observability-tutorials.html" title="Tutorials"/>
<link rel="prev" href="monitor-kubernetes.html" title="Monitor Kubernetes: Observe the health and performance of your Kubernetes deployments"/>
<meta name="DC.type" content="Learn/Docs/Observability/Guide/7.12"/>
<meta name="DC.subject" content="Observability"/>
<meta name="DC.identifier" content="7.12"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Observability Guide [7.12]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="observability-tutorials.html">Tutorials</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="monitor-kubernetes.html">« Monitor Kubernetes: Observe the health and performance of your Kubernetes deployments</a>
</span>
<span class="next">
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="monitor-azure"></a>Monitor Microsoft Azure<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h2>
</div></div></div>
<p>In this tutorial, you&#8217;ll learn how to monitor your Microsoft Azure deployments
using Elastic Observability: Logs and Metrics.</p>
<h3><a id="azure-what-you-learn"></a>What you&#8217;ll learn<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h3>
<p>You&#8217;ll learn how to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Set up an Azure service principal.
</li>
<li class="listitem">
Ingest metrics using the <a href="/guide/en/beats/metricbeat/7.12/metricbeat-module-azure.html" class="ulink" target="_top">Metricbeat
Azure module</a> and view those metrics in Kibana.
</li>
<li class="listitem">
Export Azure activity logs through Event Hubs.
</li>
<li class="listitem">
Ingest logs using the <a href="/guide/en/beats/filebeat/7.12/filebeat-module-azure.html" class="ulink" target="_top">Filebeat
Azure module</a> and view those logs in Kibana.
</li>
</ul>
</div>
<h3><a id="azure-before-you-begin"></a>Before you begin<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h3>
<p>Create a deployment using our hosted Elasticsearch Service on <a href="/cloud/elasticsearch-service/signup?baymax=docs-body&amp;elektra=docs" class="ulink" target="_top">Elastic Cloud</a>.
The deployment includes an Elasticsearch cluster for storing and searching your data,
and Kibana for visualizing and managing your data.
For more information, see <a class="xref" href="add-observability-data.html#spin-up-stack" title="Spin up the Elastic Stack">Spin up the Elastic Stack</a>.</p>
<h3><a id="azure-step-one"></a>Step 1: Create an Azure service principal and set permissions<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h3>
<p>The <a href="https://docs.microsoft.com/en-us/rest/api/monitor/" class="ulink" target="_top">Azure Monitor REST API</a>
allows you to get insights into your Azure resources using different operations.
To access the Azure Monitor REST API you need to use the Azure Resource Manager
authentication model. Therefore, all requests must be authenticated with Azure
Active Directory (Azure AD).
You can create the service principal using the <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal" class="ulink" target="_top">Azure portal</a>
or <a href="https://docs.microsoft.com/en-us/powershell/azure/create-azure-service-principal-azureps?view=azps-2.7.0" class="ulink" target="_top">Azure PowerShell</a>.
Then, you need to grant access permission, which is detailed <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles" class="ulink" target="_top">here</a>.
This tutorial uses the Azure portal.</p>
<h4><a id="_create_an_azure_service_principal"></a>Create an Azure service principal<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h4>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Go to the <a href="https://portal.azure.com/" class="ulink" target="_top">Azure Management Portal</a>. Search and click
on <span class="strong strong"><strong>Azure Active Directory</strong></span>.</p>
<p><span class="image"><img src="monitor-azure-search-active-directory.png" alt="Search and click on Azure Active Directory"></span></p>
</li>
<li class="listitem">
<p>Click on <span class="strong strong"><strong>App registrations</strong></span> in the navigation pane of the selected Active
Directory and then click on <span class="strong strong"><strong>New registration</strong></span>.</p>
<p><span class="image"><img src="monitor-azure-click-app-registration.png" alt="Click on App registrations"></span></p>
</li>
<li class="listitem">
<p>Type the name of your application (this tutorial uses <code class="literal">monitor-azure</code>) and
click on <span class="strong strong"><strong>Register</strong></span> (leave all the other options with the default value).</p>
<p><span class="image"><img src="monitor-azure-register-app.png" alt="Register an application"></span></p>
<p>Copy the <span class="strong strong"><strong>Application (client) ID</strong></span>, and save it for future reference.
This id is required to configure Metricbeat to connect to your Azure account.</p>
</li>
<li class="listitem">
<p>Click on <span class="strong strong"><strong>Certificates &amp; secrets</strong></span>. Then, click on <span class="strong strong"><strong>New client secret</strong></span> to
create a new security key.</p>
<p><span class="image"><img src="monitor-azure-click-client-secret.png" alt="Click on new client secret"></span></p>
</li>
<li class="listitem">
<p>Type a key description and select a key duration in the expire list.
Click on <span class="strong strong"><strong>Add</strong></span> to create a client secret. The next page will display the key
value under the <span class="strong strong"><strong>Value</strong></span> field. Copy the secret and save it (along with your
Client ID) for future reference.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>This is your only chance to copy this value. You can&#8217;t retrieve the
key value after you leave the page.</p>
</div>
</div>
</li>
</ol>
</div>
<h4><a id="_grant_access_permission_for_your_service_principal"></a>Grant access permission for your service principal<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h4>
<p>After creating the Azure service principal you need to grant it the correct
permission. You need <code class="literal">Reader</code> permission to configure Metricbeat to monitor
your services.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>On Azure Portal, search and click on <span class="strong strong"><strong>Subscriptions</strong></span>.</p>
<p><span class="image"><img src="monitor-azure-search-subscriptions.png" alt="Search and click on Subscriptions"></span></p>
</li>
<li class="listitem">
In the Subscriptions page, click on your subscription.
</li>
<li class="listitem">
Click on <span class="strong strong"><strong>Access control (IAM)</strong></span> in the subscription navigation pane.
</li>
<li class="listitem">
Click on <span class="strong strong"><strong>Add</strong></span> and select <span class="strong strong"><strong>Add role assignment</strong></span>.
</li>
<li class="listitem">
Select the <span class="strong strong"><strong>Reader</strong></span> role.
</li>
<li class="listitem">
<p>In the <span class="strong strong"><strong>Select</strong></span> field, type the description name of the configured service
principal (<code class="literal">monitor-azure</code>).</p>
<p><span class="image"><img src="monitor-azure-add-role-assignment.png" alt="Add role assignment"></span></p>
</li>
<li class="listitem">
Select the application and click on save to grant the service principal
access to your subscription.
</li>
</ol>
</div>
<h3><a id="azure-step-two"></a>Step 2: Install and configure Metricbeat<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h3>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This tutorial assumes the Elastic cluster is already running. Make sure you
have your <span class="strong strong"><strong>cloud ID</strong></span> and your <span class="strong strong"><strong>credentials</strong></span> on hand.</p>
</div>
</div>
<p>To monitor Microsoft Azure using the Elastic Stack, you need two main components:
an Elastic deployment to store and analyze the data and an agent to collect
and ship the data.</p>
<p>Two agents can be used to monitor Azure: Metricbeat is used to
monitor metrics, and Filebeat to monitor logs. You can run the agents on any
machine. This tutorial uses a small Azure instance, <span class="strong strong"><strong>B2s</strong></span> (2 vCPUs,
4 GB memory), with an Ubuntu distribution.</p>
<h4><a id="_install_metricbeat_3"></a>Install Metricbeat<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/shared/install-configure-metricbeat.asciidoc">edit</a></h4>
<p>Download and install Metricbeat.</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Install-m">
    <button role="tab"
            aria-selected="true"
            aria-controls="deb-tab-install-metricbeat"
            id="deb-install-metricbeat">
      DEB
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="rpm-tab-install-metricbeat"
            id="rpm-install-metricbeat"
            tabindex="-1">
      RPM
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="mac-tab-install-metricbeat"
            id="mac-install-metricbeat"
            tabindex="-1">
      MacOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="brew-tab-install-metricbeat"
            id="brew-install-metricbeat"
            tabindex="-1">
      Brew
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-install-metricbeat"
            id="linux-install-metricbeat"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-install-metricbeat"
            id="win-install-metricbeat"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="deb-tab-install-metricbeat"
       aria-labelledby="deb-install-metricbeat">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-7.12.1-amd64.deb
sudo dpkg -i metricbeat-7.12.1-amd64.deb</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="rpm-tab-install-metricbeat"
       aria-labelledby="rpm-install-metricbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-7.12.1-x86_64.rpm
sudo rpm -vi metricbeat-7.12.1-x86_64.rpm</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-install-metricbeat"
       aria-labelledby="mac-install-metricbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-7.12.1-darwin-x86_64.tar.gz
tar xzvf metricbeat-7.12.1-darwin-x86_64.tar.gz</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="brew-tab-install-metricbeat"
       aria-labelledby="brew-install-metricbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">brew tap elastic/tap
brew install elastic/tap/metricbeat-full</pre>
</div>
<p>This command installs the most recently released default distribution of
Metricbeat. To install the OSS distribution, specify
<code class="literal">elastic/tap/metricbeat-oss</code>.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-install-metricbeat"
       aria-labelledby="linux-install-metricbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-7.12.1-linux-x86_64.tar.gz
tar xzvf metricbeat-7.12.1-linux-x86_64.tar.gz</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-install-metricbeat"
       aria-labelledby="win-install-metricbeat"
       hidden="">
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Download the Metricbeat Windows zip file from the
<a href="/downloads/beats/metricbeat" class="ulink" target="_top">downloads page</a>.
</li>
<li class="listitem">
Extract the contents of the zip file into <code class="literal">C:\Program Files</code>.
</li>
<li class="listitem">
Rename the <code class="literal">metricbeat-&lt;version&gt;-windows</code> directory to <code class="literal">Metricbeat</code>.
</li>
<li class="listitem">
Open a PowerShell prompt as an Administrator (right-click the PowerShell icon
and select <span class="strong strong"><strong>Run As Administrator</strong></span>).
</li>
<li class="listitem">
<p>From the PowerShell prompt, run the following commands to install
Metricbeat as a Windows service:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">PS &gt; cd 'C:\Program Files\Metricbeat'
PS C:\Program Files\Metricbeat&gt; .\install-service-metricbeat.ps1</pre>
</div>
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If script execution is disabled on your system, you need to set the
execution policy for the current session to allow the script to run. For
example:
<code class="literal">PowerShell.exe -ExecutionPolicy UnRestricted -File .\install-service-metricbeat.ps1</code>.</p>
</div>
</div>
  </div>
</div>
<h4><a id="_set_up_assets_5"></a>Set up assets<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/shared/install-configure-metricbeat.asciidoc">edit</a></h4>
<p>Metricbeat comes with predefined assets for parsing, indexing, and visualizing your data.
Run the following command to load these assets. It may take a few minutes.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat setup -e -E 'cloud.id=YOUR_DEPLOYMENT_CLOUD_ID' -E 'cloud.auth=elastic:YOUR_SUPER_SECRET_PASS' <a id="CO56-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO56-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Substitute your Cloud ID and an administrator&#8217;s <code class="literal">username:password</code> in this command.
To find your Cloud ID, click on your <a href="https://cloud.elastic.co/deployments" class="ulink" target="_top">deployment</a>.</p>
</td>
</tr>
</table>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Setting up Metricbeat is an admin-level task that requires extra privileges.
As a best practice, <a href="/guide/en/beats/metricbeat/7.12/privileges-to-setup-beats.html" class="ulink" target="_top">use an administrator role to set up</a>,
and a more restrictive role for event publishing (which you will do next).</p>
</div>
</div>
<h4><a id="_configure_metricbeat_output_3"></a>Configure Metricbeat output<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/shared/install-configure-metricbeat.asciidoc">edit</a></h4>
<p>Next, you are going to configure Metricbeat output to Elasticsearch Service.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Use the Metricbeat keystore to store <a href="/guide/en/beats/metricbeat/7.12/keystore.html" class="ulink" target="_top">secure settings</a>.
Store the Cloud ID in the keystore.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat keystore create
echo -n "&lt;Your Deployment Cloud ID&gt;" | ./metricbeat keystore add CLOUD_ID --stdin</pre>
</div>
</li>
<li class="listitem">
<p>To store metrics in Elasticsearch with minimal permissions, create an API key to send
data from Metricbeat to Elasticsearch Service. Log into Kibana (you can do so from the Cloud
Console without typing in any permissions) and select <span class="strong strong"><strong>Management</strong></span> &#8594; <span class="strong strong"><strong>Dev
Tools</strong></span>. Send the following request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/api_key
{
  "name": "metricbeat-monitor",
  "role_descriptors": {
    "metricbeat_writer": {
      "cluster": ["monitor", "read_ilm"],
      "index": [
        {
          "names": ["metricbeat-*"],
          "privileges": ["view_index_metadata", "create_doc"]
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/14.console"></div>
</li>
<li class="listitem">
<p>The response contains an <code class="literal">api_key</code> and an <code class="literal">id</code> field, which can be stored in
the Metricbeat keystore in the following format: <code class="literal">id:api_key</code>.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">echo -n "IhrJJHMB4JmIUAPLuM35:1GbfxhkMT8COBB4JWY3pvQ" | ./metricbeat keystore add ES_API_KEY --stdin</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure you specify the <code class="literal">-n</code> parameter; otherwise, you will have
painful debugging sessions due to adding a newline at the end of
your API key.</p>
</div>
</div>
</li>
<li class="listitem">
<p>To see if both settings have been stored, run the following command:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat keystore list</pre>
</div>
</li>
<li class="listitem">
<p>To configure Metricbeat to output to Elasticsearch Service, edit the <code class="literal">metricbeat.yml</code>
configuration file. Add the following lines to the end of the file.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">cloud.id: ${CLOUD_ID}
output.elasticsearch:
  api_key: ${ES_API_KEY}</pre>
</div>
</li>
<li class="listitem">
<p>Finally, test if the configuration is working. If it is not working,
verify if you used the right credentials and add them again.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat test output</pre>
</div>
</li>
</ol>
</div>
<p>Now that the output is working, you are going to set up the input (Azure).</p>
<h3><a id="azure-step-three"></a>Step 3: Configure Metricbeat Azure module<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h3>
<p>To collect metrics from Microsoft Azure, use the
<a href="/guide/en/beats/metricbeat/7.12/metricbeat-module-azure.html" class="ulink" target="_top">Metricbeat Azure module</a>.
This module periodically fetches monitoring metrics from Microsoft Azure using
the <a href="https://docs.microsoft.com/en-us/rest/api/monitor/" class="ulink" target="_top">Azure Monitor REST API</a>.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Extra Azure charges on metric queries my be generated by this module.
Please see <a href="/guide/en/beats/metricbeat/7.12/metricbeat-module-azure.html#azure-api-cost" class="ulink" target="_top">additional
notes about metrics and costs</a> for more details.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>The azure module configuration needs three ids and one secret. Use the
commands below to store each one of them in the keystore.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">echo -n "&lt;client_id&gt;" | ./metricbeat keystore add AZURE_CLIENT_ID --stdin
echo -n "&lt;client_secret&gt;" | ./metricbeat keystore add AZURE_CLIENT_SECRET --stdin
echo -n "&lt;tenant_id&gt;" | ./metricbeat keystore add AZURE_TENANT_ID --stdin
echo -n "&lt;subscription_id&gt;" | ./metricbeat keystore add AZURE_SUBSCRIPTION_ID --stdin</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can find the <code class="literal">tenant_id</code> in the main Azure Active Directory page.
You can find the <code class="literal">subscription_id</code> in the main Subscriptions page.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Enable the Azure module.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat modules enable azure</pre>
</div>
</li>
<li class="listitem">
<p>Edit the <code class="literal">modules.d/azure.yml</code> file to collect <code class="literal">compute_vms</code> metrics.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">- module: azure
  metricsets:
  - compute_vm  <a id="CO57-1"></a><i class="conum" data-value="1"></i>
  enabled: true
  period: 300s  <a id="CO57-2"></a><i class="conum" data-value="2"></i>
  client_id: '${AZURE_CLIENT_ID:""}'  <a id="CO57-3"></a><i class="conum" data-value="3"></i>
  client_secret: '${AZURE_CLIENT_SECRET:""}'  <a id="CO57-4"></a><i class="conum" data-value="4"></i>
  tenant_id: '${AZURE_TENANT_ID:""}'  <a id="CO57-5"></a><i class="conum" data-value="5"></i>
  subscription_id: '${AZURE_SUBSCRIPTION_ID:""}'  <a id="CO57-6"></a><i class="conum" data-value="6"></i>
  refresh_list_interval: 600s</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO57-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">compute_vm</code> metricset is a predefined metricset that collects metrics
from the virtual machines.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO57-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Collects metrics every 5 minutes. The period for <code class="literal">compute_vm</code> metricset
should be 300s or multiples of 300s.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO57-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The unique identifier for the application (also known as Application ID,
which you copied earlier).</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO57-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The client/application secret/key (copied earlier).</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO57-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>The unique identifier of the Azure Active Directory instance.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO57-6"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>The unique identifier for the azure subscription.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>To check if Metricbeat can collect data, test the input by running the
following command:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat test modules azure</pre>
</div>
<p>Metricbeat will print <code class="literal">compute_vms</code> metrics to the terminal, if the setup is
correct.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If it returns a timeout error, try again. The <code class="literal">test modules</code> timeout is short.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Edit the <code class="literal">modules.d/azure.yml</code> file to also collect <code class="literal">billing</code> metrics.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">- module: azure
  metricsets:
  - billing  <a id="CO58-1"></a><i class="conum" data-value="1"></i>
  enabled: true
  period: 24h  <a id="CO58-2"></a><i class="conum" data-value="2"></i>
  client_id: '${AZURE_CLIENT_ID:""}'
  client_secret: '${AZURE_CLIENT_SECRET:""}'
  tenant_id: '${AZURE_TENANT_ID:""}'
  subscription_id: '${AZURE_SUBSCRIPTION_ID:""}'
  refresh_list_interval: 600s</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO58-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">billing</code> metricset is a predefined metricset that collects relevant
usage data and forecast information of the subscription configured.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO58-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Collects metrics every 24 hours. The period for <code class="literal">billing</code> metricset
should be 24h or multiples of 24h.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>When the input and output are ready, start Metricbeat to collect the data.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat -e</pre>
</div>
</li>
<li class="listitem">
<p>Finally, log into Kibana and open the <span class="strong strong"><strong>[Metricbeat Azure] Compute VMs
Overview</strong></span> dashboard.</p>
<p><span class="image"><img src="monitor-azure-compute-vms-overview-dashboard.png" alt="Metricbeat azure compute vms overview dashboard"></span></p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <span class="strong strong"><strong>VM Available Memory</strong></span> visualization might be empty if you only have Linux
VMs as discussed <a href="https://github.com/elastic/beats/issues/20289" class="ulink" target="_top">here</a>.</p>
</div>
</div>
<p>You can also check the <span class="strong strong"><strong>[Metricbeat Azure] Billing overview</strong></span> dashboard, even
though it might take longer to collect data.</p>
<p><span class="image"><img src="monitor-azure-billing-overview-dashboard.png" alt="Metricbeat azure compute vms overview dashboard"></span></p>
</li>
</ol>
</div>
<h3><a id="azure-step-four"></a>Step 4: Install and configure Filebeat<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h3>
<p>Now that Metricbeat is up and running, configure Filebeat to collect Azure
logs.</p>
<h4><a id="_install_filebeat_3"></a>Install Filebeat<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/shared/install-configure-filebeat.asciidoc">edit</a></h4>
<p>Download and install Filebeat.</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Install-f">
    <button role="tab"
            aria-selected="true"
            aria-controls="deb-tab-install-filebeat"
            id="deb-install-filebeat">
      DEB
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="rpm-tab-install-filebeat"
            id="rpm-install-filebeat"
            tabindex="-1">
      RPM
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="mac-tab-install-filebeat"
            id="mac-install-filebeat"
            tabindex="-1">
      MacOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="brew-tab-install-filebeat"
            id="brew-install-filebeat"
            tabindex="-1">
      Brew
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-install-filebeat"
            id="linux-install-filebeat"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-install-filebeat"
            id="win-install-filebeat"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="deb-tab-install-filebeat"
       aria-labelledby="deb-install-filebeat">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.12.1-amd64.deb
sudo dpkg -i filebeat-7.12.1-amd64.deb</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="rpm-tab-install-filebeat"
       aria-labelledby="rpm-install-filebeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.12.1-x86_64.rpm
sudo rpm -vi filebeat-7.12.1-x86_64.rpm</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-install-filebeat"
       aria-labelledby="mac-install-filebeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.12.1-darwin-x86_64.tar.gz
tar xzvf filebeat-7.12.1-darwin-x86_64.tar.gz</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="brew-tab-install-filebeat"
       aria-labelledby="brew-install-filebeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">brew tap elastic/tap
brew install elastic/tap/filebeat-full</pre>
</div>
<p>This command installs the most recently released default distribution of
Filebeat. To install the OSS distribution, specify
<code class="literal">elastic/tap/filebeat-oss</code>.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-install-filebeat"
       aria-labelledby="linux-install-filebeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.12.1-linux-x86_64.tar.gz
tar xzvf filebeat-7.12.1-linux-x86_64.tar.gz</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-install-filebeat"
       aria-labelledby="win-install-filebeat"
       hidden="">
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Download the Filebeat Windows zip file from the
<a href="/downloads/beats/filebeat" class="ulink" target="_top">downloads page</a>.
</li>
<li class="listitem">
Extract the contents of the zip file into <code class="literal">C:\Program Files</code>.
</li>
<li class="listitem">
Rename the <code class="literal">filebeat-&lt;version&gt;-windows</code> directory to <code class="literal">Filebeat</code>.
</li>
<li class="listitem">
Open a PowerShell prompt as an Administrator (right-click the PowerShell icon
and select <span class="strong strong"><strong>Run As Administrator</strong></span>).
</li>
<li class="listitem">
<p>From the PowerShell prompt, run the following commands to install
Filebeat as a Windows service:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">PS &gt; cd 'C:\Program Files\Filebeat'
PS C:\Program Files\Filebeat&gt; .\install-service-filebeat.ps1</pre>
</div>
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If script execution is disabled on your system, you need to set the
execution policy for the current session to allow the script to run. For
example:
<code class="literal">PowerShell.exe -ExecutionPolicy UnRestricted -File .\install-service-filebeat.ps1</code>.</p>
</div>
</div>
  </div>
</div>
<h4><a id="_set_up_assets_6"></a>Set up assets<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/shared/install-configure-filebeat.asciidoc">edit</a></h4>
<p>Filebeat comes with predefined assets for parsing, indexing, and visualizing your data.
Run the following command to load these assets. It may take a few minutes.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat setup -e -E 'cloud.id=YOUR_DEPLOYMENT_CLOUD_ID' -E 'cloud.auth=elastic:YOUR_SUPER_SECRET_PASS' <a id="CO59-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO59-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Substitute your Cloud ID and an administrator&#8217;s <code class="literal">username:password</code> in this command.
To find your Cloud ID, click on your <a href="https://cloud.elastic.co/deployments" class="ulink" target="_top">deployment</a>.</p>
</td>
</tr>
</table>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Setting up Filebeat is an admin-level task that requires extra privileges.
As a best practice, <a href="/guide/en/beats/filebeat/7.12/privileges-to-setup-beats.html" class="ulink" target="_top">use an administrator role to set up</a>
and a more restrictive role for event publishing (which you will do next).</p>
</div>
</div>
<h4><a id="_configure_filebeat_output_3"></a>Configure Filebeat output<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/shared/install-configure-filebeat.asciidoc">edit</a></h4>
<p>Next, you are going to configure Filebeat output to Elasticsearch Service.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Use the Filebeat keystore to store <a href="/guide/en/beats/filebeat/7.12/keystore.html" class="ulink" target="_top">secure settings</a>.
Store the Cloud ID in the keystore.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat keystore create
echo -n "&lt;Your Deployment Cloud ID&gt;" | ./filebeat keystore add CLOUD_ID --stdin</pre>
</div>
</li>
<li class="listitem">
<p>To store logs in Elasticsearch with minimal permissions, create an API key to send
data from Filebeat to Elasticsearch Service. Log into Kibana (you can do so from the Cloud
Console without typing in any permissions) and select <span class="strong strong"><strong>Management</strong></span> &#8594; <span class="strong strong"><strong>Dev
Tools</strong></span>. Send the following request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/api_key
{
  "name": "filebeat-monitor-gcp",
  "role_descriptors": {
    "filebeat_writer": {
      "cluster": [
        "monitor",
        "read_ilm",
        "cluster:admin/ingest/pipeline/get", <a id="CO60-1"></a><i class="conum" data-value="1"></i>
        "cluster:admin/ingest/pipeline/put" <a id="CO60-2"></a><i class="conum" data-value="1"></i>
      ],
      "index": [
        {
          "names": ["filebeat-*"],
          "privileges": ["view_index_metadata", "create_doc"]
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/15.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO60-1"><i class="conum" data-value="1"></i></a><a href="#CO60-2"></a></p>
</td>
<td align="left" valign="top">
<p>Filebeat needs extra cluster permissions to publish logs, which differs
from the Metricbeat configuration. You can find more
details <a href="/guide/en/beats/filebeat/7.12/feature-roles.html" class="ulink" target="_top">here</a>.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>The response contains an <code class="literal">api_key</code> and an <code class="literal">id</code> field, which can be stored in
the Filebeat keystore in the following format: <code class="literal">id:api_key</code>.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">echo -n "IhrJJHMB4JmIUAPLuM35:1GbfxhkMT8COBB4JWY3pvQ" | ./filebeat keystore add ES_API_KEY --stdin</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure you specify the <code class="literal">-n</code> parameter; otherwise, you will have
painful debugging sessions due to adding a newline at the end of
your API key.</p>
</div>
</div>
</li>
<li class="listitem">
<p>To see if both settings have been stored, run the following command:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat keystore list</pre>
</div>
</li>
<li class="listitem">
<p>To configure Filebeat to output to Elasticsearch Service, edit the <code class="literal">filebeat.yml</code>
configuration file. Add the following lines to the end of the file.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">cloud.id: ${CLOUD_ID}
output.elasticsearch:
  api_key: ${ES_API_KEY}</pre>
</div>
</li>
<li class="listitem">
<p>Finally, test if the configuration is working. If it is not working,
verify that you used the right credentials and, if necessary, add them again.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat test output</pre>
</div>
</li>
</ol>
</div>
<p>Now that the output is working, you are going to set up the input (Azure).</p>
<h3><a id="azure-step-five"></a>Step 5: Create an event hub and configure diagnostics settings<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h3>
<p>To collect logs from Microsoft Azure, use the
<a href="/guide/en/beats/filebeat/7.12/filebeat-module-azure.html" class="ulink" target="_top">Filebeat Azure module</a>.
This module periodically fetches logs that have been forwarded to an Azure event
hub.
There are four available filesets: <code class="literal">activitylogs</code>, <code class="literal">platformlogs</code>, <code class="literal">signinlogs</code>,
and <code class="literal">auditlogs</code>. This tutorial covers the <code class="literal">activitylogs</code> fileset.</p>
<h4><a id="_create_event_hubs_namespace"></a>Create Event Hubs namespace<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h4>
<p>You have different options to create an event hub, such as
<a href="https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-create" class="ulink" target="_top">Azure portal</a>
or <a href="https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-quickstart-powershell" class="ulink" target="_top">PowerShell</a>.
This tutorial uses PowerShell.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Open the Azure PowerShell:</p>
<div class="imageblock">
<div class="content">
<img src="monitor-azure-open-powershell.png" alt="Open the Azure PowerShell">
</div>
</div>
</li>
<li class="listitem">
<p>Run the following command to create an Event Hub namespace:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">New-AzEventHubNamespace -ResourceGroupName monitor-azure-resource-group `
  -NamespaceName monitor-azure-namespace `
  -Location northeurope</pre>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can only stream logs to event hubs in the same region. Make sure to choose
an appropriate region.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Create an event hub:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">New-AzEventHub -ResourceGroupName monitor-azure-resource-group `
  -NamespaceName monitor-azure-namespace `
  -EventHubName monitor-azure-event-hub `
  -MessageRetentionInDays 3 `</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Adjust the <code class="literal">-MessageRetentionInDays</code> value to your needs. This tutorial uses the
default value suggested in the Azure quick start.</p>
</div>
</div>
</li>
</ol>
</div>
<h4><a id="_configure_activity_logs_to_stream_to_the_event_hub"></a>Configure activity logs to stream to the event hub<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h4>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Navigate to <span class="strong strong"><strong>Activity log</strong></span>.</p>
<div class="imageblock">
<div class="content">
<img src="monitor-azure-search-activity-log.png" alt="Navigate to Activity log">
</div>
</div>
</li>
<li class="listitem">
<p>Click on <span class="strong strong"><strong>Diagnostics settings</strong></span>.</p>
<div class="imageblock">
<div class="content">
<img src="monitor-azure-click-diagnostics-settings.png" alt="Click on diagnostics settings">
</div>
</div>
</li>
<li class="listitem">
Click on <span class="strong strong"><strong>Add diagnostic setting</strong></span>.
</li>
<li class="listitem">
<p>Configure it and click on <span class="strong strong"><strong>Save</strong></span>.</p>
<div class="imageblock">
<div class="content">
<img src="monitor-azure-configure-diagnostics-settings.png" alt="Configure on diagnostics settings">
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Select the log categories that you want.
Select stream to an event hub and make sure to configure the correct namespace
event hub.</p>
</div>
</div>
</li>
</ol>
</div>
<h3><a id="azure-step-six"></a>Step 6: Configure Filebeat Azure module<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h3>
<p>There are 2 configuration values that you need to get from the Azure portal:
<code class="literal">connection_string</code> and <code class="literal">storage_account_key</code>.</p>
<h4><a id="_add_the_connection_string_to_the_keystore"></a>Add the <code class="literal">connection_string</code> to the keystore<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h4>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Navigate to Event Hubs.</p>
<div class="imageblock">
<div class="content">
<img src="monitor-azure-search-event-hubs.png" alt="Search event hubs">
</div>
</div>
</li>
<li class="listitem">
Click on the created namespace (<code class="literal">monitor-azure-namespace</code>).
</li>
<li class="listitem">
Click on shared policies and then on the <code class="literal">RootManageSharedAccessKey</code> policy.
</li>
<li class="listitem">
<p>Copy the <code class="literal">Connection string–primary key</code> value and add it to the <code class="literal">keystore</code>.</p>
<div class="imageblock">
<div class="content">
<img src="monitor-azure-click-policy.png" alt="Click on policy">
</div>
</div>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">echo -n "&lt;Your Connection string-primary key&gt;" | ./filebeat keystore add AZURE_CONNECTION_STRING --stdin</pre>
</div>
</li>
</ol>
</div>
<h4><a id="_add_storage_account_key_to_the_keystore"></a>Add <code class="literal">storage_account_key</code> to the keystore<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h4>
<p>A Blob Storage account is required in order to store/retrieve/update the offset
or state of the eventhub messages. This means that after stopping the Filebeat
azure module it can start back up at the spot that it stopped processing
messages.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create a storage account. (You can also use an existing one.)</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">New-AzStorageAccount -ResourceGroupName monitor-azure-resource-group `
  -Name monitorazurestorage `
  -Location northeurope `
  -SkuName Standard_ZRS `
  -Kind StorageV2</pre>
</div>
</li>
<li class="listitem">
<p>Navigate to Storage accounts.</p>
<div class="imageblock">
<div class="content">
<img src="monitor-azure-search-storage-accounts.png" alt="Search storage accounts">
</div>
</div>
</li>
<li class="listitem">
<p>Click on the created storage account and then on <span class="strong strong"><strong>Access keys</strong></span>.</p>
<div class="imageblock">
<div class="content">
<img src="monitor-azure-click-access-keys.png" alt="Click on access keys">
</div>
</div>
</li>
<li class="listitem">
<p>Click on <span class="strong strong"><strong>Show keys</strong></span> and copy one of the keys.</p>
<div class="imageblock">
<div class="content">
<img src="monitor-azure-click-view-keys.png" alt="Click on view keys">
</div>
</div>
</li>
<li class="listitem">
<p>Add the <code class="literal">storage_account_key</code> to the <code class="literal">keystore</code>.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">echo -n "&lt;Your Storage account key&gt;" | ./filebeat keystore add AZURE_STORAGE_KEY --stdin</pre>
</div>
</li>
</ol>
</div>
<h4><a id="_configure_filebeat_azure_module"></a>Configure Filebeat Azure module<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/7.12/docs/en/observability/monitor-azure.asciidoc">edit</a></h4>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Enable the Filebeat Azure module.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat modules enable azure</pre>
</div>
</li>
<li class="listitem">
<p>Edit the <code class="literal">modules.d/azure.yml</code> file with the following configurations.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">- module: azure
  # All logs
  activitylogs:
    enabled: true
    var:
      eventhub: "monitor-azure-event-hub"  <a id="CO61-1"></a><i class="conum" data-value="1"></i>
      consumer_group: "$Default"  <a id="CO61-2"></a><i class="conum" data-value="2"></i>
      connection_string: "${AZURE_CONNECTION_STRING}"  <a id="CO61-3"></a><i class="conum" data-value="3"></i>
      storage_account: "monitorazurestorage"  <a id="CO61-4"></a><i class="conum" data-value="4"></i>
      storage_account_key: "${AZURE_STORAGE_KEY}"  <a id="CO61-5"></a><i class="conum" data-value="5"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO61-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Collects logs from the <code class="literal">monitor-azure-event-hub</code> event hub.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO61-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Uses the default consumer group.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO61-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Connects using the configured connection string.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO61-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>Persists the state of the eventhub messages to the <code class="literal">monitorazurestorage</code>
storage account.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO61-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>Uses the configured key to authenticate to the storage account.</p>
</td>
</tr>
</table>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>You cannot remove any of the other filesets from the configuration file.
You must have them in the config file and disabled.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Start Filebeat to collect the logs.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat -e</pre>
</div>
</li>
<li class="listitem">
<p>Finally, log into Kibana and open the <span class="strong strong"><strong>[Filebeat Azure] Cloud Overview</strong></span>
dashboard.</p>
<div class="imageblock">
<div class="content">
<img src="monitor-azure-cloud-overview-dashboard.png" alt="Filebeat azure cloud overview dashboard">
</div>
</div>
</li>
</ol>
</div>
<style>
.tabs {
  width: 100%;
}
[role="tablist"] {
  margin: 0 0 -0.1em;
  overflow: visible;
}
[role="tab"] {
  position: relative;
  padding: 0.3em 0.5em 0.4em;
  border: 1px solid hsl(219, 1%, 72%);
  border-radius: 0.2em 0.2em 0 0;
  overflow: visible;
  font-family: inherit;
  font-size: inherit;
  background: hsl(220, 20%, 94%);
}
[role="tab"]:hover::before,
[role="tab"]:focus::before,
[role="tab"][aria-selected="true"]::before {
  position: absolute;
  bottom: 100%;
  right: -1px;
  left: -1px;
  border-radius: 0.2em 0.2em 0 0;
  border-top: 3px solid hsl(219, 1%, 72%);
  content: '';
}
[role="tab"][aria-selected="true"] {
  border-radius: 0;
  background: hsl(220, 43%, 99%);
  outline: 0;
}
[role="tab"][aria-selected="true"]:not(:focus):not(:hover)::before {
  border-top: 5px solid hsl(218, 96%, 48%);
}
[role="tab"][aria-selected="true"]::after {
  position: absolute;
  z-index: 3;
  bottom: -1px;
  right: 0;
  left: 0;
  height: 0.3em;
  background: hsl(220, 43%, 99%);
  box-shadow: none;
  content: '';
}
[role="tab"]:hover,
[role="tab"]:focus,
[role="tab"]:active {
  outline: 0;
  border-radius: 0;
  color: inherit;
}
[role="tab"]:hover::before,
[role="tab"]:focus::before {
  border-color: hsl(218, 96%, 48%);
}
[role="tabpanel"] {
  position: relative;
  z-index: 2;
  padding: 1em;
  border: 1px solid hsl(219, 1%, 72%);
  border-radius: 0 0.2em 0.2em 0.2em;
  box-shadow: 0 0 0.2em hsl(219, 1%, 72%);
  background: hsl(220, 43%, 99%);
  margin-bottom: 1em;
}
[role="tabpanel"] p {
  margin: 0;
}
[role="tabpanel"] * + p {
  margin-top: 1em;
}
</style>

<script>
window.addEventListener("DOMContentLoaded", () => {
  const tabs = document.querySelectorAll('[role="tab"]');
  const tabList = document.querySelector('[role="tablist"]');
  // Add a click event handler to each tab
  tabs.forEach(tab => {
    tab.addEventListener("click", changeTabs);
  });
  // Enable arrow navigation between tabs in the tab list
  let tabFocus = 0;
  tabList.addEventListener("keydown", e => {
    // Move right
    if (e.keyCode === 39 || e.keyCode === 37) {
      tabs[tabFocus].setAttribute("tabindex", -1);
      if (e.keyCode === 39) {
        tabFocus++;
        // If we're at the end, go to the start
        if (tabFocus >= tabs.length) {
          tabFocus = 0;
        }
        // Move left
      } else if (e.keyCode === 37) {
        tabFocus--;
        // If we're at the start, move to the end
        if (tabFocus < 0) {
          tabFocus = tabs.length - 1;
        }
      }
      tabs[tabFocus].setAttribute("tabindex", 0);
      tabs[tabFocus].focus();
    }
  });
});

function setActiveTab(target) {
  const parent = target.parentNode;
  const grandparent = parent.parentNode;
  // console.log(grandparent);
  // Remove all current selected tabs
  parent
    .querySelectorAll('[aria-selected="true"]')
    .forEach(t => t.setAttribute("aria-selected", false));
  // Set this tab as selected
  target.setAttribute("aria-selected", true);
  // Hide all tab panels
  grandparent
    .querySelectorAll('[role="tabpanel"]')
    .forEach(p => p.setAttribute("hidden", true));
  // Show the selected panel
  grandparent.parentNode
    .querySelector(`#${target.getAttribute("aria-controls")}`)
    .removeAttribute("hidden");
}

function changeTabs(e) {
  // get the containing list of the tab that was just clicked
  const tabList = e.target.parentNode;

  // get all of the sibling tabs
  const buttons = Array.apply(null, tabList.querySelectorAll('button'));

  // loop over the siblings to discover which index thje clicked one was
  const { index } = buttons.reduce(({ found, index }, button) => {
    if (!found && buttons[index] === e.target) {
      return { found: true, index };
    } else if (!found) {
      return { found, index: index + 1 };
    } else {
      return { found, index };
    }
  }, { found: false, index: 0 });

  // get the tab container
  const container = tabList.parentNode;
  // read the data-tab-group value from the container, e.g. "os"
  const { tabGroup } = container.dataset;
  // get a list of all the tab groups that match this value on the page
  const groups = document.querySelectorAll('[data-tab-group=' + tabGroup + ']');

  // for each of the found tab groups, find the tab button at the previously discovered index and select it for each group
  groups.forEach((group) => {
    const target = group.querySelectorAll('button')[index];
    setActiveTab(target);
  });
}
</script>
</div>
<div class="navfooter">
<span class="prev">
<a href="monitor-kubernetes.html">« Monitor Kubernetes: Observe the health and performance of your Kubernetes deployments</a>
</span>
<span class="next">
</span>
</div>
</div>
</body>
</html>
