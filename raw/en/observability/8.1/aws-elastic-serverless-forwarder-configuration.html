<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="description" content="Learn configuration options for Elastic Serverless Forwarder and how to transform your AWS data as it is collected from Amazon Web Services (AWS).">
<meta name="keywords" content="serverless">
<title>Configuration options for Elastic Serverless Forwarder | Observability Guide [8.1] | Elastic</title>
<link rel="home" href="index.html" title="Observability Guide [8.1]"/>
<link rel="up" href="aws-elastic-serverless-forwarder.html" title="Elastic Serverless Forwarder for AWS"/>
<link rel="prev" href="aws-deploy-elastic-serverless-forwarder.html" title="Deploy Elastic Serverless Forwarder"/>
<link rel="next" href="aws-serverless-troubleshooting.html" title="Troubleshooting and error handling"/>
<meta name="DC.type" content="Learn/Docs/Observability/Guide/8.1"/>
<meta name="DC.subject" content="Observability"/>
<meta name="DC.identifier" content="8.1"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">Observability Guide [8.1]</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="add-observability-data.html">Send data to Elasticsearch</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="aws-elastic-serverless-forwarder.html">Elastic Serverless Forwarder for AWS</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="aws-deploy-elastic-serverless-forwarder.html">« Deploy Elastic Serverless Forwarder</a>
</span>
<span class="next">
<a href="aws-serverless-troubleshooting.html">Troubleshooting and error handling »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="aws-elastic-serverless-forwarder-configuration"></a>Configuration options for Elastic Serverless Forwarder<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h3>
</div></div></div>

<p>Learn more about configuration options for Elastic Serverless Forwarder, including more detail on permissions and policies, automatic routing of AWS service logs, and how to use AWS Secrets Manager for authentication.</p>
<p>You can transform or enrich data from AWS as it is parsed by the forwarder. This includes examples such as using tags and filters to organise your data and exclude specific messages, automatically discovering and collecting JSON content, and managing multiline messages effectively.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder-configuration.html#lambda-permissions-policies" title="Permissions and policies">Permissions and policies</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder-configuration.html#use-secrets-manager" title="Use AWS Secrets Manager">Use AWS Secrets Manager</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder-configuration.html#aws-serverless-route-service-logs" title="Route AWS service logs">Route AWS service logs</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder-configuration.html#aws-serverless-use-tags-filters" title="Use tags and filters">Use tags and filters</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder-configuration.html#aws-serverless-json-content" title="JSON content discovery">JSON content discovery</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder-configuration.html#aws-serverless-manage-multiline-messages" title="Manage multiline messages">Manage multiline messages</a>
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="lambda-permissions-policies"></a>Permissions and policies<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h4>
</div></div></div>
<p>A Lambda function&#8217;s execution role is an AWS Identity and Access Management (IAM) role that grants the function permission to access AWS services and resources. This role is automatically created when the function is deployed and Lambda assumes this role when the function is invoked.</p>
<p>When you provide the ARNs of AWS resources the forwarder will interact with, the Cloudformation template will create the correct IAM role with the appropriate IAM policies.</p>
<p>You can view the execution role associated with your Lambda function from the <span class="strong strong"><strong>Configuration &gt; Permissions</strong></span> section within . By default this role starts with the name <span class="strong strong"><strong>serverlessrepo-</strong></span>. When the role is created, a custom policy is added to grant Lambda minimum permissions to be able to use the configured SQS queue, S3 buckets, Kinesis data stream, CloudWatch Logs log groups, Secrets manager (if using), and SQS replay queue.</p>
<p>The forwarder is granted the following <code class="literal">ManagedPolicyArns</code> permissions, which are automatically added by default to the Events configuration (if relevant):</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
arn:aws:iam::aws:policy/service-role/AWSLambdaKinesisExecutionRole
arn:aws:iam::aws:policy/service-role/AWSLambdaSQSQueueExecutionRole</pre>
</div>
<p>In addition to these basic permissions, the following permissions are added when the function is created by the Cloudformation template of the function:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
For SQS queue resources specified in the <code class="literal">SQS_CONTINUE_URL</code> and <code class="literal">SQS_REPLAY_URL</code> environment variables, the following action is allowed: <code class="literal">sqs:SendMessage</code>
</li>
<li class="listitem">
For S3 bucket resources specified in the <code class="literal">S3_CONFIG_FILE</code> environment variable, the following action is allowed on the S3 buckets' config file object key: <code class="literal">s3:GetObject</code>
</li>
<li class="listitem">
For every S3 bucket resource sending notifications to SQS queues, the following action is allowed on the S3 buckets: <code class="literal">s3:ListBucket</code>
</li>
<li class="listitem">
For every S3 bucket resource sending notifications to SQS queues, the following action is allowed on the S3 buckets' keys: <code class="literal">s3:GetObject</code>
</li>
<li class="listitem">
For every Secret Manager secret that you want to refer in the <code class="literal">config.yaml</code> file, the following action is allowed: <code class="literal">secretsmanager:GetSecretValue</code>
</li>
<li class="listitem">
Excepting the default key used to encrypt your Secret Manager secrets with, the following action is allowed for every decrypt key: <code class="literal">kms:Decrypt</code>
</li>
<li class="listitem">
<p>If any CloudWatch Logs log groups are set as Lambda inputs, the following actions are allowed for the resource:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">arn:aws:logs:%AWS_REGION%:%AWS_ACCOUNT_ID%:log-group:*:*</code>
</li>
<li class="listitem">
<code class="literal">logs:DescribeLogGroups</code>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="lambda-policy-cloudwatch"></a>Lambda resource-based policy for CloudWatch Logs subscription filter input<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>For CloudWatch Logs subscription filter log group resources that you want to use as triggers for the forwarder, the following is allowed as a resource-based policy in separate Policy statements:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">  * Principal: logs.%AWS_REGION%.amazonaws.com
  * Action: lambda:InvokeFunction
  * Source ARN: arn:aws:logs:%AWS_REGION%:%AWS_ACCOUNT_ID%:log-group:%LOG_GROUP_NAME%:*</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="use-secrets-manager"></a>Use AWS Secrets Manager<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h4>
</div></div></div>
<p>AWS Secrets Manager enables you to replace hardcoded credentials in your code, including passwords, with an API call to Secrets Manager to retrieve the secret programmatically. For more info, refer to the <a href="https://docs.aws.amazon.com/secretsmanager/index.html" class="ulink" target="_top">AWS Secrets Manager documentation</a>.</p>
<p>There are 2 types of secrets that can be used:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
SecretString (plain text or key/value pairs)
</li>
<li class="listitem">
SecretBinary
</li>
</ul>
</div>
<p>The following code shows API calls to AWS Secrets Manager:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">inputs:
  - type: "s3-sqs"
    id: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
    outputs:
      - type: "elasticsearch"
        args:
          elasticsearch_url: "arn:aws:secretsmanager:eu-central-1:123456789:secret:es_url"
          username: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:username"
          password: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:password"
          es_datastream_name: "logs-generic-default"</pre>
</div>
<p>To use a <span class="strong strong"><strong>plain text</strong></span> or <span class="strong strong"><strong>binary</strong></span> secret, note the following format for the ARN:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">arn:aws:secretsmanager:AWS_REGION:AWS_ACCOUNT_ID:secret:SECRET_NAME</pre>
</div>
<p>In order to use a <span class="strong strong"><strong>key/value</strong></span> pair secret, you need to provide the key at the end of the arn, as per:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">arn:aws:secretsmanager:AWS_REGION:AWS_ACCOUNT_ID:secret:SECRET_NAME:SECRET_KEY</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Secrets from different regions are supported, but the only version currently retrieved for a secret is <code class="literal">AWSCURRENT</code>.
</li>
<li class="listitem">
You cannot use the same secret for both plain text and key/value pairs.
</li>
<li class="listitem">
Secrets are case-sensitive.
</li>
<li class="listitem">
Any configuration error or typo in the <code class="literal">config.yaml</code> file will be ignored (or exceptions raised) and secrets will not be retrieved.
</li>
<li class="listitem">
Keys must exist in the AWS Secrets Manager.
</li>
<li class="listitem">
Empty values for a given key are not allowed.
</li>
</ul>
</div>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-route-service-logs"></a>Route AWS service logs<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h4>
</div></div></div>
<p>For <code class="literal">S3 SQS Event Notifications</code> inputs, the Elastic Serverless Forwarder supports automatic routing of several AWS service logs to the corresponding <a href="https://docs.elastic.co/en/integrations" class="ulink" target="_top">integration data streams</a> for further processing and storage in the Elasticsearch cluster.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-automatic-routing"></a>Automatic routing<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>Elastic Serverless Forwarder supports automatic routing of the following logs to the corresponding default integration data stream:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
AWS CloudTrail (<code class="literal">aws.cloudtrail</code>)
</li>
<li class="listitem">
Amazon CloudWatch (<code class="literal">aws.cloudwatch_logs</code>)
</li>
<li class="listitem">
Elastic Load Balancing (<code class="literal">aws.elb_logs</code>)
</li>
<li class="listitem">
AWS Network Firewall (<code class="literal">aws.firewall_logs</code>)
</li>
<li class="listitem">
Amazon VPC Flow (<code class="literal">aws.vpcflow</code>)
</li>
<li class="listitem">
AWS Web Application Firewall (<code class="literal">aws.waf</code>)
</li>
</ul>
</div>
<p>For these use cases, setting the <code class="literal">es_datastream_name</code> field in the configuration file is optional.</p>
<p>For most other use cases, you will need to set the <code class="literal">es_datastream_name</code> field in the configuration file to route the data to a specific data stream or index. This value should be set in the following use cases:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
You want to write the data to a specific index, alias, or custom data stream, and not to the default integration data stream. This can help some users to use existing Elasticsearch assets like index templates, ingest pipelines, or dashboards, that are already set up and connected to business processes.
</li>
<li class="listitem">
When using <code class="literal">Kinesis Data Stream</code>, <code class="literal">CloudWatch Logs subscription filter</code> or <code class="literal">Direct SQS message payload</code> inputs. Only the <code class="literal">S3 SQS Event Notifications</code> input method supports automatic routing to default integration data streams for several AWS service logs.
</li>
<li class="listitem">
When using <code class="literal">S3 SQS Event Notifications</code> but where the log type is something <span class="strong strong"><strong>other than</strong></span> AWS CloudTrail (<code class="literal">aws.cloudtrail</code>), Amazon CloudWatch Logs (<code class="literal">aws.cloudwatch_logs</code>), Elastic Load Balancing (<code class="literal">aws.elb_logs</code>), AWS Network Firewall (<code class="literal">aws.firewall_logs</code>), Amazon VPC Flow (<code class="literal">aws.vpcflow</code>), and AWS Web Application Firewall (<code class="literal">aws.waf</code>).
</li>
</ul>
</div>
<p>If the <code class="literal">es_datastream_name</code> is not specified, and the log cannot be matched with any of the above AWS services, then the dataset will be set to <code class="literal">generic</code> and the namespace set to <code class="literal">default</code>, pointing to the data stream name <code class="literal">logs-generic-default</code>.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-use-tags-filters"></a>Use tags and filters<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h4>
</div></div></div>
<p>You can use tags and filters to tag and filter messages based on regular expressions.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-use-tags"></a>Use custom tags<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>You can add custom tags to filter and categorize items in events.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">inputs:
  - type: "s3-sqs"
    id: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
    tags:
      - "tag1"
      - "tag2"
      - "tag3"
    outputs:
      - type: "elasticsearch"
        args:
          elasticsearch_url: "arn:aws:secretsmanager:eu-central-1:123456789:secret:es_url"
          username: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:username"
          password: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:password"
          es_datastream_name: "logs-generic-default"</pre>
</div>
<p>Using the above example configuration, the tags will be set in the following way:</p>
<p><code class="literal">["forwarded", "generic", "tag1", "tag2", "tag3"]</code></p>
<p>The <code class="literal">forwarded</code> tag is always appended and the <code class="literal">generic</code> tag in this example comes from the dataset.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Tags must be defined within <code class="literal">inputs</code> in the <code class="literal">config.yaml</code> file.
</li>
<li class="listitem">
Each tag must be a string and added to the list.
</li>
</ul>
</div>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-define-include-exclude-filters"></a>Define include/exclude filters<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>You can define multiple filters for inputs to include or exclude events from data ingestion.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">inputs:
  - type: "s3-sqs"
    id: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
    include:
      - "[a-zA-Z]"
    exclude:
      - "skip this"
      - "skip also this"
    outputs:
      - type: "elasticsearch"
        args:
          elasticsearch_url: "arn:aws:secretsmanager:eu-central-1:123456789:secret:es_url"
          username: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:username"
          password: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:password"
          es_datastream_name: "logs-generic-default"</pre>
</div>
<p>You can define a list of regular expressions within <code class="literal">inputs.[].include</code>. If this list is populated, only messages <span class="strong strong"><strong>matching any</strong></span> of the defined regular expressions will be forwarded to the outputs.</p>
<p>You can define a list of regular expressions within <code class="literal">inputs.[].exclude</code>. If this list is populated, only messages <span class="strong strong"><strong>not matching any</strong></span> of the defined regular expressions will be forwarded to the outputs i.e. every message will be forwarded to the outputs unless it matches any of the defined regular expressions.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Both config parameters are optional, and can be set independently of each other. In terms of rule precedence, the exclude filter is applied first and then the include filter, so exclude takes precedence if both are specified.</p>
<p>All regular expressions are case-sensitive and should follow <a href="https://docs.python.org/3.9/library/re.html#regular-expression-syntax" class="ulink" target="_top">Python&#8217;s 3.9 regular expression syntax</a>.</p>
<p>Messages are scanned for terms that match the defined filters. Use the <code class="literal">^</code> (caret) special character to explicitly anchor the regex to the position before the first character of the string, and use <code class="literal">$</code> to anchor at the end.</p>
<p>No flags are used when the regular expression is compiled. Please refer to <a href="https://docs.python.org/3.9/library/re.html#re.compile" class="ulink" target="_top">inline flag documentation</a> for alternative options for multiline, case-insensitive, and other matching behaviors.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-json-content"></a>JSON content discovery<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h4>
</div></div></div>
<p>The Elastic Serverless Forwarder is able to automatically discover JSON content in the payload of an input and collect the JSON objects contained in the payload.</p>
<p>The JSON objects can either be on a single line or spanning multiple lines. In the second case, the forwarder expects different JSON objects spanning multiple lines to be separated by a newline delimiter.</p>
<p>When JSON objects span multiple lines, a limit of 1000 lines is applied. Every JSON object spanning across more than 1000 lines will not be collected. Every line composing the whole JSON object will be forwarded individually instead.</p>
<p>If you have known payload content which includes single JSON objects that span more than 1000 lines, or if you find that relying on auto-discovery of JSON content has a big impact on performance, you can configure JSON content types within the inputs to address this. This will change the parsing logic and improve performance while overcoming the 1000 lines limit.</p>
<p>Where content is known to be plain text, you can improve overall performance by disabling automatic JSON content discovery completely.</p>
<p>To change this configuration option, set <code class="literal">inputs.[].json_content_type</code> to one of the following values:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>single</strong></span>: indicates that the content of a single item in the input payload is a single JSON object. The content can either be on a single line or spanning multiple lines. With this setting the whole content of the payload is decoded as a JSON object, with no limit on the number of lines the JSON object spans.
</li>
<li class="listitem">
<span class="strong strong"><strong>ndjson</strong></span>: indicates that the content of a single item in the input payload is a valid NDJSON format. Multiple single JSON objects formatted on a single line should be separated by a newline delimiter. With this setting each line will be decoded as JSON object, which improves the parsing performance.
</li>
<li class="listitem">
<span class="strong strong"><strong>disabled</strong></span>: instructs the forwarder not to attempt any automatic JSON content discovery and instead treat the content as plain text, which improves the parsing performance.
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>There is no need to configure the JSON content type when <a class="xref" href="aws-elastic-serverless-forwarder-configuration.html#expanding-events-from-json-object-lists" title="Expanding events from JSON object lists">Expanding events from JSON object lists</a>, unless you have single JSON objects that span more than 1000 lines.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="expanding-events-from-json-object-lists"></a>Expanding events from JSON object lists<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>You can extract a list of events to be ingested from a specific field in the JSON file.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">inputs:
  - type: "s3-sqs"
    id: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
    expand_event_list_from_field: "Records"
    outputs:
      - type: "elasticsearch"
        args:
          elasticsearch_url: "arn:aws:secretsmanager:eu-central-1:123456789:secret:es_url"
          username: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:username"
          password: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:password"
          es_datastream_name: "logs-generic-default"</pre>
</div>
<p>You can define <code class="literal">inputs.[].expand_event_list_from_field</code> as a string with the value of a key in the JSON that contains a list of elements that must be sent as events instead of the encompassing JSON.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When <a class="xref" href="aws-elastic-serverless-forwarder-configuration.html#aws-serverless-route-service-logs" title="Route AWS service logs">routing service logs</a>, any value set for the <code class="literal">expand_event_list_from_field</code> configuration parameter will be ignored, because this will be automatically handled by the Elastic Serverless Forwarder.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_example"></a>Example<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>With the following input:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{"Records":[{"key": "value #1"},{"key": "value #2"}]}
{"Records":[{"key": "value #3"},{"key": "value #4"}]}</pre>
</div>
<p>Without setting <code class="literal">expand_event_list_from_field</code>, two events will be forwarded:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{"@timestamp": "2022-06-16T04:06:03.064Z", "message": "{\"Records\":[{\"key\": \"value #1\"},{\"key\": \"value #2\"}]}"}
{"@timestamp": "2022-06-16T04:06:13.888Z", "message": "{\"Records\":[{\"key\": \"value #3\"},{\"key\": \"value #4\"}]}"}</pre>
</div>
<p>If <code class="literal">expand_event_list_from_field</code> is set to <code class="literal">Records</code>, four events will be forwarded:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{"@timestamp": "2022-06-16T04:06:21.105Z", "message": "{\"key\": \"value #1\"}"}
{"@timestamp": "2022-06-16T04:06:27.204Z", "message": "{\"key\": \"value #2\"}"}
{"@timestamp": "2022-06-16T04:06:31.154Z", "message": "{\"key\": \"value #3\"}"}
{"@timestamp": "2022-06-16T04:06:36.189Z", "message": "{\"key\": \"value #4\"}"}</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-manage-multiline-messages"></a>Manage multiline messages<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h4>
</div></div></div>
<p>Forwarded content may contain messages that span multiple lines of text. For example, multiline messages are common in files that contain Java stack traces. In order to correctly handle these multiline events, you need to configure <code class="literal">multiline</code> settings for a specific input to specify which lines are part of a single event.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-multiline-config"></a>Configuration options<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>You can specify the following options for a specific input in the <code class="literal">config.yaml</code> file to control how the Elastic Serverless Forwarder deals with messages that span multiple lines.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">inputs:
  - type: "s3-sqs"
    id: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
    multiline:
      type: pattern
      pattern: '^\\['
      negate: true
      match: after
    outputs:
      - type: "elasticsearch"
        args:
          elasticsearch_url: "arn:aws:secretsmanager:eu-central-1:123456789:secret:es_url"
          username: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:username"
          password: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:password"
          es_datastream_name: "logs-generic-default"</pre>
</div>
<p>The forwarder takes all the lines that do not start with <code class="literal">[</code> and combines them with the previous line that does. For example, you could use this configuration to join the following lines of a multiline message into a single event:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">[beat-logstash-some-name-832-2015.11.28] IndexNotFoundException[no such index]
    at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver$WildcardExpressionResolver.resolve(IndexNameExpressionResolver.java:566)
    at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver.concreteIndices(IndexNameExpressionResolver.java:133)
    at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver.concreteIndices(IndexNameExpressionResolver.java:77)
    at org.elasticsearch.action.admin.indices.delete.TransportDeleteIndexAction.checkBlock(TransportDeleteIndexAction.java:75)</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Note that you should escape the opening square bracket (<code class="literal">[</code>) in the regular expression, because it specifies a character class i.e. a set of characters that you wish to match. You also have to escape the backslash (<code class="literal">\</code>) used for escaping the opening square bracket as raw strings are not used. Thus, <code class="literal">^\\[</code> will produce the required regular expression upon compiling.</p>
</div>
</div>
<p><code class="literal">inputs.[].multiline.type</code> defines which aggregation method to use. The default is <code class="literal">pattern</code>. The other options are <code class="literal">count</code>, which enables you to aggregate a constant number of lines, and <code class="literal">while_pattern</code>, which aggregates lines by pattern without matching options.</p>
<p><code class="literal">inputs.[].multiline.pattern</code> differs from the patterns supported by Logstash. See <a href="https://docs.python.org/3.9/library/re.html#regular-expression-syntax" class="ulink" target="_top">Python&#8217;s 3.9 regular expression syntax</a> for a list of supported regexp patterns. Depending on how you configure other multiline options, lines that match the specified regular expression are considered either continuations of a previous line or the start of a new multiline event.</p>
<p><code class="literal">inputs.[].multiline.negate</code> defines whether the pattern is negated. The default is <code class="literal">false</code>. This setting works only with <code class="literal">pattern</code> and <code class="literal">while_pattern</code> types.</p>
<p><code class="literal">inputs.[].multiline.match</code> changes the grouping of multiple lines according to the schema below (works only with <code class="literal">pattern</code> type):</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Setting for <code class="literal">negate</code></p></td>
<td align="left" valign="top"><p>Setting for <code class="literal">match</code></p></td>
<td align="left" valign="top"><p>Result</p></td>
<td align="left" valign="top"><p>Example <code class="literal">pattern: ^b</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">false</code></p></td>
<td align="left" valign="top"><p><code class="literal">after</code></p></td>
<td align="left" valign="top"><p>Consecutive lines that match the pattern are appended to the previous line that doesn’t match.</p></td>
<td align="left" valign="top"><p><span class="image"><img src="images/false-after-multi.png" alt="Lines a b b c b b become &quot;abb&quot; and &quot;cbb&quot;"></span></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">false</code></p></td>
<td align="left" valign="top"><p><code class="literal">before</code></p></td>
<td align="left" valign="top"><p>Consecutive lines that match the pattern are prepended to the next line that doesn’t match.</p></td>
<td align="left" valign="top"><p><span class="image"><img src="images/false-after-multi.png" alt="Lines b b a b b c become &quot;bba&quot; and &quot;bbc&quot;"></span></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">true</code></p></td>
<td align="left" valign="top"><p><code class="literal">after</code></p></td>
<td align="left" valign="top"><p>Consecutive lines that don’t match the pattern are appended to the previous line that does match.</p></td>
<td align="left" valign="top"><p><span class="image"><img src="images/true-after-multi.png" alt="Lines b a c b d e become &quot;bac&quot; and &quot;bde&quot;"></span></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">false</code></p></td>
<td align="left" valign="top"><p><code class="literal">before</code></p></td>
<td align="left" valign="top"><p>Consecutive lines that don’t match the pattern are prepended to the next line that does match.</p></td>
<td align="left" valign="top"><p><span class="image"><img src="images/true-before-multi.png" alt="Lines a c b d e b become &quot;acb&quot; and &quot;deb&quot;"></span></p></td>
</tr>
</tbody>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <code class="literal">after</code> setting is equivalent to <code class="literal">previous</code> in <a href="/guide/en/logstash/current/plugins-codecs-multiline.html" class="ulink" target="_top">Logstash</a>, and <code class="literal">before</code> is equivalent to <code class="literal">next</code>.</p>
</div>
</div>
<p><code class="literal">inputs.[].multiline.flush_pattern</code> specifies a regular expression, in which the current multiline will be flushed from memory, ending the multiline-message. Works only with <code class="literal">pattern</code> type.</p>
<p><code class="literal">inputs.[].multiline.max_lines</code> defines the maximum number of lines that can be combined into one event. If the multiline message contains more than <code class="literal">max_lines</code>, any additional lines are truncated from the event. The default is <code class="literal">500</code>.</p>
<p><code class="literal">inputs.[].multiline.max_bytes</code> defines the maximum number of bytes that can be combined into one event. If the multiline message contains more than <code class="literal">max_bytes</code>, any additional content is truncated from the event. The default is <code class="literal">10485760</code>.</p>
<p><code class="literal">inputs.[].multiline.count_lines</code> defines the number of lines to aggregate into a single event. Works only with <code class="literal">count</code> type.</p>
<p><code class="literal">inputs.[].multiline.skip_newline</code> defined whether multiline events must be concatenated, stripping the line separator. If set to <code class="literal">true</code>, the line separator will be stripped. The default is <code class="literal">false</code>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-multiline-config-examples"></a>Examples of multiline configuration<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>The examples in this section cover the following use cases:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Combining a Java stack trace into a single event
</li>
<li class="listitem">
Combining C-style line continuations into a single event
</li>
<li class="listitem">
Combining multiple lines from time-stamped events
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="aws-serverless-multiline-config-example-java"></a>Java stack traces<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h6>
</div></div></div>
<p>Java stack traces consist of multiple lines, with each line after the initial line beginning with whitespace, as in this example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">Exception in thread "main" java.lang.NullPointerException
        at com.example.myproject.Book.getTitle(Book.java:16)
        at com.example.myproject.Author.getBookTitles(Author.java:25)
        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)</pre>
</div>
<p>This configuration merges any line that begins with whitespace up to the previous line:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">multiline:
  type: pattern
  pattern: '^\s'
  negate: false
  match: after</pre>
</div>
<p>This is a slightly more complex Java stack trace example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">Exception in thread "main" java.lang.IllegalStateException: A book has a null property
       at com.example.myproject.Author.getBookIds(Author.java:38)
       at com.example.myproject.Bootstrap.main(Bootstrap.java:14)
Caused by: java.lang.NullPointerException
       at com.example.myproject.Book.getId(Book.java:22)
       at com.example.myproject.Author.getBookIds(Author.java:35)
       ... 1 more</pre>
</div>
<p>To consolidate these lines into a single event, use the following multiline configuration:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">multiline:
  type: pattern
  pattern: '^\s+(at|.{3})\s+\\b|^Caused by:'
  negate: false
  match: after</pre>
</div>
<p>In this example, the pattern matches and merges the following lines:
-   a line that begins with spaces followed by the word <code class="literal">at</code> or <code class="literal">...</code>
-   a line that begins with the words <code class="literal">Caused by:</code></p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In Python’s string literals, <code class="literal">\b</code> is the backspace character (ASCII value 8). As raw strings are not used, Python would convert the <code class="literal">\b</code> to a backspace. In order for our regular expression to match as expected, you need to escape the backslash <code class="literal">\</code> in <code class="literal">\b</code> to <code class="literal">\\b</code>, which will produce the correct regular expression upon compiling.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="aws-serverless-multiline-line-continuations"></a>Line continuations<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h6>
</div></div></div>
<p>Several programming languages use the backslash (<code class="literal">\</code>) character at the end of a line to denote that the line continues, as in this example:</p>
<div class="pre_wrapper lang-c">
<pre class="programlisting prettyprint lang-c">printf ("%10.10ld  \t %10.10ld \t %s\
  %f", w, x, y, z );</pre>
</div>
<p>To consolidate these lines into a single event, use the following multiline configuration:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">multiline:
  type: pattern
  pattern: '\\\\$'
  negate: false
  match: after</pre>
</div>
<p>This configuration merges any line that ends with the <code class="literal">\</code> character with the line that follows it.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Note that you should escape the opening backslash (<code class="literal">\</code>) twice in the regular expression, as raw strings are not used. Thus, <code class="literal">\\\\$</code> will produce the required regular expression upon compiling.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="aws-serverless-multiline-timestamps"></a>Timestamps<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h6>
</div></div></div>
<p>Activity logs from services such as Elasticsearch typically begin with a timestamp, followed by information on the specific activity, as in this example:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">[2015-08-24 11:49:14,389][INFO ][env                      ] [Letha] using [1] data paths, mounts [[/
(/dev/disk1)]], net usable_space [34.5gb], net total_space [118.9gb], types [hfs]</pre>
</div>
<p>To consolidate these lines into a single event, use the following multiline configuration:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">multiline:
  type: pattern
  pattern: '^\\[[0-9]{4}-[0-9]{2}-[0-9]{2}'
  negate: true
  match: after</pre>
</div>
<p>This configuration uses the <code class="literal">negate: true</code> and <code class="literal">match: after</code> settings to specify that any line that does not match the specified pattern belongs to the previous line.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Note that you should escape the opening square bracket (<code class="literal">[</code>) in the regular expression, because it specifies a character class i.e. a set of characters that you wish to match. You also have to escape the backslash (<code class="literal">\</code>) used for escaping the opening square bracket as raw strings are not used. Thus, <code class="literal">^\\[</code> will produce the required regular expression upon compiling.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="aws-serverless-multiline-application-events"></a>Application events<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h6>
</div></div></div>
<p>Sometimes your application logs contain events, that begin and end with custom markers, such as the following example:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">[2015-08-24 11:49:14,389] Start new event
[2015-08-24 11:49:14,395] Content of processing something
[2015-08-24 11:49:14,399] End event</pre>
</div>
<p>To consolidate these lines into a single event, use the following multiline configuration:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">multiline:
  type: pattern
  pattern: 'Start new event'
  negate: true
  match: after
  flush_pattern: 'End event'</pre>
</div>
<p>The <code class="literal">flush_pattern</code> option specifies a regex at which the current multiline will be flushed. If you think of the <code class="literal">pattern</code> option specifying the beginning of an event, the <code class="literal">flush_pattern</code> option will specify the end or last line of the event.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This example will not work correctly if start/end log blocks are mixed with non-multiline logs, or if different start/end log blocks overlap with each other. For instance, <code class="literal">Some other log</code> log lines in the following example will be merged into a <span class="strong strong"><strong>single</strong></span> multiline document because they neither match <code class="literal">inputs.[].multiline.pattern</code> nor <code class="literal">inputs.[].multiline.flush_pattern</code>, and <code class="literal">inputs.[].multiline.negate</code> is set to <code class="literal">true</code>.</p>
</div>
</div>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">[2015-08-24 11:49:14,389] Start new event
[2015-08-24 11:49:14,395] Content of processing something
[2015-08-24 11:49:14,399] End event
[2015-08-24 11:50:14,389] Some other log
[2015-08-24 11:50:14,395] Some other log
[2015-08-24 11:50:14,399] Some other log
[2015-08-24 11:51:14,389] Start new event
[2015-08-24 11:51:14,395] Content of processing something
[2015-08-24 11:51:14,399] End event</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-multiline-test-regexp"></a>Test your regexp pattern for multiline<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>To make it easier for you to test the regexp patterns in your multiline config, you can use this <a href="https://replit.com/@AndreaSpacca/Multiline-Regexp-Test#main.py" class="ulink" target="_top">Multiline Regexp Test</a>:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Plug in the regexp pattern at line <code class="literal">3</code>, along with the <code class="literal">multiline.negate</code> setting that you plan to use at line <code class="literal">4</code>
</li>
<li class="listitem">
Paste a sample message between the three double quote delimiters (<code class="literal">""" """</code>) at line <code class="literal">5</code>
</li>
<li class="listitem">
Click <code class="literal">Run</code> to see which lines in the message match your specified configuration.
</li>
</ol>
</div>
<p class="screenshot"><span class="image"><img src="images/multiline-regexp-test-repl-main.png" alt="Add your test message to Multiline Regexp test"></span></p>
<p class="screenshot"><span class="image"><img src="images/multiline-regexp-test-repl-run.png" alt="View the test results"></span></p>
</div>

</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="aws-deploy-elastic-serverless-forwarder.html">« Deploy Elastic Serverless Forwarder</a>
</span>
<span class="next">
<a href="aws-serverless-troubleshooting.html">Troubleshooting and error handling »</a>
</span>
</div>
</div>
</body>
</html>
