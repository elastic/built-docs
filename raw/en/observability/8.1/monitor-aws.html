<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="description" content="Learn configuration options for Elastic Serverless Forwarder and how to transform your AWS data as it is collected from Amazon Web Services (AWS).">
<meta name="keywords" content="serverless">
<title>Monitor Amazon Web Services (AWS) | Observability Guide [8.1] | Elastic</title>
<link rel="home" href="index.html" title="Observability Guide [8.1]"/>
<link rel="up" href="observability-tutorials.html" title="Tutorials"/>
<link rel="prev" href="observability-tutorials.html" title="Tutorials"/>
<link rel="next" href="monitor-gcp.html" title="Monitor Google Cloud Platform"/>
<meta name="DC.type" content="Learn/Docs/Observability/Guide/8.1"/>
<meta name="DC.subject" content="Observability"/>
<meta name="DC.identifier" content="8.1"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">Observability Guide [8.1]</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="observability-tutorials.html">Tutorials</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="observability-tutorials.html">« Tutorials</a>
</span>
<span class="next">
<a href="monitor-gcp.html">Monitor Google Cloud Platform »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="monitor-aws"></a>Monitor Amazon Web Services (AWS)<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/monitor-aws.asciidoc">edit</a></h2>
</div></div></div>
<p>In this tutorial, you’ll learn how to monitor your AWS infrastructure using
Elastic Observability: Logs and Metrics.</p>
<h3><a id="aws-what-you-learn"></a>What you&#8217;ll learn<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/monitor-aws.asciidoc">edit</a></h3>
<p>You&#8217;ll learn how to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Create and configure an S3 bucket
</li>
<li class="listitem">
Create and configure an SQS queue.
</li>
<li class="listitem">
Install and configure Filebeat and Metricbeat to collect Logs and Metrics
</li>
<li class="listitem">
Collect logs from S3
</li>
<li class="listitem">
Collect metrics from Amazon CloudWatch
</li>
</ul>
</div>
<h3><a id="aws-before-you-begin"></a>Before you begin<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/monitor-aws.asciidoc">edit</a></h3>
<p>Create a deployment using our hosted Elasticsearch Service on <a href="/cloud/elasticsearch-service/signup?baymax=docs-body&amp;elektra=docs" class="ulink" target="_top">Elastic Cloud</a>.
The deployment includes an Elasticsearch cluster for storing and searching your data,
and Kibana for visualizing and managing your data.
To learn more, see <a class="xref" href="spin-up-stack.html" title="Spin up the Elastic Stack">Spin up the Elastic Stack</a>.</p>
<p>With this tutorial, we assume that your logs and your infrastructure
data are already shipped to CloudWatch. We are going to show you how you can
stream your data from CloudWatch to Elasticsearch. If you don’t know how to put
your AWS logs and infrastructure data in CloudWatch, Amazon provides a lot of
documentation around this specific topic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Collect your logs and infrastructure data from specific <a href="https://www.youtube.com/watch?v=vAnIhIwE5hY" class="ulink" target="_top">AWS services</a>
</li>
<li class="listitem">
Export your logs <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/S3ExportTasksConsole.html" class="ulink" target="_top">to an S3 bucket</a>
</li>
</ul>
</div>
<h3><a id="aws-step-one"></a>Step 1:  Create an S3 Bucket<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/monitor-aws.asciidoc">edit</a></h3>
<p>To centralize your logs in Elasticsearch, you need to have an S3 bucket.
Filebeat, the agent you&#8217;ll use to collect logs, has an input for S3.</p>
<p>In the <a href="https://s3.console.aws.amazon.com/s3" class="ulink" target="_top">AWS S3 console</a>, click on <span class="strong strong"><strong>Create
bucket</strong></span>. Give the bucket a <span class="strong strong"><strong>name</strong></span> and specify the <span class="strong strong"><strong>region</strong></span> in which you want it
deployed.</p>
<div class="imageblock">
<div class="content">
<img src="creating-a-s3-bucket.png" alt="S3 bucket creation">
</div>
</div>
<h3><a id="aws-step-two"></a>Step 2:  Create an SQS Queue<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/monitor-aws.asciidoc">edit</a></h3>
<p>You should now have an S3 bucket in which you can export your logs, but you will
also need an SQS queue. To avoid significant lagging with polling all
log files from each S3 bucket, we will use Amazon Simple Queue Service (SQS).
This will provide us with an Amazon S3 notification when a new S3 object is
created. The <a href="/guide/en/beats/filebeat/8.1/filebeat-input-aws-s3.html" class="ulink" target="_top">Filebeat S3 input</a>
checks SQS for new messages regarding the new object created in S3 and uses the
information in these messages to retrieve logs from S3 buckets. With this setup,
periodic polling from each S3 bucket is not needed. Instead, the Filebeat S3
input guarantees near real-time data collection from S3 buckets with both speed
and reliability.</p>
<p>Create an SQS queue and configure our S3 bucket to send a message to the SQS
queue whenever new logs are present in the S3 bucket. Go to the <a href="https://eu-central-1.console.aws.amazon.com/sqs/" class="ulink" target="_top">SQS console</a></p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure that the queue is created in the same region as the S3 bucket.</p>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="creating-a-queue.png" alt="Queue Creation">
</div>
</div>
<p>Create a standard SQS queue and edit the access policy by using a JSON object to
define an advanced access policy:</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Replace <code class="literal">&lt;sqs-arn&gt;</code> with the ARN of the SQS queue, <code class="literal">&lt;s3-bucket-arn&gt;</code> with the
ARN of the S3 bucket you just created, the <code class="literal">&lt;source-account&gt;</code> with your source
account.</p>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">{
  "Version": "2012-10-17",
  "Id": "example-ID",
  "Statement": [
    {
      "Sid": "example-statement-ID",
      "Effect": "Allow",
      "Principal": {
        "AWS": "*"
      },
      "Action": "SQS:SendMessage",
      "Resource": "&lt;sqs-arn&gt;",
      "Condition": {
        "StringEquals": {
          "aws:SourceAccount": "&lt;source-account&gt;"
        },
        "ArnLike": {
          "aws:SourceArn": "&lt;s3-bucket-arn&gt;"
        }
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1.console"></div>
<h3><a id="aws-step-three"></a>Step 3:  Enable Event Notification<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/monitor-aws.asciidoc">edit</a></h3>
<p>Now that your queue is created, go to the properties of the S3 bucket you
created and click <span class="strong strong"><strong>Create event notification</strong></span>.</p>
<p>Specify that you want to send a notification on every object creation event.</p>
<div class="imageblock">
<div class="content">
<img src="configure-event-notification.png" alt="Event Notification Setting">
</div>
</div>
<p>Set the destination as the SQS queue you just created.</p>
<div class="imageblock">
<div class="content">
<img src="configure-notification-output.png" alt="Event Notification Setting">
</div>
</div>
<h3><a id="aws-step-four"></a>Step 4: Install and configure Filebeat<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/monitor-aws.asciidoc">edit</a></h3>
<p>To monitor AWS using the Elastic Stack, you need two main components:
an Elastic deployment to store and analyze the data and an agent to collect and
ship the data.</p>
<h4><a id="_install_filebeat"></a>Install Filebeat<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/shared/install-configure-filebeat.asciidoc">edit</a></h4>
<p>Download and install Filebeat.</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Install-f">
    <button role="tab"
            aria-selected="true"
            aria-controls="deb-tab-install-filebeat"
            id="deb-install-filebeat">
      DEB
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="rpm-tab-install-filebeat"
            id="rpm-install-filebeat"
            tabindex="-1">
      RPM
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="mac-tab-install-filebeat"
            id="mac-install-filebeat"
            tabindex="-1">
      MacOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-install-filebeat"
            id="linux-install-filebeat"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-install-filebeat"
            id="win-install-filebeat"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="deb-tab-install-filebeat"
       aria-labelledby="deb-install-filebeat">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.1.3-amd64.deb
sudo dpkg -i filebeat-8.1.3-amd64.deb</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="rpm-tab-install-filebeat"
       aria-labelledby="rpm-install-filebeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.1.3-x86_64.rpm
sudo rpm -vi filebeat-8.1.3-x86_64.rpm</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-install-filebeat"
       aria-labelledby="mac-install-filebeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.1.3-darwin-x86_64.tar.gz
tar xzvf filebeat-8.1.3-darwin-x86_64.tar.gz</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-install-filebeat"
       aria-labelledby="linux-install-filebeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.1.3-linux-x86_64.tar.gz
tar xzvf filebeat-8.1.3-linux-x86_64.tar.gz</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-install-filebeat"
       aria-labelledby="win-install-filebeat"
       hidden="">
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Download the Filebeat Windows zip file from the
<a href="/downloads/beats/filebeat" class="ulink" target="_top">downloads page</a>.
</li>
<li class="listitem">
Extract the contents of the zip file into <code class="literal">C:\Program Files</code>.
</li>
<li class="listitem">
Rename the <code class="literal">filebeat-&lt;version&gt;-windows</code> directory to <code class="literal">Filebeat</code>.
</li>
<li class="listitem">
Open a PowerShell prompt as an Administrator (right-click the PowerShell icon
and select <span class="strong strong"><strong>Run As Administrator</strong></span>).
</li>
<li class="listitem">
<p>From the PowerShell prompt, run the following commands to install
Filebeat as a Windows service:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">PS &gt; cd 'C:\Program Files\Filebeat'
PS C:\Program Files\Filebeat&gt; .\install-service-filebeat.ps1</pre>
</div>
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If script execution is disabled on your system, you need to set the
execution policy for the current session to allow the script to run. For
example:
<code class="literal">PowerShell.exe -ExecutionPolicy UnRestricted -File .\install-service-filebeat.ps1</code>.</p>
</div>
</div>
  </div>
</div>
<h4><a id="_set_up_assets"></a>Set up assets<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/shared/install-configure-filebeat.asciidoc">edit</a></h4>
<p>Filebeat comes with predefined assets for parsing, indexing, and visualizing your data.
Run the following command to load these assets. It may take a few minutes.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat setup -e -E 'cloud.id=YOUR_DEPLOYMENT_CLOUD_ID' -E 'cloud.auth=elastic:YOUR_SUPER_SECRET_PASS' <a id="CO44-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO44-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Substitute your Cloud ID and an administrator&#8217;s <code class="literal">username:password</code> in this command.
To find your Cloud ID, click on your <a href="https://cloud.elastic.co/deployments" class="ulink" target="_top">deployment</a>.</p>
</td>
</tr>
</table>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Setting up Filebeat is an admin-level task that requires extra privileges.
As a best practice, <a href="/guide/en/beats/filebeat/8.1/privileges-to-setup-beats.html" class="ulink" target="_top">use an administrator role to set up</a>
and a more restrictive role for event publishing (which you will do next).</p>
</div>
</div>
<h4><a id="_configure_filebeat_output"></a>Configure Filebeat output<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/shared/install-configure-filebeat.asciidoc">edit</a></h4>
<p>Next, you are going to configure Filebeat output to Elasticsearch Service.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Use the Filebeat keystore to store <a href="/guide/en/beats/filebeat/8.1/keystore.html" class="ulink" target="_top">secure settings</a>.
Store the Cloud ID in the keystore.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat keystore create
echo -n "&lt;Your Deployment Cloud ID&gt;" | ./filebeat keystore add CLOUD_ID --stdin</pre>
</div>
</li>
<li class="listitem">
<p>To store logs in Elasticsearch with minimal permissions, create an API key to send
data from Filebeat to Elasticsearch Service. Log into Kibana (you can do so from the Cloud
Console without typing in any permissions) and select <span class="strong strong"><strong>Management</strong></span> &#8594; <span class="strong strong"><strong>Dev
Tools</strong></span>. Send the following request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/api_key
{
  "name": "filebeat-monitor-gcp",
  "role_descriptors": {
    "filebeat_writer": {
      "cluster": [
        "monitor",
        "read_ilm",
        "cluster:admin/ingest/pipeline/get", <a id="CO45-1"></a><i class="conum" data-value="1"></i>
        "cluster:admin/ingest/pipeline/put" <a id="CO45-2"></a><i class="conum" data-value="1"></i>
      ],
      "index": [
        {
          "names": ["filebeat-*"],
          "privileges": ["view_index_metadata", "create_doc"]
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/2.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO45-1"><i class="conum" data-value="1"></i></a><a href="#CO45-2"></a></p>
</td>
<td align="left" valign="top">
<p>Filebeat needs extra cluster permissions to publish logs, which differs
from the Metricbeat configuration. You can find more
details <a href="/guide/en/beats/filebeat/8.1/feature-roles.html" class="ulink" target="_top">here</a>.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>The response contains an <code class="literal">api_key</code> and an <code class="literal">id</code> field, which can be stored in
the Filebeat keystore in the following format: <code class="literal">id:api_key</code>.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">echo -n "IhrJJHMB4JmIUAPLuM35:1GbfxhkMT8COBB4JWY3pvQ" | ./filebeat keystore add ES_API_KEY --stdin</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure you specify the <code class="literal">-n</code> parameter; otherwise, you will have
painful debugging sessions due to adding a newline at the end of
your API key.</p>
</div>
</div>
</li>
<li class="listitem">
<p>To see if both settings have been stored, run the following command:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat keystore list</pre>
</div>
</li>
<li class="listitem">
<p>To configure Filebeat to output to Elasticsearch Service, edit the <code class="literal">filebeat.yml</code>
configuration file. Add the following lines to the end of the file.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">cloud.id: ${CLOUD_ID}
output.elasticsearch:
  api_key: ${ES_API_KEY}</pre>
</div>
</li>
<li class="listitem">
<p>Finally, test if the configuration is working. If it is not working,
verify that you used the right credentials and, if necessary, add them again.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat test output</pre>
</div>
</li>
</ol>
</div>
<h3><a id="aws-step-five"></a>Step 5: Configure the AWS Module<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/monitor-aws.asciidoc">edit</a></h3>
<p>Now that the output is working, you can set up the
<a href="/guide/en/beats/filebeat/8.1/filebeat-module-aws.html" class="ulink" target="_top">Filebeat AWS</a> module which
will automatically create the AWS input. This
module checks SQS for new messages regarding the new object created in the S3
bucket and uses the information in these messages to retrieve logs from S3
buckets. With this setup, periodic polling from each S3 bucket is not needed.</p>
<p>There are many different filesets available: <code class="literal">cloudtrail</code>, <code class="literal">vpcflow</code>, <code class="literal">ec2</code>,
<code class="literal">cloudwatch</code>, <code class="literal">elb</code> and <code class="literal">s3access</code>. In this tutorial, we are going to show you a
few examples using the <code class="literal">ec2</code> and the <code class="literal">s3access</code> filesets.</p>
<p>The <code class="literal">ec2</code> fileset is
used to ship and process logs stored in cloudwatch, and export them to an S3
bucket. The <code class="literal">s3access</code> fileset is used when S3 access logs need to be collected.
It provides detailed records for the requests that are made to a bucket. Server
access logs are useful for many applications. For example, access log
information can be useful in security and access audits. It can also help you
learn about your customer base and understand your Amazon S3 bill.</p>
<p>Let&#8217;s enable the AWS module in Filebeat.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat modules enable aws</pre>
</div>
<p>Edit the <code class="literal">modules.d/aws.yml</code> file with the following configurations.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">- module: aws
  cloudtrail:
    enabled: false
  cloudwatch:
    enabled: false
  ec2:
    enabled: true <a id="CO46-1"></a><i class="conum" data-value="1"></i>
    var.credential_profile_name: fb-aws <a id="CO46-2"></a><i class="conum" data-value="2"></i>
    var.queue_url: https://sqs.eu-central-1.amazonaws.com/836370109380/howtoguide-tutorial <a id="CO46-3"></a><i class="conum" data-value="3"></i>
  elb:
    enabled: false
  s3access:
    enabled: false
  vpcflow:
    enabled: false</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO46-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Enables the <code class="literal">ec2</code> fileset.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO46-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>This is the AWS profile defined following the <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html" class="ulink" target="_top">AWS standard</a>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO46-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Add the URL to the queue containing notifications around the bucket containing the EC2 logs</p>
</td>
</tr>
</table>
</div>
<p>Make sure that the AWS user used to collect the logs from S3 has at least the
following permissions attached to it:</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": [
              "s3:GetObject",
              "sqs:ReceiveMessage",
              "sqs:ChangeMessageVisibility",
              "sqs:DeleteMessage"
            ],
            "Effect": "Allow",
            "Resource": "*"
        }
    ]
}</pre>
</div>
<p>You can now upload your logs to the S3 bucket. If you are using cloudwatch,
make sure to edit the policy of your bucket as shown in <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/S3ExportTasksConsole.html" class="ulink" target="_top">step 3 of the AWS user guide</a>.
This will help you avoid permissions issues.</p>
<p>Start Filebeat to collect the logs.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat -e</pre>
</div>
<p>Here&#8217;s what we&#8217;ve achieved so far:</p>
<div class="imageblock">
<div class="content">
<img src="one-bucket-archi.png" alt="Current Architecture">
</div>
</div>
<p>Now, let&#8217;s configure the <code class="literal">s3access</code> fileset.
The goal here is to be able to monitor how people access the bucket we
created. To do this, we&#8217;ll create another bucket and another queue.
The new architecture will look like this:</p>
<div class="imageblock">
<div class="content">
<img src="two-buckets-archi.png" alt="Architecture with Access Logging Enabled">
</div>
</div>
<p>Create a new S3 bucket and SQS queue. Ensure that the event notifications on the new bucket are enabled,
and that it&#8217;s sending notifications to the new queue.</p>
<p>Now go back to the first bucket, and go to <span class="strong strong"><strong>Properties</strong></span> &gt; <span class="strong strong"><strong>Server access
logging</strong></span>. Specify that you want to ship the access logs to the bucket you most recently
created.</p>
<div class="imageblock">
<div class="content">
<img src="Server-Access-Logging.png" alt="Enabling Server Access Logging">
</div>
</div>
<p>Copy the URL of the queue you created. Edit the `modules.d/aws.yml`file with
the following configurations.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">- module: aws
  cloudtrail:
    enabled: false
  cloudwatch:
    enabled: false
  ec2:
    enabled: true <a id="CO47-1"></a><i class="conum" data-value="1"></i>
    var.credential_profile_name: fb-aws <a id="CO47-2"></a><i class="conum" data-value="2"></i>
    var.queue_url: https://sqs.eu-central-1.amazonaws.com/836370109380/howtoguide-tutorial <a id="CO47-3"></a><i class="conum" data-value="3"></i>
  elb:
    enabled: false
  s3access:
    enabled: true <a id="CO47-4"></a><i class="conum" data-value="1"></i>
    var.credential_profile_name: fb-aws <a id="CO47-5"></a><i class="conum" data-value="2"></i>
    var.queue_url: https://sqs.eu-central-1.amazonaws.com/836370109380/access-log <a id="CO47-6"></a><i class="conum" data-value="4"></i>
  vpcflow:
    enabled: false</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO47-1"><i class="conum" data-value="1"></i></a><a href="#CO47-4"></a></p>
</td>
<td align="left" valign="top">
<p>Enables the <code class="literal">ec2</code> fileset.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO47-2"><i class="conum" data-value="2"></i></a><a href="#CO47-5"></a></p>
</td>
<td align="left" valign="top">
<p>This is the aws profile defined following the <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html" class="ulink" target="_top">AWS standard</a>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO47-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Add the URL to the queue containing notifications around the bucket containing the EC2 logs</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO47-6"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>Add the URL to the queue containing notifications around the bucket containing the S3 access logs</p>
</td>
</tr>
</table>
</div>
<p>Once you have edited the config file, you need to restart filebeat. To stop
flebeat, you can press CTRL + C in the terminal. Now let&#8217;s restart filebeat by
running the following command:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat -e</pre>
</div>
<h3><a id="aws-step-six"></a>Step 6: Visualize Logs<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/monitor-aws.asciidoc">edit</a></h3>
<p>Now that the logs are being shipped to Elasticsearch we can visualize them in
Kibana. To see the raw logs, open the main menu in Kibana, then click
<span class="strong strong"><strong>Logs</strong></span>:</p>
<div class="imageblock">
<div class="content">
<img src="EC2-logs.png" alt="EC2 logs in the Logs UI">
</div>
</div>
<p>The filesets we used in the previous steps also come with prebuilt dashboards
that you can use to visualize the data. In Kibana, open the main menu and click
<span class="strong strong"><strong>Dashboard</strong></span>. Search for S3 and select the dashboard called:
<span class="strong strong"><strong>[Filebeat AWS] S3 Server Access Log Overview</strong></span>:</p>
<div class="imageblock">
<div class="content">
<img src="S3-Server-Access-Logs.png" alt="S3 Server Access Log Overview">
</div>
</div>
<p>This gives you an overview of how your S3 buckets are being accessed.</p>
<h3><a id="aws-step-seven"></a>Step 7: Collect Metrics<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/monitor-aws.asciidoc">edit</a></h3>
<p>To monitor your AWS infrastructure you will need to first make sure your
infrastructure data are being shipped to CloudWatch. To ship the data to
Elasticsearch we are going to use the AWS module from Metricbeat. This module
periodically fetches monitoring metrics from AWS CloudWatch using
<span class="strong strong"><strong>GetMetricData</strong></span> API for AWS services.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Extra AWS charges on CloudWatch API requests will be generated by this module.
Please see <a href="/guide/en/beats/metricbeat/8.1/metricbeat-module-aws.html#aws-api-requests" class="ulink" target="_top">AWS API requests</a> for more details.</p>
</div>
</div>
<h3><a id="aws-step-eight"></a>Step 8: Install and configure Metricbeat<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/monitor-aws.asciidoc">edit</a></h3>
<p>In a new terminal window, run the following commands.</p>
<h4><a id="_install_metricbeat"></a>Install Metricbeat<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/shared/install-configure-metricbeat.asciidoc">edit</a></h4>
<p>Download and install Metricbeat.</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Install-m">
    <button role="tab"
            aria-selected="true"
            aria-controls="deb-tab-install-metricbeat"
            id="deb-install-metricbeat">
      DEB
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="rpm-tab-install-metricbeat"
            id="rpm-install-metricbeat"
            tabindex="-1">
      RPM
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="mac-tab-install-metricbeat"
            id="mac-install-metricbeat"
            tabindex="-1">
      MacOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-install-metricbeat"
            id="linux-install-metricbeat"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-install-metricbeat"
            id="win-install-metricbeat"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="deb-tab-install-metricbeat"
       aria-labelledby="deb-install-metricbeat">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.1.3-amd64.deb
sudo dpkg -i metricbeat-8.1.3-amd64.deb</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="rpm-tab-install-metricbeat"
       aria-labelledby="rpm-install-metricbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.1.3-x86_64.rpm
sudo rpm -vi metricbeat-8.1.3-x86_64.rpm</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-install-metricbeat"
       aria-labelledby="mac-install-metricbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.1.3-darwin-x86_64.tar.gz
tar xzvf metricbeat-8.1.3-darwin-x86_64.tar.gz</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-install-metricbeat"
       aria-labelledby="linux-install-metricbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.1.3-linux-x86_64.tar.gz
tar xzvf metricbeat-8.1.3-linux-x86_64.tar.gz</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-install-metricbeat"
       aria-labelledby="win-install-metricbeat"
       hidden="">
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Download the Metricbeat Windows zip file from the
<a href="/downloads/beats/metricbeat" class="ulink" target="_top">downloads page</a>.
</li>
<li class="listitem">
Extract the contents of the zip file into <code class="literal">C:\Program Files</code>.
</li>
<li class="listitem">
Rename the <code class="literal">metricbeat-&lt;version&gt;-windows</code> directory to <code class="literal">Metricbeat</code>.
</li>
<li class="listitem">
Open a PowerShell prompt as an Administrator (right-click the PowerShell icon
and select <span class="strong strong"><strong>Run As Administrator</strong></span>).
</li>
<li class="listitem">
<p>From the PowerShell prompt, run the following commands to install
Metricbeat as a Windows service:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">PS &gt; cd 'C:\Program Files\Metricbeat'
PS C:\Program Files\Metricbeat&gt; .\install-service-metricbeat.ps1</pre>
</div>
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If script execution is disabled on your system, you need to set the
execution policy for the current session to allow the script to run. For
example:
<code class="literal">PowerShell.exe -ExecutionPolicy UnRestricted -File .\install-service-metricbeat.ps1</code>.</p>
</div>
</div>
  </div>
</div>
<h4><a id="_set_up_assets_2"></a>Set up assets<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/shared/install-configure-metricbeat.asciidoc">edit</a></h4>
<p>Metricbeat comes with predefined assets for parsing, indexing, and visualizing your data.
Run the following command to load these assets. It may take a few minutes.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat setup -e -E 'cloud.id=YOUR_DEPLOYMENT_CLOUD_ID' -E 'cloud.auth=elastic:YOUR_SUPER_SECRET_PASS' <a id="CO48-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO48-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Substitute your Cloud ID and an administrator&#8217;s <code class="literal">username:password</code> in this command.
To find your Cloud ID, click on your <a href="https://cloud.elastic.co/deployments" class="ulink" target="_top">deployment</a>.</p>
</td>
</tr>
</table>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Setting up Metricbeat is an admin-level task that requires extra privileges.
As a best practice, <a href="/guide/en/beats/metricbeat/8.1/privileges-to-setup-beats.html" class="ulink" target="_top">use an administrator role to set up</a>,
and a more restrictive role for event publishing (which you will do next).</p>
</div>
</div>
<h4><a id="_configure_metricbeat_output"></a>Configure Metricbeat output<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/shared/install-configure-metricbeat.asciidoc">edit</a></h4>
<p>Next, you are going to configure Metricbeat output to Elasticsearch Service.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Use the Metricbeat keystore to store <a href="/guide/en/beats/metricbeat/8.1/keystore.html" class="ulink" target="_top">secure settings</a>.
Store the Cloud ID in the keystore.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat keystore create
echo -n "&lt;Your Deployment Cloud ID&gt;" | ./metricbeat keystore add CLOUD_ID --stdin</pre>
</div>
</li>
<li class="listitem">
<p>To store metrics in Elasticsearch with minimal permissions, create an API key to send
data from Metricbeat to Elasticsearch Service. Log into Kibana (you can do so from the Cloud
Console without typing in any permissions) and select <span class="strong strong"><strong>Management</strong></span> &#8594; <span class="strong strong"><strong>Dev
Tools</strong></span>. Send the following request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/api_key
{
  "name": "metricbeat-monitor",
  "role_descriptors": {
    "metricbeat_writer": {
      "cluster": ["monitor", "read_ilm"],
      "index": [
        {
          "names": ["metricbeat-*"],
          "privileges": ["view_index_metadata", "create_doc"]
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/3.console"></div>
</li>
<li class="listitem">
<p>The response contains an <code class="literal">api_key</code> and an <code class="literal">id</code> field, which can be stored in
the Metricbeat keystore in the following format: <code class="literal">id:api_key</code>.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">echo -n "IhrJJHMB4JmIUAPLuM35:1GbfxhkMT8COBB4JWY3pvQ" | ./metricbeat keystore add ES_API_KEY --stdin</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure you specify the <code class="literal">-n</code> parameter; otherwise, you will have
painful debugging sessions due to adding a newline at the end of
your API key.</p>
</div>
</div>
</li>
<li class="listitem">
<p>To see if both settings have been stored, run the following command:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat keystore list</pre>
</div>
</li>
<li class="listitem">
<p>To configure Metricbeat to output to Elasticsearch Service, edit the <code class="literal">metricbeat.yml</code>
configuration file. Add the following lines to the end of the file.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">cloud.id: ${CLOUD_ID}
output.elasticsearch:
  api_key: ${ES_API_KEY}</pre>
</div>
</li>
<li class="listitem">
<p>Finally, test if the configuration is working. If it is not working,
verify if you used the right credentials and add them again.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat test output</pre>
</div>
</li>
</ol>
</div>
<p>Now that the output is working, you are going to set up the AWS module.</p>
<h3><a id="aws-step-nine"></a>Step 9: Configure the AWS module<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/monitor-aws.asciidoc">edit</a></h3>
<p>To collect metrics from your AWS infrastructure, we&#8217;ll use the
<a href="/guide/en/beats/metricbeat/8.1/metricbeat-module-aws.html" class="ulink" target="_top">Metricbeat AWS</a> module. This module
contains many metricsets: <code class="literal">billing</code>, <code class="literal">cloudwatch</code>, <code class="literal">dynamodb</code>, <code class="literal">ebs</code>,
<code class="literal">ec2</code>, <code class="literal">elb</code>, <code class="literal">lambda</code>, and many more. Each metricset is created to help you
stream and process your data. In this tutorial, we&#8217;re going to show you a
few examples using the <code class="literal">ec2</code> and the <code class="literal">billing</code> metricsets.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Let&#8217;s enable the AWS module in Metricbeat.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat modules enable aws</pre>
</div>
</li>
<li class="listitem">
<p>Edit the <code class="literal">modules.d/aws.yml</code> file with the following configurations.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">- module: aws <a id="CO49-1"></a><i class="conum" data-value="1"></i>
  period: 24h <a id="CO49-2"></a><i class="conum" data-value="2"></i>
  metricsets:
    - billing <a id="CO49-3"></a><i class="conum" data-value="3"></i>
  credential_profile_name: mb-aws <a id="CO49-4"></a><i class="conum" data-value="4"></i>
  cost_explorer_config:
    group_by_dimension_keys:
      - "AZ"
      - "INSTANCE_TYPE"
      - "SERVICE"
    group_by_tag_keys:
      - "aws:createdBy"
- module: aws <a id="CO49-5"></a><i class="conum" data-value="1"></i>
  period: 300s <a id="CO49-6"></a><i class="conum" data-value="2"></i>
  metricsets:
    - ec2 <a id="CO49-7"></a><i class="conum" data-value="3"></i>
  credential_profile_name: mb-aws <a id="CO49-8"></a><i class="conum" data-value="4"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO49-1"><i class="conum" data-value="1"></i></a><a href="#CO49-5"></a></p>
</td>
<td align="left" valign="top">
<p>Defines the module that is going to be used.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO49-2"><i class="conum" data-value="2"></i></a><a href="#CO49-6"></a></p>
</td>
<td align="left" valign="top">
<p>Defines the period at which the metrics are going to be collected</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO49-3"><i class="conum" data-value="3"></i></a><a href="#CO49-7"></a></p>
</td>
<td align="left" valign="top">
<p>Defines the metricset that is going to be used.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO49-4"><i class="conum" data-value="4"></i></a><a href="#CO49-8"></a></p>
</td>
<td align="left" valign="top">
<p>This is the aws profile defined following the <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html" class="ulink" target="_top">AWS standard</a>.</p>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<p>Make sure that the AWS user used to collect the metrics from CloudWatch has at
least the following permissions attached to it:</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": [
                "ec2:DescribeInstances",
                "ec2:DescribeRegions",
                "cloudwatch:GetMetricData",
                "cloudwatch:ListMetrics",
                "sts:GetCallerIdentity",
                "iam:ListAccountAliases",
                "tag:getResources",
                "ce:GetCostAndUsage"
            ],
            "Effect": "Allow",
            "Resource": "*"
        }
    ]
}</pre>
</div>
<p>You can now start Metricbeat:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat -e</pre>
</div>
<h3><a id="aws-step-ten"></a>Step 10: Visualize metrics<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.1/docs/en/observability/monitor-aws.asciidoc">edit</a></h3>
<p>Now that the metrics are being streamed to Elasticsearch we can visualize them in
Kibana. In Kibana, open the main menu and click
<span class="strong strong"><strong>Metrics</strong></span>. Make sure to show the <span class="strong strong"><strong>AWS</strong></span> source and the <span class="strong strong"><strong>EC2 Instances</strong></span>:</p>
<div class="imageblock">
<div class="content">
<img src="EC2-instances.png" alt="Your EC2 Infrastructure">
</div>
</div>
<p>The metricsets we used in the previous steps also comes with prebuilt dashboard
that you can use to visualize the data. In Kibana, open the main menu and click
<span class="strong strong"><strong>Dashboard</strong></span>. Search for EC2 and select the dashboard called: <span class="strong strong"><strong>[Metricbeat
AWS] EC2 Overview</strong></span>:</p>
<div class="imageblock">
<div class="content">
<img src="ec2-dashboard.png" alt="EC2 Overview">
</div>
</div>
<p>If you want to track your billings on AWS, you can also check the
<span class="strong strong"><strong>[Metricbeat AWS] Billing Overview</strong></span> dashboard:</p>
<div class="imageblock">
<div class="content">
<img src="aws-billing.png" alt="Billing Overview">
</div>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="observability-tutorials.html">« Tutorials</a>
</span>
<span class="next">
<a href="monitor-gcp.html">Monitor Google Cloud Platform »</a>
</span>
</div>
</div>
</body>
</html>
