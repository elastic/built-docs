<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Monitor CloudTrail logs | Elastic Observability [8.15] | Elastic</title>
<meta class="elastic" name="content" content="Monitor CloudTrail logs | Elastic Observability [8.15]">

<link rel="home" href="index.html" title="Elastic Observability [8.15]"/>
<link rel="up" href="ingest-aws-firehose.html" title="Monitor Amazon Web Services (AWS) with Amazon Data Firehose"/>
<link rel="prev" href="monitor-amazon-vpc-flow-logs.html" title="Monitor Virtual Private Cloud (VPC) Flow Logs"/>
<link rel="next" href="monitor-aws-firewall-firehose.html" title="Monitor AWS Network Firewall logs"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Observability"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Observability/Guide/8.15"/>
<meta name="DC.subject" content="Observability"/>
<meta name="DC.identifier" content="8.15"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="monitor-amazon-vpc-flow-logs.html">« Monitor Virtual Private Cloud (VPC) Flow Logs</a>
</span>
<span class="next">
<a href="monitor-aws-firewall-firehose.html">Monitor AWS Network Firewall logs »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Observability [8.15]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="monitor-amazon-web-services.html">Amazon Web Services (AWS) monitoring</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="ingest-aws-firehose.html">Monitor Amazon Web Services (AWS) with Amazon Data Firehose</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Monitor CloudTrail logs</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.15/docs/en/observability/cloud-monitoring/aws/monitor-aws-cloudtrail-firehose.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="monitor-aws-cloudtrail-firehose"></a>Monitor CloudTrail logs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.15/docs/en/observability/cloud-monitoring/aws/monitor-aws-cloudtrail-firehose.asciidoc">edit</a></h3>
</div></div></div>

<p>In this section, you&#8217;ll learn how to monitor and analyze the CloudTrail logs you send to Elastic with Amazon Data Firehose. You will go through the following steps:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Install AWS integration in Kibana
</li>
<li class="listitem">
Export Cloudtrail events to CloudWatch
</li>
<li class="listitem">
Set up a Firehose delivery stream
</li>
<li class="listitem">
Set up a subscription filter to route Cloudtrail events to a delivery stream
</li>
<li class="listitem">
Visualize your CloudTrail logs in Kibana
</li>
</ul>
</div>
<h5><a id="firehose-cloudtrail-prerequisites"></a>Before you begin<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.15/docs/en/observability/cloud-monitoring/aws/monitor-aws-cloudtrail-firehose.asciidoc">edit</a></h5>
<p>We assume that you already have:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
An AWS account with permissions to pull the necessary data from AWS.
</li>
<li class="listitem">
A deployment using our hosted Elasticsearch Service on <a href="/cloud/elasticsearch-service/signup?page=docs&amp;placement=docs-body" class="ulink" target="_top">Elastic Cloud</a>. The deployment includes an Elasticsearch cluster for storing and searching your data, and Kibana for visualizing and managing your data. AWS Data Firehose works with Elastic Stack version 7.17 or greater, running on Elastic Cloud only.
</li>
</ul>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure the deployment is on AWS, because the Amazon Data Firehose delivery stream connects specifically to an endpoint that needs to be on AWS.</p>
</div>
</div>
<h5><a id="firehose-cloudtrail-step-one"></a>Step 1: Install AWS integration in Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.15/docs/en/observability/cloud-monitoring/aws/monitor-aws-cloudtrail-firehose.asciidoc">edit</a></h5>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Kibana, navigate to <span class="strong strong"><strong>Management</strong></span> &gt; <span class="strong strong"><strong>Integrations</strong></span> and browse the catalog to find the Amazon Data Firehose integration.
</li>
<li class="listitem">
Navigate to the <span class="strong strong"><strong>Settings</strong></span> tab and click <span class="strong strong"><strong>Install Amazon Data Firehose assets</strong></span>.
</li>
</ol>
</div>
<h5><a id="firehose-cloudtrail-step-two"></a>Step 2: Export Cloudtrail events to CloudWatch<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.15/docs/en/observability/cloud-monitoring/aws/monitor-aws-cloudtrail-firehose.asciidoc">edit</a></h5>
<div class="imageblock">
<div class="content">
<img src="firehose-cloudtrail-cloudwatch.png" alt="Cloudtrail to CloudWatch">
</div>
</div>
<p>To export CloudTrail logs to CloudWatch, you must set up a <span class="strong strong"><strong>trail</strong></span> through the following steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to the <a href="https://console.aws.amazon.com/" class="ulink" target="_top">AWS console</a> and navigate to CloudTrail.
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Create trail</strong></span> and configure the general details on the <span class="strong strong"><strong>Choose trail attributes</strong></span> panel, like:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Trail name
</li>
<li class="listitem">
<p>Storage location</p>
<p>By default, CloudTrail exports data to an S3 bucket. It isn’t possible to opt-out from S3.</p>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Specify the encryption options.</p>
<p>When exporting data from CloudTrail to S3, it is recommended to enable
<span class="strong strong"><strong>Log file SSE-KMS encryption</strong></span>. You can use an existing AWS KMS key, or create a new one.</p>
</li>
<li class="listitem">
<p>Enable <span class="strong strong"><strong>CloudWatch Logs</strong></span> and confirm the <span class="strong strong"><strong>Log group name</strong></span>.</p>
<p>CloudTrail offers the option to send events to CloudWatch as logs. You
must enable this option to forward the events to Amazon Data Firehose.</p>
<p>You also need to create an IAM Role, or select an existing one, to enable CloudTrail to put log events into a CloudWatch stream.</p>
</li>
<li class="listitem">
From the <span class="strong strong"><strong>Choose log events</strong></span> panel, select the event types you want to send to Elastic.
</li>
<li class="listitem">
Review the attributes and log events you have specified in the previous steps and click <span class="strong strong"><strong>Create trail</strong></span>.
</li>
<li class="listitem">
<p>Verify everything is working as expected.</p>
<p>Open the log group you just created on CloudWatch and make sure there are events from the CloudTrail you have just created.</p>
<div class="imageblock">
<div class="content">
<img src="firehose-verify-events-cloudwatch.png" alt="Verify events in CloudWatch">
</div>
</div>
</li>
</ol>
</div>
<h5><a id="firehose-cloudtrail-step-three"></a>Step 3: Set up a Firehose delivery stream<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.15/docs/en/observability/cloud-monitoring/aws/monitor-aws-cloudtrail-firehose.asciidoc">edit</a></h5>
<div class="imageblock">
<div class="content">
<img src="firehose-delivery-stream.png" alt="Firehose delivery stream">
</div>
</div>
<p>You now have a CloudWatch log group with events coming from CloudTrail.
For more information on how to set up a Amazon Data Firehose delivery stream to send data to Elastic Cloud, you can also check the <a class="xref" href="ingest-aws-firehose.html" title="Monitor Amazon Web Services (AWS) with Amazon Data Firehose">setup guide</a>.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Collect Elasticsearch endpoint and API key from your deployment on Elastic Cloud.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elasticsearch endpoint URL: Enter the Elasticsearch endpoint URL of your Elasticsearch cluster. To find the Elasticsearch endpoint, go to the Elastic Cloud console and select <span class="strong strong"><strong>Connection details</strong></span>.
</li>
<li class="listitem">
API key: Enter the encoded Elastic API key. To create an API key, go to the Elastic Cloud console, select <span class="strong strong"><strong>Connection details</strong></span> and click <span class="strong strong"><strong>Create and manage API keys</strong></span>. If you are using an API key with <span class="strong strong"><strong>Restrict privileges</strong></span>, make sure to review the Indices privileges to provide at least "auto_configure" &amp; "write" permissions for the indices you will be using with this delivery stream.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Set up the delivery stream by specifying the following data:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic endpoint URL
</li>
<li class="listitem">
API key
</li>
<li class="listitem">
Content encoding: gzip
</li>
<li class="listitem">
Retry duration: 60 (default)
</li>
<li class="listitem">
Backup settings: failed data only to s3 bucket
</li>
</ul>
</div>
</li>
</ol>
</div>
<p>You now have an Amazon Data Firehose delivery specified with:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
source: direct put
</li>
<li class="listitem">
destination: elastic
</li>
<li class="listitem">
parameters: es_datastream_name: logs-aws.cloudtrail-default
</li>
</ul>
</div>
<h5><a id="firehose-cloudtrail-step-four"></a>Step 4: Set up a subscription filter to route Cloudtrail events to a delivery stream<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.15/docs/en/observability/cloud-monitoring/aws/monitor-aws-cloudtrail-firehose.asciidoc">edit</a></h5>
<div class="imageblock">
<div class="content">
<img src="firehose-subscription-filter.png" alt="Firehose subscription filter">
</div>
</div>
<p>The Amazon Data Firehose delivery stream is ready to send logs to your Elastic Cloud deployment.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Visit the log group with the CloudTrail events.</p>
<p>Open the log group where the CloudTrail service is sending the
events. You must forward these events to an Elastic stack using the
Amazon Data Firehose delivery stream. CloudWatch log group offers a
<a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Subscriptions.html" class="ulink" target="_top">subscription filter</a> that allows you to choose log events from the log group and forward them to other services like Amazon Kinesis stream, an Amazon Data Firehose stream, or AWS Lambda.</p>
</li>
<li class="listitem">
<p>Create a subscription filter for Amazon Data Firehose by following these steps.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Choose the destination account.</p>
<p>Select the delivery stream you created in step 3.</p>
</li>
<li class="listitem">
<p>Grant permission.</p>
<p>Follow these steps to enable the CloudWatch service to send log events to the delivery stream in Amazon Data Firehose:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li class="listitem">
<p>Create a new role with a trust policy that allows CloudWatch to assume the role.</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "logs.eu-north-1.amazonaws.com"
            },
            "Action": "sts:AssumeRole",
            "Condition": {
                "StringLike": {
                    "aws:SourceArn": "arn:aws:logs:eu-north-1:&lt;YOUR ACCOUNT ID&gt;:*"
                }
            }
        }
    ]
}</pre>
</div>
</li>
<li class="listitem">
<p>Assign a new IAM policy to the role that permits ”putting records” into a
in Amazon Data Firehose delivery stream.</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "firehose:PutRecord",
            "Resource": "arn:aws:firehose:eu-north-1:&lt;YOUR ACCOUNT ID&gt;:deliverystream/mbranca-dev-cloudtrail-logs"
        }
    ]
}</pre>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<p>When the new role is ready, you can select it in the subscription filter. Select <span class="strong strong"><strong>Amazon CloudTrail</strong></span> in the log format option to configure log format and filters.</p>
<h6><a id="_verify"></a>Verify<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.15/docs/en/observability/cloud-monitoring/aws/monitor-aws-cloudtrail-firehose.asciidoc">edit</a></h6>
<p>To check if there are destination error logs, go to the AWS console, visit your Amazon Data Firehose delivery stream, and check for entries in the <span class="strong strong"><strong>Destination error logs</strong></span>.</p>
<p>If everything is correct, this list should be empty. If there’s an
error, you can check the details. The following example shows a delivery stream that fails to send records to the Elastic stack due to bad authentication settings:</p>
<div class="imageblock">
<div class="content">
<img src="firehose-failed-delivery-stream.png" alt="Firehose failed delivery stream">
</div>
</div>
<p>The Amazon Data Firehose delivery stream reports the number of failed deliveries and failure details.</p>
<h5><a id="firehose-cloudtrail-step-five"></a>Step 5: Visualize your CloudTrail logs in Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/8.15/docs/en/observability/cloud-monitoring/aws/monitor-aws-cloudtrail-firehose.asciidoc">edit</a></h5>
<p>With the new subscription filter running, CloudWatch starts routing new
CloudTrail log events to the Firehose delivery stream.</p>
<div class="imageblock">
<div class="content">
<img src="firehose-monitor-cloudtrail-logs.png" alt="Firehose monitor CloudTrail logs">
</div>
</div>
<p>Navigate to Kibana and choose among the following monitoring options:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p><span class="strong strong"><strong>Visualize your logs with Discover</strong></span></p>
<div class="imageblock">
<div class="content">
<img src="firehose-cloudtrail-discover.png" alt="Visualize CloudTrail logs with Disocver">
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Visualize your logs with Logs explorer</strong></span></p>
<div class="imageblock">
<div class="content">
<img src="firehose-cloudtrail-logsexplorer.png" alt="Visualize CloudTrail logs with Logs explorer">
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Visualize your logs with the CloudTrail Dashboard</strong></span></p>
<div class="imageblock">
<div class="content">
<img src="firehose-cloudtrail-dashboard.png" alt="Visualize CloudTrail logs with CloudTrail Dashboard">
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="monitor-amazon-vpc-flow-logs.html">« Monitor Virtual Private Cloud (VPC) Flow Logs</a>
</span>
<span class="next">
<a href="monitor-aws-firewall-firehose.html">Monitor AWS Network Firewall logs »</a>
</span>
</div>
</body>
</html>
