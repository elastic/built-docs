<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Known issues | Elastic Observability [master] | Elastic</title>
<meta class="elastic" name="content" content="Known issues | Elastic Observability [master]">

<link rel="home" href="index.html" title="Elastic Observability [master]"/>
<link rel="up" href="apm.html" title="Application performance monitoring (APM)"/>
<link rel="prev" href="apm-release-notes-8.0.html" title="APM version 8.0"/>
<link rel="next" href="logs-checklist.html" title="Log monitoring"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Observability"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Observability/Guide/master"/>
<meta name="DC.subject" content="Observability"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="apm-release-notes-8.0.html">« APM version 8.0</a>
</span>
<span class="next">
<a href="logs-checklist.html">Log monitoring »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Observability [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="apm.html">Application performance monitoring (APM)</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Known issues</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/known-issues.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="apm-known-issues"></a>Known issues<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/known-issues.asciidoc">edit</a></h2>
</div></div></div>
<p>APM has the following known issues:</p>
<p><a id="broken-apm-anomaly-rule"></a><span class="strong strong"><strong>Upgrading to v8.13.0 to v8.13.2 breaks APM anomaly rules</strong></span><br>
<em>Elastic Stack versions: 8.13.0, 8.13.1, 8.13.2</em><br>
<em>Fixed in Elastic Stack version 8.13.3</em></p>
<p>This issue occurs when upgrading the Elastic Stack to version 8.13.0, 8.13.1, or 8.13.2.
This issue may go unnoticed unless you actively monitor your Kibana logs.
The following log indicates the presence of this issue:</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">"params invalid: [anomalyDetectorTypes]: expected value of type [array] but got [undefined]"</pre>
</div>
<p>This issue occurs because a non-optional parameter, <code class="literal">anomalyDetectorTypes</code> was added in 8.13.0 without
the presence of an automation migration script. This breaks pre-existing rules as they do not have this parameter
and will fail validation. This issue is fixed in v8.13.3.</p>
<p>There are three ways to fix this error:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Upgrade to version 8.13.3
</li>
<li class="listitem">
Fix broken anomaly rules in the APM UI (no upgrade required)
</li>
<li class="listitem">
Fix broken anomaly rules with Kibana APIs (no upgrade required)
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Fix broken anomaly rules in the APM UI</strong></span></p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
From any APM page in Kibana, select <span class="strong strong"><strong>Alerts and rules</strong></span> &#8594; <span class="strong strong"><strong>Manage rules</strong></span>.
</li>
<li class="listitem">
Filter your rules by setting <span class="strong strong"><strong>Type</strong></span> to <span class="strong strong"><strong>APM Anomaly</strong></span>.
</li>
<li class="listitem">
For each anomaly rule in the list, select the pencil icon to edit the rule.
</li>
<li class="listitem">
<p>Add one or more <span class="strong strong"><strong>DETECTOR TYPES</strong></span> to the rule.</p>
<p>The detector type determines when the anomaly rule triggers. For example, a latency anomaly rule will
trigger when the latency of the service being monitored is abnormal.
Supported detector types are <code class="literal">latency</code>, <code class="literal">throughput</code>, and <code class="literal">failed transaction rate</code>.</p>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Save</strong></span>.
</li>
</ol>
</div>
<p><span class="strong strong"><strong>Fix broken anomaly rules with Kibana APIs</strong></span></p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Find broken rules</p>
<div class="exampleblock">
<div class="content">
<p>To identify rules in this exact state, you can use the <a href="/guide/en/kibana/master/find-rules-api.html" class="ulink" target="_top">find rules endpoint</a> and search for the APM anomaly rule type as well as this exact error message indicating that the rule is in the broken state. We will also use the <code class="literal">fields</code> parameter to specify only the fields required when making the update request later.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">search_fields=alertTypeId</code>
</li>
<li class="listitem">
<code class="literal">search=apm.anomaly</code>
</li>
<li class="listitem">
<code class="literal">filter=alert.attributes.executionStatus.error.message:"params invalid: [anomalyDetectorTypes]: expected value of type [array] but got [undefined]"</code>
</li>
<li class="listitem">
<code class="literal">fields=[id, name, actions, tags, schedule, notify_when, throttle, params]</code>
</li>
</ul>
</div>
<p>The encoded request might look something like this:</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">curl -u "$KIBANA_USER":"$KIBANA_PASSWORD" "$KIBANA_URL/api/alerting/rules/_find?search_fields=alertTypeId&amp;search=apm.anomaly&amp;filter=alert.attributes.executionStatus.error.message%3A%22params%20invalid%3A%20%5BanomalyDetectorTypes%5D%3A%20expected%20value%20of%20type%20%5Barray%5D%20but%20got%20%5Bundefined%5D%22&amp;fields=id&amp;fields=name&amp;fields=actions&amp;fields=tags&amp;fields=schedule&amp;fields=notify_when&amp;fields=throttle&amp;fields=params"</pre>
</div>
<details>
<summary class="title">Example result:</summary>
<div class="content">
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "page": 1,
  "total": 1,
  "per_page": 10,
  "data": [
    {
      "id": "d85e54de-f96a-49b5-99d4-63956f90a6eb",
      "name": "APM Anomaly Jason Test FAILING [2]",
      "tags": [
        "test",
        "jasonrhodes"
      ],
      "throttle": null,
      "schedule": {
        "interval": "1m"
      },
      "params": {
        "windowSize": 30,
        "windowUnit": "m",
        "anomalySeverityType": "warning",
        "environment": "ENVIRONMENT_ALL"
      },
      "notify_when": null,
      "actions": []
    }
  ]
}</pre>
</div>
</div>
</details>
</div>
</div>
</li>
<li class="listitem">
<p>Prepare the update JSON doc(s)</p>
<div class="exampleblock">
<div class="content">
<p>For each broken rule found, create a JSON rule document with what was returned from the API in the previous step. You will need to make two changes to each document:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Remove the <code class="literal">id</code> key but keep the value connected to this document (e.g. rename the file to <code class="literal">{id}.json</code>). <span class="strong strong"><strong>The <code class="literal">id</code> cannot be sent as part of the request body for the PUT request, but you will need it for the URL path.</strong></span>
</li>
<li class="listitem">
<p>Add the <code class="literal">"anomalyDetectorTypes"</code> to the <code class="literal">"params"</code> block, using the default value as seen below to mimic the pre-8.13 behavior:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "params": {
    // ... other existing params should stay here,
    // with the required one added to this object
    "anomalyDetectorTypes": [
      "txLatency",
      "txThroughput",
      "txFailureRate"
    ]
  }
}</pre>
</div>
</li>
</ol>
</div>
</div>
</div>
</li>
<li class="listitem">
<p>Update each rule using the <code class="literal">PUT /api/alerting/rule/{id}</code> API</p>
<div class="exampleblock">
<div class="content">
<p>For each rule, submit a PUT request to the <a href="/guide/en/kibana/master/update-rule-api.html" class="ulink" target="_top">update rule endpoint</a> using that rule&#8217;s ID and its stored update document from the previous step. For example, assuming the first broken rule&#8217;s ID is <code class="literal">046c0d4f</code>:</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">curl -u "$KIBANA_USER":"$KIBANA_PASSWORD" -XPUT "$KIBANA_URL/api/alerting/rule/046c0d4f" -H 'Content-Type: application/json' -H 'kbn-xsrf: rule-update' -d @046c0d4f.json</pre>
</div>
<p>Once the PUT request executes successfully, the rule will no longer be broken.</p>
</div>
</div>
</li>
</ol>
</div>
<p><a id="apm-empty-metricset-values"></a><span class="strong strong"><strong>Upgrading APM Server to 8.11+ might break event intake from older APM Java agents</strong></span><br>
<em>APM Server versions: &gt;=8.11.0</em><br>
<em>Elastic APM Java agent versions: &lt; 1.43.0</em></p>
<p>If you are using APM Server (&gt; v8.11.0) and the Elastic APM Java agent (&lt; v1.43.0),
the agent may be sending empty histogram metricsets.</p>
<p>In previous APM Server versions some data validation was not properly applied,
leading the APM Server to accept empty histogram metricsets where it shouldn&#8217;t.
This bug was fixed in the APM Server in 8.11.0.</p>
<p>The APM Java agent (&lt; v1.43.0) was sending this kind of invalid data under certain circumstances.
If you upgrade the APM Server to v8.11.0+ <em>without</em> upgrading the APM Java agent version,
metricsets can be rejected by the APM Server and can result in additional error logs in the Java agent.</p>
<p>The fix is to upgrade the Elastic APM Java agent to a version &gt;= 1.43.0.
Find details in <a href="https://github.com/elastic/apm-data/pull/157" class="ulink" target="_top">elastic/apm-data#157</a>.</p>
<p><span class="strong strong"><strong>traces-apm@custom ingest pipeline applied to certain data streams unintentionally</strong></span><br>
<em>APM Server versions: 8.12.0</em><br></p>
<p>If you&#8217;re using the Elastic APM Server v8.12.0,
the <code class="literal">traces-apm@custom</code> ingest pipeline is now additionally applied to data streams <code class="literal">traces-apm.sampled-*</code>
and <code class="literal">traces-apm.rum-*</code>, and applied twice for <code class="literal">traces-apm-*</code>. This bug impacts users with a non-empty <code class="literal">traces-apm@custom</code> ingest pipeline.</p>
<p>If you rely on this unintended behavior in 8.12.0, please rename your pipeline to <code class="literal">traces-apm.integration@custom</code> to preserve this behavior in later versions.</p>
<p>A fix was released in 8.12.1: <a href="https://github.com/elastic/kibana/pull/175448" class="ulink" target="_top">elastic/kibana#175448</a>.</p>
<p><span class="strong strong"><strong>Ingesting new JVM metrics in 8.9 and 8.10 breaks upgrade to 8.11 and stops ingestion</strong></span><br>
<em>APM Server versions: 8.11.0, 8.11.1</em><br>
<em>Elastic APM Java agent versions: 1.39.0+</em></p>
<p>If you&#8217;re using the Elastic APM Java agent v1.39.0+ to send new JVM metrics to APM Server v8.9.x and v8.10.x,
upgrading to 8.11.0 or 8.11.1 will silently fail and stop ingesting APM metrics.</p>
<p>After upgrading, you will see the following errors:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>APM Server error logs:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">failed to index document in 'metrics-apm.internal-default' (fail_processor_exception): Document produced by APM Server v8.11.1, which is newer than the installed APM integration (v8.10.3-preview-1695284222). The APM integration must be upgraded.</pre>
</div>
</li>
<li class="listitem">
<p>Fleet error on integration package upgrade:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">Failed installing package [apm] due to error: [ResponseError: mapper_parsing_exception
	Root causes:
		mapper_parsing_exception: Field [jvm.memory.non_heap.pool.committed] attempted to shadow a time_series_metric]</pre>
</div>
</li>
</ul>
</div>
<p>A fix was released in 8.11.2: <a href="https://github.com/elastic/kibana/pull/171712" class="ulink" target="_top">elastic/kibana#171712</a>.</p>
<p><span class="strong strong"><strong>APM integration package upgrade through Fleet causes excessive data stream rollovers</strong></span><br>
<em>APM Server versions: &lt;= 8.12.1 +</em></p>
<p>If you&#8217;re upgrading APM integration package to any versions &lt;= 8.12.1,
in some rare cases, the upgrade fails with a mapping conflict error. The upgrade process keeps rolling
over the data stream in an unsuccessful attempt to work around the error. As a result, many empty backing indices for
APM data streams are created.</p>
<p>During upgrade, you will see errors similar to the one below:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Fleet error on integration package upgrade:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">Mappings update for metrics-apm.service_destination.10m-default failed due to ResponseError: illegal_argument_exception
	Root causes:
		illegal_argument_exception: Mapper for [metricset.interval] conflicts with existing mapper:
	Cannot update parameter [value] from [10m] to [null]</pre>
</div>
</li>
</ul>
</div>
<p>A fix was released in 8.12.2: <a href="https://github.com/elastic/apm-server/pull/12219" class="ulink" target="_top">elastic/apm-server#12219</a>.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="apm-release-notes-8.0.html">« APM version 8.0</a>
</span>
<span class="next">
<a href="logs-checklist.html">Log monitoring »</a>
</span>
</div>
</body>
</html>
