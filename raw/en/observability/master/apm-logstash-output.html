<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Configure the Logstash output | Elastic Observability [master] | Elastic</title>
<meta class="elastic" name="content" content="Configure the Logstash output | Elastic Observability [master]">

<link rel="home" href="index.html" title="Elastic Observability [master]"/>
<link rel="up" href="apm-configuring-output.html" title="Configure the output"/>
<link rel="prev" href="apm-elasticsearch-output.html" title="Configure the Elasticsearch output"/>
<link rel="next" href="apm-kafka-output.html" title="Configure the Kafka output"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Observability"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Observability/Guide/master"/>
<meta name="DC.subject" content="Observability"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="apm-elasticsearch-output.html">« Configure the Elasticsearch output</a>
</span>
<span class="next">
<a href="apm-kafka-output.html">Configure the Kafka output »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Observability [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="apm.html">Application performance monitoring (APM)</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="apm-configuring-howto-apm-server.html">Configure</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="apm-configuring-output.html">Configure the output</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Configure the Logstash output</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="apm-logstash-output"></a>Configure the Logstash output<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h4>
</div></div></div>

<div class="sidebar">
<div class="titlepage"></div>
<p><span class="image"><img src="./binary-yes-fm-no.svg" alt="supported deployment methods"></span></p>
<p>The Logstash output is not yet supported by Fleet-managed APM Server.</p>
</div>
<p>Logstash allows for additional processing and routing of APM events.
The Logstash output sends events directly to Logstash using the lumberjack
protocol, which runs over TCP.</p>
<h5><a id="_send_events_to_logstash"></a>Send events to Logstash<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h5>
<p>To send events to Logstash, you must:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="apm-logstash-output.html#apm-ls-output-config" title="Logstash output configuration">Enable the Logstash output in APM Server</a>
</li>
<li class="listitem">
<a class="xref" href="apm-logstash-output.html#apm-ls-kib-config" title="Kibana endpoint configuration">Enable the Kibana endpoint in APM Server</a>
</li>
<li class="listitem">
<a class="xref" href="apm-logstash-output.html#apm-ls-config-pipeline" title="Logstash configuration pipeline">Create a Logstash configuration pipeline in Logstash</a>
</li>
</ol>
</div>
<h6><a id="apm-ls-output-config"></a>Logstash output configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
<p>To enable the Logstash output in APM Server,
edit the <code class="literal">apm-server.yml</code> file to:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Disable the Elasticsearch output by commenting it out and
</li>
<li class="listitem">
<p>Enable the Logstash output by uncommenting the Logstash section and setting <code class="literal">enabled</code> to <code class="literal">true</code>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">output.logstash:
  enabled: true
  hosts: ["localhost:5044"] <a id="CO41-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO41-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">hosts</code> option specifies the Logstash server and the port (<code class="literal">5044</code>) where Logstash is configured to listen for incoming
APM Server connections.</p>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<h6><a id="apm-ls-kib-config"></a>Kibana endpoint configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
<p>APM Server uses the APM integration to set up and manage APM templates, policies, and pipelines.
To confirm the integration is installed, APM Server polls either Elasticsearch or Kibana on startup.
When using a non-Elasticsearch output, APM Server requires access to Kibana via the
<a class="xref" href="apm-setup-kibana-endpoint.html" title="Configure the Kibana endpoint">Kibana endpoint</a>.</p>
<p>Example configuration:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">apm-server:
  kibana:
    enabled: true
    host: "https://..."
    username: "elastic"
    password: "xxx"</pre>
</div>
<h6><a id="apm-ls-config-pipeline"></a>Logstash configuration pipeline<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
<p>Finally, you must create a Logstash configuration pipeline that listens for incoming
APM Server connections and indexes received events into Elasticsearch.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Use the <a href="/guide/en/logstash/master/plugins-inputs-elastic_agent.html" class="ulink" target="_top">Elastic Agent input plugin</a> to configure
Logstash to receive events from the APM Server. A minimal <code class="literal">input</code> config might look like this:</p>
<div class="pre_wrapper lang-conf">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-conf">input {
  elastic_agent {
    port =&gt; 5044
  }
}</pre>
</div>
</li>
<li class="listitem">
<p>Use the <a href="/guide/en/logstash/master/plugins-outputs-elasticsearch.html" class="ulink" target="_top">Elasticsearch output plugin</a> to send
events to Elasticsearch for indexing. A minimal <code class="literal">output</code> config might look like this:</p>
<div class="pre_wrapper lang-conf">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-conf">output {
  elasticsearch {
    data_stream =&gt; "true" <a id="CO42-1"></a><i class="conum" data-value="1"></i>
    cloud_id =&gt; "YOUR_CLOUD_ID_HERE" <a id="CO42-2"></a><i class="conum" data-value="2"></i>
    cloud_auth =&gt; "YOUR_CLOUD_AUTH_HERE" <a id="CO42-3"></a><i class="conum" data-value="2"></i>
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO42-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Enables indexing into Elasticsearch data streams.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO42-2"><i class="conum" data-value="2"></i></a><a href="#CO42-3"></a></p>
</td>
<td align="left" valign="top">
<p>This example assumes you&#8217;re sending data to Elastic Cloud. If you&#8217;re using a self-hosted version of Elasticsearch, use <code class="literal">hosts</code> instead. See <a href="/guide/en/logstash/master/plugins-outputs-elasticsearch.html" class="ulink" target="_top">Elasticsearch output plugin</a> for more information.</p>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<p>Here&#8217;s what your basic Logstash configuration file will look like when we put everything together:</p>
<div class="pre_wrapper lang-conf">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-conf">input {
  elastic_agent {
    port =&gt; 5044
  }
}

output {
  elasticsearch {
    data_stream =&gt; "true"
    cloud_id =&gt; "YOUR_CLOUD_ID_HERE"
    cloud_auth =&gt; "YOUR_CLOUD_AUTH_HERE"
  }
}</pre>
</div>
<h5><a id="_accessing_the_metadata_field"></a>Accessing the @metadata field<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h5>
<p>Every event sent to Logstash contains a special field called
<a href="/guide/en/logstash/master/event-dependent-configuration.html#metadata" class="ulink" target="_top"><code class="literal">@metadata</code></a> that you can
use in Logstash for conditionals, filtering, indexing and more.
APM Server sends the following <code class="literal">@metadata</code> to Logstash:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
    ...
    "@metadata": {
      "beat": "apm-server", <a id="CO43-1"></a><i class="conum" data-value="1"></i>
      "version": "8.16.0" <a id="CO43-2"></a><i class="conum" data-value="2"></i>
    }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>To change the default <code class="literal">apm-server</code> value, set the
<a class="xref" href="apm-logstash-output.html#apm-logstash-index" title="index"><code class="literal">index</code></a> option in the APM Server config file.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The current version of APM Server.</p>
</td>
</tr>
</table>
</div>
<p>In addition to <code class="literal">@metadata</code>, APM Server provides other potentially useful fields, like the
<code class="literal">data_stream</code> field, which can be used to conditionally operate on
<a href="/guide/en/observability/master/apm-data-model.html" class="ulink" target="_top">event types</a>, namespaces, or datasets.</p>
<p>As an example, you might want to use Logstash to route all <code class="literal">metric</code> events to the same custom metrics data stream,
rather than to service-specific data streams:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">output {
  if [@metadata][beat] == "apm-server" { <a id="CO44-1"></a><i class="conum" data-value="1"></i>
    if [data_stream][type] == "metrics" { <a id="CO44-2"></a><i class="conum" data-value="2"></i>
      elasticsearch {
        index =&gt; "%{[data_stream][type]}-custom-%{[data_stream][namespace]}" <a id="CO44-3"></a><i class="conum" data-value="3"></i>
        action =&gt; "create" <a id="CO44-4"></a><i class="conum" data-value="4"></i>
        cloud_id =&gt; "${CLOUD_ID}" <a id="CO44-5"></a><i class="conum" data-value="5"></i>
        cloud_auth =&gt; "${CLOUD_AUTH}" <a id="CO44-6"></a><i class="conum" data-value="5"></i>
      }
    } else {
      elasticsearch {
        data_stream =&gt; "true" <a id="CO44-7"></a><i class="conum" data-value="6"></i>
        cloud_id =&gt; "${CLOUD_ID}"
        cloud_auth =&gt; "${CLOUD_AUTH}"
      }
    }
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO44-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Only apply this output if the data is being sent from the APM Server</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO44-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Determine if the event type is <code class="literal">metric</code></p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO44-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>If the event type is <code class="literal">metric</code>, output to a custom data stream: <code class="literal">metrics-custom-&lt;YOUR_NAMESPACE&gt;</code></p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO44-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>You must explicitly set <code class="literal">action</code> to `create when using Logstash to output an index to a data stream</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO44-5"><i class="conum" data-value="5"></i></a><a href="#CO44-6"></a></p>
</td>
<td align="left" valign="top">
<p>In this example, <code class="literal">cloud_id</code> and <code class="literal">cloud_auth</code> are stored as <a href="/guide/en/logstash/master/environment-variables.html" class="ulink" target="_top">environment variables</a></p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO44-7"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>For all other event types, index data directly into the predefined APM data steams</p>
</td>
</tr>
</table>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_compatibility_2"></a>Compatibility<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h5>
</div></div></div>
<p>This output works with all compatible versions of Logstash. See the
<a href="/support/matrix#matrix_compatibility" class="ulink" target="_top">Elastic Support
Matrix</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_configuration_options_4"></a>Configuration options<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h5>
</div></div></div>
<p>You can specify the following options in the <code class="literal">logstash</code> section of the
<code class="literal">apm-server.yml</code> config file:</p>
<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_enabled_3"></a><code class="literal">enabled</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>The enabled config is a boolean setting to enable or disable the output. If set
to false, the output is disabled.</p>
<p>The default value is <code class="literal">false</code>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="apm-hosts"></a><code class="literal">hosts</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>The list of known Logstash servers to connect to. If load balancing is disabled, but
multiple hosts are configured, one host is selected randomly (there is no precedence).
If one host becomes unreachable, another one is selected randomly.</p>
<p>All entries in this list can contain a port number. The default port number 5044 will be used if no number is given.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_compression_level_2"></a><code class="literal">compression_level</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>The gzip compression level. Setting this value to 0 disables compression.
The compression level must be in the range of 1 (best speed) to 9 (best compression).</p>
<p>Increasing the compression level will reduce the network usage but will increase the CPU usage.</p>
<p>The default value is 3.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_escape_html_2"></a><code class="literal">escape_html</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>Configure escaping of HTML in strings. Set to <code class="literal">true</code> to enable escaping.</p>
<p>The default value is <code class="literal">false</code>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_worker"></a><code class="literal">worker</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>The number of workers per configured host publishing events to Logstash. This
is best used with load balancing mode enabled. Example: If you have 2 hosts and
3 workers, in total 6 workers are started (3 for each host).</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="apm-loadbalance"></a><code class="literal">loadbalance</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>If set to true and multiple Logstash hosts are configured, the output plugin
load balances published events onto all Logstash hosts. If set to false,
the output plugin sends all events to only one host (determined at random) and
will switch to another host if the selected one becomes unresponsive. The default value is false.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">output.logstash:
  hosts: ["localhost:5044", "localhost:5045"]
  loadbalance: true
  index: apm-server</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_ttl"></a><code class="literal">ttl</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>Time to live for a connection to Logstash after which the connection will be re-established.
Useful when Logstash hosts represent load balancers. Since the connections to Logstash hosts
are sticky, operating behind load balancers can lead to uneven load distribution between the instances.
Specifying a TTL on the connection allows to achieve equal connection distribution between the
instances.  Specifying a TTL of 0 will disable this feature.</p>
<p>The default value is 0.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The "ttl" option is not yet supported on an asynchronous Logstash client (one with the "pipelining" option set).</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_pipelining"></a><code class="literal">pipelining</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>Configures the number of batches to be sent asynchronously to Logstash while waiting
for ACK from Logstash. Output only becomes blocking once number of <code class="literal">pipelining</code>
batches have been written. Pipelining is disabled if a value of 0 is
configured. The default value is 2.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_proxy_url_2"></a><code class="literal">proxy_url</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>The URL of the SOCKS5 proxy to use when connecting to the Logstash servers. The
value must be a URL with a scheme of <code class="literal">socks5://</code>. The protocol used to
communicate to Logstash is not based on HTTP so a web-proxy cannot be used.</p>
<p>If the SOCKS5 proxy server requires client authentication, then a username and
password can be embedded in the URL as shown in the example.</p>
<p>When using a proxy, hostnames are resolved on the proxy server instead of on the
client. You can change this behavior by setting the
<a class="xref" href="apm-logstash-output.html#apm-logstash-proxy-use-local-resolver" title="proxy_use_local_resolver"><code class="literal">proxy_use_local_resolver</code></a> option.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">output.logstash:
  hosts: ["remote-host:5044"]
  proxy_url: socks5://user:password@socks5-proxy:2233</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="apm-logstash-proxy-use-local-resolver"></a><code class="literal">proxy_use_local_resolver</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>The <code class="literal">proxy_use_local_resolver</code> option determines if Logstash hostnames are
resolved locally when using a proxy. The default value is false, which means
that when a proxy is used the name resolution occurs on the proxy server.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="apm-logstash-index"></a><code class="literal">index</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>The index root name to write events to. The default is <code class="literal">apm-server</code>. For
example <code class="literal">"apm"</code> generates <code class="literal">"[apm-]8.16.0-YYYY.MM.DD"</code>
indices (for example, <code class="literal">"apm-8.16.0-2017.04.26"</code>).</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This parameter&#8217;s value will be assigned to the <code class="literal">metadata.beat</code> field. It
can then be accessed in Logstash&#8217;s output section as <code class="literal">%{[@metadata][beat]}</code>.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_ssl_2"></a><code class="literal">ssl</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>Configuration options for SSL parameters like the root CA for Logstash connections. See
<a class="xref" href="apm-configuration-ssl.html" title="SSL/TLS output settings">SSL/TLS output settings</a> for more information. To use SSL, you must also configure the
<a href="/guide/en/logstash/master/plugins-inputs-beats.html" class="ulink" target="_top">Beats input plugin for Logstash</a> to use SSL/TLS.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_timeout_2"></a><code class="literal">timeout</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>The number of seconds to wait for responses from the Logstash server before timing out. The default is 30 (seconds).</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_max_retries_2"></a><code class="literal">max_retries</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>The number of times to retry publishing an event after a publishing failure.
After the specified number of retries, the events are typically dropped.</p>
<p>Set <code class="literal">max_retries</code> to a value less than 0 to retry until all events are published.</p>
<p>The default is 3.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_bulk_max_size"></a><code class="literal">bulk_max_size</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>The maximum number of events to bulk in a single Logstash request. The default is 2048.</p>
<p>If the Beat sends single events, the events are collected into batches. If the Beat publishes
a large batch of events (larger than the value specified by <code class="literal">bulk_max_size</code>), the batch is
split.</p>
<p>Specifying a larger batch size can improve performance by lowering the overhead of sending events.
However big batch sizes can also increase processing times, which might result in
API errors, killed connections, timed-out publishing requests, and, ultimately, lower
throughput.</p>
<p>Setting <code class="literal">bulk_max_size</code> to values less than or equal to 0 disables the
splitting of batches. When splitting is disabled, the queue decides on the
number of events to be contained in a batch.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_slow_start"></a><code class="literal">slow_start</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>If enabled, only a subset of events in a batch of events is transferred per transaction.
The number of events to be sent increases up to <code class="literal">bulk_max_size</code> if no error is encountered.
On error, the number of events per transaction is reduced again.</p>
<p>The default is <code class="literal">false</code>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_backoff_init_2"></a><code class="literal">backoff.init</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>The number of seconds to wait before trying to reconnect to Logstash after
a network error. After waiting <code class="literal">backoff.init</code> seconds, APM Server tries to
reconnect. If the attempt fails, the backoff timer is increased exponentially up
to <code class="literal">backoff.max</code>. After a successful connection, the backoff timer is reset. The
default is <code class="literal">1s</code>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_backoff_max_2"></a><code class="literal">backoff.max</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/configure/outputs/logstash.asciidoc">edit</a></h6>
</div></div></div>
<p>The maximum number of seconds to wait before attempting to connect to
Logstash after a network error. The default is <code class="literal">60s</code>.</p>
<h5><a id="apm-configuring-ssl-logstash"></a>Secure communication with Logstash<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/shared-ssl-logstash-config.asciidoc">edit</a></h5>
<p>You can use SSL mutual authentication to secure connections between APM Server and Logstash. This ensures that
APM Server sends encrypted data to trusted Logstash servers only, and that the Logstash server receives data from
trusted APM Server clients only.</p>
<p>To use SSL mutual authentication:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create a certificate authority (CA) and use it to sign the certificates that you plan to use for
APM Server and Logstash. Creating a correct SSL/TLS infrastructure is outside the scope of this
document. There are many online resources available that describe how to create certificates.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you are using security features, you can use the
<a href="/guide/en/elasticsearch/reference/master/certutil.html" class="ulink" target="_top"><code class="literal">elasticsearch-certutil</code> tool</a> to generate certificates.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Configure APM Server to use SSL. In the <code class="literal">apm-server.yml</code> config file, specify the following settings under
<code class="literal">ssl</code>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">certificate_authorities</code>: Configures APM Server to trust any certificates signed by the specified CA. If
<code class="literal">certificate_authorities</code> is empty or not set, the trusted certificate authorities of the host system are used.
</li>
<li class="listitem">
<p><code class="literal">certificate</code> and <code class="literal">key</code>: Specifies the certificate and key that APM Server uses to authenticate with
Logstash.</p>
<p>For example:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">output.logstash:
  hosts: ["logs.mycompany.com:5044"]
  ssl.certificate_authorities: ["/etc/ca.crt"]
  ssl.certificate: "/etc/client.crt"
  ssl.key: "/etc/client.key"</pre>
</div>
<p>For more information about these configuration options, see <a class="xref" href="apm-configuration-ssl.html" title="SSL/TLS output settings">SSL/TLS output settings</a>.</p>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Configure Logstash to use SSL. In the Logstash config file, specify the following settings for the <a href="/guide/en/logstash/master/plugins-inputs-beats.html" class="ulink" target="_top">Beats input plugin for Logstash</a>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">ssl</code>: When set to true, enables Logstash to use SSL/TLS.
</li>
<li class="listitem">
<code class="literal">ssl_certificate_authorities</code>: Configures Logstash to trust any certificates signed by the specified CA.
</li>
<li class="listitem">
<code class="literal">ssl_certificate</code> and <code class="literal">ssl_key</code>: Specify the certificate and key that Logstash uses to authenticate with the client.
</li>
<li class="listitem">
<p><code class="literal">ssl_verify_mode</code>: Specifies whether the Logstash server verifies the client certificate against the CA. You
need to specify either <code class="literal">peer</code> or <code class="literal">force_peer</code> to make the server ask for the certificate and validate it. If you
specify <code class="literal">force_peer</code>, and APM Server doesn&#8217;t provide a certificate, the Logstash connection will be closed. If you choose not to use <a href="/guide/en/elasticsearch/reference/master/certutil.html" class="ulink" target="_top"><code class="literal">certutil</code></a>, the certificates that you obtain must allow for both <code class="literal">clientAuth</code> and <code class="literal">serverAuth</code> if the extended key usage extension is present.</p>
<p>For example:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">input {
  beats {
    port =&gt; 5044
    ssl =&gt; true
    ssl_certificate_authorities =&gt; ["/etc/ca.crt"]
    ssl_certificate =&gt; "/etc/server.crt"
    ssl_key =&gt; "/etc/server.key"
    ssl_verify_mode =&gt; "force_peer"
  }
}</pre>
</div>
<p>For more information about these options, see the
<a href="/guide/en/logstash/master/plugins-inputs-beats.html" class="ulink" target="_top">documentation for the Beats input plugin</a>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<h6><a id="apm-testing-ssl-logstash"></a>Validate the Logstash server&#8217;s certificate<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/shared-ssl-logstash-config.asciidoc">edit</a></h6>
<p>Before running APM Server, you should validate the Logstash server&#8217;s certificate. You can use <code class="literal">curl</code> to validate the certificate even though the protocol used to communicate with Logstash is not based on HTTP. For example:</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">curl -v --cacert ca.crt https://logs.mycompany.com:5044</pre>
</div>
<p>If the test is successful, you&#8217;ll receive an empty response error:</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">* Rebuilt URL to: https://logs.mycompany.com:5044/
*   Trying 192.168.99.100...
* Connected to logs.mycompany.com (192.168.99.100) port 5044 (#0)
* TLS 1.2 connection using TLS_DHE_RSA_WITH_AES_256_CBC_SHA
* Server certificate: logs.mycompany.com
* Server certificate: mycompany.com
&gt; GET / HTTP/1.1
&gt; Host: logs.mycompany.com:5044
&gt; User-Agent: curl/7.43.0
&gt; Accept: */*
&gt;
* Empty reply from server
* Connection #0 to host logs.mycompany.com left intact
curl: (52) Empty reply from server</pre>
</div>
<p>The following example uses the IP address rather than the hostname to validate the certificate:</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">curl -v --cacert ca.crt https://192.168.99.100:5044</pre>
</div>
<p>Validation for this test fails because the certificate is not valid for the specified IP address. It&#8217;s only valid for the <code class="literal">logs.mycompany.com</code>, the hostname that appears in the Subject field of the certificate.</p>
<div class="pre_wrapper lang-shell">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-shell">* Rebuilt URL to: https://192.168.99.100:5044/
*   Trying 192.168.99.100...
* Connected to 192.168.99.100 (192.168.99.100) port 5044 (#0)
* WARNING: using IP address, SNI is being disabled by the OS.
* SSL: certificate verification failed (result: 5)
* Closing connection 0
curl: (51) SSL: certificate verification failed (result: 5)</pre>
</div>
<p>See the <a class="xref" href="apm-common-problems.html#apm-ssl-client-fails" title="SSL client fails to connect">troubleshooting docs</a> for info about resolving this issue.</p>
<h6><a id="_test_the_apm_server_to_logstash_connection"></a>Test the APM Server to Logstash connection<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/apm/shared-ssl-logstash-config.asciidoc">edit</a></h6>
<p>If you have APM Server running as a service, first stop the service. Then test your setup by running APM Server in
the foreground so you can quickly see any errors that occur:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">apm-server -c apm-server.yml -e -v</pre>
</div>
<p>Any errors will be printed to the console. See the <a class="xref" href="apm-common-problems.html#apm-ssl-client-fails" title="SSL client fails to connect">troubleshooting docs</a> for info about
resolving common errors.</p>
</div>

</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="apm-elasticsearch-output.html">« Configure the Elasticsearch output</a>
</span>
<span class="next">
<a href="apm-kafka-output.html">Configure the Kafka output »</a>
</span>
</div>
</body>
</html>
