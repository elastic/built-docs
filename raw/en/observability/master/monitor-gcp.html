<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Monitor Google Cloud Platform | Observability Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="Monitor Google Cloud Platform | Observability Guide [master]">

<link rel="home" href="index.html" title="Observability Guide [master]"/>
<link rel="up" href="observability-tutorials.html" title="Tutorials"/>
<link rel="prev" href="monitor-aws.html" title="Monitor Amazon Web Services (AWS) with Beats"/>
<link rel="next" href="gcp-dataflow.html" title="GCP Dataflow templates"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Observability"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Observability/Guide/master"/>
<meta name="DC.subject" content="Observability"/>
<meta name="DC.identifier" content="master"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Observability Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="observability-tutorials.html">Tutorials</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="monitor-aws.html">« Monitor Amazon Web Services (AWS) with Beats</a>
</span>
<span class="next">
<a href="gcp-dataflow.html">GCP Dataflow templates »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="monitor-gcp"></a>Monitor Google Cloud Platform<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-gcp.asciidoc">edit</a></h2>
</div></div></div>
<p>In this tutorial, you&#8217;ll learn how to monitor your Google Cloud Platform (GCP)
deployments using Elastic Observability: Logs and Infrastructure metrics.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you don&#8217;t want to provision VM and install data shippers due to process and
management overhead, you can skip this step and ingest logs directly from
Pub/Sub in the Google Cloud Console to Elastic with
<a href="gcp-dataflow.html" class="ulink" target="_top">GCP Dataflow Templates</a>.</p>
</div>
</div>
<h3><a id="_what_youll_learn"></a>What you&#8217;ll learn<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-gcp.asciidoc">edit</a></h3>
<p>You&#8217;ll learn how to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Set up a GCP Service Account.
</li>
<li class="listitem">
Ingest metrics using the <a href="/guide/en/beats/metricbeat/master/metricbeat-module-gcp.html" class="ulink" target="_top">Metricbeat
Google Cloud Platform module</a> and view those metrics in Kibana.
</li>
<li class="listitem">
Export GCP audit logs through Pub/Sub topics.
</li>
<li class="listitem">
Ingest logs using the <a href="/guide/en/beats/filebeat/master/filebeat-module-gcp.html" class="ulink" target="_top">Filebeat
Google Cloud module</a> and view those logs in Kibana.
</li>
</ul>
</div>
<h3><a id="_before_you_begin"></a>Before you begin<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-gcp.asciidoc">edit</a></h3>
<p>Create a deployment using our hosted Elasticsearch Service on <a href="/cloud/elasticsearch-service/signup?baymax=docs-body&amp;elektra=docs" class="ulink" target="_top">Elastic Cloud</a>.
The deployment includes an Elasticsearch cluster for storing and searching your data,
and Kibana for visualizing and managing your data.</p>
<h3><a id="_step_1_setup_a_service_account"></a>Step 1: Setup a Service Account<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-gcp.asciidoc">edit</a></h3>
<p>Google Cloud Platform implements <a href="https://cloud.google.com/compute/docs/access/service-accounts" class="ulink" target="_top">service
accounts</a> as a way to access APIs securely. To monitor GCP with
Elastic, you will need a service account. The easiest way is to use a predefined
service account that GCP <a href="https://cloud.google.com/compute/docs/access/service-accounts?hl=en#default_service_account" class="ulink" target="_top">creates automatically</a>.
Alternatively, you can create a new service account.
This tutorial creates a new one.</p>
<p>First, to access the service account menu, click
<span class="strong strong"><strong>Menu</strong></span> &#8594; <span class="strong strong"><strong>IAM &amp; Admin</strong></span> &#8594; <span class="strong strong"><strong>Service Accounts</strong></span>.</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-service-account-menu.png" alt="Service account menu">
</div>
</div>
<p>Next, click <span class="strong strong"><strong>Create Service Account</strong></span>. Define the new service account
name (for example, "gcp-monitor") and the description (for example, "Service
account to monitor GCP services using the Elastic Stack").</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-service-account-name.png" alt="Service account name">
</div>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure to select the correct roles.</p>
</div>
</div>
<p>To monitor GCP services, you need to add these roles to the
service account:</p>
<p><span class="strong strong"><strong>Compute Viewer</strong></span>:</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-service-account-roles-compute-viewer.png" alt="Service account roles compute viewer">
</div>
</div>
<p><span class="strong strong"><strong>Monitoring Viewer</strong></span>:</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-service-account-roles-monitoring-viewer.png" alt="Service account roles monitoring viewer">
</div>
</div>
<p><span class="strong strong"><strong>Pub/Sub Subscriber</strong></span>:</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-service-account-roles-pubsub-subscriber.png" alt="Service account roles pub/sub subscriber">
</div>
</div>
<p>The final result should be the following:</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-service-account-roles-final.png" alt="Service account roles result">
</div>
</div>
<p>Click <span class="strong strong"><strong>Continue</strong></span>, then skip granting users access to this service. Finally,
click <span class="strong strong"><strong>Done</strong></span>. The service account is now ready to be used.</p>
<p>Next, to use the service account, click <span class="strong strong"><strong>Manage keys</strong></span>.</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-service-account-manage-keys.png" alt="Service account manage keys">
</div>
</div>
<p>Then, add a new JSON key type by selecting <span class="strong strong"><strong>Create new key</strong></span>.</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-service-account-create-key.png" alt="Service account create key">
</div>
</div>
<p>After that, the credential file is downloaded.
Keep this file in an accessible place to use later.</p>
<h3><a id="_step_2_install_and_configure_metricbeat"></a>Step 2: Install and configure Metricbeat<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-gcp.asciidoc">edit</a></h3>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This tutorial assumes the Elastic cluster is already running. Make sure you have your <span class="strong strong"><strong>cloud ID</strong></span> and your <span class="strong strong"><strong>credentials</strong></span> on hand.</p>
</div>
</div>
<p>To monitor GCP using the Elastic Stack, you need two main components:
an Elastic deployment to store and analyze the data and an agent to collect
and ship the data.</p>
<p>Two agents can be used to monitor GCP: Metricbeat is used to
monitor metrics, and Filebeat to monitor logs. You can run the agents on any
machine. This tutorial uses a small GCP instance, e2-small (2 vCPUs,
2 GB memory), with an Ubuntu distribution.</p>
<h4><a id="_install_metricbeat_2"></a>Install Metricbeat<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/shared/install-configure-metricbeat.asciidoc">edit</a></h4>
<p>Download and install Metricbeat.</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Install-m">
    <button role="tab"
            aria-selected="true"
            aria-controls="deb-tab-install-metricbeat"
            id="deb-install-metricbeat">
      DEB
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="rpm-tab-install-metricbeat"
            id="rpm-install-metricbeat"
            tabindex="-1">
      RPM
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="mac-tab-install-metricbeat"
            id="mac-install-metricbeat"
            tabindex="-1">
      MacOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-install-metricbeat"
            id="linux-install-metricbeat"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-install-metricbeat"
            id="win-install-metricbeat"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="deb-tab-install-metricbeat"
       aria-labelledby="deb-install-metricbeat">
<p>Version 8.9.0 of Metricbeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="rpm-tab-install-metricbeat"
       aria-labelledby="rpm-install-metricbeat"
       hidden="">
<p>Version 8.9.0 of Metricbeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-install-metricbeat"
       aria-labelledby="mac-install-metricbeat"
       hidden="">
<p>Version 8.9.0 of Metricbeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-install-metricbeat"
       aria-labelledby="linux-install-metricbeat"
       hidden="">
<p>Version 8.9.0 of Metricbeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-install-metricbeat"
       aria-labelledby="win-install-metricbeat"
       hidden="">
<p>Version 8.9.0 of Metricbeat has not yet been released.</p>
  </div>
</div>
<h4><a id="_set_up_assets_3"></a>Set up assets<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/shared/install-configure-metricbeat.asciidoc">edit</a></h4>
<p>Metricbeat comes with predefined assets for parsing, indexing, and visualizing your data.
Run the following command to load these assets. It may take a few minutes.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat setup -e -E 'cloud.id=YOUR_DEPLOYMENT_CLOUD_ID' -E 'cloud.auth=elastic:YOUR_SUPER_SECRET_PASS' <a id="CO20-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO20-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Substitute your Cloud ID and an administrator&#8217;s <code class="literal">username:password</code> in this command.
To find your Cloud ID, click on your <a href="https://cloud.elastic.co/deployments" class="ulink" target="_top">deployment</a>.</p>
</td>
</tr>
</table>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Setting up Metricbeat is an admin-level task that requires extra privileges.
As a best practice, <a href="/guide/en/beats/metricbeat/master/privileges-to-setup-beats.html" class="ulink" target="_top">use an administrator role to set up</a>,
and a more restrictive role for event publishing (which you will do next).</p>
</div>
</div>
<h4><a id="_configure_metricbeat_output_2"></a>Configure Metricbeat output<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/shared/install-configure-metricbeat.asciidoc">edit</a></h4>
<p>Next, you are going to configure Metricbeat output to Elasticsearch Service.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Use the Metricbeat keystore to store <a href="/guide/en/beats/metricbeat/master/keystore.html" class="ulink" target="_top">secure settings</a>.
Store the Cloud ID in the keystore.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat keystore create
echo -n "&lt;Your Deployment Cloud ID&gt;" | ./metricbeat keystore add CLOUD_ID --stdin</pre>
</div>
</li>
<li class="listitem">
<p>To store metrics in Elasticsearch with minimal permissions, create an API key to send
data from Metricbeat to Elasticsearch Service. Log into Kibana (you can do so from the Cloud
Console without typing in any permissions) and select <span class="strong strong"><strong>Management</strong></span> &#8594; <span class="strong strong"><strong>Dev Tools</strong></span>.
Send the following request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/api_key
{
  "name": "metricbeat-monitor",
  "role_descriptors": {
    "metricbeat_writer": {
      "cluster": ["monitor", "read_ilm"],
      "index": [
        {
          "names": ["metricbeat-*"],
          "privileges": ["view_index_metadata", "create_doc"]
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/4.console"></div>
</li>
<li class="listitem">
<p>The response contains an <code class="literal">api_key</code> and an <code class="literal">id</code> field, which can be stored in
the Metricbeat keystore in the following format: <code class="literal">id:api_key</code>.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">echo -n "IhrJJHMB4JmIUAPLuM35:1GbfxhkMT8COBB4JWY3pvQ" | ./metricbeat keystore add ES_API_KEY --stdin</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure you specify the <code class="literal">-n</code> parameter; otherwise, you will have
painful debugging sessions due to adding a newline at the end of
your API key.</p>
</div>
</div>
</li>
<li class="listitem">
<p>To see if both settings have been stored, run the following command:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat keystore list</pre>
</div>
</li>
<li class="listitem">
<p>To configure Metricbeat to output to Elasticsearch Service, edit the <code class="literal">metricbeat.yml</code>
configuration file. Add the following lines to the end of the file.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">cloud.id: ${CLOUD_ID}
output.elasticsearch:
  api_key: ${ES_API_KEY}</pre>
</div>
</li>
<li class="listitem">
<p>Finally, test if the configuration is working. If it is not working,
verify if you used the right credentials and add them again.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat test output</pre>
</div>
</li>
</ol>
</div>
<p>Now that the output is working, you are going to set up the input (GCP).</p>
<h3><a id="_step_3_configure_metricbeat_google_cloud_platform_module"></a>Step 3: Configure Metricbeat Google Cloud Platform module<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-gcp.asciidoc">edit</a></h3>
<p>To collect metrics from Google Cloud Platform, use the
<a href="/guide/en/beats/metricbeat/master/metricbeat-module-gcp.html" class="ulink" target="_top">Google Cloud Platform</a>
module. This module periodically fetches monitoring metrics from Google Cloud
Platform using
<a href="https://cloud.google.com/monitoring/api/metrics_gcp" class="ulink" target="_top">Stackdriver Monitoring API</a>
for Google Cloud Platform services.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Extra GCP charges on Stackdriver Monitoring API requests may be generated by
this module. Please see
<a href="/guide/en/beats/metricbeat/master/metricbeat-module-gcp.html#gcp-api-requests" class="ulink" target="_top">rough estimation of the number of API calls</a>
for more details.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Enable the GCP module.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat modules enable gcp</pre>
</div>
</li>
<li class="listitem">
<p>Edit the <code class="literal">modules.d/gcp.yml</code> file to configure which metrics to
collect.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">- module: gcp
  metricsets:
    - compute <a id="CO21-1"></a><i class="conum" data-value="1"></i>
  zone: "" <a id="CO21-2"></a><i class="conum" data-value="2"></i>
  project_id: "your-project-id" <a id="CO21-3"></a><i class="conum" data-value="3"></i>
  period: 1m <a id="CO21-4"></a><i class="conum" data-value="4"></i>
  credentials_file_path: "/home/ubuntu/credentials.json" <a id="CO21-5"></a><i class="conum" data-value="5"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">compute</code> metricset is a predefined metricset that collects some
GCP compute metrics.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Defines which zones to monitor, an empty value collects data from <span class="strong strong"><strong>all</strong></span> zones</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Collects metrics within the <code class="literal">your-project-id</code> project-id.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>Collects metrics every minute</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO21-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>The GCP credential file that you generated earlier. (Don&#8217;t forget to create
the file if it does not exist and use the correct full path).</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>To check if Metricbeat can collect data, test the input by running the
following command:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat test modules gcp</pre>
</div>
<p>Metricbeat will print GCP metrics to the terminal, if the setup is correct.</p>
</li>
<li class="listitem">
<p>When the input and output are ready, start Metricbeat to collect the data.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./metricbeat -e</pre>
</div>
</li>
<li class="listitem">
<p>Finally, log into Kibana and open the <span class="strong strong"><strong>[Metricbeat GCP] Compute Overview</strong></span>
dashboard.</p>
<p><span class="image"><img src="monitor-gcp-compute-overview-dashboard.png" alt="Metricbeat compute overview dashboard"></span></p>
</li>
</ol>
</div>
<h3><a id="_step_4_install_and_configure_filebeat"></a>Step 4: Install and configure Filebeat<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-gcp.asciidoc">edit</a></h3>
<p>Now that Metricbeat is up and running, configure Filebeat to
collect Google Cloud logs.</p>
<h4><a id="_install_filebeat_2"></a>Install Filebeat<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/shared/install-configure-filebeat.asciidoc">edit</a></h4>
<p>Download and install Filebeat.</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Install-f">
    <button role="tab"
            aria-selected="true"
            aria-controls="deb-tab-install-filebeat"
            id="deb-install-filebeat">
      DEB
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="rpm-tab-install-filebeat"
            id="rpm-install-filebeat"
            tabindex="-1">
      RPM
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="mac-tab-install-filebeat"
            id="mac-install-filebeat"
            tabindex="-1">
      MacOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-install-filebeat"
            id="linux-install-filebeat"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-install-filebeat"
            id="win-install-filebeat"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="deb-tab-install-filebeat"
       aria-labelledby="deb-install-filebeat">
<p>Version 8.9.0 of Filebeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="rpm-tab-install-filebeat"
       aria-labelledby="rpm-install-filebeat"
       hidden="">
<p>Version 8.9.0 of Filebeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-install-filebeat"
       aria-labelledby="mac-install-filebeat"
       hidden="">
<p>Version 8.9.0 of Filebeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-install-filebeat"
       aria-labelledby="linux-install-filebeat"
       hidden="">
<p>Version 8.9.0 of Filebeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-install-filebeat"
       aria-labelledby="win-install-filebeat"
       hidden="">
<p>Version 8.9.0 of Filebeat has not yet been released.</p>
  </div>
</div>
<h4><a id="_set_up_assets_4"></a>Set up assets<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/shared/install-configure-filebeat.asciidoc">edit</a></h4>
<p>Filebeat comes with predefined assets for parsing, indexing, and visualizing your data.
Run the following command to load these assets. It may take a few minutes.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat setup -e -E 'cloud.id=YOUR_DEPLOYMENT_CLOUD_ID' -E 'cloud.auth=elastic:YOUR_SUPER_SECRET_PASS' <a id="CO22-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO22-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Substitute your Cloud ID and an administrator&#8217;s <code class="literal">username:password</code> in this command.
To find your Cloud ID, click on your <a href="https://cloud.elastic.co/deployments" class="ulink" target="_top">deployment</a>.</p>
</td>
</tr>
</table>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Setting up Filebeat is an admin-level task that requires extra privileges.
As a best practice, <a href="/guide/en/beats/filebeat/master/privileges-to-setup-beats.html" class="ulink" target="_top">use an administrator role to set up</a>
and a more restrictive role for event publishing (which you will do next).</p>
</div>
</div>
<h4><a id="_configure_filebeat_output_2"></a>Configure Filebeat output<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/shared/install-configure-filebeat.asciidoc">edit</a></h4>
<p>Next, you are going to configure Filebeat output to Elasticsearch Service.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Use the Filebeat keystore to store <a href="/guide/en/beats/filebeat/master/keystore.html" class="ulink" target="_top">secure settings</a>.
Store the Cloud ID in the keystore.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat keystore create
echo -n "&lt;Your Deployment Cloud ID&gt;" | ./filebeat keystore add CLOUD_ID --stdin</pre>
</div>
</li>
<li class="listitem">
<p>To store logs in Elasticsearch with minimal permissions, create an API key to send
data from Filebeat to Elasticsearch Service. Log into Kibana (you can do so from the Cloud
Console without typing in any permissions) and select <span class="strong strong"><strong>Management</strong></span> &#8594; <span class="strong strong"><strong>Dev Tools</strong></span>.
Send the following request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/api_key
{
  "name": "filebeat-monitor-gcp",
  "role_descriptors": {
    "filebeat_writer": {
      "cluster": [
        "monitor",
        "read_ilm",
        "cluster:admin/ingest/pipeline/get", <a id="CO23-1"></a><i class="conum" data-value="1"></i>
        "cluster:admin/ingest/pipeline/put" <a id="CO23-2"></a><i class="conum" data-value="1"></i>
      ],
      "index": [
        {
          "names": ["filebeat-*"],
          "privileges": ["view_index_metadata", "create_doc"]
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/5.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO23-1"><i class="conum" data-value="1"></i></a><a href="#CO23-2"></a></p>
</td>
<td align="left" valign="top">
<p>Filebeat needs extra cluster permissions to publish logs, which differs
from the Metricbeat configuration. You can find more
details <a href="/guide/en/beats/filebeat/master/feature-roles.html" class="ulink" target="_top">here</a>.</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>The response contains an <code class="literal">api_key</code> and an <code class="literal">id</code> field, which can be stored in
the Filebeat keystore in the following format: <code class="literal">id:api_key</code>.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">echo -n "IhrJJHMB4JmIUAPLuM35:1GbfxhkMT8COBB4JWY3pvQ" | ./filebeat keystore add ES_API_KEY --stdin</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure you specify the <code class="literal">-n</code> parameter; otherwise, you will have
painful debugging sessions due to adding a newline at the end of
your API key.</p>
</div>
</div>
</li>
<li class="listitem">
<p>To see if both settings have been stored, run the following command:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat keystore list</pre>
</div>
</li>
<li class="listitem">
<p>To configure Filebeat to output to Elasticsearch Service, edit the <code class="literal">filebeat.yml</code>
configuration file. Add the following lines to the end of the file.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">cloud.id: ${CLOUD_ID}
output.elasticsearch:
  api_key: ${ES_API_KEY}</pre>
</div>
</li>
<li class="listitem">
<p>Finally, test if the configuration is working. If it is not working,
verify that you used the right credentials and, if necessary, add them again.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat test output</pre>
</div>
</li>
</ol>
</div>
<p>Now that the output is working, you are going to set up the input (GCP).</p>
<h3><a id="_step_5_configure_filebeat_google_cloud_module"></a>Step 5: Configure Filebeat Google Cloud module<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-gcp.asciidoc">edit</a></h3>
<p>To collect logs from Google Cloud Platform, use the
<a href="/guide/en/beats/filebeat/master/filebeat-module-gcp.html" class="ulink" target="_top">Google Cloud Platform</a>
module. This module periodically fetches logs that have been exported from
Stackdriver to a Google Pub/Sub topic sink.
There are three available filesets:
<code class="literal">audit</code>, <code class="literal">vpcflow</code>, <code class="literal">firewall</code>. This tutorial covers the <code class="literal">audit</code> fileset.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Go to the <span class="strong strong"><strong>Logs Router</strong></span> page to configure GCP to export logs to a Pub/Sub
topic. Use the search bar to find the page:</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-navigate-logs-router.png" alt="Navigate to Logs Router page">
</div>
</div>
<p>To set up the logs routing sink, click  <span class="strong strong"><strong>Create sink</strong></span>.
Set <span class="strong strong"><strong>sink name</strong></span> as <code class="literal">monitor-gcp-audit-sink</code>. Select the <span class="strong strong"><strong>Cloud Pub/Sub topic</strong></span> as the
<span class="strong strong"><strong>sink service</strong></span> and <span class="strong strong"><strong>Create new Cloud Pub/Sub topic</strong></span> named <code class="literal">monitor-gcp-audit</code>:</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-create-pubsub-topic.png" alt="Create Pub/Sub topic">
</div>
</div>
<p>Finally, under <span class="strong strong"><strong>Choose logs to include in sink</strong></span>, add
<code class="literal">logName:"cloudaudit.googleapis.com"</code> (it includes all audit logs).
Click <span class="strong strong"><strong>create sink</strong></span>.  It will look something like the following:</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-create-sink.png" alt="Create logs routing sink">
</div>
</div>
</li>
<li class="listitem">
<p>Now go to the <span class="strong strong"><strong>Pub/Sub</strong></span> page to add a subscription to the topic you just
created. Use the search bar to find the page:</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-pub-sub.png" alt="GCP Pub/Sub">
</div>
</div>
<p>To add a subscription to the <code class="literal">monitor-gcp-audit</code> topic click
<span class="strong strong"><strong>Create subscription</strong></span>:</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-pub-sub-create-subscription.png" alt="Create GCP Pub/Sub Subscription">
</div>
</div>
<p>Set <code class="literal">monitor-gcp-audit-sub</code> as the <span class="strong strong"><strong>Subscription ID</strong></span> and leave the
<span class="strong strong"><strong>Delivery type</strong></span> as pull:</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-pub-sub-subscription-id.png" alt="GCP Pub/Sub Subscription ID">
</div>
</div>
<p>Finally, scroll down and click <span class="strong strong"><strong>Create</strong></span>.</p>
</li>
<li class="listitem">
<p>Now that GCP is configured to export audit logs, enable Filebeat Google Cloud module.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat modules enable gcp</pre>
</div>
</li>
<li class="listitem">
<p>Edit the <code class="literal">modules.d/gcp.yml</code> file with the following configurations.</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">- module: gcp
  vpcflow:
    enabled: false <a id="CO24-1"></a><i class="conum" data-value="1"></i>
  firewall:
    enabled: false <a id="CO24-2"></a><i class="conum" data-value="1"></i>
  audit:
    enabled: true <a id="CO24-3"></a><i class="conum" data-value="2"></i>
    var.project_id: "elastic-education" <a id="CO24-4"></a><i class="conum" data-value="3"></i>
    var.topic: "monitor-gcp-audit" <a id="CO24-5"></a><i class="conum" data-value="4"></i>
    var.subscription_name: "monitor-gcp-audit-sub" <a id="CO24-6"></a><i class="conum" data-value="5"></i>
    var.credentials_file: "/home/ubuntu/credentials.json" <a id="CO24-7"></a><i class="conum" data-value="6"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-1"><i class="conum" data-value="1"></i></a><a href="#CO24-2"></a></p>
</td>
<td align="left" valign="top">
<p>Disables both <code class="literal">vpcflow</code> and <code class="literal">firewall</code> filesets.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-3"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Enables the <code class="literal">audit</code> fileset.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-4"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Collects data within the <code class="literal">elastic-education</code> project-id.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-5"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>Collects logs from the <code class="literal">monitor-gcp-audit</code> topic.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-6"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>Google Cloud Pub/Sub topic subscription name.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO24-7"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>The GCP credential file that you generated earlier. (Don&#8217;t forget to create
the file if it does not exist and to use the correct full path).</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>Start Filebeat to collect the logs.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">./filebeat -e</pre>
</div>
</li>
<li class="listitem">
<p>Finally, log into Kibana and open the <span class="strong strong"><strong>[Filebeat GCP] Audit</strong></span>
dashboard.</p>
<div class="imageblock">
<div class="content">
<img src="monitor-gcp-audit-overview-dashboard.png" alt="Filebeat audit overview dashboard">
</div>
</div>
</li>
</ol>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="monitor-aws.html">« Monitor Amazon Web Services (AWS) with Beats</a>
</span>
<span class="next">
<a href="gcp-dataflow.html">GCP Dataflow templates »</a>
</span>
</div>
</div>
</body>
</html>
