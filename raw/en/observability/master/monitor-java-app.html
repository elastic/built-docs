<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Monitor a Java application | Elastic Observability [master] | Elastic</title>
<meta class="elastic" name="content" content="Monitor a Java application | Elastic Observability [master]">

<link rel="home" href="index.html" title="Elastic Observability [master]"/>
<link rel="up" href="observability-tutorials.html" title="Tutorials"/>
<link rel="prev" href="gcp-dataflow.html" title="GCP Dataflow templates"/>
<link rel="next" href="monitor-nginx.html" title="Monitor nginx: Observe the logs and metrics of your nginx instances"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Observability"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Observability/Guide/master"/>
<meta name="DC.subject" content="Observability"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="gcp-dataflow.html">« GCP Dataflow templates</a>
</span>
<span class="next">
<a href="monitor-nginx.html">Monitor nginx: Observe the logs and metrics of your nginx instances »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Observability [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="observability-tutorials.html">Tutorials</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Monitor a Java application</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="monitor-java-app"></a>Monitor a Java application<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h2>
</div></div></div>
<p>In this tutorial, you&#8217;ll learn how to monitor a Java application using Elastic
Observability: Logs, Infrastructure metrics, APM, and Uptime.</p>
<h3><a id="_what_youll_learn_3"></a>What you&#8217;ll learn<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h3>
<p>You&#8217;ll learn how to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Create a sample Java application.
</li>
<li class="listitem">
Ingest logs using Filebeat and view your logs in Kibana.
</li>
<li class="listitem">
Ingest metrics using the <a href="/guide/en/beats/metricbeat/master/metricbeat-module-prometheus.html" class="ulink" target="_top">Metricbeat
Prometheus Module</a> and view your metrics in Kibana.
</li>
<li class="listitem">
Instrument your application using the <a href="/guide/en/apm/agent/java/current/index.html" class="ulink" target="_top">Elastic APM
Java agent</a>.
</li>
<li class="listitem">
Monitor your services using Heartbeat and view your uptime data in Kibana.
</li>
</ul>
</div>
<h3><a id="_before_you_begin_3"></a>Before you begin<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h3>
<p>Create a deployment using our hosted Elasticsearch Service on <a href="/cloud/elasticsearch-service/signup?page=docs&amp;placement=docs-body" class="ulink" target="_top">Elastic Cloud</a>. The deployment includes
an Elasticsearch cluster for storing and searching your data, Kibana for visualizing and managing
your data, and an APM server.
If you do not want to follow all those steps listed here and take a look at
the final java code, check out the
<a href="https://github.com/elastic/observability-contrib/tree/main/monitor-java-app" class="ulink" target="_top">observability-contrib
GitHub repository</a> for the sample application.</p>
<h3><a id="_step_1_create_a_java_application"></a>Step 1: Create a Java application<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h3>
<p>To create the Java application, you require OpenJDK 14 (or higher) and the <a href="https://javalin.io/" class="ulink" target="_top">Javalin</a>
web framework. The application will include the main endpoint, an
artificially long-running endpoint, and an endpoint that needs to poll
another data source. There will also be a background job
running.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Set up a Gradle project and create the following <code class="literal">build.gradle</code> file.</p>
<div class="pre_wrapper lang-gradle">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-gradle">plugins {
  id 'java'
  id 'application'
}

repositories {
  jcenter()
}

dependencies {
  implementation 'io.javalin:javalin:3.10.1'

  testImplementation 'org.junit.jupiter:junit-jupiter-api:5.6.2'
  testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.6.2'
}

application {
  mainClassName = 'de.spinscale.javalin.App'
}

test {
  useJUnitPlatform()
}</pre>
</div>
</li>
<li class="listitem">
<p>Run the following command.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">echo "rootProject.name = 'javalin-app'" &gt;&gt; settings.gradle

mkdir -p src/main/java/de/spinscale/javalin
mkdir -p src/test/java/de/spinscale/javalin</pre>
</div>
</li>
<li class="listitem">
Install the Gradle wrapper. An easy way to install Gradle is to use
<a href="https://sdkman.io/" class="ulink" target="_top">sdkman</a> and run <code class="literal">sdk install gradle 6.5.1</code>. Next run
<code class="literal">gradle wrapper</code> in the current directory to install the Gradle wrapper.
</li>
<li class="listitem">
Run <code class="literal">./gradlew clean check</code>. You should see a
successful build that has nothing built or compiled yet.
</li>
<li class="listitem">
<p>To create a Javalin server and its first endpoint (the main endpoint), create the
<code class="literal">src/main/java/de/spinscale/javalin/App.java</code> file.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">package de.spinscale.javalin;

import io.javalin.Javalin;

public class App {
    public static void main(String[] args) {
        Javalin app = Javalin.create().start(7000);
        app.get("/", ctx -&gt; ctx.result("Appsolutely perfect"));
    }
}</pre>
</div>
</li>
<li class="listitem">
<p>Run <code class="literal">./gradlew assemble</code></p>
<p>This command compiled the <code class="literal">App.class</code> file in the <code class="literal">build</code> directory.
However, there is no way to start the server. Let’s create a jar that
contains our compiled class along with all the required dependencies.</p>
</li>
<li class="listitem">
<p>In the <code class="literal">build.gradle</code> file, edit <code class="literal">plugins</code> as shown here.</p>
<div class="pre_wrapper lang-gradle">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-gradle">plugins {
  id 'com.github.johnrengelman.shadow' version '6.0.0'
  id 'application'
  id 'java'
}</pre>
</div>
</li>
<li class="listitem">
<p>Run <code class="literal">./gradlew shadowJar</code>. This command creates a
<code class="literal">build/libs/javalin-app-all.jar</code> file.</p>
<p>The <code class="literal">shadowJar</code> plugin requires information about its main class.</p>
</li>
<li class="listitem">
<p>Add the following snippet to the <code class="literal">build.gradle</code> file.</p>
<div class="pre_wrapper lang-gradle">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-gradle">jar {
  manifest {
    attributes 'Main-Class': 'de.spinscale.javalin.App'
  }
}</pre>
</div>
</li>
<li class="listitem">
<p>Rebuild the project and start the server.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">java -jar build/libs/javalin-app-all.jar</pre>
</div>
<p>Open another terminal and run
<code class="literal">curl localhost:7000</code> to display an HTTP response.</p>
</li>
<li class="listitem">
<p>Test the code. Placing everything into the <code class="literal">main()</code> method makes it difficult to test
the code. However, a dedicated handler fixes this.</p>
<p>Refactor the <code class="literal">App</code> class.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">package de.spinscale.javalin;

import io.javalin.Javalin;
import io.javalin.http.Handler;

public class App {

    public static void main(String[] args) {
        Javalin app = Javalin.create().start(7000);
        app.get("/", mainHandler());
    }

    static Handler mainHandler() {
        return ctx -&gt; ctx.result("Appsolutely perfect");
    }
}</pre>
</div>
<p>Add a Mockito and an Assertj dependency to the <code class="literal">build.gradle</code> file.</p>
<div class="pre_wrapper lang-gradle">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-gradle">dependencies {
  implementation 'io.javalin:javalin:3.10.1'

  testImplementation 'org.mockito:mockito-core:3.5.10'
  testImplementation 'org.assertj:assertj-core:3.17.2'
  testImplementation 'org.junit.jupiter:junit-jupiter-api:5.6.2'
  testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.6.2'
}</pre>
</div>
<p>Create an <code class="literal">AppTests.java</code> class file in
<code class="literal">src/test/java/de/spinscale/javalin</code>.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">package de.spinscale.javalin;

import io.javalin.http.Context;
import org.junit.jupiter.api.Test;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.util.HashMap;

import static de.spinscale.javalin.App.mainHandler;
import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.mock;

public class AppTests {

    final HttpServletRequest req = mock(HttpServletRequest.class);
    final HttpServletResponse res = mock(HttpServletResponse.class);
    final Context ctx = new Context(req, res, new HashMap&lt;&gt;());

    @Test
    public void testMainHandler() throws Exception {
        mainHandler().handle(ctx);

        String response = resultStreamToString(ctx);
        assertThat(response).isEqualTo("Appsolutely perfect");
    }

    private String resultStreamToString(Context ctx) throws IOException {
        final byte[] bytes = ctx.resultStream().readAllBytes();
        return new String(bytes, StandardCharsets.UTF_8);
    }
}</pre>
</div>
</li>
<li class="listitem">
<p>After the tests pass, build and package the application.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">./gradlew clean check shadowJar</pre>
</div>
</li>
</ol>
</div>
<h3><a id="_step_2_ingest_logs"></a>Step 2: Ingest logs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h3>
<p>Logs can be events such as checkout, an exception, or an HTTP request. For this tutorial,
let&#8217;s use log4j2 as our logging implementation.</p>
<h4><a id="_add_logging_implementation"></a>Add logging implementation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add the dependency to the <code class="literal">build.gradle</code> file.</p>
<div class="pre_wrapper lang-gradle">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-gradle">dependencies {
  implementation 'io.javalin:javalin:3.10.1'
  implementation 'org.apache.logging.log4j:log4j-slf4j18-impl:2.13.3'

  ...
}</pre>
</div>
</li>
<li class="listitem">
<p>To start logging, edit the <code class="literal">App.java</code> file and change a handler.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The logger call must be within the lambda. Otherwise,
the log message is logged only during startup.</p>
</div>
</div>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">package de.spinscale.javalin;

import io.javalin.Javalin;
import io.javalin.http.Handler;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class App {

    private static final Logger logger = LoggerFactory.getLogger(App.class);

    public static void main(String[] args) {
        Javalin app = Javalin.create();
        app.get("/", mainHandler());
        app.start(7000);
    }

    static Handler mainHandler() {
        return ctx -&gt; {
            logger.info("This is an informative logging message, user agent [{}]", ctx.userAgent());
            ctx.result("Appsolutely perfect");
        };
    }
}</pre>
</div>
</li>
<li class="listitem">
<p>Create a log4j2 configuration in the <code class="literal">src/main/resources/log4j2.xml</code> file. You might need to create that directory first.</p>
<div class="pre_wrapper lang-xml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Configuration&gt;
  &lt;Appenders&gt;
    &lt;Console name="Console" target="SYSTEM_OUT"&gt;
      &lt;PatternLayout pattern="%d{HH:mm:ss.SSS} [%-5level] %logger{36} %msg%n"/&gt;
    &lt;/Console&gt;
  &lt;/Appenders&gt;
  &lt;Loggers&gt;
    &lt;Logger name="de.spinscale.javalin.App" level="INFO"/&gt;
    &lt;Root level="ERROR"&gt;
      &lt;AppenderRef ref="Console" /&gt;
    &lt;/Root&gt;
  &lt;/Loggers&gt;
&lt;/Configuration&gt;</pre>
</div>
<p>By default, this logs on the <code class="literal">ERROR</code> level. For the <code class="literal">App</code> class, there is
an additional configuration so that all <code class="literal">INFO</code> logs are also logged.
After repackaging and restarting, the log messages are displayed in the terminal.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">17:17:40.019 [INFO ] de.spinscale.javalin.App - This is an informative logging message, user agent [curl/7.64.1]</pre>
</div>
</li>
</ol>
</div>
<h4><a id="_log_requests"></a>Log requests<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>Depending on the application traffic and whether it happens outside of the application, it makes sense to
log each request on the application level.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>In the <code class="literal">App.java</code> file, edit the <code class="literal">App</code> class.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">public class App {

    private static final Logger logger = LoggerFactory.getLogger(App.class);

    public static void main(String[] args) {
        Javalin app = Javalin.create(config -&gt; {
            config.requestLogger((ctx, executionTimeMs) -&gt; {
                logger.info("{} {} {} {} \"{}\" {}",
                        ctx.method(),  ctx.url(), ctx.req.getRemoteHost(),
                        ctx.res.getStatus(), ctx.userAgent(), executionTimeMs.longValue());
           });
        });
        app.get("/", mainHandler());
        app.start(7000);
    }

    static Handler mainHandler() {
        return ctx -&gt; {
            logger.info("This is an informative logging message, user agent [{}]", ctx.userAgent());
            ctx.result("Appsolutely perfect");
        };
    }
}</pre>
</div>
</li>
<li class="listitem">
<p>Rebuild and restart the application. The log messages are logged for each
request.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">10:43:50.066 [INFO ] de.spinscale.javalin.App - GET / 200 0:0:0:0:0:0:0:1 "curl/7.64.1" 7</pre>
</div>
</li>
</ol>
</div>
<h4><a id="_create_an_iso8601_timestamp"></a>Create an ISO8601 timestamp<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>Before ingesting logs into Elasticsearch Service, create an ISO8601 timestamp by editing the <code class="literal">log4j2.xml</code> file.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Creating an ISO8601 timestamp removes the need to do any calculation for timestamps when ingesting
logs, as this is a unique point in time, including the timezone. Having a
timezone becomes more important once you are running across data centers
while trying to follow data streams.</p>
</div>
</div>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">&lt;PatternLayout pattern="%d{ISO8601_OFFSET_DATE_TIME_HHCMM} [%-5level] %logger{36} %msg%n"/&gt;</pre>
</div>
<p>The log entries are ingested containing timestamps like the following.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">2020-07-03T14:25:40,378+02:00 [INFO ] de.spinscale.javalin.App GET / 200 0:0:0:0:0:0:0:1 "curl/7.64.1" 0</pre>
</div>
<h4><a id="_log_to_a_file_and_stdout"></a>Log to a file and stdout<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>To read the logging output, let&#8217;s write data into a file and to stdout. This is a new <code class="literal">log4j2.xml</code> file.</p>
<div class="pre_wrapper lang-xml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Configuration&gt;
  &lt;Appenders&gt;
    &lt;Console name="Console" target="SYSTEM_OUT"&gt;
      &lt;PatternLayout pattern="%highlight{%d{ISO8601_OFFSET_DATE_TIME_HHCMM} [%-5level] %logger{36} %msg%n}"/&gt;
    &lt;/Console&gt;
    &lt;File name="JavalinAppLog" fileName="/tmp/javalin/app.log"&gt;
      &lt;PatternLayout pattern="%d{ISO8601_OFFSET_DATE_TIME_HHCMM} [%-5level] %logger{36} %msg%n"/&gt;
    &lt;/File&gt;
  &lt;/Appenders&gt;
  &lt;Loggers&gt;
    &lt;Logger name="de.spinscale.javalin.App" level="INFO"/&gt;
    &lt;Root level="ERROR"&gt;
      &lt;AppenderRef ref="Console" /&gt;
      &lt;AppenderRef ref="JavalinAppLog" /&gt;
    &lt;/Root&gt;
  &lt;/Loggers&gt;
&lt;/Configuration&gt;</pre>
</div>
</li>
<li class="listitem">
Restart the application and send a request. The logs will be sent to
<code class="literal">/tmp/javalin/app.log</code>.
</li>
</ol>
</div>
<h4><a id="_install_and_configure_filebeat"></a>Install and configure Filebeat<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>To read the log file and send it to Elasticsearch, Filebeat is required. To download and install Filebeat,
use the commands that work with your system:</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Install-f">
    <button role="tab"
            aria-selected="true"
            aria-controls="deb-tab-install-filebeat"
            id="deb-install-filebeat">
      DEB
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="rpm-tab-install-filebeat"
            id="rpm-install-filebeat"
            tabindex="-1">
      RPM
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="mac-tab-install-filebeat"
            id="mac-install-filebeat"
            tabindex="-1">
      MacOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-install-filebeat"
            id="linux-install-filebeat"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-install-filebeat"
            id="win-install-filebeat"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="deb-tab-install-filebeat"
       aria-labelledby="deb-install-filebeat">
<p>Version 8.16.0 of Filebeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="rpm-tab-install-filebeat"
       aria-labelledby="rpm-install-filebeat"
       hidden="">
<p>Version 8.16.0 of Filebeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-install-filebeat"
       aria-labelledby="mac-install-filebeat"
       hidden="">
<p>Version 8.16.0 of Filebeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-install-filebeat"
       aria-labelledby="linux-install-filebeat"
       hidden="">
<p>Version 8.16.0 of Filebeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-install-filebeat"
       aria-labelledby="win-install-filebeat"
       hidden="">
<p>Version 8.16.0 of Filebeat has not yet been released.</p>
  </div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Use the Filebeat keystore to store <a href="/guide/en/beats/filebeat/master/keystore.html" class="ulink" target="_top">secure
settings</a>. Let’s store the Cloud ID in the keystore.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Substitute the Cloud ID from your deployment in the following command.  To find your Cloud ID
Click on your deployment in <a href="https://cloud.elastic.co/deployments" class="ulink" target="_top">https://cloud.elastic.co/deployments</a></p>
</div>
</div>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">./filebeat keystore create
echo -n "&lt;Your Cloud ID&gt;" | ./filebeat keystore add CLOUD_ID --stdin</pre>
</div>
<p>To store logs in Elasticsearch with minimal permissions, create an API key to send data from Filebeat to Elasticsearch Service.</p>
</li>
<li class="listitem">
<p>Log into Kibana user (you can do so from the Cloud Console without typing
in any permissions) and select <span class="strong strong"><strong>Management</strong></span> &#8594; <span class="strong strong"><strong>Dev Tools</strong></span>. Send the
following request:</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">POST /_security/api_key
{
  "name": "filebeat_javalin-app",
  "role_descriptors": {
    "filebeat_writer": {
      "cluster": ["monitor", "read_ilm"],
      "index": [
        {
          "names": ["filebeat-*"],
          "privileges": ["view_index_metadata", "create_doc"]
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/71.console"></div>
<p>The response contains an <code class="literal">api_key</code> and an <code class="literal">id</code> field, which can be stored in
the Filebeat keystore in the following format: <code class="literal">id:api_key</code>.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">echo -n "IhrJJHMB4JmIUAPLuM35:1GbfxhkMT8COBB4JWY3pvQ" | ./filebeat keystore add ES_API_KEY --stdin</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure you specify the <code class="literal">-n</code> parameter; otherwise, you will have
painful debugging sessions, because of adding a newline at the end of
your API key.</p>
</div>
</div>
<p>To see if both settings have been stored, run <code class="literal">./filebeat keystore list</code>.</p>
</li>
<li class="listitem">
<p>To load the Filebeat dashboards, use the <code class="literal">elastic</code> super user.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">./filebeat setup -e -E 'cloud.id=${CLOUD_ID}' -E 'cloud.auth=elastic:YOUR_SUPER_SECRET_PASS'</pre>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you prefer not to store credentials in your shell&#8217;s
<code class="literal">.history</code> file, add a space at the beginning of the line.
Depending on the shell configuration, these commands are not added to
the history.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Configure Filebeat, so it knows where to read data from and where to send it
to. Create a <code class="literal">filebeat.yml</code> file.</p>
<div class="pre_wrapper lang-yml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yml">name: javalin-app-shipper

filebeat.inputs:
- type: log
  paths:
    - /tmp/javalin/*.log

cloud.id: ${CLOUD_ID}
output.elasticsearch:
  api_key: ${ES_API_KEY}</pre>
</div>
</li>
</ol>
</div>
<h4><a id="_send_data_to_elasticsearch"></a>Send data to Elasticsearch<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>To send data to Elasticsearch, start Filebeat.</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Start-f">
    <button role="tab"
            aria-selected="true"
            aria-controls="deb-tab-start-filebeat"
            id="deb-start-filebeat">
      DEB
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="rpm-tab-start-filebeat"
            id="rpm-start-filebeat"
            tabindex="-1">
      RPM
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="mac-tab-start-filebeat"
            id="mac-start-filebeat"
            tabindex="-1">
      MacOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-start-filebeat"
            id="linux-start-filebeat"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-start-filebeat"
            id="win-start-filebeat"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="deb-tab-start-filebeat"
       aria-labelledby="deb-start-filebeat">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo service filebeat start</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you use an <code class="literal">init.d</code> script to start Filebeat, you can&#8217;t specify command
line flags (see <a href="/guide/en/beats/filebeat/master/command-line-options.html" class="ulink" target="_top">Command reference</a>). To specify flags, start Filebeat in
the foreground.</p>
</div>
</div>
<p>Also see <a href="/guide/en/beats/filebeat/master/running-with-systemd.html" class="ulink" target="_top">Filebeat and systemd</a>.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="rpm-tab-start-filebeat"
       aria-labelledby="rpm-start-filebeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo service filebeat start</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you use an <code class="literal">init.d</code> script to start Filebeat, you can&#8217;t specify command
line flags (see <a href="/guide/en/beats/filebeat/master/command-line-options.html" class="ulink" target="_top">Command reference</a>). To specify flags, start Filebeat in
the foreground.</p>
</div>
</div>
<p>Also see <a href="/guide/en/beats/filebeat/master/running-with-systemd.html" class="ulink" target="_top">Filebeat and systemd</a>.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-start-filebeat"
       aria-labelledby="mac-start-filebeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">./filebeat -e</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-start-filebeat"
       aria-labelledby="linux-start-filebeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">./filebeat -e</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-start-filebeat"
       aria-labelledby="win-start-filebeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">PS C:\Program Files\filebeat&gt; Start-Service filebeat</pre>
</div>
<p>By default, Windows log files are stored in <code class="literal">C:\ProgramData\filebeat\Logs</code>.</p>
  </div>
</div>
<p>In the log output, you should see the following line.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">2020-07-03T15:41:56.532+0200    INFO    log/harvester.go:297    Harvester started for file: /tmp/javalin/app.log</pre>
</div>
<p>Let&#8217;s create some log entries for the application. You can use a tool
like <a href="https://github.com/wg/wrk" class="ulink" target="_top">wrk</a> and run the following command to send requests to the application.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">wrk -t1 -c 100 -d10s http://localhost:7000</pre>
</div>
<p>This command results in roughly 8,000 requests per
second, and the equivalent number of log lines are also written.</p>
<h3><a id="_step_3_view_logs_in_kibana"></a>Step 3: View logs in Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h3>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Log into Kibana and select the <span class="strong strong"><strong>Discover</strong></span> app.</p>
<p>There is a summary of the documents at the top, but let’s take a look at a single document.</p>
<p class="screenshot"><span class="image"><img src="./images/monitor-java-app-kibana-single-document.png" alt="Kibana single document view"></span></p>
<p>You can see that a lot more data is indexed than just the event. There is information about
the offset in the file, information about the component shipping the logs, the name of the shipper&#8217;s
name in the output, and there is a <code class="literal">message</code> field containing log line contents.</p>
<p>You can see there is a flaw in the request logging. If the user agent is <code class="literal">null</code>,
something other than <code class="literal">null</code> is returned. Reading our logs is
crucial; however, just indexing them gains us nothing.  To fix this, here is a new request logger.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">Javalin app = Javalin.create(config -&gt; {
    config.requestLogger((ctx, executionTimeMs) -&gt; {
        String userAgent = ctx.userAgent() != null ? ctx.userAgent() : "-";
        logger.info("{} {} {} {} \"{}\" {}",
                ctx.method(), ctx.req.getPathInfo(), ctx.res.getStatus(),
                ctx.req.getRemoteHost(), userAgent, executionTimeMs.longValue());
    });
});</pre>
</div>
<p>You may also want to fix this in the logging message in the main handler.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">static Handler mainHandler() {
    return ctx -&gt; {
        String userAgent = ctx.userAgent() != null ? ctx.userAgent() : "-";
        logger.info("This is an informative logging message, user agent [{}]", userAgent);
        ctx.result("Appsolutely perfect");
    };
}</pre>
</div>
</li>
<li class="listitem">
<p>Now let&#8217;s have a look at the Logs app in Kibana. Select <span class="strong strong"><strong>Observability</strong></span> &#8594; <span class="strong strong"><strong>Logs</strong></span>.</p>
<p>If you want to see the streaming feature at work, run the following curl request in
a loop while sleeping.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">while $(sleep 0.7) ; do curl localhost:7000 ; done</pre>
</div>
</li>
<li class="listitem">
<p>To view a continuous stream of log messages, click <span class="strong strong"><strong>Stream live</strong></span>. You can also
highlight specific terms, as shown here.</p>
<p class="screenshot"><span class="image"><img src="./images/monitor-java-app-kibana-streaming.png" alt="Kibana Logs UI Streaming"></span></p>
<p>Looking at one of the documents being indexed, you can see that the log message
is contained in a single field. Verify this by looking at one of those documents.</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET filebeat-*/_search
{
  "size": 1
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/72.console"></div>
<p>Things to note:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
When you compare the <code class="literal">@timestamp</code> field with the timestamp of the log message, you will
notice that it differs. This means that you don&#8217;t get the results you expect when filtering based on the
<code class="literal">@timestamp</code> field. The current <code class="literal">@timestamp</code> field reflects the timestamp when the event was created within
Filebeat, not the timestamp of when the log event occurred in the application.
</li>
<li class="listitem">
One cannot filter on specific fields like the HTTP verb, the HTTP status
code, the log level or the class that generated the log message
</li>
</ul>
</div>
</li>
</ol>
</div>
<h3><a id="_step_4_work_with_your_logs"></a>Step 4: Work with your logs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h3>
<h4><a id="_structure_logs"></a>Structure logs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>To extract more data from a single log line into several fields requires additional structuring
of the logs.</p>
<p>Let’s take another look at a log message generated by our app.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">2020-07-03T15:45:01,479+02:00 [INFO ] de.spinscale.javalin.App This is an informative logging message</pre>
</div>
<p>This message has four parts: <code class="literal">timestamp</code>, <code class="literal">log level</code>, <code class="literal">class</code>, and <code class="literal">message</code>. The
rules of splitting are apparent as well, as most of them involve
whitespace.</p>
<p>The good news is that all Beats can process a log line before
sending it to Elasticsearch by using <a href="/guide/en/beats/filebeat/master/filtering-and-enhancing-data.html" class="ulink" target="_top">processors</a>.
If the capabilities of these processors are not enough, you can always let Elasticsearch do the heavy lifting by using
<a href="/guide/en/elasticsearch/reference/master/ingest.html" class="ulink" target="_top">an ingest node</a>. This is what many modules in Filebeat do. A module in Filebeat
is a way to parse a specific log file format for a particular software.</p>
<p>Let’s try this by using a couple of processors and only a Filebeat
configuration.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">processors:
  - add_host_metadata: ~
  - dissect:
      tokenizer: '%{timestamp} [%{log.level}] %{log.logger} %{message_content}'
      field: "message"
      target_prefix: ""
  - timestamp:
      field: "timestamp"
      layouts:
        - '2006-01-02T15:04:05.999Z0700'
      test:
        - '2020-07-18T04:59:51.123+0200'
  - drop_fields:
      fields: [ "message", "timestamp" ]
  - rename:
      fields:
        - from: "message_content"
        - to: "message"</pre>
</div>
<p>The <code class="literal">dissect</code> processor splits the log message into four parts. If you want
to have the last part of the original message in the <code class="literal">message</code> field,
you need to remove the old <code class="literal">message</code> field first and then rename the field.
There is no in-place replacement with the dissect filter.</p>
<p>There is also a dedicated timestamp parsing so that the <code class="literal">@timestamp</code>
field contains a parsed value. Drop the duplicated
fields, but ensure that a part of the original message is still
available in the <code class="literal">message</code> field.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>The removal of parts of the original message is debatable. Keeping the
original message around makes a lot of sense to me. With the above example,
debugging might become problematic if parsing the timestamp does not work as
expected.</p>
</div>
</div>
<p>There is also a slight difference in the parsing of a timestamp as the
go time parser only accepts dots as a separator between seconds and
milliseconds. Still, our default output of the log4j2 is using a comma.</p>
<p>Either one can fix the timestamp in the logging output to look like one
expected from Filebeat. This results in the following pattern layout.</p>
<div class="pre_wrapper lang-xml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-xml">  &lt;PatternLayout pattern="%d{yyyy-MM-dd'T'HH:mm:ss.SSSZ} [%-5level] %logger{36} %msg%n"/&gt;</pre>
</div>
<p>Fixing the timestamp parsing is another way, as you do not always have
full control over your logs and change their format. Imagine using some
third-party software. For now, this will be good enough.</p>
<p>Restart Filebeat after the change, and look at what
changed in an indexed JSON document by running this search (and having
another log message indexed).</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET filebeat-*/_search?filter_path=**._source
{
  "size": 1,
  "_source": {
    "excludes": [
      "host.ip",
      "host.mac"
    ]
  },
  "sort": [
    {
      "@timestamp": {
        "order": "desc"
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/73.console"></div>
<p>This returns a document like this.</p>
<div class="pre_wrapper lang-console-response">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console-response">{
  "hits" : {
    "hits" : [
      {
        "_source" : {
          "input" : {
            "type" : "log"
          },
          "agent" : {
            "hostname" : "rhincodon",
            "name" : "javalin-app-shipper",
            "id" : "95705f0c-b472-4bcc-8b01-2d387c0d309b",
            "type" : "filebeat",
            "ephemeral_id" : "e4df883f-6073-4a90-a4c4-9e116704f871",
            "version" : "7.9.0"
          },
          "@timestamp" : "2020-07-03T15:11:51.925Z",
          "ecs" : {
            "version" : "1.5.0"
          },
          "log" : {
            "file" : {
              "path" : "/tmp/javalin/app.log"
            },
            "offset" : 1440,
            "level" : "ERROR",
            "logger" : "de.spinscale.javalin.App"
          },
          "host" : {
            "hostname" : "rhincodon",
            "os" : {
              "build" : "19F101",
              "kernel" : "19.5.0",
              "name" : "Mac OS X",
              "family" : "darwin",
              "version" : "10.15.5",
              "platform" : "darwin"
            },
            "name" : "javalin-app-shipper",
            "id" : "C28736BF-0EB3-5A04-BE85-C27A62C99316",
            "architecture" : "x86_64"
          },
          "message" : "This is an informative logging message, user agent [curl/7.64.1]"
        }
      }
    ]
  }
}</pre>
</div>
<p>You can see that the <code class="literal">message</code> field only contains the last part of our log
message. Also, there is a <code class="literal">log.level</code> and <code class="literal">log.logger</code> field.</p>
<p>When the log level is <code class="literal">INFO</code>, it is logged with
additional space at the end. You could use a
<a href="/guide/en/beats/filebeat/master/processor-script.html" class="ulink" target="_top">script
processor</a> and call <code class="literal">trim()</code>. However, it might be easier to fix our logging
configuration to not always emit 5 characters, regardless of
the log level length. You can still keep this when writing to standard out.</p>
<div class="pre_wrapper lang-xml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-xml">&lt;File name="JavalinAppLog" fileName="/tmp/javalin/app.log"&gt;
  &lt;PatternLayout pattern="%d{yyyy-MM-dd'T'HH:mm:ss.SSSZ} [%level] %logger{36} %msg%n"/&gt;
&lt;/File&gt;</pre>
</div>
<h4><a id="_parse_exceptions"></a>Parse exceptions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>Exceptions are a special treat in the case of logging.
They span multiple lines, so the old rule of one message per line does not exist
in exceptions.</p>
<p>Add an endpoint in <code class="literal">App.java</code> that triggers an exception first and make sure it
is logged by using an exception mapper.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">app.get("/exception", ctx -&gt; {
    throw new IllegalArgumentException("not yet implemented");
});

app.exception(Exception.class, (e, ctx) -&gt; {
    logger.error("Exception found", e);
    ctx.status(500).result(e.getMessage());
});</pre>
</div>
<p>Calling <code class="literal">/exception</code> returns an HTTP 500 error to the client, but
it leaves a stack trace in the logs like this.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">2020-07-06T11:27:29,491+02:00 [ERROR] de.spinscale.javalin.App Exception found
java.lang.IllegalArgumentException: not yet implemented
    at de.spinscale.javalin.App.lambda$main$2(App.java:24) ~[classes/:?]
    at io.javalin.core.security.SecurityUtil.noopAccessManager(SecurityUtil.kt:23) ~[javalin-3.10.1.jar:?]
    at io.javalin.http.JavalinServlet$addHandler$protectedHandler$1.handle(JavalinServlet.kt:119) ~[javalin-3.10.1.jar:?]
    at io.javalin.http.JavalinServlet$service$2$1.invoke(JavalinServlet.kt:45) ~[javalin-3.10.1.jar:?]
    at io.javalin.http.JavalinServlet$service$2$1.invoke(JavalinServlet.kt:24) ~[javalin-3.10.1.jar:?]

  ... goes on and on and on and own ...</pre>
</div>
<p>There is one attribute that helps to parse this stack trace. It seems different
compared to a regular log message. Each new line starts
with whitespace, thus different from a log message beginning with the date.
Let’s add this logic to our Beats configuration.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">- type: log
  enabled: true
  paths:
    - /tmp/javalin/*.log
  multiline.pattern: ^20
  multiline.negate: true
  multiline.match: after</pre>
</div>
<p>So the verbatim translation of the above settings says to treat everything
as part of an existing message, that is not starting with <code class="literal">20</code> in a line.
The <code class="literal">20</code> resembles the beginning year of your timestamps. Some users
prefer to wrap the date in <code class="literal">[]</code> to make this easier to understand.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This introduces state into your logging. You cannot split a
log file among several processors now, as every log line could still be
belonging to the current event. This is not a bad thing, but again
something to be aware of.</p>
</div>
</div>
<p>After restarting Filebeat and your Javalin app, trigger an
exception, and you will see a long stack trace in the <code class="literal">message</code> field of
your logs.</p>
<h4><a id="_configure_log_rotation"></a>Configure log rotation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>To ensure that logs don&#8217;t grow infinitely, let’s add some log rotation to your
logging configuration.</p>
<div class="pre_wrapper lang-xml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Configuration&gt;
  &lt;Appenders&gt;
    &lt;Console name="Console" target="SYSTEM_OUT"&gt;
      &lt;PatternLayout pattern="%highlight{%d{ISO8601_OFFSET_DATE_TIME_HHCMM} [%-5level] %logger{36} %msg%n}"/&gt;
    &lt;/Console&gt;

    &lt;RollingFile name="JavalinAppLogRolling" fileName="/tmp/javalin/app.log" filePattern="/tmp/javalin/%d{yyyy-MM-dd}-%i.log.gz"&gt;
      &lt;PatternLayout pattern="%d{yyyy-MM-dd'T'HH:mm:ss.SSSZ} [%level] %logger{36} %msg%n"/&gt;
      &lt;Policies&gt;
        &lt;TimeBasedTriggeringPolicy /&gt;
        &lt;SizeBasedTriggeringPolicy size="50 MB"/&gt;
      &lt;/Policies&gt;
      &lt;DefaultRolloverStrategy max="20"/&gt;
    &lt;/RollingFile&gt;
  &lt;/Appenders&gt;

  &lt;Loggers&gt;
    &lt;Logger name="de.spinscale.javalin.App" level="INFO"/&gt;
    &lt;Root level="ERROR"&gt;
      &lt;AppenderRef ref="Console" /&gt;
      &lt;AppenderRef ref="JavalinAppLogRolling" /&gt;
    &lt;/Root&gt;
  &lt;/Loggers&gt;
&lt;/Configuration&gt;</pre>
</div>
<p>The sample added a <code class="literal">JavalinAppLogRolling</code> appender to our configuration that
uses the same logging pattern as before, but rolls over if a new day
starts or if the log file has reached 50 megabytes.</p>
<p>If a new log file is created, older log files are gzipped as well to take less space on disk.
The size of 50 megabytes refers to the unpacked file size, so
the potentially twenty files on disk will be much smaller each.</p>
<h4><a id="_ingest_node"></a>Ingest node<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>The built-in modules are almost entirely using the
<a href="/guide/en/elasticsearch/reference/master/ingest.html" class="ulink" target="_top">Ingest node</a>
feature of Elasticsearch instead of the Beats processors.</p>
<p>One of the most helpful parts of the ingest pipeline is the ability to debug by using
the <a href="/guide/en/elasticsearch/reference/master/simulate-pipeline-api.html" class="ulink" target="_top">Simulate Pipeline API</a>.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Let’s write a pipeline that is similar to our Filebeat processors using
the Dev Tools panel in Kibana, run the following:</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console"># Store the pipeline in Elasticsearch
PUT _ingest/pipeline/javalin_pipeline
{
  "processors": [
    {
      "dissect": {
        "field": "message",
        "pattern": "%{@timestamp} [%{log.level}] %{log.logger} %{message}"
      }
    },
    {
      "trim": {
        "field": "log.level"
      }
    },
    {
      "date": {
        "field": "@timestamp",
        "formats": [
          "ISO8601"
        ]
      }
    }
  ]
}

# Test the pipeline
POST _ingest/pipeline/javalin_pipeline/_simulate
{
  "docs": [
    {
      "_source": {
        "message": "2020-07-06T13:39:51,737+02:00 [INFO ] de.spinscale.javalin.App This is an informative logging message"
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/74.console"></div>
<p>You can see the pipeline&#8217;s created fields in the output, which now
looks like the earlier Filebeat processors. As the ingest pipeline
works on a document level, you still need to check for exceptions where
the logs are generated and let Filebeat create a single message out
of that. You could even implement the log level trimming with a single
processor, and date parsing was also pretty easy, as the Elasticsearch
ISO8601 parser correctly identifies a comma instead of a dot when
splitting seconds and milliseconds.</p>
</li>
<li class="listitem">
<p>Now, on to the Filebeat configuration. First, let’s remove all the
processors, except the
<a href="/guide/en/beats/filebeat/master/add-host-metadata.html" class="ulink" target="_top">add_host_metadata
processor</a>, to add some host information like the host name and operating
system.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">processors:
  - add_host_metadata: ~</pre>
</div>
</li>
<li class="listitem">
<p>Edit the Elasticsearch output to ensure the pipeline will be
referred to when a document is indexed from Filebeat.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">cloud.id: ${CLOUD_ID}
output.elasticsearch:
  api_key: ${ES_API_KEY}
  pipeline: javalin_pipeline</pre>
</div>
</li>
<li class="listitem">
Restart Filebeat and see if logs are flowing in as expected.
</li>
</ol>
</div>
<h4><a id="_write_logs_as_json"></a>Write logs as JSON<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>You have now learned about parsing logs in either Beats or Elasticsearch. What if
we didn&#8217;t need to think about parsing our logs and extract data manually?</p>
<p>Writing out logs as plain text works and is easy to read for humans.
However, first writing them out as plain text, parsing them using
the <code class="literal">dissect</code> processors, and then creating a JSON again sounds tedious and burns
unneeded CPU cycles.</p>
<p>While log4j2 has a
<a href="https://logging.apache.org/log4j/2.x/manual/layouts.html#JSONLayout" class="ulink" target="_top">JSONLayout</a>,
you can go further and use a Library called
<a href="https://github.com/elastic/ecs-logging-java" class="ulink" target="_top">ecs-logging-java</a>. The advantage of
ECS logging is that it uses the <a href="/guide/en/ecs/8.11/index.html" class="ulink" target="_top">Elastic Common
Schema</a>. ECS defines a standard set of fields used when storing event data in
Elasticsearch, such as logs and metrics.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Instead of writing our logging standard, use an existing one. Let’s add
the logging dependency to our Javalin application.</p>
<div class="pre_wrapper lang-gradle">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-gradle">dependencies {
  implementation 'io.javalin:javalin:3.10.1'
  implementation 'org.apache.logging.log4j:log4j-slf4j18-impl:2.13.3'
  implementation 'co.elastic.logging:log4j2-ecs-layout:0.5.0'

  testImplementation 'org.mockito:mockito-core:3.5.10'
  testImplementation 'org.assertj:assertj-core:3.17.2'
  testImplementation 'org.junit.jupiter:junit-jupiter-api:5.6.2'
  testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.6.2'
}

// this is needed to ensure JSON logging works as expected when building
// a shadow jar
shadowJar {
  transform(com.github.jengelman.gradle.plugins.shadow.transformers.Log4j2PluginsCacheFileTransformer)
}</pre>
</div>
<p>The <code class="literal">log4j2-ecs-layout</code> ships with a custom <code class="literal">&lt;EcsLayout&gt;</code> which can be used
in the logging setup for the rolling file appender</p>
<div class="pre_wrapper lang-xml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-xml">&lt;RollingFile name="JavalinAppLogRolling" fileName="/tmp/javalin/app.log" filePattern="/tmp/javalin/%d{yyyy-MM-dd}-%i.log.gz"&gt;
  &lt;EcsLayout serviceName="my-javalin-app"/&gt;
  &lt;Policies&gt;
    &lt;TimeBasedTriggeringPolicy /&gt;
    &lt;SizeBasedTriggeringPolicy size="50 MB"/&gt;
  &lt;/Policies&gt;
  &lt;DefaultRolloverStrategy max="20"/&gt;
&lt;/RollingFile&gt;</pre>
</div>
<p>When you restart your app, you will see pure JSON written to your
log file. When you trigger an exception, you will see, that the
stack trace is already within your single document. This means the
Filebeat configuration can become stateless and even more lightweight.
Also, the ingest pipeline on the Elasticsearch side can be deleted
again.</p>
</li>
<li class="listitem">
<p>You can configure a few
<a href="https://github.com/elastic/ecs-logging-java/tree/main/log4j2-ecs-layout" class="ulink" target="_top">more
parameters</a> for the <code class="literal">EcsLayout</code>, but the defaults have been selected wisely. Let’s
fix the Filebeat configuration and remove the multiline setup along with
pipeline:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /tmp/javalin/*.log
  json.keys_under_root: true

name: javalin-app-shipper

cloud.id: ${CLOUD_ID}
output.elasticsearch:
  api_key: ${ES_API_KEY}

# ================================= Processors =================================
processors:
  - add_host_metadata: ~</pre>
</div>
<p>As you can see, just by writing out logs as JSON, our whole logging
setup got a ton easier, so whenever possible, try to directly
write your logs as JSON.</p>
</li>
</ol>
</div>
<h2><a id="_step_5_ingest_metrics"></a>Step 5: Ingest metrics<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h2>
<p>A metric is considered a point in time value that can change anytime. The
number of current requests can change any millisecond. You could have a
spike of 1000 requests, and then everything goes back to one request. This
also means that these kinds of metrics may not be accurate, and you also
want to pull min/max values to get some more indication. Furthermore, this
implies that you need to think about the duration of those metrics as well.
Do you need those once per minute or every 10 seconds?</p>
<p>To get a different angled view of your application, let&#8217;s ingest some metrics. In this example,
we will use the <a href="/guide/en/beats/metricbeat/master/metricbeat-module-prometheus.html" class="ulink" target="_top">Metricbeat
Prometheus Module</a> to send data to Elasticsearch.</p>
<p>The underlying library used in our app is
<a href="http://micrometer.io/" class="ulink" target="_top">micrometer.io</a>, a vendor-neutral application
metrics facade in combination with its
<a href="http://micrometer.io/docs/registry/prometheus" class="ulink" target="_top">Prometheus support</a> to
implement a pull-based model. You could use the
<a href="http://micrometer.io/docs/registry/elastic" class="ulink" target="_top">elastic support</a> to achieve
a push-based model. This would require users to store credential data of
the Elasticsearch cluster in our app. This example keeps this data in
the surrounding tools.</p>
<h4><a id="_add_metrics_to_the_application"></a>Add metrics to the application<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add the dependencies to our <code class="literal">build.gradle</code> file.</p>
<div class="pre_wrapper lang-gradle">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-gradle">  // metrics via micrometer
  implementation 'io.micrometer:micrometer-core:1.5.4'
  implementation 'io.micrometer:micrometer-registry-prometheus:1.5.4'
  implementation 'org.apache.commons:commons-lang3:3.11'</pre>
</div>
</li>
<li class="listitem">
<p>Add the micrometer plugin and its corresponding import to our Javalin app.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">...
import io.javalin.plugin.metrics.MicrometerPlugin;
import io.javalin.core.security.BasicAuthCredentials;
...

Javalin app = Javalin.create(config -&gt; {
   ...
   config.registerPlugin(new MicrometerPlugin());
);</pre>
</div>
</li>
<li class="listitem">
<p>Add a new metrics endpoint and ensure the <code class="literal">BasicAuthCredentials</code> class is
imported as well.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">final Micrometer micrometer = new Micrometer();
app.get("/metrics", ctx -&gt; {
  ctx.status(404);
  if (ctx.basicAuthCredentialsExist()) {
    final BasicAuthCredentials credentials = ctx.basicAuthCredentials();
    if ("metrics".equals(credentials.getUsername()) &amp;&amp; "secret".equals(credentials.getPassword())) {
      ctx.status(200).result(micrometer.scrape());
    }
  }
});</pre>
</div>
<p>Here, the <code class="literal">MicroMeter</code> class is a self-written class named <code class="literal">MicroMeter.java</code>
that sets up a couple of metrics monitors and creates the registry for
Prometheus, which provides the text-based Prometheus output.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">package de.spinscale.javalin;

import io.micrometer.core.instrument.Metrics;
import io.micrometer.core.instrument.binder.jvm.JvmCompilationMetrics;
import io.micrometer.core.instrument.binder.jvm.JvmGcMetrics;
import io.micrometer.core.instrument.binder.jvm.JvmHeapPressureMetrics;
import io.micrometer.core.instrument.binder.jvm.JvmMemoryMetrics;
import io.micrometer.core.instrument.binder.jvm.JvmThreadMetrics;
import io.micrometer.core.instrument.binder.logging.Log4j2Metrics;
import io.micrometer.core.instrument.binder.system.FileDescriptorMetrics;
import io.micrometer.core.instrument.binder.system.ProcessorMetrics;
import io.micrometer.core.instrument.binder.system.UptimeMetrics;
import io.micrometer.prometheus.PrometheusConfig;
import io.micrometer.prometheus.PrometheusMeterRegistry;

public class Micrometer {

    final PrometheusMeterRegistry registry = new PrometheusMeterRegistry(new PrometheusConfig() {
        @Override
        public String get(String key) {
            return null;
        }

        @Override
        public String prefix() {
            return "javalin";
        }
    });

    public Micrometer() {
        Metrics.addRegistry(registry);
        new JvmGcMetrics().bindTo(Metrics.globalRegistry);
        new JvmHeapPressureMetrics().bindTo(Metrics.globalRegistry);
        new JvmThreadMetrics().bindTo(Metrics.globalRegistry);
        new JvmCompilationMetrics().bindTo(Metrics.globalRegistry);
        new JvmMemoryMetrics().bindTo(Metrics.globalRegistry);
        new Log4j2Metrics().bindTo(Metrics.globalRegistry);
        new UptimeMetrics().bindTo(Metrics.globalRegistry);
        new FileDescriptorMetrics().bindTo(Metrics.globalRegistry);
        new ProcessorMetrics().bindTo(Metrics.globalRegistry);
    }

    public String scrape() {
        return registry.scrape();
    }
}</pre>
</div>
</li>
<li class="listitem">
<p>Rebuild your app and poll the metrics endpoint.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">curl localhost:7000/metrics -u metrics:secret</pre>
</div>
<p>This returns a line based response with one metric per line. This is the
standard Prometheus format.</p>
</li>
</ol>
</div>
<h4><a id="_install_and_configure_metricbeat_2"></a>Install and configure Metricbeat<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>To send metrics to Elasticsearch, Metricbeat is required. To download and install Metricbeat,
use the commands that work with your system:</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Install-m">
    <button role="tab"
            aria-selected="true"
            aria-controls="deb-tab-install-metricbeat"
            id="deb-install-metricbeat">
      DEB
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="rpm-tab-install-metricbeat"
            id="rpm-install-metricbeat"
            tabindex="-1">
      RPM
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="mac-tab-install-metricbeat"
            id="mac-install-metricbeat"
            tabindex="-1">
      MacOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-install-metricbeat"
            id="linux-install-metricbeat"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-install-metricbeat"
            id="win-install-metricbeat"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="deb-tab-install-metricbeat"
       aria-labelledby="deb-install-metricbeat">
<p>Version 8.16.0 of Metricbeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="rpm-tab-install-metricbeat"
       aria-labelledby="rpm-install-metricbeat"
       hidden="">
<p>Version 8.16.0 of Metricbeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-install-metricbeat"
       aria-labelledby="mac-install-metricbeat"
       hidden="">
<p>Version 8.16.0 of Metricbeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-install-metricbeat"
       aria-labelledby="linux-install-metricbeat"
       hidden="">
<p>Version 8.16.0 of Metricbeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-install-metricbeat"
       aria-labelledby="win-install-metricbeat"
       hidden="">
<p>Version 8.16.0 of Metricbeat has not yet been released.</p>
  </div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Similar to the Filebeat setup, run the initial set up of all the dashboards
using the admin user, and then use an API key.</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">POST /_security/api_key
{
  "name": "metricbeat_javalin-app",
  "role_descriptors": {
    "metricbeat_writer": {
      "cluster": ["monitor", "read_ilm"],
      "index": [
        {
          "names": ["metricbeat-*"],
          "privileges": ["view_index_metadata", "create_doc"]
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/75.console"></div>
</li>
<li class="listitem">
<p>Store the combination of <code class="literal">id</code> and <code class="literal">api_key</code> fields in the keystore.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">./metricbeat keystore create
echo -n "IhrJJHMB4JmIUAPLuM35:1GbfxhkMT8COBB4JWY3pvQ" | ./metricbeat keystore add ES_API_KEY --stdin
echo -n "observability-javalin-app:ZXUtY2VudHJhbC0xLmF3cy5jbG91ZC5lcy5pbyQ4NDU5M2I1YmQzYTY0N2NhYjA2MWQ3NTJhZWFhNWEzYyQzYmQwMWE2OTQ2MmQ0N2ExYjdhYTkwMzI0YjJiOTMyYQ==" | ./metricbeat keystore add CLOUD_ID --stdin</pre>
</div>
<p>Don’t forget to do the initial setup like this.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">./metricbeat setup -e -E 'cloud.id=${CLOUD_ID}' -E 'cloud.auth=elastic:YOUR_SUPER_SECRET_PASS'</pre>
</div>
</li>
<li class="listitem">
<p>Configure Metricbeat to read our Prometheus metrics. Start with a
basic <code class="literal">metricbeat.yaml</code>.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">metricbeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: false

name: javalin-metrics-shipper

cloud.id: ${CLOUD_ID}
output.elasticsearch:
  api_key: ${ES_API_KEY}

processors:
  - add_host_metadata: ~
  - add_cloud_metadata: ~
  - add_docker_metadata: ~
  - add_kubernetes_metadata: ~</pre>
</div>
<p>As Metricbeat supports dozens of modules, which in turn are different
ways of ingesting metrics (the same applies to Filebeat with different
types of log files and formats), the Prometheus module needs to be enabled.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">./metricbeat modules enable prometheus</pre>
</div>
<p>Add the Prometheus endpoint to poll in <code class="literal">./modules.d/prometheus.yml</code>:</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">- module: prometheus
  period: 10s
  hosts: ["localhost:7000"]
  metrics_path: /metrics
  username: "metrics"
  password: "secret"
  use_types: true
  rate_counters: true</pre>
</div>
</li>
<li class="listitem">
To improve security, you should add the username and the
password to the keystore and refer to both in the configuration.
</li>
<li class="listitem">
Start Metricbeat.
</li>
</ol>
</div>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Start-m">
    <button role="tab"
            aria-selected="true"
            aria-controls="deb-tab-start-metricbeat"
            id="deb-start-metricbeat">
      DEB
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="rpm-tab-start-metricbeat"
            id="rpm-start-metricbeat"
            tabindex="-1">
      RPM
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="mac-tab-start-metricbeat"
            id="mac-start-metricbeat"
            tabindex="-1">
      MacOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-start-metricbeat"
            id="linux-start-metricbeat"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-start-metricbeat"
            id="win-start-metricbeat"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="deb-tab-start-metricbeat"
       aria-labelledby="deb-start-metricbeat">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo service metricbeat start</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you use an <code class="literal">init.d</code> script to start Metricbeat, you can&#8217;t specify command
line flags (see <a href="/guide/en/beats/metricbeat/master/command-line-options.html" class="ulink" target="_top">Command reference</a>). To specify flags, start Metricbeat in
the foreground.</p>
</div>
</div>
<p>Also see <a href="/guide/en/beats/metricbeat/master/running-with-systemd.html" class="ulink" target="_top">Metricbeat and systemd</a>.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="rpm-tab-start-metricbeat"
       aria-labelledby="rpm-start-metricbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo service metricbeat start</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you use an <code class="literal">init.d</code> script to start Metricbeat, you can&#8217;t specify command
line flags (see <a href="/guide/en/beats/metricbeat/master/command-line-options.html" class="ulink" target="_top">Command reference</a>). To specify flags, start Metricbeat in
the foreground.</p>
</div>
</div>
<p>Also see <a href="/guide/en/beats/metricbeat/master/running-with-systemd.html" class="ulink" target="_top">Metricbeat and systemd</a>.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-start-metricbeat"
       aria-labelledby="mac-start-metricbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo chown root metricbeat.yml <a id="CO107-1"></a><i class="conum" data-value="1"></i>
sudo ./metricbeat -e</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO107-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>You&#8217;ll be running Metricbeat as root, so you need to change ownership
of the configuration file, or run Metricbeat with <code class="literal">--strict.perms=false</code>
specified. See
<a href="/guide/en/beats/libbeat/master/config-file-permissions.html" class="ulink" target="_top">Config File Ownership and Permissions</a>.</p>
</td>
</tr>
</table>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-start-metricbeat"
       aria-labelledby="linux-start-metricbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo chown root metricbeat.yml <a id="CO108-1"></a><i class="conum" data-value="1"></i>
sudo ./metricbeat -e</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO108-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>You&#8217;ll be running Metricbeat as root, so you need to change ownership
of the configuration file, or run Metricbeat with <code class="literal">--strict.perms=false</code>
specified. See
<a href="/guide/en/beats/libbeat/master/config-file-permissions.html" class="ulink" target="_top">Config File Ownership and Permissions</a>.</p>
</td>
</tr>
</table>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-start-metricbeat"
       aria-labelledby="win-start-metricbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">PS C:\Program Files\metricbeat&gt; Start-Service metricbeat</pre>
</div>
<p>By default, Windows log files are stored in <code class="literal">C:\ProgramData\metricbeat\Logs</code>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>On Windows, statistics about system load and swap usage are currently
not captured</p>
</div>
</div>
  </div>
</div>
<p>Verify that the Prometheus events are flowing into
Elasticsearch.</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET metricbeat-*/_search?filter_path=**.prometheus,hits.total
{
  "query": {
    "term": {
      "event.module": "prometheus"
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/76.console"></div>
<h2><a id="_step_6_view_metrics_in_kibana"></a>Step 6: View metrics in Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h2>
<p>As this is custom data from our Javalin app, there is no predefined
dashboard for displaying this data.</p>
<p>Let’s check for the number of logging messages per log level.</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">GET metricbeat-*/_search
{
  "query": {
    "exists": {
      "field": "prometheus.log4j2_events_total.counter"
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/77.console"></div>
<p>Visualize the number of log messages over time, split by the
log level. Since the Elastic Stack 7.7, there is a new way of creating a
visualization called <code class="literal">Lens</code>.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Log into Kibana and select <span class="strong strong"><strong>Visualize</strong></span> &#8594; <span class="strong strong"><strong>Create Visualization</strong></span>.
</li>
<li class="listitem">
<p>Create a line chart and select <code class="literal">metricbeat-*</code> as the source.</p>
<p>The basic idea is to have a
<a href="/guide/en/elasticsearch/reference/master/search-aggregations-metrics-max-aggregation.html" class="ulink" target="_top">max
aggregation</a> on the y-axis on the <code class="literal">prometheus.log4j2_events_total.rate</code>
field, whereas the x-axis, is split by date using a
<a href="/guide/en/elasticsearch/reference/master/search-aggregations-bucket-datehistogram-aggregation.html" class="ulink" target="_top">date_histogram
aggregation</a> on the <code class="literal">@timestamp</code> field.</p>
<p>There is one more split within
each date histogram bucket, split by log level, using a
<a href="/guide/en/elasticsearch/reference/master/search-aggregations-bucket-terms-aggregation.html" class="ulink" target="_top">terms
aggregation</a> on the <code class="literal">prometheus.labels.level</code>, which contains the log
level. Also, increase the size of the log level to six to display
every log level.</p>
<p>The final result looks like this.</p>
<p class="screenshot"><span class="image"><img src="./images/monitor-java-app-metrics-kibana-create-visualization-log-rate.png" alt="Date Histogram of the log rate per log level"></span></p>
</li>
</ol>
</div>
<h4><a id="_visualize_open_files_over_time"></a>Visualize open files over time<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>The second visualization is to be a check for the number of open
files in our application.</p>
<p>As no one can remember all the field names, let’s again look at the metrics
output again first.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">curl -s localhost:7000/metrics -u metrics:secret | grep ^process
process_files_max_files 10240.0
process_cpu_usage 1.8120711232436825E-4
process_uptime_seconds 72903.726
process_start_time_seconds 1.594048883317E9
process_files_open_files 61.0</pre>
</div>
<p>Let&#8217;s look at the <code class="literal">process_files_open_files</code> metric. This should be a rather static value that rarely changes.
If you run an application which stores data within the JVM or opens and closes network
sockets, this metric increases and decreases depending on the load. With a web application,
this is rather static. Let’s figure out why there are 60 files open on our
small web application.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Run <code class="literal">jps</code> that will contain your App in the process list.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">$ jps
14224 Jps
82437 Launcher
82438 App
40895</pre>
</div>
</li>
<li class="listitem">
<p>Use <code class="literal">lsof</code> on that process.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">$ lsof -p 82438</pre>
</div>
<p>You will see more output than just all the files being opened,
as a file is also a TCP connection happening right now.</p>
</li>
<li class="listitem">
<p>Add an endpoint to increase the number of open files by
having long-running HTTP connections (each connection is also considered
an open file as it requires a file descriptor), and then run <code class="literal">wrk</code>
against it.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">...
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.Executor;
import java.util.concurrent.TimeUnit;
...

public static void main(String[] args) {
...
    final Executor executor = CompletableFuture.delayedExecutor(20, TimeUnit.SECONDS);
    app.get("/wait", ctx -&gt; {
        CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; "done", executor);
        ctx.result(future);
    });
...</pre>
</div>
<p>Every future gets delayed by 20 seconds, which means that a single HTTP
request stays open for 20 seconds.</p>
</li>
<li class="listitem">
<p>Let’s run a <code class="literal">wrk</code> workload.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">wrk -c 100 -t 20 -d 5m http://localhost:7000/wait</pre>
</div>
<p>Results show that only twenty requests were sent, which makes sense
given the processing time.</p>
<p>Now let’s build a visualization using
<a href="/guide/en/kibana/master/dashboard.html#create-panels-with-lens" class="ulink" target="_top">Lens</a> in Kibana.</p>
<p class="screenshot"><span class="image"><img src="./images/monitor-java-app-metrics-kibana-create-visualization-open-files.png" alt="Lens visualization"></span></p>
</li>
<li class="listitem">
<p>Below <code class="literal">Add filter</code>, select the <code class="literal">metricbeat-*</code> index
pattern. This will likely use
<code class="literal">filebeat-*</code> as the default.</p>
<p>The x-axis uses the <code class="literal">@timestamp</code> field -
which in turn will create a <code class="literal">date_histogram</code> aggregation again. The
y-axis should not be the document count, as that one will always be
stable, but the maximum value of the documents in the buckets. Click on the right of
the field name on the y-axis and select <code class="literal">Max</code>. This gives you a similar
visualization than shown, with a peak where you ran the <code class="literal">wrk</code> command above.</p>
</li>
<li class="listitem">
<p>Now let&#8217;s have a look at the Infrastructure app in Kibana. Select <span class="strong strong"><strong>Observability</strong></span> &#8594; <span class="strong strong"><strong>Infrastructure</strong></span>.</p>
<p>You will only see data from a single shipper. Still, the moment
you are running several services and the ability to group this per
Kubernetes pod or host enables you to spot hosts with elevated
CPU or memory consumption.</p>
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Metrics Explorer</strong></span>, you can
start exploring your data for specific hosts or the CPU usage across your
nodes.</p>
<p class="screenshot"><span class="image"><img src="./images/monitor-java-app-metrics-ui-prometheus-event-counter.png" alt="Metrics UI Log Counter"></span></p>
<p>This is an area chart of the total events counter the Javalin app emits.
It’s rising because there is a component
polling an endpoint that, in turn, produces another log message. The
steeper peek was due to sending more requests. But where is the sudden
drop-off coming from? A JVM restart. As those metrics are not
persisted, they reset on a JVM restart. With that in mind, it’s
often better to log the <code class="literal">rate</code> instead of the <code class="literal">counter</code> field.</p>
</li>
</ol>
</div>
<h2><a id="_step_7_instrument_the_application"></a>Step 7: Instrument the application<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h2>
<p>The third piece of Observability is Application Performance Management (APM).
An APM setup consists of an APM server which accepts the data (and is
already running within our Elastic Cloud setup) and an agent delivering
the data to the server.</p>
<p>The agent has two tasks: instrumenting the Java application to
extract application performance information and sending that data to the APM Server.</p>
<p>One of the APM&#8217;s core ideas is the ability to follow the flow of a user
session across your whole stack, regardless of whether you have dozens of
microservices or a monolith answering your user requests. This implies
the ability to tag a request across your entire stack.</p>
<p>To fully capture user activity, you need to start in the
browser of the user using Real User Monitoring (RUM) down to your
application, which sends a SQL query to your database.</p>
<h4><a id="_data_model"></a>Data Model<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>Despite a heavily fragmented APM landscape, the terminology often is
similar. The two most important terms are <span class="strong strong"><strong>Spans</strong></span> and
<span class="strong strong"><strong>Transactions</strong></span>.</p>
<p>A transaction encapsulates a series of spans, which contain
information about the execution of a piece of code. Let’s take a look at
this screenshot from the Kibana APM UI.</p>
<p class="screenshot"><span class="image"><img src="./images/monitor-java-app-apm-transactions.png" alt="A transaction with spans"></span></p>
<p>This is a Spring Boot application. The
<code class="literal">UserProfileController.showProfile()</code> method is called, which is marked as the
transaction. There are two spans within. First, a request is sent to
Elasticsearch using the Elasticsearch REST client, and after the
response is rendered using Thymeleaf. The request to Elasticsearch is faster than the
rendering in this case.</p>
<p>The Java APM agent can instrument specific frameworks
automatically. Spring and Spring Boot are supported well, and the
above data was created by adding the agent to the Spring Boot
application; there is no configuration necessary.</p>
<p>There are currently agents for Go, .NET, Node, Python, Ruby, and the browser (RUM). Agents
keep getting added so you may want to check the
<a href="/guide/en/apm/agent/index.html" class="ulink" target="_top">APM agent
documentation</a>.</p>
<h4><a id="_add_the_apm_agent_to_your_code"></a>Add the APM agent to your code<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>You have two options to add Java agent instrumentation to your
application.</p>
<p>First, you can add the agent via a parameter when calling the <code class="literal">java</code>
binary. This way, it does not interfere with the packaging of the
application. This mechanism instruments the application when starting
up.</p>
<p>First, download the agent, you can check
<a href="https://search.maven.org/search?q=g:co.elastic.apm%20AND%20a:elastic-apm-agent" class="ulink" target="_top">for
the most recent version</a>.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">wget https://repo1.maven.org/maven2/co/elastic/apm/elastic-apm-agent/1.17.0/elastic-apm-agent-1.17.0.jar</pre>
</div>
<p>Specify the agent on startup as well as the configuration
parameters of where to send the APM data to. Before starting the Java application,
let’s get an API key for our APM server running in Elastic Cloud.</p>
<p>When you check your deployment in Elastic Cloud and click on <code class="literal">APM</code> on
the left, you will see the <code class="literal">APM Server Secret Token</code>, which you can use.
Also you can copy the APM endpoint URL from there.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">java -javaagent:/path/to/elastic-apm-agent-1.17.0.jar\
  -Delastic.apm.service_name=javalin-app \
  -Delastic.apm.application_packages=de.spinscale.javalin \
  -Delastic.apm.server_urls=$APM_ENDPOINT_URL \
  -Delastic.apm.secret_token=PqWTHGtHZS2i0ZuBol \
  -jar build/libs/javalin-app-all.jar</pre>
</div>
<p>You could now go ahead and open up the APM UI and you should see the
data flowing in.</p>
<h4><a id="_automatic_attachment"></a>Automatic attachment<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>If you do not want to change the startup options of your application,
the standalone agent allows you to attach to running JVMs on a host.</p>
<p>This requires you to download the standalone jar. You can find the link
on the
<a href="/guide/en/apm/agent/java/current/setup-attach-cli.html" class="ulink" target="_top">official
docs</a>.</p>
<p>To list your locally running java application, you can run</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">java -jar /path/to/apm-agent-attach-1.17.0-standalone.jar --list</pre>
</div>
<p>As I usually run more than a single java app on my system, I specify the
application to attach to. Also, make sure, that you have stopped your
Javalin application with the agent already attached and just start a
regular Javalin app without the agent configured to attach.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">java -jar /tmp/apm-agent-attach-1.17.0-standalone.jar --pid 30730 \
  --config service_name=javalin-app \
  --config application_packages=de.spinscale.javalin \
  --config server_urls=$APM_ENDPOINT_URL \
  --config secret_token=PqWTHGtHZS2i0ZuBol</pre>
</div>
<p>This above message will return something like this:</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">2020-07-10 15:04:48.144  INFO Attaching the Elastic {apm-agent} to 30730
2020-07-10 15:04:49.649  INFO Done</pre>
</div>
<p>So now the agent was attached to a running application with a special
configuration.</p>
<p>While both of the first two possibilities work, you can also use the third
one: using the APM agent as a direct dependency. This allows you to write
custom spans and transactions within our application.</p>
<h4><a id="_programmatic_setup"></a>Programmatic setup<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>A programmatic setup allows you to attach the agent via a line of java in
your source code.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add the java agent dependency.</p>
<div class="pre_wrapper lang-gradle">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-gradle">dependencies {
  ...
  implementation 'co.elastic.apm:apm-agent-attach:1.17.0'
  ...
}</pre>
</div>
</li>
<li class="listitem">
<p>Instrument the application right at the start in our <code class="literal">main()</code> method.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">import co.elastic.apm.attach.ElasticApmAttacher;

...

public static void main(String[] args) {
    ElasticApmAttacher.attach();
    ...
}</pre>
</div>
<p>We did not configure any endpoint or API tokens yet. While the
<a href="/guide/en/apm/agent/java/current/setup-attach-api.html#setup-attach-api-configuration" class="ulink" target="_top">documentation</a>
recommends using the <code class="literal">src/main/resources/elasticapm.properties</code> file, I
prefer the use of environment variables, as this prevents
either committing API tokens to your source or merging another
repository. Mechanisms like <a href="https://www.vaultproject.io/" class="ulink" target="_top">vault</a> allow
you to manage your secrets in such a way.</p>
<p>For our local deployment, I usually use something like
<a href="https://direnv.net/" class="ulink" target="_top">direnv</a> for local setup. <code class="literal">direnv</code> is an extension
for your local shell that loads/unloads environment variables when you
enter a directory, like your application. <code class="literal">direnv</code> can do quite a bit
more like loading the right node/ruby version or adding a directory to
your $PATH variable.</p>
</li>
<li class="listitem">
<p>To enable <code class="literal">direnv</code>, you need to create a <code class="literal">.envrc</code> file with this.</p>
<div class="pre_wrapper lang-text">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-text">dotenv</pre>
</div>
<p>This tells <code class="literal">direnv</code> to load the contents of the <code class="literal">.env</code> file as
environment variables. The <code class="literal">.env</code> file should look like this:</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">ELASTIC_APM_SERVICE_NAME=javalin-app
ELASTIC_APM_SERVER_URLS=https://APM_ENDPOINT_URL
ELASTIC_APM_SECRET_TOKEN=PqWTHGtHZS2i0ZuBol</pre>
</div>
<p>If you are not comfortable with putting sensitive data in that <code class="literal">.env</code>
file, you can use tools like <a href="https://github.com/sorah/envchain" class="ulink" target="_top">envchain</a>
or call arbitrary commands in the <code class="literal">.envrc</code> file like accessing Vault.</p>
</li>
<li class="listitem">
<p>You can now run the java application as you did before.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">java -jar build/libs/javalin-app-all.jar</pre>
</div>
<p>If you want to run this in your IDE, you can either set the environment
variables manually or search for a plugin that supports <code class="literal">.env</code> files.</p>
<p>Wait a few minutes and let’s finally take a look at the APM UI.</p>
<p class="screenshot"><span class="image"><img src="./images/monitor-java-app-apm-ui-javalin-app.png" alt="Javalin App APM UI"></span></p>
<p>As you can see, this is quite the difference to the Spring Boot
application shown earlier. The different endpoints are not listed; we
can see the requests per minute though including errors.</p>
<p>The only transaction comes from a single servlet, which is not too helpful.
Let’s try to fix this by introducing custom programmatic transactions.</p>
</li>
</ol>
</div>
<h4><a id="_custom_transactions"></a>Custom transactions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add another dependency.</p>
<div class="pre_wrapper lang-gradle">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-gradle">dependencies {
  ...
  implementation 'co.elastic.apm:apm-agent-attach:1.17.0'
  implementation 'co.elastic.apm:apm-agent-api:1.17.0'
  ...
}</pre>
</div>
</li>
<li class="listitem">
<p>Fix the name of the transactions to include the HTTP method
and the request path</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">app.before(ctx -&gt; ElasticApm.currentTransaction()
  .setName(ctx.method() + " " + ctx.path()));</pre>
</div>
</li>
<li class="listitem">
<p>Restart your app and see data flowing in. Test a few different
endpoints, especially the one that throws exceptions and the one
that triggers a 404.</p>
<p class="screenshot"><span class="image"><img src="./images/monitor-java-app-apm-ui-javalin-with-transaction-names.png" alt="APM UI with correct transaction names"></span></p>
<p>This looks much better, having differences between endpoints.</p>
</li>
<li class="listitem">
<p>Add another endpoint to see the power of transactions, which polls
another HTTP service. You may have heard of <a href="https://wttr.in/" class="ulink" target="_top">wttr.in</a>, a
service to poll weather information from. Let&#8217;s implement a proxy
HTTP method that forwards the request to that endpoint. Let’s use
<a href="https://hc.apache.org/httpcomponents-client-4.5.x/quickstart.html" class="ulink" target="_top">Apache
HTTP client</a>, one of the most typical HTTP clients out there.</p>
<div class="pre_wrapper lang-gradle">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-gradle">implementation 'org.apache.httpcomponents:fluent-hc:4.5.12'</pre>
</div>
<p>This is our new endpoint.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">import org.apache.http.client.fluent.Request;

...

public static void main(String[] args) {
...

    app.get("/weather/:city", ctx -&gt; {
        String city = ctx.pathParam("city");
        ctx.result(Request.Get("https://wttr.in/" + city + "?format=3").execute()
            .returnContent().asBytes())
            .contentType("text/plain; charset=utf-8");
    });

...</pre>
</div>
</li>
<li class="listitem">
<p>Curl <code class="literal">http://localhost:7000/weather/Munich</code> and
see a one-line response about the current weather. Let’s check the APM
UI.</p>
<p>In the overview, you can see that most time is spent in the HTTP
client, which is not surprising.</p>
<p class="screenshot"><span class="image"><img src="./images/monitor-java-app-apm-ui-javalin-wttr-1.png" alt="Overview"></span></p>
<p>Our transactions for the <code class="literal">/weather/Munich</code> now contain a span,
showing how much time is spent on retrieving the weather data. Because
the HTTP client is instrumented automatically, there is no need to do
anything.</p>
<p class="screenshot"><span class="image"><img src="./images/monitor-java-app-apm-ui-javalin-wttr-2.png" alt="Transaction with span"></span></p>
<p>If the <code class="literal">city</code> parameter if that URL is of high
cardinality, this will result in a high amount of URLs mentioned instead of
the generic endpoint. If you would like to prevent this, a possibility would
be to use <code class="literal">ctx.matchedPath()</code> to log every call to the weather API as
<code class="literal">GET /weather/:city</code>. This however requires some refactoring by removing the
<code class="literal">app.before()</code> handler and replacing it with a <code class="literal">app.after()</code> handler.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">app.after(ctx -&gt; ElasticApm.currentTransaction().setName(ctx.method()
  + " " + ctx.endpointHandlerPath()));</pre>
</div>
</li>
</ol>
</div>
<h4><a id="_method_tracing_via_agent_configuration"></a>Method tracing via agent configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>Instead of writing code to trace methods, you can also configure the
agent to do this. Let’s try to figure out if
logging is a bottleneck for our application and trace the request logger
statements we added earlier.</p>
<p>The agent can
<a href="/guide/en/apm/agent/java/current/config-core.html#config-trace-methods" class="ulink" target="_top">trace
methods</a> based on their signature.</p>
<p>The interface to monitor would be the <code class="literal">io.javalin.http.RequestLogger</code>
interface with the <code class="literal">handle</code> method. So let’s try
<code class="literal">io.javalin.http.RequestLogger#handle</code> to identify the method to log
and put this in your <code class="literal">.env</code>.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">ELASTIC_APM_TRACE_METHODS="de.spinscale.javalin.Log4j2RequestLogger#handle"</pre>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create a dedicated logger class as well to match the above trace method.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">package de.spinscale.javalin;

import io.javalin.http.Context;
import io.javalin.http.RequestLogger;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class Log4j2RequestLogger implements RequestLogger  {

    private final Logger logger = LoggerFactory.getLogger(Log4j2RequestLogger.class);

    @Override
    public void handle(@NotNull Context ctx, @NotNull Float executionTimeMs) throws Exception {
        String userAgent = ctx.userAgent() != null ? ctx.userAgent() : "-";
        logger.info("{} {} {} {} \"{}\" {}",
                ctx.method(), ctx.req.getPathInfo(), ctx.res.getStatus(),
                ctx.req.getRemoteHost(), userAgent, executionTimeMs.longValue());
    }
}</pre>
</div>
</li>
<li class="listitem">
<p>Fix the call in our <code class="literal">App</code> class.</p>
<div class="pre_wrapper lang-java">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-java">config.requestLogger(new Log4j2RequestLogger());</pre>
</div>
</li>
<li class="listitem">
<p>Restart your app, and see how much time your logging takes.</p>
<p class="screenshot"><span class="image"><img src="./images/monitor-java-app-apm-ui-logging-trace.png" alt="Logging caller trace"></span></p>
<p>The request logger takes roughly 400 microseconds. The whole request takes
about 1.3 milliseconds. Approximately a third of the processing of our request goes into logging.</p>
<p>If you are on the quest for a faster service, you may want to
rethink logging. However, this logging happens after the result is written
to the client, so while the total processing time increases with logging,
responding to the client does not (closing the connection however might
be). Also note that these tests were conducted without a proper warm-up. I
assume that after appropriate JVM warm-up, you will have much faster processing of
requests.</p>
</li>
</ol>
</div>
<h4><a id="_automatic_profiling_of_inferred_spans"></a>Automatic profiling of inferred spans<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>Once you have a bigger application with more code paths than our sample
app, you can try to enable the
<a href="/guide/en/apm/agent/java/current/config-profiling.html#config-profiling-inferred-spans-enabled" class="ulink" target="_top">automatic
profiling of inferred spans</a> by setting the following.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">ELASTIC_APM_PROFILING_INFERRED_SPANS_ENABLED=true</pre>
</div>
<p>This mechanism uses the
<a href="https://github.com/jvm-profiling-tools/async-profiler" class="ulink" target="_top">async profiler</a> to
create spans without you having to instrument anything allowing you to
find bottlenecks faster.</p>
<h4><a id="_log_correlation"></a>Log correlation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>Transaction ids are automatically added to logs.
You can check the generated log files that are sent
to Elasticsearch via Filebeat. An entry looks like this.</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "@timestamp": "2020-07-13T12:03:22.491Z",
  "log.level": "INFO",
  "message": "GET / 200 0:0:0:0:0:0:0:1 \"curl/7.64.1\" 0",
  "service.name": "my-javalin-app",
  "event.dataset": "my-javalin-app.log",
  "process.thread.name": "qtp34871826-36",
  "log.logger": "de.spinscale.javalin.Log4j2RequestLogger",
  "trace.id": "ed735860ec0cd3ee3bdf80ed7ea47afb",
  "transaction.id": "8af7dff698937dc5"
}</pre>
</div>
<p>Having the <code class="literal">trace.id</code> and <code class="literal">transaction.id</code> added, in the case of an error
you will get an <code class="literal">error.id</code> field.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>We have not covered the
<a href="/guide/en/apm/agent/java/current/opentracing-bridge.html" class="ulink" target="_top">Elastic
APM OpenTracing bridge</a> or looked into the
<a href="/guide/en/apm/agent/java/current/metrics.html" class="ulink" target="_top">additional
metrics</a> the agent provides, which allows us to take a look at things
like garbage collection or the memory footprint of our application.</p>
</div>
</div>
<h3><a id="_step_8_ingest_uptime_data"></a>Step 8: Ingest Uptime data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h3>
<p>There are some basic monitoring capabilities in our application so far. We index
logs (with traces), we index metrics, and we even can look in our app to
figure out single performance bottlenecks thanks to APM. However, there is
still one weak spot. Everything done so far was within the application, but all
the users are reaching the application from the internet.</p>
<p>How about checking if our users have the same experience that our APM data
is suggesting to us. Imagine having a lagging load balancer fronting your app,
that costs you an additional 50 milliseconds per request. That would be devastating. Or
TLS negotiation being costly. Even though none of those external events is your fault, you will
still be impacted by this and should try to mitigate those. This means you
need to know about them first.</p>
<p><a href="/uptime-monitoring" class="ulink" target="_top">Uptime</a> not only enables you to monitor the availability
of a service, but also graph latencies over time, and get notified about expiring TLS certificates.</p>
<h4><a id="_setup"></a>Setup<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h4>
<p>To send uptime data to Elasticsearch, Heartbeat (the polling component) is required. To download
and install Heartbeat, use the commands that work with your system:</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Install-h">
    <button role="tab"
            aria-selected="true"
            aria-controls="deb-tab-install-heartbeat"
            id="deb-install-heartbeat">
      DEB
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="rpm-tab-install-heartbeat"
            id="rpm-install-heartbeat"
            tabindex="-1">
      RPM
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="mac-tab-install-heartbeat"
            id="mac-install-heartbeat"
            tabindex="-1">
      MacOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-install-heartbeat"
            id="linux-install-heartbeat"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-install-heartbeat"
            id="win-install-heartbeat"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="deb-tab-install-heartbeat"
       aria-labelledby="deb-install-heartbeat">
<p>Version 8.16.0 of Heartbeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="rpm-tab-install-heartbeat"
       aria-labelledby="rpm-install-heartbeat"
       hidden="">
<p>Version 8.16.0 of Heartbeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-install-heartbeat"
       aria-labelledby="mac-install-heartbeat"
       hidden="">
<p>Version 8.16.0 of Heartbeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-install-heartbeat"
       aria-labelledby="linux-install-heartbeat"
       hidden="">
<p>Version 8.16.0 of Heartbeat has not yet been released.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-install-heartbeat"
       aria-labelledby="win-install-heartbeat"
       hidden="">
<p>Version 8.16.0 of Heartbeat has not yet been released.</p>
  </div>
</div>
<p>After downloading and unpacking, we have to set up the cloud id and the
password one more time.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>We need to create another <code class="literal">API_KEY</code> as an elastic admin user in Kibana.</p>
<div class="pre_wrapper lang-console">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-console">POST /_security/api_key
{
  "name": "heartbeat_javalin-app",
  "role_descriptors": {
    "heartbeat_writer": {
      "cluster": ["monitor", "read_ilm"],
      "index": [
        {
          "names": ["heartbeat-*"],
          "privileges": ["view_index_metadata", "create_doc"]
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/78.console"></div>
</li>
<li class="listitem">
<p>Let’s setup the Heartbeat keystore and run the setup.</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">./heartbeat keystore create
echo -n "observability-javalin-app:ZXUtY2VudHJhbC0xLmF3cy5jbG91ZC5lcy5pbyQ4NDU5M2I1YmQzYTY0N2NhYjA2MWQ3NTJhZWFhNWEzYyQzYmQwMWE2OTQ2MmQ0N2ExYjdhYTkwMzI0YjJiOTMyYQ==" | ./heartbeat keystore add CLOUD_ID --stdin
echo -n "SCdUSHMB1JmLUFPLgWAY:R3PQzBWW3faJT01wxXD6uw" | ./heartbeat keystore add ES_API_KEY --stdin

./heartbeat setup -e -E 'cloud.id=${CLOUD_ID}' -E 'cloud.auth=elastic:YOUR_SUPER_SECRET_PASS'</pre>
</div>
</li>
<li class="listitem">
<p>Add some services to monitor.</p>
<div class="pre_wrapper lang-yaml">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-yaml">name: heartbeat-shipper

cloud.id: ${CLOUD_ID}
output.elasticsearch:
  api_key: ${ES_API_KEY}

heartbeat.monitors:
  - type: http
    id: javalin-http-app
    name: "Javalin Web Application"
    urls: ["http://localhost:7000"]
    check.response.status: [200]
    schedule: '@every 15s'

  - type: http
    id: httpbin-get
    name: "httpbin GET"
    urls: ["https://httpbin.org/get"]
    check.response.status: [200]
    schedule: '@every 15s'

  - type: tcp
    id: javalin-tcp
    name: "TCP Port 7000"
    hosts: ["localhost:7000"]
    schedule: '@every 15s'

processors:
  - add_observer_metadata:
      geo:
        name: europe-munich
        location: "48.138791, 11.583030"</pre>
</div>
</li>
<li class="listitem">
Now start Heartbeat and wait a couple of minutes to get some data.
</li>
</ol>
</div>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Start-h">
    <button role="tab"
            aria-selected="true"
            aria-controls="deb-tab-start-heartbeat"
            id="deb-start-heartbeat">
      DEB
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="rpm-tab-start-heartbeat"
            id="rpm-start-heartbeat"
            tabindex="-1">
      RPM
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="mac-tab-start-heartbeat"
            id="mac-start-heartbeat"
            tabindex="-1">
      MacOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-start-heartbeat"
            id="linux-start-heartbeat"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-start-heartbeat"
            id="win-start-heartbeat"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="deb-tab-start-heartbeat"
       aria-labelledby="deb-start-heartbeat">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo service heartbeat start</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you use an <code class="literal">init.d</code> script to start Heartbeat, you can&#8217;t specify command
line flags (see <a href="/guide/en/beats/heartbeat/master/command-line-options.html" class="ulink" target="_top">Command reference</a>). To specify flags, start Heartbeat in
the foreground.</p>
</div>
</div>
<p>Also see <a href="/guide/en/beats/heartbeat/master/running-with-systemd.html" class="ulink" target="_top">Heartbeat and systemd</a>.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="rpm-tab-start-heartbeat"
       aria-labelledby="rpm-start-heartbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo service heartbeat start</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you use an <code class="literal">init.d</code> script to start Heartbeat, you can&#8217;t specify command
line flags (see <a href="/guide/en/beats/heartbeat/master/command-line-options.html" class="ulink" target="_top">Command reference</a>). To specify flags, start Heartbeat in
the foreground.</p>
</div>
</div>
<p>Also see <a href="/guide/en/beats/heartbeat/master/running-with-systemd.html" class="ulink" target="_top">Heartbeat and systemd</a>.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-start-heartbeat"
       aria-labelledby="mac-start-heartbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo chown root heartbeat.yml <a id="CO109-1"></a><i class="conum" data-value="1"></i>
sudo ./heartbeat -e</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO109-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>You&#8217;ll be running Heartbeat as root, so you need to change ownership
of the configuration file, or run Heartbeat with <code class="literal">--strict.perms=false</code>
specified. See
<a href="/guide/en/beats/libbeat/master/config-file-permissions.html" class="ulink" target="_top">Config File Ownership and Permissions</a>.</p>
</td>
</tr>
</table>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-start-heartbeat"
       aria-labelledby="linux-start-heartbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">sudo chown root heartbeat.yml <a id="CO110-1"></a><i class="conum" data-value="1"></i>
sudo ./heartbeat -e</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO110-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>You&#8217;ll be running Heartbeat as root, so you need to change ownership
of the configuration file, or run Heartbeat with <code class="literal">--strict.perms=false</code>
specified. See
<a href="/guide/en/beats/libbeat/master/config-file-permissions.html" class="ulink" target="_top">Config File Ownership and Permissions</a>.</p>
</td>
</tr>
</table>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-start-heartbeat"
       aria-labelledby="win-start-heartbeat"
       hidden="">
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">PS C:\Program Files\heartbeat&gt; Start-Service heartbeat</pre>
</div>
<p>By default, Windows log files are stored in <code class="literal">C:\ProgramData\heartbeat\Logs</code>.</p>
  </div>
</div>
<p>To view the Uptime app,
select <span class="strong strong"><strong>Observability</strong></span> &#8594; <span class="strong strong"><strong>Uptime</strong></span>. The overview looks
like this.</p>
<p class="screenshot"><span class="image"><img src="./images/monitor-java-app-uptime-overview.png" alt="Uptime Overview"></span></p>
<p>You can see the list of monitors and a global overview. Let’s see the
details for one of those alerts. Click <span class="strong strong"><strong>Javalin Web Application</strong></span>.</p>
<p>You can see the execution for the last
scheduled checks, but the duration for each check might be more interesting.
You can see if the latency for one of your checks is going up.</p>
<p>The interesting part is the world map at the top. You can specify in the
configuration where the check originated, which in this case was in Munich in Europe.
By configuring several Heartbeats running across the world, you
can compare latencies and figure out which data center you need to run your
application to be next to your users.</p>
<p>The duration of the monitor is in the low milliseconds, as it is really
fast. Check the monitor for the <code class="literal">httpbin.org</code> endpoint, and you will see a
much higher duration. In this case, it is about 400 milliseconds for each request. This
is not too surprising because the endpoint is not nearby, and you need to
initiate a TLS connection for every request, which is costly.</p>
<p>Do not underestimate the importance of this kind of
monitoring. Also, consider this just the beginning as the next step is
to have synthetics that monitor the correct behavior of your
application, for example, to ensure that your checkout process works all
the time.</p>
<h3><a id="_whats_next_3"></a>What&#8217;s next?<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/observability/monitor-java-app.asciidoc">edit</a></h3>
<p>For more information about using  Elastic
Observability, see the <a class="xref" href="observability-introduction.html" title="What is Elastic Observability?">Observability documentation</a>.</p>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="gcp-dataflow.html">« GCP Dataflow templates</a>
</span>
<span class="next">
<a href="monitor-nginx.html">Monitor nginx: Observe the logs and metrics of your nginx instances »</a>
</span>
</div>
</body>
</html>
