<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FirstTime Seen Account Performing DCSync | Elastic Security Solution [8.12] | Elastic</title>
<meta class="elastic" name="content" content="FirstTime Seen Account Performing DCSync | Elastic Security Solution [8.12]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.12]"/>
<link rel="up" href="prebuilt-rule-8-12-7-prebuilt-rules-8-12-7-appendix.html" title="Appendix Z: Downloadable rule update v8.12.7"/>
<link rel="prev" href="prebuilt-rule-8-12-7-potential-credential-access-via-trusted-developer-utility.html" title="Potential Credential Access via Trusted Developer Utility"/>
<link rel="next" href="prebuilt-rule-8-12-7-potential-credential-access-via-dcsync.html" title="Potential Credential Access via DCSync"/>
<meta class="elastic" name="product_version" content="8.12"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.12"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.12"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-12-7-potential-credential-access-via-trusted-developer-utility.html">« Potential Credential Access via Trusted Developer Utility</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-12-7-potential-credential-access-via-dcsync.html">Potential Credential Access via DCSync »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.12]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-12-7-prebuilt-rules-8-12-7-appendix.html">Downloadable rule update v8.12.7</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>FirstTime Seen Account Performing DCSync</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.12/docs/detections/prebuilt-rules/downloadable-packages/8-12-7/prebuilt-rule-8-12-7-firsttime-seen-account-performing-dcsync.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-12-7-firsttime-seen-account-performing-dcsync"></a>FirstTime Seen Account Performing DCSync</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.12/docs/detections/prebuilt-rules/downloadable-packages/8-12-7/prebuilt-rule-8-12-7-firsttime-seen-account-performing-dcsync.asciidoc">edit</a></div>
</div></div></div>
<p>This rule identifies when a User Account starts the Active Directory Replication Process for the first time. Attackers can use the DCSync technique to get credential information of individual accounts or the entire domain, thus compromising the entire domain.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
winlogbeat-*
</li>
<li class="listitem">
logs-system.*
</li>
<li class="listitem">
logs-windows.*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: high</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 73</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.12/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-180815210510.html" class="ulink" target="_top">https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-180815210510.html</a>
</li>
<li class="listitem">
<a href="https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing" class="ulink" target="_top">https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing</a>
</li>
<li class="listitem">
<a href="https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_ad_replication_non_machine_account.yml" class="ulink" target="_top">https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_ad_replication_non_machine_account.yml</a>
</li>
<li class="listitem">
<a href="https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0027_windows_audit_directory_service_access.md" class="ulink" target="_top">https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0027_windows_audit_directory_service_access.md</a>
</li>
<li class="listitem">
<a href="https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync" class="ulink" target="_top">https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync</a>
</li>
<li class="listitem">
<a href="https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync" class="ulink" target="_top">https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Credential Access
</li>
<li class="listitem">
Tactic: Privilege Escalation
</li>
<li class="listitem">
Use Case: Active Directory Monitoring
</li>
<li class="listitem">
Data Source: Active Directory
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 10</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_3443"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.12/docs/detections/prebuilt-rules/downloadable-packages/8-12-7/prebuilt-rule-8-12-7-firsttime-seen-account-performing-dcsync.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating FirstTime Seen Account Performing DCSync</strong></span></p>
<p>Active Directory replication is the process by which the changes that originate on one domain controller are automatically transferred to other domain controllers that store the same data.</p>
<p>Active Directory data consists of objects that have properties, or attributes. Each object is an instance of an object class, and object classes and their respective attributes are defined in the Active Directory schema. Objects are defined by the values of their attributes, and changes to attribute values must be transferred from the domain controller on which they occur to every other domain controller that stores a replica of an affected object.</p>
<p>Adversaries can use the DCSync technique that uses Windows Domain Controller&#8217;s API to simulate the replication process from a remote domain controller, compromising major credential material such as the Kerberos krbtgt keys that are used legitimately for creating tickets, but also for forging tickets by attackers. This attack requires some extended privileges to succeed (DS-Replication-Get-Changes and DS-Replication-Get-Changes-All), which are granted by default to members of the Administrators, Domain Admins, Enterprise Admins, and Domain Controllers groups. Privileged accounts can be abused to grant controlled objects the right to DCsync/Replicate.</p>
<p>More details can be found on <a href="https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing" class="ulink" target="_top">Threat Hunter Playbook</a> and <a href="https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync" class="ulink" target="_top">The Hacker Recipes</a>.</p>
<p>This rule monitors for when a Windows Event ID 4662 (Operation was performed on an Active Directory object) with the access mask 0x100 (Control Access) and properties that contain at least one of the following or their equivalent Schema-Id-GUID (DS-Replication-Get-Changes, DS-Replication-Get-Changes-All, DS-Replication-Get-Changes-In-Filtered-Set) is seen in the environment for the first time in the last 15 days.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Identify the user account that performed the action and whether it should perform this kind of action.
</li>
<li class="listitem">
Contact the account and system owners and confirm whether they are aware of this activity.
</li>
<li class="listitem">
Investigate other alerts associated with the user/host during the past 48 hours.
</li>
<li class="listitem">
Correlate security events 4662 and 4624 (Logon Type 3) by their Logon ID (<code class="literal">winlog.logon.id</code>) on the Domain Controller (DC) that received the replication request. This will tell you where the AD replication request came from, and if it came from another DC or not.
</li>
<li class="listitem">
Scope which credentials were compromised (for example, whether all accounts were replicated or specific ones).
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Administrators may use custom accounts on Azure AD Connect; investigate if this is part of a new Azure AD account setup, and ensure it is properly secured. If the activity was expected and there is no other suspicious activity involving the host or user, the analyst can dismiss the alert.
</li>
<li class="listitem">
Although replicating Active Directory (AD) data to non-Domain Controllers is not a common practice and is generally not recommended from a security perspective, some software vendors may require it for their products to function correctly. Investigate if this is part of a new product setup, and ensure it is properly secured. If the activity was expected and there is no other suspicious activity involving the host or user, the analyst can dismiss the alert.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Initiate the incident response process based on the outcome of the triage.
</li>
<li class="listitem">
Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.
</li>
<li class="listitem">
If the entire domain or the <code class="literal">krbtgt</code> user was compromised:
</li>
<li class="listitem">
Activate your incident response plan for total Active Directory compromise which should include, but not be limited to, a password reset (twice) of the <code class="literal">krbtgt</code> user.
</li>
<li class="listitem">
Investigate how the attacker escalated privileges and identify systems they used to conduct lateral movement. Use this information to determine ways the attacker could regain access to the environment.
</li>
<li class="listitem">
Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.
</li>
<li class="listitem">
Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_1160"></a>Setup</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.12/docs/detections/prebuilt-rules/downloadable-packages/8-12-7/prebuilt-rule-8-12-7-firsttime-seen-account-performing-dcsync.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Setup</strong></span></p>
<p>The <em>Audit Directory Service Access</em> logging policy must be configured for (Success, Failure).
Steps to implement the logging policy with Advanced Audit Configuration:</p>
<pre class="screen">Computer Configuration &gt;
Policies &gt;
Windows Settings &gt;
Security Settings &gt;
Advanced Audit Policies Configuration &gt;
Audit Policies &gt;
DS Access &gt;
Audit Directory Service Access (Success,Failure)</pre>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5274"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.12/docs/detections/prebuilt-rules/downloadable-packages/8-12-7/prebuilt-rule-8-12-7-firsttime-seen-account-performing-dcsync.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.action:("Directory Service Access" or "object-operation-performed") and event.code:"4662" and
 winlog.event_data.Properties:(*DS-Replication-Get-Changes* or *DS-Replication-Get-Changes-All* or
                               *DS-Replication-Get-Changes-In-Filtered-Set* or *1131f6ad-9c07-11d1-f79f-00c04fc2dcd2* or
                               *1131f6aa-9c07-11d1-f79f-00c04fc2dcd2* or *89e95b76-444d-4c62-991a-0facbeda640c*) and
 not winlog.event_data.SubjectUserName:(*$ or MSOL_*)</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: OS Credential Dumping
</li>
<li class="listitem">
ID: T1003
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1003/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1003/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: DCSync
</li>
<li class="listitem">
ID: T1003.006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1003/006/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1003/006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Privilege Escalation
</li>
<li class="listitem">
ID: TA0004
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0004/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0004/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Valid Accounts
</li>
<li class="listitem">
ID: T1078
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1078/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1078/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Domain Accounts
</li>
<li class="listitem">
ID: T1078.002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1078/002/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1078/002/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-12-7-potential-credential-access-via-trusted-developer-utility.html">« Potential Credential Access via Trusted Developer Utility</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-12-7-potential-credential-access-via-dcsync.html">Potential Credential Access via DCSync »</a>
</span>
</div>
</body>
</html>
