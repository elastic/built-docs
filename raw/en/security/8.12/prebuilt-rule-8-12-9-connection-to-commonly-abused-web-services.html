<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Connection to Commonly Abused Web Services | Elastic Security Solution [8.12] | Elastic</title>
<meta class="elastic" name="content" content="Connection to Commonly Abused Web Services | Elastic Security Solution [8.12]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.12]"/>
<link rel="up" href="prebuilt-rule-8-12-9-prebuilt-rules-8-12-9-appendix.html" title="Appendix \: Downloadable rule update v8.12.9"/>
<link rel="prev" href="prebuilt-rule-8-12-9-linux-user-account-creation.html" title="Linux User Account Creation"/>
<link rel="next" href="prebuilt-rule-8-12-9-potential-command-and-control-via-internet-explorer.html" title="Potential Command and Control via Internet Explorer"/>
<meta class="elastic" name="product_version" content="8.12"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.12"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.12"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-12-9-linux-user-account-creation.html">« Linux User Account Creation</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-12-9-potential-command-and-control-via-internet-explorer.html">Potential Command and Control via Internet Explorer »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.12]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-12-9-prebuilt-rules-8-12-9-appendix.html">Downloadable rule update v8.12.9</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Connection to Commonly Abused Web Services</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.12/docs/detections/prebuilt-rules/downloadable-packages/8-12-9/prebuilt-rule-8-12-9-connection-to-commonly-abused-web-services.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="prebuilt-rule-8-12-9-connection-to-commonly-abused-web-services"></a>Connection to Commonly Abused Web Services<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.12/docs/detections/prebuilt-rules/downloadable-packages/8-12-9/prebuilt-rule-8-12-9-connection-to-commonly-abused-web-services.asciidoc">edit</a></h2>
</div></div></div>
<p>Adversaries may implement command and control (C2) communications that use common web services to hide their activity. This attack technique is typically targeted at an organization and uses web services common to the victim network, which allows the adversary to blend into legitimate traffic activity. These popular services are typically targeted since they have most likely been used before compromise, which helps malicious traffic blend in.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
logs-endpoint.events.network-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.12/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>: None</p>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Command and Control
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
<li class="listitem">
Data Source: Elastic Defend
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 112</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_investigation_guide_3769"></a>Investigation guide<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.12/docs/detections/prebuilt-rules/downloadable-packages/8-12-9/prebuilt-rule-8-12-9-connection-to-commonly-abused-web-services.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating Connection to Commonly Abused Web Services</strong></span></p>
<p>Adversaries may use an existing, legitimate external Web service as a means for relaying data to/from a compromised system. Popular websites and social media acting as a mechanism for C2 may give a significant amount of cover due to the likelihood that hosts within a network are already communicating with them prior to a compromise.</p>
<p>This rule looks for processes outside known legitimate program locations communicating with a list of services that can be abused for exfiltration or command and control.</p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Note</strong></span>:
This investigation guide uses the <a href="/guide/en/security/master/invest-guide-run-osquery.html" class="ulink" target="_top">Osquery Markdown Plugin</a> introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.
This investigation guide uses the <a href="/guide/en/security/master/interactive-investigation-guides.html" class="ulink" target="_top">Investigate Markdown Plugin</a> introduced in Elastic Stack version 8.8.0. Older Elastic Stack versions will display unrendered Markdown in this guide.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.
</li>
<li class="listitem">
Investigate other alerts associated with the user/host during the past 48 hours.
</li>
<li class="listitem">
!{investigate{"label":"Alerts associated with the user in the last 48h","providers":[[{"excluded":false,"field":"event.kind","queryType":"phrase","value":"signal","valueType":"string"},{"excluded":false,"field":"user.id","queryType":"phrase","value":"{{user.id}}","valueType":"string"}]],"relativeFrom":"now-48h/h","relativeTo":"now"}}
</li>
<li class="listitem">
!{investigate{"label":"Alerts associated with the host in the last 48h","providers":[[{"excluded":false,"field":"event.kind","queryType":"phrase","value":"signal","valueType":"string"},{"excluded":false,"field":"host.name","queryType":"phrase","value":"{{host.name}}","valueType":"string"}]],"relativeFrom":"now-48h/h","relativeTo":"now"}}
</li>
<li class="listitem">
Verify whether the digital signature exists in the executable.
</li>
<li class="listitem">
Identify the operation type (upload, download, tunneling, etc.).
</li>
<li class="listitem">
Examine the host for derived artifacts that indicate suspicious activities:
</li>
<li class="listitem">
Analyze the process executable using a private sandboxed analysis system.
</li>
<li class="listitem">
Observe and collect information about the following activities in both the sandbox and the alert subject host:
</li>
<li class="listitem">
Attempts to contact external domains and addresses.
</li>
<li class="listitem">
Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' <code class="literal">process.entity_id</code>.
</li>
<li class="listitem">
!{investigate{"label":"Investigate the Subject Process Network Events","providers":[[{"excluded":false,"field":"process.entity_id","queryType":"phrase","value":"{{process.entity_id}}","valueType":"string"},{"excluded":false,"field":"event.category","queryType":"phrase","value":"network","valueType":"string"}]]}}
</li>
<li class="listitem">
Examine the DNS cache for suspicious or anomalous entries.
</li>
<li class="listitem">
!{osquery{"label":"Osquery - Retrieve DNS Cache","query":"SELECT * FROM dns_cache"}}
</li>
<li class="listitem">
Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.
</li>
<li class="listitem">
Examine the host services for suspicious or anomalous entries.
</li>
<li class="listitem">
!{osquery{"label":"Osquery - Retrieve All Services","query":"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services"}}
</li>
<li class="listitem">
!{osquery{"label":"Osquery - Retrieve Services Running on User Accounts","query":"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\nNOT (user_account LIKE <em>%LocalSystem</em> OR user_account LIKE <em>%LocalService</em> OR user_account LIKE <em>%NetworkService</em> OR\nuser_account == null)\n"}}
</li>
<li class="listitem">
!{osquery{"label":"Osquery - Retrieve Service Unsigned Executables with Virustotal Link","query":"SELECT concat(<em><a href="https://www.virustotal.com/gui/file/" class="ulink" target="_top">https://www.virustotal.com/gui/file/</a></em>, sha1) AS VtLink, name, description, start_type, status, pid,\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != <em>trusted</em>\n"}}
</li>
<li class="listitem">
Retrieve the files' SHA-256 hash values using the PowerShell <code class="literal">Get-FileHash</code> cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
This rule has a high chance to produce false positives because it detects communication with legitimate services. Noisy false positives can be added as exceptions.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Initiate the incident response process based on the outcome of the triage.
</li>
<li class="listitem">
Isolate the involved host to prevent further post-compromise behavior.
</li>
<li class="listitem">
If the triage identified malware, search the environment for additional compromised hosts.
</li>
<li class="listitem">
Implement temporary network rules, procedures, and segmentation to contain the malware.
</li>
<li class="listitem">
Stop suspicious processes.
</li>
<li class="listitem">
Immediately block the identified indicators of compromise (IoCs).
</li>
<li class="listitem">
Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.
</li>
<li class="listitem">
Remove and block malicious artifacts identified during triage.
</li>
<li class="listitem">
Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.
</li>
<li class="listitem">
Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.
</li>
<li class="listitem">
Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_rule_query_5816"></a>Rule query<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.12/docs/detections/prebuilt-rules/downloadable-packages/8-12-9/prebuilt-rule-8-12-9-connection-to-commonly-abused-web-services.asciidoc">edit</a></h3>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">network where host.os.type == "windows" and network.protocol == "dns" and
    process.name != null and user.id not in ("S-1-5-18", "S-1-5-19", "S-1-5-20") and
    /* Add new WebSvc domains here */
    dns.question.name :
       (
        "raw.githubusercontent.*",
        "pastebin.*",
        "paste4btc.com",
        "paste.ee",
        "ghostbin.com",
        "drive.google.com",
        "?.docs.live.net",
        "api.dropboxapi.*",
        "content.dropboxapi.*",
        "dl.dropboxusercontent.*",
        "api.onedrive.com",
        "*.onedrive.org",
        "onedrive.live.com",
        "filebin.net",
        "*.ngrok.io",
        "ngrok.com",
        "*.portmap.*",
        "*serveo.net",
        "*localtunnel.me",
        "*pagekite.me",
        "*localxpose.io",
        "*notabug.org",
        "rawcdn.githack.*",
        "paste.nrecom.net",
        "zerobin.net",
        "controlc.com",
        "requestbin.net",
        "slack.com",
        "api.slack.com",
        "slack-redir.net",
        "slack-files.com",
        "cdn.discordapp.com",
        "discordapp.com",
        "discord.com",
        "apis.azureedge.net",
        "cdn.sql.gg",
        "?.top4top.io",
        "top4top.io",
        "www.uplooder.net",
        "*.cdnmegafiles.com",
        "transfer.sh",
        "gofile.io",
        "updates.peer2profit.com",
        "api.telegram.org",
        "t.me",
        "meacz.gq",
        "rwrd.org",
        "*.publicvm.com",
        "*.blogspot.com",
        "api.mylnikov.org",
        "file.io",
        "stackoverflow.com",
        "*files.1drv.com",
        "api.anonfile.com",
        "*hosting-profi.de",
        "ipbase.com",
        "ipfs.io",
        "*up.freeo*.space",
        "api.mylnikov.org",
        "script.google.com",
        "script.googleusercontent.com",
        "api.notion.com",
        "graph.microsoft.com",
        "*.sharepoint.com",
        "mbasic.facebook.com",
        "login.live.com",
        "api.gofile.io",
        "api.anonfiles.com",
        "api.notion.com",
        "api.trello.com",
        "gist.githubusercontent.com",
        "files.pythonhosted.org",
        "g.live.com",
        "*.zulipchat.com") and

    /* Insert noisy false positives here */
    not (
      (
        process.executable : (
          "?:\\Program Files\\*.exe",
          "?:\\Program Files (x86)\\*.exe",
          "?:\\Windows\\System32\\WWAHost.exe",
          "?:\\Windows\\System32\\smartscreen.exe",
          "?:\\Windows\\System32\\MicrosoftEdgeCP.exe",
          "?:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\*\\MsMpEng.exe",
          "?:\\Users\\*\\AppData\\Local\\Google\\Chrome\\Application\\chrome.exe",
          "?:\\Users\\*\\AppData\\Local\\BraveSoftware\\*\\Application\\brave.exe",
          "?:\\Users\\*\\AppData\\Local\\Vivaldi\\Application\\vivaldi.exe",
          "?:\\Users\\*\\AppData\\Local\\Programs\\Opera*\\opera.exe",
          "?:\\Users\\*\\AppData\\Local\\Programs\\Fiddler\\Fiddler.exe",
          "?:\\Users\\*\\AppData\\Local\\Programs\\Microsoft VS Code\\Code.exe",
          "?:\\Users\\*\\AppData\\Local\\Microsoft\\OneDrive\\OneDrive.exe",
          "?:\\Windows\\system32\\mobsync.exe",
          "?:\\Windows\\SysWOW64\\mobsync.exe"
        )
      ) or

      /* Discord App */
      (process.name : "Discord.exe" and (process.code_signature.subject_name : "Discord Inc." and
       process.code_signature.trusted == true) and dns.question.name : ("discord.com", "cdn.discordapp.com", "discordapp.com")
      ) or

      /* MS Sharepoint */
      (process.name : "Microsoft.SharePoint.exe" and (process.code_signature.subject_name : "Microsoft Corporation" and
       process.code_signature.trusted == true) and dns.question.name : "onedrive.live.com"
      ) or

      /* Firefox */
      (process.name : "firefox.exe" and (process.code_signature.subject_name : "Mozilla Corporation" and
       process.code_signature.trusted == true)
      ) or

      /* Dropbox */
      (process.name : "Dropbox.exe" and (process.code_signature.subject_name : "Dropbox, Inc" and
       process.code_signature.trusted == true) and dns.question.name : ("api.dropboxapi.com", "*.dropboxusercontent.com")
      ) or

      /* Obsidian - Plugins are stored on raw.githubusercontent.com */
      (process.name : "Obsidian.exe" and (process.code_signature.subject_name : "Dynalist Inc" and
       process.code_signature.trusted == true) and dns.question.name : "raw.githubusercontent.com"
      ) or

      /* WebExperienceHostApp */
      (process.name : "WebExperienceHostApp.exe" and (process.code_signature.subject_name : "Microsoft Windows" and
       process.code_signature.trusted == true) and dns.question.name : ("onedrive.live.com", "skyapi.onedrive.live.com")
      ) or

      (process.code_signature.subject_name : "Microsoft *" and process.code_signature.trusted == true and
       dns.question.name : ("*.sharepoint.com", "graph.microsoft.com", "g.live.com", "login.live.com", "login.live.com")) or

      (process.code_signature.trusted == true and
       process.code_signature.subject_name :
                             ("Johannes Schindelin",
                              "Redis Inc.",
                              "Slack Technologies, LLC",
                              "Cisco Systems, Inc.",
                              "Dropbox, Inc",
                              "Amazon.com Services LLC"))
    )</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Command and Control
</li>
<li class="listitem">
ID: TA0011
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0011/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0011/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Web Service
</li>
<li class="listitem">
ID: T1102
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1102/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1102/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Dynamic Resolution
</li>
<li class="listitem">
ID: T1568
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1568/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1568/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Domain Generation Algorithms
</li>
<li class="listitem">
ID: T1568.002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1568/002/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1568/002/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Exfiltration
</li>
<li class="listitem">
ID: TA0010
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0010/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0010/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Exfiltration Over Web Service
</li>
<li class="listitem">
ID: T1567
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1567/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1567/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Exfiltration to Code Repository
</li>
<li class="listitem">
ID: T1567.001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1567/001/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1567/001/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Exfiltration to Cloud Storage
</li>
<li class="listitem">
ID: T1567.002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1567/002/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1567/002/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-12-9-linux-user-account-creation.html">« Linux User Account Creation</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-12-9-potential-command-and-control-via-internet-explorer.html">Potential Command and Control via Internet Explorer »</a>
</span>
</div>
</body>
</html>
