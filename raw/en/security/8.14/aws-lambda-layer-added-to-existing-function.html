<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AWS Lambda Layer Added to Existing Function | Elastic Security Solution [8.14] | Elastic</title>
<meta class="elastic" name="content" content="AWS Lambda Layer Added to Existing Function | Elastic Security Solution [8.14]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.14]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="aws-lambda-function-policy-updated-to-allow-public-invocation.html" title="AWS Lambda Function Policy Updated to Allow Public Invocation"/>
<link rel="next" href="aws-management-console-brute-force-of-root-user-identity.html" title="AWS Management Console Brute Force of Root User Identity"/>
<meta class="elastic" name="product_version" content="8.14"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.14"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.14"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="aws-lambda-function-policy-updated-to-allow-public-invocation.html">« AWS Lambda Function Policy Updated to Allow Public Invocation</a>
</span>
<span class="next">
<a href="aws-management-console-brute-force-of-root-user-identity.html">AWS Management Console Brute Force of Root User Identity »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.14]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>AWS Lambda Layer Added to Existing Function</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/aws-lambda-layer-added-to-existing-function.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="aws-lambda-layer-added-to-existing-function"></a>AWS Lambda Layer Added to Existing Function</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/aws-lambda-layer-added-to-existing-function.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies when an Lambda Layer is added to an existing Lambda function. AWS layers are a way to share code and data across multiple functions. By adding a layer to an existing function, an attacker can persist or execute code in the context of the function.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: query</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-aws.cloudtrail-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 10m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-60m (<a href="/guide/en/elasticsearch/reference/8.14/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence" class="ulink" target="_top">https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence</a>
</li>
<li class="listitem">
<a href="https://docs.aws.amazon.com/lambda/latest/api/API_PublishLayerVersion.html" class="ulink" target="_top">https://docs.aws.amazon.com/lambda/latest/api/API_PublishLayerVersion.html</a>
</li>
<li class="listitem">
<a href="https://docs.aws.amazon.com/lambda/latest/api/API_UpdateFunctionConfiguration.html" class="ulink" target="_top">https://docs.aws.amazon.com/lambda/latest/api/API_UpdateFunctionConfiguration.html</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Data Source: AWS
</li>
<li class="listitem">
Data Source: Amazon Web Services
</li>
<li class="listitem">
Data Source: AWS Lambda
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Execution
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 2</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_43"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/aws-lambda-layer-added-to-existing-function.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and Analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating AWS Lambda Layer Added to Existing Function</strong></span></p>
<p>This rule detects when a Lambda layer is added to an existing Lambda function. AWS Lambda layers are a mechanism for sharing code and data across multiple functions. By adding a layer to an existing function, an attacker can persist or execute code in the context of the function. Understanding the context and legitimacy of such changes is crucial to determine if the action is benign or malicious.</p>
<p><span class="strong strong"><strong>Possible Investigation Steps:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Identify the Actor</strong></span>: Review the <code class="literal">aws.cloudtrail.user_identity.arn</code> and <code class="literal">aws.cloudtrail.user_identity.access_key_id</code> fields to identify who made the change. Verify if this actor typically performs such actions and if they have the necessary permissions.
</li>
<li class="listitem">
<span class="strong strong"><strong>Review the Request Details</strong></span>: Examine the <code class="literal">aws.cloudtrail.request_parameters</code> to understand the specific layer added to the Lambda function. Look for any unusual parameters that could suggest unauthorized or malicious modifications.
</li>
<li class="listitem">
<span class="strong strong"><strong>Analyze the Source of the Request</strong></span>: Investigate the <code class="literal">source.ip</code> and <code class="literal">source.geo</code> fields to determine the geographical origin of the request. An external or unexpected location might indicate compromised credentials or unauthorized access.
</li>
<li class="listitem">
<span class="strong strong"><strong>Contextualize with Timestamp</strong></span>: Use the <code class="literal">@timestamp</code> field to check when the change occurred. Modifications during non-business hours or outside regular maintenance windows might require further scrutiny.
</li>
<li class="listitem">
<span class="strong strong"><strong>Correlate with Other Activities</strong></span>: Search for related CloudTrail events before and after this change to see if the same actor or IP address engaged in other potentially suspicious activities.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False Positive Analysis:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Legitimate Administrative Actions</strong></span>: Confirm if the addition of the Lambda layer aligns with scheduled updates, development activities, or legitimate administrative tasks documented in change management systems.
</li>
<li class="listitem">
<span class="strong strong"><strong>Consistency Check</strong></span>: Compare the action against historical data of similar actions performed by the user or within the organization. If the action is consistent with past legitimate activities, it might indicate a false alarm.
</li>
<li class="listitem">
<span class="strong strong"><strong>Verify through Outcomes</strong></span>: Check the <code class="literal">aws.cloudtrail.response_elements</code> and the <code class="literal">event.outcome</code> to confirm if the change was successful and intended according to policy.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and Remediation:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Immediate Review and Reversal if Necessary</strong></span>: If the change was unauthorized, remove the added layer from the Lambda function to mitigate any unintended code execution or persistence.
</li>
<li class="listitem">
<span class="strong strong"><strong>Enhance Monitoring and Alerts</strong></span>: Adjust monitoring systems to alert on similar actions, especially those involving sensitive functions or layers.
</li>
<li class="listitem">
<span class="strong strong"><strong>Educate and Train</strong></span>: Provide additional training to users with administrative rights on the importance of security best practices concerning Lambda function management and the use of layers.
</li>
<li class="listitem">
<span class="strong strong"><strong>Audit Lambda Functions and Policies</strong></span>: Conduct a comprehensive audit of all Lambda functions and associated policies to ensure they adhere to the principle of least privilege.
</li>
<li class="listitem">
<span class="strong strong"><strong>Incident Response</strong></span>: If there&#8217;s an indication of malicious intent or a security breach, initiate the incident response protocol to mitigate any damage and prevent future occurrences.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Additional Information:</strong></span></p>
<p>For further guidance on managing Lambda functions and securing AWS environments, refer to the <a href="https://docs.aws.amazon.com/lambda/latest/dg/welcome.html" class="ulink" target="_top">AWS Lambda documentation</a> and AWS best practices for security. Additionally, consult the following resources for specific details on Lambda layers and persistence techniques:
- <a href="https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence" class="ulink" target="_top">AWS Lambda Layers Persistence</a>
- <a href="https://docs.aws.amazon.com/lambda/latest/api/API_PublishLayerVersion.html" class="ulink" target="_top">AWS API PublishLayerVersion</a>
- <a href="https://docs.aws.amazon.com/lambda/latest/api/API_UpdateFunctionConfiguration.html" class="ulink" target="_top">AWS API UpdateFunctionConfiguration</a></p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_57"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/aws-lambda-layer-added-to-existing-function.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset: aws.cloudtrail
    and event.provider: lambda.amazonaws.com
    and event.outcome: success
    and event.action: (PublishLayerVersion* or UpdateFunctionConfiguration)</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Execution
</li>
<li class="listitem">
ID: TA0002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0002/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0002/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Serverless Execution
</li>
<li class="listitem">
ID: T1648
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1648/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1648/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="aws-lambda-function-policy-updated-to-allow-public-invocation.html">« AWS Lambda Function Policy Updated to Allow Public Invocation</a>
</span>
<span class="next">
<a href="aws-management-console-brute-force-of-root-user-identity.html">AWS Management Console Brute Force of Root User Identity »</a>
</span>
</div>
</body>
</html>
