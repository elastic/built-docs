<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Okta Sign-In Events via Third-Party IdP | Elastic Security Solution [8.14] | Elastic</title>
<meta class="elastic" name="content" content="Okta Sign-In Events via Third-Party IdP | Elastic Security Solution [8.14]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.14]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="okta-fastpass-phishing-detection.html" title="Okta FastPass Phishing Detection"/>
<link rel="next" href="okta-threatinsight-threat-suspected-promotion.html" title="Okta ThreatInsight Threat Suspected Promotion"/>
<meta class="elastic" name="product_version" content="8.14"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.14"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.14"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.14]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="okta-fastpass-phishing-detection.html">« Okta FastPass Phishing Detection</a>
</span>
<span class="next">
<a href="okta-threatinsight-threat-suspected-promotion.html">Okta ThreatInsight Threat Suspected Promotion »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="okta-sign-in-events-via-third-party-idp"></a>Okta Sign-In Events via Third-Party IdP<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/okta-sign-in-events-via-third-party-idp.asciidoc">edit</a></h2>
</div></div></div>
<p>Detects sign-in events where authentication is carried out via a third-party Identity Provider (IdP).</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: query</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-okta*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 15m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-30m (<a href="/guide/en/elasticsearch/reference/8.14/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://blog.cloudflare.com/cloudflare-investigation-of-the-january-2022-okta-compromise/" class="ulink" target="_top">https://blog.cloudflare.com/cloudflare-investigation-of-the-january-2022-okta-compromise/</a>
</li>
<li class="listitem">
<a href="/security-labs/testing-okta-visibility-and-detection-dorothy" class="ulink" target="_top">https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy</a>
</li>
<li class="listitem">
<a href="https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection" class="ulink" target="_top">https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection</a>
</li>
<li class="listitem">
<a href="https://unit42.paloaltonetworks.com/muddled-libra/" class="ulink" target="_top">https://unit42.paloaltonetworks.com/muddled-libra/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Use Case: Identity and Access Audit
</li>
<li class="listitem">
Tactic: Initial Access
</li>
<li class="listitem">
Data Source: Okta
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 2</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_investigation_guide_308"></a>Investigation guide<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/okta-sign-in-events-via-third-party-idp.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating Okta Sign-In Events via Third-Party IdP</strong></span></p>
<p>This rule detects sign-in events where authentication is carried out via a third-party Identity Provider (IdP).</p>
<p>Adversaries may attempt to add an unauthorized IdP to an Okta tenant to gain access to the tenant. Following this action, adversaries may attempt to sign in to the tenant using the unauthorized IdP. This rule detects both the addition of an unauthorized IdP and the subsequent sign-in attempt.</p>
<p><span class="strong strong"><strong>Possible investigation steps:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Identify the third-party IdP by examining the <code class="literal">okta.authentication_context.issuer.id</code> field.
</li>
<li class="listitem">
Once the third-party IdP is identified, determine if this IdP is authorized to be used by the tenant.
</li>
<li class="listitem">
If the IdP is unauthorized, deactivate it immediately via the Okta console.
</li>
<li class="listitem">
Identify the actor associated with the IdP creation by examining the <code class="literal">okta.actor.id</code>, <code class="literal">okta.actor.type</code>, <code class="literal">okta.actor.alternate_id</code>, and <code class="literal">okta.actor.display_name</code> fields in historical data.
</li>
<li class="listitem">
The <code class="literal">New Okta Identity Provider (IdP) Added by Admin</code> rule may be helpful in identifying the actor and the IdP creation event.
</li>
<li class="listitem">
Determine the client used by the actor. Review the <code class="literal">okta.client.ip</code>, <code class="literal">okta.client.user_agent.raw_user_agent</code>, <code class="literal">okta.client.zone</code>, <code class="literal">okta.client.device</code>, and <code class="literal">okta.client.id</code> fields.
</li>
<li class="listitem">
If the client is a device, check the <code class="literal">okta.device.id</code>, <code class="literal">okta.device.name</code>, <code class="literal">okta.device.os_platform</code>, <code class="literal">okta.device.os_version</code>, and <code class="literal">okta.device.managed</code> fields.
</li>
<li class="listitem">
Review the past activities of the actor involved in this action by checking their previous actions logged in the <code class="literal">okta.target</code> field.
</li>
<li class="listitem">
Examine the <code class="literal">okta.request.ip_chain</code> field to potentially determine if the actor used a proxy or VPN to perform this action.
</li>
<li class="listitem">
Evaluate the actions that happened just before and after this event in the <code class="literal">okta.event_type</code> field to help understand the full context of the activity.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
It might be a false positive if this IdP is authorized to be used by the tenant.
</li>
<li class="listitem">
This may be a false positive if an authorized third-party IdP is used to sign in to the tenant but failures occurred due to an incorrect configuration.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If the IdP is unauthorized, deactivate it immediately via the Okta console.
</li>
<li class="listitem">
Reset the effected user&#8217;s password and enforce MFA re-enrollment, if applicable.
</li>
<li class="listitem">
Mobile device forensics may be required to determine if the user&#8217;s device is compromised.
</li>
<li class="listitem">
If the IdP is authorized, ensure that the actor who created it is authorized to do so.
</li>
<li class="listitem">
If the actor is unauthorized, deactivate their account via the Okta console.
</li>
<li class="listitem">
If the actor is authorized, ensure that the actor&#8217;s account is not compromised.
</li>
<li class="listitem">
Block the IP address or device used in the attempts if they appear suspicious, using the data from the <code class="literal">okta.client.ip</code> and <code class="literal">okta.device.id</code> fields.
</li>
<li class="listitem">
Conduct a review of Okta policies and ensure they are in accordance with security best practices.
</li>
<li class="listitem">
If the deactivated IdP was crucial to the organization, consider adding a new IdP and removing the unauthorized IdP.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_setup_386"></a>Setup<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/okta-sign-in-events-via-third-party-idp.asciidoc">edit</a></h3>
</div></div></div>
<p>The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_rule_query_522"></a>Rule query<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/okta-sign-in-events-via-third-party-idp.asciidoc">edit</a></h3>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset:okta.system and okta.debug_context.debug_data.request_uri:/oauth2/v1/authorize/callback and
    (not okta.authentication_context.issuer.id:Okta and event.action:(user.authentication.auth_via_IDP
        or user.authentication.auth_via_inbound_SAML
        or user.authentication.auth_via_mfa
        or user.authentication.auth_via_social)
        or event.action:user.session.start) or
    (event.action:user.authentication.auth_via_IDP and okta.outcome.result:FAILURE
        and okta.outcome.reason:("A SAML assert with the same ID has already been processed by Okta for a previous request"
            or "Unable to match transformed username"
            or "Unable to resolve IdP endpoint"
            or "Unable to validate SAML Response"
            or "Unable to validate incoming SAML Assertion"))</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Initial Access
</li>
<li class="listitem">
ID: TA0001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0001/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0001/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Trusted Relationship
</li>
<li class="listitem">
ID: T1199
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1199/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1199/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="okta-fastpass-phishing-detection.html">« Okta FastPass Phishing Detection</a>
</span>
<span class="next">
<a href="okta-threatinsight-threat-suspected-promotion.html">Okta ThreatInsight Threat Suspected Promotion »</a>
</span>
</div>
</div>
</body>
</html>
