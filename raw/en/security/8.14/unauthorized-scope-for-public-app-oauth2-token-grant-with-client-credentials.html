<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Unauthorized Scope for Public App OAuth2 Token Grant with Client Credentials | Elastic Security Solution [8.14] | Elastic</title>
<meta class="elastic" name="content" content="Unauthorized Scope for Public App OAuth2 Token Grant with Client Credentials | Elastic Security Solution [8.14]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.14]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="unauthorized-access-to-an-okta-application.html" title="Unauthorized Access to an Okta Application"/>
<link rel="next" href="uncommon-destination-port-connection-by-web-server.html" title="Uncommon Destination Port Connection by Web Server"/>
<meta class="elastic" name="product_version" content="8.14"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.14"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.14"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="unauthorized-access-to-an-okta-application.html">« Unauthorized Access to an Okta Application</a>
</span>
<span class="next">
<a href="uncommon-destination-port-connection-by-web-server.html">Uncommon Destination Port Connection by Web Server »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.14]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Unauthorized Scope for Public App OAuth2 Token Grant with Client Credentials</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/unauthorized-scope-for-public-app-oauth2-token-grant-with-client-credentials.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="unauthorized-scope-for-public-app-oauth2-token-grant-with-client-credentials"></a>Unauthorized Scope for Public App OAuth2 Token Grant with Client Credentials</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/unauthorized-scope-for-public-app-oauth2-token-grant-with-client-credentials.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies a failed OAuth 2.0 token grant attempt for a public client app using client credentials. This event is generated when a public client app attempts to exchange a client credentials grant for an OAuth 2.0 access token, but the request is denied due to the lack of required scopes. This could indicate compromised client credentials in which an adversary is attempting to obtain an access token for unauthorized scopes. This is a [New Terms](<a href="/guide/en/security/current/rules-ui-create.html#create-new-terms-rule" class="ulink" target="_top">https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule</a>) rule where the <code class="literal">okta.actor.display_name</code> field value has not been seen in the last 14 days regarding this event.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-okta*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.14/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://github.blog/news-insights/company-news/security-alert-stolen-oauth-user-tokens/" class="ulink" target="_top">https://github.blog/news-insights/company-news/security-alert-stolen-oauth-user-tokens/</a>
</li>
<li class="listitem">
<a href="https://developer.okta.com/docs/reference/api/event-types/" class="ulink" target="_top">https://developer.okta.com/docs/reference/api/event-types/</a>
</li>
<li class="listitem">
<a href="/security-labs/monitoring-okta-threats-with-elastic-security" class="ulink" target="_top">https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security</a>
</li>
<li class="listitem">
<a href="/security-labs/starter-guide-to-understanding-okta" class="ulink" target="_top">https://www.elastic.co/security-labs/starter-guide-to-understanding-okta</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: SaaS
</li>
<li class="listitem">
Data Source: Okta
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Use Case: Identity and Access Audit
</li>
<li class="listitem">
Tactic: Defense Evasion
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 106</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_1088"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/unauthorized-scope-for-public-app-oauth2-token-grant-with-client-credentials.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Unauthorized Scope for Public App OAuth2 Token Grant with Client Credentials</strong></span></p>
<p>OAuth 2.0 is a protocol for authorization, allowing apps to access resources on behalf of users. Public client apps, lacking secure storage, use client credentials for token grants. Adversaries may exploit compromised credentials to request unauthorized scopes. The detection rule identifies failed token grants due to scope mismatches, signaling potential misuse of client credentials.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the <code class="literal">okta.actor.display_name</code> field to identify the public client app involved in the failed token grant attempt and determine if it is a known or expected application.
</li>
<li class="listitem">
Examine the <code class="literal">okta.debug_context.debug_data.flattened.requestedScopes</code> field to understand which unauthorized scopes were requested and assess their potential impact if accessed.
</li>
<li class="listitem">
Investigate the <code class="literal">okta.actor.type</code> field to confirm that the actor is indeed a public client app, which lacks secure storage, and evaluate the risk of compromised credentials.
</li>
<li class="listitem">
Check the <code class="literal">okta.outcome.reason</code> field for "no_matching_scope" to verify that the failure was due to a scope mismatch, indicating an attempt to access unauthorized resources.
</li>
<li class="listitem">
Analyze the <code class="literal">okta.client.user_agent.raw_user_agent</code> field to ensure the request did not originate from known Okta integrations, which are excluded from the rule, to rule out false positives.
</li>
<li class="listitem">
Correlate the event with other security logs or alerts to identify any patterns or additional suspicious activities related to the same client credentials or IP address.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Frequent legitimate access attempts by known public client apps may trigger false positives. To manage this, consider creating exceptions for specific <code class="literal">okta.actor.display_name</code> values that are known to frequently request scopes without malicious intent.
</li>
<li class="listitem">
Automated processes or integrations that use client credentials might occasionally request scopes not typically associated with their function. Review these processes and, if deemed non-threatening, exclude their <code class="literal">okta.client.user_agent.raw_user_agent</code> from triggering the rule.
</li>
<li class="listitem">
Development or testing environments often simulate various OAuth 2.0 token grant scenarios, which can result in false positives. Identify and exclude these environments by their <code class="literal">okta.actor.display_name</code> or other distinguishing attributes.
</li>
<li class="listitem">
Regularly review and update the list of non-threatening scopes in <code class="literal">okta.debug_context.debug_data.flattened.requestedScopes</code> to ensure that legitimate scope requests are not flagged as unauthorized.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately revoke the compromised client credentials to prevent further unauthorized access attempts.
</li>
<li class="listitem">
Conduct a thorough review of the affected public client app&#8217;s access logs to identify any successful unauthorized access or data exfiltration attempts.
</li>
<li class="listitem">
Notify the application owner and relevant security teams about the incident to ensure coordinated response efforts.
</li>
<li class="listitem">
Implement additional monitoring on the affected app and associated user accounts to detect any further suspicious activities.
</li>
<li class="listitem">
Update and enforce stricter access controls and scope permissions for public client apps to minimize the risk of unauthorized scope requests.
</li>
<li class="listitem">
Consider implementing multi-factor authentication (MFA) for accessing sensitive resources to add an additional layer of security.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) for further investigation and to determine if broader organizational impacts exist.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_1159"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/unauthorized-scope-for-public-app-oauth2-token-grant-with-client-credentials.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset: okta.system
    and event.action: "app.oauth2.as.token.grant"
    and okta.actor.type: "PublicClientApp"
    and okta.debug_context.debug_data.flattened.grantType: "client_credentials"
    and okta.outcome.result: "FAILURE"
    and not okta.client.user_agent.raw_user_agent: "Okta-Integrations"
    and not okta.actor.display_name: (Okta* or Datadog)
    and not okta.debug_context.debug_data.flattened.requestedScopes: ("okta.logs.read" or "okta.eventHooks.read" or "okta.inlineHooks.read")
    and okta.outcome.reason: "no_matching_scope"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Defense Evasion
</li>
<li class="listitem">
ID: TA0005
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0005/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0005/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Use Alternate Authentication Material
</li>
<li class="listitem">
ID: T1550
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1550/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1550/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Application Access Token
</li>
<li class="listitem">
ID: T1550.001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1550/001/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1550/001/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="unauthorized-access-to-an-okta-application.html">« Unauthorized Access to an Okta Application</a>
</span>
<span class="next">
<a href="uncommon-destination-port-connection-by-web-server.html">Uncommon Destination Port Connection by Web Server »</a>
</span>
</div>
</body>
</html>
