<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Untrusted DLL Loaded by Azure AD Sync Service | Elastic Security Solution [8.14] | Elastic</title>
<meta class="elastic" name="content" content="Untrusted DLL Loaded by Azure AD Sync Service | Elastic Security Solution [8.14]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.14]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="unsigned-dll-loaded-by-dns-service.html" title="Unsigned DLL loaded by DNS Service"/>
<link rel="next" href="untrusted-driver-loaded.html" title="Untrusted Driver Loaded"/>
<meta class="elastic" name="product_version" content="8.14"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.14"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.14"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="unsigned-dll-loaded-by-dns-service.html">« Unsigned DLL loaded by DNS Service</a>
</span>
<span class="next">
<a href="untrusted-driver-loaded.html">Untrusted Driver Loaded »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.14]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Untrusted DLL Loaded by Azure AD Sync Service</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/untrusted-dll-loaded-by-azure-ad-sync-service.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="untrusted-dll-loaded-by-azure-ad-sync-service"></a>Untrusted DLL Loaded by Azure AD Sync Service</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/untrusted-dll-loaded-by-azure-ad-sync-service.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies the load of a DLL without a valid code signature by the Azure AD Sync process, which may indicate an attempt to persist or collect sensitive credentials passing through the Azure AD synchronization server.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
winlogbeat-*
</li>
<li class="listitem">
logs-endpoint.events.library-*
</li>
<li class="listitem">
logs-windows.sysmon_operational-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: high</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 73</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.14/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://blog.xpnsec.com/azuread-connect-for-redteam/" class="ulink" target="_top">https://blog.xpnsec.com/azuread-connect-for-redteam/</a>
</li>
<li class="listitem">
<a href="https://medium.com/@breakingmhet/detect-azure-pass-through-authentication-abuse-azure-hybrid-environments-ed4274784252" class="ulink" target="_top">https://medium.com/@breakingmhet/detect-azure-pass-through-authentication-abuse-azure-hybrid-environments-ed4274784252</a>
</li>
<li class="listitem">
<a href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/tshoot-connect-pass-through-authentication" class="ulink" target="_top">https://learn.microsoft.com/en-us/azure/active-directory/hybrid/tshoot-connect-pass-through-authentication</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Credential Access
</li>
<li class="listitem">
Data Source: Elastic Defend
</li>
<li class="listitem">
Data Source: Sysmon
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 103</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
<li class="listitem">
Matteo Potito Giorgio
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_1089"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/untrusted-dll-loaded-by-azure-ad-sync-service.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Untrusted DLL Loaded by Azure AD Sync Service</strong></span></p>
<p>Azure AD Sync Service facilitates identity synchronization between on-premises directories and Azure AD, crucial for seamless authentication. Adversaries may exploit this by loading malicious DLLs to intercept credentials. The detection rule identifies untrusted DLLs loaded by the Azure AD Sync process, focusing on those lacking valid signatures and excluding known safe paths, thus highlighting potential credential access threats.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the process details for AzureADConnectAuthenticationAgentService.exe to confirm its legitimacy and check for any unusual behavior or anomalies.
</li>
<li class="listitem">
Examine the specific DLL file path that triggered the alert to determine if it is located in an unexpected or suspicious directory.
</li>
<li class="listitem">
Investigate the code signature status of the DLL to understand why it is untrusted, and verify if the DLL should have a valid signature.
</li>
<li class="listitem">
Check the system for any recent changes or installations that could have introduced the untrusted DLL, focusing on the timeframe around the alert.
</li>
<li class="listitem">
Analyze the event logs for any other suspicious activities or related alerts that might indicate a broader compromise or attack pattern.
</li>
<li class="listitem">
Correlate the alert with other security tools or logs to gather additional context and determine if this is part of a larger attack campaign.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
DLLs from legitimate software updates or installations may trigger alerts if they are not yet recognized as trusted. Users can monitor these occurrences and verify the legitimacy of the software source before adding exceptions.
</li>
<li class="listitem">
Custom or in-house developed applications might load DLLs that lack valid signatures. Users should ensure these applications are from a trusted source and consider signing them or adding their paths to the exclusion list.
</li>
<li class="listitem">
DLLs located in non-standard directories that are part of legitimate software operations can be flagged. Users should verify the software&#8217;s legitimacy and update the exclusion list with these specific paths if necessary.
</li>
<li class="listitem">
Temporary files or DLLs created during software installation or updates might be flagged. Users should confirm the installation process and temporarily exclude these paths during the update period.
</li>
<li class="listitem">
Security or monitoring tools that dynamically load DLLs for legitimate purposes may be misidentified. Users should verify the tool&#8217;s activity and add it to the exclusion list if it is deemed safe.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected Azure AD Sync server from the network to prevent further unauthorized access or data exfiltration.
</li>
<li class="listitem">
Terminate the AzureADConnectAuthenticationAgentService.exe process to stop the execution of the untrusted DLL and prevent potential credential dumping.
</li>
<li class="listitem">
Conduct a thorough review of the loaded DLLs on the affected server to identify and remove any malicious or unauthorized files.
</li>
<li class="listitem">
Restore the server from a known good backup taken before the incident to ensure the system is free from compromise.
</li>
<li class="listitem">
Change all credentials that may have been exposed or compromised, focusing on those related to Azure AD and on-premises directory services.
</li>
<li class="listitem">
Implement application whitelisting to prevent unauthorized DLLs from being loaded by critical processes like Azure AD Sync.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) for further investigation and to determine if additional systems are affected.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_1146"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.14/docs/detections/prebuilt-rules/rule-details/untrusted-dll-loaded-by-azure-ad-sync-service.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">any where host.os.type == "windows" and process.name : "AzureADConnectAuthenticationAgentService.exe" and
(
 (event.category == "library" and event.action == "load") or
 (event.category == "process" and event.action : "Image loaded*")
) and

not (?dll.code_signature.trusted == true or file.code_signature.status == "Valid") and not

  (
   /* Elastic defend DLL path */
   ?dll.path :
         ("?:\\Windows\\assembly\\NativeImages*",
          "?:\\Windows\\Microsoft.NET\\*",
          "?:\\Windows\\WinSxS\\*",
          "?:\\Windows\\System32\\DriverStore\\FileRepository\\*") or

   /* Sysmon DLL path is mapped to file.path */
   file.path :
         ("?:\\Windows\\assembly\\NativeImages*",
          "?:\\Windows\\Microsoft.NET\\*",
          "?:\\Windows\\WinSxS\\*",
          "?:\\Windows\\System32\\DriverStore\\FileRepository\\*")
  )</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: OS Credential Dumping
</li>
<li class="listitem">
ID: T1003
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1003/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1003/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="unsigned-dll-loaded-by-dns-service.html">« Unsigned DLL loaded by DNS Service</a>
</span>
<span class="next">
<a href="untrusted-driver-loaded.html">Untrusted Driver Loaded »</a>
</span>
</div>
</body>
</html>
