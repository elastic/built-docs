<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AWS CLI Command with Custom Endpoint URL | Elastic Security [8.15] | Elastic</title>
<meta class="elastic" name="content" content="AWS CLI Command with Custom Endpoint URL | Elastic Security [8.15]">

<link rel="home" href="index.html" title="Elastic Security [8.15]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="aws-bedrock-invocations-without-guardrails-detected-by-a-single-user-over-a-session.html" title="AWS Bedrock Invocations without Guardrails Detected by a Single User Over a Session"/>
<link rel="next" href="aws-cloudtrail-log-created.html" title="AWS CloudTrail Log Created"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.15"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.15"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="aws-bedrock-invocations-without-guardrails-detected-by-a-single-user-over-a-session.html">« AWS Bedrock Invocations without Guardrails Detected by a Single User Over a Session</a>
</span>
<span class="next">
<a href="aws-cloudtrail-log-created.html">AWS CloudTrail Log Created »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.15]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>AWS CLI Command with Custom Endpoint URL</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/aws-cli-command-with-custom-endpoint-url.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs/reference/security/prebuilt-rules/rules/linux/command_and_control_aws_cli_endpoint_url_used">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="aws-cli-command-with-custom-endpoint-url"></a>AWS CLI Command with Custom Endpoint URL</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/aws-cli-command-with-custom-endpoint-url.asciidoc">edit</a></div>
</div></div></div>
<p>Detects the use of the AWS CLI with the <code class="literal">--endpoint-url</code> argument, which allows users to specify a custom endpoint URL for AWS services. This can be leveraged by adversaries to redirect API requests to non-standard or malicious endpoints, potentially bypassing typical security controls and logging mechanisms. This behavior may indicate an attempt to interact with unauthorized or compromised infrastructure, exfiltrate data, or perform other malicious activities under the guise of legitimate AWS operations.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
logs-endpoint.events.process-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.15/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://sysdig.com/blog/scarleteel-2-0/" class="ulink" target="_top">https://sysdig.com/blog/scarleteel-2-0/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Data Source: Elastic Defend
</li>
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Linux
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Command and Control
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 2</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_9"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/aws-cli-command-with-custom-endpoint-url.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating AWS CLI Command with Custom Endpoint URL</strong></span></p>
<p>The AWS CLI allows users to interact with AWS services via command-line, offering flexibility in managing cloud resources. The <code class="literal">--endpoint-url</code> option lets users specify alternative endpoints, which can be exploited by adversaries to reroute requests to malicious servers, bypassing security controls. The detection rule identifies such misuse by monitoring for the <code class="literal">--endpoint-url</code> argument in process logs, flagging potential unauthorized activities.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the process logs to identify the specific command line that triggered the alert, focusing on the presence of the --endpoint-url argument.
</li>
<li class="listitem">
Investigate the custom endpoint URL specified in the command to determine if it is a known malicious or unauthorized domain.
</li>
<li class="listitem">
Check the user account associated with the process to assess if it has a history of suspicious activity or if it has been compromised.
</li>
<li class="listitem">
Analyze network logs to trace any outbound connections to the custom endpoint URL and evaluate the data being transmitted.
</li>
<li class="listitem">
Correlate the event with other security alerts or logs to identify any patterns or additional indicators of compromise related to the same user or endpoint.
</li>
<li class="listitem">
Verify if the AWS credentials used in the command have been exposed or misused in other contexts, potentially indicating credential theft or abuse.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Internal testing environments may use custom endpoint URLs for development purposes. To manage this, create exceptions for known internal IP addresses or domain names associated with these environments.
</li>
<li class="listitem">
Organizations using AWS CLI with custom endpoints for legitimate third-party integrations might trigger this rule. Identify and whitelist these specific integrations by their endpoint URLs to prevent false positives.
</li>
<li class="listitem">
Automated scripts or tools that interact with AWS services through custom endpoints for monitoring or backup purposes can be flagged. Review and document these scripts, then exclude them from detection by process name or specific endpoint URL.
</li>
<li class="listitem">
Some organizations may use proxy servers that require custom endpoint URLs for AWS CLI operations. Verify these configurations and exclude the associated endpoint URLs from the detection rule.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected system from the network to prevent further unauthorized access or data exfiltration.
</li>
<li class="listitem">
Review process logs and network traffic to identify any data that may have been redirected to unauthorized endpoints and assess the extent of potential data exposure.
</li>
<li class="listitem">
Revoke any AWS credentials or access keys used on the affected system to prevent further misuse and rotate them with new credentials.
</li>
<li class="listitem">
Conduct a thorough investigation to determine if any other systems have been compromised or if similar unauthorized endpoint usage has occurred elsewhere in the network.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine if additional containment or remediation actions are necessary.
</li>
<li class="listitem">
Implement network-level controls to block known malicious endpoints and enhance monitoring for unusual AWS CLI usage patterns across the environment.
</li>
<li class="listitem">
Update security policies and endpoint protection configurations to detect and alert on the use of custom endpoint URLs in AWS CLI commands, ensuring rapid response to future incidents.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_9"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/aws-cli-command-with-custom-endpoint-url.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">host.os.type: "linux" and event.category: "process" and process.name: "aws" and process.args:  "--endpoint-url"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Command and Control
</li>
<li class="listitem">
ID: TA0011
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0011/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0011/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Web Service
</li>
<li class="listitem">
ID: T1102
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1102/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1102/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="aws-bedrock-invocations-without-guardrails-detected-by-a-single-user-over-a-session.html">« AWS Bedrock Invocations without Guardrails Detected by a Single User Over a Session</a>
</span>
<span class="next">
<a href="aws-cloudtrail-log-created.html">AWS CloudTrail Log Created »</a>
</span>
</div>
</body>
</html>
