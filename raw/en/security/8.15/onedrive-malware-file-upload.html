<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>OneDrive Malware File Upload | Elastic Security Solution [8.15] | Elastic</title>
<meta class="elastic" name="content" content="OneDrive Malware File Upload | Elastic Security Solution [8.15]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.15]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="okta-user-sessions-started-from-different-geolocations.html" title="Okta User Sessions Started from Different Geolocations"/>
<link rel="next" href="openssl-password-hash-generation.html" title="OpenSSL Password Hash Generation"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.15"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.15"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="okta-user-sessions-started-from-different-geolocations.html">« Okta User Sessions Started from Different Geolocations</a>
</span>
<span class="next">
<a href="openssl-password-hash-generation.html">OpenSSL Password Hash Generation »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.15]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>OneDrive Malware File Upload</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/onedrive-malware-file-upload.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="onedrive-malware-file-upload"></a>OneDrive Malware File Upload</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/onedrive-malware-file-upload.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies the occurence of files uploaded to OneDrive being detected as Malware by the file scanning engine. Attackers can use File Sharing and Organization Repositories to spread laterally within the company and amplify their access. Users can inadvertently share these files without knowing their maliciousness, giving adversaries opportunity to gain initial access to other endpoints in the environment.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: query</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-o365*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: high</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 73</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-30m (<a href="/guide/en/elasticsearch/reference/8.15/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/virus-detection-in-spo?view=o365-worldwide" class="ulink" target="_top">https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/virus-detection-in-spo?view=o365-worldwide</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Data Source: Microsoft 365
</li>
<li class="listitem">
Tactic: Lateral Movement
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 207</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_602"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/onedrive-malware-file-upload.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating OneDrive Malware File Upload</strong></span></p>
<p>OneDrive, a cloud storage service, facilitates file sharing and collaboration within organizations. However, adversaries can exploit this by uploading malware, which can spread across shared environments, leading to lateral movement within a network. The detection rule identifies such threats by monitoring OneDrive activities for malware detection events, focusing on file operations flagged by Microsoft&#8217;s security engine. This proactive approach helps in identifying and mitigating potential breaches.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the alert details to confirm the event dataset is <em>o365.audit</em> and the event provider is <em>OneDrive</em> to ensure the alert is relevant to OneDrive activities.
</li>
<li class="listitem">
Examine the specific file operation flagged by the event code <em>SharePointFileOperation</em> and action <em>FileMalwareDetected</em> to identify the file in question and understand the nature of the detected malware.
</li>
<li class="listitem">
Identify the user account associated with the file upload to determine if the account has been compromised or if the user inadvertently uploaded the malicious file.
</li>
<li class="listitem">
Check the sharing settings of the affected file to assess the extent of exposure and identify any other users or systems that may have accessed the file.
</li>
<li class="listitem">
Investigate the file&#8217;s origin and history within the organization to trace how it was introduced into the environment and whether it has been shared or accessed by other users.
</li>
<li class="listitem">
Review any additional security alerts or logs related to the user account or file to identify potential patterns of malicious activity or further compromise.
</li>
<li class="listitem">
Coordinate with IT and security teams to isolate the affected file and user account, and initiate remediation steps to prevent further spread of the malware.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Legitimate software updates or patches may be flagged as malware if they are not yet recognized by the security engine. Users should verify the source and integrity of the file and consider adding it to an exception list if confirmed safe.
</li>
<li class="listitem">
Files containing scripts or macros used for automation within the organization might trigger false positives. Review the file&#8217;s purpose and origin, and whitelist it if it is a known and trusted internal tool.
</li>
<li class="listitem">
Shared files from trusted partners or vendors could be mistakenly identified as threats. Establish a process to verify these files with the sender and use exceptions for recurring, verified files.
</li>
<li class="listitem">
Archived or compressed files that contain known safe content might be flagged due to their format. Decompress and scan the contents separately to confirm their safety before adding exceptions.
</li>
<li class="listitem">
Files with unusual or encrypted content used for legitimate business purposes may be misclassified. Ensure these files are documented and approved by IT security before excluding them from alerts.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected OneDrive account to prevent further file sharing and potential spread of malware within the organization.
</li>
<li class="listitem">
Notify the user associated with the account about the detected malware and instruct them to cease any file sharing activities until further notice.
</li>
<li class="listitem">
Conduct a thorough scan of the affected files using an updated antivirus or endpoint detection and response (EDR) solution to confirm the presence of malware and identify any additional infected files.
</li>
<li class="listitem">
Remove or quarantine the identified malicious files from OneDrive and any other locations they may have been shared to prevent further access or execution.
</li>
<li class="listitem">
Review and revoke any shared links or permissions associated with the infected files to ensure no unauthorized access is possible.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) or incident response team for further investigation and to determine if any lateral movement or additional compromise has occurred.
</li>
<li class="listitem">
Implement enhanced monitoring and alerting for similar OneDrive activities to quickly detect and respond to any future malware uploads or related threats.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_388"></a>Setup</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/onedrive-malware-file-upload.asciidoc">edit</a></div>
</div></div></div>
<p>The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_644"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/onedrive-malware-file-upload.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset:o365.audit and event.provider:OneDrive and event.code:SharePointFileOperation and event.action:FileMalwareDetected</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Lateral Movement
</li>
<li class="listitem">
ID: TA0008
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0008/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0008/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Taint Shared Content
</li>
<li class="listitem">
ID: T1080
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1080/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1080/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="okta-user-sessions-started-from-different-geolocations.html">« Okta User Sessions Started from Different Geolocations</a>
</span>
<span class="next">
<a href="openssl-password-hash-generation.html">OpenSSL Password Hash Generation »</a>
</span>
</div>
</body>
</html>
