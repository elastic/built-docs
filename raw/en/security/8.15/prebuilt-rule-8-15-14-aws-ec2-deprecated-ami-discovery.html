<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AWS EC2 Deprecated AMI Discovery | Elastic Security Solution [8.15] | Elastic</title>
<meta class="elastic" name="content" content="AWS EC2 Deprecated AMI Discovery | Elastic Security Solution [8.15]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.15]"/>
<link rel="up" href="prebuilt-rule-8-15-14-prebuilt-rules-8-15-14-appendix.html" title="Appendix a: Downloadable rule update v8.15.14"/>
<link rel="prev" href="prebuilt-rule-8-15-14-aws-sqs-queue-purge.html" title="AWS SQS Queue Purge"/>
<link rel="next" href="prebuilt-rule-8-15-14-excessive-aws-s3-object-encryption-with-sse-c.html" title="Excessive AWS S3 Object Encryption with SSE-C"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.15"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.15"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-15-14-aws-sqs-queue-purge.html">« AWS SQS Queue Purge</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-15-14-excessive-aws-s3-object-encryption-with-sse-c.html">Excessive AWS S3 Object Encryption with SSE-C »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.15]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-15-14-prebuilt-rules-8-15-14-appendix.html">Downloadable rule update v8.15.14</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>AWS EC2 Deprecated AMI Discovery</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/downloadable-packages/8-15-14/prebuilt-rule-8-15-14-aws-ec2-deprecated-ami-discovery.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-15-14-aws-ec2-deprecated-ami-discovery"></a>AWS EC2 Deprecated AMI Discovery</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/downloadable-packages/8-15-14/prebuilt-rule-8-15-14-aws-ec2-deprecated-ami-discovery.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies when a user has queried for deprecated Amazon Machine Images (AMIs) in AWS. This may indicate an adversary whom is looking for outdated AMIs that may be vulnerable to exploitation. While deprecated AMIs are not inherently malicious or indicate breach, they may be more susceptible to vulnerabilities and should be investigated for potential security risks.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: query</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-aws.cloudtrail-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.15/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://hackingthe.cloud/aws/exploitation/Misconfigured_Resource-Based_Policies/exploting_public_resources_attack_playbook/" class="ulink" target="_top">https://hackingthe.cloud/aws/exploitation/Misconfigured_Resource-Based_Policies/exploting_public_resources_attack_playbook/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Data Source: AWS
</li>
<li class="listitem">
Data Source: AWS EC2
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Discovery
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 1</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4429"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/downloadable-packages/8-15-14/prebuilt-rule-8-15-14-aws-ec2-deprecated-ami-discovery.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Investigating AWS EC2 Deprecated AMI Discovery</strong></span></p>
<p>This rule detects when a user queries AWS for deprecated Amazon Machine Images (AMIs). While deprecated AMIs are not inherently malicious, their use can introduce vulnerabilities or misconfigurations. Adversaries may exploit deprecated AMIs in search of outdated or unpatched systems. Investigating these queries can help identify potential risks or misconfigurations.</p>
<p><span class="strong strong"><strong>Possible Investigation Steps</strong></span></p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p><span class="strong strong"><strong>Identify the User Performing the Query</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the <code class="literal">aws.cloudtrail.user_identity.arn</code> field to determine the AWS user or role making the request.
</li>
<li class="listitem">
Check <code class="literal">aws.cloudtrail.user_identity.type</code> and <code class="literal">aws.cloudtrail.user_identity.access_key_id</code> to verify the type of access (e.g., IAM user, role, or federated identity).
</li>
<li class="listitem">
Investigate the <code class="literal">related.user</code> field for additional user context.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Analyze the Source of the Request</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the <code class="literal">source.ip</code> field to determine the IP address of the source making the request.
</li>
<li class="listitem">
Check <code class="literal">source.geo</code> for the geographic location of the IP address.
</li>
<li class="listitem">
Analyze the <code class="literal">user_agent.original</code> field to determine the client or tool used (e.g., AWS CLI, SDK).
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Review the Request Details</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Inspect the <code class="literal">aws.cloudtrail.flattened.request_parameters</code> field for query parameters, such as <code class="literal">includeDeprecated=true</code>.
</li>
<li class="listitem">
Confirm that the request explicitly includes deprecated AMIs (<code class="literal">includeDeprecated=true</code>) and is tied to specific owners via the <code class="literal">ownersSet</code> field.
</li>
<li class="listitem">
Verify the <code class="literal">event.action</code> is <code class="literal">DescribeImages</code> and the <code class="literal">event.outcome</code> is <code class="literal">success</code>.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Validate the Query Context</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Determine if the request is part of legitimate activity, such as:
</li>
<li class="listitem">
Security assessments or vulnerability scans.
</li>
<li class="listitem">
Maintenance or testing of legacy systems.
</li>
<li class="listitem">
Check if the query aligns with recent changes in the AWS environment, such as new configurations or services.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Correlate with Other Events</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Investigate additional AWS API calls from the same user or IP address for signs of reconnaissance or exploitation.
</li>
<li class="listitem">
Review logs for related actions, such as launching instances from deprecated AMIs (<code class="literal">RunInstances</code> API call).
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Assess Security Risks</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Evaluate the use of deprecated AMIs within your environment and their associated vulnerabilities.
</li>
<li class="listitem">
Ensure that deprecated AMIs are not being used in production environments or systems exposed to external threats.
</li>
</ul>
</div>
</li>
</ol>
</div>
<p><span class="strong strong"><strong>False Positive Analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Legitimate Use</strong></span>: Users may query for deprecated AMIs for testing or compatibility purposes.
</li>
<li class="listitem">
<span class="strong strong"><strong>Automated Tools</strong></span>: Security or compliance tools might query deprecated AMIs as part of regular assessments.
</li>
<li class="listitem">
<span class="strong strong"><strong>Misconfigured Services</strong></span>: Legacy systems may rely on deprecated AMIs for compatibility, leading to legitimate queries.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and Remediation</strong></span></p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p><span class="strong strong"><strong>Immediate Actions</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Verify the intent of the user querying for deprecated AMIs.
</li>
<li class="listitem">
Restrict IAM permissions to prevent unauthorized access to deprecated AMIs.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Mitigation Steps</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Identify and replace deprecated AMIs in use with supported and updated AMIs.
</li>
<li class="listitem">
Update AWS IAM policies to minimize permissions for querying or using deprecated AMIs.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Enhance Monitoring</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Enable alerts for future queries involving deprecated AMIs or other unusual API activity.
</li>
<li class="listitem">
Monitor CloudTrail logs for additional reconnaissance or suspicious behavior.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Security Audits</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Conduct a review of all AMIs in use across your environment to identify outdated or deprecated images.
</li>
<li class="listitem">
Remove any deprecated AMIs from production environments and restrict their usage to isolated testing.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Add Rule Exceptions</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Create exceptions for legitimate use cases or automated tools that query for deprecated AMIs.
</li>
<li class="listitem">
Document and communicate the exceptions to relevant teams to avoid future alerts.
</li>
</ul>
</div>
</li>
</ol>
</div>
<p><span class="strong strong"><strong>Additional Resources</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html" class="ulink" target="_top">AWS Documentation: AMI Lifecycle Management</a>
</li>
<li class="listitem">
<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ami-deprecate.html" class="ulink" target="_top">AWS Documentation: Deprecated AMIs</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5853"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/downloadable-packages/8-15-14/prebuilt-rule-8-15-14-aws-ec2-deprecated-ami-discovery.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset: "aws.cloudtrail"
    and event.provider: "ec2.amazonaws.com"
    and event.action: "DescribeImages"
    and event.outcome: "success"
    and aws.cloudtrail.flattened.request_parameters.includeDeprecated: "true"
    and aws.cloudtrail.request_parameters: *owner=*</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Discovery
</li>
<li class="listitem">
ID: TA0007
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0007/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0007/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Cloud Infrastructure Discovery
</li>
<li class="listitem">
ID: T1580
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1580/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1580/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-15-14-aws-sqs-queue-purge.html">« AWS SQS Queue Purge</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-15-14-excessive-aws-s3-object-encryption-with-sse-c.html">Excessive AWS S3 Object Encryption with SSE-C »</a>
</span>
</div>
</body>
</html>
