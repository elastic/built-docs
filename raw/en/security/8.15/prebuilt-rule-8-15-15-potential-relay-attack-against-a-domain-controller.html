<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Potential Relay Attack against a Domain Controller | Elastic Security Solution [8.15] | Elastic</title>
<meta class="elastic" name="content" content="Potential Relay Attack against a Domain Controller | Elastic Security Solution [8.15]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.15]"/>
<link rel="up" href="prebuilt-rule-8-15-15-prebuilt-rules-8-15-15-appendix.html" title="Appendix b: Downloadable rule update v8.15.15"/>
<link rel="prev" href="prebuilt-rule-8-15-15-creation-of-a-dns-named-record.html" title="Creation of a DNS-Named Record"/>
<link rel="next" href="prebuilt-rule-8-15-15-creation-or-modification-of-domain-backup-dpapi-private-key.html" title="Creation or Modification of Domain Backup DPAPI private key"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.15"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.15"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-15-15-creation-of-a-dns-named-record.html">« Creation of a DNS-Named Record</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-15-15-creation-or-modification-of-domain-backup-dpapi-private-key.html">Creation or Modification of Domain Backup DPAPI private key »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.15]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-15-15-prebuilt-rules-8-15-15-appendix.html">Downloadable rule update v8.15.15</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Potential Relay Attack against a Domain Controller</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/downloadable-packages/8-15-15/prebuilt-rule-8-15-15-potential-relay-attack-against-a-domain-controller.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-15-15-potential-relay-attack-against-a-domain-controller"></a>Potential Relay Attack against a Domain Controller</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/downloadable-packages/8-15-15/prebuilt-rule-8-15-15-potential-relay-attack-against-a-domain-controller.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies potential relay attacks against a domain controller (DC) by identifying authentication events using the domain controller computer account coming from other hosts to the DC that owns the account. Attackers may relay the DC hash after capturing it using forced authentication.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
logs-system.security-*
</li>
<li class="listitem">
logs-windows.forwarded*
</li>
<li class="listitem">
winlogbeat-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.15/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://github.com/p0dalirius/windows-coerced-authentication-methods" class="ulink" target="_top">https://github.com/p0dalirius/windows-coerced-authentication-methods</a>
</li>
<li class="listitem">
<a href="https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications" class="ulink" target="_top">https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications</a>
</li>
<li class="listitem">
<a href="https://attack.mitre.org/techniques/T1187/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1187/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Credential Access
</li>
<li class="listitem">
Data Source: Elastic Defend
</li>
<li class="listitem">
Data Source: Active Directory
</li>
<li class="listitem">
Use Case: Active Directory Monitoring
</li>
<li class="listitem">
Data Source: System
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 103</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_5223"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/downloadable-packages/8-15-15/prebuilt-rule-8-15-15-potential-relay-attack-against-a-domain-controller.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Potential Relay Attack against a Domain Controller</strong></span></p>
<p>Domain Controllers (DCs) are critical in managing authentication within Windows environments. Adversaries exploit this by capturing and relaying DC credentials, often using NTLM authentication, to gain unauthorized access. The detection rule identifies anomalies in authentication events, such as machine accounts logging in from unexpected hosts, indicating potential relay attacks. By analyzing network logon types and mismatched IP addresses, it flags suspicious activities, aiding in early threat detection.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the authentication events with event codes 4624 and 4625 to identify any anomalies in logon attempts, focusing on those using NTLM authentication.
</li>
<li class="listitem">
Examine the source IP addresses of the suspicious authentication events to determine if they are external or unexpected within the network environment.
</li>
<li class="listitem">
Verify the machine account names that end with a dollar sign ($) to ensure they match the expected hostnames, and investigate any discrepancies.
</li>
<li class="listitem">
Check the network logon types to confirm if they align with typical usage patterns for the identified machine accounts.
</li>
<li class="listitem">
Investigate the context of the source IP addresses that do not match the host IP, looking for any signs of unauthorized access or unusual network activity.
</li>
<li class="listitem">
Correlate the findings with other security logs and alerts to identify any patterns or additional indicators of compromise related to the potential relay attack.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Machine accounts performing legitimate network logons from different IP addresses can trigger false positives. To manage this, identify and whitelist known IP addresses associated with legitimate administrative tasks or automated processes.
</li>
<li class="listitem">
Scheduled tasks or automated scripts that use machine accounts for network operations may be flagged. Review and document these tasks, then create exceptions for their associated IP addresses and hostnames.
</li>
<li class="listitem">
Load balancers or proxy servers that alter the source IP address of legitimate authentication requests can cause false alerts. Ensure these devices are accounted for in the network architecture and exclude their IP addresses from the rule.
</li>
<li class="listitem">
Temporary network reconfigurations or migrations might result in machine accounts appearing to log in from unexpected hosts. During such events, temporarily adjust the rule parameters or disable the rule to prevent unnecessary alerts.
</li>
<li class="listitem">
Regularly review and update the list of exceptions to ensure they reflect current network configurations and operational practices, minimizing the risk of overlooking genuine threats.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected domain controller from the network to prevent further unauthorized access and potential lateral movement by the attacker.
</li>
<li class="listitem">
Conduct a password reset for the domain controller&#8217;s machine account and any other accounts that may have been compromised or are at risk, ensuring the use of strong, unique passwords.
</li>
<li class="listitem">
Review and analyze recent authentication logs and network traffic to identify any other potentially compromised systems or accounts, focusing on the source IP addresses flagged in the alert.
</li>
<li class="listitem">
Implement network segmentation to limit the ability of attackers to relay credentials between systems, particularly between domain controllers and other critical infrastructure.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) or incident response team for further investigation and to determine the full scope of the breach.
</li>
<li class="listitem">
Deploy additional monitoring and detection mechanisms to identify similar relay attack patterns in the future, enhancing the detection capabilities for NTLM relay attacks.
</li>
<li class="listitem">
Conduct a post-incident review to identify any gaps in security controls and update policies or procedures to prevent recurrence, ensuring lessons learned are applied to improve overall security posture.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_6690"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/downloadable-packages/8-15-15/prebuilt-rule-8-15-15-potential-relay-attack-against-a-domain-controller.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">authentication where host.os.type == "windows" and event.code in ("4624", "4625") and endswith~(user.name, "$") and
    winlog.event_data.AuthenticationPackageName : "NTLM" and winlog.logon.type : "network" and

    /* Filter for a machine account that matches the hostname */
    startswith~(host.name, substring(user.name, 0, -1)) and

    /* Verify if the Source IP belongs to the host */
    not endswith(string(source.ip), string(host.ip)) and
    source.ip != null and source.ip != "::1" and source.ip != "127.0.0.1"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Forced Authentication
</li>
<li class="listitem">
ID: T1187
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1187/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1187/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Adversary-in-the-Middle
</li>
<li class="listitem">
ID: T1557
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1557/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1557/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: LLMNR/NBT-NS Poisoning and SMB Relay
</li>
<li class="listitem">
ID: T1557.001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1557/001/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1557/001/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-15-15-creation-of-a-dns-named-record.html">« Creation of a DNS-Named Record</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-15-15-creation-or-modification-of-domain-backup-dpapi-private-key.html">Creation or Modification of Domain Backup DPAPI private key »</a>
</span>
</div>
</body>
</html>
