<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SSM Session Started to EC2 Instance | Elastic Security Solution [8.15] | Elastic</title>
<meta class="elastic" name="content" content="SSM Session Started to EC2 Instance | Elastic Security Solution [8.15]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.15]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="ssh-process-launched-from-inside-a-container.html" title="SSH Process Launched From Inside A Container"/>
<link rel="next" href="suid-sgid-bit-set.html" title="SUID/SGID Bit Set"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.15"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.15"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="ssh-process-launched-from-inside-a-container.html">« SSH Process Launched From Inside A Container</a>
</span>
<span class="next">
<a href="suid-sgid-bit-set.html">SUID/SGID Bit Set »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.15]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>SSM Session Started to EC2 Instance</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/ssm-session-started-to-ec2-instance.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="ssm-session-started-to-ec2-instance"></a>SSM Session Started to EC2 Instance<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/ssm-session-started-to-ec2-instance.asciidoc">edit</a></h2>
</div></div></div>
<p>Identifies the first occurrence of an AWS resource establishing a session via SSM to an EC2 instance. Adversaries may use AWS Systems Manager to establish a session to an EC2 instance to execute commands on the instance. This can be used to gain access to the instance and perform actions such as privilege escalation. This rule helps detect the first occurrence of this activity for a given AWS resource.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-aws.cloudtrail-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 10m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-60m (<a href="/guide/en/elasticsearch/reference/8.15/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://docs.aws.amazon.com/systems-manager/latest/APIReference/API_StartSession.html" class="ulink" target="_top">https://docs.aws.amazon.com/systems-manager/latest/APIReference/API_StartSession.html</a>
</li>
<li class="listitem">
<a href="https://hackingthe.cloud/aws/post_exploitation/intercept_ssm_communications/" class="ulink" target="_top">https://hackingthe.cloud/aws/post_exploitation/intercept_ssm_communications/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Data Source: AWS
</li>
<li class="listitem">
Data Source: Amazon Web Services
</li>
<li class="listitem">
Data Source: AWS SSM
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Lateral Movement
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 1</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_investigation_guide_433"></a>Investigation guide<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/ssm-session-started-to-ec2-instance.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="strong strong"><strong>Triage and Analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating SSM Session Started to EC2 Instance</strong></span></p>
<p>This rule detects the first instance of an AWS resource initiating an SSM session to an EC2 instance, which could be indicative of legitimate administrative activities or potential malicious actions like command execution or lateral movement.</p>
<p><span class="strong strong"><strong>Possible Investigation Steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Examine the Session Start Event</strong></span>: Review the AWS CloudTrail log for the event.
</li>
<li class="listitem">
Look for the <code class="literal">StartSession</code> action and verify details such as the <code class="literal">user_identity.arn</code>, <code class="literal">event.action</code>, and the target EC2 instance (<code class="literal">aws.cloudtrail.flattened.request_parameters</code>).
</li>
<li class="listitem">
<span class="strong strong"><strong>Verify User Identity and Role</strong></span>: Check the user’s ARN and access key ID (<code class="literal">aws.cloudtrail.user_identity.access_key_id</code>).
</li>
<li class="listitem">
Cross-reference this with IAM to verify if the user had the necessary permissions and if their role typically requires initiating SSM sessions.
</li>
<li class="listitem">
<span class="strong strong"><strong>Assess Geographic and IP Context</strong></span>: Analyze the source IP (<code class="literal">source.ip</code>) and geographic location (<code class="literal">source.geo</code>) from which the session was initiated.
</li>
<li class="listitem">
Determine if these are consistent with typical user locations or if they raise suspicions of compromise or misuse.
</li>
<li class="listitem">
<span class="strong strong"><strong>Review Session Details</strong></span>: Examine details like the session ID and stream URL (<code class="literal">aws.cloudtrail.flattened.response_elements</code>) to understand the scope and nature of the session.
</li>
<li class="listitem">
Check if any commands executed during the session were unauthorized or out of ordinary practices.
</li>
<li class="listitem">
<span class="strong strong"><strong>Correlate with Other Security Events</strong></span>: Look for other related security events around the time of the session start to identify any pattern or broader attack vector that may involve this user or EC2 instance.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False Positive Analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Legitimate Administrative Activities</strong></span>: Confirm whether the SSM session was initiated for valid administrative purposes such as system maintenance, patching, or configuration updates. Verify with the respective teams or personnel.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and Remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Immediate Session Review</strong></span>: If the session initiation seems suspicious, review all actions taken during the session.
</li>
<li class="listitem">
If possible, terminate the session to prevent any potential harm.
</li>
<li class="listitem">
<span class="strong strong"><strong>Validate and Reinforce Security Policies</strong></span>: Ensure that policies around SSM session initiation are strict and adhere to the principle of least privilege.
</li>
<li class="listitem">
Update IAM policies if necessary to tighten controls.
</li>
<li class="listitem">
<span class="strong strong"><strong>Incident Response Activation</strong></span>: If malicious intent or actions are confirmed, activate the incident response protocol.
</li>
<li class="listitem">
This includes containment of the threat, eradication of the adversary’s presence, recovery of affected systems, and a thorough investigation.
</li>
<li class="listitem">
<span class="strong strong"><strong>Enhance Monitoring and Alerts</strong></span>: Improve monitoring of SSM sessions, particularly focusing on sessions that involve sensitive or critical EC2 instances.
</li>
<li class="listitem">
Adjust alerting mechanisms to flag unusual session initiations promptly.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Additional Information</strong></span></p>
<p>For more in-depth understanding of managing SSM sessions and security best practices, refer to the <a href="https://docs.aws.amazon.com/systems-manager/latest/APIReference/API_StartSession.html" class="ulink" target="_top">AWS Systems Manager documentation</a>. Additionally, consider the security implications and best practices outlined in <a href="https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-privilege-escalation/aws-ssm-privesc" class="ulink" target="_top">AWS SSM privilege escalation techniques</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_rule_query_854"></a>Rule query<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/ssm-session-started-to-ec2-instance.asciidoc">edit</a></h3>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset:"aws.cloudtrail" and event.provider:"ssm.amazonaws.com"
    and event.action:"StartSession" and event.outcome:"success"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Lateral Movement
</li>
<li class="listitem">
ID: TA0008
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0008/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0008/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Remote Services
</li>
<li class="listitem">
ID: T1021
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1021/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1021/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Cloud Services
</li>
<li class="listitem">
ID: T1021.007
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1021/007/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1021/007/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="ssh-process-launched-from-inside-a-container.html">« SSH Process Launched From Inside A Container</a>
</span>
<span class="next">
<a href="suid-sgid-bit-set.html">SUID/SGID Bit Set »</a>
</span>
</div>
</body>
</html>
