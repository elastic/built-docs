<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Unusual Print Spooler Child Process | Elastic Security Solution [8.15] | Elastic</title>
<meta class="elastic" name="content" content="Unusual Print Spooler Child Process | Elastic Security Solution [8.15]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.15]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="unusual-preload-environment-variable-process-execution.html" title="Unusual Preload Environment Variable Process Execution"/>
<link rel="next" href="unusual-process-execution-path-alternate-data-stream.html" title="Unusual Process Execution Path - Alternate Data Stream"/>
<meta class="elastic" name="product_version" content="8.15"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.15"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.15"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="unusual-preload-environment-variable-process-execution.html">« Unusual Preload Environment Variable Process Execution</a>
</span>
<span class="next">
<a href="unusual-process-execution-path-alternate-data-stream.html">Unusual Process Execution Path - Alternate Data Stream »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.15]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Unusual Print Spooler Child Process</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/unusual-print-spooler-child-process.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="unusual-print-spooler-child-process"></a>Unusual Print Spooler Child Process</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/unusual-print-spooler-child-process.asciidoc">edit</a></div>
</div></div></div>
<p>Detects unusual Print Spooler service (spoolsv.exe) child processes. This may indicate an attempt to exploit privilege escalation vulnerabilities related to the Printing Service on Windows.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
winlogbeat-*
</li>
<li class="listitem">
logs-endpoint.events.process-*
</li>
<li class="listitem">
logs-windows.*
</li>
<li class="listitem">
logs-system.security*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.15/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527" class="ulink" target="_top">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Privilege Escalation
</li>
<li class="listitem">
Use Case: Vulnerability
</li>
<li class="listitem">
Data Source: Elastic Defend
</li>
<li class="listitem">
Data Source: System
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 210</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_1135"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/unusual-print-spooler-child-process.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Unusual Print Spooler Child Process</strong></span></p>
<p>The Print Spooler service, integral to Windows environments, manages print jobs and interactions with printers. Adversaries may exploit vulnerabilities in this service to escalate privileges, gaining unauthorized access or control. The detection rule identifies suspicious child processes spawned by the Print Spooler, excluding known legitimate processes, to flag potential exploitation attempts, focusing on unusual command lines and integrity levels.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the process details to identify the unusual child process spawned by spoolsv.exe, focusing on the process name and command line arguments to understand its purpose and potential malicious intent.
</li>
<li class="listitem">
Check the integrity level of the process using the fields process.Ext.token.integrity_level_name or winlog.event_data.IntegrityLevel to confirm if it is running with elevated privileges, which could indicate an exploitation attempt.
</li>
<li class="listitem">
Investigate the parent-child relationship by examining the process tree to determine if there are any other suspicious processes associated with the same parent process, spoolsv.exe.
</li>
<li class="listitem">
Cross-reference the process executable path against known legitimate software paths to ensure it is not a false positive, especially if the executable is not listed in the exclusion paths.
</li>
<li class="listitem">
Analyze recent system logs and security events around the time of the alert to identify any other anomalous activities or patterns that could be related to the potential exploitation attempt.
</li>
<li class="listitem">
If the process is confirmed suspicious, isolate the affected system to prevent further exploitation and conduct a deeper forensic analysis to understand the scope and impact of the incident.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Legitimate print-related processes like splwow64.exe, PDFCreator.exe, and acrodist.exe may trigger alerts. These are excluded in the rule to prevent false positives.
</li>
<li class="listitem">
System processes such as msiexec.exe, route.exe, and WerFault.exe are known to be legitimate child processes of the Print Spooler and are excluded to reduce false alerts.
</li>
<li class="listitem">
Commands involving net.exe for starting or stopping services are common in administrative tasks and are excluded to avoid unnecessary alerts.
</li>
<li class="listitem">
Command-line operations involving cmd.exe or powershell.exe that reference .spl files or system paths are often legitimate and are excluded to minimize false positives.
</li>
<li class="listitem">
Network configuration changes using netsh.exe, such as adding port openings or rules, are typical in network management and are excluded to prevent false alerts.
</li>
<li class="listitem">
Registration of PrintConfig.dll via regsvr32.exe is a known legitimate operation and is excluded to avoid false positives.
</li>
<li class="listitem">
Executables from known paths like CutePDF Writer and GPLGS are excluded to prevent alerts from common, non-threatening applications.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected system from the network to prevent further exploitation or lateral movement by the adversary.
</li>
<li class="listitem">
Terminate any suspicious child processes spawned by the Print Spooler service that do not match known legitimate processes or command lines.
</li>
<li class="listitem">
Conduct a thorough review of the system&#8217;s security logs to identify any unauthorized access or privilege escalation attempts related to the Print Spooler service.
</li>
<li class="listitem">
Apply the latest security patches and updates to the Windows operating system and specifically to the Print Spooler service to mitigate known vulnerabilities.
</li>
<li class="listitem">
Restore the system from a clean backup if any unauthorized changes or malicious activities are confirmed.
</li>
<li class="listitem">
Monitor the system closely for any recurrence of similar suspicious activities, ensuring enhanced logging and alerting are in place for spoolsv.exe and its child processes.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) or incident response team for further investigation and to assess the potential impact on other systems within the network.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_710"></a>Setup</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/unusual-print-spooler-child-process.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Setup</strong></span></p>
<p>If enabling an EQL rule on a non-elastic-agent index (such as beats) for versions &lt;8.2,
events will not define <code class="literal">event.ingested</code> and default fallback for EQL rules was not added until version 8.2.
Hence for this rule to work effectively, users will need to add a custom ingest pipeline to populate
<code class="literal">event.ingested</code> to @timestamp.
For more details on adding a custom ingest pipeline refer - <a href="/guide/en/fleet/current/data-streams-pipeline-tutorial.html" class="ulink" target="_top">https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html</a></p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_1176"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.15/docs/detections/prebuilt-rules/rule-details/unusual-print-spooler-child-process.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">process where host.os.type == "windows" and event.type == "start" and
 process.parent.name : "spoolsv.exe" and process.command_line != null and
 (?process.Ext.token.integrity_level_name : "System" or ?winlog.event_data.IntegrityLevel : "System") and

 /* exclusions for FP control below */
 not process.name : ("splwow64.exe", "PDFCreator.exe", "acrodist.exe", "spoolsv.exe", "msiexec.exe", "route.exe", "WerFault.exe") and
 not process.command_line : "*\\WINDOWS\\system32\\spool\\DRIVERS*" and
 not (process.name : "net.exe" and process.command_line : ("*stop*", "*start*")) and
 not (process.name : ("cmd.exe", "powershell.exe") and process.command_line : ("*.spl*", "*\\program files*", "*route add*")) and
 not (process.name : "netsh.exe" and process.command_line : ("*add portopening*", "*rule name*")) and
 not (process.name : "regsvr32.exe" and process.command_line : "*PrintConfig.dll*") and
 not process.executable : (
    "?:\\Program Files (x86)\\CutePDF Writer\\CPWriter2.exe",
    "?:\\Program Files (x86)\\GPLGS\\gswin32c.exe"
 )</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Privilege Escalation
</li>
<li class="listitem">
ID: TA0004
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0004/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0004/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Exploitation for Privilege Escalation
</li>
<li class="listitem">
ID: T1068
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1068/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1068/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="unusual-preload-environment-variable-process-execution.html">« Unusual Preload Environment Variable Process Execution</a>
</span>
<span class="next">
<a href="unusual-process-execution-path-alternate-data-stream.html">Unusual Process Execution Path - Alternate Data Stream »</a>
</span>
</div>
</body>
</html>
