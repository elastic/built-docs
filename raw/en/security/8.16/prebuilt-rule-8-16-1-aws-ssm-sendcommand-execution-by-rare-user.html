<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AWS SSM SendCommand Execution by Rare User | Elastic Security Solution [8.16] | Elastic</title>
<meta class="elastic" name="content" content="AWS SSM SendCommand Execution by Rare User | Elastic Security Solution [8.16]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.16]"/>
<link rel="up" href="prebuilt-rule-8-16-1-prebuilt-rules-8-16-1-appendix.html" title="Appendix T: Downloadable rule update v8.16.1"/>
<link rel="prev" href="prebuilt-rule-8-16-1-aws-sts-getcalleridentity-api-called-for-the-first-time.html" title="AWS STS GetCallerIdentity API Called for the First Time"/>
<link rel="next" href="prebuilt-rule-8-16-1-aws-s3-bucket-enumeration-or-brute-force.html" title="AWS S3 Bucket Enumeration or Brute Force"/>
<meta class="elastic" name="product_version" content="8.16"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.16"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.16"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-16-1-aws-sts-getcalleridentity-api-called-for-the-first-time.html">« AWS STS GetCallerIdentity API Called for the First Time</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-16-1-aws-s3-bucket-enumeration-or-brute-force.html">AWS S3 Bucket Enumeration or Brute Force »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.16]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-16-1-prebuilt-rules-8-16-1-appendix.html">Downloadable rule update v8.16.1</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>AWS SSM SendCommand Execution by Rare User</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-1/prebuilt-rule-8-16-1-aws-ssm-sendcommand-execution-by-rare-user.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-16-1-aws-ssm-sendcommand-execution-by-rare-user"></a>AWS SSM <code class="literal">SendCommand</code> Execution by Rare User</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-1/prebuilt-rule-8-16-1-aws-ssm-sendcommand-execution-by-rare-user.asciidoc">edit</a></div>
</div></div></div>
<p>Detects the execution of commands or scripts on EC2 instances using AWS Systems Manager (SSM), such as <code class="literal">RunShellScript</code>, <code class="literal">RunPowerShellScript</code> or custom documents. While legitimate users may employ these commands for management tasks, they can also be exploited by attackers with credentials to establish persistence, install malware, or execute reverse shells for further access to compromised instances. This is a [New Terms](<a href="/guide/en/security/current/rules-ui-create.html#create-new-terms-rule" class="ulink" target="_top">https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule</a>) rule that looks for the first instance of this behavior by the <code class="literal">aws.cloudtrail.user_identity.arn</code> field in the last 7 days.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-aws.cloudtrail-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.16/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-plugins.html" class="ulink" target="_top">https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-plugins.html</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Data Source: AWS
</li>
<li class="listitem">
Data Source: Amazon Web Services
</li>
<li class="listitem">
Data Source: AWS SSM
</li>
<li class="listitem">
Use Case: Log Auditing
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Execution
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 210</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_3897"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-1/prebuilt-rule-8-16-1-aws-ssm-sendcommand-execution-by-rare-user.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and Analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating AWS SSM <code class="literal">SendCommand</code> Execution by Rare User</strong></span></p>
<p>This rule detects the execution of commands or scripts on EC2 instances using AWS Systems Manager (SSM) by an unexpected or new user. The SSM <code class="literal">SendCommand</code> action can enable remote command execution, which adversaries may exploit to install backdoors, deploy malware, or interact with compromised instances through reverse shells.</p>
<p><span class="strong strong"><strong>Possible Investigation Steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Identify the Target Instance</strong></span>:
</li>
<li class="listitem">
<span class="strong strong"><strong>Instance ID</strong></span>: Review the <code class="literal">aws.cloudtrail.flattened.request_parameters.targets</code> field to identify which EC2 instances were targeted by this command. Confirm if these instances are expected to be managed through SSM.
</li>
<li class="listitem">
<span class="strong strong"><strong>Document Used</strong></span>: Check the <code class="literal">aws.cloudtrail.flattened.request_parameters.documentName</code> field, which specifies the document or script being executed. Commands such as <code class="literal">RunShellScript</code> or <code class="literal">RunPowerShellScript</code> can indicate interactive sessions or script-based interactions.
</li>
<li class="listitem">
<span class="strong strong"><strong>Review User Context</strong></span>:
</li>
<li class="listitem">
<span class="strong strong"><strong>User Identity</strong></span>: Inspect the <code class="literal">aws.cloudtrail.user_identity.arn</code> field to determine the user or role executing the <code class="literal">SendCommand</code>. If this user is not typically involved in EC2 or SSM interactions, this could indicate unauthorized access.
</li>
<li class="listitem">
<span class="strong strong"><strong>Access Patterns</strong></span>: Validate whether the user typically has permissions to perform <code class="literal">SendCommand</code> operations on instances and whether the frequency of this action matches expected behavior.
</li>
<li class="listitem">
<span class="strong strong"><strong>Analyze Command Parameters</strong></span>:
</li>
<li class="listitem">
<span class="strong strong"><strong>Document Contents</strong></span>: While the exact command may not be visible in CloudTrail, use logs to determine the purpose of the script, especially if the document name suggests encryption, data transfer, or reverse shell capabilities.
</li>
<li class="listitem">
<span class="strong strong"><strong>Timing and Context</strong></span>: Compare this command execution with other recent SSM actions in your environment. A single <code class="literal">SendCommand</code> event by an unusual user can indicate an early stage of a larger attack.
</li>
<li class="listitem">
<span class="strong strong"><strong>Check User Agent and Source IP</strong></span>:
</li>
<li class="listitem">
<span class="strong strong"><strong>User Agent Analysis</strong></span>: Review the <code class="literal">user_agent.original</code> field to verify the tool or client used (e.g., <code class="literal">aws-cli</code>). This can provide insight into whether this action was automated, scripted, or executed manually.
</li>
<li class="listitem">
<span class="strong strong"><strong>Source IP and Geolocation</strong></span>: Use <code class="literal">source.address</code> and <code class="literal">source.geo</code> fields to check if the IP address and geolocation align with expected regions for your organization. Unusual IP addresses or locations can indicate external adversaries.
</li>
<li class="listitem">
<span class="strong strong"><strong>Evaluate for Persistence Indicators</strong></span>:
</li>
<li class="listitem">
<span class="strong strong"><strong>Command Consistency</strong></span>: Investigate if this action is part of a recurring pattern, such as repeated command executions across instances, which may suggest an attempt to maintain access.
</li>
<li class="listitem">
<span class="strong strong"><strong>Permissions</strong></span>: Ensure that the IAM policies associated with the user limit <code class="literal">SendCommand</code> actions to necessary use cases. Consider adding alerts for commands executed by users with minimal roles or permissions.
</li>
<li class="listitem">
<span class="strong strong"><strong>Correlate with Other CloudTrail Events</strong></span>:
</li>
<li class="listitem">
<span class="strong strong"><strong>Cross-Reference SSM Actions</strong></span>: Look for other recent SSM actions like <code class="literal">CreateDocument</code>, <code class="literal">UpdateDocument</code>, or additional <code class="literal">SendCommand</code> events that could indicate preparation for further exploitation.
</li>
<li class="listitem">
<span class="strong strong"><strong>Monitor Data Access or Modification</strong></span>: Correlate with <code class="literal">S3</code> access patterns, IAM changes, or EC2 modifications in recent events to detect broader malicious activities.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False Positive Analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Routine Automation</strong></span>: SSM <code class="literal">SendCommand</code> may be used by automation scripts or management tools. Verify if this event aligns with known, routine automated workflows.
</li>
<li class="listitem">
<span class="strong strong"><strong>Maintenance Activity</strong></span>: Confirm if legitimate administrative activities, such as patching or updates, are expected at this time, which may involve similar commands executed on multiple instances.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and Remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Limit SSM Permissions</strong></span>: If unauthorized, immediately revoke <code class="literal">SendCommand</code> permissions from the user or role to prevent further access.
</li>
<li class="listitem">
<span class="strong strong"><strong>Quarantine Target Instance</strong></span>: If malicious behavior is confirmed, isolate the affected EC2 instance(s) to limit lateral movement or data exfiltration.
</li>
<li class="listitem">
<span class="strong strong"><strong>Investigate and Contain User Account</strong></span>: If the action was performed by a compromised account, review recent activity and reset access credentials as necessary.
</li>
<li class="listitem">
<span class="strong strong"><strong>Audit SSM and IAM Configurations</strong></span>: Periodically review permissions associated with SSM usage and ensure least privilege access principles are in place.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Additional Information</strong></span></p>
<p>For further details on managing AWS SSM and security best practices for EC2 instances, refer to the <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-plugins.html" class="ulink" target="_top">AWS Systems Manager Documentation</a> and AWS best practices.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_4802"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-1/prebuilt-rule-8-16-1-aws-ssm-sendcommand-execution-by-rare-user.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset: "aws.cloudtrail"
    and event.provider: "ssm.amazonaws.com"
    and event.action: "SendCommand"
    and event.outcome: "success"
    and not aws.cloudtrail.user_identity.arn: *AWSServiceRoleForAmazonSSM/StateManagerService*</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Execution
</li>
<li class="listitem">
ID: TA0002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0002/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0002/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Cloud Administration Command
</li>
<li class="listitem">
ID: T1651
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1651/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1651/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-16-1-aws-sts-getcalleridentity-api-called-for-the-first-time.html">« AWS STS GetCallerIdentity API Called for the First Time</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-16-1-aws-s3-bucket-enumeration-or-brute-force.html">AWS S3 Bucket Enumeration or Brute Force »</a>
</span>
</div>
</body>
</html>
