<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AWS STS AssumeRole with New MFA Device | Elastic Security Solution [8.16] | Elastic</title>
<meta class="elastic" name="content" content="AWS STS AssumeRole with New MFA Device | Elastic Security Solution [8.16]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.16]"/>
<link rel="up" href="prebuilt-rule-8-16-6-prebuilt-rules-8-16-6-appendix.html" title="Appendix Y: Downloadable rule update v8.16.6"/>
<link rel="prev" href="prebuilt-rule-8-16-6-aws-route-table-created.html" title="AWS Route Table Created"/>
<link rel="next" href="prebuilt-rule-8-16-6-aws-iam-administratoraccess-policy-attached-to-group.html" title="AWS IAM AdministratorAccess Policy Attached to Group"/>
<meta class="elastic" name="product_version" content="8.16"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.16"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.16"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-16-6-aws-route-table-created.html">« AWS Route Table Created</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-16-6-aws-iam-administratoraccess-policy-attached-to-group.html">AWS IAM AdministratorAccess Policy Attached to Group »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.16]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-16-6-prebuilt-rules-8-16-6-appendix.html">Downloadable rule update v8.16.6</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>AWS STS AssumeRole with New MFA Device</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-6/prebuilt-rule-8-16-6-aws-sts-assumerole-with-new-mfa-device.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-16-6-aws-sts-assumerole-with-new-mfa-device"></a>AWS STS AssumeRole with New MFA Device</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-6/prebuilt-rule-8-16-6-aws-sts-assumerole-with-new-mfa-device.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies when a user has assumed a role using a new MFA device. Users can assume a role to obtain temporary credentials and access AWS resources using the AssumeRole API of AWS Security Token Service (STS). While a new MFA device is not always indicative of malicious behavior it should be verified as adversaries can use this technique for persistence and privilege escalation.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-aws.cloudtrail-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: None (<a href="/guide/en/elasticsearch/reference/8.16/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html" class="ulink" target="_top">https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html</a>
</li>
<li class="listitem">
<a href="https://github.com/RhinoSecurityLabs/cloudgoat/blob/d5863b80afd082d853f2e8df1955c6393695a4da/scenarios/iam_privesc_by_key_rotation/README.md" class="ulink" target="_top">https://github.com/RhinoSecurityLabs/cloudgoat/blob/d5863b80afd082d853f2e8df1955c6393695a4da/scenarios/iam_privesc_by_key_rotation/README.md</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Data Source: AWS
</li>
<li class="listitem">
Data Source: Amazon Web Services
</li>
<li class="listitem">
Data Source: AWS STS
</li>
<li class="listitem">
Use Case: Identity and Access Audit
</li>
<li class="listitem">
Tactic: Privilege Escalation
</li>
<li class="listitem">
Tactic: Persistence
</li>
<li class="listitem">
Tactic: Lateral Movement
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 2</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4198"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-6/prebuilt-rule-8-16-6-aws-sts-assumerole-with-new-mfa-device.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating AWS STS AssumeRole with New MFA Device</strong></span></p>
<p>AWS Security Token Service (STS) allows users to assume roles and gain temporary credentials for accessing AWS resources. This process can involve Multi-Factor Authentication (MFA) for enhanced security. However, adversaries may exploit new MFA devices to maintain persistence or escalate privileges. The detection rule identifies successful role assumptions with new MFA devices, flagging potential misuse for further investigation.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the event details in AWS CloudTrail to identify the user who assumed the role, focusing on the user.id field to determine if the user is legitimate and authorized to use the new MFA device.
</li>
<li class="listitem">
Check the serialNumber in the aws.cloudtrail.flattened.request_parameters to verify the registration and legitimacy of the new MFA device associated with the role assumption.
</li>
<li class="listitem">
Investigate the context of the AssumeRole action by examining the event.action field to understand if it was part of a legitimate workflow or an unusual activity.
</li>
<li class="listitem">
Analyze the event.outcome field to confirm the success of the role assumption and cross-reference with any recent changes in user permissions or MFA device registrations.
</li>
<li class="listitem">
Correlate the event with other logs or alerts to identify any patterns of suspicious behavior, such as multiple role assumptions or changes in MFA devices within a short timeframe.
</li>
<li class="listitem">
Contact the user or relevant team to confirm if the new MFA device registration and role assumption were expected and authorized.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
New employee onboarding processes may trigger this rule when new MFA devices are issued. To manage this, create exceptions for known onboarding activities by correlating with HR records or onboarding schedules.
</li>
<li class="listitem">
Routine device replacements or upgrades can result in new MFA devices being registered. Implement a process to track and verify device changes through IT support tickets or asset management systems.
</li>
<li class="listitem">
Users with multiple roles or responsibilities might frequently switch roles using different MFA devices. Establish a baseline of normal behavior for these users and create exceptions for their typical activity patterns.
</li>
<li class="listitem">
Organizational policy changes that require MFA updates can lead to multiple new MFA device registrations. Coordinate with security teams to whitelist these events during policy rollout periods.
</li>
<li class="listitem">
Temporary contractors or third-party vendors may use new MFA devices when accessing AWS resources. Ensure that their access is logged and reviewed, and create temporary exceptions for their known access periods.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately revoke the temporary credentials associated with the assumed role to prevent unauthorized access to AWS resources.
</li>
<li class="listitem">
Verify the legitimacy of the new MFA device by contacting the user or administrator associated with the role assumption. Confirm whether the device was intentionally registered and used.
</li>
<li class="listitem">
If the new MFA device is determined to be unauthorized, disable or remove it from the user&#8217;s account to prevent further misuse.
</li>
<li class="listitem">
Conduct a review of recent AWS CloudTrail logs to identify any suspicious activities or patterns associated with the user or role in question, focusing on privilege escalation or lateral movement attempts.
</li>
<li class="listitem">
Escalate the incident to the security operations team for further investigation and to determine if additional containment measures are necessary.
</li>
<li class="listitem">
Implement additional monitoring and alerting for unusual MFA device registrations and role assumptions to enhance detection of similar threats in the future.
</li>
<li class="listitem">
Review and update IAM policies and MFA device management procedures to ensure they align with best practices for security and access control.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_1033"></a>Setup</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-6/prebuilt-rule-8-16-6-aws-sts-assumerole-with-new-mfa-device.asciidoc">edit</a></div>
</div></div></div>
<p>The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5302"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-6/prebuilt-rule-8-16-6-aws-sts-assumerole-with-new-mfa-device.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset:aws.cloudtrail
    and event.provider:sts.amazonaws.com
    and event.action:(AssumeRole or AssumeRoleWithSAML or AssumeRoleWithWebIdentity)
    and event.outcome:success
    and user.id:*
    and aws.cloudtrail.flattened.request_parameters.serialNumber:*</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Persistence
</li>
<li class="listitem">
ID: TA0003
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0003/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0003/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Modify Authentication Process
</li>
<li class="listitem">
ID: T1556
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1556/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1556/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Multi-Factor Authentication
</li>
<li class="listitem">
ID: T1556.006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1556/006/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1556/006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Privilege Escalation
</li>
<li class="listitem">
ID: TA0004
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0004/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0004/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Abuse Elevation Control Mechanism
</li>
<li class="listitem">
ID: T1548
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1548/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1548/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Lateral Movement
</li>
<li class="listitem">
ID: TA0008
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0008/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0008/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Use Alternate Authentication Material
</li>
<li class="listitem">
ID: T1550
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1550/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1550/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Application Access Token
</li>
<li class="listitem">
ID: T1550.001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1550/001/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1550/001/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-16-6-aws-route-table-created.html">« AWS Route Table Created</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-16-6-aws-iam-administratoraccess-policy-attached-to-group.html">AWS IAM AdministratorAccess Policy Attached to Group »</a>
</span>
</div>
</body>
</html>
