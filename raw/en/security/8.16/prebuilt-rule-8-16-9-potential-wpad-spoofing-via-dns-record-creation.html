<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Potential WPAD Spoofing via DNS Record Creation | Elastic Security Solution [8.16] | Elastic</title>
<meta class="elastic" name="content" content="Potential WPAD Spoofing via DNS Record Creation | Elastic Security Solution [8.16]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.16]"/>
<link rel="up" href="prebuilt-rule-8-16-9-prebuilt-rules-8-16-9-appendix.html" title="Appendix \: Downloadable rule update v8.16.9"/>
<link rel="prev" href="prebuilt-rule-8-16-9-potential-adidns-poisoning-via-wildcard-record-creation.html" title="Potential ADIDNS Poisoning via Wildcard Record Creation"/>
<link rel="next" href="prebuilt-rule-8-16-9-privileged-account-brute-force.html" title="Privileged Account Brute Force"/>
<meta class="elastic" name="product_version" content="8.16"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.16"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.16"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-16-9-potential-adidns-poisoning-via-wildcard-record-creation.html">« Potential ADIDNS Poisoning via Wildcard Record Creation</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-16-9-privileged-account-brute-force.html">Privileged Account Brute Force »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.16]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-16-9-prebuilt-rules-8-16-9-appendix.html">Downloadable rule update v8.16.9</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Potential WPAD Spoofing via DNS Record Creation</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-9/prebuilt-rule-8-16-9-potential-wpad-spoofing-via-dns-record-creation.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-16-9-potential-wpad-spoofing-via-dns-record-creation"></a>Potential WPAD Spoofing via DNS Record Creation</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-9/prebuilt-rule-8-16-9-potential-wpad-spoofing-via-dns-record-creation.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies the creation of a DNS record that is potentially meant to enable WPAD spoofing. Attackers can disable the Global Query Block List (GQBL) and create a "wpad" record to exploit hosts running WPAD with default settings for privilege escalation and lateral movement.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
logs-system.security*
</li>
<li class="listitem">
logs-windows.forwarded*
</li>
<li class="listitem">
winlogbeat-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.16/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/wpad-spoofing#through-adidns-spoofing" class="ulink" target="_top">https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/wpad-spoofing#through-adidns-spoofing</a>
</li>
<li class="listitem">
<a href="https://cube0x0.github.io/Pocing-Beyond-DA/" class="ulink" target="_top">https://cube0x0.github.io/Pocing-Beyond-DA/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Credential Access
</li>
<li class="listitem">
Data Source: Active Directory
</li>
<li class="listitem">
Use Case: Active Directory Monitoring
</li>
<li class="listitem">
Data Source: Windows Security Event Logs
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 105</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_5347"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-9/prebuilt-rule-8-16-9-potential-wpad-spoofing-via-dns-record-creation.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Potential WPAD Spoofing via DNS Record Creation</strong></span></p>
<p>Web Proxy Auto-Discovery (WPAD) helps devices automatically detect proxy settings, crucial for network efficiency. However, attackers can exploit WPAD by creating malicious DNS records, tricking systems into using rogue proxies for data interception. The detection rule identifies suspicious DNS record changes, specifically targeting WPAD entries, to flag potential spoofing attempts, aiding in early threat detection and mitigation.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the event logs for the specific event code "5137" to identify the creation or modification of the "wpad" DNS record. Focus on the details provided in the winlog.event_data.ObjectDN field to confirm the presence of "DC=wpad,*".
</li>
<li class="listitem">
Check the Active Directory change history to determine who made the changes to the DNS records and whether these changes were authorized.
</li>
<li class="listitem">
Investigate the user account associated with the directory service change event to assess if it has been compromised or if there are any signs of unauthorized access.
</li>
<li class="listitem">
Analyze network traffic to and from the "wpad" DNS record to identify any suspicious activity or connections to rogue proxy servers.
</li>
<li class="listitem">
Verify the configuration of the Global Query Block List (GQBL) to ensure it has not been disabled or altered, which could allow unauthorized WPAD entries.
</li>
<li class="listitem">
Cross-reference the alert with other security logs and alerts to identify any related suspicious activities or patterns that could indicate a broader attack campaign.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Legitimate network changes may trigger alerts if a new WPAD DNS record is created intentionally for network configuration. Verify with network administrators if such changes were planned.
</li>
<li class="listitem">
Automated scripts or software updates that modify DNS records can cause false positives. Review the source of the change and consider excluding known benign scripts or update processes.
</li>
<li class="listitem">
Test environments often simulate DNS changes, including WPAD entries, for development purposes. Exclude these environments from monitoring if they are known to generate non-threatening alerts.
</li>
<li class="listitem">
Some organizations may have legacy systems that rely on WPAD configurations. Document these systems and create exceptions for their DNS changes to avoid unnecessary alerts.
</li>
<li class="listitem">
Regular audits of the Global Query Block List settings can help identify and exclude expected changes, reducing false positives related to WPAD record creation.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected system from the network to prevent further data interception or lateral movement by the rogue proxy.
</li>
<li class="listitem">
Verify and restore the integrity of the DNS records by removing any unauthorized "wpad" entries and re-enabling the Global Query Block List (GQBL) if it was disabled.
</li>
<li class="listitem">
Conduct a thorough review of Active Directory logs to identify any unauthorized changes or suspicious activities related to directory service modifications.
</li>
<li class="listitem">
Reset credentials for any accounts that may have been compromised or accessed during the incident to prevent unauthorized access.
</li>
<li class="listitem">
Implement network segmentation to limit the exposure of critical systems to potential WPAD spoofing attacks.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) for further investigation and to determine if additional systems or data were affected.
</li>
<li class="listitem">
Update and enhance monitoring rules to detect similar WPAD spoofing attempts in the future, ensuring timely alerts and responses.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_1850"></a>Setup</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-9/prebuilt-rule-8-16-9-potential-wpad-spoofing-via-dns-record-creation.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Setup</strong></span></p>
<p>The <em>Audit Directory Service Changes</em> logging policy must be configured for (Success, Failure).
Steps to implement the logging policy with Advanced Audit Configuration:</p>
<pre class="screen">Computer Configuration &gt;
Policies &gt;
Windows Settings &gt;
Security Settings &gt;
Advanced Audit Policies Configuration &gt;
Audit Policies &gt;
DS Access &gt;
Audit Directory Service Changes (Success,Failure)</pre>
<p>The above policy does not cover the target object by default (we still need it to be configured to generate events), so we need to set up an AuditRule using <a href="https://github.com/OTRF/Set-AuditRule" class="ulink" target="_top">https://github.com/OTRF/Set-AuditRule</a>.</p>
<pre class="screen">Set-AuditRule -AdObjectPath 'AD:\CN=MicrosoftDNS,DC=DomainDNSZones,DC=Domain,DC=com' -WellKnownSidType WorldSid -Rights CreateChild -InheritanceFlags Descendents -AttributeGUID e0fa1e8c-9b45-11d0-afdd-00c04fd930c9 -AuditFlags Success</pre>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_6402"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/downloadable-packages/8-16-9/prebuilt-rule-8-16-9-potential-wpad-spoofing-via-dns-record-creation.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">any where host.os.type == "windows" and event.code == "5137" and winlog.event_data.ObjectDN : "DC=wpad,*"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Adversary-in-the-Middle
</li>
<li class="listitem">
ID: T1557
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1557/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1557/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-16-9-potential-adidns-poisoning-via-wildcard-record-creation.html">« Potential ADIDNS Poisoning via Wildcard Record Creation</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-16-9-privileged-account-brute-force.html">Privileged Account Brute Force »</a>
</span>
</div>
</body>
</html>
