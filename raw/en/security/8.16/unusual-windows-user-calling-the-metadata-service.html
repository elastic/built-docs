<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Unusual Windows User Calling the Metadata Service | Elastic Security Solution [8.16] | Elastic</title>
<meta class="elastic" name="content" content="Unusual Windows User Calling the Metadata Service | Elastic Security Solution [8.16]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.16]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="unusual-windows-service.html" title="Unusual Windows Service"/>
<link rel="next" href="unusual-windows-user-privilege-elevation-activity.html" title="Unusual Windows User Privilege Elevation Activity"/>
<meta class="elastic" name="product_version" content="8.16"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.16"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.16"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="unusual-windows-service.html">« Unusual Windows Service</a>
</span>
<span class="next">
<a href="unusual-windows-user-privilege-elevation-activity.html">Unusual Windows User Privilege Elevation Activity »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.16]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Unusual Windows User Calling the Metadata Service</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/rule-details/unusual-windows-user-calling-the-metadata-service.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="unusual-windows-user-calling-the-metadata-service"></a>Unusual Windows User Calling the Metadata Service</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/rule-details/unusual-windows-user-calling-the-metadata-service.asciidoc">edit</a></div>
</div></div></div>
<p>Looks for anomalous access to the cloud platform metadata service by an unusual user. The metadata service may be targeted in order to harvest credentials or user data scripts containing secrets.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: machine_learning</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>: None</p>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 15m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-45m (<a href="/guide/en/elasticsearch/reference/8.16/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>: None</p>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Rule Type: ML
</li>
<li class="listitem">
Rule Type: Machine Learning
</li>
<li class="listitem">
Tactic: Credential Access
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 209</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_1186"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/rule-details/unusual-windows-user-calling-the-metadata-service.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Unusual Windows User Calling the Metadata Service</strong></span></p>
<p>Cloud platforms provide a metadata service that allows instances to access configuration data, including credentials. Adversaries may exploit this by using compromised Windows accounts to query the service, aiming to harvest sensitive information. The detection rule leverages machine learning to identify atypical access patterns by Windows users, flagging potential credential access attempts.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the alert details to identify the specific Windows user account involved in the unusual access to the metadata service.
</li>
<li class="listitem">
Check the timestamp of the access attempt to correlate with any known scheduled tasks or legitimate user activities.
</li>
<li class="listitem">
Investigate the source IP address and device from which the metadata service was accessed to determine if it aligns with expected user behavior or known assets.
</li>
<li class="listitem">
Examine recent login and access logs for the identified user account to detect any other suspicious activities or anomalies.
</li>
<li class="listitem">
Assess whether there have been any recent changes to the user&#8217;s permissions or roles that could explain the access attempt.
</li>
<li class="listitem">
Look for any other alerts or incidents involving the same user account or device to identify potential patterns of malicious behavior.
</li>
<li class="listitem">
Consult with the user or their manager to verify if the access was legitimate or if the account may have been compromised.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Routine administrative tasks by IT personnel may trigger alerts. Review access logs to confirm legitimate administrative actions and consider whitelisting specific user accounts or IP addresses.
</li>
<li class="listitem">
Automated scripts or scheduled tasks that query the metadata service for configuration updates can be mistaken for suspicious activity. Identify these scripts and exclude them from the rule by adding them to an exception list.
</li>
<li class="listitem">
Cloud management tools that regularly access the metadata service for monitoring or configuration purposes might be flagged. Verify these tools and create exceptions for their known access patterns.
</li>
<li class="listitem">
Instances where legitimate software updates or patch management processes access the metadata service should be reviewed. Document these processes and exclude them from triggering alerts.
</li>
<li class="listitem">
Temporary access by third-party vendors or consultants may appear unusual. Ensure their access is documented and create temporary exceptions during their engagement period.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected Windows system from the network to prevent further unauthorized access to the metadata service.
</li>
<li class="listitem">
Revoke any potentially compromised credentials identified during the investigation and issue new credentials to affected users.
</li>
<li class="listitem">
Conduct a thorough review of access logs to identify any unauthorized data access or exfiltration attempts from the metadata service.
</li>
<li class="listitem">
Implement additional monitoring on the affected system and similar systems to detect any further anomalous access attempts.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) for a deeper investigation into potential lateral movement or other compromised systems.
</li>
<li class="listitem">
Apply security patches and updates to the affected system to address any vulnerabilities that may have been exploited.
</li>
<li class="listitem">
Review and enhance access controls and permissions for the metadata service to ensure only authorized users can access sensitive information.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_752"></a>Setup</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.16/docs/detections/prebuilt-rules/rule-details/unusual-windows-user-calling-the-metadata-service.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Setup</strong></span></p>
<p>This rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:
- Elastic Defend
- Windows</p>
<p><span class="strong strong"><strong>Anomaly Detection Setup</strong></span></p>
<p>Once the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the "Definition" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the <a href="/guide/en/kibana/current/xpack-ml-anomalies.html" class="ulink" target="_top">helper guide</a>.</p>
<p><span class="strong strong"><strong>Elastic Defend Integration Setup</strong></span></p>
<p>Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.</p>
<p><span class="strong strong"><strong>Prerequisite Requirements:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fleet is required for Elastic Defend.
</li>
<li class="listitem">
To configure Fleet Server refer to the <a href="/guide/en/fleet/current/fleet-server.html" class="ulink" target="_top">documentation</a>.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>The following steps should be executed in order to add the Elastic Defend integration to your system:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Go to the Kibana home page and click "Add integrations".
</li>
<li class="listitem">
In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
</li>
<li class="listitem">
Click "Add Elastic Defend".
</li>
<li class="listitem">
Configure the integration name and optionally add a description.
</li>
<li class="listitem">
Select the type of environment you want to protect, either "Traditional Endpoints" or "Cloud Workloads".
</li>
<li class="listitem">
Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. <a href="/guide/en/security/current/configure-endpoint-integration-policy.html" class="ulink" target="_top">Helper guide</a>.
</li>
<li class="listitem">
We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
</li>
<li class="listitem">
Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the <a href="/guide/en/fleet/current/agent-policy.html" class="ulink" target="_top">helper guide</a>.
</li>
<li class="listitem">
Click "Save and Continue".
</li>
<li class="listitem">
To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the <a href="/guide/en/security/current/install-endpoint.html" class="ulink" target="_top">helper guide</a>.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Windows Integration Setup</strong></span></p>
<p>The Windows integration allows you to monitor the Windows OS, services, applications, and more.</p>
<p><span class="strong strong"><strong>The following steps should be executed in order to add the Elastic Agent System integration "windows" to your system:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Go to the Kibana home page and click “Add integrations”.
</li>
<li class="listitem">
In the query bar, search for “Windows” and select the integration to see more details about it.
</li>
<li class="listitem">
Click “Add Windows”.
</li>
<li class="listitem">
Configure the integration name and optionally add a description.
</li>
<li class="listitem">
Review optional and advanced settings accordingly.
</li>
<li class="listitem">
Add the newly installed “windows” to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.
</li>
<li class="listitem">
Click “Save and Continue”.
</li>
<li class="listitem">
For more details on the integration refer to the <a href="https://docs.elastic.co/integrations/windows" class="ulink" target="_top">helper guide</a>.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Unsecured Credentials
</li>
<li class="listitem">
ID: T1552
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1552/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1552/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Cloud Instance Metadata API
</li>
<li class="listitem">
ID: T1552.005
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1552/005/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1552/005/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="unusual-windows-service.html">« Unusual Windows Service</a>
</span>
<span class="next">
<a href="unusual-windows-user-privilege-elevation-activity.html">Unusual Windows User Privilege Elevation Activity »</a>
</span>
</div>
</body>
</html>
