<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Active Directory Forced Authentication from Linux Host - SMB Named Pipes | Elastic Security Solution [8.17] | Elastic</title>
<meta class="elastic" name="content" content="Active Directory Forced Authentication from Linux Host - SMB Named Pipes | Elastic Security Solution [8.17]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.17]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="account-or-group-discovery-via-built-in-tools.html" title="Account or Group Discovery via Built-In Tools"/>
<link rel="next" href="active-directory-group-modification-by-system.html" title="Active Directory Group Modification by SYSTEM"/>
<meta class="elastic" name="product_version" content="8.17"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.17"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.17"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="account-or-group-discovery-via-built-in-tools.html">« Account or Group Discovery via Built-In Tools</a>
</span>
<span class="next">
<a href="active-directory-group-modification-by-system.html">Active Directory Group Modification by SYSTEM »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.17]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Active Directory Forced Authentication from Linux Host - SMB Named Pipes</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/rule-details/active-directory-forced-authentication-from-linux-host-smb-named-pipes.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs/reference/security/prebuilt-rules/rules/cross-platform/credential_access_forced_authentication_pipes">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="active-directory-forced-authentication-from-linux-host-smb-named-pipes"></a>Active Directory Forced Authentication from Linux Host - SMB Named Pipes</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/rule-details/active-directory-forced-authentication-from-linux-host-smb-named-pipes.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies a potential forced authentication using related SMB named pipes. Attackers may attempt to force targets to authenticate to a host controlled by them to capture hashes or enable relay attacks.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
logs-endpoint.events.network-*
</li>
<li class="listitem">
logs-system.security*
</li>
<li class="listitem">
winlogbeat-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.17/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://github.com/p0dalirius/windows-coerced-authentication-methods" class="ulink" target="_top">https://github.com/p0dalirius/windows-coerced-authentication-methods</a>
</li>
<li class="listitem">
<a href="https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications" class="ulink" target="_top">https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications</a>
</li>
<li class="listitem">
<a href="https://attack.mitre.org/techniques/T1187/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1187/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
OS: Linux
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Credential Access
</li>
<li class="listitem">
Data Source: Elastic Defend
</li>
<li class="listitem">
Data Source: Active Directory
</li>
<li class="listitem">
Use Case: Active Directory Monitoring
</li>
<li class="listitem">
Data Source: Windows Security Event Logs
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 7</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_121"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/rule-details/active-directory-forced-authentication-from-linux-host-smb-named-pipes.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Active Directory Forced Authentication from Linux Host - SMB Named Pipes</strong></span></p>
<p>Active Directory (AD) and SMB named pipes facilitate network resource access and inter-process communication. Adversaries exploit these by forcing authentication from a Linux host to capture credentials or perform relay attacks. The detection rule identifies suspicious SMB connection attempts from Linux to Windows hosts, focusing on specific named pipes indicative of forced authentication attempts, thus highlighting potential credential access threats.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the network logs to identify the Linux host IP address that attempted the SMB connection on port 445 and verify if this activity is expected or authorized.
</li>
<li class="listitem">
Check the Windows host logs for event code 5145 to determine which named pipes were accessed and assess if these accesses align with normal operations or indicate suspicious activity.
</li>
<li class="listitem">
Investigate the source IP address from the Windows logs to determine if it matches the Linux host IP and evaluate if this connection is part of a known and legitimate process.
</li>
<li class="listitem">
Analyze historical data for any previous similar connection attempts from the same Linux host to identify patterns or repeated unauthorized access attempts.
</li>
<li class="listitem">
Consult with system administrators to confirm if there have been any recent changes or updates in the network configuration that could explain the connection attempts.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Routine administrative tasks from Linux hosts may trigger alerts. Identify and document these tasks to create exceptions for known IP addresses or hostnames involved in regular operations.
</li>
<li class="listitem">
Automated backup or monitoring systems that connect to Windows hosts using SMB may cause false positives. Review and whitelist these systems by their IP addresses or specific named pipes they access.
</li>
<li class="listitem">
Development or testing environments where Linux hosts frequently interact with Windows systems can generate alerts. Establish a separate monitoring policy or exclude these environments from the rule to reduce noise.
</li>
<li class="listitem">
Security tools or scripts that perform network scans or audits might mimic suspicious behavior. Verify these tools and exclude their activities by specifying their source IPs or associated user accounts.
</li>
<li class="listitem">
Cross-platform file sharing services that use SMB for legitimate purposes may be flagged. Identify these services and adjust the rule to ignore their specific connection patterns or named pipes.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Isolate the affected Linux host from the network to prevent further unauthorized SMB connection attempts and potential credential capture.
</li>
<li class="listitem">
Conduct a thorough review of the Linux host&#8217;s network activity logs to identify any unauthorized access or data exfiltration attempts.
</li>
<li class="listitem">
Reset passwords for any accounts that may have been exposed or compromised during the forced authentication attempt to mitigate the risk of credential misuse.
</li>
<li class="listitem">
Implement network segmentation to limit SMB traffic between Linux and Windows hosts, reducing the attack surface for similar threats.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) for further investigation and to determine if additional hosts or systems are affected.
</li>
<li class="listitem">
Deploy enhanced monitoring on the identified named pipes and associated network traffic to detect and respond to future forced authentication attempts promptly.
</li>
<li class="listitem">
Review and update firewall rules to restrict unnecessary SMB traffic and ensure only authorized systems can communicate over port 445.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_68"></a>Setup</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/rule-details/active-directory-forced-authentication-from-linux-host-smb-named-pipes.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Setup</strong></span></p>
<p>This rule uses Elastic Endpoint network events from Linux hosts and system integration events from Domain controllers
for correlation. Both data sources should be collected from the hosts for this detection to work.</p>
<p>The <em>Audit Detailed File Share</em> audit policy must be configured (Success Failure).
Steps to implement the logging policy with Advanced Audit Configuration:</p>
<pre class="screen">Computer Configuration &gt;
Policies &gt;
Windows Settings &gt;
Security Settings &gt;
Advanced Audit Policies Configuration &gt;
Audit Policies &gt;
Object Access &gt;
Audit Detailed File Share (Success,Failure)</pre>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_127"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/rule-details/active-directory-forced-authentication-from-linux-host-smb-named-pipes.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">sequence with maxspan=15s
[network where host.os.type == "linux" and event.action == "connection_attempted" and destination.port == 445 and not startswith~(string(destination.ip), string(host.ip))] by host.ip, data_stream.namespace
[file where host.os.type == "windows" and event.code == "5145" and file.name : ("Spoolss", "netdfs", "lsarpc", "lsass", "netlogon", "samr", "efsrpc", "FssagentRpc")] by source.ip, data_stream.namespace</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Forced Authentication
</li>
<li class="listitem">
ID: T1187
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1187/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1187/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="account-or-group-discovery-via-built-in-tools.html">« Account or Group Discovery via Built-In Tools</a>
</span>
<span class="next">
<a href="active-directory-group-modification-by-system.html">Active Directory Group Modification by SYSTEM »</a>
</span>
</div>
</body>
</html>
