<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Process Creation via Secondary Logon | Elastic Security Solution [8.17] | Elastic</title>
<meta class="elastic" name="content" content="Process Creation via Secondary Logon | Elastic Security Solution [8.17]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.17]"/>
<link rel="up" href="prebuilt-rule-8-17-4-prebuilt-rules-8-17-4-appendix.html" title="Appendix W: Downloadable rule update v8.17.4"/>
<link rel="prev" href="prebuilt-rule-8-17-4-werfault-reflectdebugger-persistence.html" title="Werfault ReflectDebugger Persistence"/>
<link rel="next" href="prebuilt-rule-8-17-4-process-created-with-a-duplicated-token.html" title="Process Created with a Duplicated Token"/>
<meta class="elastic" name="product_version" content="8.17"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.17"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.17"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-17-4-werfault-reflectdebugger-persistence.html">« Werfault ReflectDebugger Persistence</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-17-4-process-created-with-a-duplicated-token.html">Process Created with a Duplicated Token »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.17]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-17-4-prebuilt-rules-8-17-4-appendix.html">Downloadable rule update v8.17.4</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Process Creation via Secondary Logon</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-process-creation-via-secondary-logon.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-17-4-process-creation-via-secondary-logon"></a>Process Creation via Secondary Logon</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-process-creation-via-secondary-logon.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies process creation with alternate credentials. Adversaries may create a new process with a different token to escalate privileges and bypass access controls.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
winlogbeat-*
</li>
<li class="listitem">
logs-system.*
</li>
<li class="listitem">
logs-windows.*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.17/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://attack.mitre.org/techniques/T1134/002/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1134/002/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Privilege Escalation
</li>
<li class="listitem">
Data Source: System
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 111</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4952"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-process-creation-via-secondary-logon.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Process Creation via Secondary Logon</strong></span></p>
<p>The Secondary Logon service in Windows allows users to run processes with different credentials, facilitating legitimate administrative tasks. However, adversaries can exploit this to escalate privileges by creating processes with alternate tokens, bypassing access controls. The detection rule identifies such abuse by monitoring successful logins via the Secondary Logon service and subsequent process creation, linking them through unique logon identifiers.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the event logs for the specific TargetLogonId to identify the user account associated with the process creation and verify if the account is authorized to use alternate credentials.
</li>
<li class="listitem">
Examine the source IP address "::1" to confirm if the process creation originated from the local machine, which might indicate a local privilege escalation attempt.
</li>
<li class="listitem">
Investigate the process name "svchost.exe" to determine if it is being used legitimately or if it has been exploited for malicious purposes, such as running unauthorized services.
</li>
<li class="listitem">
Check the sequence of events within the 1-minute maxspan to identify any unusual or suspicious activities that occurred immediately before or after the process creation.
</li>
<li class="listitem">
Correlate the detected activity with other security alerts or logs to identify any patterns or additional indicators of compromise that might suggest a broader attack campaign.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Legitimate administrative tasks using the Secondary Logon service can trigger alerts. To manage this, identify and whitelist specific administrative accounts or tasks that frequently use this service for legitimate purposes.
</li>
<li class="listitem">
Scheduled tasks or automated scripts that use alternate credentials for routine operations may cause false positives. Review and exclude these tasks by creating exceptions for known scripts or scheduled jobs.
</li>
<li class="listitem">
Internal IT support activities often involve using alternate credentials for troubleshooting or maintenance. Document and exclude these activities by maintaining a list of support personnel and their typical actions.
</li>
<li class="listitem">
Software updates or installations that require elevated privileges might be flagged. Monitor and exclude these processes by identifying and documenting the update mechanisms used within the organization.
</li>
<li class="listitem">
Development or testing environments where alternate credentials are used for testing purposes can generate alerts. Exclude these environments by setting up specific rules that recognize and ignore these non-production activities.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected system from the network to prevent further unauthorized access or lateral movement by the adversary.
</li>
<li class="listitem">
Terminate any suspicious processes identified as being created via the Secondary Logon service, especially those linked to the unique logon identifiers from the alert.
</li>
<li class="listitem">
Review and revoke any alternate credentials or tokens used in the suspicious process creation to prevent further misuse.
</li>
<li class="listitem">
Conduct a thorough examination of the affected system for additional signs of compromise, such as unauthorized user accounts or changes to system configurations.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) or incident response team for further investigation and to determine the full scope of the breach.
</li>
<li class="listitem">
Implement stricter access controls and monitoring on the Secondary Logon service to detect and prevent similar privilege escalation attempts in the future.
</li>
<li class="listitem">
Update and reinforce endpoint detection and response (EDR) solutions to enhance monitoring of process creation events and logon activities, ensuring they are aligned with the latest threat intelligence.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_1558"></a>Setup</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-process-creation-via-secondary-logon.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Setup</strong></span></p>
<p>Audit events 4624 and 4688 are needed to trigger this rule.</p>
<p>If enabling an EQL rule on a non-elastic-agent index (such as beats) for versions &lt;8.2,
events will not define <code class="literal">event.ingested</code> and default fallback for EQL rules was not added until version 8.2.
Hence for this rule to work effectively, users will need to add a custom ingest pipeline to populate
<code class="literal">event.ingested</code> to @timestamp.
For more details on adding a custom ingest pipeline refer - <a href="/guide/en/fleet/current/data-streams-pipeline-tutorial.html" class="ulink" target="_top">https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html</a></p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5907"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-process-creation-via-secondary-logon.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">sequence by winlog.computer_name with maxspan=1m

[authentication where event.action:"logged-in" and
 event.outcome == "success" and user.id : ("S-1-5-21-*", "S-1-12-1-*") and

 /* seclogon service */
 process.name == "svchost.exe" and
 winlog.event_data.LogonProcessName : "seclogo*" and source.ip == "::1" ] by winlog.event_data.TargetLogonId

[process where event.type == "start"] by winlog.event_data.TargetLogonId</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Privilege Escalation
</li>
<li class="listitem">
ID: TA0004
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0004/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0004/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Access Token Manipulation
</li>
<li class="listitem">
ID: T1134
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1134/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1134/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Create Process with Token
</li>
<li class="listitem">
ID: T1134.002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1134/002/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1134/002/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Make and Impersonate Token
</li>
<li class="listitem">
ID: T1134.003
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1134/003/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1134/003/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-17-4-werfault-reflectdebugger-persistence.html">« Werfault ReflectDebugger Persistence</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-17-4-process-created-with-a-duplicated-token.html">Process Created with a Duplicated Token »</a>
</span>
</div>
</body>
</html>
