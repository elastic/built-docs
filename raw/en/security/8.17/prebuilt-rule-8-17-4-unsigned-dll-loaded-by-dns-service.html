<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Unsigned DLL loaded by DNS Service | Elastic Security Solution [8.17] | Elastic</title>
<meta class="elastic" name="content" content="Unsigned DLL loaded by DNS Service | Elastic Security Solution [8.17]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.17]"/>
<link rel="up" href="prebuilt-rule-8-17-4-prebuilt-rules-8-17-4-appendix.html" title="Appendix W: Downloadable rule update v8.17.4"/>
<link rel="prev" href="prebuilt-rule-8-17-4-modification-of-the-mspkiaccountcredentials.html" title="Modification of the msPKIAccountCredentials"/>
<link rel="next" href="prebuilt-rule-8-17-4-first-time-seen-driver-loaded.html" title="First Time Seen Driver Loaded"/>
<meta class="elastic" name="product_version" content="8.17"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.17"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.17"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-17-4-modification-of-the-mspkiaccountcredentials.html">« Modification of the msPKIAccountCredentials</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-17-4-first-time-seen-driver-loaded.html">First Time Seen Driver Loaded »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.17]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-17-4-prebuilt-rules-8-17-4-appendix.html">Downloadable rule update v8.17.4</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Unsigned DLL loaded by DNS Service</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-unsigned-dll-loaded-by-dns-service.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-17-4-unsigned-dll-loaded-by-dns-service"></a>Unsigned DLL loaded by DNS Service</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-unsigned-dll-loaded-by-dns-service.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies unusual DLLs loaded by the DNS Server process, potentially indicating the abuse of the ServerLevelPluginDll functionality. This can lead to privilege escalation and remote code execution with SYSTEM privileges.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
logs-endpoint.events.library-*
</li>
<li class="listitem">
logs-windows.sysmon_operational-*
</li>
<li class="listitem">
winlogbeat-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.17/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://cube0x0.github.io/Pocing-Beyond-DA/" class="ulink" target="_top">https://cube0x0.github.io/Pocing-Beyond-DA/</a>
</li>
<li class="listitem">
<a href="https://adsecurity.org/?p=4064" class="ulink" target="_top">https://adsecurity.org/?p=4064</a>
</li>
<li class="listitem">
<a href="https://github.com/gtworek/PSBits/tree/master/ServerLevelPluginDll" class="ulink" target="_top">https://github.com/gtworek/PSBits/tree/master/ServerLevelPluginDll</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Privilege Escalation
</li>
<li class="listitem">
Data Source: Elastic Defend
</li>
<li class="listitem">
Data Source: Sysmon
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 104</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4963"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-unsigned-dll-loaded-by-dns-service.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Unsigned DLL loaded by DNS Service</strong></span></p>
<p>The DNS service in Windows environments is crucial for resolving domain names to IP addresses. It can be extended via DLLs, which, if unsigned, may indicate tampering. Adversaries exploit this by loading malicious DLLs to gain elevated privileges or execute code with SYSTEM rights. The detection rule identifies such threats by monitoring the DNS process for loading untrusted DLLs, flagging potential privilege escalation attempts.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the alert details to identify the specific DLL file that was loaded by the DNS service and check its file path and name for any known malicious indicators.
</li>
<li class="listitem">
Examine the file&#8217;s code signature status and metadata to determine why it is not trusted or valid, and cross-reference with known trusted sources or databases.
</li>
<li class="listitem">
Investigate the process tree of dns.exe to identify any parent or child processes that may indicate how the unsigned DLL was introduced or executed.
</li>
<li class="listitem">
Check the system&#8217;s event logs for any recent changes or anomalies around the time the DLL was loaded, focusing on events related to process creation, file modification, or user account activity.
</li>
<li class="listitem">
Analyze network traffic logs for any unusual DNS queries or outbound connections that could suggest communication with a command and control server.
</li>
<li class="listitem">
Assess the system for other signs of compromise, such as unauthorized user accounts, scheduled tasks, or registry changes that could indicate further exploitation or persistence mechanisms.
</li>
<li class="listitem">
If possible, isolate the affected system to prevent further potential malicious activity and begin remediation steps based on the findings.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Legitimate software updates or patches may introduce new DLLs that are unsigned. Verify the source of the update and, if trusted, create an exception for these DLLs to prevent future alerts.
</li>
<li class="listitem">
Custom or in-house applications might use unsigned DLLs for specific functionalities. Confirm the legitimacy of these applications and add them to an allowlist to avoid unnecessary alerts.
</li>
<li class="listitem">
Some third-party security or monitoring tools may load unsigned DLLs as part of their operation. Validate these tools with your security team and configure exceptions for known, safe DLLs.
</li>
<li class="listitem">
Development or testing environments often use unsigned DLLs during the software development lifecycle. Ensure these environments are properly segmented and consider excluding them from this rule to reduce noise.
</li>
<li class="listitem">
Legacy systems might rely on older, unsigned DLLs that are still in use. Conduct a risk assessment and, if deemed safe, exclude these DLLs from triggering alerts.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected system from the network to prevent further exploitation or lateral movement by the adversary.
</li>
<li class="listitem">
Terminate the DNS service process (dns.exe) to stop the execution of the malicious DLL and prevent further potential damage.
</li>
<li class="listitem">
Conduct a thorough scan of the system using updated antivirus and anti-malware tools to identify and remove any additional malicious files or software.
</li>
<li class="listitem">
Restore the DNS service to its original state by replacing the compromised DLL with a legitimate, signed version from a trusted source or backup.
</li>
<li class="listitem">
Review and update the system&#8217;s security patches and configurations to address any vulnerabilities that may have been exploited, particularly those related to privilege escalation.
</li>
<li class="listitem">
Monitor the system and network for any signs of continued or repeated unauthorized activity, focusing on similar indicators of compromise.
</li>
<li class="listitem">
Report the incident to the appropriate internal security team or external authorities if required, providing details of the threat and actions taken for further investigation and response.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5940"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-unsigned-dll-loaded-by-dns-service.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">any where host.os.type == "windows" and event.category : ("library", "process") and
  event.type : ("start", "change") and event.action : ("load", "Image loaded*") and
  process.executable : "?:\\windows\\system32\\dns.exe" and
  not ?dll.code_signature.trusted == true and
  not file.code_signature.status == "Valid"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Privilege Escalation
</li>
<li class="listitem">
ID: TA0004
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0004/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0004/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Exploitation for Privilege Escalation
</li>
<li class="listitem">
ID: T1068
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1068/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1068/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-17-4-modification-of-the-mspkiaccountcredentials.html">« Modification of the msPKIAccountCredentials</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-17-4-first-time-seen-driver-loaded.html">First Time Seen Driver Loaded »</a>
</span>
</div>
</body>
</html>
