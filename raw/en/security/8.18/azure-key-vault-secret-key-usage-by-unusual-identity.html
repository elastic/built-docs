<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Azure Key Vault Secret Key Usage by Unusual Identity | Elastic Security [8.18] | Elastic</title>
<meta class="elastic" name="content" content="Azure Key Vault Secret Key Usage by Unusual Identity | Elastic Security [8.18]">

<link rel="home" href="index.html" title="Elastic Security [8.18]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="azure-key-vault-modified.html" title="Azure Key Vault Modified"/>
<link rel="next" href="azure-kubernetes-events-deleted.html" title="Azure Kubernetes Events Deleted"/>
<meta class="elastic" name="product_version" content="8.18"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.18"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.18"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="azure-key-vault-modified.html">« Azure Key Vault Modified</a>
</span>
<span class="next">
<a href="azure-kubernetes-events-deleted.html">Azure Kubernetes Events Deleted »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.18]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Azure Key Vault Secret Key Usage by Unusual Identity</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/azure-key-vault-secret-key-usage-by-unusual-identity.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    A newer version is available. Check out the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="azure-key-vault-secret-key-usage-by-unusual-identity"></a>Azure Key Vault Secret Key Usage by Unusual Identity</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/azure-key-vault-secret-key-usage-by-unusual-identity.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies secrets, keys, or certificates retrieval operations from Azure Key Vault by a user principal that has not been seen previously doing so in a certain amount of days. Azure Key Vault is a cloud service for securely storing and accessing secrets, keys, and certificates. Unauthorized or excessive retrievals may indicate potential abuse or unauthorized access attempts.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-azure.platformlogs-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 43</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.18/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.inversecos.com/2022/05/detection-and-compromise-azure-key.html" class="ulink" target="_top">https://www.inversecos.com/2022/05/detection-and-compromise-azure-key.html</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Domain: Storage
</li>
<li class="listitem">
Domain: Identity
</li>
<li class="listitem">
Data Source: Azure
</li>
<li class="listitem">
Data Source: Azure Platform Logs
</li>
<li class="listitem">
Data Source: Azure Key Vault
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Use Case: Identity and Access Audit
</li>
<li class="listitem">
Tactic: Credential Access
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 2</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_203"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/azure-key-vault-secret-key-usage-by-unusual-identity.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating Azure Key Vault Secret Key Usage by Unusual Identity</strong></span></p>
<p>Azure Key Vault is a cloud service that safeguards encryption keys and secrets like certificates, connection strings, and passwords. It is crucial for managing sensitive data in Azure environments. Unauthorized modifications to Key Vaults can lead to data breaches or service disruptions. This rule detects excessive secret or key retrieval operations from Azure Key Vault, which may indicate potential abuse or unauthorized access attempts.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the <code class="literal">azure.platformlogs.identity.claim.upn</code> field to identify the user principal making the retrieval requests. This can help determine if the activity is legitimate or suspicious.
</li>
<li class="listitem">
Check the <code class="literal">azure.platformlogs.identity.claim.appid</code> or <code class="literal">azure.platformlogs.identity.claim.appid_display_name</code> to identify the application or service making the requests. If the application is not recognized or authorized, it may indicate a potential security incident. It is plausible that the application is a FOCI compliant application, which are commonly abused by adversaries to evade security controls or conditional access policies.
</li>
<li class="listitem">
Analyze the <code class="literal">azure.platformlogs.resource.name</code> field to determine which Key Vault is being accessed. This can help assess the impact of the retrieval operations and whether they target sensitive resources.
</li>
<li class="listitem">
Review the <code class="literal">event.action</code> field to confirm the specific actions being performed, such as <code class="literal">KeyGet</code>, <code class="literal">SecretGet</code>, or <code class="literal">CertificateGet</code>. These actions indicate retrieval of keys, secrets, or certificates from the Key Vault.
</li>
<li class="listitem">
Check the <code class="literal">source.ip</code> or <code class="literal">geo.*</code> fields to identify the source of the retrieval requests. Look for unusual or unexpected IP addresses, especially those associated with known malicious activity or geographic locations that do not align with the user&#8217;s typical behavior.
</li>
<li class="listitem">
Use the <code class="literal">time_window</code> field to analyze the frequency of retrieval operations. If multiple retrievals occur within a short time frame (e.g., within a few minutes), it may indicate excessive or suspicious activity.
</li>
<li class="listitem">
Correlate the retrieval operations with other security events or alerts in the environment to identify any patterns or related incidents.
</li>
<li class="listitem">
Triage the user with Entra ID sign-in logs to gather more context about their authentication behavior and any potential anomalies.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Routine administrative tasks or automated scripts may trigger excessive retrievals, especially in environments where Key Vaults are heavily utilized for application configurations or secrets management. If this is expected behavior, consider adjusting the rule or adding exceptions for specific applications or user principals.
</li>
<li class="listitem">
Legitimate applications or services may perform frequent retrievals of keys or secrets for operational purposes, such as configuration updates or secret rotation. If this is expected behavior, consider adjusting the rule or adding exceptions for specific applications or user principals.
</li>
<li class="listitem">
Security teams may perform periodic audits or assessments that involve retrieving keys or secrets from Key Vaults. If this is expected behavior, consider adjusting the rule or adding exceptions for specific user principals or applications.
</li>
<li class="listitem">
Some applications may require frequent access to keys or secrets for normal operation, leading to high retrieval counts. If this is expected behavior, consider adjusting the rule or adding exceptions for specific applications or user principals.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Investigate the user principal making the excessive retrieval requests to determine if they are authorized to access the Key Vault and its contents. If the user is not authorized, take appropriate actions to block their access and prevent further unauthorized retrievals.
</li>
<li class="listitem">
Review the application or service making the requests to ensure it is legitimate and authorized to access the Key Vault. If the application is unauthorized or suspicious, consider blocking it and revoking its permissions to access the Key Vault.
</li>
<li class="listitem">
Assess the impact of the excessive retrieval operations on the Key Vault and its contents. Determine if any sensitive data was accessed or compromised during the retrievals.
</li>
<li class="listitem">
Implement additional monitoring and alerting for the Key Vault to detect any further suspicious activity or unauthorized access attempts.
</li>
<li class="listitem">
Consider implementing stricter access controls or policies for Key Vaults to limit excessive retrievals and ensure that only authorized users and applications can access sensitive keys and secrets.
</li>
<li class="listitem">
Educate users and administrators about the risks associated with excessive retrievals from Key Vaults and encourage them to follow best practices for managing keys and secrets in Azure environments.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_130"></a>Setup</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/azure-key-vault-secret-key-usage-by-unusual-identity.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Required Azure Key Vault Diagnostic Logs</strong></span></p>
<p>To ensure this rule functions correctly, the following diagnostic logs must be enabled for Azure Key Vault:
- AuditEvent: This log captures all read and write operations performed on the Key Vault, including secret, key, and certificate retrievals. These logs should be streamed to the Event Hub used for the Azure integration configuration.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_208"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/azure-key-vault-secret-key-usage-by-unusual-identity.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset : "azure.platformlogs" and
event.outcome: "success" and
event.action : (
    "VaultGet" or
    "KeyGet" or
    "KeyList" or
    "KeyListVersions" or
    "KeyGetDeleted" or
    "KeyListDeleted" or
    "SecretGet" or
    "SecretList" or
    "SecretListVersions" or
    "SecretGetDeleted" or
    "SecretListDeleted" or
    "CertificateGet" or
    "CertificateList" or
    "CertificateListVersions" or
    "CertificateGetDeleted" or
    "CertificateListDeleted" or
    "CertificatePolicyGet" or
    "CertificateContactsGet" or
    "CertificateIssuerGet" or
    "CertificateIssuersList"
) and azure.platformlogs.identity.claim.upn: * and azure.platformlogs.properties.id: *</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credentials from Password Stores
</li>
<li class="listitem">
ID: T1555
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1555/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1555/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Cloud Secrets Management Stores
</li>
<li class="listitem">
ID: T1555.006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1555/006/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1555/006/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="azure-key-vault-modified.html">« Azure Key Vault Modified</a>
</span>
<span class="next">
<a href="azure-kubernetes-events-deleted.html">Azure Kubernetes Events Deleted »</a>
</span>
</div>
</body>
</html>
