<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Microsoft Entra ID SharePoint Access for User Principal via Auth Broker | Elastic Security [8.18] | Elastic</title>
<meta class="elastic" name="content" content="Microsoft Entra ID SharePoint Access for User Principal via Auth Broker | Elastic Security [8.18]">

<link rel="home" href="index.html" title="Elastic Security [8.18]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="microsoft-entra-id-service-principal-credentials-added-by-rare-user.html" title="Microsoft Entra ID Service Principal Credentials Added by Rare User"/>
<link rel="next" href="microsoft-entra-id-sign-in-brute-force-activity.html" title="Microsoft Entra ID Sign-In Brute Force Activity"/>
<meta class="elastic" name="product_version" content="8.18"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.18"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.18"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="microsoft-entra-id-service-principal-credentials-added-by-rare-user.html">« Microsoft Entra ID Service Principal Credentials Added by Rare User</a>
</span>
<span class="next">
<a href="microsoft-entra-id-sign-in-brute-force-activity.html">Microsoft Entra ID Sign-In Brute Force Activity »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.18]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Microsoft Entra ID SharePoint Access for User Principal via Auth Broker</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/microsoft-entra-id-sharepoint-access-for-user-principal-via-auth-broker.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    A newer version is available. Check out the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="microsoft-entra-id-sharepoint-access-for-user-principal-via-auth-broker"></a>Microsoft Entra ID SharePoint Access for User Principal via Auth Broker</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/microsoft-entra-id-sharepoint-access-for-user-principal-via-auth-broker.asciidoc">edit</a></div>
</div></div></div>
<p>This rule detects non-interactive authentication activity against SharePoint Online (<code class="literal">Office 365 SharePoint Online</code>) by a user principal via the <code class="literal">Microsoft Authentication Broker</code> application. The session leverages a refresh token or Primary Refresh Token (PRT) without interactive sign-in, often used in OAuth phishing or token replay scenarios.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
logs-azure.signinlogs-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: high</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 73</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.18/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.volexity.com/blog/2025/04/22/phishing-for-codes-russian-threat-actors-target-microsoft-365-oauth-workflows/" class="ulink" target="_top">https://www.volexity.com/blog/2025/04/22/phishing-for-codes-russian-threat-actors-target-microsoft-365-oauth-workflows/</a>
</li>
<li class="listitem">
<a href="https://github.com/dirkjanm/ROADtools" class="ulink" target="_top">https://github.com/dirkjanm/ROADtools</a>
</li>
<li class="listitem">
<a href="https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/" class="ulink" target="_top">https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Use Case: Identity and Access Audit
</li>
<li class="listitem">
Tactic: Collection
</li>
<li class="listitem">
Data Source: Azure
</li>
<li class="listitem">
Data Source: Microsoft Entra ID
</li>
<li class="listitem">
Data Source: Microsoft Entra ID Sign-in Logs
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 2</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_587"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/microsoft-entra-id-sharepoint-access-for-user-principal-via-auth-broker.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating Microsoft Entra ID SharePoint Access for User Principal via Auth Broker</strong></span></p>
<p>This rule identifies non-interactive sign-ins to SharePoint Online via the Microsoft Authentication Broker application using a refresh token or Primary Refresh Token (PRT). This type of activity may indicate token replay attacks, OAuth abuse, or automated access from previously consented apps or stolen sessions.</p>
<p>This is a <a href="/guide/en/security/current/rules-ui-create.html#create-new-terms-rule" class="ulink" target="_top">New Terms rule</a> that detects the first occurrence of a user principal name accessing SharePoint Online via the Microsoft Authentication Broker application in the last 14 days.</p>
<p><span class="strong strong"><strong>Possible Investigation Steps:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">azure.signinlogs.properties.user_principal_name</code>: Identify the user involved. Investigate whether this user typically accesses SharePoint or if this is an anomaly.
</li>
<li class="listitem">
<code class="literal">azure.signinlogs.properties.app_display_name</code>: Verify the application used (e.g., Authentication Broker). Determine if the app is expected for SharePoint access in your environment.
</li>
<li class="listitem">
<code class="literal">azure.signinlogs.properties.resource_display_name</code>: Review the resource being accessed. SharePoint activity should be aligned with job roles or historical usage.
</li>
<li class="listitem">
<code class="literal">azure.signinlogs.properties.incoming_token_type</code>: Indicates the token type used. Look for <code class="literal">refreshToken</code> or <code class="literal">primaryRefreshToken</code>, which may point to token replay or silent access.
</li>
<li class="listitem">
<code class="literal">azure.signinlogs.properties.is_interactive</code>: If false, indicates the sign-in was non-interactive. Correlate with recent sign-ins to understand if a prior session may have been reused.
</li>
<li class="listitem">
<code class="literal">user_agent.original</code>: Analyze the user agent string for automation indicators (e.g., scripts, unusual clients). Compare with what’s typical for the user or device.
</li>
<li class="listitem">
<code class="literal">source.ip</code>: Check the originating IP address. Investigate if the IP is associated with data centers, VPNs, anonymizers, or is geographically unusual for the user.
</li>
<li class="listitem">
<code class="literal">source.geo.*</code>: Evaluate sign-in location details. Determine if the sign-in location aligns with expected travel or usage behavior.
</li>
<li class="listitem">
<code class="literal">azure.signinlogs.properties.applied_conditional_access_policies</code>: Review whether Conditional Access policies were triggered or bypassed. Investigate if required controls (like MFA) were applied.
</li>
<li class="listitem">
<code class="literal">azure.signinlogs.properties.authentication_processing_details</code>: Review any details about the authentication, such as token type or scopes. This may indicate delegated access or automation patterns.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False Positive Analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Certain MDM or mobile app scenarios may use refresh tokens legitimately via brokered apps.
</li>
<li class="listitem">
Automated processes using authorized, scripted clients could trigger this activity, especially in developer or operations environments.
</li>
<li class="listitem">
If Conditional Access policies are configured in “report-only” mode or exempted for trusted apps, activity may appear unusual but be authorized.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and Remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If activity appears unauthorized:
</li>
<li class="listitem">
Investigate and revoke active sessions or refresh tokens.
</li>
<li class="listitem">
Notify the user and validate expected activity.
</li>
<li class="listitem">
Review and audit app consent permissions and remove unused or high-risk delegated access.
</li>
<li class="listitem">
Harden Conditional Access policies to limit non-interactive access to sensitive resources.
</li>
<li class="listitem">
Monitor for repeated use of the same user agent, IP, or token type across other users to identify broader campaigns.
</li>
<li class="listitem">
Consider alerting on unusual patterns in sign-in frequency, geography, and application usage for SharePoint and other key services.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_378"></a>Setup</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/microsoft-entra-id-sharepoint-access-for-user-principal-via-auth-broker.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Required Microsoft Entra ID Sign-In Logs</strong></span></p>
<p>To use this rule, ensure that Microsoft Entra ID Sign-In Logs are being collected and streamed into the Elastic Stack via the Azure integration.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_625"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/microsoft-entra-id-sharepoint-access-for-user-principal-via-auth-broker.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset: "azure.signinlogs"
    and azure.signinlogs.properties.app_id: "29d9ed98-a469-4536-ade2-f981bc1d605e"
    and azure.signinlogs.properties.resource_id: "00000003-0000-0ff1-ce00-000000000000"
    and azure.signinlogs.identity: *
    and azure.signinlogs.properties.user_principal_name: *
    and azure.signinlogs.properties.incoming_token_type: ("refreshToken" or "primaryRefreshToken")
    and azure.signinlogs.properties.is_interactive: false</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Collection
</li>
<li class="listitem">
ID: TA0009
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0009/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0009/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Data from Information Repositories
</li>
<li class="listitem">
ID: T1213
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1213/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1213/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Sharepoint
</li>
<li class="listitem">
ID: T1213.002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1213/002/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1213/002/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="microsoft-entra-id-service-principal-credentials-added-by-rare-user.html">« Microsoft Entra ID Service Principal Credentials Added by Rare User</a>
</span>
<span class="next">
<a href="microsoft-entra-id-sign-in-brute-force-activity.html">Microsoft Entra ID Sign-In Brute Force Activity »</a>
</span>
</div>
</body>
</html>
