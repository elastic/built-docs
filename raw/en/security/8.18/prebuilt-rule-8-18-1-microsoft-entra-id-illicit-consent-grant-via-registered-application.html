<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Microsoft Entra ID Illicit Consent Grant via Registered Application | Elastic Security [8.18] | Elastic</title>
<meta class="elastic" name="content" content="Microsoft Entra ID Illicit Consent Grant via Registered Application | Elastic Security [8.18]">

<link rel="home" href="index.html" title="Elastic Security [8.18]"/>
<link rel="up" href="prebuilt-rule-8-18-1-prebuilt-rules-8-18-1-appendix.html" title="Appendix T: Downloadable rule update v8.18.1"/>
<link rel="prev" href="prebuilt-rule-8-18-1-deprecated-azure-virtual-network-device-modified-or-deleted.html" title="Deprecated - Azure Virtual Network Device Modified or Deleted"/>
<link rel="next" href="prebuilt-rule-8-18-1-microsoft-entra-id-conditional-access-policy-cap-modified.html" title="Microsoft Entra ID Conditional Access Policy (CAP) Modified"/>
<meta class="elastic" name="product_version" content="8.18"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.18"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.18"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-18-1-deprecated-azure-virtual-network-device-modified-or-deleted.html">« Deprecated - Azure Virtual Network Device Modified or Deleted</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-1-microsoft-entra-id-conditional-access-policy-cap-modified.html">Microsoft Entra ID Conditional Access Policy (CAP) Modified »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.18]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-18-1-prebuilt-rules-8-18-1-appendix.html">Downloadable rule update v8.18.1</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Microsoft Entra ID Illicit Consent Grant via Registered Application</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-1/prebuilt-rule-8-18-1-microsoft-entra-id-illicit-consent-grant-via-registered-application.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    A newer version is available. Check out the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-18-1-microsoft-entra-id-illicit-consent-grant-via-registered-application"></a>Microsoft Entra ID Illicit Consent Grant via Registered Application</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-1/prebuilt-rule-8-18-1-microsoft-entra-id-illicit-consent-grant-via-registered-application.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies an illicit consent grant request on-behalf-of a registered Entra ID application. Adversaries may create and register an application in Microsoft Entra ID for the purpose of requesting user consent to access resources. This is accomplished by tricking a user into granting consent to the application, typically via a pre-made phishing URL. This establishes an OAuth grant that allows the malicious client applocation to access resources on-behalf-of the user.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-azure*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.18/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.wiz.io/blog/midnight-blizzard-microsoft-breach-analysis-and-best-practices" class="ulink" target="_top">https://www.wiz.io/blog/midnight-blizzard-microsoft-breach-analysis-and-best-practices</a>
</li>
<li class="listitem">
<a href="https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-illicit-consent-grants?view=o365-worldwide" class="ulink" target="_top">https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-illicit-consent-grants?view=o365-worldwide</a>
</li>
<li class="listitem">
<a href="https://www.cloud-architekt.net/detection-and-mitigation-consent-grant-attacks-azuread/" class="ulink" target="_top">https://www.cloud-architekt.net/detection-and-mitigation-consent-grant-attacks-azuread/</a>
</li>
<li class="listitem">
<a href="https://docs.microsoft.com/en-us/defender-cloud-apps/investigate-risky-oauth#how-to-detect-risky-oauth-apps" class="ulink" target="_top">https://docs.microsoft.com/en-us/defender-cloud-apps/investigate-risky-oauth#how-to-detect-risky-oauth-apps</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Data Source: Azure
</li>
<li class="listitem">
Data Source: Microsoft Entra ID
</li>
<li class="listitem">
Data Source: Microsoft Entra ID Audit Logs
</li>
<li class="listitem">
Use Case: Identity and Access Audit
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
<li class="listitem">
Tactic: Initial Access
</li>
<li class="listitem">
Tactic: Credential Access
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 216</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4066"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-1/prebuilt-rule-8-18-1-microsoft-entra-id-illicit-consent-grant-via-registered-application.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating Microsoft Entra ID Illicit Consent Grant via Registered Application</strong></span></p>
<p>Adversaries may register a malicious application in Microsoft Entra ID and trick users into granting excessive permissions via OAuth consent. These applications can access sensitive data—such as mail, profiles, or files—on behalf of the user once consent is granted. This is commonly delivered via spearphishing links that prompt users to approve permissions for seemingly legitimate applications.</p>
<p>This rule identifies a new consent grant event based on Azure audit logs where the application was granted access with potentially risky scopes, such as offline_access, Mail.Read, or User.Read, and may include admin consent or tenant-wide delegation.</p>
<p>This is a New Terms rule that will only trigger if the user and client ID have not been seen doing this activity in the last 14 days.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review <code class="literal">azure.auditlogs.properties.additional_details.value</code> to identify the AppId and User-Agent values to determine which application was granted access and how the request was initiated. Pivot on the AppId in the Azure portal under Enterprise Applications to investigate further.
</li>
<li class="listitem">
Review <code class="literal">azure.auditlogs.properties.initiated_by.user.userPrincipalName</code> to identify the user who approved the application. Investigate their recent activity for signs of phishing, account compromise, or anomalous behavior during the timeframe of the consent.
</li>
<li class="listitem">
Review <code class="literal">azure.auditlogs.properties.initiated_by.user.ipAddress</code> to assess the geographic source of the consent action. Unexpected locations or IP ranges may indicate adversary-controlled infrastructure.
</li>
<li class="listitem">
Review <code class="literal">azure.auditlogs.properties.target_resources.display_name</code> to evaluate whether the application name is familiar, expected, or potentially spoofing a known service.
</li>
<li class="listitem">
Review <code class="literal">azure.auditlogs.properties.target_resources.modified_properties.display_name</code> to inspect key indicators of elevated privilege or risk, including:
</li>
<li class="listitem">
ConsentContext.IsAdminConsent to determine if the application was granted tenant-wide admin access.
</li>
<li class="listitem">
ConsentContext.OnBehalfOfAll to identify whether the app was granted permissions on behalf of all users in the tenant.
</li>
<li class="listitem">
ConsentAction.Permissions to evaluate the specific scopes and data access the application requested.
</li>
<li class="listitem">
ConsentAction.Reason to understand if Microsoft flagged the activity or if any reason was recorded by the platform.
</li>
<li class="listitem">
TargetId.ServicePrincipalNames to confirm the service principal associated with the granted permissions.
</li>
<li class="listitem">
Review <code class="literal">azure.tenant_id</code> to confirm the activity originated from your tenant and is not related to a cross-tenant application.
</li>
<li class="listitem">
Review <code class="literal">@timestamp</code> and <code class="literal">azure.auditlogs.properties.correlation_id</code> to pivot into related sign-in, token usage, or application activity for further context.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Some applications may request high-privilege scopes for legitimate purposes. Validate whether the application is verified, developed by Microsoft, or approved internally by your organization.
</li>
<li class="listitem">
Review publisher verification, app ownership, and scope alignment with the intended business use case.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Revoke the application’s OAuth grant using Graph API or PowerShell. Use the Remove-AzureADOAuth2PermissionGrant cmdlet.
</li>
<li class="listitem">
Remove the associated service principal from Azure AD.
</li>
<li class="listitem">
Reset credentials or revoke tokens for affected users.
</li>
<li class="listitem">
Block the application via Conditional Access or Defender for Cloud Apps policies.
</li>
<li class="listitem">
Enable the Admin Consent Workflow in Azure AD to prevent unsanctioned user approvals in the future.
</li>
<li class="listitem">
Report any malicious applications to Microsoft to protect other tenants.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_4918"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-1/prebuilt-rule-8-18-1-microsoft-entra-id-illicit-consent-grant-via-registered-application.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset: "azure.auditlogs" and
  (
    azure.auditlogs.operation_name:"Consent to application"
    or event.action:"Consent to application"
  )
  and event.outcome: "success"
  and azure.auditlogs.properties.additional_details.key: "AppId"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Initial Access
</li>
<li class="listitem">
ID: TA0001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0001/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0001/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Phishing
</li>
<li class="listitem">
ID: T1566
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1566/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1566/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Spearphishing Link
</li>
<li class="listitem">
ID: T1566.002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1566/002/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1566/002/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Steal Application Access Token
</li>
<li class="listitem">
ID: T1528
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1528/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1528/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-18-1-deprecated-azure-virtual-network-device-modified-or-deleted.html">« Deprecated - Azure Virtual Network Device Modified or Deleted</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-1-microsoft-entra-id-conditional-access-policy-cap-modified.html">Microsoft Entra ID Conditional Access Policy (CAP) Modified »</a>
</span>
</div>
</body>
</html>
