<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PowerShell Obfuscation via Negative Index String Reversal | Elastic Security [8.18] | Elastic</title>
<meta class="elastic" name="content" content="PowerShell Obfuscation via Negative Index String Reversal | Elastic Security [8.18]">

<link rel="home" href="index.html" title="Elastic Security [8.18]"/>
<link rel="up" href="prebuilt-rule-8-18-11-prebuilt-rules-8-18-11-appendix.html" title="Appendix ^: Downloadable rule update v8.18.11"/>
<link rel="prev" href="prebuilt-rule-8-18-11-dynamic-iex-reconstruction-via-method-string-access.html" title="Dynamic IEX Reconstruction via Method String Access"/>
<link rel="next" href="prebuilt-rule-8-18-11-potential-powershell-obfuscation-via-reverse-keywords.html" title="Potential PowerShell Obfuscation via Reverse Keywords"/>
<meta class="elastic" name="product_version" content="8.18"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.18"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.18"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-18-11-dynamic-iex-reconstruction-via-method-string-access.html">Â« Dynamic IEX Reconstruction via Method String Access</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-11-potential-powershell-obfuscation-via-reverse-keywords.html">Potential PowerShell Obfuscation via Reverse Keywords Â»</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">â€º</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.18]</a></span>
<span class="chevron-right">â€º</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-18-11-prebuilt-rules-8-18-11-appendix.html">Downloadable rule update v8.18.11</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>PowerShell Obfuscation via Negative Index String Reversal</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-11/prebuilt-rule-8-18-11-powershell-obfuscation-via-negative-index-string-reversal.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    A newer version is available. Check out the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-18-11-powershell-obfuscation-via-negative-index-string-reversal"></a>PowerShell Obfuscation via Negative Index String Reversal</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-11/prebuilt-rule-8-18-11-powershell-obfuscation-via-negative-index-string-reversal.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies PowerShell scripts that use negative index ranges to reverse the contents of a string or array at runtime as a form of obfuscation. This technique avoids direct use of reversal functions by iterating through array elements in reverse order. These methods are designed to evade static analysis and bypass security protections such as the Antimalware Scan Interface (AMSI).</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: esql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>: None</p>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.18/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>: None</p>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Defense Evasion
</li>
<li class="listitem">
Data Source: PowerShell Logs
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 3</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4539"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-11/prebuilt-rule-8-18-11-powershell-obfuscation-via-negative-index-string-reversal.asciidoc">edit</a></div>
</div></div></div>
<pre class="literallayout">## Triage and analysis</pre>

<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating PowerShell Obfuscation via Negative Index String Reversal</strong></span></p>
<p>PowerShell, a powerful scripting language, can be exploited by adversaries using obfuscation techniques like negative index string reversal to evade detection. This method manipulates strings or arrays by iterating in reverse, bypassing static analysis tools. The detection rule identifies scripts with obfuscation patterns by analyzing script length and specific indexing patterns, flagging potential threats for further investigation.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the <code class="literal">powershell.file.script_block_text</code> to understand the script&#8217;s intent and identify any suspicious or malicious behavior.
</li>
<li class="listitem">
Check the <code class="literal">host.name</code> and <code class="literal">user.id</code> fields to determine the affected system and user, assessing if they are high-value targets or have a history of similar alerts.
</li>
<li class="listitem">
Analyze the <code class="literal">file.path</code> to identify the location of the script and assess if it is in a common or suspicious directory.
</li>
<li class="listitem">
Investigate the <code class="literal">powershell.file.script_block_id</code> and <code class="literal">powershell.sequence</code> to trace the execution flow and determine if this script is part of a larger, potentially malicious sequence.
</li>
<li class="listitem">
Correlate the <code class="literal">agent.id</code> with other logs to see if there are additional related activities or alerts from the same endpoint.
</li>
<li class="listitem">
Examine the <code class="literal">count</code> of detected patterns to assess the level of obfuscation and potential threat severity.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Scripts containing the keyword "GENESIS-5654" are known false positives and are automatically excluded from triggering alerts. Ensure that any legitimate scripts using this keyword are documented to prevent unnecessary investigations.
</li>
<li class="listitem">
Legitimate administrative scripts that use negative indexing for valid purposes may trigger false positives. Review these scripts and consider adding them to an exception list if they are frequently flagged but verified as non-malicious.
</li>
<li class="listitem">
Automated scripts generated by trusted software that use similar obfuscation patterns for performance or compatibility reasons can be excluded by identifying unique identifiers or patterns within these scripts and updating the exclusion criteria accordingly.
</li>
<li class="listitem">
Regularly update the exclusion list to include new patterns or identifiers from trusted sources as they are identified, ensuring that legitimate activities are not hindered by the detection rule.
</li>
<li class="listitem">
Collaborate with IT and security teams to maintain a list of known safe scripts and their characteristics, which can be referenced when analyzing potential false positives.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Isolate the affected host immediately to prevent further spread of potentially malicious scripts or unauthorized access.
</li>
<li class="listitem">
Terminate any suspicious PowerShell processes identified by the alert to halt ongoing obfuscation activities.
</li>
<li class="listitem">
Conduct a thorough review of the PowerShell script block text and related logs to identify any malicious payloads or commands executed.
</li>
<li class="listitem">
Remove any identified malicious scripts or files from the affected system to prevent re-execution.
</li>
<li class="listitem">
Reset credentials for any user accounts involved in the alert to mitigate potential unauthorized access.
</li>
<li class="listitem">
Escalate the incident to the security operations team for further analysis and to determine if additional systems are compromised.
</li>
<li class="listitem">
Update endpoint protection and monitoring tools to enhance detection capabilities for similar obfuscation techniques in the future.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_1211"></a>Setup</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-11/prebuilt-rule-8-18-11-powershell-obfuscation-via-negative-index-string-reversal.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Setup</strong></span></p>
<p>The <em>PowerShell Script Block Logging</em> logging policy must be enabled.
Steps to implement the logging policy with Advanced Audit Configuration:</p>
<pre class="screen">Computer Configuration &gt;
Administrative Templates &gt;
Windows PowerShell &gt;
Turn on PowerShell Script Block Logging (Enable)</pre>
<p>Steps to implement the logging policy via registry:</p>
<pre class="screen">reg add "hklm\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging" /v EnableScriptBlockLogging /t REG_DWORD /d 1</pre>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5424"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-11/prebuilt-rule-8-18-11-powershell-obfuscation-via-negative-index-string-reversal.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">from logs-windows.powershell_operational* metadata _id, _version, _index
| where event.code == "4104"

// Filter out smaller scripts that are unlikely to implement obfuscation using the patterns we are looking for
| eval Esql.script_block_length = length(powershell.file.script_block_text)
| where Esql.script_block_length &gt; 500

// replace the patterns we are looking for with the ðŸ”¥ emoji to enable counting them
// The emoji is used because it's unlikely to appear in scripts and has a consistent character length of 1
| eval Esql.script_block_tmp = replace(
    powershell.file.script_block_text,
    """\$\w+\[\-\s?1\.\.""",
    "ðŸ”¥"
)

// count how many patterns were detected by calculating the number of ðŸ”¥ characters inserted
| eval Esql.script_block_pattern_count = length(Esql.script_block_tmp) - length(replace(Esql.script_block_tmp, "ðŸ”¥", ""))

// keep the fields relevant to the query, although this is not needed as the alert is populated using _id
| keep
    Esql.script_block_pattern_count,
    Esql.script_block_length,
    Esql.script_block_tmp,
    powershell.file.script_block_text,
    powershell.file.script_block_id,
    file.path,
    powershell.sequence,
    powershell.total,
    _id,
    _index,
    host.name,
    agent.id,
    user.id

// Filter for scripts that match the pattern at least once
| where Esql.script_block_pattern_count &gt;= 1

// FP Patterns
| where not powershell.file.script_block_text like "*GENESIS-5654*"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Defense Evasion
</li>
<li class="listitem">
ID: TA0005
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0005/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0005/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Obfuscated Files or Information
</li>
<li class="listitem">
ID: T1027
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1027/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1027/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Deobfuscate/Decode Files or Information
</li>
<li class="listitem">
ID: T1140
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1140/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1140/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Execution
</li>
<li class="listitem">
ID: TA0002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0002/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0002/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Command and Scripting Interpreter
</li>
<li class="listitem">
ID: T1059
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1059/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1059/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: PowerShell
</li>
<li class="listitem">
ID: T1059.001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1059/001/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1059/001/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-18-11-dynamic-iex-reconstruction-via-method-string-access.html">Â« Dynamic IEX Reconstruction via Method String Access</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-11-potential-powershell-obfuscation-via-reverse-keywords.html">Potential PowerShell Obfuscation via Reverse Keywords Â»</a>
</span>
</div>
</body>
</html>
