<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dumping Account Hashes via Built-In Commands | Elastic Security [8.18] | Elastic</title>
<meta class="elastic" name="content" content="Dumping Account Hashes via Built-In Commands | Elastic Security [8.18]">

<link rel="home" href="index.html" title="Elastic Security [8.18]"/>
<link rel="up" href="prebuilt-rule-8-18-3-prebuilt-rules-8-18-3-appendix.html" title="Appendix V: Downloadable rule update v8.18.3"/>
<link rel="prev" href="prebuilt-rule-8-18-3-keychain-commandline-interaction-via-unsigned-or-untrusted-process.html" title="Keychain CommandLine Interaction via Unsigned or Untrusted Process"/>
<link rel="next" href="prebuilt-rule-8-18-3-dumping-of-keychain-content-via-security-command.html" title="Dumping of Keychain Content via Security Command"/>
<meta class="elastic" name="product_version" content="8.18"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.18"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.18"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-18-3-keychain-commandline-interaction-via-unsigned-or-untrusted-process.html">« Keychain CommandLine Interaction via Unsigned or Untrusted Process</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-3-dumping-of-keychain-content-via-security-command.html">Dumping of Keychain Content via Security Command »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.18]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-18-3-prebuilt-rules-8-18-3-appendix.html">Downloadable rule update v8.18.3</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Dumping Account Hashes via Built-In Commands</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-3/prebuilt-rule-8-18-3-dumping-account-hashes-via-built-in-commands.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    A newer version is available. Check out the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-18-3-dumping-account-hashes-via-built-in-commands"></a>Dumping Account Hashes via Built-In Commands</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-3/prebuilt-rule-8-18-3-dumping-account-hashes-via-built-in-commands.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies the execution of macOS built-in commands used to dump user account hashes. Adversaries may attempt to dump credentials to obtain account login information in the form of a hash. These hashes can be cracked or leveraged for lateral movement.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
logs-endpoint.events.*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: high</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 73</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.18/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://apple.stackexchange.com/questions/186893/os-x-10-9-where-are-password-hashes-stored" class="ulink" target="_top">https://apple.stackexchange.com/questions/186893/os-x-10-9-where-are-password-hashes-stored</a>
</li>
<li class="listitem">
<a href="https://www.unix.com/man-page/osx/8/mkpassdb/" class="ulink" target="_top">https://www.unix.com/man-page/osx/8/mkpassdb/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: macOS
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Credential Access
</li>
<li class="listitem">
Data Source: Elastic Defend
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 110</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4167"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-3/prebuilt-rule-8-18-3-dumping-account-hashes-via-built-in-commands.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Dumping Account Hashes via Built-In Commands</strong></span></p>
<p>In macOS environments, built-in commands like <code class="literal">defaults</code> and <code class="literal">mkpassdb</code> can be exploited by adversaries to extract user account hashes, which are crucial for credential access. These hashes, once obtained, can be cracked to reveal passwords or used for lateral movement within a network. The detection rule identifies suspicious process executions involving these commands and specific arguments, signaling potential credential dumping activities.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the process execution details to confirm the presence of the <code class="literal">defaults</code> or <code class="literal">mkpassdb</code> commands with arguments like <code class="literal">ShadowHashData</code> or <code class="literal">-dump</code>, as these are indicative of credential dumping attempts.
</li>
<li class="listitem">
Identify the user account associated with the process execution to determine if the activity aligns with expected behavior for that user or if it appears suspicious.
</li>
<li class="listitem">
Check the historical activity of the involved user account and the host to identify any patterns or anomalies that could suggest unauthorized access or lateral movement.
</li>
<li class="listitem">
Investigate any network connections or subsequent processes initiated by the suspicious process to assess potential data exfiltration or further malicious actions.
</li>
<li class="listitem">
Correlate the event with other security alerts or logs from the same host or user account to build a comprehensive timeline of the activity and assess the scope of the potential compromise.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
System administrators or security tools may legitimately use the <code class="literal">defaults</code> or <code class="literal">mkpassdb</code> commands for system maintenance or auditing purposes. To manage these, create exceptions for known administrative accounts or tools that regularly execute these commands.
</li>
<li class="listitem">
Automated scripts or management software might invoke these commands as part of routine operations. Identify and whitelist these scripts or software to prevent unnecessary alerts.
</li>
<li class="listitem">
Developers or IT personnel might use these commands during testing or development phases. Establish a process to temporarily exclude these activities by setting up time-bound exceptions for specific user accounts or devices.
</li>
<li class="listitem">
Security assessments or penetration tests could trigger this rule. Coordinate with security teams to schedule and document these activities, allowing for temporary rule adjustments during the testing period.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected macOS system from the network to prevent further lateral movement or data exfiltration.
</li>
<li class="listitem">
Terminate any suspicious processes identified as using the <code class="literal">defaults</code> or <code class="literal">mkpassdb</code> commands with the specified arguments to halt ongoing credential dumping activities.
</li>
<li class="listitem">
Conduct a thorough review of user accounts on the affected system to identify any unauthorized access or changes, focusing on accounts with elevated privileges.
</li>
<li class="listitem">
Reset passwords for all potentially compromised accounts, especially those with administrative access, and enforce strong password policies.
</li>
<li class="listitem">
Analyze system logs and network traffic to identify any additional systems that may have been accessed using the compromised credentials, and apply similar containment measures.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) or incident response team for further investigation and to determine the full scope of the breach.
</li>
<li class="listitem">
Implement enhanced monitoring and alerting for similar suspicious activities across the network to detect and respond to future attempts promptly.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_960"></a>Setup</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-3/prebuilt-rule-8-18-3-dumping-account-hashes-via-built-in-commands.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Setup</strong></span></p>
<p>This rule requires data coming in from Elastic Defend.</p>
<p><span class="strong strong"><strong>Elastic Defend Integration Setup</strong></span></p>
<p>Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.</p>
<p><span class="strong strong"><strong>Prerequisite Requirements:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fleet is required for Elastic Defend.
</li>
<li class="listitem">
To configure Fleet Server refer to the <a href="/guide/en/fleet/current/fleet-server.html" class="ulink" target="_top">documentation</a>.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>The following steps should be executed in order to add the Elastic Defend integration on a macOS System:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Go to the Kibana home page and click "Add integrations".
</li>
<li class="listitem">
In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
</li>
<li class="listitem">
Click "Add Elastic Defend".
</li>
<li class="listitem">
Configure the integration name and optionally add a description.
</li>
<li class="listitem">
Select the type of environment you want to protect, for MacOS it is recommended to select "Traditional Endpoints".
</li>
<li class="listitem">
Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. <a href="/guide/en/security/current/configure-endpoint-integration-policy.html" class="ulink" target="_top">Helper guide</a>.
</li>
<li class="listitem">
We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
</li>
<li class="listitem">
Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the <a href="/guide/en/fleet/current/agent-policy.html" class="ulink" target="_top">helper guide</a>.
</li>
<li class="listitem">
Click "Save and Continue".
</li>
<li class="listitem">
To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the <a href="/guide/en/security/current/install-endpoint.html" class="ulink" target="_top">helper guide</a>.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5019"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-3/prebuilt-rule-8-18-3-dumping-account-hashes-via-built-in-commands.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">process where host.os.type == "macos" and event.type in ("start", "process_started") and
 process.name in ("defaults", "mkpassdb") and process.args like~ ("ShadowHashData", "-dump")</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: OS Credential Dumping
</li>
<li class="listitem">
ID: T1003
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1003/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1003/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-18-3-keychain-commandline-interaction-via-unsigned-or-untrusted-process.html">« Keychain CommandLine Interaction via Unsigned or Untrusted Process</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-3-dumping-of-keychain-content-via-security-command.html">Dumping of Keychain Content via Security Command »</a>
</span>
</div>
</body>
</html>
