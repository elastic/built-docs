<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Modification of Environment Variable via Unsigned or Untrusted Parent | Elastic Security Solution [8.18] | Elastic</title>
<meta class="elastic" name="content" content="Modification of Environment Variable via Unsigned or Untrusted Parent | Elastic Security Solution [8.18]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.18]"/>
<link rel="up" href="prebuilt-rule-8-18-3-prebuilt-rules-8-18-3-appendix.html" title="Appendix V: Downloadable rule update v8.18.3"/>
<link rel="prev" href="prebuilt-rule-8-18-3-attempt-to-install-root-certificate.html" title="Attempt to Install Root Certificate"/>
<link rel="next" href="prebuilt-rule-8-18-3-potential-privacy-control-bypass-via-tccdb-modification.html" title="Potential Privacy Control Bypass via TCCDB Modification"/>
<meta class="elastic" name="product_version" content="8.18"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.18"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.18"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-18-3-attempt-to-install-root-certificate.html">« Attempt to Install Root Certificate</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-3-potential-privacy-control-bypass-via-tccdb-modification.html">Potential Privacy Control Bypass via TCCDB Modification »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.18]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-18-3-prebuilt-rules-8-18-3-appendix.html">Downloadable rule update v8.18.3</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Modification of Environment Variable via Unsigned or Untrusted Parent</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-3/prebuilt-rule-8-18-3-modification-of-environment-variable-via-unsigned-or-untrusted-parent.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    A newer version is available. Check out the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-18-3-modification-of-environment-variable-via-unsigned-or-untrusted-parent"></a>Modification of Environment Variable via Unsigned or Untrusted Parent</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-3/prebuilt-rule-8-18-3-modification-of-environment-variable-via-unsigned-or-untrusted-parent.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies modifications to an environment variable using the built-in launchctl command. Adversaries may execute their own malicious payloads by hijacking certain environment variables to load arbitrary libraries or bypass certain restrictions.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
logs-endpoint.events.*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.18/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://github.com/rapid7/metasploit-framework/blob/master//modules/post/osx/escalate/tccbypass.rb" class="ulink" target="_top">https://github.com/rapid7/metasploit-framework/blob/master//modules/post/osx/escalate/tccbypass.rb</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: macOS
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Defense Evasion
</li>
<li class="listitem">
Data Source: Elastic Defend
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 210</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4117"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-3/prebuilt-rule-8-18-3-modification-of-environment-variable-via-unsigned-or-untrusted-parent.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Modification of Environment Variable via Unsigned or Untrusted Parent</strong></span></p>
<p>Environment variables in macOS are crucial for configuring system and application behavior. Adversaries may exploit these by using the <code class="literal">launchctl</code> command to alter variables, enabling malicious payload execution or bypassing restrictions. The detection rule identifies suspicious modifications initiated by untrusted or unsigned parent processes, focusing on atypical environment variables and excluding known safe executables, thus highlighting potential threats.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the process tree to identify the parent process of the <code class="literal">launchctl</code> command, focusing on whether the parent process is unsigned or untrusted, as indicated by the absence or lack of trust in the <code class="literal">process.parent.code_signature</code>.
</li>
<li class="listitem">
Examine the command-line arguments used with <code class="literal">launchctl</code>, specifically looking for the <code class="literal">setenv</code> command and any unusual or suspicious environment variables that are not part of the known safe list (e.g., ANT_HOME, DBUS_LAUNCHD_SESSION_BUS_SOCKET).
</li>
<li class="listitem">
Check the execution path of the parent process to determine if it matches any known safe executables, such as those listed in the exclusion criteria (e.g., /Applications/IntelliJ IDEA CE.app/Contents/jbr/Contents/Home/lib/jspawnhelper).
</li>
<li class="listitem">
Investigate the user account under which the <code class="literal">launchctl</code> command was executed to determine if it aligns with expected behavior or if it might indicate a compromised account.
</li>
<li class="listitem">
Correlate this event with other security alerts or logs from the same host to identify any patterns or additional indicators of compromise that might suggest a broader attack or intrusion attempt.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Development tools like IntelliJ IDEA may trigger false positives when using the jspawnhelper executable. To mitigate this, add the executable path to the exclusion list if it is a known and trusted application in your environment.
</li>
<li class="listitem">
NoMachine software can cause false positives due to its use of nxserver.bin. If this software is regularly used and trusted, consider excluding its executable path from the detection rule.
</li>
<li class="listitem">
The kr tool located at /usr/local/bin/kr might be flagged as a false positive. If this tool is part of your standard operations, ensure its path is excluded to prevent unnecessary alerts.
</li>
<li class="listitem">
Review any other unsigned or untrusted parent processes that are part of legitimate software installations or operations. If they are verified as safe, add them to the exclusion list to reduce false positives.
</li>
<li class="listitem">
Regularly update the list of known safe executables and environment variables to reflect changes in your software inventory, ensuring that legitimate processes are not mistakenly flagged.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected macOS system from the network to prevent potential lateral movement or further exploitation.
</li>
<li class="listitem">
Terminate any suspicious processes associated with the untrusted or unsigned parent process that initiated the <code class="literal">launchctl</code> command to halt any ongoing malicious activity.
</li>
<li class="listitem">
Conduct a thorough review of the environment variables modified by the <code class="literal">launchctl</code> command to identify any unauthorized changes and revert them to their original state.
</li>
<li class="listitem">
Analyze the parent process that triggered the alert to determine its origin and purpose, and remove any malicious or unauthorized software identified during this analysis.
</li>
<li class="listitem">
Restore the system from a known good backup if any critical system components or configurations have been compromised.
</li>
<li class="listitem">
Implement additional monitoring and logging for <code class="literal">launchctl</code> usage and environment variable modifications to detect similar threats in the future.
</li>
<li class="listitem">
Escalate the incident to the security operations team for further investigation and to assess the need for broader organizational response measures.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_960"></a>Setup</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-3/prebuilt-rule-8-18-3-modification-of-environment-variable-via-unsigned-or-untrusted-parent.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Setup</strong></span></p>
<p>This rule requires data coming in from Elastic Defend.</p>
<p><span class="strong strong"><strong>Elastic Defend Integration Setup</strong></span></p>
<p>Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.</p>
<p><span class="strong strong"><strong>Prerequisite Requirements:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fleet is required for Elastic Defend.
</li>
<li class="listitem">
To configure Fleet Server refer to the <a href="/guide/en/fleet/current/fleet-server.html" class="ulink" target="_top">documentation</a>.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>The following steps should be executed in order to add the Elastic Defend integration on a macOS System:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Go to the Kibana home page and click "Add integrations".
</li>
<li class="listitem">
In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
</li>
<li class="listitem">
Click "Add Elastic Defend".
</li>
<li class="listitem">
Configure the integration name and optionally add a description.
</li>
<li class="listitem">
Select the type of environment you want to protect, for MacOS it is recommended to select "Traditional Endpoints".
</li>
<li class="listitem">
Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. <a href="/guide/en/security/current/configure-endpoint-integration-policy.html" class="ulink" target="_top">Helper guide</a>.
</li>
<li class="listitem">
We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
</li>
<li class="listitem">
Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the <a href="/guide/en/fleet/current/agent-policy.html" class="ulink" target="_top">helper guide</a>.
</li>
<li class="listitem">
Click "Save and Continue".
</li>
<li class="listitem">
To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the <a href="/guide/en/security/current/install-endpoint.html" class="ulink" target="_top">helper guide</a>.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5001"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-3/prebuilt-rule-8-18-3-modification-of-environment-variable-via-unsigned-or-untrusted-parent.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">process where host.os.type == "macos" and event.type in ("start", "process_started") and
  process.name == "launchctl" and
  (process.parent.code_signature.exists == false or process.parent.code_signature.trusted == false) and
  process.args == "setenv"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Defense Evasion
</li>
<li class="listitem">
ID: TA0005
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0005/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0005/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Hijack Execution Flow
</li>
<li class="listitem">
ID: T1574
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1574/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1574/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Path Interception by PATH Environment Variable
</li>
<li class="listitem">
ID: T1574.007
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1574/007/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1574/007/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-18-3-attempt-to-install-root-certificate.html">« Attempt to Install Root Certificate</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-3-potential-privacy-control-bypass-via-tccdb-modification.html">Potential Privacy Control Bypass via TCCDB Modification »</a>
</span>
</div>
</body>
</html>
