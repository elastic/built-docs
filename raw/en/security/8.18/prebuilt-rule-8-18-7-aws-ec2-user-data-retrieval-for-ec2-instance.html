<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AWS EC2 User Data Retrieval for EC2 Instance | Elastic Security [8.18] | Elastic</title>
<meta class="elastic" name="content" content="AWS EC2 User Data Retrieval for EC2 Instance | Elastic Security [8.18]">

<link rel="home" href="index.html" title="Elastic Security [8.18]"/>
<link rel="up" href="prebuilt-rule-8-18-7-prebuilt-rules-8-18-7-appendix.html" title="Appendix Z: Downloadable rule update v8.18.7"/>
<link rel="prev" href="prebuilt-rule-8-18-7-aws-ec2-deprecated-ami-discovery.html" title="AWS EC2 Deprecated AMI Discovery"/>
<link rel="next" href="prebuilt-rule-8-18-7-aws-ec2-ebs-snapshot-shared-or-made-public.html" title="AWS EC2 EBS Snapshot Shared or Made Public"/>
<meta class="elastic" name="product_version" content="8.18"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.18"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.18"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-18-7-aws-ec2-deprecated-ami-discovery.html">« AWS EC2 Deprecated AMI Discovery</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-7-aws-ec2-ebs-snapshot-shared-or-made-public.html">AWS EC2 EBS Snapshot Shared or Made Public »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.18]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-18-7-prebuilt-rules-8-18-7-appendix.html">Downloadable rule update v8.18.7</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>AWS EC2 User Data Retrieval for EC2 Instance</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-7/prebuilt-rule-8-18-7-aws-ec2-user-data-retrieval-for-ec2-instance.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    A newer version is available. Check out the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-18-7-aws-ec2-user-data-retrieval-for-ec2-instance"></a>AWS EC2 User Data Retrieval for EC2 Instance</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-7/prebuilt-rule-8-18-7-aws-ec2-user-data-retrieval-for-ec2-instance.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies discovery request DescribeInstanceAttribute with the attribute userData and instanceId in AWS CloudTrail logs. This may indicate an attempt to retrieve user data from an EC2 instance. Adversaries may use this information to gather sensitive data from the instance such as hardcoded credentials or to identify potential vulnerabilities. This is a New Terms rule that identifies the first time an IAM user or role requests the user data for a specific EC2 instance.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-aws.cloudtrail-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-6m (<a href="/guide/en/elasticsearch/reference/8.18/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeInstanceAttribute.html" class="ulink" target="_top">https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeInstanceAttribute.html</a>
</li>
<li class="listitem">
<a href="https://hackingthe.cloud/aws/exploitation/local_ec2_priv_esc_through_user_data" class="ulink" target="_top">https://hackingthe.cloud/aws/exploitation/local_ec2_priv_esc_through_user_data</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Data Source: AWS
</li>
<li class="listitem">
Data Source: Amazon Web Services
</li>
<li class="listitem">
Data Source: Amazon EC2
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
<li class="listitem">
Use Case: Log Auditing
</li>
<li class="listitem">
Tactic: Discovery
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 6</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4336"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-7/prebuilt-rule-8-18-7-aws-ec2-user-data-retrieval-for-ec2-instance.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and Analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating AWS EC2 User Data Retrieval for EC2 Instance</strong></span></p>
<p>This rule detects requests to retrieve the <code class="literal">userData</code> attribute of an EC2 instance using the <code class="literal">DescribeInstanceAttribute</code> API action. The <code class="literal">userData</code> field can contain sensitive information, such as hardcoded credentials or configuration scripts, that adversaries may exploit for further attacks.</p>
<p><span class="strong strong"><strong>Possible Investigation Steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Identify the Target Instance</strong></span>:
</li>
<li class="listitem">
<span class="strong strong"><strong>Instance ID</strong></span>: Review the <code class="literal">aws.cloudtrail.flattened.request_parameters.instanceId</code> field to identify the EC2 instance targeted by the request. Confirm whether this instance should expose its <code class="literal">userData</code> and whether it is associated with sensitive workloads.
</li>
<li class="listitem">
<span class="strong strong"><strong>Analyze userData</strong></span>: If possible, retrieve and inspect the <code class="literal">userData</code> field to identify sensitive information like hardcoded credentials or configuration scripts.
</li>
<li class="listitem">
<span class="strong strong"><strong>Review User Context</strong></span>:
</li>
<li class="listitem">
<span class="strong strong"><strong>User Identity</strong></span>: Inspect the <code class="literal">aws.cloudtrail.user_identity.arn</code> field to identify the user or role that executed the <code class="literal">DescribeInstanceAttribute</code> action. Investigate whether this user typically performs such actions.
</li>
<li class="listitem">
<span class="strong strong"><strong>Access Patterns</strong></span>: Validate whether the user or role has the necessary permissions and whether the frequency of this action aligns with expected behavior.
</li>
<li class="listitem">
<span class="strong strong"><strong>Access Key ID</strong></span>: Check the <code class="literal">aws.cloudtrail.user_identity.access_key_id</code> field to determine the key used to make the request as it may be compromised.
</li>
<li class="listitem">
<span class="strong strong"><strong>Source IP and Geolocation</strong></span>: Check the <code class="literal">source.address</code> and <code class="literal">source.geo</code> fields to validate whether the request originated from a trusted location or network. Unexpected geolocations can indicate adversarial activity.
</li>
<li class="listitem">
<span class="strong strong"><strong>User Agent</strong></span>: Inspect the <code class="literal">user_agent.original</code> field to determine the tool or client used (e.g., Terraform, AWS CLI). Legitimate automation tools may trigger this activity, but custom or unknown user agents may indicate malicious intent.
</li>
<li class="listitem">
<span class="strong strong"><strong>Check for Related Activity</strong></span>:
</li>
<li class="listitem">
<span class="strong strong"><strong>IAM Changes</strong></span>: Correlate this event with any IAM changes or temporary credential creation to identify potential privilege escalation attempts.
</li>
<li class="listitem">
<span class="strong strong"><strong>API Usage</strong></span>: Look for other unusual API calls (e.g., <code class="literal">RunInstances</code>, <code class="literal">GetObject</code>, <code class="literal">AssumeRole</code>) by the same user or IP to detect lateral movement or data exfiltration attempts.
</li>
<li class="listitem">
<span class="strong strong"><strong>Validate Intent</strong></span>:
</li>
<li class="listitem">
<span class="strong strong"><strong>Permissions and Justification</strong></span>: Ensure that the user has the least privilege required to perform this action. Investigate whether there is a valid reason for accessing the <code class="literal">userData</code> field.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False Positive Analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Automation</strong></span>: This event is often triggered by legitimate automation tools, such as Terraform or custom scripts, that require access to <code class="literal">userData</code> during instance initialization.
</li>
<li class="listitem">
<span class="strong strong"><strong>Maintenance Activity</strong></span>: Verify whether this event aligns with expected administrative activities, such as debugging or instance configuration updates.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and Remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Revoke Excessive Permissions</strong></span>: If unauthorized, immediately remove <code class="literal">DescribeInstanceAttribute</code> permissions from the user or role.
</li>
<li class="listitem">
<span class="strong strong"><strong>Quarantine the Target Instance</strong></span>: If malicious behavior is confirmed, isolate the affected EC2 instance to limit further exposure.
</li>
<li class="listitem">
<span class="strong strong"><strong>Secure User Data</strong></span>:
</li>
<li class="listitem">
Avoid storing sensitive information, such as credentials, in <code class="literal">userData</code>. Use AWS Secrets Manager or Parameter Store instead.
</li>
<li class="listitem">
Encrypt user data and ensure only authorized users can decrypt it.
</li>
<li class="listitem">
<span class="strong strong"><strong>Audit IAM Policies</strong></span>: Regularly review IAM policies to ensure they adhere to the principle of least privilege.
</li>
<li class="listitem">
<span class="strong strong"><strong>Monitor and Detect</strong></span>: Set up additional alerts for unexpected <code class="literal">DescribeInstanceAttribute</code> calls or other suspicious API activity.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Additional Information</strong></span></p>
<p>For more details on managing EC2 user data securely, refer to the <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html" class="ulink" target="_top">AWS EC2 User Data Documentation</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5222"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-7/prebuilt-rule-8-18-7-aws-ec2-user-data-retrieval-for-ec2-instance.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset: "aws.cloudtrail"
    and event.provider: "ec2.amazonaws.com"
    and event.action: "DescribeInstanceAttribute"
    and event.outcome: "success"
    and aws.cloudtrail.flattened.request_parameters.attribute: "userData"
    and not aws.cloudtrail.user_identity.invoked_by: (
        "AWS Internal" or
        "cloudformation.amazonaws.com"
    )</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Discovery
</li>
<li class="listitem">
ID: TA0007
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0007/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0007/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Cloud Infrastructure Discovery
</li>
<li class="listitem">
ID: T1580
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1580/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1580/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Unsecured Credentials
</li>
<li class="listitem">
ID: T1552
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1552/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1552/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Cloud Instance Metadata API
</li>
<li class="listitem">
ID: T1552.005
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1552/005/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1552/005/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-18-7-aws-ec2-deprecated-ami-discovery.html">« AWS EC2 Deprecated AMI Discovery</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-7-aws-ec2-ebs-snapshot-shared-or-made-public.html">AWS EC2 EBS Snapshot Shared or Made Public »</a>
</span>
</div>
</body>
</html>
