<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Entra ID RT to PRT Transition from Same User and Device | Elastic Security [8.18] | Elastic</title>
<meta class="elastic" name="content" content="Entra ID RT to PRT Transition from Same User and Device | Elastic Security [8.18]">

<link rel="home" href="index.html" title="Elastic Security [8.18]"/>
<link rel="up" href="prebuilt-rule-8-18-8-prebuilt-rules-8-18-8-appendix.html" title="Appendix [: Downloadable rule update v8.18.8"/>
<link rel="prev" href="prebuilt-rule-8-18-8-unusual-ropc-login-attempt-by-user-principal.html" title="Unusual ROPC Login Attempt by User Principal"/>
<link rel="next" href="prebuilt-rule-8-18-8-suspicious-adrs-token-request-by-microsoft-auth-broker.html" title="Suspicious ADRS Token Request by Microsoft Auth Broker"/>
<meta class="elastic" name="product_version" content="8.18"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.18"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.18"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-18-8-unusual-ropc-login-attempt-by-user-principal.html">« Unusual ROPC Login Attempt by User Principal</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-8-suspicious-adrs-token-request-by-microsoft-auth-broker.html">Suspicious ADRS Token Request by Microsoft Auth Broker »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.18]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-18-8-prebuilt-rules-8-18-8-appendix.html">Downloadable rule update v8.18.8</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Entra ID RT to PRT Transition from Same User and Device</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-8/prebuilt-rule-8-18-8-entra-id-rt-to-prt-transition-from-same-user-and-device.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    A newer version is available. Check out the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-18-8-entra-id-rt-to-prt-transition-from-same-user-and-device"></a>Entra ID RT to PRT Transition from Same User and Device</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-8/prebuilt-rule-8-18-8-entra-id-rt-to-prt-transition-from-same-user-and-device.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies when a user signs in with a refresh token using the Microsoft Authentication Broker (MAB) client, followed by a Primary Refresh Token (PRT) sign-in from the same device within 1 hour. This pattern may indicate that an attacker has successfully registered a device using ROADtx and transitioned from short-term token access to long-term persistent access via PRTs. Excluding access to the Device Registration Service (DRS) ensures the PRT is being used beyond registration, often to access Microsoft 365 resources like Outlook or SharePoint.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-azure.signinlogs-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 30m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-60m (<a href="/guide/en/elasticsearch/reference/8.18/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.volexity.com/blog/2025/04/22/phishing-for-codes-russian-threat-actors-target-microsoft-365-oauth-workflows/" class="ulink" target="_top">https://www.volexity.com/blog/2025/04/22/phishing-for-codes-russian-threat-actors-target-microsoft-365-oauth-workflows/</a>
</li>
<li class="listitem">
<a href="https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/" class="ulink" target="_top">https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Domain: Identity
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Data Source: Azure
</li>
<li class="listitem">
Data Source: Microsoft Entra ID
</li>
<li class="listitem">
Data Source: Microsoft Entra ID Sign-In Logs
</li>
<li class="listitem">
Tactic: Persistence
</li>
<li class="listitem">
Tactic: Initial Access
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 1</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4326"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-8/prebuilt-rule-8-18-8-entra-id-rt-to-prt-transition-from-same-user-and-device.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating Entra ID RT to PRT Transition from Same User and Device</strong></span></p>
<p>This rule identifies a sequence where a Microsoft Entra ID user signs in using a refresh token issued to the Microsoft Authentication Broker (MAB), followed by a sign-in using a Primary Refresh Token (PRT) from the same device. This behavior is uncommon for normal user activity and strongly suggests adversarial behavior, particularly when paired with OAuth phishing and device registration tools like ROADtx. The use of PRT shortly after a refresh token sign-in typically indicates the attacker has obtained device trust and is now using the PRT to impersonate a fully compliant user+device pair.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Identify the user principal and device from <code class="literal">azure.signinlogs.properties.user_principal_name</code> and <code class="literal">azure.signinlogs.properties.device_detail.device_id</code>.
</li>
<li class="listitem">
Confirm the first sign-in event came from the Microsoft Auth Broker (<code class="literal">app_id</code>) with <code class="literal">incoming_token_type: refreshToken</code>.
</li>
<li class="listitem">
Ensure the device has a <code class="literal">trust_type</code> of "Azure AD joined" and that the <code class="literal">sign_in_session_status</code> is "unbound".
</li>
<li class="listitem">
Confirm the second sign-in used <code class="literal">incoming_token_type: primaryRefreshToken</code> and that the <code class="literal">resource_display_name</code> is not "Device Registration Service".
</li>
<li class="listitem">
Investigate any Microsoft Graph, Outlook, or SharePoint access occurring shortly after.
</li>
<li class="listitem">
Review conditional access policy outcomes and determine whether MFA or device compliance was bypassed.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Legitimate device onboarding and sign-ins using hybrid-joined endpoints may trigger this rule.
</li>
<li class="listitem">
Rapid device provisioning in enterprise environments using MAB could generate similar token behavior.
</li>
<li class="listitem">
Use supporting signals, such as IP address changes, geolocation, or user agent anomalies, to reduce noise.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Investigate other sign-in patterns and assess whether token abuse has occurred.
</li>
<li class="listitem">
Revoke PRT sessions via Microsoft Entra ID or Conditional Access.
</li>
<li class="listitem">
Remove or quarantine the suspicious device registration.
</li>
<li class="listitem">
Require password reset and enforce MFA.
</li>
<li class="listitem">
Audit and tighten device trust and conditional access configurations.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5215"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-8/prebuilt-rule-8-18-8-entra-id-rt-to-prt-transition-from-same-user-and-device.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">sequence by azure.signinlogs.properties.user_id, azure.signinlogs.properties.device_detail.device_id with maxspan=1h
  [authentication where
    event.dataset == "azure.signinlogs" and
    azure.signinlogs.category == "NonInteractiveUserSignInLogs" and
    azure.signinlogs.properties.app_id == "29d9ed98-a469-4536-ade2-f981bc1d605e" and
    azure.signinlogs.properties.incoming_token_type == "refreshToken" and
    azure.signinlogs.properties.device_detail.trust_type == "Azure AD joined" and
    azure.signinlogs.properties.device_detail.device_id != null and
    azure.signinlogs.properties.token_protection_status_details.sign_in_session_status == "unbound" and
    azure.signinlogs.properties.user_type == "Member" and
    azure.signinlogs.result_signature == "SUCCESS"
  ]
  [authentication where
    event.dataset == "azure.signinlogs" and
    azure.signinlogs.properties.incoming_token_type == "primaryRefreshToken" and
    azure.signinlogs.properties.resource_display_name != "Device Registration Service" and
    azure.signinlogs.result_signature == "SUCCESS"
  ]</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Persistence
</li>
<li class="listitem">
ID: TA0003
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0003/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0003/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Valid Accounts
</li>
<li class="listitem">
ID: T1078
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1078/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1078/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Cloud Accounts
</li>
<li class="listitem">
ID: T1078.004
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1078/004/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1078/004/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Account Manipulation
</li>
<li class="listitem">
ID: T1098
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1098/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1098/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Device Registration
</li>
<li class="listitem">
ID: T1098.005
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1098/005/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1098/005/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Initial Access
</li>
<li class="listitem">
ID: TA0001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0001/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0001/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-18-8-unusual-ropc-login-attempt-by-user-principal.html">« Unusual ROPC Login Attempt by User Principal</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-8-suspicious-adrs-token-request-by-microsoft-auth-broker.html">Suspicious ADRS Token Request by Microsoft Auth Broker »</a>
</span>
</div>
</body>
</html>
