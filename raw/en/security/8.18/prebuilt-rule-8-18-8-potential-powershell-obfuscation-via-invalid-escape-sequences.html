<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Potential PowerShell Obfuscation via Invalid Escape Sequences | Elastic Security [8.18] | Elastic</title>
<meta class="elastic" name="content" content="Potential PowerShell Obfuscation via Invalid Escape Sequences | Elastic Security [8.18]">

<link rel="home" href="index.html" title="Elastic Security [8.18]"/>
<link rel="up" href="prebuilt-rule-8-18-8-prebuilt-rules-8-18-8-appendix.html" title="Appendix [: Downloadable rule update v8.18.8"/>
<link rel="prev" href="prebuilt-rule-8-18-8-suspicious-net-reflection-via-powershell.html" title="Suspicious .NET Reflection via PowerShell"/>
<link rel="next" href="prebuilt-rule-8-18-8-potential-powershell-obfuscation-via-backtick-escaped-variable-expansion.html" title="Potential PowerShell Obfuscation via Backtick-Escaped Variable Expansion"/>
<meta class="elastic" name="product_version" content="8.18"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.18"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.18"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-18-8-suspicious-net-reflection-via-powershell.html">« Suspicious .NET Reflection via PowerShell</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-8-potential-powershell-obfuscation-via-backtick-escaped-variable-expansion.html">Potential PowerShell Obfuscation via Backtick-Escaped Variable Expansion »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.18]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-18-8-prebuilt-rules-8-18-8-appendix.html">Downloadable rule update v8.18.8</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Potential PowerShell Obfuscation via Invalid Escape Sequences</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-8/prebuilt-rule-8-18-8-potential-powershell-obfuscation-via-invalid-escape-sequences.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    A newer version is available. Check out the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-18-8-potential-powershell-obfuscation-via-invalid-escape-sequences"></a>Potential PowerShell Obfuscation via Invalid Escape Sequences</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-8/prebuilt-rule-8-18-8-potential-powershell-obfuscation-via-invalid-escape-sequences.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies PowerShell scripts that use invalid escape sequences as a form of obfuscation. This technique introduces backticks (`) between characters in a way that does not correspond to valid PowerShell escape sequences, breaking up strings and bypassing pattern-based detections while preserving execution logic. This is designed to evade static analysis and bypass security protections such as the Antimalware Scan Interface (AMSI).</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: esql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>: None</p>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.18/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>: None</p>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Defense Evasion
</li>
<li class="listitem">
Data Source: PowerShell Logs
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 3</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4400"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-8/prebuilt-rule-8-18-8-potential-powershell-obfuscation-via-invalid-escape-sequences.asciidoc">edit</a></div>
</div></div></div>
<pre class="literallayout">## Triage and analysis</pre>

<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Potential PowerShell Obfuscation via Invalid Escape Sequences</strong></span></p>
<p>PowerShell, a powerful scripting language in Windows environments, can be exploited by adversaries using obfuscation techniques to evade detection. By inserting invalid escape sequences, attackers can obscure malicious scripts, bypassing static analysis and security tools like AMSI. The detection rule identifies such obfuscation by analyzing script patterns, specifically targeting unusual backtick usage, to flag potential threats.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the <code class="literal">powershell.file.script_block_text</code> field to understand the context and content of the script block that triggered the alert. Look for patterns of invalid escape sequences and assess whether they appear intentionally obfuscated.
</li>
<li class="listitem">
Examine the <code class="literal">file.name</code> and <code class="literal">file.path</code> fields to determine the origin and location of the script. This can help identify whether the script is part of a legitimate application or potentially malicious.
</li>
<li class="listitem">
Check the <code class="literal">host.name</code> and <code class="literal">agent.id</code> fields to identify the affected system and the agent responsible for logging the event. This information is crucial for understanding the scope of the potential threat.
</li>
<li class="listitem">
Analyze the <code class="literal">user.id</code> field to ascertain which user executed the script. This can provide insights into whether the user has a history of executing suspicious scripts or if their account may be compromised.
</li>
<li class="listitem">
Investigate the <code class="literal">powershell.file.script_block_id</code> and <code class="literal">powershell.sequence</code> fields to trace the execution sequence and correlate it with other related script blocks, which may reveal additional obfuscation or malicious activity.
</li>
<li class="listitem">
Assess the <code class="literal">count</code> field to evaluate the extent of obfuscation detected. A higher count may indicate more aggressive obfuscation techniques, warranting further scrutiny.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Scripts from Visual Studio Code&#8217;s PowerShell extension may trigger false positives due to its shell integration. To handle this, exclude scripts containing the pattern "$([char]0x1b)]633" from detection.
</li>
<li class="listitem">
PowerShell modules with names starting with "TSS_" may be flagged incorrectly. Exclude these by adding a condition to ignore files matching the pattern "TSS_*.psm1".
</li>
<li class="listitem">
Legitimate scripts that use backticks for formatting or other non-obfuscation purposes might be detected. Review such scripts and, if verified as safe, add them to an exception list based on their script block ID or file path.
</li>
<li class="listitem">
Regularly update the exclusion list to reflect changes in legitimate script usage patterns, ensuring that new false positives are addressed promptly.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Isolate the affected host immediately to prevent lateral movement and further execution of potentially malicious scripts. Disconnect the host from the network and disable remote access.
</li>
<li class="listitem">
Analyze the script block text and file path to identify the source and nature of the obfuscated script. Determine if the script is part of a larger attack or if other systems are affected.
</li>
<li class="listitem">
Remove or quarantine the identified malicious script and any associated files from the host. Ensure that all remnants of the obfuscated code are eliminated to prevent re-execution.
</li>
<li class="listitem">
Conduct a thorough scan of the host using updated antivirus and antimalware tools to detect and remove any additional threats or indicators of compromise.
</li>
<li class="listitem">
Review and update PowerShell execution policies and security settings to restrict the execution of scripts with invalid escape sequences. Implement stricter controls to prevent similar obfuscation techniques.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) or relevant cybersecurity team for further investigation and monitoring. Provide detailed logs and findings to assist in understanding the scope and impact of the threat.
</li>
<li class="listitem">
Implement enhanced logging and monitoring for PowerShell activities across the network to detect and respond to similar obfuscation attempts promptly. Use the identified patterns to refine detection capabilities.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_1123"></a>Setup</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-8/prebuilt-rule-8-18-8-potential-powershell-obfuscation-via-invalid-escape-sequences.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Setup</strong></span></p>
<p>The <em>PowerShell Script Block Logging</em> logging policy must be enabled.
Steps to implement the logging policy with Advanced Audit Configuration:</p>
<pre class="screen">Computer Configuration &gt;
Administrative Templates &gt;
Windows PowerShell &gt;
Turn on PowerShell Script Block Logging (Enable)</pre>
<p>Steps to implement the logging policy via registry:</p>
<pre class="screen">reg add "hklm\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging" /v EnableScriptBlockLogging /t REG_DWORD /d 1</pre>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5285"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-8/prebuilt-rule-8-18-8-potential-powershell-obfuscation-via-invalid-escape-sequences.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">FROM logs-windows.powershell_operational* metadata _id, _version, _index
| WHERE event.code == "4104" and powershell.file.script_block_text LIKE "*`*"

// Replace string format expressions with 🔥 to enable counting the occurrence of the patterns we are looking for
// The emoji is used because it's unlikely to appear in scripts and has a consistent character length of 1
| EVAL replaced_with_fire = REPLACE(powershell.file.script_block_text, """[A-Za-z0-9_-]`(?![rntb]|\r|\n|\d)[A-Za-z0-9_-]""", "🔥")

// Count how many patterns were detected by calculating the number of 🔥 characters inserted
| EVAL count = LENGTH(replaced_with_fire) - LENGTH(REPLACE(replaced_with_fire, "🔥", ""))

// Keep the fields relevant to the query, although this is not needed as the alert is populated using _id
| KEEP count, replaced_with_fire, powershell.file.script_block_text, powershell.file.script_block_id, file.name, file.path, powershell.sequence, powershell.total, _id, _index, host.name, agent.id, user.id
| WHERE count &gt;= 10

// Filter FPs, and due to the behavior of the LIKE operator, allow null values
| WHERE (file.name NOT LIKE "TSS_*.psm1" or file.name IS NULL)

| WHERE
    // VSCode Shell integration
    NOT powershell.file.script_block_text LIKE "*$([char]0x1b)]633*"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Defense Evasion
</li>
<li class="listitem">
ID: TA0005
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0005/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0005/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Obfuscated Files or Information
</li>
<li class="listitem">
ID: T1027
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1027/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1027/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Deobfuscate/Decode Files or Information
</li>
<li class="listitem">
ID: T1140
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1140/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1140/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Execution
</li>
<li class="listitem">
ID: TA0002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0002/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0002/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Command and Scripting Interpreter
</li>
<li class="listitem">
ID: T1059
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1059/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1059/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: PowerShell
</li>
<li class="listitem">
ID: T1059.001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1059/001/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1059/001/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-18-8-suspicious-net-reflection-via-powershell.html">« Suspicious .NET Reflection via PowerShell</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-8-potential-powershell-obfuscation-via-backtick-escaped-variable-expansion.html">Potential PowerShell Obfuscation via Backtick-Escaped Variable Expansion »</a>
</span>
</div>
</body>
</html>
