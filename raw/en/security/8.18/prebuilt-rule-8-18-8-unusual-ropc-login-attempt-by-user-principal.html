<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Unusual ROPC Login Attempt by User Principal | Elastic Security [8.18] | Elastic</title>
<meta class="elastic" name="content" content="Unusual ROPC Login Attempt by User Principal | Elastic Security [8.18]">

<link rel="home" href="index.html" title="Elastic Security [8.18]"/>
<link rel="up" href="prebuilt-rule-8-18-8-prebuilt-rules-8-18-8-appendix.html" title="Appendix [: Downloadable rule update v8.18.8"/>
<link rel="prev" href="prebuilt-rule-8-18-8-suspicious-entra-id-oauth-user-impersonation-scope-detected.html" title="Suspicious Entra ID OAuth User Impersonation Scope Detected"/>
<link rel="next" href="prebuilt-rule-8-18-8-entra-id-rt-to-prt-transition-from-same-user-and-device.html" title="Entra ID RT to PRT Transition from Same User and Device"/>
<meta class="elastic" name="product_version" content="8.18"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.18"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.18"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-18-8-suspicious-entra-id-oauth-user-impersonation-scope-detected.html">« Suspicious Entra ID OAuth User Impersonation Scope Detected</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-8-entra-id-rt-to-prt-transition-from-same-user-and-device.html">Entra ID RT to PRT Transition from Same User and Device »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.18]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-18-8-prebuilt-rules-8-18-8-appendix.html">Downloadable rule update v8.18.8</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Unusual ROPC Login Attempt by User Principal</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-8/prebuilt-rule-8-18-8-unusual-ropc-login-attempt-by-user-principal.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    A newer version is available. Check out the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-18-8-unusual-ropc-login-attempt-by-user-principal"></a>Unusual ROPC Login Attempt by User Principal</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-8/prebuilt-rule-8-18-8-unusual-ropc-login-attempt-by-user-principal.asciidoc">edit</a></div>
</div></div></div>
<p>Detects unusual resource owner password credential (ROPC) login attempts by a user principal in Microsoft Entra ID. ROPC is a legacy authentication flow that allows applications to obtain tokens by directly providing user credentials. This method is less secure and can be exploited by adversaries to gain access to user accounts without requiring multi-factor authentication (MFA), especially during enumeration or password spraying. This is a New Terms rule that identifies when user principals are involved in ROPC login attempts, not seen before in the last 10 days, indicating potential abuse or unusual activity.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-azure.signinlogs-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.18/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.proofpoint.com/us/blog/threat-insight/attackers-unleash-teamfiltration-account-takeover-campaign" class="ulink" target="_top">https://www.proofpoint.com/us/blog/threat-insight/attackers-unleash-teamfiltration-account-takeover-campaign</a>
</li>
<li class="listitem">
<a href="https://dirkjanm.io/assets/raw/Finding%20Entra%20ID%20CA%20Bypasses%20-%20the%20structured%20way.pdf" class="ulink" target="_top">https://dirkjanm.io/assets/raw/Finding%20Entra%20ID%20CA%20Bypasses%20-%20the%20structured%20way.pdf</a>
</li>
<li class="listitem">
<a href="https://learn.microsoft.com/en-us/entra/identity-platform/v2-oauth-ropc" class="ulink" target="_top">https://learn.microsoft.com/en-us/entra/identity-platform/v2-oauth-ropc</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Domain: Identity
</li>
<li class="listitem">
Data Source: Azure
</li>
<li class="listitem">
Data Source: Microsoft Entra ID
</li>
<li class="listitem">
Data Source: Microsoft Entra ID Sign-In Logs
</li>
<li class="listitem">
Use Case: Identity and Access Audit
</li>
<li class="listitem">
Tactic: Initial Access
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 1</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4334"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-8/prebuilt-rule-8-18-8-unusual-ropc-login-attempt-by-user-principal.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating Unusual ROPC Login Attempt by User Principal</strong></span></p>
<p>This rule detects unusual login attempts using the Resource Owner Password Credentials (ROPC) flow in Microsoft Entra ID. ROPC allows applications to obtain tokens by directly providing user credentials, bypassing multi-factor authentication (MFA). This method is less secure and can be exploited by adversaries to gain access to user accounts, especially during enumeration or password spraying.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the <code class="literal">azure.signinlogs.properties.user_principal_name</code> field to identify the user principal involved in the ROPC login attempt. Check if this user is expected to use ROPC or if it is an unusual account for this type of authentication.
</li>
<li class="listitem">
Analyze the <code class="literal">azure.signinlogs.properties.authentication_protocol</code> field to confirm that the authentication protocol is indeed ROPC. This protocol is typically used in legacy applications or scripts that do not support modern authentication methods.
</li>
<li class="listitem">
Check the <code class="literal">user_agent.original</code> field to identify potentially abused open-source tools or scripts that may be using ROPC for unauthorized access such as TeamFiltration or other enumeration tools.
</li>
<li class="listitem">
Review the <code class="literal">azure.signinlogs.properties.app_display_name</code> or <code class="literal">azure.signinlogs.properties.app_id</code> to determine which application is attempting the ROPC login. FOCI applications are commonly used for enumeration and password spraying.
</li>
<li class="listitem">
Investigate the <code class="literal">azure.signinlogs.properties.client_ip</code> to identify the source of the login attempt. Check if the IP address is associated with known malicious activity or if it is a legitimate user location.
</li>
<li class="listitem">
Review the <code class="literal">azure.signinlogs.properties.authentication_details</code> field for any additional context on the authentication attempt, such as whether it was successful or if there were any errors.
</li>
<li class="listitem">
Examine the <code class="literal">azure.signinlogs.properties.applied_conditional_access_policies</code> to see if any conditional access policies were applied during the login attempt. If no policies were applied, this could indicate a potential bypass of security controls.
</li>
<li class="listitem">
Identify the resource requested access to by checking the <code class="literal">azure.signinlogs.properties.resource_display_name</code> or <code class="literal">azure.signinlogs.properties.resource_id</code>. This can help determine if the login attempt was targeting sensitive resources or applications such as Exchange Online, SharePoint, or Teams.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Legitimate applications or scripts that use ROPC for automation purposes may trigger this rule.
</li>
<li class="listitem">
Some legacy applications may still rely on ROPC for authentication, especially in environments where modern authentication methods are not fully implemented.
</li>
<li class="listitem">
Internal security tools or scripts that perform automated tasks using ROPC may generate false positives if they are not properly whitelisted or excluded from the rule.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If the ROPC login attempt is confirmed to be malicious, immediately block the user account and reset the password to prevent further unauthorized access.
</li>
<li class="listitem">
Consider enforcing multi-factor authentication (MFA) for the user account to enhance security and prevent future unauthorized access attempts.
</li>
<li class="listitem">
Review and update conditional access policies to restrict the use of ROPC for sensitive accounts or applications, ensuring that MFA is required for all login attempts.
</li>
<li class="listitem">
Investigate the source of the ROPC login attempt, including the application and IP address, to determine if there are any additional indicators of compromise or ongoing malicious activity.
</li>
<li class="listitem">
Monitor the user account and related resources for any further suspicious activity or unauthorized access attempts, and take appropriate actions to mitigate any risks identified.
</li>
<li class="listitem">
Educate users about the risks associated with ROPC and encourage them to use more secure authentication methods, such as OAuth 2.0 or OpenID Connect, whenever possible.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5223"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/downloadable-packages/8-18-8/prebuilt-rule-8-18-8-unusual-ropc-login-attempt-by-user-principal.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset: "azure.signinlogs" and
    azure.signinlogs.properties.authentication_protocol: "ropc" and
    azure.signinlogs.properties.authentication_requirement: "singleFactorAuthentication" and
    azure.signinlogs.properties.user_type: "Member" and
    event.outcome: "success"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Initial Access
</li>
<li class="listitem">
ID: TA0001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0001/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0001/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Valid Accounts
</li>
<li class="listitem">
ID: T1078
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1078/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1078/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Cloud Accounts
</li>
<li class="listitem">
ID: T1078.004
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1078/004/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1078/004/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-18-8-suspicious-entra-id-oauth-user-impersonation-scope-detected.html">« Suspicious Entra ID OAuth User Impersonation Scope Detected</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-18-8-entra-id-rt-to-prt-transition-from-same-user-and-device.html">Entra ID RT to PRT Transition from Same User and Device »</a>
</span>
</div>
</body>
</html>
