<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Local Account TokenFilter Policy Disabled | Elastic Security [8.19] | Elastic</title>
<meta class="elastic" name="content" content="Local Account TokenFilter Policy Disabled | Elastic Security [8.19]">

<link rel="home" href="index.html" title="Elastic Security [8.19]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="loadable-kernel-module-configuration-file-creation.html" title="Loadable Kernel Module Configuration File Creation"/>
<link rel="next" href="local-scheduled-task-creation.html" title="Local Scheduled Task Creation"/>
<meta class="elastic" name="product_version" content="8.19"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.19"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.19"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="loadable-kernel-module-configuration-file-creation.html">« Loadable Kernel Module Configuration File Creation</a>
</span>
<span class="next">
<a href="local-scheduled-task-creation.html">Local Scheduled Task Creation »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.19]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Local Account TokenFilter Policy Disabled</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/rule-details/local-account-tokenfilter-policy-disabled.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs/reference/security/prebuilt-rules/rules/windows/defense_evasion_persistence_account_tokenfilterpolicy">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="local-account-tokenfilter-policy-disabled"></a>Local Account TokenFilter Policy Disabled</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/rule-details/local-account-tokenfilter-policy-disabled.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies registry modification to the LocalAccountTokenFilterPolicy policy. If this value exists (which doesn&#8217;t by default) and is set to 1, then remote connections from all local members of Administrators are granted full high-integrity tokens during negotiation.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
winlogbeat-*
</li>
<li class="listitem">
logs-endpoint.events.registry-*
</li>
<li class="listitem">
logs-windows.sysmon_operational-*
</li>
<li class="listitem">
endgame-*
</li>
<li class="listitem">
logs-sentinel_one_cloud_funnel.*
</li>
<li class="listitem">
logs-m365_defender.event-*
</li>
<li class="listitem">
logs-crowdstrike.fdr*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.19/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.stigviewer.com/stig/windows_server_2008_r2_member_server/2014-04-02/finding/V-36439" class="ulink" target="_top">https://www.stigviewer.com/stig/windows_server_2008_r2_member_server/2014-04-02/finding/V-36439</a>
</li>
<li class="listitem">
<a href="https://posts.specterops.io/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy-506c25a7c167" class="ulink" target="_top">https://posts.specterops.io/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy-506c25a7c167</a>
</li>
<li class="listitem">
<a href="https://www.welivesecurity.com/wp-content/uploads/2018/01/ESET_Turla_Mosquito.pdf" class="ulink" target="_top">https://www.welivesecurity.com/wp-content/uploads/2018/01/ESET_Turla_Mosquito.pdf</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Defense Evasion
</li>
<li class="listitem">
Tactic: Lateral Movement
</li>
<li class="listitem">
Data Source: Elastic Endgame
</li>
<li class="listitem">
Data Source: Elastic Defend
</li>
<li class="listitem">
Data Source: Sysmon
</li>
<li class="listitem">
Data Source: SentinelOne
</li>
<li class="listitem">
Data Source: Microsoft Defender for Endpoint
</li>
<li class="listitem">
Data Source: Crowdstrike
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 317</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_540"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/rule-details/local-account-tokenfilter-policy-disabled.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Local Account TokenFilter Policy Disabled</strong></span></p>
<p>The LocalAccountTokenFilterPolicy is a Windows registry setting that, when enabled, allows remote connections from local administrators to use full high-integrity tokens. Adversaries may exploit this to bypass User Account Control (UAC) and gain elevated privileges remotely. The detection rule monitors changes to this registry setting, identifying potential unauthorized modifications that could indicate an attempt to facilitate lateral movement or evade defenses.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the registry event logs to confirm the change to the LocalAccountTokenFilterPolicy setting, specifically looking for entries where the registry.value is "LocalAccountTokenFilterPolicy" and registry.data.strings is "1" or "0x00000001".
</li>
<li class="listitem">
Identify the user account and process responsible for the registry modification by examining the associated event logs for user and process information.
</li>
<li class="listitem">
Check for any recent remote connections to the affected system, focusing on connections initiated by local administrator accounts, to determine if the change was exploited for lateral movement.
</li>
<li class="listitem">
Investigate any other recent registry changes on the host to identify potential patterns of unauthorized modifications that could indicate broader malicious activity.
</li>
<li class="listitem">
Correlate the event with other security alerts or logs from data sources like Elastic Endgame, Elastic Defend, Sysmon, SentinelOne, or Microsoft Defender for Endpoint to gather additional context and assess the scope of the potential threat.
</li>
<li class="listitem">
Assess the system for signs of compromise or malicious activity, such as unusual processes, network connections, or file modifications, that may have occurred around the time of the registry change.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Administrative tools or scripts that modify the LocalAccountTokenFilterPolicy for legitimate configuration purposes may trigger alerts. To manage this, identify and document these tools, then create exceptions for their known registry changes.
</li>
<li class="listitem">
System updates or patches that adjust registry settings as part of their installation process can cause false positives. Monitor update schedules and correlate alerts with these activities to determine if they are benign.
</li>
<li class="listitem">
Security software or management solutions that enforce policy changes across endpoints might modify this registry setting. Verify these actions with your IT or security team and consider excluding these processes from triggering alerts.
</li>
<li class="listitem">
Custom scripts or automation tasks used for system hardening or configuration management may alter this setting. Review these scripts and whitelist their expected changes to prevent unnecessary alerts.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected system from the network to prevent further unauthorized access or lateral movement.
</li>
<li class="listitem">
Revert the registry setting for LocalAccountTokenFilterPolicy to its default state if it was modified without authorization.
</li>
<li class="listitem">
Conduct a thorough review of recent administrative activities and access logs on the affected system to identify any unauthorized access or changes.
</li>
<li class="listitem">
Reset passwords for all local administrator accounts on the affected system to prevent potential misuse of compromised credentials.
</li>
<li class="listitem">
Deploy endpoint detection and response (EDR) tools to monitor for any further suspicious activities or attempts to modify registry settings.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) for further investigation and to determine if the threat is part of a larger attack campaign.
</li>
<li class="listitem">
Implement additional network segmentation and access controls to limit administrative access to critical systems and reduce the risk of similar threats.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_578"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/rule-details/local-account-tokenfilter-policy-disabled.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">registry where host.os.type == "windows" and event.type == "change" and
  registry.value : "LocalAccountTokenFilterPolicy" and
  registry.path : (
    "HKLM\\*\\LocalAccountTokenFilterPolicy",
    "\\REGISTRY\\MACHINE\\*\\LocalAccountTokenFilterPolicy",
    "MACHINE\\*\\LocalAccountTokenFilterPolicy"
  ) and registry.data.strings : ("1", "0x00000001") and
  not process.executable : (
    /* Intune */
    "C:\\Windows\\system32\\deviceenroller.exe",
    "C:\\Windows\\system32\\omadmclient.exe",

    /* Crowdstrike specific exclusion as it uses NT Object paths */
    "\\Device\\HarddiskVolume*\\system32\\deviceenroller.exe",
    "\\Device\\HarddiskVolume*\\system32\\omadmclient.exe"
  )</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Defense Evasion
</li>
<li class="listitem">
ID: TA0005
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0005/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0005/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Modify Registry
</li>
<li class="listitem">
ID: T1112
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1112/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1112/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Impair Defenses
</li>
<li class="listitem">
ID: T1562
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1562/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1562/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Lateral Movement
</li>
<li class="listitem">
ID: TA0008
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0008/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0008/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Use Alternate Authentication Material
</li>
<li class="listitem">
ID: T1550
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1550/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1550/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Pass the Hash
</li>
<li class="listitem">
ID: T1550.002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1550/002/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1550/002/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="loadable-kernel-module-configuration-file-creation.html">« Loadable Kernel Module Configuration File Creation</a>
</span>
<span class="next">
<a href="local-scheduled-task-creation.html">Local Scheduled Task Creation »</a>
</span>
</div>
</body>
</html>
