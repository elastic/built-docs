<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Suspicious ADRS Token Request by Microsoft Auth Broker | Elastic Security [8.19] | Elastic</title>
<meta class="elastic" name="content" content="Suspicious ADRS Token Request by Microsoft Auth Broker | Elastic Security [8.19]">

<link rel="home" href="index.html" title="Elastic Security [8.19]"/>
<link rel="up" href="prebuilt-rule-8-19-1-prebuilt-rules-8-19-1-appendix.html" title="Appendix T: Downloadable rule update v8.19.1"/>
<link rel="prev" href="prebuilt-rule-8-19-1-entra-id-rt-to-prt-transition-from-same-user-and-device.html" title="Entra ID RT to PRT Transition from Same User and Device"/>
<link rel="next" href="prebuilt-rule-8-19-1-microsoft-entra-id-suspicious-cloud-device-registration.html" title="Microsoft Entra ID Suspicious Cloud Device Registration"/>
<meta class="elastic" name="product_version" content="8.19"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.19"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.19"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-19-1-entra-id-rt-to-prt-transition-from-same-user-and-device.html">« Entra ID RT to PRT Transition from Same User and Device</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-19-1-microsoft-entra-id-suspicious-cloud-device-registration.html">Microsoft Entra ID Suspicious Cloud Device Registration »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.19]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-19-1-prebuilt-rules-8-19-1-appendix.html">Downloadable rule update v8.19.1</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Suspicious ADRS Token Request by Microsoft Auth Broker</h1><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-1/prebuilt-rule-8-19-1-suspicious-adrs-token-request-by-microsoft-auth-broker.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-19-1-suspicious-adrs-token-request-by-microsoft-auth-broker"></a>Suspicious ADRS Token Request by Microsoft Auth Broker</h2><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-1/prebuilt-rule-8-19-1-suspicious-adrs-token-request-by-microsoft-auth-broker.asciidoc">edit</a></div>
</div></div></div>
<p>Detects suspicious OAuth 2.0 token requests where the Microsoft Authentication Broker (29d9ed98-a469-4536-ade2-f981bc1d605e) requests access to the Device Registration Service (01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9) on behalf of a user principal. The presence of the adrs_access scope in the authentication processing details suggests an attempt to access ADRS, which is atypical for standard user sign-ins. This behavior may reflect an effort to abuse device registration for unauthorized persistence, such as acquiring a Primary Refresh Token (PRT) or establishing a trusted session.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: query</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-azure.signinlogs-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.19/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.volexity.com/blog/2025/04/22/phishing-for-codes-russian-threat-actors-target-microsoft-365-oauth-workflows/" class="ulink" target="_top">https://www.volexity.com/blog/2025/04/22/phishing-for-codes-russian-threat-actors-target-microsoft-365-oauth-workflows/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Domain: Identity
</li>
<li class="listitem">
Data Source: Azure
</li>
<li class="listitem">
Data Source: Microsoft Entra ID
</li>
<li class="listitem">
Data Source: Microsoft Entra ID Sign-In Logs
</li>
<li class="listitem">
Use Case: Identity and Access Audit
</li>
<li class="listitem">
Tactic: Persistence
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 1</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4031"></a>Investigation guide</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-1/prebuilt-rule-8-19-1-suspicious-adrs-token-request-by-microsoft-auth-broker.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating Suspicious ADRS Token Request by Microsoft Auth Broker</strong></span></p>
<p>Detects suspicious OAuth 2.0 token requests where the Microsoft Authentication Broker (29d9ed98-a469-4536-ade2-f981bc1d605e) requests access to the Device Registration Service (01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9) on behalf of a user principal. The presence of the adrs_access scope in the authentication processing details suggests an attempt to access ADRS, which is atypical for standard user sign-ins. This behavior may reflect an effort to abuse device registration for unauthorized persistence, such as acquiring a Primary Refresh Token (PRT) or establishing a trusted session.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Identify the user principal associated with the request by checking <code class="literal">azure.signinlogs.properties.user_principal_name</code> or <code class="literal">azure.signinlogs.properties.user_id</code>.
</li>
<li class="listitem">
Review the <code class="literal">azure.signinlogs.properties.app_id</code> and <code class="literal">azure.signinlogs.properties.resource_id</code> to confirm the request is made by the Microsoft Authentication Broker and targeting the Device Registration Service.
</li>
<li class="listitem">
Examine the <code class="literal">azure.signinlogs.properties.authentication_processing_details.Oauth Scope Info</code> for the presence of <code class="literal">adrs_access</code>, indicating an attempt to access ADRS.
</li>
<li class="listitem">
Check the <code class="literal">azure.signinlogs.properties.incoming_token_type</code> to confirm the request is made using a refresh token, which is typical for persistent access scenarios.
</li>
<li class="listitem">
Review the <code class="literal">azure.signinlogs.properties.user_type</code> to ensure it is a "Member" user, as this behavior is unusual for standard user accounts.
</li>
<li class="listitem">
Review the <code class="literal">source.address</code> and <code class="literal">source.geo.country_name</code> to identify the origin of the request. Look for any anomalies or unexpected locations.
</li>
<li class="listitem">
Check the <code class="literal">azure.signinlogs.properties.device_detail.operating_system</code> and <code class="literal">azure.signinlogs.properties.device_detail.browser</code> to identify the device and browser used for the request. Look for any unusual or unexpected devices for this user.
</li>
<li class="listitem">
Use the <code class="literal">azure.signinlogs.properties.session_id</code> to correlate this request with other sign-in events for the same user. Look for any patterns of suspicious activity or multiple requests in a short time frame.
</li>
<li class="listitem">
Correlate with Entra ID audit logs to identify any recent device registrations or changes to the user&#8217;s device registration status.
</li>
<li class="listitem">
Pivot to primary refresh token (PRTs) usage for the same user and/or session ID to identify any potential abuse or unauthorized access attempts.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Legitimate applications or services that require access to the Device Registration Service may trigger this rule. If this is expected behavior, consider adjusting the rule or adding exceptions for specific applications or user accounts.
</li>
<li class="listitem">
Users being onboarded or enrolled in new devices may also trigger this rule, especially if they are using the Microsoft Authentication Broker for the first time.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If the request is confirmed to be suspicious or unauthorized, take immediate action to revoke the access token and prevent further access.
</li>
<li class="listitem">
Disable the user account temporarily to prevent any potential compromise or unauthorized access.
</li>
<li class="listitem">
Review the user&#8217;s recent sign-in activity and access patterns to identify any potential compromise or unauthorized access.
</li>
<li class="listitem">
If the user account is compromised, initiate a password reset and enforce multi-factor authentication (MFA) for the user.
</li>
<li class="listitem">
Review the conditional access policies in place to ensure they are sufficient to prevent unauthorized access to sensitive resources.
</li>
<li class="listitem">
Consider deactivating any newly registered devices associated with the user account until further investigation is complete.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_4904"></a>Rule query</h3><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-1/prebuilt-rule-8-19-1-suspicious-adrs-token-request-by-microsoft-auth-broker.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset: "azure.signinlogs" and
    azure.signinlogs.properties.app_id : "29d9ed98-a469-4536-ade2-f981bc1d605e" and
    azure.signinlogs.properties.resource_id : "01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9" and
    azure.signinlogs.category: "NonInteractiveUserSignInLogs" and
    azure.signinlogs.properties.authentication_processing_details: *adrs_access* and
    azure.signinlogs.properties.incoming_token_type: "refreshToken" and
    azure.signinlogs.properties.user_type: "Member"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Persistence
</li>
<li class="listitem">
ID: TA0003
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0003/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0003/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Account Manipulation
</li>
<li class="listitem">
ID: T1098
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1098/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1098/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Device Registration
</li>
<li class="listitem">
ID: T1098.005
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1098/005/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1098/005/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-19-1-entra-id-rt-to-prt-transition-from-same-user-and-device.html">« Entra ID RT to PRT Transition from Same User and Device</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-19-1-microsoft-entra-id-suspicious-cloud-device-registration.html">Microsoft Entra ID Suspicious Cloud Device Registration »</a>
</span>
</div>
</body>
</html>
