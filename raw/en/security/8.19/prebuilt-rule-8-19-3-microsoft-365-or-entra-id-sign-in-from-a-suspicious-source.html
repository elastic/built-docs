<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Microsoft 365 or Entra ID Sign-in from a Suspicious Source | Elastic Security [8.19] | Elastic</title>
<meta class="elastic" name="content" content="Microsoft 365 or Entra ID Sign-in from a Suspicious Source | Elastic Security [8.19]">

<link rel="home" href="index.html" title="Elastic Security [8.19]"/>
<link rel="up" href="prebuilt-rule-8-19-3-prebuilt-rules-8-19-3-appendix.html" title="Appendix V: Downloadable rule update v8.19.3"/>
<link rel="prev" href="prebuilt-rule-8-19-3-unusual-web-config-file-access.html" title="Unusual Web Config File Access"/>
<link rel="next" href="prebuilt-rule-8-19-3-microsoft-entra-id-mfa-totp-brute-force-attempts.html" title="Microsoft Entra ID MFA TOTP Brute Force Attempts"/>
<meta class="elastic" name="product_version" content="8.19"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.19"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.19"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-19-3-unusual-web-config-file-access.html">« Unusual Web Config File Access</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-19-3-microsoft-entra-id-mfa-totp-brute-force-attempts.html">Microsoft Entra ID MFA TOTP Brute Force Attempts »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.19]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-19-3-prebuilt-rules-8-19-3-appendix.html">Downloadable rule update v8.19.3</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Microsoft 365 or Entra ID Sign-in from a Suspicious Source</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-3/prebuilt-rule-8-19-3-microsoft-365-or-entra-id-sign-in-from-a-suspicious-source.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-19-3-microsoft-365-or-entra-id-sign-in-from-a-suspicious-source"></a>Microsoft 365 or Entra ID Sign-in from a Suspicious Source</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-3/prebuilt-rule-8-19-3-microsoft-365-or-entra-id-sign-in-from-a-suspicious-source.asciidoc">edit</a></div>
</div></div></div>
<p>This rule correlate Azure or Office 356 mail successful sign-in events with network security alerts by source.ip. Adversaries may trigger some network security alerts such as reputation or other anomalies before accessing cloud resources.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: esql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>: None</p>
<p><span class="strong strong"><strong>Severity</strong></span>: high</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 73</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-60m (<a href="/guide/en/elasticsearch/reference/8.19/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>: None</p>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Domain: SaaS
</li>
<li class="listitem">
Data Source: Azure
</li>
<li class="listitem">
Data Source: Entra ID
</li>
<li class="listitem">
Data Source: Entra ID Sign-in Logs
</li>
<li class="listitem">
Data Source: Microsoft 365
</li>
<li class="listitem">
Data Source: Microsoft 365 Audit Logs
</li>
<li class="listitem">
Use Case: Identity and Access Audit
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Initial Access
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
<li class="listitem">
Rule Type: Higher-Order Rule
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 3</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4220"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-3/prebuilt-rule-8-19-3-microsoft-365-or-entra-id-sign-in-from-a-suspicious-source.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating Microsoft 365 or Entra ID Sign-in from a Suspicious Source</strong></span></p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Investiguate all the alerts associated with the source.ip.
</li>
<li class="listitem">
Verify the network security alert details associated with this source.ip.
</li>
<li class="listitem">
Verify all sign-in events associated with this source.ip.
</li>
<li class="listitem">
Consider the source IP address and geolocation for the involved user account.
</li>
<li class="listitem">
Consider the device used to sign in. Is it registered and compliant?
</li>
<li class="listitem">
Investigate other alerts associated with the user account during the past 48 hours.
</li>
<li class="listitem">
Contact the account owner and confirm whether they are aware of this activity.
</li>
<li class="listitem">
Check if this operation was approved and performed according to the organization&#8217;s change management policy.
</li>
<li class="listitem">
If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Initiate the incident response process based on the outcome of the triage.
</li>
<li class="listitem">
Disable or limit the account during the investigation and response.
</li>
<li class="listitem">
Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:
</li>
<li class="listitem">
Identify the account role in the cloud environment.
</li>
<li class="listitem">
Assess the criticality of affected services and servers.
</li>
<li class="listitem">
Work with your IT team to identify and minimize the impact on users.
</li>
<li class="listitem">
Identify if the attacker is moving laterally and compromising other accounts, servers, or services.
</li>
<li class="listitem">
Identify any regulatory or legal ramifications related to this activity.
</li>
<li class="listitem">
Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker&#8217;s access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.
</li>
<li class="listitem">
Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.
</li>
<li class="listitem">
Consider enabling multi-factor authentication for users.
</li>
<li class="listitem">
Follow security best practices <a href="https://docs.microsoft.com/en-us/azure/security/fundamentals/identity-management-best-practices" class="ulink" target="_top">outlined</a> by Microsoft.
</li>
<li class="listitem">
Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.
</li>
<li class="listitem">
Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_940"></a>Setup</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-3/prebuilt-rule-8-19-3-microsoft-365-or-entra-id-sign-in-from-a-suspicious-source.asciidoc">edit</a></div>
</div></div></div>
<p>The Azure Fleet integration, Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5094"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-3/prebuilt-rule-8-19-3-microsoft-365-or-entra-id-sign-in-from-a-suspicious-source.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">from logs-o365.audit-*, logs-azure.signinlogs-*, .alerts-security.*
// query runs every 1 hour looking for activities occurred during last 8 hours to match on disparate events
| where @timestamp &gt; now() - 8 hours
// filter for azure or m365 sign-in and external alerts with source.ip not null
| where to_ip(source.ip) is not null
  and (event.dataset in ("o365.audit", "azure.signinlogs") or kibana.alert.rule.name == "External Alerts")
  and not cidr_match(
    to_ip(source.ip),
    "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29",
    "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24",
    "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
    "100.64.0.0/10", "192.175.48.0/24", "198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24",
    "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8"
  )

// capture relevant raw fields
| keep source.ip, event.action, event.outcome, event.dataset, kibana.alert.rule.name, event.category

// classify each source ip based on alert type
| eval
  Esql.source_ip_mail_access_case = case(event.dataset == "o365.audit" and event.action == "MailItemsAccessed" and event.outcome == "success", to_ip(source.ip), null),
  Esql.source_ip_azure_signin_case = case(event.dataset == "azure.signinlogs" and event.outcome == "success", to_ip(source.ip), null),
  Esql.source_ip_network_alert_case = case(kibana.alert.rule.name == "external alerts" and not event.dataset in ("o365.audit", "azure.signinlogs"), to_ip(source.ip), null)

// aggregate by source ip
| stats
    Esql.event_count = count(*),
    Esql.source_ip_mail_access_case_count_distinct = count_distinct(Esql.source_ip_mail_access_case),
    Esql.source_ip_azure_signin_case_count_distinct = count_distinct(Esql.source_ip_azure_signin_case),
    Esql.source_ip_network_alert_case_count_distinct = count_distinct(Esql.source_ip_network_alert_case),
    Esql.event_dataset_count_distinct = count_distinct(event.dataset),
    Esql.event_dataset_values = values(event.dataset),
    Esql.kibana_alert_rule_name_values = values(kibana.alert.rule.name),
    Esql.event_category_values = values(event.category)
  by Esql.source_ip = to_ip(source.ip)

// correlation condition
| where
  Esql.source_ip_network_alert_case_count_distinct &gt; 0
  and Esql.event_dataset_count_distinct &gt;= 2
  and (Esql.source_ip_mail_access_case_count_distinct &gt; 0 or Esql.source_ip_azure_signin_case_count_distinct &gt; 0)
  and Esql.event_count &lt;= 100</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Initial Access
</li>
<li class="listitem">
ID: TA0001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0001/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0001/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Valid Accounts
</li>
<li class="listitem">
ID: T1078
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1078/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1078/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-19-3-unusual-web-config-file-access.html">« Unusual Web Config File Access</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-19-3-microsoft-entra-id-mfa-totp-brute-force-attempts.html">Microsoft Entra ID MFA TOTP Brute Force Attempts »</a>
</span>
</div>
</body>
</html>
