<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AWS Access Token Used from Multiple Addresses | Elastic Security [8.19] | Elastic</title>
<meta class="elastic" name="content" content="AWS Access Token Used from Multiple Addresses | Elastic Security [8.19]">

<link rel="home" href="index.html" title="Elastic Security [8.19]"/>
<link rel="up" href="prebuilt-rule-8-19-4-prebuilt-rules-8-19-4-appendix.html" title="Appendix W: Downloadable rule update v8.19.4"/>
<link rel="prev" href="prebuilt-rule-8-19-4-aws-s3-static-site-javascript-file-uploaded.html" title="AWS S3 Static Site JavaScript File Uploaded"/>
<link rel="next" href="prebuilt-rule-8-19-4-aws-signin-single-factor-console-login-with-federated-user.html" title="AWS Signin Single Factor Console Login with Federated User"/>
<meta class="elastic" name="product_version" content="8.19"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.19"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.19"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-19-4-aws-s3-static-site-javascript-file-uploaded.html">« AWS S3 Static Site JavaScript File Uploaded</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-19-4-aws-signin-single-factor-console-login-with-federated-user.html">AWS Signin Single Factor Console Login with Federated User »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.19]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-19-4-prebuilt-rules-8-19-4-appendix.html">Downloadable rule update v8.19.4</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>AWS Access Token Used from Multiple Addresses</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-4/prebuilt-rule-8-19-4-aws-access-token-used-from-multiple-addresses.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-19-4-aws-access-token-used-from-multiple-addresses"></a>AWS Access Token Used from Multiple Addresses</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-4/prebuilt-rule-8-19-4-aws-access-token-used-from-multiple-addresses.asciidoc">edit</a></div>
</div></div></div>
<p>This rule identifies potentially suspicious activity by detecting instances where a single IAM user&#8217;s temporary session token is accessed from multiple IP addresses within a short time frame. Such behavior may suggest that an adversary has compromised temporary credentials and is utilizing them from various locations. To enhance detection accuracy and minimize false positives, the rule incorporates criteria that evaluate unique IP addresses, user agents, cities, and networks. These additional checks help distinguish between legitimate distributed access patterns and potential credential misuse. Detected activities are classified into different types based on the combination of unique indicators, with each classification assigned a fidelity score reflecting the likelihood of malicious behavior. High fidelity scores are given to patterns most indicative of threats, such as multiple unique IPs, networks, cities, and user agents. Medium and low fidelity scores correspond to less severe patterns, enabling security teams to effectively prioritize alerts.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: esql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>: None</p>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-32m (<a href="/guide/en/elasticsearch/reference/8.19/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.sygnia.co/blog/sygnia-investigation-bybit-hack/" class="ulink" target="_top">https://www.sygnia.co/blog/sygnia-investigation-bybit-hack/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Data Source: AWS
</li>
<li class="listitem">
Data Source: Amazon Web Services
</li>
<li class="listitem">
Data Source: AWS IAM
</li>
<li class="listitem">
Data Source: AWS CloudTrail
</li>
<li class="listitem">
Tactic: Initial Access
</li>
<li class="listitem">
Use Case: Identity and Access Audit
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 102</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4226"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-4/prebuilt-rule-8-19-4-aws-access-token-used-from-multiple-addresses.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and Analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating AWS Access Token Used from Multiple Addresses</strong></span></p>
<p>Access tokens are bound to a single user. Usage from multiple IP addresses may indicate the token was stolen and used elsewhere. By correlating this with additional detection criteria like multiple user agents, different cities, and different networks, we can improve the fidelity of the rule and help to eliminate false positives associated with expected behavior, like dual-stack IPV4/IPV6 usage.</p>
<p><span class="strong strong"><strong>Possible Investigation Steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Identify the IAM User</strong></span>: Examine the <code class="literal">aws.cloudtrail.user_identity.arn</code> stored in <code class="literal">user_id</code> and correlate with the <code class="literal">source.ips</code> stored in <code class="literal">ip_list</code> and <code class="literal">unique_ips</code> count to determine how widely the token was used.
</li>
<li class="listitem">
<span class="strong strong"><strong>Correlate Additional Detection Context</strong></span>: Examine <code class="literal">activity_type</code> and <code class="literal">fidelity_score</code> to determine additional cities, networks or user agents associated with the token usage.
</li>
<li class="listitem">
<span class="strong strong"><strong>Determine Access Key Type</strong></span>: Examine the <code class="literal">access_key_id</code> to determine whether the token is short-term (beginning with ASIA) or long-term (beginning with AKIA).
</li>
<li class="listitem">
<span class="strong strong"><strong>Check Recent MFA Events</strong></span>: Determine whether the user recently enabled MFA, registered devices, or assumed a role using this token.
</li>
<li class="listitem">
<span class="strong strong"><strong>Review Workload Context</strong></span>: Confirm whether the user was expected to be active across multiple cities, networks or user agent environments.
</li>
<li class="listitem">
<span class="strong strong"><strong>Trace Adversary Movement</strong></span>: Pivot to related actions (e.g., <code class="literal">s3:ListBuckets</code>, <code class="literal">iam:ListUsers</code>, <code class="literal">sts:GetCallerIdentity</code>) to track further enumeration.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False Positive Analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Automation frameworks that rotate through multiple IPs or cloud functions with dynamic egress IPs may cause this alert to fire.
</li>
<li class="listitem">
Confirm geolocation and workload context before escalating.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and Remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Revoke the Token</strong></span>: Disable or rotate the IAM credentials and invalidate the temporary session token.
</li>
<li class="listitem">
<span class="strong strong"><strong>Audit the Environment</strong></span>: Look for signs of lateral movement or data access during the token&#8217;s validity.
</li>
<li class="listitem">
<span class="strong strong"><strong>Strengthen Controls</strong></span>: Require MFA for high-privilege actions, restrict access via policy conditions (e.g., IP range or device).
</li>
</ul>
</div>
<p><span class="strong strong"><strong>References</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html" class="ulink" target="_top">IAM Long-Term Credentials</a>
</li>
<li class="listitem">
<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html" class="ulink" target="_top">STS Temporary Credentials</a>
</li>
<li class="listitem">
<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp_enable-regions.html" class="ulink" target="_top">Using MFA with Temporary Credentials</a>
</li>
<li class="listitem">
<a href="https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-standards-fsbp-controls.html" class="ulink" target="_top">AWS Threat Detection Use Cases</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5098"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-4/prebuilt-rule-8-19-4-aws-access-token-used-from-multiple-addresses.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">from logs-aws.cloudtrail* metadata _id, _version, _index
| where @timestamp &gt; now() - 30 minutes
  and event.dataset == "aws.cloudtrail"
  and aws.cloudtrail.user_identity.arn is not null
  and aws.cloudtrail.user_identity.type == "IAMUser"
  and source.ip is not null
  and not (
    user_agent.original like "%Terraform%" or
    user_agent.original like "%Ansible%" or
    user_agent.original like "%Pulumni%"
  )
  and `source.as.organization.name` != "AMAZON-AES"
  and event.provider not in (
    "health.amazonaws.com", "monitoring.amazonaws.com", "notifications.amazonaws.com",
    "ce.amazonaws.com", "cost-optimization-hub.amazonaws.com",
    "servicecatalog-appregistry.amazonaws.com", "securityhub.amazonaws.com"
  )

| eval
  Esql.time_window_date_trunc = date_trunc(30 minutes, @timestamp),
  Esql.aws_cloudtrail_user_identity_arn = aws.cloudtrail.user_identity.arn,
  Esql.aws_cloudtrail_user_identity_access_key_id = aws.cloudtrail.user_identity.access_key_id,
  Esql.source_ip = source.ip,
  Esql.user_agent_original = user_agent.original,
  Esql.source_ip_string = to_string(source.ip),
  Esql.source_ip_user_agent_pair = concat(Esql.source_ip_string, " - ", user_agent.original),
  Esql.source_ip_city_pair = concat(Esql.source_ip_string, " - ", source.geo.city_name),
  Esql.source_geo_city_name = source.geo.city_name,
  Esql.event_timestamp = @timestamp,
  Esql.source_network_org_name = `source.as.organization.name`

| stats
  Esql.event_action_values = values(event.action),
  Esql.event_provider_values = values(event.provider),
  Esql.aws_cloudtrail_user_identity_access_key_id_values = values(Esql.aws_cloudtrail_user_identity_access_key_id),
  Esql.aws_cloudtrail_user_identity_arn_values = values(Esql.aws_cloudtrail_user_identity_arn),
  Esql.source_ip_values = values(Esql.source_ip),
  Esql.user_agent_original_values = values(Esql.user_agent_original),
  Esql.source_ip_user_agent_pair_values = values(Esql.source_ip_user_agent_pair),
  Esql.source_geo_city_name_values = values(Esql.source_geo_city_name),
  Esql.source_ip_city_pair_values = values(Esql.source_ip_city_pair),
  Esql.source_network_org_name_values = values(Esql.source_network_org_name),
  Esql.source_ip_count_distinct = count_distinct(Esql.source_ip),
  Esql.user_agent_original_count_distinct = count_distinct(Esql.user_agent_original),
  Esql.source_geo_city_name_count_distinct = count_distinct(Esql.source_geo_city_name),
  Esql.source_network_org_name_count_distinct = count_distinct(Esql.source_network_org_name),
  Esql.timestamp_first_seen = min(Esql.event_timestamp),
  Esql.timestamp_last_seen = max(Esql.event_timestamp),
  Esql.event_count = count()
  by Esql.time_window_date_trunc, Esql.aws_cloudtrail_user_identity_access_key_id

| eval
  Esql.activity_type = case(
    Esql.source_ip_count_distinct &gt;= 2 and Esql.source_network_org_name_count_distinct &gt;= 2 and Esql.source_geo_city_name_count_distinct &gt;= 2 and Esql.user_agent_original_count_distinct &gt;= 2, "multiple_ip_network_city_user_agent",
    Esql.source_ip_count_distinct &gt;= 2 and Esql.source_network_org_name_count_distinct &gt;= 2 and Esql.source_geo_city_name_count_distinct &gt;= 2, "multiple_ip_network_city",
    Esql.source_ip_count_distinct &gt;= 2 and Esql.source_geo_city_name_count_distinct &gt;= 2, "multiple_ip_and_city",
    Esql.source_ip_count_distinct &gt;= 2 and Esql.source_network_org_name_count_distinct &gt;= 2, "multiple_ip_and_network",
    Esql.source_ip_count_distinct &gt;= 2 and Esql.user_agent_original_count_distinct &gt;= 2, "multiple_ip_and_user_agent",
    "normal_activity"
  ),
  Esql.activity_fidelity_score = case(
    Esql.activity_type == "multiple_ip_network_city_user_agent", "high",
    Esql.activity_type == "multiple_ip_network_city", "high",
    Esql.activity_type == "multiple_ip_and_city", "medium",
    Esql.activity_type == "multiple_ip_and_network", "medium",
    Esql.activity_type == "multiple_ip_and_user_agent", "low"
  )

| keep
  Esql.time_window_date_trunc,
  Esql.activity_type,
  Esql.activity_fidelity_score,
  Esql.event_count,
  Esql.timestamp_first_seen,
  Esql.timestamp_last_seen,
  Esql.aws_cloudtrail_user_identity_arn_values,
  Esql.aws_cloudtrail_user_identity_access_key_id_values,
  Esql.event_action_values,
  Esql.event_provider_values,
  Esql.source_ip_values,
  Esql.user_agent_original_values,
  Esql.source_ip_user_agent_pair_values,
  Esql.source_geo_city_name_values,
  Esql.source_ip_city_pair_values,
  Esql.source_network_org_name_values,
  Esql.source_ip_count_distinct,
  Esql.user_agent_original_count_distinct,
  Esql.source_geo_city_name_count_distinct,
  Esql.source_network_org_name_count_distinct

| where Esql.activity_type != "normal_activity"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Initial Access
</li>
<li class="listitem">
ID: TA0001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0001/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0001/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Valid Accounts
</li>
<li class="listitem">
ID: T1078
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1078/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1078/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Cloud Accounts
</li>
<li class="listitem">
ID: T1078.004
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1078/004/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1078/004/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-19-4-aws-s3-static-site-javascript-file-uploaded.html">« AWS S3 Static Site JavaScript File Uploaded</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-19-4-aws-signin-single-factor-console-login-with-federated-user.html">AWS Signin Single Factor Console Login with Federated User »</a>
</span>
</div>
</body>
</html>
