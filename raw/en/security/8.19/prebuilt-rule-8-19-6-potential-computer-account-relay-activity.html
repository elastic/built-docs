<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Potential Computer Account Relay Activity | Elastic Security [8.19] | Elastic</title>
<meta class="elastic" name="content" content="Potential Computer Account Relay Activity | Elastic Security [8.19]">

<link rel="home" href="index.html" title="Elastic Security [8.19]"/>
<link rel="up" href="prebuilt-rule-8-19-6-prebuilt-rules-8-19-6-appendix.html" title="Appendix Y: Downloadable rule update v8.19.6"/>
<link rel="prev" href="prebuilt-rule-8-19-6-potential-file-transfer-via-curl-for-windows.html" title="Potential File Transfer via Curl for Windows"/>
<link rel="next" href="prebuilt-rule-8-19-6-mimikatz-memssp-log-file-detected.html" title="Mimikatz Memssp Log File Detected"/>
<meta class="elastic" name="product_version" content="8.19"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.19"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.19"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-19-6-potential-file-transfer-via-curl-for-windows.html">« Potential File Transfer via Curl for Windows</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-19-6-mimikatz-memssp-log-file-detected.html">Mimikatz Memssp Log File Detected »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.19]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-19-6-prebuilt-rules-8-19-6-appendix.html">Downloadable rule update v8.19.6</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Potential Computer Account Relay Activity</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-6/prebuilt-rule-8-19-6-potential-computer-account-relay-activity.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-19-6-potential-computer-account-relay-activity"></a>Potential Computer Account Relay Activity</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-6/prebuilt-rule-8-19-6-potential-computer-account-relay-activity.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies potential relay activities against a Computer account by identifying authentication events using the computer account coming from from hosts other than the server that owns the account. Attackers may relay the computer account hash after capturing it using forced authentication.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
logs-system.security*
</li>
<li class="listitem">
logs-windows.forwarded*
</li>
<li class="listitem">
winlogbeat-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.19/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://github.com/p0dalirius/windows-coerced-authentication-methods" class="ulink" target="_top">https://github.com/p0dalirius/windows-coerced-authentication-methods</a>
</li>
<li class="listitem">
<a href="https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications" class="ulink" target="_top">https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications</a>
</li>
<li class="listitem">
<a href="https://attack.mitre.org/techniques/T1187/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1187/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Credential Access
</li>
<li class="listitem">
Data Source: Elastic Defend
</li>
<li class="listitem">
Data Source: Active Directory
</li>
<li class="listitem">
Use Case: Active Directory Monitoring
</li>
<li class="listitem">
Data Source: Windows Security Event Logs
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 108</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4329"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-6/prebuilt-rule-8-19-6-potential-computer-account-relay-activity.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Potential Computer Account Relay Activity</strong></span></p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Compare the source.ip to the target server host.ip addresses to make sure it&#8217;s indeed a remote use of the machine account.
</li>
<li class="listitem">
Examine the source.ip activities as this is the attacker IP address used to relay.
</li>
<li class="listitem">
Review all relevant activities such as services creation, file and process events on the target server within the same period.
</li>
<li class="listitem">
Verify the machine account names that end with a dollar sign ($) to ensure they match the expected hostnames, and investigate any discrepancies.
</li>
<li class="listitem">
Check the network logon types to confirm if they align with typical usage patterns for the identified machine accounts.
</li>
<li class="listitem">
Investigate the context of the source IP addresses that do not match the host IP, looking for any signs of unauthorized access or unusual network activity.
</li>
<li class="listitem">
Correlate the findings with other security logs and alerts to identify any patterns or additional indicators of compromise related to the potential relay attack.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Machine accounts performing legitimate network logons from different IP addresses can trigger false positives. To manage this, identify and whitelist known IP addresses associated with legitimate administrative tasks or automated processes.
</li>
<li class="listitem">
Scheduled tasks or automated scripts that use machine accounts for network operations may be flagged. Review and document these tasks, then create exceptions for their associated IP addresses and hostnames.
</li>
<li class="listitem">
Load balancers or proxy servers that alter the source IP address of legitimate authentication requests can cause false alerts. Ensure these devices are accounted for in the network architecture and exclude their IP addresses from the rule.
</li>
<li class="listitem">
Temporary network reconfigurations or migrations might result in machine accounts appearing to log in from unexpected hosts. During such events, temporarily adjust the rule parameters or disable the rule to prevent unnecessary alerts.
</li>
<li class="listitem">
Regularly review and update the list of exceptions to ensure they reflect current network configurations and operational practices, minimizing the risk of overlooking genuine threats.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and Remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Initiate the incident response process based on the outcome of the triage.
</li>
<li class="listitem">
Isolate the involved hosts to prevent further post-compromise behavior.
</li>
<li class="listitem">
If the involved server is a Domain Controller, coordinate the isolation of the server with infrastructure and identity teams to contain the threat while preserving service availability and forensic evidence. Prioritize this step if active compromise or attacker persistence is confirmed.
</li>
<li class="listitem">
Reset the domain controller&#8217;s machine account password, along with any accounts suspected to be compromised or exposed. Ensure strong, unique credentials are used and apply tiered credential hygiene where applicable.
</li>
<li class="listitem">
Analyze recent authentication logs, event logs, and network traffic, focusing on suspicious activity and the source IPs referenced in the alert. Correlate findings to identify any lateral movement or additional compromised systems.
</li>
<li class="listitem">
Strengthen network segmentation, especially between domain controllers, administrative workstations, and critical infrastructure. This limits the attack surface and impedes credential relay or reuse across systems.
</li>
<li class="listitem">
Escalate the incident to the SOC or incident response team to coordinate a full investigation, containment, and recovery plan. Ensure stakeholders are kept informed throughout the response.
</li>
<li class="listitem">
Enhance detection mechanisms by tuning alerts and deploying additional telemetry focused on credential relay patterns, anomalous authentication, and NTLM-related activity.
</li>
<li class="listitem">
Conduct a structured post-incident review, documenting findings, identifying control gaps, and updating playbooks, configurations, or security policies to reduce the likelihood of similar incidents in the future.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5200"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-6/prebuilt-rule-8-19-6-potential-computer-account-relay-activity.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">authentication where host.os.type == "windows" and event.code in ("4624", "4625") and
    endswith~(user.name, "$") and winlog.logon.type : "network" and

    /* Filter for a machine account that matches the hostname */
    startswith~(host.name, substring(user.name, 0, -1)) and

    /* Verify if the Source IP belongs to the host */
    not endswith(string(source.ip), string(host.ip)) and
    source.ip != null and source.ip != "::1" and source.ip != "127.0.0.1"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Forced Authentication
</li>
<li class="listitem">
ID: T1187
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1187/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1187/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Adversary-in-the-Middle
</li>
<li class="listitem">
ID: T1557
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1557/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1557/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: LLMNR/NBT-NS Poisoning and SMB Relay
</li>
<li class="listitem">
ID: T1557.001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1557/001/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1557/001/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-19-6-potential-file-transfer-via-curl-for-windows.html">« Potential File Transfer via Curl for Windows</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-19-6-mimikatz-memssp-log-file-detected.html">Mimikatz Memssp Log File Detected »</a>
</span>
</div>
</body>
</html>
