<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Potential Credential Access via DCSync | Elastic Security Solution [8.6] | Elastic</title>
<meta class="elastic" name="content" content="Potential Credential Access via DCSync | Elastic Security Solution [8.6]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.6]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="potential-cookies-theft-via-browser-debugging.html" title="Potential Cookies Theft via Browser Debugging"/>
<link rel="next" href="potential-credential-access-via-duplicatehandle-in-lsass.html" title="Potential Credential Access via DuplicateHandle in LSASS"/>
<meta class="elastic" name="product_version" content="8.6"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.6"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.6"/>
</head>
<body><div class="page_header">
A newer version is available. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.6]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="potential-cookies-theft-via-browser-debugging.html">« Potential Cookies Theft via Browser Debugging</a>
</span>
<span class="next">
<a href="potential-credential-access-via-duplicatehandle-in-lsass.html">Potential Credential Access via DuplicateHandle in LSASS »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="potential-credential-access-via-dcsync"></a>Potential Credential Access via DCSync<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.6/docs/detections/prebuilt-rules/rule-details/potential-credential-access-via-dcsync.asciidoc">edit</a></h2>
</div></div></div>
<p>This rule identifies when a User Account starts the Active Directory Replication Process. Attackers can use the DCSync technique to get credential information of individual accounts or the entire domain, thus compromising the entire domain.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
winlogbeat-*
</li>
<li class="listitem">
logs-system.*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: high</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 73</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5 minutes</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.6/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-180815210510.html" class="ulink" target="_top">https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-180815210510.html</a>
</li>
<li class="listitem">
<a href="https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing" class="ulink" target="_top">https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing</a>
</li>
<li class="listitem">
<a href="https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_ad_replication_non_machine_account.yml" class="ulink" target="_top">https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_ad_replication_non_machine_account.yml</a>
</li>
<li class="listitem">
<a href="https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0027_windows_audit_directory_service_access.md" class="ulink" target="_top">https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0027_windows_audit_directory_service_access.md</a>
</li>
<li class="listitem">
<a href="https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync" class="ulink" target="_top">https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync</a>
</li>
<li class="listitem">
<a href="https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync" class="ulink" target="_top">https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
<li class="listitem">
Host
</li>
<li class="listitem">
Windows
</li>
<li class="listitem">
Threat Detection
</li>
<li class="listitem">
Credential Access
</li>
<li class="listitem">
Active Directory
</li>
<li class="listitem">
Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 102 (<a class="xref" href="potential-credential-access-via-dcsync.html#potential-credential-access-via-dcsync-history" title="Rule version history">version history</a>)</p>
<p><span class="strong strong"><strong>Added (Elastic Stack release)</strong></span>: 8.1.0</p>
<p><span class="strong strong"><strong>Last modified (Elastic Stack release)</strong></span>: 8.6.0</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>: Elastic</p>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_investigation_guide_324"></a>Investigation guide<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.6/docs/detections/prebuilt-rules/rule-details/potential-credential-access-via-dcsync.asciidoc">edit</a></h3>
</div></div></div>
<div class="pre_wrapper lang-markdown">
<pre class="programlisting prettyprint lang-markdown">## Triage and analysis

### Investigating Potential Credential Access via DCSync

Active Directory replication is the process by which the changes that originate on one domain controller are
automatically transferred to other domain controllers that store the same data.

Active Directory data consists of objects that have properties, or attributes. Each object is an instance of an object
class, and object classes and their respective attributes are defined in the Active Directory schema. Objects are
defined by the values of their attributes, and changes to attribute values must be transferred from the domain
controller on which they occur to every other domain controller that stores a replica of an affected object.

Adversaries can use the DCSync technique that uses Windows Domain Controller's API to simulate the replication process
from a remote domain controller, compromising major credential material such as the Kerberos krbtgt keys used
legitimately for tickets creation, but also tickets forging by attackers. This attack requires some extended privileges
to succeed (DS-Replication-Get-Changes and DS-Replication-Get-Changes-All), which are granted by default to members of
the Administrators, Domain Admins, Enterprise Admins, and Domain Controllers groups. Privileged accounts can be abused
to grant controlled objects the right to DCsync/Replicate.

More details can be found on [Threat Hunter Playbook](https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing) and [The Hacker Recipes](https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync).

This rule monitors for Event ID 4662 (Operation was performed on an Active Directory object) and identifies events that
use the access mask 0x100 (Control Access) and properties that contain at least one of the following or their equivalent:
Schema-Id-GUID (DS-Replication-Get-Changes, DS-Replication-Get-Changes-All, DS-Replication-Get-Changes-In-Filtered-Set).
It also filters out events that use computer accounts and also Azure AD Connect MSOL accounts (more details [here](https://techcommunity.microsoft.com/t5/microsoft-defender-for-identity/ad-connect-msol-user-suspected-dcsync-attack/m-p/788028)).

#### Possible investigation steps

- Identify the user account that performed the action and whether it should perform this kind of action.
- Contact the account and system owners and confirm whether they are aware of this activity.
- Investigate other alerts associated with the user/host during the past 48 hours.
- Correlate security events 4662 and 4624 (Logon Type 3) by their Logon ID (`winlog.logon.id`) on the Domain Controller
(DC) that received the replication request. This will tell you where the AD replication request came from, and if it
came from another DC or not.
- Scope which credentials were compromised (for example, whether all accounts were replicated or specific ones).

### False positive analysis

- This activity should not happen legitimately, since replication should be done by Domain Controllers only. Any
potential benign true positive (B-TP) should be mapped and monitored by the security team. Any account that performs
this activity can put the domain at risk for not having the same security standards as computer accounts (which have
long, complex, random passwords that change frequently), exposing it to credential cracking attacks (Kerberoasting,
brute force, etc.).

### Response and remediation

- Initiate the incident response process based on the outcome of the triage.
- If specific credentials were compromised:
  - Reset the password for these accounts and other potentially compromised credentials, like email, business systems,
  and web services.
- If the entire domain or the `krbtgt` user were compromised:
  - Activate your incident response plan for total Active Directory compromise which should include, but not be limited
  to, a password reset (twice) of the `krbtgt` user.
- Investigate how the attacker escalated privileges and identify systems they used to conduct lateral movement. Use this
information to scope ways that the attacker could use to regain access to the environment.
- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.
- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the
mean time to respond (MTTR).</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_rule_query_414"></a>Rule query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.6/docs/detections/prebuilt-rules/rule-details/potential-credential-access-via-dcsync.asciidoc">edit</a></h3>
</div></div></div>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">any where event.action == "Directory Service Access" and event.code
== "4662" and winlog.event_data.Properties : ( /* Control Access
Rights/Permissions Symbol */ "*DS-Replication-Get-Changes*",
"*DS-Replication-Get-Changes-All*", "*DS-Replication-Get-Changes-
In-Filtered-Set*", /* Identifying GUID used in ACE */
"*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*",
"*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*",
"*89e95b76-444d-4c62-991a-0facbeda640c*") /* The right to perform
an operation controlled by an extended access right. */ and
winlog.event_data.AccessMask : "0x100" and not
winlog.event_data.SubjectUserName : ("*$", "MSOL_*")</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_threat_mapping_407"></a>Threat mapping<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.6/docs/detections/prebuilt-rules/rule-details/potential-credential-access-via-dcsync.asciidoc">edit</a></h3>
</div></div></div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: OS Credential Dumping
</li>
<li class="listitem">
ID: T1003
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1003/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1003/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="potential-credential-access-via-dcsync-history"></a>Rule version history<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.6/docs/detections/prebuilt-rules/rule-details/potential-credential-access-via-dcsync.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
Version 102 (8.6.0 release)
</span>
</dt>
<dd>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Formatting only
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
Version 101 (8.5.0 release)
</span>
</dt>
<dd>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Formatting only
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
Version 5 (8.4.0 release)
</span>
</dt>
<dd>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Updated query, changed from:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">any where event.action == "Directory Service Access" and event.code
== "4662" and winlog.event_data.Properties : ( /* Control Access
Rights/Permissions Symbol */ "*DS-Replication-Get-Changes*",
"*DS-Replication-Get-Changes-All*", "*DS-Replication-Get-Changes-
In-Filtered-Set*", /* Identifying GUID used in ACE */
"*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*",
"*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*",
"*89e95b76-444d-4c62-991a-0facbeda640c*") /* The right to
perform an operation controlled by an extended access right. */
and winlog.event_data.AccessMask : "0x100" and not
winlog.event_data.SubjectUserName : ("*$", "MSOL_*")</pre>
</div>
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
Version 3 (8.3.0 release)
</span>
</dt>
<dd>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Formatting only
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
Version 2 (8.2.0 release)
</span>
</dt>
<dd>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Formatting only
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="potential-cookies-theft-via-browser-debugging.html">« Potential Cookies Theft via Browser Debugging</a>
</span>
<span class="next">
<a href="potential-credential-access-via-duplicatehandle-in-lsass.html">Potential Credential Access via DuplicateHandle in LSASS »</a>
</span>
</div>
</div>
</body>
</html>
