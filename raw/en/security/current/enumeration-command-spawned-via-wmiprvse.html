<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Enumeration Command Spawned via WMIPrvSE | Elastic Security [8.18] | Elastic</title>
<meta class="elastic" name="content" content="Enumeration Command Spawned via WMIPrvSE | Elastic Security [8.18]">

<link rel="home" href="index.html" title="Elastic Security [8.18]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="enumerating-domain-trusts-via-nltest-exe.html" title="Enumerating Domain Trusts via NLTEST.EXE"/>
<link rel="next" href="enumeration-of-administrator-accounts.html" title="Enumeration of Administrator Accounts"/>
<meta class="elastic" name="product_version" content="8.18"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.18"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.18"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="enumerating-domain-trusts-via-nltest-exe.html">« Enumerating Domain Trusts via NLTEST.EXE</a>
</span>
<span class="next">
<a href="enumeration-of-administrator-accounts.html">Enumeration of Administrator Accounts »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.18]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Enumeration Command Spawned via WMIPrvSE</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/enumeration-command-spawned-via-wmiprvse.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    A newer version is available. Check out the <a href="https://www.elastic.co/docs/reference/security/prebuilt-rules/rules/windows/execution_enumeration_via_wmiprvse">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="enumeration-command-spawned-via-wmiprvse"></a>Enumeration Command Spawned via WMIPrvSE</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/enumeration-command-spawned-via-wmiprvse.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies native Windows host and network enumeration commands spawned by the Windows Management Instrumentation Provider Service (WMIPrvSE).</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: eql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
endgame-*
</li>
<li class="listitem">
logs-crowdstrike.fdr*
</li>
<li class="listitem">
logs-endpoint.events.process-*
</li>
<li class="listitem">
logs-m365_defender.event-*
</li>
<li class="listitem">
logs-sentinel_one_cloud_funnel.*
</li>
<li class="listitem">
logs-system.security*
</li>
<li class="listitem">
logs-windows.forwarded*
</li>
<li class="listitem">
logs-windows.sysmon_operational-*
</li>
<li class="listitem">
winlogbeat-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.18/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>: None</p>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Execution
</li>
<li class="listitem">
Data Source: Elastic Endgame
</li>
<li class="listitem">
Data Source: Elastic Defend
</li>
<li class="listitem">
Data Source: Windows Security Event Logs
</li>
<li class="listitem">
Data Source: Microsoft Defender for Endpoint
</li>
<li class="listitem">
Data Source: Sysmon
</li>
<li class="listitem">
Data Source: SentinelOne
</li>
<li class="listitem">
Data Source: Crowdstrike
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 318</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_312"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/enumeration-command-spawned-via-wmiprvse.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Enumeration Command Spawned via WMIPrvSE</strong></span></p>
<p>Windows Management Instrumentation (WMI) is a powerful framework for managing data and operations on Windows systems. Adversaries exploit WMI to execute enumeration commands stealthily, leveraging the WMI Provider Service (WMIPrvSE) to gather system and network information. The detection rule identifies suspicious command executions initiated by WMIPrvSE, focusing on common enumeration tools while excluding benign use cases, thus highlighting potential malicious activity.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the process command line details to understand the specific enumeration command executed and its arguments, focusing on the process.command_line field.
</li>
<li class="listitem">
Investigate the parent process to confirm it is indeed WMIPrvSE by examining the process.parent.name field, ensuring the execution context aligns with potential misuse of WMI.
</li>
<li class="listitem">
Check the user context under which the process was executed to determine if it aligns with expected administrative activity or if it suggests unauthorized access.
</li>
<li class="listitem">
Correlate the event with other logs or alerts from the same host to identify any preceding or subsequent suspicious activities, such as lateral movement or privilege escalation attempts.
</li>
<li class="listitem">
Assess the network activity from the host around the time of the alert to identify any unusual outbound connections or data exfiltration attempts.
</li>
<li class="listitem">
Verify if the process execution is part of a known and legitimate administrative task or script by consulting with system administrators or reviewing change management records.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Routine administrative tasks using WMI may trigger the rule, such as network configuration checks or system diagnostics. To manage this, identify and exclude specific command patterns or arguments that are part of regular maintenance.
</li>
<li class="listitem">
Security tools like Tenable may use WMI for legitimate scans, which can be mistaken for malicious activity. Exclude processes with arguments related to known security tools, such as "tenable_mw_scan".
</li>
<li class="listitem">
Automated scripts or scheduled tasks that perform system enumeration for inventory or monitoring purposes can cause false positives. Review and whitelist these scripts by excluding their specific command lines or parent processes.
</li>
<li class="listitem">
Certain enterprise applications may use WMI for legitimate operations, such as querying system information. Identify these applications and create exceptions based on their process names or command line arguments.
</li>
<li class="listitem">
Regular use of network utilities by IT staff for troubleshooting can be flagged. Implement exclusions for known IT user accounts or specific command line patterns used during these activities.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Isolate the affected system from the network to prevent further unauthorized access or data exfiltration.
</li>
<li class="listitem">
Terminate any suspicious processes identified as being spawned by WMIPrvSE, especially those matching the enumeration tools listed in the detection query.
</li>
<li class="listitem">
Conduct a thorough review of recent WMI activity on the affected system to identify any additional unauthorized or suspicious commands executed.
</li>
<li class="listitem">
Reset credentials for any accounts that may have been compromised or used in the suspicious activity to prevent further unauthorized access.
</li>
<li class="listitem">
Restore the system from a known good backup if any malicious activity is confirmed and cannot be remediated through other means.
</li>
<li class="listitem">
Implement additional monitoring on the affected system and network to detect any recurrence of similar suspicious activities.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) or incident response team for further investigation and to determine if the threat has spread to other systems.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_323"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/enumeration-command-spawned-via-wmiprvse.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">process where host.os.type == "windows" and event.type == "start" and process.command_line != null and
  process.name:
  (
    "arp.exe", "dsquery.exe", "dsget.exe", "gpresult.exe", "hostname.exe", "ipconfig.exe", "nbtstat.exe",
    "net.exe", "net1.exe", "netsh.exe", "netstat.exe", "nltest.exe", "ping.exe", "qprocess.exe", "quser.exe",
    "qwinsta.exe", "reg.exe", "sc.exe", "systeminfo.exe", "tasklist.exe", "tracert.exe", "whoami.exe"
  ) and
  process.parent.name:"wmiprvse.exe" and
  not (
    process.name : "sc.exe" and process.args : "RemoteRegistry" and process.args : "start=" and
    process.args : ("demand", "disabled")
  ) and
  not process.args : "tenable_mw_scan"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Execution
</li>
<li class="listitem">
ID: TA0002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0002/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0002/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Windows Management Instrumentation
</li>
<li class="listitem">
ID: T1047
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1047/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1047/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Discovery
</li>
<li class="listitem">
ID: TA0007
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0007/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0007/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: System Network Configuration Discovery
</li>
<li class="listitem">
ID: T1016
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1016/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1016/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Internet Connection Discovery
</li>
<li class="listitem">
ID: T1016.001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1016/001/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1016/001/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Remote System Discovery
</li>
<li class="listitem">
ID: T1018
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1018/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1018/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Process Discovery
</li>
<li class="listitem">
ID: T1057
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1057/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1057/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Account Discovery
</li>
<li class="listitem">
ID: T1087
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1087/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1087/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Software Discovery
</li>
<li class="listitem">
ID: T1518
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1518/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1518/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="enumerating-domain-trusts-via-nltest-exe.html">« Enumerating Domain Trusts via NLTEST.EXE</a>
</span>
<span class="next">
<a href="enumeration-of-administrator-accounts.html">Enumeration of Administrator Accounts »</a>
</span>
</div>
</body>
</html>
