<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Multiple Microsoft 365 User Account Lockouts in Short Time Window | Elastic Security [8.19] | Elastic</title>
<meta class="elastic" name="content" content="Multiple Microsoft 365 User Account Lockouts in Short Time Window | Elastic Security [8.19]">

<link rel="home" href="index.html" title="Elastic Security [8.19]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="multiple-logon-failure-from-the-same-source-address.html" title="Multiple Logon Failure from the same Source Address"/>
<link rel="next" href="multiple-microsoft-entra-id-protection-alerts-by-user-principal.html" title="Multiple Microsoft Entra ID Protection Alerts by User Principal"/>
<meta class="elastic" name="product_version" content="8.19"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.19"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.19"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="multiple-logon-failure-from-the-same-source-address.html">« Multiple Logon Failure from the same Source Address</a>
</span>
<span class="next">
<a href="multiple-microsoft-entra-id-protection-alerts-by-user-principal.html">Multiple Microsoft Entra ID Protection Alerts by User Principal »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.19]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Multiple Microsoft 365 User Account Lockouts in Short Time Window</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/rule-details/multiple-microsoft-365-user-account-lockouts-in-short-time-window.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="multiple-microsoft-365-user-account-lockouts-in-short-time-window"></a>Multiple Microsoft 365 User Account Lockouts in Short Time Window</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/rule-details/multiple-microsoft-365-user-account-lockouts-in-short-time-window.asciidoc">edit</a></div>
</div></div></div>
<p>Detects a burst of Microsoft 365 user account lockouts within a short 5-minute window. A high number of IdsLocked login errors across multiple user accounts may indicate brute-force attempts for the same users resulting in lockouts.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: esql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>: None</p>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.19/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://learn.microsoft.com/en-us/security/operations/incident-response-playbook-password-spray" class="ulink" target="_top">https://learn.microsoft.com/en-us/security/operations/incident-response-playbook-password-spray</a>
</li>
<li class="listitem">
<a href="https://learn.microsoft.com/en-us/purview/audit-log-detailed-properties" class="ulink" target="_top">https://learn.microsoft.com/en-us/purview/audit-log-detailed-properties</a>
</li>
<li class="listitem">
<a href="https://securityscorecard.com/research/massive-botnet-targets-m365-with-stealthy-password-spraying-attacks/" class="ulink" target="_top">https://securityscorecard.com/research/massive-botnet-targets-m365-with-stealthy-password-spraying-attacks/</a>
</li>
<li class="listitem">
<a href="https://github.com/0xZDH/Omnispray" class="ulink" target="_top">https://github.com/0xZDH/Omnispray</a>
</li>
<li class="listitem">
<a href="https://github.com/0xZDH/o365spray" class="ulink" target="_top">https://github.com/0xZDH/o365spray</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Domain: SaaS
</li>
<li class="listitem">
Data Source: Microsoft 365
</li>
<li class="listitem">
Data Source: Microsoft 365 Audit Logs
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Use Case: Identity and Access Audit
</li>
<li class="listitem">
Tactic: Credential Access
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 3</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_622"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/rule-details/multiple-microsoft-365-user-account-lockouts-in-short-time-window.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and Analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating Multiple Microsoft 365 User Account Lockouts in Short Time Window</strong></span></p>
<p>Detects a burst of Microsoft 365 user account lockouts within a short 5-minute window. A high number of IdsLocked login errors across multiple user accounts may indicate brute-force attempts for the same users resulting in lockouts.</p>
<p>This rule uses ESQL aggregations and thus has dynamically generated fields. Correlation of the values in the alert document may need to be performed to the original sign-in and Graph events for further context.</p>
<p><span class="strong strong"><strong>Investigation Steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the <code class="literal">user_id_list</code>: Are specific naming patterns targeted (e.g., admin, helpdesk)?
</li>
<li class="listitem">
Examine <code class="literal">ip_list</code> and <code class="literal">source_orgs</code>: Look for suspicious ISPs or hosting providers.
</li>
<li class="listitem">
Check <code class="literal">duration_seconds</code>: A very short window with a high lockout rate often indicates automation.
</li>
<li class="listitem">
Confirm lockout policy thresholds with IAM or Entra ID admins. Did the policy trigger correctly?
</li>
<li class="listitem">
Use the <code class="literal">first_seen</code> and <code class="literal">last_seen</code> values to pivot into related authentication or audit logs.
</li>
<li class="listitem">
Correlate with any recent detection of password spraying or credential stuffing activity.
</li>
<li class="listitem">
Review the <code class="literal">request_type</code> field to identify which authentication methods were used (e.g., OAuth, SAML, etc.).
</li>
<li class="listitem">
Check for any successful logins from the same IP or ASN after the lockouts.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False Positive Analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Automated systems with stale credentials may cause repeated failed logins.
</li>
<li class="listitem">
Legitimate bulk provisioning or scripted tests could unintentionally cause account lockouts.
</li>
<li class="listitem">
Red team exercises or penetration tests may resemble the same lockout pattern.
</li>
<li class="listitem">
Some organizations may have a high volume of lockouts due to user behavior or legacy systems.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response Recommendations</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Notify affected users and confirm whether activity was expected or suspicious.
</li>
<li class="listitem">
Lock or reset credentials for impacted accounts.
</li>
<li class="listitem">
Block the source IP(s) or ASN temporarily using conditional access or firewall rules.
</li>
<li class="listitem">
Strengthen lockout and retry delay policies if necessary.
</li>
<li class="listitem">
Review the originating application(s) involved via <code class="literal">request_types</code>.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_662"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/rule-details/multiple-microsoft-365-user-account-lockouts-in-short-time-window.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">from logs-o365.audit-*
| mv_expand event.category
| eval
    Esql.time_window_date_trunc = date_trunc(5 minutes, @timestamp)
| where
    event.dataset == "o365.audit" and
    event.category == "authentication" and
    event.provider in ("AzureActiveDirectory", "Exchange") and
    event.action in ("UserLoginFailed", "PasswordLogonInitialAuthUsingPassword") and
    to_lower(o365.audit.ExtendedProperties.RequestType) rlike "(oauth.*||.*login.*)" and
    o365.audit.LogonError == "IdsLocked" and
    to_lower(o365.audit.UserId) != "not available" and
    o365.audit.Target.Type in ("0", "2", "6", "10") and
    source.`as`.organization.name != "MICROSOFT-CORP-MSN-as-BLOCK"
| stats
    Esql_priv.o365_audit_UserId_count_distinct = count_distinct(to_lower(o365.audit.UserId)),
    Esql_priv.o365_audit_UserId_values = values(to_lower(o365.audit.UserId)),
    Esql.source_ip_values = values(source.ip),
    Esql.source_ip_count_distinct = count_distinct(source.ip),
    Esql.source_as_organization_name_values = values(source.`as`.organization.name),
    Esql.source_as_organization_name_count_distinct = count_distinct(source.`as`.organization.name),
    Esql.source_geo_country_name_values = values(source.geo.country_name),
    Esql.source_geo_country_name_count_distinct = count_distinct(source.geo.country_name),
    Esql.o365_audit_ExtendedProperties_RequestType_values = values(to_lower(o365.audit.ExtendedProperties.RequestType)),
    Esql.timestamp_first_seen = min(@timestamp),
    Esql.timestamp_last_seen = max(@timestamp),
    Esql.event_count = count(*)
  by Esql.time_window_date_trunc
| eval
    Esql.event_duration_seconds = date_diff("seconds", Esql.timestamp_first_seen, Esql.timestamp_last_seen)
| keep
    Esql.time_window_date_trunc,
    Esql_priv.o365_audit_UserId_count_distinct,
    Esql_priv.o365_audit_UserId_values,
    Esql.source_ip_values,
    Esql.source_ip_count_distinct,
    Esql.source_as_organization_name_values,
    Esql.source_as_organization_name_count_distinct,
    Esql.source_geo_country_name_values,
    Esql.source_geo_country_name_count_distinct,
    Esql.o365_audit_ExtendedProperties_RequestType_values,
    Esql.timestamp_first_seen,
    Esql.timestamp_last_seen,
    Esql.event_count,
    Esql.event_duration_seconds
| where
    Esql_priv.o365_audit_UserId_count_distinct &gt;= 10 and
    Esql.event_count &gt;= 10 and
    Esql.event_duration_seconds &lt;= 300</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Brute Force
</li>
<li class="listitem">
ID: T1110
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1110/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1110/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="multiple-logon-failure-from-the-same-source-address.html">« Multiple Logon Failure from the same Source Address</a>
</span>
<span class="next">
<a href="multiple-microsoft-entra-id-protection-alerts-by-user-principal.html">Multiple Microsoft Entra ID Protection Alerts by User Principal »</a>
</span>
</div>
</body>
</html>
