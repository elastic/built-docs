<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Potential PowerShell Obfuscation via Concatenated Dynamic Command Invocation | Elastic Security [8.18] | Elastic</title>
<meta class="elastic" name="content" content="Potential PowerShell Obfuscation via Concatenated Dynamic Command Invocation | Elastic Security [8.18]">

<link rel="home" href="index.html" title="Elastic Security [8.18]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="potential-powershell-obfuscation-via-character-array-reconstruction.html" title="Potential PowerShell Obfuscation via Character Array Reconstruction"/>
<link rel="next" href="potential-powershell-obfuscation-via-high-numeric-character-proportion.html" title="Potential PowerShell Obfuscation via High Numeric Character Proportion"/>
<meta class="elastic" name="product_version" content="8.18"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.18"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.18"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="potential-powershell-obfuscation-via-character-array-reconstruction.html">« Potential PowerShell Obfuscation via Character Array Reconstruction</a>
</span>
<span class="next">
<a href="potential-powershell-obfuscation-via-high-numeric-character-proportion.html">Potential PowerShell Obfuscation via High Numeric Character Proportion »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.18]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Potential PowerShell Obfuscation via Concatenated Dynamic Command Invocation</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/potential-powershell-obfuscation-via-concatenated-dynamic-command-invocation.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    A newer version is available. Check out the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="potential-powershell-obfuscation-via-concatenated-dynamic-command-invocation"></a>Potential PowerShell Obfuscation via Concatenated Dynamic Command Invocation</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/potential-powershell-obfuscation-via-concatenated-dynamic-command-invocation.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies PowerShell scripts that use concatenated strings within dynamic command invocation (&amp;() or .()) as a form of obfuscation. These methods are designed to evade static analysis and bypass security protections such as the Antimalware Scan Interface (AMSI).</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: esql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>: None</p>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.18/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>: None</p>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Defense Evasion
</li>
<li class="listitem">
Data Source: PowerShell Logs
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 2</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_807"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/potential-powershell-obfuscation-via-concatenated-dynamic-command-invocation.asciidoc">edit</a></div>
</div></div></div>
<pre class="literallayout">## Triage and analysis</pre>

<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Potential PowerShell Obfuscation via Concatenated Dynamic Command Invocation</strong></span></p>
<p>PowerShell is a powerful scripting language used for task automation and configuration management in Windows environments. Adversaries exploit its capabilities by obfuscating commands to evade detection, often using concatenated strings in dynamic invocations. This detection rule identifies such obfuscation by analyzing script patterns, specifically looking for concatenated strings within dynamic command invocations, which are indicative of attempts to bypass security measures like AMSI. By counting these patterns, the rule effectively flags suspicious scripts, aiding in the identification of potential threats.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the <code class="literal">powershell.file.script_block_text</code> field to understand the content and purpose of the script, focusing on the concatenated strings and dynamic command invocations.
</li>
<li class="listitem">
Check the <code class="literal">host.name</code> and <code class="literal">user.id</code> fields to identify the machine and user account associated with the execution of the suspicious script, which can help determine if the activity is expected or anomalous.
</li>
<li class="listitem">
Analyze the <code class="literal">file.path</code> field to locate the script&#8217;s source or storage location, which may provide additional context or indicate if the script is part of a known application or process.
</li>
<li class="listitem">
Investigate the <code class="literal">powershell.file.script_block_id</code> and <code class="literal">powershell.sequence</code> fields to trace the execution sequence and correlate it with other related PowerShell activities, which might reveal a broader pattern of behavior.
</li>
<li class="listitem">
Assess the <code class="literal">agent.id</code> field to determine the specific endpoint agent involved, which can assist in further endpoint-specific investigations or actions.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Scripts with legitimate concatenated strings for dynamic command execution may trigger the rule. Review the script context to determine if the concatenation serves a valid administrative purpose.
</li>
<li class="listitem">
Automated scripts from trusted sources that use concatenation for modularity or readability might be flagged. Consider adding these scripts to an allowlist if they are verified as safe.
</li>
<li class="listitem">
Development or testing environments where PowerShell scripts are frequently modified and tested could generate false positives. Implement exceptions for known development hosts or user accounts.
</li>
<li class="listitem">
Security tools or monitoring solutions that use PowerShell for legitimate operations may inadvertently match the pattern. Identify these tools and exclude their operations from the rule.
</li>
<li class="listitem">
Regularly review and update the exclusion list to ensure it reflects the current environment and does not inadvertently allow malicious activity.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Isolate the affected host immediately to prevent further execution of potentially malicious scripts and limit lateral movement within the network.
</li>
<li class="listitem">
Terminate any suspicious PowerShell processes identified by the alert to halt the execution of obfuscated commands.
</li>
<li class="listitem">
Conduct a thorough review of the script block text and associated script block ID to understand the intent and potential impact of the obfuscated commands.
</li>
<li class="listitem">
Remove any unauthorized or malicious scripts from the affected system and ensure that all legitimate scripts are verified and signed.
</li>
<li class="listitem">
Restore the affected system from a known good backup if any malicious activity is confirmed, ensuring that all data integrity checks are performed.
</li>
<li class="listitem">
Escalate the incident to the security operations team for further analysis and to determine if additional systems have been compromised.
</li>
<li class="listitem">
Update endpoint protection and monitoring tools to enhance detection capabilities for similar obfuscation techniques, leveraging insights from the MITRE ATT&amp;CK framework.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_500"></a>Setup</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/potential-powershell-obfuscation-via-concatenated-dynamic-command-invocation.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Setup</strong></span></p>
<p>The <em>PowerShell Script Block Logging</em> logging policy must be enabled.
Steps to implement the logging policy with Advanced Audit Configuration:</p>
<pre class="screen">Computer Configuration &gt;
Administrative Templates &gt;
Windows PowerShell &gt;
Turn on PowerShell Script Block Logging (Enable)</pre>
<p>Steps to implement the logging policy via registry:</p>
<pre class="screen">reg add "hklm\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging" /v EnableScriptBlockLogging /t REG_DWORD /d 1</pre>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_851"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/potential-powershell-obfuscation-via-concatenated-dynamic-command-invocation.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">FROM logs-windows.powershell_operational* metadata _id, _version, _index
| WHERE event.code == "4104" and powershell.file.script_block_text LIKE "*+*"

// Replace string format expressions with 🔥 to enable counting the occurrence of the patterns we are looking for
// The emoji is used because it's unlikely to appear in scripts and has a consistent character length of 1
| EVAL replaced_with_fire = REPLACE(powershell.file.script_block_text, """[.&amp;]\(\s*(['"][A-Za-z0-9.-]+['"]\s*\+\s*)+['"][A-Za-z0-9.-]+['"]\s*\)""", "🔥")

// Count how many patterns were detected by calculating the number of 🔥 characters inserted
| EVAL count = LENGTH(replaced_with_fire) - LENGTH(REPLACE(replaced_with_fire, "🔥", ""))

// Keep the fields relevant to the query, although this is not needed as the alert is populated using _id
| KEEP count, replaced_with_fire, powershell.file.script_block_text, powershell.file.script_block_id, file.path, powershell.sequence, powershell.total, _id, _index, host.name, agent.id, user.id
| WHERE count &gt;= 1</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Defense Evasion
</li>
<li class="listitem">
ID: TA0005
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0005/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0005/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Obfuscated Files or Information
</li>
<li class="listitem">
ID: T1027
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1027/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1027/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Deobfuscate/Decode Files or Information
</li>
<li class="listitem">
ID: T1140
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1140/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1140/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Execution
</li>
<li class="listitem">
ID: TA0002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0002/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0002/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Command and Scripting Interpreter
</li>
<li class="listitem">
ID: T1059
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1059/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1059/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: PowerShell
</li>
<li class="listitem">
ID: T1059.001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1059/001/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1059/001/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="potential-powershell-obfuscation-via-character-array-reconstruction.html">« Potential PowerShell Obfuscation via Character Array Reconstruction</a>
</span>
<span class="next">
<a href="potential-powershell-obfuscation-via-high-numeric-character-proportion.html">Potential PowerShell Obfuscation via High Numeric Character Proportion »</a>
</span>
</div>
</body>
</html>
