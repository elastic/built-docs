<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AWS Service Quotas Multi-Region GetServiceQuota Requests | Elastic Security Solution [8.17] | Elastic</title>
<meta class="elastic" name="content" content="AWS Service Quotas Multi-Region GetServiceQuota Requests | Elastic Security Solution [8.17]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.17]"/>
<link rel="up" href="prebuilt-rule-8-17-4-prebuilt-rules-8-17-4-appendix.html" title="Appendix W: Downloadable rule update v8.17.4"/>
<link rel="prev" href="prebuilt-rule-8-17-4-aws-sts-getcalleridentity-api-called-for-the-first-time.html" title="AWS STS GetCallerIdentity API Called for the First Time"/>
<link rel="next" href="prebuilt-rule-8-17-4-aws-lambda-layer-added-to-existing-function.html" title="AWS Lambda Layer Added to Existing Function"/>
<meta class="elastic" name="product_version" content="8.17"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.17"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.17"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-17-4-aws-sts-getcalleridentity-api-called-for-the-first-time.html">« AWS STS GetCallerIdentity API Called for the First Time</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-17-4-aws-lambda-layer-added-to-existing-function.html">AWS Lambda Layer Added to Existing Function »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.17]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-17-4-prebuilt-rules-8-17-4-appendix.html">Downloadable rule update v8.17.4</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>AWS Service Quotas Multi-Region GetServiceQuota Requests</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-aws-service-quotas-multi-region-getservicequota-requests.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-17-4-aws-service-quotas-multi-region-getservicequota-requests"></a>AWS Service Quotas Multi-Region <code class="literal">GetServiceQuota</code> Requests</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-aws-service-quotas-multi-region-getservicequota-requests.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies when a single AWS resource is making <code class="literal">GetServiceQuota</code> API calls for the EC2 service quota L-1216C47A in more than 10 regions within a 30-second window. Quota code L-1216C47A represents on-demand instances which are used by adversaries to deploy malware and mine cryptocurrency. This could indicate a potential threat actor attempting to discover the AWS infrastructure across multiple regions using compromised credentials or a compromised instance.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: esql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>: None</p>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.17/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.sentinelone.com/labs/exploring-fbot-python-based-malware-targeting-cloud-and-payment-services/" class="ulink" target="_top">https://www.sentinelone.com/labs/exploring-fbot-python-based-malware-targeting-cloud-and-payment-services/</a>
</li>
<li class="listitem">
<a href="https://docs.aws.amazon.com/servicequotas/2019-06-24/apireference/API_GetServiceQuota.html" class="ulink" target="_top">https://docs.aws.amazon.com/servicequotas/2019-06-24/apireference/API_GetServiceQuota.html</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Data Source: AWS
</li>
<li class="listitem">
Data Source: Amazon Web Services
</li>
<li class="listitem">
Data Source: AWS Service Quotas
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Discovery
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 3</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4006"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-aws-service-quotas-multi-region-getservicequota-requests.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating AWS Service Quotas Multi-Region <code class="literal">GetServiceQuota</code> Requests</strong></span></p>
<p>AWS Service Quotas manage resource limits across AWS services, crucial for maintaining operational boundaries. Adversaries may exploit <code class="literal">GetServiceQuota</code> API calls to probe AWS infrastructure, seeking vulnerabilities for deploying threats like cryptocurrency miners. The detection rule identifies unusual multi-region queries for EC2 quotas, signaling potential credential compromise or unauthorized access attempts.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the AWS CloudTrail logs to identify the specific user or role associated with the <code class="literal">aws.cloudtrail.user_identity.arn</code> field that triggered the alert. Determine if this user or role should have access to multiple regions.
</li>
<li class="listitem">
Examine the <code class="literal">cloud.region</code> field to identify which regions were accessed and verify if these regions are typically used by your organization. Investigate any unfamiliar regions for unauthorized activity.
</li>
<li class="listitem">
Check the AWS IAM policies and permissions associated with the identified user or role to ensure they align with the principle of least privilege. Look for any recent changes or anomalies in permissions.
</li>
<li class="listitem">
Investigate the source IP addresses and locations from which the <code class="literal">GetServiceQuota</code> API calls were made to determine if they match expected patterns for your organization. Look for any unusual or suspicious IP addresses.
</li>
<li class="listitem">
Review recent activity logs for the identified user or role to detect any other unusual or unauthorized actions, such as attempts to launch EC2 instances or access other AWS services.
</li>
<li class="listitem">
If a compromise is suspected, consider rotating the credentials for the affected user or role and implementing additional security measures, such as multi-factor authentication (MFA) and enhanced monitoring.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Legitimate multi-region operations: Organizations with a global presence may have legitimate reasons for querying EC2 service quotas across multiple regions. To handle this, users can create exceptions for known accounts or roles that regularly perform such operations.
</li>
<li class="listitem">
Automated infrastructure management tools: Some tools or scripts designed for infrastructure management might perform multi-region <code class="literal">GetServiceQuota</code> requests as part of their normal operation. Users should identify these tools and exclude their activity from triggering alerts by whitelisting their associated user identities or ARNs.
</li>
<li class="listitem">
Testing and development activities: Developers or testers might intentionally perform multi-region queries during testing phases. Users can mitigate false positives by setting up temporary exceptions for specific time frames or user identities involved in testing.
</li>
<li class="listitem">
Cloud service providers or partners: Third-party services or partners managing AWS resources on behalf of an organization might generate similar patterns. Users should establish trust relationships and exclude these entities from detection by verifying their activities and adding them to an exception list.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the AWS account or IAM user identified in the alert to prevent further unauthorized access. This can be done by disabling the access keys or suspending the account temporarily.
</li>
<li class="listitem">
Conduct a thorough review of the AWS CloudTrail logs for the identified user or resource to determine the extent of the unauthorized activity and identify any other potentially compromised resources.
</li>
<li class="listitem">
Rotate all access keys and passwords associated with the compromised account or IAM user to prevent further unauthorized access.
</li>
<li class="listitem">
Implement additional security measures such as enabling multi-factor authentication (MFA) for all IAM users and roles to enhance account security.
</li>
<li class="listitem">
Notify the security operations team and relevant stakeholders about the potential compromise and the steps being taken to remediate the issue.
</li>
<li class="listitem">
If evidence of compromise is confirmed, consider engaging AWS Support or a third-party incident response team for further investigation and assistance.
</li>
<li class="listitem">
Review and update IAM policies and permissions to ensure the principle of least privilege is enforced, reducing the risk of future unauthorized access attempts.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5023"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-aws-service-quotas-multi-region-getservicequota-requests.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">from logs-aws.cloudtrail-*

// filter for GetServiceQuota API calls
| where event.dataset == "aws.cloudtrail" and event.provider == "servicequotas.amazonaws.com" and event.action == "GetServiceQuota"

// truncate the timestamp to a 30-second window
| eval target_time_window = DATE_TRUNC(30 seconds, @timestamp)

// pre-process the request parameters to extract the service code and quota code
| dissect aws.cloudtrail.request_parameters "{%{?service_code_key}=%{service_code}, %{?quota_code_key}=%{quota_code}}"

// filter for EC2 service quota L-1216C47A (vCPU on-demand instances)
| where service_code == "ec2" and quota_code == "L-1216C47A"

// keep only the relevant fields
| keep target_time_window, aws.cloudtrail.user_identity.arn, cloud.region, service_code, quota_code

// count the number of unique regions and total API calls within the 30-second window
| stats region_count = count_distinct(cloud.region), window_count = count(*) by target_time_window, aws.cloudtrail.user_identity.arn

// filter for resources making DescribeInstances API calls in more than 10 regions within the 30-second window
| where region_count &gt;= 10 and window_count &gt;= 10

// sort the results by time windows in descending order
| sort target_time_window desc</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Discovery
</li>
<li class="listitem">
ID: TA0007
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0007/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0007/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Cloud Infrastructure Discovery
</li>
<li class="listitem">
ID: T1580
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1580/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1580/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-17-4-aws-sts-getcalleridentity-api-called-for-the-first-time.html">« AWS STS GetCallerIdentity API Called for the First Time</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-17-4-aws-lambda-layer-added-to-existing-function.html">AWS Lambda Layer Added to Existing Function »</a>
</span>
</div>
</body>
</html>
