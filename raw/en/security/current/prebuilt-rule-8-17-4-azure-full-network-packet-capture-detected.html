<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Azure Full Network Packet Capture Detected | Elastic Security Solution [8.17] | Elastic</title>
<meta class="elastic" name="content" content="Azure Full Network Packet Capture Detected | Elastic Security Solution [8.17]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.17]"/>
<link rel="up" href="prebuilt-rule-8-17-4-prebuilt-rules-8-17-4-appendix.html" title="Appendix W: Downloadable rule update v8.17.4"/>
<link rel="prev" href="prebuilt-rule-8-17-4-azure-entra-mfa-totp-brute-force-attempts.html" title="Azure Entra MFA TOTP Brute Force Attempts"/>
<link rel="next" href="prebuilt-rule-8-17-4-entra-id-device-code-auth-with-broker-client.html" title="Entra ID Device Code Auth with Broker Client"/>
<meta class="elastic" name="product_version" content="8.17"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.17"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.17"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-17-4-azure-entra-mfa-totp-brute-force-attempts.html">« Azure Entra MFA TOTP Brute Force Attempts</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-17-4-entra-id-device-code-auth-with-broker-client.html">Entra ID Device Code Auth with Broker Client »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.17]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-17-4-prebuilt-rules-8-17-4-appendix.html">Downloadable rule update v8.17.4</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Azure Full Network Packet Capture Detected</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-azure-full-network-packet-capture-detected.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-17-4-azure-full-network-packet-capture-detected"></a>Azure Full Network Packet Capture Detected</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-azure-full-network-packet-capture-detected.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies potential full network packet capture in Azure. Packet Capture is an Azure Network Watcher feature that can be used to inspect network traffic. This feature can potentially be abused to read sensitive data from unencrypted internal traffic.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: query</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-azure*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-25m (<a href="/guide/en/elasticsearch/reference/8.17/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/resource-provider-operations" class="ulink" target="_top">https://docs.microsoft.com/en-us/azure/role-based-access-control/resource-provider-operations</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Data Source: Azure
</li>
<li class="listitem">
Tactic: Credential Access
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 104</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Austin Songer
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4082"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-azure-full-network-packet-capture-detected.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Azure Full Network Packet Capture Detected</strong></span></p>
<p>Azure&#8217;s Packet Capture is a feature of Network Watcher that allows for the inspection of network traffic, useful for diagnosing network issues. However, if misused, it can capture sensitive data from unencrypted traffic, posing a security risk. Adversaries might exploit this to access credentials or other sensitive information. The detection rule identifies suspicious packet capture activities by monitoring specific Azure activity logs for successful operations, helping to flag potential misuse.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the Azure activity logs to identify the specific user or service principal associated with the packet capture operation by examining the <code class="literal">azure.activitylogs.operation_name</code> and <code class="literal">event.dataset</code> fields.
</li>
<li class="listitem">
Check the timestamp of the detected packet capture activity to determine the exact time frame of the event and correlate it with any other suspicious activities or changes in the environment.
</li>
<li class="listitem">
Investigate the source and destination IP addresses involved in the packet capture to understand the scope and potential impact, focusing on any unencrypted traffic that might have been captured.
</li>
<li class="listitem">
Verify the legitimacy of the packet capture request by contacting the user or team responsible for the operation to confirm if it was authorized and necessary for troubleshooting or other legitimate purposes.
</li>
<li class="listitem">
Assess the risk of exposed sensitive data by identifying any critical systems or services that were part of the captured network traffic, especially those handling credentials or personal information.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Routine network diagnostics by authorized personnel can trigger the rule. To manage this, create exceptions for specific user accounts or IP addresses known to perform regular diagnostics.
</li>
<li class="listitem">
Automated network monitoring tools might initiate packet captures as part of their normal operations. Identify these tools and exclude their activities from triggering alerts.
</li>
<li class="listitem">
Scheduled maintenance activities often involve packet captures for performance analysis. Document these schedules and configure the rule to ignore captures during these periods.
</li>
<li class="listitem">
Development and testing environments may frequently use packet capture for debugging purposes. Exclude these environments by filtering based on resource tags or environment identifiers.
</li>
<li class="listitem">
Legitimate security audits may involve packet capture to assess network security. Coordinate with the audit team to whitelist their activities during the audit period.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected network segment to prevent further unauthorized packet capture and potential data exfiltration.
</li>
<li class="listitem">
Revoke any suspicious or unauthorized access to Azure Network Watcher and related resources to prevent further misuse.
</li>
<li class="listitem">
Conduct a thorough review of the captured network traffic logs to identify any sensitive data exposure and assess the potential impact.
</li>
<li class="listitem">
Reset credentials and access tokens for any accounts or services that may have been compromised due to exposed unencrypted traffic.
</li>
<li class="listitem">
Implement network encryption protocols to protect sensitive data in transit and reduce the risk of future packet capture exploitation.
</li>
<li class="listitem">
Escalate the incident to the security operations team for further investigation and to determine if additional security measures are necessary.
</li>
<li class="listitem">
Enhance monitoring and alerting for Azure Network Watcher activities to detect and respond to similar threats more effectively in the future.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_970"></a>Setup</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-azure-full-network-packet-capture-detected.asciidoc">edit</a></div>
</div></div></div>
<p>The Azure Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5098"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-azure-full-network-packet-capture-detected.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset:azure.activitylogs and azure.activitylogs.operation_name:
    (
        MICROSOFT.NETWORK/*/STARTPACKETCAPTURE/ACTION or
        MICROSOFT.NETWORK/*/VPNCONNECTIONS/STARTPACKETCAPTURE/ACTION or
        MICROSOFT.NETWORK/*/PACKETCAPTURES/WRITE
    ) and
event.outcome:(Success or success)</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Credential Access
</li>
<li class="listitem">
ID: TA0006
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0006/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0006/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Network Sniffing
</li>
<li class="listitem">
ID: T1040
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1040/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1040/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-17-4-azure-entra-mfa-totp-brute-force-attempts.html">« Azure Entra MFA TOTP Brute Force Attempts</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-17-4-entra-id-device-code-auth-with-broker-client.html">Entra ID Device Code Auth with Broker Client »</a>
</span>
</div>
</body>
</html>
