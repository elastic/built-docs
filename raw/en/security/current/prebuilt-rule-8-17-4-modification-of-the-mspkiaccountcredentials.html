<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Modification of the msPKIAccountCredentials | Elastic Security Solution [8.17] | Elastic</title>
<meta class="elastic" name="content" content="Modification of the msPKIAccountCredentials | Elastic Security Solution [8.17]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.17]"/>
<link rel="up" href="prebuilt-rule-8-17-4-prebuilt-rules-8-17-4-appendix.html" title="Appendix W: Downloadable rule update v8.17.4"/>
<link rel="prev" href="prebuilt-rule-8-17-4-process-created-with-a-duplicated-token.html" title="Process Created with a Duplicated Token"/>
<link rel="next" href="prebuilt-rule-8-17-4-unsigned-dll-loaded-by-dns-service.html" title="Unsigned DLL loaded by DNS Service"/>
<meta class="elastic" name="product_version" content="8.17"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.17"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.17"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-17-4-process-created-with-a-duplicated-token.html">« Process Created with a Duplicated Token</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-17-4-unsigned-dll-loaded-by-dns-service.html">Unsigned DLL loaded by DNS Service »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.17]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-17-4-prebuilt-rules-8-17-4-appendix.html">Downloadable rule update v8.17.4</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Modification of the msPKIAccountCredentials</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-modification-of-the-mspkiaccountcredentials.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-17-4-modification-of-the-mspkiaccountcredentials"></a>Modification of the msPKIAccountCredentials</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-modification-of-the-mspkiaccountcredentials.asciidoc">edit</a></div>
</div></div></div>
<p>Identify the modification of the msPKIAccountCredentials attribute in an Active Directory User Object. Attackers can abuse the credentials roaming feature to overwrite an arbitrary file for privilege escalation. ms-PKI-AccountCredentials contains binary large objects (BLOBs) of encrypted credential objects from the credential manager store, private keys, certificates, and certificate requests.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: query</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
winlogbeat-*
</li>
<li class="listitem">
logs-system.*
</li>
<li class="listitem">
logs-windows.*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.17/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.mandiant.com/resources/blog/apt29-windows-credential-roaming" class="ulink" target="_top">https://www.mandiant.com/resources/blog/apt29-windows-credential-roaming</a>
</li>
<li class="listitem">
<a href="https://social.technet.microsoft.com/wiki/contents/articles/11483.windows-credential-roaming.aspx" class="ulink" target="_top">https://social.technet.microsoft.com/wiki/contents/articles/11483.windows-credential-roaming.aspx</a>
</li>
<li class="listitem">
<a href="https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5136" class="ulink" target="_top">https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5136</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Endpoint
</li>
<li class="listitem">
OS: Windows
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Data Source: Active Directory
</li>
<li class="listitem">
Tactic: Privilege Escalation
</li>
<li class="listitem">
Use Case: Active Directory Monitoring
</li>
<li class="listitem">
Data Source: System
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 114</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4954"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-modification-of-the-mspkiaccountcredentials.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating Modification of the msPKIAccountCredentials</strong></span></p>
<p>The msPKIAccountCredentials attribute in Active Directory stores encrypted credential data, including private keys and certificates. Adversaries may exploit this by altering the attribute to escalate privileges, potentially overwriting files. The detection rule identifies such modifications by monitoring specific directory service events, focusing on changes to this attribute, excluding actions by the system account, thus highlighting unauthorized access attempts.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the event logs for the specific event code 5136 to gather details about the modification event, including the timestamp and the user account involved.
</li>
<li class="listitem">
Examine the winlog.event_data.SubjectUserSid field to identify the user who attempted the modification, ensuring it is not the system account (S-1-5-18).
</li>
<li class="listitem">
Investigate the history and behavior of the identified user account to determine if there are any previous suspicious activities or anomalies.
</li>
<li class="listitem">
Check for any recent changes or anomalies in the affected Active Directory User Object, focusing on the msPKIAccountCredentials attribute.
</li>
<li class="listitem">
Assess the potential impact of the modification by identifying any files or systems that may have been affected by the altered credentials.
</li>
<li class="listitem">
Correlate this event with other security alerts or logs to identify any patterns or coordinated activities that might indicate a broader attack.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Routine administrative tasks by IT personnel may trigger the rule. To manage this, create exceptions for specific user accounts or groups known to perform these tasks regularly.
</li>
<li class="listitem">
Scheduled maintenance scripts or automated processes that modify Active Directory attributes could be mistaken for unauthorized changes. Identify these processes and exclude their associated user accounts or service accounts from the rule.
</li>
<li class="listitem">
Software updates or installations that require changes to user credentials might cause false positives. Document these events and adjust the rule to ignore modifications during known update windows.
</li>
<li class="listitem">
Legitimate changes made by third-party applications integrated with Active Directory can be flagged. Review and whitelist these applications by excluding their associated user accounts or service accounts.
</li>
<li class="listitem">
Temporary changes during incident response or security audits may appear suspicious. Coordinate with security teams to ensure these activities are recognized and excluded from triggering alerts.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Immediately isolate the affected system from the network to prevent further unauthorized access or data exfiltration.
</li>
<li class="listitem">
Revoke any potentially compromised certificates and private keys associated with the affected msPKIAccountCredentials attribute to prevent misuse.
</li>
<li class="listitem">
Conduct a thorough review of recent changes in Active Directory, focusing on the msPKIAccountCredentials attribute, to identify any unauthorized modifications or access patterns.
</li>
<li class="listitem">
Reset passwords and regenerate keys for any accounts or services that may have been affected to ensure that compromised credentials are no longer valid.
</li>
<li class="listitem">
Escalate the incident to the security operations center (SOC) or incident response team for further investigation and to determine the full scope of the breach.
</li>
<li class="listitem">
Implement additional monitoring on the affected systems and accounts to detect any further suspicious activity or attempts to exploit similar vulnerabilities.
</li>
<li class="listitem">
Review and update access controls and permissions in Active Directory to ensure that only authorized personnel have the ability to modify sensitive attributes like msPKIAccountCredentials.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_1558"></a>Setup</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-modification-of-the-mspkiaccountcredentials.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Setup</strong></span></p>
<p>The <em>Audit Directory Service Changes</em> logging policy must be configured for (Success, Failure).
Steps to implement the logging policy with Advanced Audit Configuration:</p>
<pre class="screen">Computer Configuration &gt;
Policies &gt;
Windows Settings &gt;
Security Settings &gt;
Advanced Audit Policies Configuration &gt;
Audit Policies &gt;
DS Access &gt;
Audit Directory Service Changes (Success,Failure)</pre>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5908"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-4/prebuilt-rule-8-17-4-modification-of-the-mspkiaccountcredentials.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.code:"5136" and winlog.event_data.AttributeLDAPDisplayName:"msPKIAccountCredentials" and
  winlog.event_data.OperationType:"%%14674" and
  not winlog.event_data.SubjectUserSid : "S-1-5-18"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Privilege Escalation
</li>
<li class="listitem">
ID: TA0004
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0004/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0004/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Exploitation for Privilege Escalation
</li>
<li class="listitem">
ID: T1068
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1068/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1068/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-17-4-process-created-with-a-duplicated-token.html">« Process Created with a Duplicated Token</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-17-4-unsigned-dll-loaded-by-dns-service.html">Unsigned DLL loaded by DNS Service »</a>
</span>
</div>
</body>
</html>
