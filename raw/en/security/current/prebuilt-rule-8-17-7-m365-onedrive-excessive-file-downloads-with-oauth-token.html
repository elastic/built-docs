<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>M365 OneDrive Excessive File Downloads with OAuth Token | Elastic Security Solution [8.17] | Elastic</title>
<meta class="elastic" name="content" content="M365 OneDrive Excessive File Downloads with OAuth Token | Elastic Security Solution [8.17]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.17]"/>
<link rel="up" href="prebuilt-rule-8-17-7-prebuilt-rules-8-17-7-appendix.html" title="Appendix Z: Downloadable rule update v8.17.7"/>
<link rel="prev" href="prebuilt-rule-8-17-7-potential-azure-openai-model-theft.html" title="Potential Azure OpenAI Model Theft"/>
<link rel="next" href="prebuilt-rule-8-17-7-high-number-of-egress-network-connections-from-unusual-executable.html" title="High Number of Egress Network Connections from Unusual Executable"/>
<meta class="elastic" name="product_version" content="8.17"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.17"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.17"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-17-7-potential-azure-openai-model-theft.html">« Potential Azure OpenAI Model Theft</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-17-7-high-number-of-egress-network-connections-from-unusual-executable.html">High Number of Egress Network Connections from Unusual Executable »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.17]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-17-7-prebuilt-rules-8-17-7-appendix.html">Downloadable rule update v8.17.7</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>M365 OneDrive Excessive File Downloads with OAuth Token</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-7/prebuilt-rule-8-17-7-m365-onedrive-excessive-file-downloads-with-oauth-token.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-17-7-m365-onedrive-excessive-file-downloads-with-oauth-token"></a>M365 OneDrive Excessive File Downloads with OAuth Token</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-7/prebuilt-rule-8-17-7-m365-onedrive-excessive-file-downloads-with-oauth-token.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies when an excessive number of files are downloaded from OneDrive using OAuth authentication. Adversaries may conduct phishing campaigns to steal OAuth tokens and impersonate users. These access tokens can then be used to download files from OneDrive.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: esql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>: None</p>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-9m (<a href="/guide/en/elasticsearch/reference/8.17/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.volexity.com/blog/2025/02/13/multiple-russian-threat-actors-targeting-microsoft-device-code-authentication/" class="ulink" target="_top">https://www.volexity.com/blog/2025/02/13/multiple-russian-threat-actors-targeting-microsoft-device-code-authentication/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Domain: SaaS
</li>
<li class="listitem">
Data Source: Microsoft 365
</li>
<li class="listitem">
Data Source: SharePoint
</li>
<li class="listitem">
Data Source: OneDrive
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Collection
</li>
<li class="listitem">
Tactic: Exfiltration
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 1</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_5218"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-7/prebuilt-rule-8-17-7-m365-onedrive-excessive-file-downloads-with-oauth-token.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and Analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating M365 OneDrive Excessive File Downloads with OAuth Token</strong></span></p>
<p>This rule detects an excessive number of files downloaded from OneDrive using OAuth authentication. Threat actors may use OAuth phishing attacks, such as <span class="strong strong"><strong>Device Code Authentication phishing</strong></span>, to obtain valid access tokens and perform unauthorized data exfiltration. This method allows adversaries to bypass traditional authentication mechanisms, making it a stealthy and effective technique.</p>
<p>This rule leverages ES|QL aggregations which limit the field values available in the alert document. To investigate further, it is recommended to identify the original documents ingested.</p>
<p><span class="strong strong"><strong>Possible Investigation Steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the <code class="literal">o365.audit.UserId</code> field to identify the user who performed the downloads. Check if this user typically downloads large amounts of data from OneDrive.
</li>
<li class="listitem">
Correlate <code class="literal">o365.audit.UserId</code> with Entra Sign-In logs to verify the authentication method used and determine if it was expected for this user.
</li>
<li class="listitem">
Review the authentication method used. If OAuth authentication was used, investigate whether it was expected for this user.
</li>
<li class="listitem">
Identify the client application used for authentication. Determine if it is a legitimate enterprise-approved app or an unauthorized third-party application.
</li>
<li class="listitem">
Check the number of unique files downloaded. If a user downloads a high volume of unique files in a short period, it may indicate data exfiltration.
</li>
<li class="listitem">
Analyze the file types and directories accessed to determine if sensitive or confidential data was involved.
</li>
<li class="listitem">
Investigate the source IP address and geolocation of the download activity. If it originates from an unusual or anonymized location, further scrutiny is needed.
</li>
<li class="listitem">
Review other recent activities from the same user, such as file access, sharing, or permission changes, that may indicate further compromise.
</li>
<li class="listitem">
Check for signs of session persistence using OAuth. If Azure sign-in logs are correlated where <code class="literal">authentication_protocol</code> or <code class="literal">originalTransferMethod</code> field shows <code class="literal">deviceCode</code>, the session was established through device code authentication.
</li>
<li class="listitem">
Look for multiple authentication attempts from different devices or locations within a short timeframe, which could indicate unauthorized access.
</li>
<li class="listitem">
Investigate if other OAuth-related anomalies exist, such as consent grants for unfamiliar applications or unexpected refresh token activity.
</li>
<li class="listitem">
Review the <code class="literal">file.directory</code> value from the original documents to identify the specific folders or paths where the files were downloaded.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False Positive Analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Verify if the user regularly downloads large batches of files as part of their job function.
</li>
<li class="listitem">
Determine if the downloads were triggered by an authorized automated process, such as a data backup or synchronization tool.
</li>
<li class="listitem">
Confirm if the detected OAuth application is approved for enterprise use and aligns with expected usage patterns.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and Remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If unauthorized activity is confirmed, revoke the OAuth token used and terminate active OneDrive sessions.
</li>
<li class="listitem">
Reset the affected user&#8217;s password and require reauthentication to prevent continued unauthorized access.
</li>
<li class="listitem">
Restrict OAuth app permissions and enforce conditional access policies to limit authentication to trusted devices and applications.
</li>
<li class="listitem">
Monitor for additional signs of compromise, such as unusual email forwarding rules, external sharing of OneDrive files, or privilege escalation attempts.
</li>
<li class="listitem">
Educate users on OAuth phishing risks and encourage the use of <span class="strong strong"><strong>Microsoft Defender for Office 365 Safe Links</strong></span> to mitigate credential-based attacks.
</li>
<li class="listitem">
Enable continuous monitoring for OAuth authentication anomalies using <span class="strong strong"><strong>Microsoft Entra ID sign-in logs</strong></span> and security tools.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_6198"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.17/docs/detections/prebuilt-rules/downloadable-packages/8-17-7/prebuilt-rule-8-17-7-m365-onedrive-excessive-file-downloads-with-oauth-token.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">FROM logs-o365.audit-*
| WHERE @timestamp &gt; now() - 14 day
| WHERE
    event.dataset == "o365.audit" and

    // filter on files downloaded from OneDrive
    event.provider == "OneDrive" and
    event.action == "FileDownloaded" and

    // filter on OAuth authentication which encompasses device code workflow
    o365.audit.AuthenticationType == "OAuth"
    and event.outcome == "success"
// bucket authentication attempts by 1 minute
| EVAL target_time_window = DATE_TRUNC(1 minutes, @timestamp)
| KEEP target_time_window, o365.audit.UserId, file.name, source.ip

// aggregate on unique file names and download attempts
| STATS unique_file_count = count_distinct(file.name), download_attempt_count = count(*) BY target_time_window, o365.audit.UserId, source.ip

// adjustable range for "excessive" unique files that were downloaded
| WHERE unique_file_count &gt;= 25</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Collection
</li>
<li class="listitem">
ID: TA0009
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0009/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0009/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Data from Cloud Storage
</li>
<li class="listitem">
ID: T1530
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1530/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1530/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Exfiltration
</li>
<li class="listitem">
ID: TA0010
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0010/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0010/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-17-7-potential-azure-openai-model-theft.html">« Potential Azure OpenAI Model Theft</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-17-7-high-number-of-egress-network-connections-from-unusual-executable.html">High Number of Egress Network Connections from Unusual Executable »</a>
</span>
</div>
</body>
</html>
