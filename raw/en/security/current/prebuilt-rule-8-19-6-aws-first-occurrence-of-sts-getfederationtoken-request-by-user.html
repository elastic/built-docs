<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AWS First Occurrence of STS GetFederationToken Request by User | Elastic Security [8.19] | Elastic</title>
<meta class="elastic" name="content" content="AWS First Occurrence of STS GetFederationToken Request by User | Elastic Security [8.19]">

<link rel="home" href="index.html" title="Elastic Security [8.19]"/>
<link rel="up" href="prebuilt-rule-8-19-6-prebuilt-rules-8-19-6-appendix.html" title="Appendix Y: Downloadable rule update v8.19.6"/>
<link rel="prev" href="prebuilt-rule-8-19-6-first-time-seen-aws-secret-value-accessed-in-secrets-manager.html" title="First Time Seen AWS Secret Value Accessed in Secrets Manager"/>
<link rel="next" href="prebuilt-rule-8-19-6-aws-sts-getcalleridentity-api-called-for-the-first-time.html" title="AWS STS GetCallerIdentity API Called for the First Time"/>
<meta class="elastic" name="product_version" content="8.19"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.19"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.19"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-19-6-first-time-seen-aws-secret-value-accessed-in-secrets-manager.html">« First Time Seen AWS Secret Value Accessed in Secrets Manager</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-19-6-aws-sts-getcalleridentity-api-called-for-the-first-time.html">AWS STS GetCallerIdentity API Called for the First Time »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.19]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-19-6-prebuilt-rules-8-19-6-appendix.html">Downloadable rule update v8.19.6</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>AWS First Occurrence of STS GetFederationToken Request by User</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-6/prebuilt-rule-8-19-6-aws-first-occurrence-of-sts-getfederationtoken-request-by-user.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-19-6-aws-first-occurrence-of-sts-getfederationtoken-request-by-user"></a>AWS First Occurrence of STS GetFederationToken Request by User</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-6/prebuilt-rule-8-19-6-aws-first-occurrence-of-sts-getfederationtoken-request-by-user.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies the first occurrence of an AWS Security Token Service (STS) GetFederationToken request made by a user. The GetFederationToken API call allows users to request temporary security credentials to access AWS resources. The maximum expiration period for these tokens is 36 hours and they can be used to create a console signin token even for identities that don&#8217;t already have one. Adversaries may use this API to obtain temporary credentials for persistence and to bypass IAM API call limitations by gaining console access.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-aws.cloudtrail-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-6m (<a href="/guide/en/elasticsearch/reference/8.19/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://hackingthe.cloud/aws/post_exploitation/survive_access_key_deletion_with_sts_getfederationtoken/" class="ulink" target="_top">https://hackingthe.cloud/aws/post_exploitation/survive_access_key_deletion_with_sts_getfederationtoken/</a>
</li>
<li class="listitem">
<a href="https://www.crowdstrike.com/en-us/blog/how-adversaries-persist-with-aws-user-federation/" class="ulink" target="_top">https://www.crowdstrike.com/en-us/blog/how-adversaries-persist-with-aws-user-federation/</a>
</li>
<li class="listitem">
<a href="https://medium.com/@adan.alvarez/how-attackers-persist-in-aws-using-getfederationtoken-a-simple-and-effective-technique-used-in-the-987ec1f0bdfe/" class="ulink" target="_top">https://medium.com/@adan.alvarez/how-attackers-persist-in-aws-using-getfederationtoken-a-simple-and-effective-technique-used-in-the-987ec1f0bdfe/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Data Source: Amazon Web Services
</li>
<li class="listitem">
Data Source: AWS
</li>
<li class="listitem">
Data Source: AWS STS
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Defense Evasion
</li>
<li class="listitem">
Tactic: Persistence
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 5</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4337"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-6/prebuilt-rule-8-19-6-aws-first-occurrence-of-sts-getfederationtoken-request-by-user.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<div class="quoteblock">
<blockquote>
<p><span class="strong strong"><strong>Disclaimer</strong></span>:
This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.</p>
</blockquote>
</div>
<p><span class="strong strong"><strong>Investigating AWS First Occurrence of STS GetFederationToken Request by User</strong></span></p>
<p>AWS Security Token Service (STS) enables users to request temporary credentials for accessing AWS resources. While beneficial for legitimate use, adversaries may exploit this to gain unauthorized access. These credentials will remain active for the duration specified (maximum 36 hours), even if the initial compromised identity is deleted. They can also be used to request a console signin token which allows the adversary to make sensitive IAM API calls which would otherwise be denied with the federation token alone. The detection rule identifies unusual activity by flagging the first instance of a <code class="literal">GetFederationToken</code> request by a user helping to uncover potential misuse aimed at evading defenses and gaining persistence.</p>
<p><span class="strong strong"><strong>Possible investigation steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Review the specific user account associated with the <code class="literal">GetFederationToken</code> request to determine if the activity aligns with their typical behavior and role within the organization.
</li>
<li class="listitem">
Examine the AWS CloudTrail logs for additional context around the time of the <code class="literal">GetFederationToken</code> request, looking for any other unusual or suspicious activities by the same user or related accounts.
</li>
<li class="listitem">
Check the <code class="literal">source.ip</code> and <code class="literal">source.geo</code> fields of the request to identify if it originates from an expected or unexpected location.
</li>
<li class="listitem">
View the <code class="literal">aws.cloudtrail.response_elements</code> to find the created <code class="literal">federatedUser.arn</code>. Investigate the resources accessed by this Federated User to assess if there was any suspicious activity.
</li>
<li class="listitem">
Consult with the requesting user <code class="literal">aws.cloudtrail.user_identity.arn</code> to verify if the <code class="literal">GetFederationToken</code> request was legitimate and necessary for their work tasks.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False positive analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Routine administrative tasks by cloud administrators may trigger the rule if they are using <code class="literal">GetFederationToken</code> for legitimate purposes. To manage this, create exceptions for known administrative accounts that regularly perform these actions.
</li>
<li class="listitem">
Automated scripts or applications that use <code class="literal">GetFederationToken</code> for legitimate operations might be flagged. Identify these scripts and exclude their associated user accounts from the rule to prevent unnecessary alerts.
</li>
<li class="listitem">
Third-party services integrated with AWS that require temporary credentials might cause false positives. Review and whitelist these services if they are verified and trusted to avoid repeated alerts.
</li>
<li class="listitem">
New employees or contractors accessing AWS resources for the first time may trigger the rule. Implement a process to verify their access requirements and exclude their accounts if their actions are deemed non-threatening.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If compromise is verified, attach a policy that denies all actions, effectively preventing any further activity, even from temporary credentials. You can use the AWS-managed policy <a href="https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AWSDenyAll.html" class="ulink" target="_top">AWSDenyAll</a>. This ensures that any temporary credentials generated by the compromised user are also blocked, stopping the attacker’s activities.
</li>
<li class="listitem">
Notify the security team and relevant stakeholders about the incident for awareness and further investigation.
</li>
<li class="listitem">
Conduct a root cause analysis to determine how the <code class="literal">GetFederationToken</code> request was initiated and identify any potential security gaps or misconfigurations.
</li>
<li class="listitem">
Implement additional monitoring and alerting for <code class="literal">GetFederationToken</code> requests to detect and respond to similar activities promptly in the future.
</li>
<li class="listitem">
Review and update IAM policies and permissions to ensure that only authorized users have the ability to request temporary credentials, reducing the risk of misuse.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5211"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-6/prebuilt-rule-8-19-6-aws-first-occurrence-of-sts-getfederationtoken-request-by-user.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset: "aws.cloudtrail"
    and event.provider:sts.amazonaws.com
    and event.action:GetFederationToken
    and event.outcome:success</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Defense Evasion
</li>
<li class="listitem">
ID: TA0005
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0005/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0005/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Use Alternate Authentication Material
</li>
<li class="listitem">
ID: T1550
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1550/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1550/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Application Access Token
</li>
<li class="listitem">
ID: T1550.001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1550/001/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1550/001/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Persistence
</li>
<li class="listitem">
ID: TA0003
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0003/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0003/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Account Manipulation
</li>
<li class="listitem">
ID: T1098
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1098/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1098/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Additional Cloud Credentials
</li>
<li class="listitem">
ID: T1098.001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1098/001/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1098/001/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-19-6-first-time-seen-aws-secret-value-accessed-in-secrets-manager.html">« First Time Seen AWS Secret Value Accessed in Secrets Manager</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-19-6-aws-sts-getcalleridentity-api-called-for-the-first-time.html">AWS STS GetCallerIdentity API Called for the First Time »</a>
</span>
</div>
</body>
</html>
