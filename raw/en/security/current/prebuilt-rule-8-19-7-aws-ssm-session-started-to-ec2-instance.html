<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AWS SSM Session Started to EC2 Instance | Elastic Security [8.19] | Elastic</title>
<meta class="elastic" name="content" content="AWS SSM Session Started to EC2 Instance | Elastic Security [8.19]">

<link rel="home" href="index.html" title="Elastic Security [8.19]"/>
<link rel="up" href="prebuilt-rule-8-19-7-prebuilt-rules-8-19-7-appendix.html" title="Appendix Z: Downloadable rule update v8.19.7"/>
<link rel="prev" href="prebuilt-rule-8-19-7-aws-access-token-used-from-multiple-addresses.html" title="AWS Access Token Used from Multiple Addresses"/>
<link rel="next" href="prebuilt-rule-8-19-7-aws-ec2-instance-connect-ssh-public-key-uploaded.html" title="AWS EC2 Instance Connect SSH Public Key Uploaded"/>
<meta class="elastic" name="product_version" content="8.19"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.19"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.19"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-19-7-aws-access-token-used-from-multiple-addresses.html">« AWS Access Token Used from Multiple Addresses</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-19-7-aws-ec2-instance-connect-ssh-public-key-uploaded.html">AWS EC2 Instance Connect SSH Public Key Uploaded »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.19]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-19-7-prebuilt-rules-8-19-7-appendix.html">Downloadable rule update v8.19.7</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>AWS SSM Session Started to EC2 Instance</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-7/prebuilt-rule-8-19-7-aws-ssm-session-started-to-ec2-instance.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="prebuilt-rule-8-19-7-aws-ssm-session-started-to-ec2-instance"></a>AWS SSM Session Started to EC2 Instance</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-7/prebuilt-rule-8-19-7-aws-ssm-session-started-to-ec2-instance.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies the first occurrence of an AWS user or role establishing a session via SSM to an EC2 instance. Adversaries may use AWS Session Manager to establish a session to an EC2 instance to execute commands on the instance. This can be used to gain access to the instance and perform actions such as privilege escalation.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-aws.cloudtrail-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-6m (<a href="/guide/en/elasticsearch/reference/8.19/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://docs.aws.amazon.com/systems-manager/latest/APIReference/API_StartSession.html" class="ulink" target="_top">https://docs.aws.amazon.com/systems-manager/latest/APIReference/API_StartSession.html</a>
</li>
<li class="listitem">
<a href="https://hackingthe.cloud/aws/post_exploitation/intercept_ssm_communications/" class="ulink" target="_top">https://hackingthe.cloud/aws/post_exploitation/intercept_ssm_communications/</a>
</li>
<li class="listitem">
<a href="https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-privilege-escalation/aws-ssm-privesc" class="ulink" target="_top">https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-privilege-escalation/aws-ssm-privesc</a>
</li>
<li class="listitem">
<a href="https://unit42.paloaltonetworks.com/cloud-lateral-movement-techniques" class="ulink" target="_top">https://unit42.paloaltonetworks.com/cloud-lateral-movement-techniques</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Data Source: AWS
</li>
<li class="listitem">
Data Source: Amazon Web Services
</li>
<li class="listitem">
Data Source: AWS SSM
</li>
<li class="listitem">
Data Source: AWS EC2
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Tactic: Lateral Movement
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 5</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_4434"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-7/prebuilt-rule-8-19-7-aws-ssm-session-started-to-ec2-instance.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating AWS SSM Session Started to EC2 Instance</strong></span></p>
<p>This rule detects the first instance of an AWS user or role initiating an SSM session to an EC2 instance, which could be indicative of legitimate administrative activities or potential malicious actions like command execution or lateral movement.</p>
<p><span class="strong strong"><strong>Possible Investigation Steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Examine the Session Start Event</strong></span>: Review the AWS CloudTrail log for the event.
</li>
<li class="listitem">
Determine the target EC2 instance using <code class="literal">aws.cloudtrail.request_parameters</code>.
</li>
<li class="listitem">
<span class="strong strong"><strong>Verify User Identity and Role</strong></span>: Check the user’s ARN and access key ID (<code class="literal">aws.cloudtrail.user_identity.access_key_id</code>).
</li>
<li class="listitem">
Determine if their role typically requires initiating SSM sessions.
</li>
<li class="listitem">
<span class="strong strong"><strong>Assess Geographic and IP Context</strong></span>: Analyze the source IP (<code class="literal">source.ip</code>) and geographic location (<code class="literal">source.geo</code>) from which the session was initiated.
</li>
<li class="listitem">
Determine if these are consistent with typical user locations or if they raise suspicions of compromise or misuse.
</li>
<li class="listitem">
<span class="strong strong"><strong>Review Session Details</strong></span>: Examine details like the session ID and stream URL (<code class="literal">aws.cloudtrail.response_elements</code>) to understand the scope and nature of the session.
</li>
<li class="listitem">
Check if any commands executed during the session were unauthorized or out of ordinary practices.
</li>
<li class="listitem">
<span class="strong strong"><strong>Correlate with Other Security Events</strong></span>: Look for other related security events around the time of the session start to identify any pattern or broader attack vector that may involve this user or EC2 instance.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False Positive Analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Legitimate Administrative Activities</strong></span>: Confirm whether the SSM session was initiated for valid administrative purposes such as system maintenance, patching, or configuration updates. Verify with the respective teams or personnel.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and Remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Incident Response Activation</strong></span>: If malicious intent or actions are confirmed, activate the incident response protocol.
</li>
<li class="listitem">
This includes containment of the threat, eradication of the adversary’s presence, recovery of affected systems, and a thorough investigation.
</li>
<li class="listitem">
<span class="strong strong"><strong>Validate and Reinforce Security Policies</strong></span>: Ensure that policies around SSM session initiation are strict and adhere to the principle of least privilege.
</li>
<li class="listitem">
Update IAM policies if necessary to tighten controls.
</li>
<li class="listitem">
<span class="strong strong"><strong>Enhance Monitoring and Alerts</strong></span>: Improve monitoring of SSM sessions, particularly focusing on sessions that involve sensitive or critical EC2 instances.
</li>
<li class="listitem">
Adjust alerting mechanisms to flag unusual session initiations promptly.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Additional Information</strong></span></p>
<p>For more in-depth understanding of managing SSM sessions and security best practices, refer to the <a href="https://docs.aws.amazon.com/systems-manager/latest/APIReference/API_StartSession.html" class="ulink" target="_top">AWS Systems Manager documentation</a>. Additionally, consider the security implications and best practices outlined in <a href="https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-privilege-escalation/aws-ssm-privesc" class="ulink" target="_top">AWS SSM privilege escalation techniques</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_5305"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/downloadable-packages/8-19-7/prebuilt-rule-8-19-7-aws-ssm-session-started-to-ec2-instance.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset:"aws.cloudtrail" and event.provider:"ssm.amazonaws.com"
    and event.action:"StartSession" and event.outcome:"success"</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Lateral Movement
</li>
<li class="listitem">
ID: TA0008
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0008/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0008/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Remote Services
</li>
<li class="listitem">
ID: T1021
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1021/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1021/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Cloud Services
</li>
<li class="listitem">
ID: T1021.007
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1021/007/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1021/007/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-19-7-aws-access-token-used-from-multiple-addresses.html">« AWS Access Token Used from Multiple Addresses</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-19-7-aws-ec2-instance-connect-ssh-public-key-uploaded.html">AWS EC2 Instance Connect SSH Public Key Uploaded »</a>
</span>
</div>
</body>
</html>
