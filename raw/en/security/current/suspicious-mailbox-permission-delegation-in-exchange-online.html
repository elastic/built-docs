<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Suspicious Mailbox Permission Delegation in Exchange Online | Elastic Security Solution [8.18] | Elastic</title>
<meta class="elastic" name="content" content="Suspicious Mailbox Permission Delegation in Exchange Online | Elastic Security Solution [8.18]">

<link rel="home" href="index.html" title="Elastic Security Solution [8.18]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="suspicious-ms-outlook-child-process.html" title="Suspicious MS Outlook Child Process"/>
<link rel="next" href="suspicious-managed-code-hosting-process.html" title="Suspicious Managed Code Hosting Process"/>
<meta class="elastic" name="product_version" content="8.18"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.18"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.18"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="suspicious-ms-outlook-child-process.html">« Suspicious MS Outlook Child Process</a>
</span>
<span class="next">
<a href="suspicious-managed-code-hosting-process.html">Suspicious Managed Code Hosting Process »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [8.18]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Suspicious Mailbox Permission Delegation in Exchange Online</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/suspicious-mailbox-permission-delegation-in-exchange-online.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    A newer version is available. Check out the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="suspicious-mailbox-permission-delegation-in-exchange-online"></a>Suspicious Mailbox Permission Delegation in Exchange Online</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/suspicious-mailbox-permission-delegation-in-exchange-online.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies the assignment of rights to access content from another mailbox. An adversary may use the compromised account to send messages to other accounts in the network of the target organization while creating inbox rules, so messages can evade spam/phishing detection mechanisms.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: new_terms</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
filebeat-*
</li>
<li class="listitem">
logs-o365.audit-*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: low</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 21</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: None (<a href="/guide/en/elasticsearch/reference/8.18/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://learn.microsoft.com/en-us/microsoft-365/admin/add-users/give-mailbox-permissions-to-another-user?view=o365-worldwide" class="ulink" target="_top">https://learn.microsoft.com/en-us/microsoft-365/admin/add-users/give-mailbox-permissions-to-another-user?view=o365-worldwide</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Domain: SaaS
</li>
<li class="listitem">
Data Source: Microsoft 365
</li>
<li class="listitem">
Data Source: Microsoft Exchange
</li>
<li class="listitem">
Data Source: Microsoft 365 Audit Logs
</li>
<li class="listitem">
Use Case: Configuration Audit
</li>
<li class="listitem">
Tactic: Persistence
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 211</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
<li class="listitem">
Austin Songer
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_1062"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/suspicious-mailbox-permission-delegation-in-exchange-online.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and Analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating Suspicious Mailbox Permission Delegation in Exchange Online</strong></span></p>
<p>This rule detects the delegation of mailbox permissions in Microsoft 365 Exchange. This behavior may indicate that an adversary is attempting to gain access to another user&#8217;s mailbox or send messages on behalf of that user.</p>
<p><span class="strong strong"><strong>Possible Investigation Steps</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">user.id</code> and <code class="literal">o365.audit.Parameters.Identity</code>: Determine which account was delegated access and which account performed the delegation. Review both for unusual activity.
</li>
<li class="listitem">
<code class="literal">event.action</code>: Indicates the type of permission granted. Review which delegation action was taken.
</li>
<li class="listitem">
<code class="literal">o365.audit.Parameters.AccessRights</code> or <code class="literal">GrantSendOnBehalfTo</code>: Confirm the exact permission granted.
</li>
<li class="listitem">
<code class="literal">@timestamp</code> and <code class="literal">event.ingested</code>: Review the timing of the delegation and whether it aligns with user activity or known business events.
</li>
<li class="listitem">
<code class="literal">source.ip</code> and <code class="literal">source.geo</code>: Validate that the source IP and location are expected for the admin or account performing the action.
</li>
<li class="listitem">
<code class="literal">user_agent.original</code>: If present, review to identify any automation, script, or unexpected interface used to assign the permissions.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>FullAccess (<code class="literal">Add-MailboxPermission</code>)</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">o365.audit.Parameters.Identity</code>: The mailbox being accessed.
</li>
<li class="listitem">
<code class="literal">o365.audit.Parameters.User</code>: The user granted FullAccess.
</li>
<li class="listitem">
Review for subsequent mailbox logins or message rules created by the grantee.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>SendAs (<code class="literal">Add-RecipientPermission</code>)</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">o365.audit.Parameters.Identity</code>: The account the grantee is allowed to impersonate.
</li>
<li class="listitem">
<code class="literal">o365.audit.Parameters.Trustee</code>: The user who was granted the ability to send as the identity.
</li>
<li class="listitem">
Search for recent messages sent "as" the identity and validate whether the activity was legitimate.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>SendOnBehalf (<code class="literal">Set-Mailbox</code>)</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">o365.audit.Parameters.GrantSendOnBehalfTo</code>: The user allowed to send on behalf of the mailbox owner.
</li>
<li class="listitem">
Check for outbound emails or meeting requests with "on behalf of" headers.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False Positive Analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Delegation to Assistants: Executive or admin assistants often receive FullAccess or SendOnBehalf permissions.
</li>
<li class="listitem">
Shared Mailboxes: Teams or departments may share access to mailboxes for operational efficiency.
</li>
<li class="listitem">
Automated Admin Actions: System or service accounts may perform these actions as part of onboarding or automation.
</li>
<li class="listitem">
Project-Based Access: Temporary access granted for short-term collaboration.
</li>
<li class="listitem">
Maintain an allowlist of known delegation relationships.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and Remediation</strong></span></p>
<p>If the delegation is determined to be unauthorized or suspicious:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Revoke the delegated permissions immediately to prevent further access.
</li>
<li class="listitem">
Reset credentials for the impacted accounts if compromise is suspected.
</li>
<li class="listitem">
Review mailbox rules and sent items to detect abuse.
</li>
<li class="listitem">
Alert impacted users and advise on suspicious activity to watch for.
</li>
<li class="listitem">
Audit audit logs around the delegation for additional attacker actions (e.g., MFA disablement, mailbox rule creation, login from foreign IPs).
</li>
<li class="listitem">
Review conditional access, role-based access control, and app permissions to reduce the attack surface.
</li>
<li class="listitem">
Harden delegation policies by requiring approvals, limiting delegation to specific groups, or implementing Just-in-Time (JIT) access for mailboxes.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_1118"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.18/docs/detections/prebuilt-rules/rule-details/suspicious-mailbox-permission-delegation-in-exchange-online.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset: "o365.audit" and
event.provider: "Exchange" and
event.outcome: "success" and
not o365.audit.UserType : (3 or 4) and
(
    (event.action: "Add-MailboxPermission" and o365.audit.Parameters.AccessRights: "FullAccess") or
    (event.action: "Add-RecipientPermission" and o365.audit.Parameters.AccessRights: "SendAs") or
    (event.action: "Set-Mailbox" and o365.audit.Parameters.GrantSendOnBehalfTo: *)
) and
not user.id:(
    "NT AUTHORITY\SYSTEM (Microsoft.Exchange.ServiceHost)" or
    "NT AUTHORITY\SYSTEM (Microsoft.Exchange.AdminApi.NetCore)" or
    "NT AUTHORITY\SYSTEM (w3wp)"
    )</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Persistence
</li>
<li class="listitem">
ID: TA0003
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0003/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0003/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Account Manipulation
</li>
<li class="listitem">
ID: T1098
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1098/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1098/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Additional Email Delegate Permissions
</li>
<li class="listitem">
ID: T1098.002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1098/002/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1098/002/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="suspicious-ms-outlook-child-process.html">« Suspicious MS Outlook Child Process</a>
</span>
<span class="next">
<a href="suspicious-managed-code-hosting-process.html">Suspicious Managed Code Hosting Process »</a>
</span>
</div>
</body>
</html>
