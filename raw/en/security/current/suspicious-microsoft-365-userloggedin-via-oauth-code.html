<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Suspicious Microsoft 365 UserLoggedIn via OAuth Code | Elastic Security [8.19] | Elastic</title>
<meta class="elastic" name="content" content="Suspicious Microsoft 365 UserLoggedIn via OAuth Code | Elastic Security [8.19]">

<link rel="home" href="index.html" title="Elastic Security [8.19]"/>
<link rel="up" href="prebuilt-rules.html" title="Prebuilt rule reference"/>
<link rel="prev" href="suspicious-microsoft-365-mail-access-by-unusual-clientappid.html" title="Suspicious Microsoft 365 Mail Access by Unusual ClientAppId"/>
<link rel="next" href="suspicious-microsoft-diagnostics-wizard-execution.html" title="Suspicious Microsoft Diagnostics Wizard Execution"/>
<meta class="elastic" name="product_version" content="8.19"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/8.19"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="8.19"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="suspicious-microsoft-365-mail-access-by-unusual-clientappid.html">« Suspicious Microsoft 365 Mail Access by Unusual ClientAppId</a>
</span>
<span class="next">
<a href="suspicious-microsoft-diagnostics-wizard-execution.html">Suspicious Microsoft Diagnostics Wizard Execution »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security [8.19]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rules.html">Prebuilt rule reference</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Suspicious Microsoft 365 UserLoggedIn via OAuth Code</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/rule-details/suspicious-microsoft-365-userloggedin-via-oauth-code.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div id="url-to-v3" class="version-warning">
    <strong>IMPORTANT</strong>: This documentation is no longer updated. Refer to <a href="https://www.elastic.co/support/eol">Elastic's version policy</a> and the <a href="https://www.elastic.co/docs">latest documentation</a>.
</div>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h2 class="title"><a id="suspicious-microsoft-365-userloggedin-via-oauth-code"></a>Suspicious Microsoft 365 UserLoggedIn via OAuth Code</h2><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/rule-details/suspicious-microsoft-365-userloggedin-via-oauth-code.asciidoc">edit</a></div>
</div></div></div>
<p>Identifies sign-ins on behalf of a principal user to the Microsoft Graph API from multiple IPs using the Microsoft Authentication Broker or Visual Studio Code application. This behavior may indicate an adversary using a phished OAuth refresh token.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: esql</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>: None</p>
<p><span class="strong strong"><strong>Severity</strong></span>: high</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 73</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 59m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: now-60m (<a href="/guide/en/elasticsearch/reference/8.19/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.volexity.com/blog/2025/04/22/phishing-for-codes-russian-threat-actors-target-microsoft-365-oauth-workflows/" class="ulink" target="_top">https://www.volexity.com/blog/2025/04/22/phishing-for-codes-russian-threat-actors-target-microsoft-365-oauth-workflows/</a>
</li>
<li class="listitem">
<a href="https://github.com/dirkjanm/ROADtools" class="ulink" target="_top">https://github.com/dirkjanm/ROADtools</a>
</li>
<li class="listitem">
<a href="https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/" class="ulink" target="_top">https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Domain: Cloud
</li>
<li class="listitem">
Domain: Email
</li>
<li class="listitem">
Domain: Identity
</li>
<li class="listitem">
Data Source: Microsoft 365
</li>
<li class="listitem">
Data Source: Microsoft 365 Audit Logs
</li>
<li class="listitem">
Use Case: Identity and Access Audit
</li>
<li class="listitem">
Use Case: Threat Detection
</li>
<li class="listitem">
Resources: Investigation Guide
</li>
<li class="listitem">
Tactic: Defense Evasion
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 2</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_investigation_guide_1124"></a>Investigation guide</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/rule-details/suspicious-microsoft-365-userloggedin-via-oauth-code.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Triage and analysis</strong></span></p>
<p><span class="strong strong"><strong>Investigating Suspicious Microsoft 365 UserLoggedIn via OAuth Code</strong></span></p>
<p><span class="strong strong"><strong>Possible Investigation Steps:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">o365.audit.UserId</code>: The identity value the application is acting on behalf of principal user.
</li>
<li class="listitem">
<code class="literal">unique_ips</code>: Analyze the list of unique IP addresses used within the 30-minute window. Determine whether these originate from different geographic regions, cloud providers, or anonymizing infrastructure (e.g., Tor or VPNs).
</li>
<li class="listitem">
<code class="literal">target_time_window</code>: Use the truncated time window to pivot into raw events to reconstruct the full sequence of resource access events, including exact timestamps and service targets.
</li>
<li class="listitem">
<code class="literal">azure.auditlogs</code> to check for device join or registration events around the same timeframe.
</li>
<li class="listitem">
<code class="literal">azure.identityprotection</code> to identify correlated risk detections, such as anonymized IP access or token replay.
</li>
<li class="listitem">
Any additional sign-ins from the <code class="literal">ips</code> involved, even outside the broker, to determine if tokens have been reused elsewhere.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>False Positive Analysis</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Developers or IT administrators working across environments may also produce similar behavior.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Response and Remediation</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If confirmed unauthorized, revoke all refresh tokens for the affected user and remove any devices registered during this session.
</li>
<li class="listitem">
Notify the user and determine whether the device join or authentication activity was expected.
</li>
<li class="listitem">
Audit Conditional Access and broker permissions (<code class="literal">29d9ed98-a469-4536-ade2-f981bc1d605e</code>) to ensure policies enforce strict access controls.
</li>
<li class="listitem">
Consider blocking token-based reauthentication to Microsoft Graph and DRS from suspicious locations or user agents.
</li>
<li class="listitem">
Continue monitoring for follow-on activity like lateral movement or privilege escalation.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_setup_704"></a>Setup</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/rule-details/suspicious-microsoft-365-userloggedin-via-oauth-code.asciidoc">edit</a></div>
</div></div></div>
<p><span class="strong strong"><strong>Setup</strong></span></p>
<p>The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h3 class="title"><a id="_rule_query_1160"></a>Rule query</h3><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/8.19/docs/detections/prebuilt-rules/rule-details/suspicious-microsoft-365-userloggedin-via-oauth-code.asciidoc">edit</a></div>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">from logs-o365.audit-*
| WHERE event.dataset == "o365.audit" and event.action == "UserLoggedIn" and

  // ensure source, application and user are not null
  source.ip is not null and
  o365.audit.UserId is not null and
  o365.audit.ApplicationId is not null and

  // filter for user principals that are not service accounts
  o365.audit.UserType in ("0", "2", "3", "10") and

  // filter for successful logon to Microsoft Graph and from the Microsoft Authentication Broker or Visual Studio Code
  o365.audit.ApplicationId in ("aebc6443-996d-45c2-90f0-388ff96faa56", "29d9ed98-a469-4536-ade2-f981bc1d605e") and
  o365.audit.ObjectId in ("00000003-0000-0000-c000-000000000000")

// keep relevant fields only
| keep @timestamp, o365.audit.UserId, source.ip, o365.audit.ApplicationId, o365.audit.ObjectId, o365.audit.ExtendedProperties.RequestType, source.as.organization.name, o365.audit.ExtendedProperties.ResultStatusDetail

// case statements to track which are OAuth2 authorization request via redirect and which are related to OAuth2 code to token conversion
| eval
  oauth_authorize = case(o365.audit.ExtendedProperties.RequestType == "OAuth2:Authorize" and o365.audit.ExtendedProperties.ResultStatusDetail == "Redirect", o365.audit.UserId, null),
  oauth_token = case(o365.audit.ExtendedProperties.RequestType == "OAuth2:Token", o365.audit.UserId, null)

// split time to 30 minutes intervals
| eval target_time_window = DATE_TRUNC(30 minutes, @timestamp)

// aggregate by principal, applicationId, objectId and time window
| stats
  unique_ips = COUNT_DISTINCT(source.ip),
  source_ips = VALUES(source.ip),
  appIds = VALUES(o365.audit.ApplicationId),
  asn = values(`source.as.organization.name`),
  is_oauth_token = COUNT_DISTINCT(oauth_token),
  is_oauth_authorize = COUNT_DISTINCT(oauth_authorize)
by o365.audit.UserId, target_time_window, o365.audit.ApplicationId, o365.audit.ObjectId

// filter for cases where the same appId is used by the same principal user to access the same object and from multiple addresses via OAuth2 token
| where unique_ips &gt;= 2 and is_oauth_authorize &gt; 0 and is_oauth_token &gt; 0</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Defense Evasion
</li>
<li class="listitem">
ID: TA0005
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0005/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0005/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Use Alternate Authentication Material
</li>
<li class="listitem">
ID: T1550
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1550/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1550/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Sub-technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Application Access Token
</li>
<li class="listitem">
ID: T1550.001
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1550/001/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1550/001/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="suspicious-microsoft-365-mail-access-by-unusual-clientappid.html">« Suspicious Microsoft 365 Mail Access by Unusual ClientAppId</a>
</span>
<span class="next">
<a href="suspicious-microsoft-diagnostics-wizard-execution.html">Suspicious Microsoft Diagnostics Wizard Execution »</a>
</span>
</div>
</body>
</html>
