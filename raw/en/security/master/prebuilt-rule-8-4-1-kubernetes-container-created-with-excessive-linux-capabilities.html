<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kubernetes Container Created with Excessive Linux Capabilities | Elastic Security Solution [master] | Elastic</title>
<meta class="elastic" name="content" content="Kubernetes Container Created with Excessive Linux Capabilities | Elastic Security Solution [master]">

<link rel="home" href="index.html" title="Elastic Security Solution [master]"/>
<link rel="up" href="prebuilt-rule-8-4-1-prebuilt-rules-8-4-1-appendix.html" title="Appendix L: Downloadable rule update v8.4.1"/>
<link rel="prev" href="prebuilt-rule-8-4-1-kubernetes-anonymous-request-authorized.html" title="Kubernetes Anonymous Request Authorized"/>
<link rel="next" href="prebuilt-rule-8-4-1-kubernetes-suspicious-assignment-of-controller-service-account.html" title="Kubernetes Suspicious Assignment of Controller Service Account"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/master"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="prebuilt-rule-8-4-1-kubernetes-anonymous-request-authorized.html">« Kubernetes Anonymous Request Authorized</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-4-1-kubernetes-suspicious-assignment-of-controller-service-account.html">Kubernetes Suspicious Assignment of Controller Service Account »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="prebuilt-rule-8-4-1-prebuilt-rules-8-4-1-appendix.html">Downloadable rule update v8.4.1</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Kubernetes Container Created with Excessive Linux Capabilities</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/prebuilt-rules/downloadable-packages/8-4-1/prebuilt-rule-8-4-1-kubernetes-container-created-with-excessive-linux-capabilities.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="prebuilt-rule-8-4-1-kubernetes-container-created-with-excessive-linux-capabilities"></a>Kubernetes Container Created with Excessive Linux Capabilities<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/prebuilt-rules/downloadable-packages/8-4-1/prebuilt-rule-8-4-1-kubernetes-container-created-with-excessive-linux-capabilities.asciidoc">edit</a></h2>
</div></div></div>
<p>This rule detects a container deployed with one or more dangerously permissive Linux capabilities. An attacker with the ability to deploy a container with added capabilities could use this for further execution, lateral movement, or privilege escalation within a cluster. The capabilities detected in this rule have been used in container escapes to the host machine.</p>
<p><span class="strong strong"><strong>Rule type</strong></span>: query</p>
<p><span class="strong strong"><strong>Rule indices</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
logs-kubernetes.*
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Severity</strong></span>: medium</p>
<p><span class="strong strong"><strong>Risk score</strong></span>: 47</p>
<p><span class="strong strong"><strong>Runs every</strong></span>: 5m</p>
<p><span class="strong strong"><strong>Searches indices from</strong></span>: None (<a href="/guide/en/elasticsearch/reference/master/common-options.html#date-math" class="ulink" target="_top">Date Math format</a>, see also <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule"><code class="literal">Additional look-back time</code></a>)</p>
<p><span class="strong strong"><strong>Maximum alerts per execution</strong></span>: 100</p>
<p><span class="strong strong"><strong>References</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-capabilities-for-a-container" class="ulink" target="_top">https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-capabilities-for-a-container</a>
</li>
<li class="listitem">
<a href="https://0xn3va.gitbook.io/cheat-sheets/container/escaping/excessive-capabilities" class="ulink" target="_top">https://0xn3va.gitbook.io/cheat-sheets/container/escaping/excessive-capabilities</a>
</li>
<li class="listitem">
<a href="https://man7.org/linux/man-pages/man7/capabilities.7.html" class="ulink" target="_top">https://man7.org/linux/man-pages/man7/capabilities.7.html</a>
</li>
<li class="listitem">
<a href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities" class="ulink" target="_top">https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities</a>
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Tags</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
<li class="listitem">
Kubernetes
</li>
<li class="listitem">
Continuous Monitoring
</li>
<li class="listitem">
Execution
</li>
<li class="listitem">
Privilege Escalation
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Version</strong></span>: 1</p>
<p><span class="strong strong"><strong>Rule authors</strong></span>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Elastic
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Rule license</strong></span>: Elastic License v2</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_investigation_guide_1875"></a>Investigation guide<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/prebuilt-rules/downloadable-packages/8-4-1/prebuilt-rule-8-4-1-kubernetes-container-created-with-excessive-linux-capabilities.asciidoc">edit</a></h3>
</div></div></div>
<div class="pre_wrapper lang-markdown">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-markdown">## Triage and analysis

### Investigating Kubernetes Container Created with Excessive Linux Capabilities

Linux capabilities were designed to divide root privileges into smaller units. Each capability grants a thread just enough power to perform specific privileged tasks. In Kubernetes, containers are given a set of default capabilities that can be dropped or added to at the time of creation. Added capabilities entitle containers in a pod with additional privileges that can be used to change
core processes, change network settings of a cluster, or directly access the underlying host. The following have been used in container escape techniques:

BPF - Allow creating BPF maps, loading BPF Type Format (BTF) data, retrieve JITed code of BPF programs, and more.
DAC_READ_SEARCH - Bypass file read permission checks and directory read and execute permission checks.
NET_ADMIN - Perform various network-related operations.
SYS_ADMIN - Perform a range of system administration operations.
SYS_BOOT - Use reboot(2) and kexec_load(2), reboot and load a new kernel for later execution.
SYS_MODULE - Load and unload kernel modules.
SYS_PTRACE - Trace arbitrary processes using ptrace(2).
SYS_RAWIO - Perform I/O port operations (iopl(2) and ioperm(2)).
SYSLOG - Perform privileged syslog(2) operations.

### False positive analysis

- While these capabilities are not included by default in containers, some legitimate images may need to add them. This rule leaves space for the exception of trusted container images. To add an exception, add the trusted container image name to the query field, kubernetes.audit.requestObject.spec.containers.image.</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_rule_query_2388"></a>Rule query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/prebuilt-rules/downloadable-packages/8-4-1/prebuilt-rule-8-4-1-kubernetes-container-created-with-excessive-linux-capabilities.asciidoc">edit</a></h3>
</div></div></div>
<div class="pre_wrapper lang-js">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-js">event.dataset: kubernetes.audit_logs
  and kubernetes.audit.annotations.authorization_k8s_io/decision:"allow"
  and kubernetes.audit.verb: create
  and kubernetes.audit.objectRef.resource: pods
  and kubernetes.audit.requestObject.spec.containers.securityContext.capabilities.add: ("BPF" or "DAC_READ_SEARCH"  or "NET_ADMIN" or "SYS_ADMIN" or "SYS_BOOT" or "SYS_MODULE" or "SYS_PTRACE" or "SYS_RAWIO"  or "SYSLOG")
  and not kubernetes.audit.requestObject.spec.containers.image : ("docker.elastic.co/beats/elastic-agent:8.4.0" or "rancher/klipper-lb:v0.3.5" or "")</pre>
</div>
<p><span class="strong strong"><strong>Framework</strong></span>: MITRE ATT&amp;CK<sup>TM</sup></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Privilege Escalation
</li>
<li class="listitem">
ID: TA0004
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0004/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0004/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Escape to Host
</li>
<li class="listitem">
ID: T1611
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1611/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1611/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Tactic:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Execution
</li>
<li class="listitem">
ID: TA0002
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/tactics/TA0002/" class="ulink" target="_top">https://attack.mitre.org/tactics/TA0002/</a>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Technique:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Name: Deploy Container
</li>
<li class="listitem">
ID: T1610
</li>
<li class="listitem">
Reference URL: <a href="https://attack.mitre.org/techniques/T1610/" class="ulink" target="_top">https://attack.mitre.org/techniques/T1610/</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="prebuilt-rule-8-4-1-kubernetes-anonymous-request-authorized.html">« Kubernetes Anonymous Request Authorized</a>
</span>
<span class="next">
<a href="prebuilt-rule-8-4-1-kubernetes-suspicious-assignment-of-controller-service-account.html">Kubernetes Suspicious Assignment of Controller Service Account »</a>
</span>
</div>
</body>
</html>
