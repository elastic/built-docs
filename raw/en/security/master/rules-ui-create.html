<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Create a detection rule | Elastic Security Solution [master] | Elastic</title>
<meta class="elastic" name="content" content="Create a detection rule | Elastic Security Solution [master]">

<link rel="home" href="index.html" title="Elastic Security Solution [master]"/>
<link rel="up" href="detection-engine-overview.html" title="Detections and alerts"/>
<link rel="prev" href="about-rules.html" title="About detection rules"/>
<link rel="next" href="rules-cross-cluster-search.html" title="Cross-cluster search and detection rules"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Security"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Security/Guide/master"/>
<meta name="DC.subject" content="Security"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body>
<div class="page_header">
This documentation contains work-in-progress information for future Elastic Stack and Cloud releases. Use the version selector to view supported release docs. It also contains some Elastic Cloud serverless information. Check out our <a href="https://www.elastic.co/docs/current/serverless">serverless docs</a> for more details.
</div>
<div class="navheader">
<span class="prev">
<a href="about-rules.html">« About detection rules</a>
</span>
<span class="next">
<a href="rules-cross-cluster-search.html">Cross-cluster search and detection rules »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Security Solution [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and alerts</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Create a detection rule</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="chapter xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="rules-ui-create"></a>Create a detection rule<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h2>
</div></div></div>
<p>To create a new detection rule, follow these steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Define the <a class="xref" href="about-rules.html#rule-types" title="Rule types"><span class="strong strong"><strong>rule type</strong></span></a>. The configuration for this step varies depending on the rule type.
</li>
<li class="listitem">
Configure basic rule settings.
</li>
<li class="listitem">
Configure advanced rule settings (optional).
</li>
<li class="listitem">
Set the rule&#8217;s schedule.
</li>
<li class="listitem">
Set up alert notifications (optional).
</li>
<li class="listitem">
Set up response actions (optional).
</li>
</ol>
</div>
<div class="sidebar">
<div class="titlepage"><div><div>
<p class="title"><strong>Requirements</strong></p>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
To create detection rules, you must have access to data views, which requires the <a href="/guide/en/kibana/master/kibana-role-management.html" class="ulink" target="_top">Kibana privilege</a> <code class="literal">Data View Management</code>.
</li>
<li class="listitem">
You&#8217;ll also need permissions to enable and view detections, manage rules, manage alerts, and preview rules. These permissions depend on the user role. Refer to <a class="xref" href="detections-permissions-section.html" title="Detections prerequisites and requirements">Detections prerequisites and requirements</a> for more information.
</li>
</ul>
</div>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>At any step, you can <a class="xref" href="rules-ui-create.html#preview-rules" title="Preview your rule (optional)">preview the rule</a> before saving it to see what kind of results you can expect.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Additional configuration is required for detection rules using cross-cluster search. Refer to <a class="xref" href="rules-cross-cluster-search.html" title="Cross-cluster search and detection rules">Cross-cluster search and detection rules</a>.</p>
</div>
</div>
<h3><a id="create-ml-rule"></a>Create a machine learning rule<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h3>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>To create or edit machine learning rules, you must have the <a href="/subscriptions" class="ulink" target="_top">appropriate license</a> or use a
<a href="/cloud/elasticsearch-service/signup?page=docs&amp;placement=docs-body" class="ulink" target="_top">cloud deployment</a>. Additionally, you must have the <a href="/guide/en/elasticsearch/reference/master/built-in-roles.html" class="ulink" target="_top"><code class="literal">machine_learning_admin</code></a> user
role, and the selected machine learning job must be running for the rule to function correctly.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to <span class="strong strong"><strong>Rules</strong></span> &#8594; <span class="strong strong"><strong>Detection rules (SIEM)</strong></span> &#8594; <span class="strong strong"><strong>Create new rule</strong></span>. The <span class="strong strong"><strong>Create new rule</strong></span> page displays.
</li>
<li class="listitem">
<p>To create a rule based on a machine learning anomaly threshold, select <span class="strong strong"><strong>Machine Learning</strong></span>,
then select:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>The required machine learning jobs.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If a required job isn&#8217;t currently running, it will automatically start when you finish configuring and enable the rule.</p>
</div>
</div>
</li>
<li class="listitem">
The anomaly score threshold above which alerts are created.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>(Optional) Add <span class="strong strong"><strong>Related integrations</strong></span> to associate the rule with one or more <a href="https://docs.elastic.co/en/integrations" class="ulink" target="_top">Elastic integrations</a>. This indicates the rule&#8217;s dependency on specific integrations and the data they generate, and allows users to confirm each integration&#8217;s <a class="xref" href="rules-ui-management.html#rule-prerequisites" title="Confirm rule prerequisites">installation status</a> when viewing the rule.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add integration</strong></span>, then select an integration from the list. You can also start typing an integration&#8217;s name to find it faster.
</li>
<li class="listitem">
Enter the version of the integration you want to associate with the rule, using <a href="https://semver.org" class="ulink" target="_top">semantic versioning</a>. For version ranges, you must use tilde or caret syntax. For example, <code class="literal">~1.2.3</code> is from 1.2.3 to any patch version less than 1.3.0, and <code class="literal">^1.2.3</code> is from 1.2.3 to any minor and patch version less than 2.0.0.
</li>
</ol>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Continue</strong></span> to <a class="xref" href="rules-ui-create.html#rule-ui-basic-params" title="Configure basic rule settings">configure basic rule settings</a>.
</li>
</ol>
</div>
<h3><a id="create-custom-rule"></a>Create a custom query rule<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h3>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to <span class="strong strong"><strong>Rules</strong></span> &#8594; <span class="strong strong"><strong>Detection rules (SIEM)</strong></span> &#8594; <span class="strong strong"><strong>Create new rule</strong></span>. The <span class="strong strong"><strong>Create new rule</strong></span> page displays.
</li>
<li class="listitem">
<p>To create a rule based on a KQL or Lucene query, select <span class="strong strong"><strong>Custom query</strong></span>,
then:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Define which Elasticsearch indices or data view the rule searches for alerts.
</li>
<li class="listitem">
<p>Use the filter and query fields to create the criteria used for detecting
alerts.</p>
<p>The following example (based on the prebuilt rule <a class="xref" href="prebuilt-rule-0-14-2-volume-shadow-copy-deleted-or-resized-via-vssadmin.html" title="Volume Shadow Copy Deleted or Resized via VssAdmin">Volume Shadow Copy Deleted or Resized via VssAdmin</a>) detects when the <code class="literal">vssadmin delete shadows</code>
Windows command is executed:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p><span class="strong strong"><strong>Index patterns</strong></span>: <code class="literal">winlogbeat-*</code></p>
<p>Winlogbeat ships Windows event logs to Elastic Security.</p>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Custom query</strong></span>: <code class="literal">event.action:"Process Create (rule: ProcessCreate)" and process.name:"vssadmin.exe" and process.args:("delete" and "shadows")</code></p>
<p>Searches the <code class="literal">winlogbeat-*</code> indices for <code class="literal">vssadmin.exe</code> executions with
the <code class="literal">delete</code> and <code class="literal">shadow</code> arguments, which are used to delete a volume&#8217;s shadow
copies.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/rule-query-example.png" alt="Rule query example">
</div>
</div>
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>You can use Kibana saved queries (<span class="image"><img src="images/saved-query-menu.png" alt="Saved query menu" width="18" height="18"></span>) and queries from saved Timelines (<span class="strong strong"><strong>Import query from saved Timeline</strong></span>) as rule conditions.</p>
<p>When you use a saved query, the <span class="strong strong"><strong>Load saved query "<em>query name</em>" dynamically on each rule execution</strong></span> check box appears:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Select this to use the saved query every time the rule runs. This links the rule to the saved query, and you won&#8217;t be able to modify the rule&#8217;s <span class="strong strong"><strong>Custom query</strong></span> field or filters because the rule will only use settings from the saved query. To make changes, modify the saved query itself.
</li>
<li class="listitem">
Deselect this to load the saved query as a one-time way of populating the rule&#8217;s <span class="strong strong"><strong>Custom query</strong></span> field and filters. This copies the settings from the saved query to the rule, so you can then further adjust the rule&#8217;s query and filters as needed. If the saved query is later changed, the rule will not inherit those changes.
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
(Optional, <a href="/pricing" class="ulink" target="_top">Platinum or higher subscription</a> required) Use <span class="strong strong"><strong>Suppress alerts by</strong></span> to reduce the number of repeated or duplicate alerts created by the rule. Refer to <a class="xref" href="alert-suppression.html" title="Suppress detection alerts">Suppress detection alerts</a> for more information.
</li>
<li class="listitem">
<p>(Optional) Create a list of <span class="strong strong"><strong>Required fields</strong></span> that the rule needs to function. This list is informational only, to help users understand the rule; it doesn&#8217;t affect how the rule actually runs.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add required field</strong></span>, then select a field from the index patterns or data view you specified for the rule. You can also start typing a field&#8217;s name to find it faster, or type in an entirely new custom field.
</li>
<li class="listitem">
Enter the field&#8217;s data type.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>(Optional) Add <span class="strong strong"><strong>Related integrations</strong></span> to associate the rule with one or more <a href="https://docs.elastic.co/en/integrations" class="ulink" target="_top">Elastic integrations</a>. This indicates the rule&#8217;s dependency on specific integrations and the data they generate, and allows users to confirm each integration&#8217;s <a class="xref" href="rules-ui-management.html#rule-prerequisites" title="Confirm rule prerequisites">installation status</a> when viewing the rule.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add integration</strong></span>, then select an integration from the list. You can also start typing an integration&#8217;s name to find it faster.
</li>
<li class="listitem">
Enter the version of the integration you want to associate with the rule, using <a href="https://semver.org" class="ulink" target="_top">semantic versioning</a>. For version ranges, you must use tilde or caret syntax. For example, <code class="literal">~1.2.3</code> is from 1.2.3 to any patch version less than 1.3.0, and <code class="literal">^1.2.3</code> is from 1.2.3 to any minor and patch version less than 2.0.0.
</li>
</ol>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Continue</strong></span> to <a class="xref" href="rules-ui-create.html#rule-ui-basic-params" title="Configure basic rule settings">configure basic rule settings</a>.
</li>
</ol>
</div>
<h3><a id="create-threshold-rule"></a>Create a threshold rule<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h3>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to <span class="strong strong"><strong>Rules</strong></span> &#8594; <span class="strong strong"><strong>Detection rules (SIEM)</strong></span> &#8594; <span class="strong strong"><strong>Create new rule</strong></span>. The <span class="strong strong"><strong>Create new rule</strong></span> page displays.
</li>
<li class="listitem">
<p>To create a rule based on a source event field threshold, select <span class="strong strong"><strong>Threshold</strong></span>, then:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Define which Elasticsearch indices the rule analyzes for alerts.
</li>
<li class="listitem">
<p>Use the filter and query fields to create the criteria used for detecting
alerts.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can use Kibana saved queries (<span class="image"><img src="images/saved-query-menu.png" alt="Saved query menu" width="18" height="18"></span>) and queries from saved Timelines (<span class="strong strong"><strong>Import query from saved Timeline</strong></span>) as rule conditions.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Use the <span class="strong strong"><strong>Group by</strong></span> and <span class="strong strong"><strong>Threshold</strong></span> fields to determine which source event field is used as a threshold and the threshold&#8217;s value.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Nested fields are not supported for use with <span class="strong strong"><strong>Group by</strong></span>.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Use the <span class="strong strong"><strong>Count</strong></span> field to limit alerts by cardinality of a certain field.</p>
<p>For example, if <span class="strong strong"><strong>Group by</strong></span> is <code class="literal">source.ip, destination.ip</code> and its <span class="strong strong"><strong>Threshold</strong></span> is <code class="literal">10</code>, an alert is generated for every pair of source and destination IP addresses that appear in at least 10 of the rule&#8217;s search results.</p>
<p>You can also leave the <span class="strong strong"><strong>Group by</strong></span> field undefined. The rule then creates an alert when the number of search results is equal to or greater than the threshold value. If you set <span class="strong strong"><strong>Count</strong></span> to limit the results by <code class="literal">process.name</code> &gt;= 2, an alert will only be generated for source/destination IP pairs that appear with at least 2 unique process names across all events.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Alerts created by threshold rules are synthetic alerts that do not resemble the source documents. The alert itself only contains data about the fields that were aggregated over (the <span class="strong strong"><strong>Group by</strong></span> fields). Other fields are omitted, because they can vary across all source documents that were counted toward the threshold. Additionally, you can reference the actual count of documents that exceeded the threshold from the <code class="literal">kibana.alert.threshold_result.count</code> field.</p>
</div>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
<span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> (Optional, <a href="/pricing" class="ulink" target="_top">Platinum or higher subscription</a> required) Select <span class="strong strong"><strong>Suppress alerts</strong></span> to reduce the number of repeated or duplicate alerts created by the rule. Refer to <a class="xref" href="alert-suppression.html" title="Suppress detection alerts">Suppress detection alerts</a> for more information.
</li>
<li class="listitem">
<p>(Optional) Create a list of <span class="strong strong"><strong>Required fields</strong></span> that the rule needs to function. This list is informational only, to help users understand the rule; it doesn&#8217;t affect how the rule actually runs.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add required field</strong></span>, then select a field from the index patterns or data view you specified for the rule. You can also start typing a field&#8217;s name to find it faster, or type in an entirely new custom field.
</li>
<li class="listitem">
Enter the field&#8217;s data type.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>(Optional) Add <span class="strong strong"><strong>Related integrations</strong></span> to associate the rule with one or more <a href="https://docs.elastic.co/en/integrations" class="ulink" target="_top">Elastic integrations</a>. This indicates the rule&#8217;s dependency on specific integrations and the data they generate, and allows users to confirm each integration&#8217;s <a class="xref" href="rules-ui-management.html#rule-prerequisites" title="Confirm rule prerequisites">installation status</a> when viewing the rule.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add integration</strong></span>, then select an integration from the list. You can also start typing an integration&#8217;s name to find it faster.
</li>
<li class="listitem">
Enter the version of the integration you want to associate with the rule, using <a href="https://semver.org" class="ulink" target="_top">semantic versioning</a>. For version ranges, you must use tilde or caret syntax. For example, <code class="literal">~1.2.3</code> is from 1.2.3 to any patch version less than 1.3.0, and <code class="literal">^1.2.3</code> is from 1.2.3 to any minor and patch version less than 2.0.0.
</li>
</ol>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Continue</strong></span> to <a class="xref" href="rules-ui-create.html#rule-ui-basic-params" title="Configure basic rule settings">configure basic rule settings</a>.
</li>
</ol>
</div>
<h3><a id="create-eql-rule"></a>Create an event correlation rule<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h3>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to <span class="strong strong"><strong>Rules</strong></span> &#8594; <span class="strong strong"><strong>Detection rules (SIEM)</strong></span> &#8594; <span class="strong strong"><strong>Create new rule</strong></span>. The <span class="strong strong"><strong>Create new rule</strong></span> page displays.
</li>
<li class="listitem">
<p>To create an event correlation rule using EQL, select <span class="strong strong"><strong>Event Correlation</strong></span>, then:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Define which Elasticsearch indices or data view the rule searches when querying for events.
</li>
<li class="listitem">
<p>Write an <a href="/guide/en/elasticsearch/reference/master/eql-syntax.html" class="ulink" target="_top">EQL query</a> that searches for matching events or a series of matching events.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>To find events that are missing in a sequence, use the <a href="/guide/en/elasticsearch/reference/master/eql-syntax.html#eql-missing-events" class="ulink" target="_top">missing events</a> syntax.</p>
</div>
</div>
<p>For example, the following rule detects when <code class="literal">msxsl.exe</code> makes an outbound
network connection:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p><span class="strong strong"><strong>Index patterns</strong></span>: <code class="literal">winlogbeat-*</code></p>
<p>Winlogbeat ships Windows events to Elastic Security.</p>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>EQL query</strong></span>:</p>
<div class="pre_wrapper lang-eql">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-eql">sequence by process.entity_id
  [process
    where event.type in ("start", "process_started")
    and process.name == "msxsl.exe"]
  [network
    where event.type == "connection"
    and process.name == "msxsl.exe"
    and network.direction == "outgoing"]</pre>
</div>
<p>Searches the <code class="literal">winlogbeat-*</code> indices for sequences of a <code class="literal">msxsl.exe</code> process start
event followed by an outbound network connection event that was started by the
<code class="literal">msxsl.exe</code> process.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/eql-rule-query-example.png" alt="eql rule query example">
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For sequence events, the Elastic Security app generates a single alert when all events listed in the sequence are detected. To see the matched sequence events in more detail, you can view the alert in the Timeline, and, if all events came from the same process, open the alert in Analyze Event view.</p>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>(Optional) Click the EQL settings icon (<span class="image"><img src="images/eql-settings-icon.png" alt="EQL settings icon" width="16" height="16"></span>) to configure additional fields used by <a href="/guide/en/elasticsearch/reference/master/eql.html#specify-a-timestamp-or-event-category-field" class="ulink" target="_top">EQL search</a>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Event category field</strong></span>: Contains the event classification, such as <code class="literal">process</code>, <code class="literal">file</code>, or <code class="literal">network</code>. This field is typically mapped as a field type in the <a href="/guide/en/elasticsearch/reference/master/keyword.html" class="ulink" target="_top">keyword family</a>. Defaults to the <code class="literal">event.category</code> ECS field.
</li>
<li class="listitem">
<span class="strong strong"><strong>Tiebreaker field</strong></span>: Sets a secondary field for sorting events (in ascending, lexicographic order) if they have the same timestamp.
</li>
<li class="listitem">
<span class="strong strong"><strong>Timestamp field</strong></span>: Contains the event timestamp used for sorting a sequence of events. This is different from the <span class="strong strong"><strong>Timestamp override</strong></span> advanced setting, which is used for querying events within a range. Defaults to the <code class="literal">@timestamp</code> ECS field.
</li>
</ul>
</div>
</li>
<li class="listitem">
<span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> (Optional, <a href="/pricing" class="ulink" target="_top">Platinum or higher subscription</a> required) Use <span class="strong strong"><strong>Suppress alerts by</strong></span> to reduce the number of repeated or duplicate alerts created by the rule. Refer to <a class="xref" href="alert-suppression.html" title="Suppress detection alerts">Suppress detection alerts</a> for more information.
</li>
<li class="listitem">
<p>(Optional) Create a list of <span class="strong strong"><strong>Required fields</strong></span> that the rule needs to function. This list is informational only, to help users understand the rule; it doesn&#8217;t affect how the rule actually runs.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add required field</strong></span>, then select a field from the index patterns or data view you specified for the rule. You can also start typing a field&#8217;s name to find it faster, or type in an entirely new custom field.
</li>
<li class="listitem">
Enter the field&#8217;s data type.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>(Optional) Add <span class="strong strong"><strong>Related integrations</strong></span> to associate the rule with one or more <a href="https://docs.elastic.co/en/integrations" class="ulink" target="_top">Elastic integrations</a>. This indicates the rule&#8217;s dependency on specific integrations and the data they generate, and allows users to confirm each integration&#8217;s <a class="xref" href="rules-ui-management.html#rule-prerequisites" title="Confirm rule prerequisites">installation status</a> when viewing the rule.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add integration</strong></span>, then select an integration from the list. You can also start typing an integration&#8217;s name to find it faster.
</li>
<li class="listitem">
Enter the version of the integration you want to associate with the rule, using <a href="https://semver.org" class="ulink" target="_top">semantic versioning</a>. For version ranges, you must use tilde or caret syntax. For example, <code class="literal">~1.2.3</code> is from 1.2.3 to any patch version less than 1.3.0, and <code class="literal">^1.2.3</code> is from 1.2.3 to any minor and patch version less than 2.0.0.
</li>
</ol>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Continue</strong></span> to <a class="xref" href="rules-ui-create.html#rule-ui-basic-params" title="Configure basic rule settings">configure basic rule settings</a>.
</li>
</ol>
</div>
<h3><a id="create-indicator-rule"></a>Create an indicator match rule<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h3>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Elastic Security provides limited support for indicator match rules. See <a class="xref" href="detection-engine-overview.html#support-indicator-rules" title="Limited support for indicator match rules">Limited support for indicator match rules</a> for more information.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to <span class="strong strong"><strong>Rules</strong></span> &#8594; <span class="strong strong"><strong>Detection rules (SIEM)</strong></span> &#8594; <span class="strong strong"><strong>Create new rule</strong></span>. The <span class="strong strong"><strong>Create new rule</strong></span> page displays.
</li>
<li class="listitem">
<p>To create a rule that searches for events whose specified field value matches the specified indicator field value in the indicator index patterns, select <span class="strong strong"><strong>Indicator Match</strong></span>, then fill in the following fields:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<span class="strong strong"><strong>Source</strong></span>: The individual index patterns or data view that specifies what data to search.
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Custom query</strong></span>: The query and filters used to retrieve the required results from
the Elastic Security event indices. For example, if you want to match documents that only contain a <code class="literal">destination.ip</code> address field, add <code class="literal">destination.ip : *</code>.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you want the rule to check every field in the indices, use this
wildcard expression: <code class="literal">*:*</code>.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can use Kibana saved queries (<span class="image"><img src="images/saved-query-menu.png" alt="Saved query menu" width="18" height="18"></span>) and queries from saved Timelines (<span class="strong strong"><strong>Import query from saved Timeline</strong></span>) as rule conditions.</p>
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Indicator index patterns</strong></span>: The indicator index patterns containing field values for which you want to generate alerts. This field is automatically populated with indices specified in the <code class="literal">securitySolution:defaultThreatIndex</code> advanced setting. For more information, see <a class="xref" href="advanced-settings.html#update-threat-intel-indices" title="Update default Elastic Security threat intelligence indices">Update default Elastic Security threat intelligence indices</a>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Data in indicator indices must be <a class="xref" href="siem-field-reference.html" title="Elastic Security ECS field reference">ECS compatible</a>, and so it must contain a <code class="literal">@timestamp</code> field.</p>
</div>
</div>
</li>
<li class="listitem">
<span class="strong strong"><strong>Indicator index query</strong></span>: The query and filters used to filter the fields from
the indicator index patterns. The default query <code class="literal">@timestamp &gt; "now-30d/d"</code> searches specified indicator indices for indicators ingested during the past 30 days and rounds the start time down to the nearest day (resolves to UTC <code class="literal">00:00:00</code>).
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Indicator mapping</strong></span>: Compares the values of the specified event and indicator fields, and generates an alert if the values are identical.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Only single-value fields are supported.</p>
</div>
</div>
<p>To define
which field values are compared from the indices add the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Field</strong></span>: The field used for comparing values in the Elastic Security event
indices.
</li>
<li class="listitem">
<span class="strong strong"><strong>Indicator index field</strong></span>: The field used for comparing values in the indicator
indices.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>You can add <code class="literal">AND</code> and <code class="literal">OR</code> clauses to define when alerts are generated.</p>
<p>For example, to create a rule that generates alerts when <code class="literal">host.name</code> <span class="strong strong"><strong>and</strong></span>
<code class="literal">destination.ip</code> field values in the <code class="literal">logs-*</code> or <code class="literal">packetbeat-*</code> Elastic Security indices
are identical to the corresponding field values in the <code class="literal">mock-threat-list</code> indicator
index, enter the rule parameters seen in the following image:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/indicator-rule-example.png" alt="Indicator match rule settings">
</div>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Before you create rules, create <a class="xref" href="timelines-ui.html" title="Investigate events in Timeline">Timeline templates</a> so
they can be selected here. When alerts generated by the rule are investigated
in the Timeline, Timeline query values are replaced with their corresponding alert
field values.</p>
</div>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
<span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> (Optional, <a href="/pricing" class="ulink" target="_top">Platinum or higher subscription</a> required) Select <span class="strong strong"><strong>Suppress alerts</strong></span> to reduce the number of repeated or duplicate alerts created by the rule. Refer to <a class="xref" href="alert-suppression.html" title="Suppress detection alerts">Suppress detection alerts</a> for more information.
</li>
<li class="listitem">
<p>(Optional) Create a list of <span class="strong strong"><strong>Required fields</strong></span> that the rule needs to function. This list is informational only, to help users understand the rule; it doesn&#8217;t affect how the rule actually runs.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add required field</strong></span>, then select a field from the index patterns or data view you specified for the rule. You can also start typing a field&#8217;s name to find it faster, or type in an entirely new custom field.
</li>
<li class="listitem">
Enter the field&#8217;s data type.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>(Optional) Add <span class="strong strong"><strong>Related integrations</strong></span> to associate the rule with one or more <a href="https://docs.elastic.co/en/integrations" class="ulink" target="_top">Elastic integrations</a>. This indicates the rule&#8217;s dependency on specific integrations and the data they generate, and allows users to confirm each integration&#8217;s <a class="xref" href="rules-ui-management.html#rule-prerequisites" title="Confirm rule prerequisites">installation status</a> when viewing the rule.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add integration</strong></span>, then select an integration from the list. You can also start typing an integration&#8217;s name to find it faster.
</li>
<li class="listitem">
Enter the version of the integration you want to associate with the rule, using <a href="https://semver.org" class="ulink" target="_top">semantic versioning</a>. For version ranges, you must use tilde or caret syntax. For example, <code class="literal">~1.2.3</code> is from 1.2.3 to any patch version less than 1.3.0, and <code class="literal">^1.2.3</code> is from 1.2.3 to any minor and patch version less than 2.0.0.
</li>
</ol>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Continue</strong></span> to <a class="xref" href="rules-ui-create.html#rule-ui-basic-params" title="Configure basic rule settings">configure basic rule settings</a>.
</li>
</ol>
</div>
<h4><a id="indicator-value-lists"></a>Use value lists with indicator match rules<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h4>
<p>While there are numerous ways you can add data into indicator indices, you can use value lists as the indicator match index in an indicator match rule. Take the following scenario, for example:</p>
<p>You uploaded a value list of known ransomware domains, and you want to be notified if any of those domains matches a value contained in a domain field in your security event index pattern.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Upload a value list of indicators.
</li>
<li class="listitem">
<p>Create an indicator match rule and fill in the following fields:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<span class="strong strong"><strong>Index patterns</strong></span>: The Elastic Security event indices on which the rule runs.
</li>
<li class="listitem">
<span class="strong strong"><strong>Custom query</strong></span>: The query and filters used to retrieve the required results from the Elastic Security event indices (e.g., <code class="literal">host.domain :*</code>).
</li>
<li class="listitem">
<span class="strong strong"><strong>Indicator index patterns</strong></span>: Value lists are stored in a hidden index called <code class="literal">.items-&lt;Kibana space&gt;</code>. Enter the name of the Kibana space in which this rule will run in this field.
</li>
<li class="listitem">
<span class="strong strong"><strong>Indicator index query</strong></span>: Enter the value <code class="literal">list_id :</code>, followed by the name of the value list you want to use as your indicator index (uploaded in Step 1 above).
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Indicator mapping</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Field</strong></span>: Enter the field from the Elastic Security event indices to be used for comparing values.
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Indicator index field</strong></span>: Enter the type of value list you created (i.e., <code class="literal">keyword</code>, <code class="literal">text</code>, or <code class="literal">IP</code>).</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you don&#8217;t remember this information, go to <span class="strong strong"><strong>Rules</strong></span> &#8594; <span class="strong strong"><strong>Detection rules (SIEM)</strong></span> &#8594; <span class="strong strong"><strong>Manage value lists</strong></span>. Locate the appropriate value list and note the field in the corresponding <code class="literal">Type</code> column. (Examples include keyword, text, and IP.)</p>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="imageblock screenshot">
<div class="content">
<img src="images/indicator_value_list.png" alt="indicator value list">
</div>
</div>
<h3><a id="create-new-terms-rule"></a>Create a new terms rule<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h3>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to <span class="strong strong"><strong>Rules</strong></span> &#8594; <span class="strong strong"><strong>Detection rules (SIEM)</strong></span> &#8594; <span class="strong strong"><strong>Create new rule</strong></span>. The <span class="strong strong"><strong>Create new rule</strong></span> page displays.
</li>
<li class="listitem">
<p>To create a rule that searches for each new term detected in source documents, select <span class="strong strong"><strong>New Terms</strong></span>, then:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Specify what data to search by entering individual Elasticsearch index patterns or selecting an existing data view.
</li>
<li class="listitem">
<p>Use the filter and query fields to create the criteria used for detecting
alerts.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can use Kibana saved queries (<span class="image"><img src="images/saved-query-menu.png" alt="Saved query menu" width="18" height="18"></span>) and queries from saved Timelines (<span class="strong strong"><strong>Import query from saved Timeline</strong></span>) as rule conditions.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Use the <span class="strong strong"><strong>Fields</strong></span> menu to select a field to check for new terms. You can also select up to three fields to detect a combination of new terms (for example, a <code class="literal">host.ip</code> and <code class="literal">host.id</code> that have never been observed together before).</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>When checking multiple fields, each unique combination of values from those fields is evaluated separately. For example, a document with <code class="literal">host.name: ["host-1", "host-2", "host-3"]</code> and <code class="literal">user.name: ["user-1", "user-2", "user-3"]</code> has 9 (3x3) unique combinations of <code class="literal">host.name</code> and <code class="literal">user.name</code>. A document with 11 values in <code class="literal">host.name</code> and 10 values in <code class="literal">user.name</code> has 110 (11x10) unique combinations. The new terms rule only evaluates 100 unique combinations per document, so selecting fields with large arrays of values might cause incorrect results.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Use the <span class="strong strong"><strong>History Window Size</strong></span> menu to specify the time range to search in minutes, hours, or days to determine if a term is new. The history window size must be larger than the rule interval plus additional look-back time, because the rule will look for terms where the only time(s) the term appears within the history window is <em>also</em> within the rule interval and additional look-back time.</p>
<p>For example, if a rule has an interval of 5 minutes, no additional look-back time, and a history window size of 7 days, a term will be considered new only if the time it appears within the last 7 days is also within the last 5 minutes. Configure the rule interval and additional look-back time when you <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule">set the rule&#8217;s schedule</a>.</p>
</li>
</ol>
</div>
</li>
<li class="listitem">
<span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> (Optional, <a href="/pricing" class="ulink" target="_top">Platinum or higher subscription</a> required) Use <span class="strong strong"><strong>Suppress alerts by</strong></span> to reduce the number of repeated or duplicate alerts created by the rule. Refer to <a class="xref" href="alert-suppression.html" title="Suppress detection alerts">Suppress detection alerts</a> for more information.
</li>
<li class="listitem">
<p>(Optional) Create a list of <span class="strong strong"><strong>Required fields</strong></span> that the rule needs to function. This list is informational only, to help users understand the rule; it doesn&#8217;t affect how the rule actually runs.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add required field</strong></span>, then select a field from the index patterns or data view you specified for the rule. You can also start typing a field&#8217;s name to find it faster, or type in an entirely new custom field.
</li>
<li class="listitem">
Enter the field&#8217;s data type.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>(Optional) Add <span class="strong strong"><strong>Related integrations</strong></span> to associate the rule with one or more <a href="https://docs.elastic.co/en/integrations" class="ulink" target="_top">Elastic integrations</a>. This indicates the rule&#8217;s dependency on specific integrations and the data they generate, and allows users to confirm each integration&#8217;s <a class="xref" href="rules-ui-management.html#rule-prerequisites" title="Confirm rule prerequisites">installation status</a> when viewing the rule.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add integration</strong></span>, then select an integration from the list. You can also start typing an integration&#8217;s name to find it faster.
</li>
<li class="listitem">
Enter the version of the integration you want to associate with the rule, using <a href="https://semver.org" class="ulink" target="_top">semantic versioning</a>. For version ranges, you must use tilde or caret syntax. For example, <code class="literal">~1.2.3</code> is from 1.2.3 to any patch version less than 1.3.0, and <code class="literal">^1.2.3</code> is from 1.2.3 to any minor and patch version less than 2.0.0.
</li>
</ol>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Continue</strong></span> to <a class="xref" href="rules-ui-create.html#rule-ui-basic-params" title="Configure basic rule settings">configure basic rule settings</a>.
</li>
</ol>
</div>
<h3><a id="create-esql-rule"></a>Create an ES|QL rule<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h3>
<p>Use <a href="/guide/en/elasticsearch/reference/master/esql.html" class="ulink" target="_top">ES|QL</a> to query your source events and aggregate event data. Query results are returned in a table with rows and columns. Each row becomes an alert.</p>
<p>To create an ES|QL rule:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to <span class="strong strong"><strong>Rules</strong></span> &#8594; <span class="strong strong"><strong>Detection rules (SIEM)</strong></span> &#8594; <span class="strong strong"><strong>Create new rule</strong></span>. The <span class="strong strong"><strong>Create new rule</strong></span> page appears.
</li>
<li class="listitem">
<p>Select <span class="strong strong"><strong>ES|QL</strong></span>, then write a query.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Refer to the sections below to learn more about <a class="xref" href="rules-ui-create.html#esql-rule-query-types" title="ES|QL query types">ES|QL query types</a>, <a class="xref" href="rules-ui-create.html#esql-query-design" title="Query design considerations">query design considerations</a>, and <a class="xref" href="rules-ui-create.html#esql-rule-limitations" title="ES|QL rule limitations">rule limitations</a>.</p>
</div>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Click the help icon (<span class="image"><img src="images/esql-help-ref-button.png" alt="Click the ES|QL help icon" width="20" height="20"></span>) to open the in-product reference documentation for all ES|QL commands and functions.</p>
</div>
</div>
</li>
<li class="listitem">
<p>(Optional) Create a list of <span class="strong strong"><strong>Required fields</strong></span> that the rule needs to function. This list is informational only, to help users understand the rule; it doesn&#8217;t affect how the rule actually runs.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add required field</strong></span>, then select a field from the index patterns or data view you specified for the rule. You can also start typing a field&#8217;s name to find it faster, or type in an entirely new custom field.
</li>
<li class="listitem">
Enter the field&#8217;s data type.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>(Optional) Add <span class="strong strong"><strong>Related integrations</strong></span> to associate the rule with one or more <a href="https://docs.elastic.co/en/integrations" class="ulink" target="_top">Elastic integrations</a>. This indicates the rule&#8217;s dependency on specific integrations and the data they generate, and allows users to confirm each integration&#8217;s <a class="xref" href="rules-ui-management.html#rule-prerequisites" title="Confirm rule prerequisites">installation status</a> when viewing the rule.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Click <span class="strong strong"><strong>Add integration</strong></span>, then select an integration from the list. You can also start typing an integration&#8217;s name to find it faster.
</li>
<li class="listitem">
Enter the version of the integration you want to associate with the rule, using <a href="https://semver.org" class="ulink" target="_top">semantic versioning</a>. For version ranges, you must use tilde or caret syntax. For example, <code class="literal">~1.2.3</code> is from 1.2.3 to any patch version less than 1.3.0, and <code class="literal">^1.2.3</code> is from 1.2.3 to any minor and patch version less than 2.0.0.
</li>
</ol>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Continue</strong></span> to <a class="xref" href="rules-ui-create.html#rule-ui-basic-params" title="Configure basic rule settings">configure basic rule settings</a>.
</li>
</ol>
</div>
<h4><a id="esql-rule-query-types"></a>ES|QL query types<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h4>
<p>ES|QL rule queries are loosely categorized into two types: aggregating and non-aggregating.</p>
<h5><a id="esql-agg-query"></a>Aggregating query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h5>
<p>Aggregating queries use <a href="/guide/en/elasticsearch/reference/master/esql-functions-operators.html#esql-agg-functions" class="ulink" target="_top"><code class="literal">STATS...BY</code></a> functions to aggregate source event data. Alerts generated by a rule with an aggregating query only contain the fields that the ES|QL query returns and any new fields that the query creates.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>A <em>new field</em> is a field that doesn&#8217;t exist in the query&#8217;s source index and is instead created when the rule runs. You can access new fields in the details of any alerts that are generated by the rule. For example, if you use the <code class="literal">STATS...BY</code> function to create a column with aggregated values, the column is created when the rule runs and is added as a new field to any alerts that are generated by the rule.</p>
</div>
</div>
<p>Here is an example aggregating query:</p>
<div class="pre_wrapper lang-esql">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-esql">FROM logs-*
| STATS host_count = COUNT(host.name) BY host.name
| SORT host_count DESC
| WHERE host_count &gt; 20</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
This query starts by searching logs from indices that match the pattern <code class="literal">logs-*</code>.
</li>
<li class="listitem">
The query then aggregates the count of events by <code class="literal">host.name</code>.
</li>
<li class="listitem">
Next, it sorts the result by <code class="literal">host_count</code> in descending order.
</li>
<li class="listitem">
Then, it filters for events where the <code class="literal">host_count</code> field appears more than 20 times during the specified rule interval.
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Rules that use aggregating queries might create duplicate alerts. This can happen  when events that occur in the additional look-back time are aggregated both in the current rule execution and in a previous rule execution.</p>
</div>
</div>
<h5><a id="esql-non-agg-query"></a>Non-aggregating query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h5>
<p>Non-aggregating queries don&#8217;t use <code class="literal">STATS...BY</code> functions and don&#8217;t aggregate source event data. Alerts generated by a non-aggregating query contain source event fields that the query returns, new fields the query creates, and all other fields in the source event document.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>A <em>new field</em> is a field that doesn&#8217;t exist in the query&#8217;s source index and is instead created when the rule runs. You can access new fields in the details of any alerts that are generated by the rule. For example, if you use the <a href="/guide/en/elasticsearch/reference/master/esql-commands.html#esql-eval" class="ulink" target="_top"><code class="literal">EVAL</code></a> command to append new columns with calculated values, the columns are created when the rule runs, and are added as new fields to any alerts generated by the rule.</p>
</div>
</div>
<p>Here is an example non-aggregating query:</p>
<div class="pre_wrapper lang-esql">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-esql">FROM logs-* METADATA _id, _index, _version
| WHERE event.category == "process"  AND event.id == "8a4f500d"
| LIMIT 10</pre>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
This query starts by querying logs from indices that match the pattern <code class="literal">logs-*</code>. The <code class="literal">METADATA _id, _index, _version</code> operator allows <a class="xref" href="rules-ui-create.html#esql-non-agg-query-dedupe" title="Turn on alert deduplication for rules using non-aggregating queries">alert deduplication</a>.
</li>
<li class="listitem">
Next, the query filters events where the <code class="literal">event.category</code> is a process and the <code class="literal">event.id</code> is <code class="literal">8a4f500d</code>.
</li>
<li class="listitem">
Then, it limits the output to the top 10 results.
</li>
</ul>
</div>
<h5><a id="esql-non-agg-query-dedupe"></a>Turn on alert deduplication for rules using non-aggregating queries<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h5>
<p>To deduplicate alerts, a query needs access to the <code class="literal">_id</code>, <code class="literal">_index</code>, and <code class="literal">_version</code> metadata fields of the queried source event documents. You can allow this by adding the <code class="literal">METADATA _id, _index, _version</code> operator after the <code class="literal">FROM</code> source command, for example:</p>
<div class="pre_wrapper lang-esql">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-esql">FROM logs-* METADATA _id, _index, _version
| WHERE event.category == "process"  AND event.id == "8a4f500d"
| LIMIT 10</pre>
</div>
<p>When those metadata fields are provided, unique alert IDs are created for each alert generated by the query.</p>
<p>When developing the query, make sure you don&#8217;t <a href="/guide/en/elasticsearch/reference/master/esql-commands.html#esql-drop" class="ulink" target="_top"><code class="literal">DROP</code></a> or filter out the <code class="literal">_id</code>, <code class="literal">_index</code>, or <code class="literal">_version</code> metadata fields.</p>
<p>Here is an example of a query that fails to deduplicate alerts. It uses the <code class="literal">DROP</code> command to omit the <code class="literal">_id</code> property from the results table:</p>
<div class="pre_wrapper lang-esql">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-esql">FROM logs-* METADATA _id, _index, _version
| WHERE event.category == "process"  AND event.id == "8a4f500d"
| DROP _id
| LIMIT 10</pre>
</div>
<p>Here is another example of an invalid query that uses the <code class="literal">KEEP</code> command to only return <code class="literal">event.*</code> fields in the results table:</p>
<div class="pre_wrapper lang-esql">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-esql">FROM logs-* METADATA _id, _index, _version
| WHERE event.category == "process"  AND event.id == "8a4f500d"
| KEEP event.*
| LIMIT 10</pre>
</div>
<h4><a id="esql-query-design"></a>Query design considerations<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h4>
<p>When writing your query, consider the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>The <a href="/guide/en/elasticsearch/reference/master/esql-commands.html#esql-limit" class="ulink" target="_top"><code class="literal">LIMIT</code></a> command specifies the maximum number of rows an ES|QL query returns and the maximum number of alerts created per rule execution. Similarly, a detection rule&#8217;s <span class="strong strong"><strong>Max alerts per run</strong></span> setting specifies the maximum number of alerts it can create every time it runs.</p>
<p>If the <code class="literal">LIMIT</code> value and <span class="strong strong"><strong>Max alerts per run</strong></span> value are different, the rule uses the lower value to determine the maximum number of alerts the rule generates.</p>
</li>
<li class="listitem">
When writing an aggregating query, use the <a href="/guide/en/elasticsearch/reference/master/esql-commands.html#esql-stats-by" class="ulink" target="_top"><code class="literal">STATS...BY</code></a> command with fields that you want to search and filter for after alerts are created. For example, using the <code class="literal">host.name</code>, <code class="literal">user.name</code>, <code class="literal">process.name</code> fields with the <code class="literal">BY</code> operator of the <code class="literal">STATS...BY</code> command returns these fields in alert documents, and allows you to search and filter for them from the Alerts table.
</li>
</ul>
</div>
<h4><a id="esql-rule-limitations"></a>ES|QL rule limitations<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h4>
<p>If your ES|QL query creates new fields that aren’t part of the ECS schema, they aren&#8217;t mapped to the alerts index so you can&#8217;t search for or filter them in the Alerts table. As a workaround, create <a class="xref" href="runtime-fields.html" title="Create runtime fields in Elastic Security">runtime fields</a>.</p>
<h4><a id="custom-highlighted-esql-fields"></a>Highlight fields returned by the ES|QL rule query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h4>
<p>When configuring an ES|QL rule&#8217;s <span class="strong strong"><strong><a class="xref" href="rules-ui-create.html#rule-ui-advanced-params" title="Configure advanced rule settings (optional)">Custom highlighted fields</a></strong></span>, you can specify any fields that the rule&#8217;s aggregating or non-aggregating query return. This can help ensure that returned fields are visible in the alert details flyout while you&#8217;re investigating alerts.</p>
<h3><a id="rule-ui-basic-params"></a>Configure basic rule settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h3>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>In the <span class="strong strong"><strong>About rule</strong></span> pane, fill in the following fields:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<span class="strong strong"><strong>Name</strong></span>: The rule&#8217;s name.
</li>
<li class="listitem">
<span class="strong strong"><strong>Description</strong></span>: A description of what the rule does.
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Default severity</strong></span>: Select the severity level of alerts created by the rule:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Low</strong></span>: Alerts that are of interest but generally are not considered to be
security incidents. Sometimes a combination of low severity alerts can
indicate suspicious activity.
</li>
<li class="listitem">
<span class="strong strong"><strong>Medium</strong></span>: Alerts that require investigation.
</li>
<li class="listitem">
<span class="strong strong"><strong>High</strong></span>: Alerts that require an immediate investigation.
</li>
<li class="listitem">
<span class="strong strong"><strong>Critical</strong></span>: Alerts that indicate it is highly likely a security incident has
occurred.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Severity override</strong></span> (optional): Select to use source event values to
override the <span class="strong strong"><strong>Default severity</strong></span> in generated alerts. When selected, a UI
component is displayed where you can map the source event field values to
severity levels. The following example shows how to map severity levels to <code class="literal">host.name</code>
values:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/severity-mapping-ui.png" alt="severity mapping ui">
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For threshold rules, not all source event values can be used for overrides; only the fields that were aggregated over (the <code class="literal">Group by</code> fields) will contain data. Please also note that overrides are not supported for event correlation rules.</p>
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Default risk score</strong></span>: A numerical value between 0 and 100 that indicates the risk of events detected by the rule. This setting changes to a default value when you change the <span class="strong strong"><strong>Severity</strong></span> level, but you can adjust the risk score as needed. General guidelines are:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">0</code> - <code class="literal">21</code> represents low severity.
</li>
<li class="listitem">
<code class="literal">22</code> - <code class="literal">47</code> represents medium severity.
</li>
<li class="listitem">
<code class="literal">48</code> - <code class="literal">73</code> represents high severity.
</li>
<li class="listitem">
<code class="literal">74</code> - <code class="literal">100</code> represents critical severity.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Risk score override</strong></span> (optional): Select to use a source event value to
override the <span class="strong strong"><strong>Default risk score</strong></span> in generated alerts. When selected, a UI
component is displayed to select the source field used for the risk
score. For example, if you want to use the source event&#8217;s risk score in
alerts:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/risk-source-field-ui.png" alt="risk source field ui">
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For threshold rules, not all source event values can be used for overrides; only the fields that were aggregated over (the <code class="literal">Group by</code> fields) will contain data.</p>
</div>
</div>
</li>
<li class="listitem">
<span class="strong strong"><strong>Tags</strong></span> (optional): Words and phrases used to categorize, filter, and search
the rule.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>Continue with <span class="strong strong"><strong>one</strong></span> of the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="rules-ui-create.html#rule-ui-advanced-params" title="Configure advanced rule settings (optional)">Configure advanced rule settings (optional)</a>
</li>
<li class="listitem">
<a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule">Set the rule&#8217;s schedule</a>
</li>
</ul>
</div>
</li>
</ol>
</div>
<h3><a id="rule-ui-advanced-params"></a>Configure advanced rule settings (optional)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h3>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Click <span class="strong strong"><strong>Advanced settings</strong></span> and fill in the following fields where applicable:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<span class="strong strong"><strong>Reference URLs</strong></span> (optional): References to information that is relevant to
the rule. For example, links to background information.
</li>
<li class="listitem">
<span class="strong strong"><strong>False positive examples</strong></span> (optional): List of common scenarios that may produce
false-positive alerts.
</li>
<li class="listitem">
<span class="strong strong"><strong>MITRE ATT&amp;CK<sup>TM</sup> threats</strong></span> (optional): Add relevant <a href="https://attack.mitre.org/" class="ulink" target="_top">MITRE</a> framework tactics, techniques, and subtechniques.
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Custom highlighted fields</strong></span> (optional): Specify highlighted fields for personalized alert investigation flows. Fields with values are added to the <a class="xref" href="view-alert-details.html#investigation-section" title="Investigation">Highlighted fields</a> section within the alert details flyout. Fields without values aren&#8217;t added. After you create the rule, you can find all custom highlighted fields in the About section of the rule details page.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>There&#8217;s no limit to the number of custom highlighted fields you can add.</p>
</div>
</div>
</li>
<li class="listitem">
<span class="strong strong"><strong>Setup guide</strong></span> (optional): Instructions on rule prerequisites such as required integrations, configuration steps, and anything else needed for the rule to work correctly.
</li>
<li class="listitem">
<span class="strong strong"><strong>Investigation guide</strong></span> (optional): Information for analysts investigating
alerts created by the rule. You can also add action buttons to <a class="xref" href="invest-guide-run-osquery.html" title="Run Osquery from investigation guides">run Osquery</a> or <a class="xref" href="interactive-investigation-guides.html" title="Launch Timeline from investigation guides">launch Timeline investigations</a> using alert data.
</li>
<li class="listitem">
<span class="strong strong"><strong>Author</strong></span> (optional): The rule&#8217;s authors.
</li>
<li class="listitem">
<span class="strong strong"><strong>License</strong></span> (optional): The rule&#8217;s license.
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Elastic endpoint exceptions</strong></span> (optional): Adds all Elastic Endpoint Security
rule exceptions to this rule (refer to <a class="xref" href="add-exceptions.html#endpoint-rule-exceptions" title="Add Elastic Endpoint exceptions">Add Elastic Endpoint exceptions</a> to learn more about adding endpoint exceptions).</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you select this option, you can add
<a class="xref" href="add-exceptions.html#endpoint-rule-exceptions" title="Add Elastic Endpoint exceptions">Endpoint exceptions</a> on the Rule details page.
Additionally, all future exceptions added to the Endpoint Security rule
also affect this rule.</p>
</div>
</div>
</li>
<li class="listitem">
<span class="strong strong"><strong>Building block</strong></span> (optional): Select to create a building-block rule. By
default, alerts generated from a building-block rule are not displayed in the
UI. See <a class="xref" href="building-block-rule.html" title="About building block rules"><em>About building block rules</em></a> for more information.
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Max alerts per run</strong></span> (optional): Specify the maximum number of alerts the rule can create each time it runs. Default is 100.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This setting can be superseded by the <a href="/guide/en/kibana/master/alert-action-settings-kb.html#alert-settings" class="ulink" target="_top">Kibana configuration setting</a> <code class="literal">xpack.alerting.rules.run.alerts.max</code>, which determines the maximum alerts generated by <em>any</em> rule in the Kibana alerting framework. For example, if <code class="literal">xpack.alerting.rules.run.alerts.max</code> is set to <code class="literal">1000</code>, the rule can generate no more than 1000 alerts even if <span class="strong strong"><strong>Max alerts per run</strong></span> is set higher.</p>
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Indicator prefix override</strong></span>: Define the location of indicator data within the structure of indicator documents. When the indicator match rule executes, it queries specified indicator indices and references this setting to locate fields with indicator data. This data is used to enrich indicator match alerts with metadata about matched threat indicators. The default value for this setting is <code class="literal">threat.indicator</code>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>If your threat indicator data is at a different location, update this setting accordingly to ensure alert enrichment can still be performed.</p>
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Rule name override</strong></span> (optional): Select a source event field to use as the
rule name in the UI (Alerts table). This is useful for exposing, at a glance,
more information about an alert. For example, if the rule generates alerts from
Suricata, selecting <code class="literal">event.action</code> lets you see what action (Suricata category)
caused the event directly in the Alerts table.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For threshold rules, not all source event values can be used for overrides; only the fields that were aggregated over (the <code class="literal">Group by</code> fields) will contain data.</p>
</div>
</div>
</li>
<li class="listitem">
<p><span class="strong strong"><strong>Timestamp override</strong></span> (optional): Select a source event timestamp field. When selected, the rule&#8217;s query uses the selected field, instead of the default <code class="literal">@timestamp</code> field, to search for alerts. This can help reduce missing alerts due to network or server outages. Specifically, if your ingest pipeline adds a timestamp when events are sent to Elasticsearch, this avoids missing alerts due to ingestion delays.
However, if you know your data source has an inaccurate <code class="literal">@timestamp</code> value, it is recommended you select the <span class="strong strong"><strong>Do not use @timestamp as a fallback timestamp field</strong></span> option to ignore the <code class="literal">@timestamp</code> field entirely.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <a href="/guide/en/beats/filebeat/master/filebeat-module-microsoft.html" class="ulink" target="_top">Microsoft</a> and
<a href="/guide/en/beats/filebeat/master/filebeat-module-google_workspace.html" class="ulink" target="_top">Google Workspace</a> Filebeat modules have an <code class="literal">event.ingested</code> timestamp field that can be used instead of the default <code class="literal">@timestamp</code> field.</p>
</div>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Continue</strong></span>. The <span class="strong strong"><strong>Schedule rule</strong></span> pane is displayed.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/schedule-rule.png" alt="schedule rule">
</div>
</div>
</li>
<li class="listitem">
Continue with <a class="xref" href="rules-ui-create.html#rule-schedule" title="Set the rule&#8217;s schedule">setting the rule&#8217;s schedule</a>.
</li>
</ol>
</div>
<h3><a id="rule-schedule"></a>Set the rule&#8217;s schedule<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h3>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Select how often the rule runs.
</li>
<li class="listitem">
<p>Optionally, add <code class="literal">Additional look-back time</code> to the rule. When defined, the
rule searches indices with the additional time.</p>
<p>For example, if you set a rule to run every 5 minutes with an additional
look-back time of 1 minute, the rule runs every 5 minutes but analyzes the
documents added to indices during the last 6 minutes.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>It is recommended to set the <code class="literal">Additional look-back time</code> to at
least 1 minute. This ensures there are no missing alerts when a rule does not
run exactly at its scheduled time.</p>
<p>Elastic Security prevents duplication. Any duplicate alerts that are discovered during the
<code class="literal">Additional look-back time</code> are <em>not</em> created.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Continue</strong></span>. The <span class="strong strong"><strong>Rule actions</strong></span> pane is displayed.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/available-action-types.png" alt="Available connector types">
</div>
</div>
</li>
<li class="listitem">
<p>Do either of the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Continue onto <a class="xref" href="rules-ui-create.html#rule-notifications" title="Set up alert notifications (optional)">setting up alert notifications</a> and <a class="xref" href="rules-ui-create.html#rule-response-action" title="Set up response actions (optional)">Response Actions</a> (optional).
</li>
<li class="listitem">
Create the rule (with or without activation).
</li>
</ul>
</div>
</li>
</ol>
</div>
<h3><a id="rule-notifications"></a>Set up alert notifications (optional)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h3>
<p>Use Kibana Actions to set up notifications sent via other systems when alerts
are generated.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>To use Kibana Actions for alert notifications, you need the
<a href="/subscriptions" class="ulink" target="_top">appropriate license</a> and your role needs <span class="strong strong"><strong>All</strong></span> privileges for the <span class="strong strong"><strong>Action and Connectors</strong></span> feature. For more information, see <a class="xref" href="case-permissions.html" title="Cases prerequisites">Cases prerequisites</a>.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Select a connector type to determine how notifications are sent. For example, if you select the Jira connector, notifications are sent to your Jira system.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Each action type requires a connector. Connectors store the
information required to send the notification from the external system. You can
configure connectors while creating the rule or in <span class="strong strong"><strong>Stack Management</strong></span> &#8594; <span class="strong strong"><strong>Connectors</strong></span>. For more
information, see <a href="/guide/en/kibana/master/action-types.html" class="ulink" target="_top">Action and connector types</a>.</p>
</div>
</div>
<div class="imageblock screenshot">
<div class="content">
<img src="images/available-action-types.png" alt="Available connector types">
</div>
</div>
</li>
<li class="listitem">
<p>After you select a connector, set its action frequency to define when notifications are sent:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p><span class="strong strong"><strong>Summary of alerts</strong></span>: Select this option to get a report that summarizes generated alerts, which you can review at your convenience. Alert summaries will be sent at the specified time intervals.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When setting a custom notification frequency, do not choose a time that is shorter than the rule&#8217;s execution schedule.</p>
</div>
</div>
</li>
<li class="listitem">
<span class="strong strong"><strong>For each alert</strong></span>: Select this option to ensure notifications are sent every time new alerts are generated.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>(Optional) Specify additional conditions that need to be met for notifications to send. Click the toggle to enable a setting, then add the required details:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>If alert matches query</strong></span>: Enter a KQL query that defines field-value pairs or query conditions that must be met for notifications to send. The query only searches alert documents in the indices specified for the rule.
</li>
<li class="listitem">
<span class="strong strong"><strong>If alert is generated during timeframe</strong></span>: Set timeframe details. Notifications are only sent if alerts are generated within the timeframe you define.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Complete the required connector type fields. Here is an example with Jira:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/selected-action-type.png" alt="selected action type">
</div>
</div>
</li>
<li class="listitem">
Use the default notification message or customize it. You can add more context to the message by clicking the icon above the message text box and selecting from a list of available <a class="xref" href="rules-ui-create.html#rule-action-variables" title="Alert notification placeholders">alert notification variables</a>.
</li>
<li class="listitem">
<p>Create the rule with or without activation.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When you activate a rule, it is queued, and its schedule is determined by
its initial run time. For example, if you activate a rule that runs every 5
minutes at 14:03 but it does not run until 14:04, it will run again at 14:09.</p>
</div>
</div>
</li>
</ol>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>After you activate a rule, you can check if it is running as expected
using the <a class="xref" href="alerts-ui-monitor.html" title="Monitor and troubleshoot rule executions">Monitoring tab</a> on the Rules page. If you see
values in the <code class="literal">Gap</code> column, you can <a class="xref" href="alerts-ui-monitor.html#troubleshoot-signals" title="Troubleshoot missing alerts">Troubleshoot missing alerts</a>.</p>
<p>When a rule fails to run, the Elastic Security app tries to rerun it at its next
scheduled run time.</p>
</div>
</div>
<h4><a id="rule-action-variables"></a>Alert notification placeholders<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h4>
<p>You can use <a href="http://mustache.github.io/" class="ulink" target="_top">mustache syntax</a> to add variables to notification messages. The action frequency you choose determines the variables you can select from.</p>
<p>The following variables can be passed for all rules:</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Refer to <a href="/guide/en/kibana/master/rule-action-variables.html#alert-summary-action-variables" class="ulink" target="_top">Action frequency: Summary of alerts</a> to learn about additional variables that can be passed if the rule&#8217;s action frequency is <span class="strong strong"><strong>Summary of alerts</strong></span>.</p>
</div>
</div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">{{context.alerts}}</code>: Array of detected alerts
</li>
<li class="listitem">
<code class="literal">{{{context.results_link}}}</code>: URL to the alerts in Kibana
</li>
<li class="listitem">
<code class="literal">{{context.rule.anomaly_threshold}}</code>: Anomaly threshold score above which
alerts are generated (machine learning rules only)
</li>
<li class="listitem">
<code class="literal">{{context.rule.description}}</code>: Rule description
</li>
<li class="listitem">
<code class="literal">{{context.rule.false_positives}}</code>: Rule false positives
</li>
<li class="listitem">
<code class="literal">{{context.rule.filters}}</code>: Rule filters (query rules only)
</li>
<li class="listitem">
<code class="literal">{{context.rule.id}}</code>: Unique rule ID returned after creating the rule
</li>
<li class="listitem">
<code class="literal">{{context.rule.index}}</code>: Indices rule runs on (query rules only)
</li>
<li class="listitem">
<code class="literal">{{context.rule.language}}</code>: Rule query language (query rules only)
</li>
<li class="listitem">
<code class="literal">{{context.rule.machine_learning_job_id}}</code>: ID of associated machine learning job (machine learning
rules only)
</li>
<li class="listitem">
<code class="literal">{{context.rule.max_signals}}</code>: Maximum allowed number of alerts per rule
execution
</li>
<li class="listitem">
<code class="literal">{{context.rule.name}}</code>: Rule name
</li>
<li class="listitem">
<code class="literal">{{context.rule.query}}</code>: Rule query (query rules only)
</li>
<li class="listitem">
<code class="literal">{{context.rule.references}}</code>: Rule references
</li>
<li class="listitem">
<p><code class="literal">{{context.rule.risk_score}}</code>: Default rule risk score</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This placeholder contains the rule&#8217;s default values even when the <span class="strong strong"><strong>Risk score override</strong></span> option is used.</p>
</div>
</div>
</li>
<li class="listitem">
<code class="literal">{{context.rule.rule_id}}</code>: Generated or user-defined rule ID that can be
used as an identifier across systems
</li>
<li class="listitem">
<code class="literal">{{context.rule.saved_id}}</code>: Saved search ID
</li>
<li class="listitem">
<p><code class="literal">{{context.rule.severity}}</code>: Default rule severity</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This placeholder contains the rule&#8217;s default values even when the <span class="strong strong"><strong>Severity override</strong></span> option is used.</p>
</div>
</div>
</li>
<li class="listitem">
<code class="literal">{{context.rule.threat}}</code>: Rule threat framework
</li>
<li class="listitem">
<code class="literal">{{context.rule.threshold}}</code>: Rule threshold values (threshold rules only)
</li>
<li class="listitem">
<code class="literal">{{context.rule.timeline_id}}</code>: Associated Timeline ID
</li>
<li class="listitem">
<code class="literal">{{context.rule.timeline_title}}</code>: Associated Timeline name
</li>
<li class="listitem">
<code class="literal">{{context.rule.type}}</code>: Rule type
</li>
<li class="listitem">
<code class="literal">{{context.rule.version}}</code>: Rule version
</li>
<li class="listitem">
<code class="literal">{{date}}`</code>: Date the rule scheduled the action
</li>
<li class="listitem">
<code class="literal">{{kibanaBaseUrl}}</code>: Configured <code class="literal">server.publicBaseUrl</code> value, or empty string if not configured
</li>
<li class="listitem">
<code class="literal">{{rule.id}}</code>: ID of the rule
</li>
<li class="listitem">
<code class="literal">{{rule.name}}</code>: Name of the rule
</li>
<li class="listitem">
<code class="literal">{{rule.spaceId}}</code>: Space ID of the rule
</li>
<li class="listitem">
<code class="literal">{{rule.tags}}</code>: Tags of the rule
</li>
<li class="listitem">
<code class="literal">{{rule.type}}</code>: Type of rule
</li>
<li class="listitem">
<code class="literal">{{state.signals_count}}</code>: Number of alerts detected
</li>
</ul>
</div>
<p>The following variables can only be passed if the rule’s action frequency is for each alert:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">{{alert.actionGroup}}</code>: Action group of the alert that scheduled actions for the rule
</li>
<li class="listitem">
<code class="literal">{{alert.actionGroupName}}</code>: Human-readable name of the action group of the alert that scheduled actions for the rule
</li>
<li class="listitem">
<code class="literal">{{alert.actionSubgroup}}</code>: Action subgroup of the alert that scheduled actions for the rule
</li>
<li class="listitem">
<code class="literal">{{alert.id}}</code>: ID of the alert that scheduled actions for the rule
</li>
<li class="listitem">
<code class="literal">{{alert.flapping}}</code>: A flag on the alert that indicates whether the alert status is changing repeatedly
</li>
</ul>
</div>
<h5><a id="placeholder-examples"></a>Alert placeholder examples<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h5>
<p>To understand which fields to parse, see the <a class="xref" href="rule-api-overview.html" title="Detections API"><em>Detections API</em></a> to view the JSON representation of rules.</p>
<p>Example using <code class="literal">{{context.rule.filters}}</code> to output a list of filters:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{{#context.rule.filters}}
{{^meta.disabled}}{{meta.key}} {{#meta.negate}}NOT {{/meta.negate}}{{meta.type}} {{^exists}}{{meta.value}}{{meta.params.query}}{{/exists}}{{/meta.disabled}}
{{/context.rule.filters}}</pre>
</div>
<p>Example using <code class="literal">{{context.alerts}}</code> as an array, which contains each alert generated since the last time the action was executed:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{{#context.alerts}}
Detection alert for user: {{user.name}}
{{/context.alerts}}</pre>
</div>
<p>Example using the mustache "current element" notation <code class="literal">{{.}}</code> to output all the rule references in the <code class="literal">signal.rule.references</code> array:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{{#signal.rule.references}} {{.}} {{/signal.rule.references}}</pre>
</div>
<h3><a id="rule-response-action"></a>Set up response actions (optional)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h3>
<p>Use Response Actions to set up additional functionality that will run whenever a rule executes:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Osquery</strong></span>: Include live Osquery queries with a custom query rule. When an alert is generated, Osquery automatically collects data on the system related to the alert. Refer to <a class="xref" href="osquery-response-action.html" title="Add Osquery Response Actions"><em>Add Osquery Response Actions</em></a> to learn more.
</li>
<li class="listitem">
<span class="strong strong"><strong>Elastic Defend</strong></span>: Automatically run response actions on an endpoint when rule conditions are met. For example, you can automatically isolate a host or terminate a process when specific activities or events are detected on the host. Refer to <a class="xref" href="automated-response-actions.html" title="Automated response actions"><em>Automated response actions</em></a> to learn more.
</li>
</ul>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Host isolation involves quarantining a host from the network to prevent further spread of threats and limit potential damage. Be aware that automatic host isolation can cause unintended consequences, such as disrupting legitimate user activities or blocking critical business processes.</p>
</div>
</div>
<div class="imageblock screenshot">
<div class="content">
<img src="images/available-response-actions.png" alt="Shows available response actions">
</div>
</div>
<h3><a id="preview-rules"></a>Preview your rule (optional)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/main/docs/detections/rules-ui-create.asciidoc">edit</a></h3>
<p>You can preview any custom or prebuilt rule to find out how noisy it will be. For a custom rule, you can then adjust the rule&#8217;s query or other settings.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>To preview rules, you need the <code class="literal">read</code> privilege for the <code class="literal">.preview.alerts-security.alerts-&lt;space-id&gt;</code> and <code class="literal">.internal.preview.alerts-security.alerts-&lt;space-id&gt;-*</code> indices, plus <code class="literal">All</code> privileges for the Security feature. Refer to <a class="xref" href="detections-permissions-section.html" title="Detections prerequisites and requirements">Detections prerequisites and requirements</a> for more information.</p>
</div>
</div>
<p>Click the <span class="strong strong"><strong>Rule preview</strong></span> button while creating or editing a rule. The preview opens in a side panel, showing a histogram and table with the alerts you can expect, based on the defined rule settings and past events in your indices.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/preview-rule.png" alt="Rule preview">
</div>
</div>
<p>The preview also includes the effects of rule exceptions and override fields. In the histogram, alerts are stacked by <code class="literal">event.category</code> (or <code class="literal">host.name</code> for machine learning rules), and alerts with multiple values are counted more than once.</p>
<p>To interact with the rule preview:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Use the date and time picker to define the preview&#8217;s time range.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Avoid setting long time ranges with short rule intervals, or the rule preview might time out.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Refresh</strong></span> to update the preview.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
When you edit the rule&#8217;s settings or the preview&#8217;s time range, the button changes from blue (<span class="image"><img src="images/rule-preview-refresh-circle.png" alt="Blue circular refresh icon" width="16" height="17"></span>) to green (<span class="image"><img src="images/rule-preview-refresh-arrow.png" alt="Green right-pointing arrow refresh icon" width="17" height="17"></span>) to indicate that the rule has been edited since the last preview.
</li>
<li class="listitem">
For a relative time range (such as <code class="literal">Last 1 hour</code>), refresh the preview to check for the latest results. (Previews don&#8217;t automatically refresh with new incoming data.)
</li>
</ul>
</div>
</li>
<li class="listitem">
Click the <span class="strong strong"><strong>View details</strong></span> icon (<span class="image"><img src="images/view-details-icon.png" alt="View details icon" width="16" height="15"></span>) in the alerts table to view the details of a particular alert.
</li>
<li class="listitem">
To resize the preview, hover between the rule settings and preview, then click and drag the border. You can also click the border, then the collapse icon (<span class="image"><img src="images/collapse-right-icon.png" alt="Collapse icon" width="16" height="17"></span>) to collapse and expand the preview.
</li>
<li class="listitem">
To close the preview, click the <span class="strong strong"><strong>Rule preview</strong></span> button again.
</li>
</ul>
</div>


</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="about-rules.html">« About detection rules</a>
</span>
<span class="next">
<a href="rules-cross-cluster-search.html">Cross-cluster search and detection rules »</a>
</span>
</div>
</body>
</html>
