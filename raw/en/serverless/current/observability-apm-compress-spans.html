<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Compress spans | Serverless | Elastic</title>
<meta class="elastic" name="content" content="Compress spans | Serverless">

<link rel="home" href="index.html" title="Serverless"/>
<link rel="up" href="observability-apm-reduce-your-data-usage.html" title="Reduce your data usage"/>
<link rel="prev" href="observability-apm-transaction-sampling.html" title="Transaction sampling"/>
<link rel="next" href="observability-apm-stacktrace-collection.html" title="Stacktrace collection"/>
<meta class="elastic" name="product_version" content="main"/>
<meta class="elastic" name="product_name" content="Serverless"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Serverless/Guide"/>
<meta name="DC.subject" content="Serverless"/>
<meta name="DC.identifier" content="main"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="observability-apm-transaction-sampling.html">« Transaction sampling</a>
</span>
<span class="next">
<a href="observability-apm-stacktrace-collection.html">Stacktrace collection »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Serverless</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="what-is-observability-serverless.html">Elastic Observability serverless</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="observability-apm.html">Application performance monitoring (APM)</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="observability-apm-reduce-your-data-usage.html">Reduce your data usage</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Compress spans</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-compress-spans.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h4 class="title"><a id="observability-apm-compress-spans"></a>Compress spans</h4><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-compress-spans.asciidoc">edit</a></div>
</div></div></div>
<p>In some cases, APM agents may collect large amounts of very similar or identical spans in a transaction.
For example, this can happen if spans are captured inside a loop or in unoptimized SQL queries that use multiple
queries instead of joins to fetch related data.</p>
<p>In such cases, the upper limit of spans per transaction (by default, 500 spans) can be reached quickly, causing the agent to stop capturing potentially more relevant spans for a given transaction.</p>
<p>Capturing similar or identical spans often isn&#8217;t helpful, especially if they are of very short duration.
They can also clutter the UI, and cause processing and storage overhead.</p>
<p>To address this problem, APM agents can compress similar spans into a single span.
The compressed span retains most of the original span information, including the overall duration and number of spans it represents.</p>
<p>Regardless of the compression strategy, a span is eligible for compression if:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
It has not propagated its trace context.
</li>
<li class="listitem">
It is an <em>exit</em> span (such as database query spans).
</li>
<li class="listitem">
Its outcome is not <code class="literal">"failure"</code>.
</li>
</ul>
</div>
<div class="position-relative"><h6><a id="observability-apm-compress-spans-compression-strategies"></a>Compression strategies</h6><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-compress-spans.asciidoc">edit</a></div>
<p>The APM agent selects between two strategies to decide if adjacent spans can be compressed.
In both strategies, only one previous span needs to be kept in memory.
This ensures that the agent doesn&#8217;t require large amounts of memory to enable span compression.</p>
<div class="position-relative"><h7><a id="observability-apm-compress-spans-same-kind-strategy"></a>Same-Kind strategy</h7><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-compress-spans.asciidoc">edit</a></div>
<p>The agent uses the same-kind strategy if two adjacent spans have the same:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
span type
</li>
<li class="listitem">
span subtype
</li>
<li class="listitem">
<code class="literal">destination.service.resource</code> (e.g. database name)
</li>
</ul>
</div>
<div class="position-relative"><h7><a id="observability-apm-compress-spans-exact-match-strategy"></a>Exact-Match strategy</h7><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-compress-spans.asciidoc">edit</a></div>
<p>The agent uses the exact-match strategy if two adjacent spans have the same:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
span name
</li>
<li class="listitem">
span type
</li>
<li class="listitem">
span subtype
</li>
<li class="listitem">
<code class="literal">destination.service.resource</code> (e.g. database name)
</li>
</ul>
</div>
<div class="position-relative"><h6><a id="observability-apm-compress-spans-settings"></a>Settings</h6><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-compress-spans.asciidoc">edit</a></div>
<p>You can specify the maximum span duration in the agent&#8217;s configuration settings.
Spans with a duration longer than the specified value will not be compressed.</p>
<p>For the "Same-Kind" strategy, the default maximum span duration is 0 milliseconds, which means that
the "Same-Kind" strategy is disabled by default.
For the "Exact-Match" strategy, the default limit is 50 milliseconds.</p>
<div class="position-relative"><h7><a id="observability-apm-compress-spans-agent-support"></a>Agent support</h7><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-compress-spans.asciidoc">edit</a></div>
<p>Support for span compression is available in the following agents and can be configured
using the options listed below:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Agent</th>
<th align="left" valign="top">Same-kind config</th>
<th align="left" valign="top">Exact-match config</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>Go agent</strong></span></p></td>
<td align="left" valign="top"><p><a href="/guide/en/apm/agent/go/2.x/configuration.html#config-span-compression-same-kind-duration" class="ulink" target="_top"><code class="literal">ELASTIC_APM_SPAN_COMPRESSION_SAME_KIND_MAX_DURATION</code></a></p></td>
<td align="left" valign="top"><p><a href="/guide/en/apm/agent/go/2.x/configuration.html#config-span-compression-exact-match-duration" class="ulink" target="_top"><code class="literal">ELASTIC_APM_SPAN_COMPRESSION_EXACT_MATCH_MAX_DURATION</code></a></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>Java agent</strong></span></p></td>
<td align="left" valign="top"><p><a href="/guide/en/apm/agent/java/1.x/config-huge-traces.html#config-span-compression-same-kind-max-duration" class="ulink" target="_top"><code class="literal">span_compression_same_kind_max_duration</code></a></p></td>
<td align="left" valign="top"><p><a href="/guide/en/apm/agent/java/1.x/config-huge-traces.html#config-span-compression-exact-match-max-duration" class="ulink" target="_top"><code class="literal">span_compression_exact_match_max_duration</code></a></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>.NET agent</strong></span></p></td>
<td align="left" valign="top"><p><a href="/guide/en/apm/agent/dotnet/1.x/config-core.html#config-span-compression-same-kind-max-duration" class="ulink" target="_top"><code class="literal">SpanCompressionSameKindMaxDuration</code></a></p></td>
<td align="left" valign="top"><p><a href="/guide/en/apm/agent/dotnet/1.x/config-core.html#config-span-compression-exact-match-max-duration" class="ulink" target="_top"><code class="literal">SpanCompressionExactMatchMaxDuration</code></a></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>Node.js agent</strong></span></p></td>
<td align="left" valign="top"><p><a href="/guide/en/apm/agent/nodejs/4.x/configuration.html#span-compression-same-kind-max-duration" class="ulink" target="_top"><code class="literal">spanCompressionSameKindMaxDuration</code></a></p></td>
<td align="left" valign="top"><p><a href="/guide/en/apm/agent/nodejs/4.x/configuration.html#span-compression-exact-match-max-duration" class="ulink" target="_top"><code class="literal">spanCompressionExactMatchMaxDuration</code></a></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>Python agent</strong></span></p></td>
<td align="left" valign="top"><p><a href="/guide/en/apm/agent/python/6.x/configuration.html#config-span-compression-same-kind-max-duration" class="ulink" target="_top"><code class="literal">span_compression_same_kind_max_duration</code></a></p></td>
<td align="left" valign="top"><p><a href="/guide/en/apm/agent/python/6.x/configuration.html#config-span-compression-exact-match-max_duration" class="ulink" target="_top"><code class="literal">span_compression_exact_match_max_duration</code></a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="observability-apm-transaction-sampling.html">« Transaction sampling</a>
</span>
<span class="next">
<a href="observability-apm-stacktrace-collection.html">Stacktrace collection »</a>
</span>
</div>
</body>
</html>
