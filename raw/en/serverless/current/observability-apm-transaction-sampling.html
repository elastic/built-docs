<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Transaction sampling | Serverless | Elastic</title>
<meta class="elastic" name="content" content="Transaction sampling | Serverless">

<link rel="home" href="index.html" title="Serverless"/>
<link rel="up" href="observability-apm-reduce-your-data-usage.html" title="Reduce your data usage"/>
<link rel="prev" href="observability-apm-reduce-your-data-usage.html" title="Reduce your data usage"/>
<link rel="next" href="observability-apm-compress-spans.html" title="Compress spans"/>
<meta class="elastic" name="product_version" content="main"/>
<meta class="elastic" name="product_name" content="Serverless"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Serverless/Guide"/>
<meta name="DC.subject" content="Serverless"/>
<meta name="DC.identifier" content="main"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="observability-apm-reduce-your-data-usage.html">« Reduce your data usage</a>
</span>
<span class="next">
<a href="observability-apm-compress-spans.html">Compress spans »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Serverless</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="what-is-observability-serverless.html">Elastic Observability serverless</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="application-and-service-monitoring.html">Application and service monitoring</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="observability-apm.html">Application performance monitoring (APM)</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="observability-apm-reduce-your-data-usage.html">Reduce your data usage</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Transaction sampling</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-transaction-sampling.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="observability-apm-transaction-sampling"></a>Transaction sampling</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-transaction-sampling.asciidoc">edit</a></div>
</div></div></div>
<p><a class="xref" href="observability-apm-distributed-tracing.html" title="Distributed tracing">Distributed tracing</a> can
generate a substantial amount of data. More data can mean higher costs and more noise.
Sampling aims to lower the amount of data ingested and the effort required to analyze that data —
all while still making it easy to find anomalous patterns in your applications, detect outages, track errors,
and lower mean time to recovery (MTTR).</p>
<div class="position-relative"><h7><a id="observability-apm-transaction-sampling-head-based-sampling"></a>Head-based sampling</h7><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-transaction-sampling.asciidoc">edit</a></div>
<p>In head-based sampling, the sampling decision for each trace is made when the trace is initiated.
Each trace has a defined and equal probability of being sampled.</p>
<p>For example, a sampling value of <code class="literal">.2</code> indicates a transaction sample rate of <code class="literal">20%</code>.
This means that only <code class="literal">20%</code> of traces will send and retain all of their associated information.
The remaining traces will drop contextual information to reduce the transfer and storage size of the trace.</p>
<p>Head-based sampling is quick and easy to set up.
Its downside is that it&#8217;s entirely random — interesting
data might be discarded purely due to chance.</p>
<div class="position-relative"><h8><a id="observability-apm-transaction-sampling-distributed-tracing"></a>Distributed tracing</h8><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-transaction-sampling.asciidoc">edit</a></div>
<p>In a <em>distributed</em> trace, the sampling decision is still made when the trace is initiated.
Each subsequent service respects the initial service&#8217;s sampling decision, regardless of its configured sample rate;
the result is a sampling percentage that matches the initiating service.</p>
<p>In the example in <em>Figure 1</em>, <code class="literal">Service A</code> initiates four transactions and has a sample rate of <code class="literal">.5</code> (<code class="literal">50%</code>).
The upstream sampling decision is respected, so even if the sample rate is defined and is a different
value in <code class="literal">Service B</code> and <code class="literal">Service C</code>, the sample rate will be <code class="literal">.5</code> (<code class="literal">50%</code>) for all services.</p>
<p><span class="strong strong"><strong>Figure 1. Upstream sampling decision is respected</strong></span></p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/apm-dt-sampling-example-1.png" alt="Distributed tracing and head based sampling example one">
</div>
</div>
<p>In the example in <em>Figure 2</em>, <code class="literal">Service A</code> initiates four transactions and has a sample rate of <code class="literal">1</code> (<code class="literal">100%</code>).
Again, the upstream sampling decision is respected, so the sample rate for all services will
be <code class="literal">1</code> (<code class="literal">100%</code>).</p>
<p><span class="strong strong"><strong>Figure 2. Upstream sampling decision is respected</strong></span></p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/apm-dt-sampling-example-2.png" alt="Distributed tracing and head based sampling example two">
</div>
</div>
<div class="position-relative"><h8><a id="observability-apm-transaction-sampling-trace-continuation-strategies-with-distributed-tracing"></a>Trace continuation strategies with distributed tracing</h8><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-transaction-sampling.asciidoc">edit</a></div>
<p>In addition to setting the sample rate, you can also specify which <em>trace continuation strategy</em> to use.
There are three trace continuation strategies: <code class="literal">continue</code>, <code class="literal">restart</code>, and <code class="literal">restart_external</code>.</p>
<p>The <span class="strong strong"><strong><code class="literal">continue</code></strong></span> trace continuation strategy is the default and will behave similar to the examples in
the <a class="xref" href="observability-apm-transaction-sampling.html#observability-apm-transaction-sampling-distributed-tracing" title="Distributed tracing">Distributed tracing section</a>.</p>
<p>Use the <span class="strong strong"><strong><code class="literal">restart_external</code></strong></span> trace continuation strategy on an Elastic-monitored service to start
a new trace if the previous service did not have a <code class="literal">traceparent</code> header with <code class="literal">es</code> vendor data.
This can be helpful if a transaction includes an Elastic-monitored service that is receiving requests
from an unmonitored service.</p>
<p>In the example in <em>Figure 3</em>, <code class="literal">Service A</code> is an Elastic-monitored service that initiates four transactions
with a sample rate of <code class="literal">.25</code> (<code class="literal">25%</code>). Because <code class="literal">Service B</code> is unmonitored, the traces started in
<code class="literal">Service A</code> will end there. <code class="literal">Service C</code> is an Elastic-monitored service that initiates four transactions
that start new traces with a new sample rate of <code class="literal">.5</code> (<code class="literal">50%</code>). Because <code class="literal">Service D</code> is also
Elastic-monitored service, the upstream sampling decision defined in <code class="literal">Service C</code> is respected.
The end result will be three sampled traces.</p>
<p><span class="strong strong"><strong>Figure 3. Using the <code class="literal">restart_external</code> trace continuation strategy</strong></span></p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/apm-dt-sampling-continuation-strategy-restart_external.png" alt="Distributed tracing and head based sampling with restart_external continuation strategy">
</div>
</div>
<p>Use the <span class="strong strong"><strong><code class="literal">restart</code></strong></span> trace continuation strategy on an Elastic-monitored service to start
a new trace regardless of whether the previous service had a <code class="literal">traceparent</code> header.
This can be helpful if an Elastic-monitored service is publicly exposed, and you do not
want tracing data to possibly be spoofed by user requests.</p>
<p>In the example in <em>Figure 4</em>, <code class="literal">Service A</code> and <code class="literal">Service B</code> are Elastic-monitored services that use the
default trace continuation strategy. <code class="literal">Service A</code> has a sample rate of <code class="literal">.25</code> (<code class="literal">25%</code>), and that
sampling decision is respected in <code class="literal">Service B</code>. <code class="literal">Service C</code> is an Elastic-monitored service that
uses the <code class="literal">restart</code> trace continuation strategy and has a sample rate of <code class="literal">1</code> (<code class="literal">100%</code>).
Because it uses <code class="literal">restart</code>, the upstream sample rate is <em>not</em> respected in <code class="literal">Service C</code> and all four
traces will be sampled as new traces in <code class="literal">Service C</code>. The end result will be five sampled traces.</p>
<p><span class="strong strong"><strong>Figure 4. Using the <code class="literal">restart</code> trace continuation strategy</strong></span></p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/apm-dt-sampling-continuation-strategy-restart.png" alt="Distributed tracing and head based sampling with restart continuation strategy">
</div>
</div>
<div class="position-relative"><h8><a id="observability-apm-transaction-sampling-opentelemetry"></a>OpenTelemetry</h8><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-transaction-sampling.asciidoc">edit</a></div>
<p>Head-based sampling is implemented directly in the APM agents and SDKs.
The sample rate must be propagated between services and the managed intake service in order to produce accurate metrics.</p>
<p>OpenTelemetry offers multiple samplers. However, most samplers do not propagate the sample rate.
This results in inaccurate span-based metrics, like APM throughput, latency, and error metrics.</p>
<p>For accurate span-based metrics when using head-based sampling with OpenTelemetry, you must use
a <a href="https://opentelemetry.io/docs/specs/otel/trace/tracestate-probability-sampling/" class="ulink" target="_top">consistent probability sampler</a>.
These samplers propagate the sample rate between services and the managed intake service, resulting in accurate metrics.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>OpenTelemetry does not offer consistent probability samplers in all languages. Refer to the documentation of your favorite OpenTelemetry agent or SDK for more information.</p>
</div>
</div>
<div class="position-relative"><h7><a id="observability-apm-transaction-sampling-sampled-data-and-visualizations"></a>Sampled data and visualizations</h7><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-transaction-sampling.asciidoc">edit</a></div>
<p>A sampled trace retains all data associated with it.
A non-sampled trace drops all <a class="xref" href="observability-apm-data-types.html" title="APM data types">span</a> and <a class="xref" href="observability-apm-data-types.html" title="APM data types">transaction</a> data.
Regardless of the sampling decision, all traces retain <a class="xref" href="observability-apm-data-types.html" title="APM data types">error</a> data.</p>
<p>Some visualizations in the Applications UI, like latency, are powered by aggregated transaction and span <a class="xref" href="observability-apm-data-types.html" title="APM data types">metrics</a>.
Metrics are based on sampled traces and weighted by the inverse sampling rate.
For example, if you sample at 5%, each trace is counted as 20.
As a result, as the variance of latency increases, or the sampling rate decreases, your level of error will increase.</p>
<div class="position-relative"><h7><a id="observability-apm-transaction-sampling-sample-rates"></a>Sample rates</h7><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-transaction-sampling.asciidoc">edit</a></div>
<p>What&#8217;s the best sampling rate? Unfortunately, there isn&#8217;t one.
Sampling is dependent on your data, the throughput of your application, data retention policies, and other factors.
A sampling rate from <code class="literal">.1%</code> to <code class="literal">100%</code> would all be considered normal.
You&#8217;ll likely decide on a unique sample rate for different scenarios.
Here are some examples:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Services with considerably more traffic than others might be safe to sample at lower rates
</li>
<li class="listitem">
Routes that are more important than others might be sampled at higher rates
</li>
<li class="listitem">
A production service environment might warrant a higher sampling rate than a development environment
</li>
<li class="listitem">
Failed trace outcomes might be more interesting than successful traces — thus requiring a higher sample rate
</li>
</ul>
</div>
<p>Regardless of the above, cost conscious customers are likely to be fine with a lower sample rate.</p>
<div class="position-relative"><h7><a id="observability-apm-transaction-sampling-configure-head-based-sampling"></a>Configure head-based sampling</h7><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/apm/apm-transaction-sampling.asciidoc">edit</a></div>
<p>Each APM agent provides a configuration value used to set the transaction sample rate.
Refer to the relevant agent&#8217;s documentation for more details:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Go: <a href="/guide/en/apm/agent/go/2.x/configuration.html#config-transaction-sample-rate" class="ulink" target="_top"><code class="literal">ELASTIC_APM_TRANSACTION_SAMPLE_RATE</code></a>
</li>
<li class="listitem">
Java: <a href="/guide/en/apm/agent/java/1.x/config-core.html#config-transaction-sample-rate" class="ulink" target="_top"><code class="literal">transaction_sample_rate</code></a>
</li>
<li class="listitem">
.NET: <a href="/guide/en/apm/agent/dotnet/1.x/config-core.html#config-transaction-sample-rate" class="ulink" target="_top"><code class="literal">TransactionSampleRate</code></a>
</li>
<li class="listitem">
Node.js: <a href="/guide/en/apm/agent/nodejs/4.x/configuration.html#transaction-sample-rate" class="ulink" target="_top"><code class="literal">transactionSampleRate</code></a>
</li>
<li class="listitem">
PHP: <a href="/guide/en/apm/agent/php/current/configuration-reference.html#config-transaction-sample-rate" class="ulink" target="_top"><code class="literal">transaction_sample_rate</code></a>
</li>
<li class="listitem">
Python: <a href="/guide/en/apm/agent/python/6.x/configuration.html#config-transaction-sample-rate" class="ulink" target="_top"><code class="literal">transaction_sample_rate</code></a>
</li>
<li class="listitem">
Ruby: <a href="/guide/en/apm/agent/ruby/4.x/configuration.html#config-transaction-sample-rate" class="ulink" target="_top"><code class="literal">transaction_sample_rate</code></a>
</li>
</ul>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="observability-apm-reduce-your-data-usage.html">« Reduce your data usage</a>
</span>
<span class="next">
<a href="observability-apm-compress-spans.html">Compress spans »</a>
</span>
</div>
</body>
</html>
