<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Create an Elasticsearch query rule | Serverless | Elastic</title>
<meta class="elastic" name="content" content="Create an Elasticsearch query rule | Serverless">

<link rel="home" href="index.html" title="Serverless"/>
<link rel="up" href="observability-create-manage-rules.html" title="Create and manage rules"/>
<link rel="prev" href="observability-create-custom-threshold-alert-rule.html" title="Create a custom threshold rule"/>
<link rel="next" href="observability-create-error-count-threshold-alert-rule.html" title="Create an error count threshold rule"/>
<meta class="elastic" name="product_version" content="main"/>
<meta class="elastic" name="product_name" content="Serverless"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Serverless/Guide"/>
<meta name="DC.subject" content="Serverless"/>
<meta name="DC.identifier" content="main"/>
</head>
<body>
<div class="navheader">
<span class="prev">
<a href="observability-create-custom-threshold-alert-rule.html">« Create a custom threshold rule</a>
</span>
<span class="next">
<a href="observability-create-error-count-threshold-alert-rule.html">Create an error count threshold rule »</a>
</span>
</div>
<div class="book" lang="en">
<div class="titlepage">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Serverless</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="what-is-observability-serverless.html">Elastic Observability Serverless</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="incident-management.html">Incident management</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="observability-alerting.html">Alerting</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="observability-create-manage-rules.html">Create and manage rules</a></span>
</div>
<div>
<div><h1 class="title"><a id="id-1"></a>Create an Elasticsearch query rule</h1><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/alerting/create-elasticsearch-query-alert-rule.asciidoc">edit</a></div>
</div>
<!--EXTRA-->
</div>
<div id="content">
<div class="section">
<div class="titlepage"><div><div>
<div class="position-relative"><h5 class="title"><a id="observability-create-elasticsearch-query-rule"></a>Create an Elasticsearch query rule</h5><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/alerting/create-elasticsearch-query-alert-rule.asciidoc">edit</a></div>
</div></div></div>

<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p class="admon_title">Required role</p>
<p>The <span class="strong strong"><strong>Editor</strong></span> role or higher is required to create Elasticsearch query rules. To learn more, refer to <a class="xref" href="general-manage-organization.html#general-assign-user-roles" title="Assign user roles and privileges">Assign user roles and privileges</a>.</p>
</div>
</div>
<p>The Elasticsearch query rule type runs a user-configured query, compares the number of
matches to a configured threshold, and schedules actions to run when the
threshold condition is met.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
To access this page, from your project go to <span class="strong strong"><strong>Alerts</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Manage Rules</strong></span> → <span class="strong strong"><strong>Create rule</strong></span>.
</li>
<li class="listitem">
Under <span class="strong strong"><strong>Select rule type</strong></span>, select <span class="strong strong"><strong>Elasticsearch query</strong></span>.
</li>
</ol>
</div>
<p>An Elasticsearch query rule can be defined using Elasticsearch Query Domain Specific Language (DSL), Elasticsearch Query Language (ES|QL), Kibana Query Language (KQL), or Lucene.</p>
<div class="position-relative"><h7><a id="observability-create-elasticsearch-query-rule-define-the-conditions"></a>Define the conditions</h7><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/alerting/create-elasticsearch-query-alert-rule.asciidoc">edit</a></div>
<p>When you create an Elasticsearch query rule, your choice of query type affects the information you must provide.
For example:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/alerting-rule-types-es-query-conditions.png" alt="Define the condition to detect">
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Define your query</p>
<p>If you use <a href="/guide/en/elasticsearch/reference/8.16/query-dsl.html" class="ulink" target="_top">query DSL</a>, you must select an index and time field then provide your query.
Only the <code class="literal">query</code>, <code class="literal">fields</code>, <code class="literal">_source</code> and <code class="literal">runtime_mappings</code> fields are used, other DSL fields are not considered.
For example:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">{
  "query":{
    "match_all" : {}
  }
}</pre>
</div>
<p>If you use <a href="/guide/en/kibana/8.16/kuery-query.html" class="ulink" target="_top">KQL</a> or <a href="/guide/en/kibana/8.16/lucene-query.html" class="ulink" target="_top">Lucene</a>, you must specify a data view then define a text-based query.
For example, <code class="literal">http.request.referrer: "https://example.com"</code>.</p>
<p>If you use <a href="/guide/en/elasticsearch/reference/8.16/esql.html" class="ulink" target="_top">ES|QL</a>, you must provide a source command followed by an optional series of processing commands, separated by pipe characters (|).
For example:</p>
<div class="pre_wrapper lang-sh">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-sh">FROM kibana_sample_data_logs
| STATS total_bytes = SUM(bytes) BY host
| WHERE total_bytes &gt; 200000
| SORT total_bytes DESC
| LIMIT 10</pre>
</div>
</li>
<li class="listitem">
<p>If you use query DSL, KQL, or Lucene, set the group and theshold.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
When
</span>
</dt>
<dd>
Specify how to calculate the value that is compared to the threshold. The value is calculated by aggregating a numeric field within the time window. The aggregation options are: <code class="literal">count</code>, <code class="literal">average</code>, <code class="literal">sum</code>, <code class="literal">min</code>, and <code class="literal">max</code>. When using <code class="literal">count</code> the document count is used and an aggregation field is not necessary.
</dd>
<dt>
<span class="term">
Over or Grouped Over
</span>
</dt>
<dd>
Specify whether the aggregation is applied over all documents or split into groups using up to four grouping fields.
If you choose to use grouping, it&#8217;s a <a href="/guide/en/elasticsearch/reference/8.16/search-aggregations-bucket-terms-aggregation.html" class="ulink" target="_top">terms</a> or <a href="/guide/en/elasticsearch/reference/8.16/search-aggregations-bucket-multi-terms-aggregation.html" class="ulink" target="_top">multi terms aggregation</a>; an alert will be created for each unique set of values when it meets the condition.
To limit the number of alerts on high cardinality fields, you must specify the number of groups to check against the threshold.
Only the top groups are checked.
</dd>
<dt>
<span class="term">
Threshold
</span>
</dt>
<dd>
Defines a threshold value and a comparison operator  (<code class="literal">is above</code>,
<code class="literal">is above or equals</code>, <code class="literal">is below</code>, <code class="literal">is below or equals</code>, or <code class="literal">is between</code>). The value
calculated by the aggregation is compared to this threshold.
</dd>
</dl>
</div>
</li>
<li class="listitem">
Set the time window, which defines how far back to search for documents.
</li>
<li class="listitem">
If you use query DSL, KQL, or Lucene, set the number of documents to send to the configured actions when the threshold condition is met.
</li>
<li class="listitem">
If you use query DSL, KQL, or Lucene, choose whether to avoid alert duplication by excluding matches from the previous run.
This option is not available when you use a grouping field.
</li>
<li class="listitem">
Set the check interval, which defines how often to evaluate the rule conditions.
Generally this value should be set to a value that is smaller than the time window, to avoid gaps in
detection.
</li>
</ol>
</div>
<div class="position-relative"><h7><a id="observability-create-elasticsearch-query-rule-test-your-query"></a>Test your query</h7><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/alerting/create-elasticsearch-query-alert-rule.asciidoc">edit</a></div>
<p>Use the <span class="strong strong"><strong>Test query</strong></span> feature to verify that your query is valid.</p>
<p>If you use query DSL, KQL, or Lucene, the query runs against the selected indices using the configured time window.
The number of documents that match the query is displayed.
For example:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/alerting-rule-types-es-query-valid.png" alt="Test Elasticsearch query returns number of matches when valid">
</div>
</div>
<p>If you use an ES|QL query, a table is displayed. For example:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/alerting-rule-types-esql-query-valid.png" alt="Test ES|QL query returns a table when valid">
</div>
</div>
<p>If the query is not valid, an error occurs.</p>
<div class="position-relative"><h7><a id="observability-create-elasticsearch-query-rule-add-actions"></a>Add actions</h7><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/alerting/create-elasticsearch-query-alert-rule.asciidoc">edit</a></div>
<p>You can optionally send notifications when the rule conditions are met and when they are no longer met.
In particular, this rule type supports:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
alert summaries
</li>
<li class="listitem">
actions that run when the query is matched
</li>
<li class="listitem">
recovery actions that run when the rule conditions are no longer met
</li>
</ul>
</div>
<p>For each action, you must choose a connector, which provides connection information for a service or third party integration.</p>
<details>
<summary class="title">Connector types</summary>
<div class="content">
<p>Connectors provide a central place to store connection information for services and integrations with third party systems.
The following connectors are available when defining actions for alerting rules:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="/guide/en/kibana/8.16/cases-action-type.html" class="ulink" target="_top">Cases</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/d3security-action-type.html" class="ulink" target="_top">D3 Security</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/email-action-type.html" class="ulink" target="_top">Email</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/resilient-action-type.html" class="ulink" target="_top">IBM Resilient</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/index-action-type.html" class="ulink" target="_top">Index</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/jira-action-type.html" class="ulink" target="_top">Jira</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/teams-action-type.html" class="ulink" target="_top">Microsoft Teams</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/obs-ai-assistant-action-type.html" class="ulink" target="_top">Observability AI Assistant</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/opsgenie-action-type.html" class="ulink" target="_top">Opsgenie</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/pagerduty-action-type.html" class="ulink" target="_top">PagerDuty</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/server-log-action-type.html" class="ulink" target="_top">Server log</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/servicenow-itom-action-type.html" class="ulink" target="_top">ServiceNow ITOM</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/servicenow-action-type.html" class="ulink" target="_top">ServiceNow ITSM</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/servicenow-sir-action-type.html" class="ulink" target="_top">ServiceNow SecOps</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/slack-action-type.html" class="ulink" target="_top">Slack</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/swimlane-action-type.html" class="ulink" target="_top">Swimlane</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/torq-action-type.html" class="ulink" target="_top">Torq</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/webhook-action-type.html" class="ulink" target="_top">Webhook</a>
</li>
<li class="listitem">
<a href="/guide/en/kibana/8.16/xmatters-action-type.html" class="ulink" target="_top">xMatters</a>
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Some connector types are paid commercial features, while others are free.
For a comparison of the Elastic subscription levels, go to
<a href="/subscriptions" class="ulink" target="_top">the subscription page</a>.</p>
</div>
</div>
<p>For more information on creating connectors, refer to <a class="xref" href="action-connectors.html" title="Connectors">Connectors</a>.</p>
</div>
</details>
<details>
<summary class="title">Action frequency</summary>
<div class="content">
<p>After you select a connector, you must set the action frequency. You can choose to create a <span class="strong strong"><strong>Summary of alerts</strong></span> on each check interval or on a custom interval. For example, you can send email notifications that summarize the new, ongoing, and recovered alerts at a custom interval:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/alerting-es-query-rule-action-summary.png" alt="UI for defining alert summary action in an Elasticsearch query rule">
</div>
</div>
<p>Alternatively, you can set the action frequency to <span class="strong strong"><strong>For each alert</strong></span> and specify the conditions each alert must meet for the action to run.</p>
<p>With the <span class="strong strong"><strong>Run when</strong></span> menu you can choose how often the action runs (at each check interval, only when the alert status changes, or at a custom action interval).
You must also choose an action group, which indicates whether the action runs when the query is matched or when the alert is recovered.
Each connector supports a specific set of actions for each action group.
For example:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/alerting-es-query-rule-action-query-matched.png" alt="UI for defining a recovery action">
</div>
</div>
<p>You can further refine the conditions under which actions run by specifying that actions only run when they match a KQL query or when an alert occurs within a specific time frame.</p>
</div>
</details>
<details>
<summary class="title">Action variables</summary>
<div class="content">
<p>Use the default notification message or customize it.
You can add more context to the message by clicking the Add variable icon <span class="image"><img src="images/icons/indexOpen.svg" alt="Add variable"></span> and selecting from a list of available variables.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/action-variables-popup.png" alt="Action variables list">
</div>
</div>
<p>The following variables are specific to this rule type.
You can also specify <a href="/guide/en/kibana/8.16/rule-action-variables.html" class="ulink" target="_top">variables common to all rules</a>.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">context.conditions</code>
</span>
</dt>
<dd>
A string that describes the threshold condition. Example:
<code class="literal">count greater than 4</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.date</code>
</span>
</dt>
<dd>
The date, in ISO format, that the rule met the condition.
Example: <code class="literal">2022-02-03T20:29:27.732Z</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.hits</code>
</span>
</dt>
<dd>
<p>
The most recent documents that matched the query. Using the
<a href="https://mustache.github.io/" class="ulink" target="_top">Mustache</a> template array syntax, you can iterate
over these hits to get values from the Elasticsearch documents into your actions.
</p>
<p>For example, the message in an email connector action might contain:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">Elasticsearch query rule '{{rule.name}}' is active:

{{#context.hits}}
Document with {{_id}} and hostname {{_source.host.name}} has
{{_source.system.memory.actual.free}} bytes of memory free
{{/context.hits}}</pre>
</div>
<p>The documents returned by <code class="literal">context.hits</code> include the <a href="/guide/en/elasticsearch/reference/8.16/mapping-source-field.html" class="ulink" target="_top"><code class="literal">_source</code></a> field.
If the Elasticsearch query search API&#8217;s <a href="/guide/en/elasticsearch/reference/8.16/search-fields.html#search-fields-param" class="ulink" target="_top"><code class="literal">fields</code></a> parameter is used, documents will also return the <code class="literal">fields</code> field,
which can be used to access any runtime fields defined by the <a href="/guide/en/elasticsearch/reference/8.16/runtime-search-request.html" class="ulink" target="_top"><code class="literal">runtime_mappings</code></a> parameter.
For example:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">{{#context.hits}}
timestamp: {{_source.@timestamp}}
day of the week: {{fields.day_of_week}} <a id="CO34-1"></a><i class="conum" data-value="1"></i>
{{/context.hits}}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO34-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">fields</code> parameter here is used to access the <code class="literal">day_of_week</code> runtime field.</p>
</td>
</tr>
</table>
</div>
<p>As the <a href="/guide/en/elasticsearch/reference/8.16/search-fields.html#search-fields-response" class="ulink" target="_top"><code class="literal">fields</code></a> response always returns an array of values for each field,
the <a href="https://mustache.github.io/" class="ulink" target="_top">Mustache</a> template array syntax is used to iterate over these values in your actions.
For example:</p>
<div class="pre_wrapper lang-txt">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-txt">{{#context.hits}}
Labels:
{{#fields.labels}}
- {{.}}
{{/fields.labels}}
{{/context.hits}}</pre>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">context.link</code>
</span>
</dt>
<dd>
Link to Discover and show the records that triggered the alert.
</dd>
<dt>
<span class="term">
<code class="literal">context.message</code>
</span>
</dt>
<dd>
A message for the alert. Example:
<code class="literal">rule 'my es-query' is active:</code>
<code class="literal">- Value: 2</code>
<code class="literal">- Conditions Met: Number of matching documents is greater than 1 over 5m</code>
<code class="literal">- Timestamp: 2022-02-03T20:29:27.732Z</code>
</dd>
<dt>
<span class="term">
<code class="literal">context.title</code>
</span>
</dt>
<dd>
A title for the alert. Example:
<code class="literal">rule term match alert query matched</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.value</code>
</span>
</dt>
<dd>
The value that met the threshold condition.
</dd>
</dl>
</div>
</div>
</details>
<div class="position-relative"><h7><a id="observability-create-elasticsearch-query-rule-handling-multiple-matches-of-the-same-document"></a>Handling multiple matches of the same document</h7><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/serverless/alerting/create-elasticsearch-query-alert-rule.asciidoc">edit</a></div>
<p>By default, <span class="strong strong"><strong>Exclude matches from previous run</strong></span> is turned on and the rule checks
for duplication of document matches across multiple runs. If you configure the
rule with a schedule interval smaller than the time window and a document
matches a query in multiple runs, it is alerted on only once.</p>
<p>The rule uses the timestamp of the matches to avoid alerting on the same match
multiple times. The timestamp of the latest match is used for evaluating the
rule conditions when the rule runs. Only matches between the latest timestamp
from the previous run and the current run are considered.</p>
<p>Suppose you have a rule configured to run every minute. The rule uses a time
window of 1 hour and checks if there are more than 99 matches for the query. The
Elasticsearch query rule type does the following:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top"></th>
<th align="left" valign="top"></th>
<th align="left" valign="top"></th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">Run 1 (0:00)</code></p></td>
<td align="left" valign="top"><p>Rule finds 113 matches in the last hour: <code class="literal">113 &gt; 99</code></p></td>
<td align="left" valign="top"><p>Rule is active and user is alerted.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">Run 2 (0:01)</code></p></td>
<td align="left" valign="top"><p>Rule finds 127 matches in the last hour. 105 of the matches are duplicates that were already alerted on previously, so you actually have 22 matches: <code class="literal">22 !&gt; 99</code></p></td>
<td align="left" valign="top"><p>No alert.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">Run 3 (0:02)</code></p></td>
<td align="left" valign="top"><p>Rule finds 159 matches in the last hour. 88 of the matches are duplicates that were already alerted on previously, so you actually have 71 matches: <code class="literal">71 !&gt; 99</code></p></td>
<td align="left" valign="top"><p>No alert.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">Run 4 (0:03)</code></p></td>
<td align="left" valign="top"><p>Rule finds 190 matches in the last hour. 71 of them are duplicates that were already alerted on previously, so you actually have 119 matches: <code class="literal">119 &gt; 99</code></p></td>
<td align="left" valign="top"><p>Rule is active and user is alerted.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div><div class="navfooter">
<span class="prev">
<a href="observability-create-custom-threshold-alert-rule.html">« Create a custom threshold rule</a>
</span>
<span class="next">
<a href="observability-create-error-count-threshold-alert-rule.html">Create an error count threshold rule »</a>
</span>
</div>
</body>
</html>
